<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Learn crime mapping with R - 3&nbsp; Wrangling data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../02_your_first_crime_map/index.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<!-- START OF INCLUDED HEADER -->

<!--
This file contains code that will be included in the header of each page of the
quarto book
-->

<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>

<!-- END OF INCLUDED HEADER -->


<link rel="stylesheet" href="../css/styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Learn crime mapping with R</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/mpjashby/crimemappingbook/" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Download" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-download"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="../Learn-crime-mapping-with-R.pdf">
            <i class="bi bi-bi-file-pdf pe-1"></i>
          Download PDF
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="../Learn-crime-mapping-with-R.epub">
            <i class="bi bi-bi-journal pe-1"></i>
          Download ePub
          </a>
        </li>
    </ul>
    <a href="" title="Share" id="sidebar-tool-dropdown-1" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-1">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Welcome!</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../00_setup/index.html" class="sidebar-item-text sidebar-link">Install the software needed for this book</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_getting_started/index.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_your_first_crime_map/index.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Your first crime map</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_data_wrangling/index.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">load packages</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="toc-section-number">3.1</span>  Introduction</a>
  <ul class="collapse">
  <li><a href="#functions" id="toc-functions" class="nav-link" data-scroll-target="#functions"><span class="toc-section-number">3.1.1</span>  Functions</a></li>
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages"><span class="toc-section-number">3.1.2</span>  Packages</a></li>
  </ul></li>
  <li><a href="#loading-data" id="toc-loading-data" class="nav-link" data-scroll-target="#loading-data"><span class="toc-section-number">3.2</span>  Loading data</a>
  <ul class="collapse">
  <li><a href="#loading-csv-data" id="toc-loading-csv-data" class="nav-link" data-scroll-target="#loading-csv-data"><span class="toc-section-number">3.2.1</span>  Loading CSV data</a></li>
  <li><a href="#loading-excel-data" id="toc-loading-excel-data" class="nav-link" data-scroll-target="#loading-excel-data"><span class="toc-section-number">3.2.2</span>  Loading Excel data</a></li>
  </ul></li>
  <li><a href="#selecting-columns" id="toc-selecting-columns" class="nav-link" data-scroll-target="#selecting-columns"><span class="toc-section-number">3.3</span>  Selecting columns</a></li>
  <li><a href="#filtering-rows" id="toc-filtering-rows" class="nav-link" data-scroll-target="#filtering-rows"><span class="toc-section-number">3.4</span>  Filtering rows</a></li>
  <li><a href="#transforming-values" id="toc-transforming-values" class="nav-link" data-scroll-target="#transforming-values"><span class="toc-section-number">3.5</span>  Transforming values</a></li>
  <li><a href="#summarising-rows" id="toc-summarising-rows" class="nav-link" data-scroll-target="#summarising-rows"><span class="toc-section-number">3.6</span>  Summarising rows</a>
  <ul class="collapse">
  <li><a href="#counting-rows" id="toc-counting-rows" class="nav-link" data-scroll-target="#counting-rows"><span class="toc-section-number">3.6.1</span>  Counting rows</a></li>
  </ul></li>
  <li><a href="#arranging-rows" id="toc-arranging-rows" class="nav-link" data-scroll-target="#arranging-rows"><span class="toc-section-number">3.7</span>  Arranging rows</a>
  <ul class="collapse">
  <li><a href="#check-your-understanding" id="toc-check-your-understanding" class="nav-link" data-scroll-target="#check-your-understanding"><span class="toc-section-number">3.7.1</span>  Check your understanding</a></li>
  </ul></li>
  <li><a href="#saving-data" id="toc-saving-data" class="nav-link" data-scroll-target="#saving-data"><span class="toc-section-number">3.8</span>  Saving data</a></li>
  <li><a href="#stringing-functions-together" id="toc-stringing-functions-together" class="nav-link" data-scroll-target="#stringing-functions-together"><span class="toc-section-number">3.9</span>  Stringing functions together</a></li>
  <li><a href="#in-summary" id="toc-in-summary" class="nav-link" data-scroll-target="#in-summary"><span class="toc-section-number">3.10</span>  In summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><strong>Learn the building blocks of data analysis: loading, filtering, manipulating and saving data for crime mapping.</strong></p>
<div class="box load-tutorial">
<p>To load the <a href="../#how-to-use-this-book">interactive tutorial</a> for this chapter, copy and paste the following code into the RStudio console:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>crimemapping<span class="sc">::</span><span class="fu">tutorial</span>(<span class="st">"03_data_wrangling"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and press <code>Enter</code>.</p>
</div>
<section id="introduction" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">3.1</span> Introduction</h2>
<p>A major step in using any data to make decisions or draw conclusions is <em>data wrangling</em>: the process of transforming data from the format in which we originally have it to the format needed to analyse and present it to our audience.</p>
<p class="full-width-image">
<img src="https://github.com/mpjashby/crimemapping/raw/main/inst/tutorials/03_data_wrangling/images/datawrangling.jpg" alt="Cartoon of furry monsters putting boxes onto a conveyor belt with machines marked 'wrangle', 'vizualise' and 'model' adjusting the boxes as they move along the belt">
</p>
<p>Start off by watching this video that walks through the different steps in wrangling a dataset. We will cover all the steps in the video in more detail during the rest of this tutorial.</p>
<p><img src="https://youtu.be/pQeJKt6O9dU.png" class="img-fluid"></p>
<section id="functions" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="functions"><span class="header-section-number">3.1.1</span> Functions</h3>
<p>In this tutorial we will learn how to wrangle data in R using <em>functions</em> – specialised pieces of code that do something to the data we give it. The code to use a function (sometimes called <em>calling</em> the function) has two parts: the function name followed by a pair of parentheses, inside which are zero or more <em>arguments</em> separated by commas. Arguments are a way of providing input that a function works on, or to fine-tune the way the function works (we will see many examples of this later). Remember that you can identify a function in R because the name will always have parentheses after it.</p>
<p>One basic R function is <code>sqrt()</code>, which calculates the square root of a number. The <code>sqrt()</code> function has only one argument: the number that we want to find the square root of.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When you run code in R, by default R prints the output of your code – in this case, just the number <code>1.414214</code>.</p>
</section>
<section id="packages" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="packages"><span class="header-section-number">3.1.2</span> Packages</h3>
<div class="cell">

</div>
<p>R contains thousands of different functions that do different things. A few functions are contained in the default installation of R that you have already installed (this is sometimes referred to as <em>base R</em>). But most functions are contained in <em>packages</em>, which are extensions to base R. Most packages focus on a particular type of data analysis, so that there are packages devoted to time-series analysis, testing whether events are clustered in particular places, network analysis and thousands of other tasks. Packages are often developed by experts in the field, and are typically updated to introduce new features.</p>
<p>To use a package in R, we must do two things:</p>
<ul>
<li><em>install</em> the package, which we have to do just once on each computer we want to use, then</li>
<li><em>load</em> the package, which we have to do each time we restart R (which happens when we open RStudio or switch between projects).</li>
</ul>
<p>The <code>install.packages()</code> function downloads and installs packages from the <a href="https://cran.r-project.org/">Comprehensive R Archive Network</a> (universally known as CRAN), which contains about 19,000 different packages. Some packages that are still in the early stages of development are not available on CRAN, but all the packages we will use are there.</p>
<p><a href="https://tidyverse.org/" title="tidyverse website"><img src="images/tidyverse.png" class="right-side-image"></a></p>
<p>So to install (for example) the package called <code>tidyverse</code>, which we will use extensively in this tutorial, we would run the R code:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We only have to <em>install</em> a package once for each computer that we will use to run R, although we would have to do it again if we updated to a new version of R. Once a package is installed on our computer, we have to <em>load</em> it so that we can use it in our code. We load packages using the <code>library()</code> function, which should probably have been called <code>load_package()</code> but isn’t. So to load the <code>tidyverse</code> package, we run the code:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Many packages are focused on specialist tasks and so are only used occasionally, but a few packages are likely to be useful in almost all the code we write. Fortunately, packages can themselves load other packages, and all the main packages we need are themselves loaded by the <code>tidyverse</code> package. That is why you will often see <code>library(tidyverse)</code> at the top of R code in subsequent tutorials – that short line of code loads several packages containing hundreds of functions that we can use in data analysis.</p>
<p class="credits">
<a href="https://github.com/allisonhorst/stats-illustrations">Stats Illustrations by Allison Horst</a> licensed under the <a href="https://github.com/allisonhorst/stats-illustrations/blob/master/license">Creative Commons Attribution licence</a>.
</p>
</section>
</section>
<section id="loading-data" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="loading-data"><span class="header-section-number">3.2</span> Loading data</h2>
<p>Before we can do anything with any data, we have to load it into R. In this course we will read tabular data in comma-separated values (CSV) and Excel formats, as well as spatial data in different formats (because there are lots of ways to store spatial data). We will learn how to read CSV and Excel data now, but leave loading spatial data until later.</p>
<p>Tabular data contains multiple columns where every column has the same number of rows. For example, crime data might have columns for the type of crime, date and address at which the crime occurred.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Crime data in rectangular format</caption>
<thead>
<tr class="header">
<th style="text-align: left;">type</th>
<th style="text-align: left;">date</th>
<th style="text-align: left;">address</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">homicide</td>
<td style="text-align: left;">19 Jan 2022</td>
<td style="text-align: left;">274 Main St</td>
</tr>
<tr class="even">
<td style="text-align: left;">non-residential burglary</td>
<td style="text-align: left;">29 Aug 2022</td>
<td style="text-align: left;">541 Station Rd</td>
</tr>
<tr class="odd">
<td style="text-align: left;">personal robbery</td>
<td style="text-align: left;">01 Jan 2023</td>
<td style="text-align: left;">10 North Av</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="loading-csv-data" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="loading-csv-data"><span class="header-section-number">3.2.1</span> Loading CSV data</h3>
<p><a href="https://readr.tidyverse.org/" title="readr website"><img src="images/readr.png" class="right-side-image"></a></p>
<p>Data stored in CSV format is easy to load with the <code>read_csv()</code> function from the <a href="https://readr.tidyverse.org"><code>readr</code></a> package. <code>readr</code> is one of the packages loaded by the <code>tidyverse</code> package, so all we need to do to use this package is include the code <code>library(tidyverse)</code> on the first line of our R script. We will use comments (lines of code beginning with <code>#</code>) to help explain as we go.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the tidyverse suite of packages, including the readr package </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># that contains the read_csv() function</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># We can load data from a file in the same folder as our R script</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>san_fran_rob <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"san_francisco_robbery.csv"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Or another folder on your computer ('../' is short for the parent </span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># folder of the current folder)</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>san_fran_rob <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../san_francisco_robbery.csv"</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Or directly from a file online</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>san_fran_rob <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"http://example.com/san_francisco_robbery.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In each of these examples, the code stores the result of the <code>read_csv()</code> function in an <em>object</em> named <code>san_fran_rob</code>. Objects are places where we can store data. To create an object and store our data in it, we use the assignment operator <code>&lt;-</code> (a less-than sign followed by a dash). Continually typing <code>&lt;-</code> can be tedious, so in RStudio we can use the keyboard short cut <code>Option+-</code> (on Mac) or <code>Alt+-</code> (on Windows or Linux) to insert the complete operator.</p>
<div class="box notewell">
<p>When choosing object names, it is important to remember that if you assign a value (such as the number <code>1</code> or the result of the function <code>read_csv()</code>) to an object name, R will overwrite any existing value of that object name. We can see this in a simple example:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>one_to_ten <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>one_to_ten <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we were to run this code, the object <code>one_to_ten</code> would not actually hold the numbers from one to ten, but instead the value <code>1.414214</code> (the square root of two). There is also no way to undo assignment of a value to an object, so once you have run the code <code>one_to_ten &lt;- sqrt(2)</code> it is not possible to recover any previous value that was assigned to the object <code>one_to_ten</code>.</p>
</div>
<p>Objects come in several different types, with tabular data typically being stored as a <em>data frame</em>. The <code>read_csv()</code> function actually produces a modern variation on the data frame called (slightly strangely) a <em>tibble</em>, which makes use of some advances in how R handles data since the data-frame format was set 20 years ago. Tibbles behave just like data frames almost all of the time (so much so that people working with tibbles often call them data frames) except for a few occasions where they behave in a more-convenient way.</p>
<p>We can <code>read_csv()</code> to load data from <code>https://github.com/mpjashby/crimemapping/raw/main/inst/extdata/san_francisco_robbery.csv</code> and store it in an object called <code>san_fran_rob</code>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>san_fran_rob <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://github.com/mpjashby/crimemapping/raw/main/inst/extdata/san_francisco_robbery.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If the data are loaded successfully, R will list the columns in the data and the type of variable (numeric, date etc.) stored in each column. The format of this is somewhat esoteric, but if you are interested they are explained in the ‘Extra detail’ box below.</p>
<div class="box extra-detail">
<h5 id="read-box1-title" class="box-title anchored">
What do the messages produced by <code>read_csv()</code> mean?
</h5>
<div id="read-box1" class="box-content">
<p>By default, the <code>read_csv()</code> function prints a message when it loads data to summarise the format of each data column. In the case of the <code>san_fran_rob</code> dataset, <code>read_csv()</code> tells us that:</p>
<ul>
<li>there is one column called <code>offense_type</code> that contains character (<code>chr</code>) values,</li>
<li>there are three columns called <code>uid</code>, <code>longitude</code> and <code>latitude</code> containing numeric (<code>dbl</code>) values, and</li>
<li>there is one column called <code>date_time</code> that contains values stored as dates and times (<code>dttm</code>).</li>
</ul>
<p>There are some other possible types of data, but we will learn about these later on. The numeric values are referred to as <code>dbl</code> values because they are stored in a format that can handle numbers that are not whole numbers (e.g.&nbsp;123.456). This format for storing numbers is called the double-precision floating-point format, which is often known as the double format for short. Most numbers in R are stored in double format, so you can think of the format code <code>dbl</code> as meaning ‘numeric’.</p>
</div>
</div>
<script>
$("#read-box1-title").click(function () { $("#read-box1").toggle("slow") })
</script>
<p>To see the first few rows of data currently stored in an object, we can use the <code>head()</code> function.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(san_fran_rob)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="loading-excel-data" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="loading-excel-data"><span class="header-section-number">3.2.2</span> Loading Excel data</h3>
<p><a href="https://readxl.tidyverse.org/" title="readxl website"><img src="images/readxl.png" class="right-side-image"></a></p>
<p>Loading data from Microsoft Excel files is very similar to loading CSV data, with a few important differences. Functions to load Excel data are contained in the <code>readxl</code> package, which was installed automatically when we installed the <code>tidyverse</code> package.</p>
<p>There are two main things we must do to import Excel data that are not required for importing CSV data. The first is that the <code>readxl</code> package cannot directly load files from a URL, instead only loading files that are present on your computer. To get round this, we will first download an Excel file and store it in a temporary directory (to avoid cluttering up our computers).</p>
<div class="box notewell">
<p><strong>Using <code>download.file()</code> on Windows</strong></p>
<p>If you are using a Windows computer, you may find that the <code>download.file()</code> function in the code below does not work as expected. This is because Windows handles files in a way that distinguishes between <em>plain-text</em> files such as <code>.txt</code> and <code>.csv</code> files and <em>binary</em> files, which includes most other file types (including compressed files). Since <code>aggravated_assaults.xlsx</code> is not a plain-text file, on Windows you need to specify that you want it to be downloaded as a binary file. To do this, add the argument <code>mode = "wb"</code> to the <code>download.file()</code> function so that it reads:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">url =</span> <span class="st">"https://github.com/mpjashby/crimemapping/raw/main/inst/extdata/aggravated_assaults.xlsx"</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">destfile =</span> temp_file,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"wb"</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you are using a Mac or a Linux computer then you do not need to worry about this.</p>
</div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the name of and location of our temporary file: it does not matter</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># what this file is called or where it is stored, so we use the tempfile()</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># function to create a file in the correct location automatically</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>temp_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".xlsx"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the Excel file and store it in the temporary location</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">url =</span> <span class="st">"https://github.com/mpjashby/crimemapping/raw/main/inst/extdata/aggravated_assaults.xlsx"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">destfile =</span> temp_file,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"wb"</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>download.file()</code> function does not produce any output if the file has been successfully downloaded, so you will not see any output when you run this code.</p>
<p>Now we have downloaded our data, we can load it into R. Since Excel files can contain multiple sheets, we need to specify which sheet we would like to load into a tibble. We can use the <code>excel_sheets()</code> function to get a list of sheets in an Excel file:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the readxl package</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a list of sheets in an Excel file</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">excel_sheets</span>(temp_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can now load the sheet containing data for Austin and view the first few rows of the resulting object:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>agg_assault_data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(temp_file, <span class="at">sheet =</span> <span class="st">"Austin"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(agg_assault_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we have learned how to load our data into an object, we can use other R functions to work with that data in many different ways.</p>
<div class="box reading">
<p><a href="https://r4ds.had.co.nz/data-import.html">Learn more about how to read data into R</a> by reading this chapter of the free online book <a href="https://r4ds.had.co.nz/">R for Data Science</a>.</p>
<p>Excel data can often be messy and the <code>readxl</code> package contains various other functions that can be used to deal with this. You can <a href="http://lesscrime.info/post/cleaning-ons-data/">learn more about how to handle messy Excel data in this online tutorial</a>.</p>
</div>
</section>
</section>
<section id="selecting-columns" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="selecting-columns"><span class="header-section-number">3.3</span> Selecting columns</h2>
<p>In this section we will learn how to reduce the size of our data by selecting only the columns we need and discarding the rest. This can be particularly useful if we are working with a very-large dataset, or if we want to produce a table containing only some columns.</p>
<p class="full-width-image">
<img src="https://github.com/mpjashby/crimemapping/raw/main/inst/tutorials/03_data_wrangling/images/dplyr.jpg" alt="Cartoon showing a furry monster with 'dplyr' written on it wrangling a bunch of smaller, unruly, monsters.">
</p>
<p>We can use the <code>select()</code> function from the <a href="https://dplyr.tidyverse.org/"><code>dplyr</code></a> package (one of the packages that is loaded automatically when we call the <code>library(tidyverse)</code> function) to select columns.</p>
<p>If we wanted to select just the <code>date</code> and <code>location_type</code> columns from the <code>agg_assault_data</code> we loaded in the previous section:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(agg_assault_data, date, location_type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="https://dplyr.tidyverse.org/" title="dplyr website"><img src="images/dplyr.png" class="right-side-image"></a></p>
<p>In a previous section, we mentioned that the code needed to run (or <em>call</em>) a function in R has two parts: the function name followed by a pair of parentheses, inside which are zero or more <em>arguments</em> separated by commas. The arguments in the <code>select()</code> function (and many other functions in the <code>dplyr</code> package) work in a slightly different way to many other functions. Here, the first argument is the name of the data object that we want to select from. All the remaining arguments (here, <code>date</code> and <code>location_type</code>) are the names of the columns we want to select from the data.</p>
<p>We can select as many columns as we want, by just adding the names of the columns separated by commas. Write the code necessary to select the <code>longitude</code> and <code>latitude</code> columns from the <code>agg_assault_data</code> object:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(agg_assault_data, longitude, latitude)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The columns in our new dataset will appear in the order in which we specify them in the <code>select()</code> function.</p>
<p>We can also use <code>select()</code> to rename columns at the same time as selecting them. For example, to select the columns <code>date</code> and <code>location_type</code> while also renaming <code>location_type</code> to be called <code>type</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(agg_assault_data, date, <span class="at">type =</span> location_type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we want to rename a column while keeping <em>all</em> the columns in the data, we can instead use the <code>rename()</code> function (also from the <code>dplyr</code> package):</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rename</span>(agg_assault_data, <span class="at">type =</span> location_type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Remember that functions in R generally do not change existing objects, but instead produce (or <em>return</em>) new ones. This means if we want to store the result of this function so we can use it later, we have to assign the value returned by the function to a new object (or overwrite the existing object):</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>agg_assault_locations <span class="ot">&lt;-</span> <span class="fu">select</span>(agg_assault_data, <span class="at">lon =</span> longitude, <span class="at">lat =</span> latitude)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(agg_assault_locations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="box reading">
<p>You can learn more about selecting, filtering and arranging data using the functions in the <code>dplyr</code> package by reading this <a href="https://dplyr.tidyverse.org/articles/dplyr.html">Introduction to <code>dplyr</code> tutorial</a>.</p>
</div>
</section>
<section id="filtering-rows" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="filtering-rows"><span class="header-section-number">3.4</span> Filtering rows</h2>
<p>Often in crime mapping we will only be interested in part of a particular dataset. In the same way that we can <em>select</em> particular <em>columns</em> in our data, we can <em>filter</em> particular <em>rows</em> using the <code>filter()</code> function from the <code>dplyr</code> package.</p>
<p class="full-width-image">
<img src="https://github.com/mpjashby/crimemapping/raw/main/inst/tutorials/03_data_wrangling/images/filter.jpg" alt="Cartoon showing monsters explaining how the filter() function works.">
</p>
<p>If we were only interested in offences in the <code>agg_assault_data</code> dataset that occurred in residences, we could use <code>filter()</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(agg_assault_data, location_type <span class="sc">==</span> <span class="st">"residence"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that:</p>
<ul>
<li>the column <em>name</em> <code>location_type</code> is not surrounded by quotes but the column <em>value</em> <code>"residence"</code> is, and</li>
<li>the <code>==</code> (equal to) operator is used, since a single equals sign <code>=</code> has another meaning in R.</li>
</ul>
<p>We can filter using the values of more than one column simultaneously. To filter offences in which the <code>location_category</code> is ‘leisure’ and the <code>location_type</code> is ‘bar/club’:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  agg_assault_data, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  location_category <span class="sc">==</span> <span class="st">"leisure"</span>, </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  location_type <span class="sc">==</span> <span class="st">"bar/club"</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As well as filtering using the <code>==</code> operator, we can filter using the greater-than (<code>&gt;</code>), less-than (<code>&lt;</code>), greater-than-or-equal-to (<code>&gt;=</code>) and less-than-or-equal-to (<code>&lt;=</code>) operators. For example, we can choose offences that occurred in residences on or after 1 July 2019:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  agg_assault_data, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  location_type <span class="sc">==</span> <span class="st">"residence"</span>, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  date <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2019-07-01"</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Sometimes we will want to filter rows that are one thing <em>or</em> another. We can do this with the <code>|</code> (or) operator. For example, we can filter offences that occurred either in leisure facilities or shopping malls on or after 1 July 2019:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  agg_assault_data, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  location_category <span class="sc">==</span> <span class="st">"leisure"</span> <span class="sc">|</span> location_type <span class="sc">==</span> <span class="st">"mall"</span>, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  date <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2019-07-01"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we want to filter offences that have any one of several different values of the same column, we can use the <code>%in%</code> (in) operator. To filter offences that occurred in either streets or publicly accessible open spaces:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(agg_assault_data, location_category <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"open space"</span>, <span class="st">"street"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The code <code>c("open space", "street")</code> produces what is referred to in R as a <em>vector</em> (sometimes referred to as an <em>atomic vector</em>, especially in error messages). A vector is a one-dimensional sequence of values of the same type (i.e.&nbsp;all numbers, all character strings etc.). For example, a vector might hold several strings of text (as in the vector <code>c("open space", "street")</code>) or a series of numbers such as <code>c(1, 2, 3)</code>. There is lots we could learn about vectors, but for now it’s only necessary to know that we can create vectors with the <code>c()</code> or <em>combine</em> function.</p>
<p>If we wanted to re-use a vector of values several times in our code, it might make sense to store the vector as an object. For example:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create vector of location types we are interested in</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>location_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"open space"</span>, <span class="st">"street"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the data</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(agg_assault_data, location_category <span class="sc">%in%</span> location_types)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, you can filter based on the output of any R function that returns <code>TRUE</code> or <code>FALSE</code>. For example, missing values are represented in R as <code>NA</code>. We can test whether a value is missing using the <code>is.na()</code> function. If we wanted to remove rows from our data that had missing location types, we would filter for those rows that are <em>not</em> <code>NA</code>. We can do this by combining the <code>is.na()</code> function with the <code>!</code> (not) operator:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(agg_assault_data, <span class="sc">!</span><span class="fu">is.na</span>(location_type))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We will see lots more examples of how to use <code>filter()</code> in future tutorials.</p>
<p class="credits">
<a href="https://github.com/allisonhorst/stats-illustrations">Stats Illustrations by Allison Horst</a> licensed under the <a href="https://github.com/allisonhorst/stats-illustrations/blob/master/license">Creative Commons Attribution licence</a>.
</p>
</section>
<section id="transforming-values" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="transforming-values"><span class="header-section-number">3.5</span> Transforming values</h2>
<p>It is often useful to create new columns in our data, or change the values of existing columns. The <code>mutate()</code> function in the <code>dplyr</code> package gives us a way to transform existing columns in our dataset using almost any R function.</p>
<p class="full-width-image">
<img src="https://github.com/mpjashby/crimemapping/raw/main/inst/tutorials/03_data_wrangling/images/mutate.jpg" alt="Cartoon showing furry monsters moving columns of data using a crane.">
</p>
<p><a href="https://lubridate.tidyverse.org/" title="lubridate website"><img src="images/lubridate.png" class="right-side-image"></a></p>
<p>For example, say we wanted to create a new column in our aggravated-assault dataset specifying the day of the week on which each crime occurred. We can do this using the <code>wday()</code> function from the <a href="https://lubridate.tidyverse.org/"><code>lubridate</code></a> package (using the <code>label = TRUE</code> argument to produce weekday names, rather than numbers):</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(agg_assault_data, <span class="at">weekday =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Depending on the width of your screen, you might need to click the <code>▸</code> button to see the new variable.</p>
<p>We can also categorise an existing variable, for example creating a variable to show whether an offence occurred in the northern or southern half of the city:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  agg_assault_data, </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">region =</span> <span class="fu">if_else</span>(latitude <span class="sc">&gt;</span> <span class="fu">median</span>(latitude), <span class="st">"northern"</span>, <span class="st">"southern"</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can change existing columns, although (as with objects) there is no way to undo this so you should only replace columns if you are sure you will not need them. For example, if we wanted to remove the time portion of the <code>date</code> variable (which may sometimes be useful, as shown in the next section) using the <code>as_date()</code> function (also from the <code>lubridate</code> package) and at the same time create the weekday variable:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  agg_assault_data, </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">as_date</span>(date),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">weekday =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You may sometimes want to change only some values in a column. We can do this in various ways, depending on which values we want to change:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  agg_assault_data,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Change a single value with a new value (and otherwise keep the existing </span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># value) using the if_else() function</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">location_type =</span> <span class="fu">if_else</span>(location_type <span class="sc">==</span> <span class="st">"street"</span>, <span class="st">"road"</span>, location_type),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Change multiple values in a categorical variable using the recode() </span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># function, in which values are changed using arguments in the format</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># old_value = new_value</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">location_category =</span> <span class="fu">recode</span>(</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    location_category, </span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"open space"</span> <span class="ot">=</span> <span class="st">"public open space"</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"street"</span> <span class="ot">=</span> <span class="st">"street or road"</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We could also make changes based on more-complicated sets of criteria using the <code>case_when()</code> function, but we will return to that in a future tutorial.</p>
<p>The R functions that you use inside <code>mutate()</code> must return the same number of values as there are rows in the dataset. This is true for most R functions (which are referred to as <em>vectorised</em> functions), but there are some – such as <code>mean()</code> and <code>max()</code> – that return a single value. These summarising functions cannot be used inside <code>mutate()</code> (you will see an error message if you try) but are instead used with the next data-wrangling function we will learn about: <code>summarise()</code>.</p>
<p class="credits">
<a href="https://github.com/allisonhorst/stats-illustrations">Stats Illustrations by Allison Horst</a> licensed under the <a href="https://github.com/allisonhorst/stats-illustrations/blob/master/license">Creative Commons Attribution licence</a>.
</p>
</section>
<section id="summarising-rows" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="summarising-rows"><span class="header-section-number">3.6</span> Summarising rows</h2>
<p>Summarising data is often useful in crime analysis. We can use the <code>summarise()</code> function from the <code>dplyr</code> package to produce summaries of different columns in our data. There is an identical function called <code>summarize()</code> so that you do not have to remember whether to use the US or British spelling.</p>
<p>By default, <code>summarise()</code> collapses data into a single row, with each column summarised using a function that you specify. For example, suppose you want to find out which police station a specialist squad should be based at to most easily respond to reports of serious assaults. You might do this by working out the weighted centre of all the offence locations, i.e.&nbsp;the means of the longitudes and latitudes for all the crimes. You could then base the squad at the police station that was closest to the weighted centre.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  agg_assault_data, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_lng =</span> <span class="fu">mean</span>(longitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_lat =</span> <span class="fu">mean</span>(latitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="box extra-detail">
<h5 id="summarise-box1-title" class="box-title anchored">
What does the argument <code>na.rm = TRUE</code> do?
</h5>
<div id="summarise-box1" class="box-content">
<p>Lots of functions in R have an argument called <code>na.rm</code> that can be set to either <code>TRUE</code> or <code>FALSE</code>. Setting <code>na.rm = TRUE</code> in this case specifies that the <code>mean()</code> function should remove (<code>rm</code>) any missing (<code>NA</code>) values before calculating the mean.</p>
<p>If we do not specify this and our data contain any missing values, the <code>mean()</code> function will return <code>NA</code>. Functions in R do this because it is not possible to completely answer the question ‘what is the mean of these values?’ if some of the values are missing.</p>
<p>This logic applies in lots of cases. For example, if you create an R object called <code>value</code> with the code <code>value &lt;- 2</code> and then run the R code <code>value &gt; 1</code>, you will get the answer <code>TRUE</code>. But if you set the object <code>value</code> to be <code>NA</code> using the code <code>value &lt;- NA</code>, when you run the R code <code>value &gt; 1</code> you will get the answer <code>NA</code>. This is because there is no way to know if the missing value represented by <code>NA</code> is greater than 1 or not. This is why it is often useful to calculate statistics such as a mean value after removing any missing values using the <code>na.rm = TRUE</code> argument.</p>
</div>
</div>
<script>
$("#summarise-box1-title").click(function () { $("#summarise-box1").toggle("slow") })
</script>
<p><code>summarise()</code> becomes more useful if we first divide our data into groups, since we then get a summary for each group separately. We can use the <code>group_by()</code> function to specify which columns denote which group each row is in. So if we wanted to repeat the calculation above, but separately for each value of <code>location_category</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(agg_assault_data, location_category),</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_lng =</span> <span class="fu">mean</span>(longitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_lat =</span> <span class="fu">mean</span>(latitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code might be slightly difficult to read, since the <code>group_by()</code> function is called inside <code>summarise()</code>, but we will learn a way of writing this code that might be easier to read in the final section of this tutorial.</p>
<p>You can add multiple grouping variables if you want to generate summary values for groups within groups:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(agg_assault_data, location_category, location_type),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_lng =</span> <span class="fu">mean</span>(longitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_lat =</span> <span class="fu">mean</span>(latitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="box extra-detail">
<h5 id="summarise-box2-title" class="box-title anchored">
Did you see a message saying <code>`summarise()` has grouped output by 'location_category'</code>?
</h5>
<div id="summarise-box2" class="box-content">
<p>You might have noticed the that code above produced a message specifying how groups have been handled by <code>summarise()</code>. This message reminds you that by default the <code>summarise()</code> functions strips the final level of grouping added by <code>group_by()</code>. This allows us to summarise data using a detailed set of groups and then summarise those summaries using more-general groups. In practice, this ability has been a source of some confusion, so R now prints a message to remind you that the data are still grouped after you run <code>summarise()</code>. If you want to hide this message then you can add <code>.groups = "drop"</code> to the <code>summarise()</code> function to remove all the groups in the data.</p>
</div>
</div>
<script>
$("#summarise-box2-title").click(function () { $("#summarise-box2").toggle("slow") })
</script>
<section id="counting-rows" class="level3" data-number="3.6.1">
<h3 data-number="3.6.1" class="anchored" data-anchor-id="counting-rows"><span class="header-section-number">3.6.1</span> Counting rows</h3>
<p>One form of summarising grouped data is so common that it gets its own function: <code>count()</code>. This simply counts the number of rows of data in each group. So if you wanted to know how many aggravated assaults had occurred in each location category and type:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">count</span>(<span class="fu">group_by</span>(agg_assault_data, location_category, location_type), <span class="at">sort =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>sort = TRUE</code> argument sorts the counts in descending order. You can do more-sophisticated sorting using the <code>arrange()</code> function, which we will learn about in the next section.</p>
</section>
</section>
<section id="arranging-rows" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="arranging-rows"><span class="header-section-number">3.7</span> Arranging rows</h2>
<p>It is sometimes useful to be able to place rows in a dataset into a particular order. We can do this using the <code>arrange()</code> function from the <code>dplyr</code> package. For example, we can sort the aggravated-assault data by date:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(agg_assault_data, date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>By default, <code>arrange()</code> sorts rows in ascending order, i.e.&nbsp;it sorts numeric values from the smallest to the largest, dates from earliest to latest and character values alphabetically. We can instead sort values in descending order by wrapping the name of a column in the <code>desc()</code> function:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(agg_assault_data, <span class="fu">desc</span>(date))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can also sort the data based on multiple columns – the data are sorted first on the first column that you specify, with tied rows then sorted on the subsequent columns in order.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(agg_assault_data, date, <span class="fu">desc</span>(location_type), location_category)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="check-your-understanding" class="level3" data-number="3.7.1">
<h3 data-number="3.7.1" class="anchored" data-anchor-id="check-your-understanding"><span class="header-section-number">3.7.1</span> Check your understanding</h3>
<p><strong>Type the code necessary to arrange <code>agg_assault_data</code> in order of latitude, in descending order (from largest to smallest)</strong></p>
<p>Run your code using the <code>Run Code</code> button, then (if necessary) correct your code and run it again. Once you are happy that your code does what it is intended to do, click the <code>Solution</code> button to check.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(agg_assault_data, <span class="fu">desc</span>(latitude))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="saving-data" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="saving-data"><span class="header-section-number">3.8</span> Saving data</h2>
<p>Once we have finished wrangling a particular dataset, it is often useful to save it to a file so that we can use it again in future without going through all the steps of data wrangling again.</p>
<p>Most R functions that begin with <code>read_</code> (like <code>read_csv()</code> and <code>read_excel()</code>) have equivalent functions that begin <code>write_</code> and which save data into a particular file format. In this example, we will use the <code>write_csv()</code> function from the <code>readr</code> package, which is loaded when we load the <code>tidyverse</code> package.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can write data to a file in the same folder as our R script</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(agg_assault_data, <span class="st">"fort_worth_agg_assault.csv"</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Or another folder on your computer ('../../' is short for the parent folder of</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># the parent folder of the current folder)</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(agg_assault_data, <span class="st">"../../fort_worth_agg_assault.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For very large datasets, we can save a compressed version of the file by adding <code>.gz</code> (for gzip) to the end of the file name, which tells R to compress the file after creating it.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(agg_assault_data, <span class="st">"fort_worth_agg_assault.csv.gz"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>read_csv()</code> can read gzipped CSV files, but some other programs (such as Excel) cannot, so only use this option if you are sure you will only need to open the file in software that can handle it.</p>
<p>There are corresponding write functions for other types of data (which we will come back to when we learn how to handle spatial data), but in this course we will store all non-spatial data in CSV format because it can be read by many different programs.</p>
</section>
<section id="stringing-functions-together" class="level2" data-number="3.9">
<h2 data-number="3.9" class="anchored" data-anchor-id="stringing-functions-together"><span class="header-section-number">3.9</span> Stringing functions together</h2>
<p>In this tutorial we have learned how to use the <code>dplyr</code> functions <code>select()</code>, <code>filter()</code>, <code>mutate()</code>, <code>summarise()</code> and <code>arrange()</code> to wrangle data from one format to another. Data wrangling is part of almost all data analysis, so these are skills we will use frequently.</p>
<p>Data wrangling often involves multiple steps. For example, we might want to load some data, select certain columns, filter some rows, mutate some of the variables, summarise the dataset and save the result. We can do each of these steps separately, assigning the result of each step to a new object.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the lubridate package, since we will need it below</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read San Francisco robbery data</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>robbery1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://github.com/mpjashby/crimemapping/raw/main/inst/extdata/san_francisco_robbery.csv"</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only the columns we need</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>robbery2 <span class="ot">&lt;-</span> <span class="fu">select</span>(robbery1, date_time)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter only those offences that occurred in the first quarter of 2019</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>robbery3 <span class="ot">&lt;-</span> <span class="fu">filter</span>(robbery2, <span class="fu">as.Date</span>(date_time) <span class="sc">&lt;=</span> <span class="fu">as.Date</span>(<span class="st">"2019-03-31"</span>))</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new weekday variable</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>robbery4 <span class="ot">&lt;-</span> <span class="fu">mutate</span>(robbery3, <span class="at">weekday =</span> <span class="fu">wday</span>(date_time, <span class="at">label =</span> <span class="cn">TRUE</span>))</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Count how many offences occurred on each weekday</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>q1_weekday_counts <span class="ot">&lt;-</span> <span class="fu">count</span>(robbery4, weekday)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the first few rows of the result</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(q1_weekday_counts, <span class="at">n =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code works, but involves creating six new objects, even though we only need the final object for our analysis. You may notice that the first argument expected by <code>select()</code>, <code>filter()</code>, <code>mutate()</code> and <code>count()</code> is always the data tibble produced by the previous step. This means we can skip saving the result of each step as a new object, and just run the previous function inside the first function. This approach produces the following code, which produces exactly the same result as the code above.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>q1_weekday_counts <span class="ot">&lt;-</span> <span class="fu">count</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">read_csv</span>(<span class="st">"https://github.com/mpjashby/crimemapping/raw/main/inst/extdata/san_francisco_robbery.csv"</span>),</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>offense_type</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>      ), </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.Date</span>(date_time) <span class="sc">&lt;=</span> <span class="fu">as.Date</span>(<span class="st">"2019-03-31"</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekday =</span> <span class="fu">wday</span>(date_time, <span class="at">label =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(q1_weekday_counts, <span class="at">n =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code works and takes up less space, but it’s quite difficult to read – which can be a problem for finding and fixing problems with your code. For example, it’s quite hard (without counting pairs of parentheses) to work out that the reference to the column <code>weekday</code> on line 13 of this code belongs to the <code>group_by()</code> function on line 2.</p>
<p>It’s possible to write this code so that it is readable and does not require us to create multiple different objects to store the result of each step in our code. This method uses the <code>|&gt;</code> (or <em>pipe</em>) operator. The pipe operator works by using the result of the code on the left-hand side of the pipe as the first argument to a function on the right-hand side. So the code <code>x  |&gt; fun1()  |&gt; fun2(y)</code> is the same as the code <code>fun2(fun1(x), y)</code>, but it is much easier to see that <code>fun1()</code> is run before <code>fun2()</code>. It may be useful to read the pipe operator as ‘and then’, since piped code does the first thing <em>and then</em> the second thing with the result <em>and then</em> the third thing with the result of that, and so on. Piped code (sometimes called a <em>pipeline</em>) is a lot like the series of steps in a recipe.</p>
<p>Since each function we are using returns the new data, and the first argument to all of those functions is the name of the input data object, the pipe means we can just omit the first argument to all except the first function.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>san_fran_rob <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://github.com/mpjashby/crimemapping/raw/main/inst/extdata/san_francisco_robbery.csv"</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>q1_weekday_counts <span class="ot">&lt;-</span> san_fran_rob <span class="sc">|&gt;</span> </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>offense_type) <span class="sc">|&gt;</span> </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.Date</span>(date_time) <span class="sc">&lt;=</span> <span class="fu">as.Date</span>(<span class="st">"2019-03-31"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weekday =</span> <span class="fu">wday</span>(date_time, <span class="at">label =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(weekday)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(q1_weekday_counts, <span class="at">n =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code strikes a good balance between being easy to read and not requiring us to manage lots of intermediate variables. You might not find the pipe operator completely intuitive at the moment, but it will become easier as you see more examples in future tutorials.</p>
<div class="box extra-detail">
<h5 id="pipe-box1-title" class="box-title anchored">
What about the <code>%&gt;%</code> pipe operator?
</h5>
<div id="pipe-box1" class="box-content">
<p>If you have learned any R coding before, you might have learned to use the <code>%&gt;%</code> pipe operator from the <code>magrittr</code> package. The <code>%&gt;%</code> pipe operator was introduced several years ago to allow people to construct pipelines of code in R. The <code>%&gt;%</code> operator was so widely used that the team that writes the R programming language decided to provide a pipe operator in R itself, to avoid the need to load the <code>magrittr</code> package.</p>
<p>You will still see the <code>%&gt;%</code> pipe operator used in lots of R code examples online. In almost all cases, when you see <code>%&gt;%</code> you can replace it with the R pipe operator <code>|&gt;</code>, since they both work in very similar ways.</p>
</div>
</div>
<script>
$("#pipe-box1-title").click(function () { $("#pipe-box1").toggle("slow") })
</script>
<div class="box reading">
<p>You can find out more about how to use the pipe operator in the <a href="https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html">Introducing <code>magrittr</code></a> online tutorial.</p>
</div>
</section>
<section id="in-summary" class="level2" data-number="3.10">
<h2 data-number="3.10" class="anchored" data-anchor-id="in-summary"><span class="header-section-number">3.10</span> In summary</h2>
<div class="box welldone">
<p>In this tutorial, you have learned how to wrangle data in R using functions from packages in the <code>tidyverse</code> suite of packages. You can now construct a complete pipeline of R code to take raw data and transform it into the format(s) we need to effectively map crimes.</p>
</div>
<div class="box reading">
<p>Developing your data wrangling skills will help you to produce better, faster analysis of crime (and other) data. If you would like to develop your skills further, you might be interested in:</p>
<ul>
<li><a href="https://cengel.github.io/R-data-wrangling/">Data Wrangling with R</a> by Claudia Engel, a free online book that explains the functions introduced in this tutorial (and some others) in more detail.</li>
<li><a href="https://posit.co/wp-content/uploads/2022/10/data-transformation-1.pdf">Data transformation with dplyr cheat sheet</a> by the team that makes RStudio, which provides a handy two-page guide to the main functions in the <code>dplyr</code> package, which is very useful for reminding you of the code needed to run each of the functions we have used in this tutorial.</li>
<li><a href="https://rstudio.com/resources/webinars/data-wrangling-with-r-and-rstudio/">Data wrangling with R and RStudio</a> by Garrett Grolemund, a recording of a webinar covering the data-wrangling functions introduced in this tutorial and some other very-useful related functions.</li>
<li><a href="https://r4ds.had.co.nz/">R for Data Science</a> by Hadley Wickham and Garrett Grolemund, a free online book that is the bible for wrangling data in R.</li>
</ul>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../02_your_first_crime_map/index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Your first crime map</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->



</body></html>