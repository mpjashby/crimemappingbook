<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>6&nbsp; Mapping crime patterns – Learn Crime Mapping with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../07_map_context/index.html" rel="next">
<link href="../05_code_with_style/index.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-854d42f42d0f6b455b86ad16a464e311.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<!-- START OF INCLUDED HEADER -->

<!--
This file contains code that will be included in the header of each page of the
quarto book
-->

<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>

<!-- END OF INCLUDED HEADER -->


<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../include/webex.css">
<meta name="twitter:title" content="6&nbsp; Mapping crime patterns – Learn Crime Mapping with R">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="../images/cover_image.png">
<meta name="twitter:image:alt" content="">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../06_mapping_crime_patterns/index.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping crime patterns</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/cover_image.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Learn Crime Mapping with R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mpjashby/crimemappingbook/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install the software needed for this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_getting_started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_your_first_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Your first crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_data_wrangling/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_your_second_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Your second crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_code_with_style/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Code with style</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_mapping_crime_patterns/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping crime patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_map_context/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Giving a map context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_handling_bugs/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Handling bugs in your code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_mapping_areas/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Mapping area data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../10_place_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../11_mapping_hotspots/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../12_messy_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../13_crime_series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Mapping crime series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../14_writing_reports/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Writing reports in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../15_no_maps/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Presenting spatial data without maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../16_mapping_time/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Mapping crime over time</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/read_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Functions for reading data into R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/map_checklist.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Checklist: Making a good crime map</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/common_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Common R errors and how to fix them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/functions_to_avoid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Some R functions you should avoid</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/handling_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Checklist: handling code errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">In this chapter</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">6.1</span> Introduction</a></li>
  <li><a href="#mapping-crime-density" id="toc-mapping-crime-density" class="nav-link" data-scroll-target="#mapping-crime-density"><span class="header-section-number">6.2</span> Mapping crime density</a>
  <ul class="collapse">
  <li><a href="#fine-tuning-cell-size-and-bandwidth" id="toc-fine-tuning-cell-size-and-bandwidth" class="nav-link" data-scroll-target="#fine-tuning-cell-size-and-bandwidth"><span class="header-section-number">6.2.1</span> Fine-tuning cell size and bandwidth</a></li>
  <li><a href="#using-colour-to-show-density" id="toc-using-colour-to-show-density" class="nav-link" data-scroll-target="#using-colour-to-show-density"><span class="header-section-number">6.2.2</span> Using colour to show density</a></li>
  </ul></li>
  <li><a href="#clipping-map-layers" id="toc-clipping-map-layers" class="nav-link" data-scroll-target="#clipping-map-layers"><span class="header-section-number">6.3</span> Clipping map layers</a></li>
  <li><a href="#sec-base-maps" id="toc-sec-base-maps" class="nav-link" data-scroll-target="#sec-base-maps"><span class="header-section-number">6.4</span> Adding a base map</a></li>
  <li><a href="#sec-other-layers" id="toc-sec-other-layers" class="nav-link" data-scroll-target="#sec-other-layers"><span class="header-section-number">6.5</span> Adding more layers</a></li>
  <li><a href="#in-summary" id="toc-in-summary" class="nav-link" data-scroll-target="#in-summary"><span class="header-section-number">6.6</span> In summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-mapping-patterns" class="quarto-section-identifier"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping crime patterns</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="abstract">
<p>This chapter explores techniques for mapping crime patterns using R. You’ll learn how to visualize where crimes are concentrated by transitioning from simple point maps to density maps. Key concepts include kernel density estimation (KDE), working with spatial data layers, and using colour schemes to enhance map clarity. The chapter also addresses practical challenges, such as managing data distortion in projected coordinate systems and clipping map layers to relevant boundaries. By the end, you’ll be able to create informative, visually appealing maps that reveal meaningful patterns in crime data, laying the groundwork for more-advanced mapping techniques later in the course.</p>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Before you start
</div>
</div>
<div class="callout-body-container callout-body">
<p>Open RStudio or – if you already have RStudio open – click <code>Session</code> then <code>Restart R</code>. Make sure you’re working inside the Crime Mapping RStudio project you created in <a href="../01_getting_started/index.html#sec-create-project" class="quarto-xref"><span>Section 1.4.2</span></a>, then you’re ready to start mapping.</p>
</div>
</div>
<section id="introduction" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">6.1</span> Introduction</h2>
<p>In <a href="../04_your_second_crime_map/index.html" class="quarto-xref"><span>Chapter 4</span></a>, we created a map showing bike thefts in the City of Vancouver. But it was hard to see the patterns of theft on this map because too many of the points representing theft locations overlapped. In fact, dot maps are almost never a good way to show patterns of crime. A better way to show where crime is concentrated on a map is to work out the <em>density</em> of crime in each area and then map that density. In this chapter we will learn how to estimate crime density and show it on a map.</p>
<p>Create a new R script file and save it as <code>chapter_06.R</code>, then add this code from <a href="../04_your_second_crime_map/index.html" class="quarto-xref"><span>Chapter 4</span></a>:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_06.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Load packages</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggspatial, sf, sfhotspot, tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># Load and wrangle bike theft data</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Run this code. To do that, highlight all the lines of code and then either:</p>
<ul>
<li>click the <code>Run</code> button at the top of the R script panel, or</li>
<li>press <code>Ctrl+Enter</code> (Windows) or <code>Command+Return</code> (Mac) on your keyboard.</li>
</ul>
</section>
<section id="mapping-crime-density" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="mapping-crime-density"><span class="header-section-number">6.2</span> Mapping crime density</h2>
<p>When we speak about the <em>density</em> of crime, we mean the relative concentration of points in each part of the area we are studying, i.e.&nbsp;how many points (representing bike thefts) are there in each part of the map <em>relative to all the other areas of the map</em>.</p>
<p>To estimate the density of points in different areas of the map, R uses a technique called <em>kernel density estimation</em> (KDE). To do this, R must:</p>
<ol type="1">
<li>divide the map into a grid of cells, each the same size,</li>
<li>count the number of points in each cell,</li>
<li>for each cell, count the number of points in nearby cells, but give less weight to (i.e.&nbsp;systematically undercount) those cells that are further away,</li>
<li>for each cell, total up the count of points in that cell and the (weighted) count of points in nearby cells – this is the estimate of the density of points in that cell.</li>
</ol>
<p>This procedure has the effect of producing a smooth surface representing crime density.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/kde_explanation.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<!-- We don't need to worry at this point about the details of how the counts are used to estimate the density of crimes. -->
<p><a href="https://github.com/mpjashby/sfhotspot/" title="sfhotspot website"><img src="../images/sfhotspot.png" class="right-side-image"></a></p>
<p>There are several ways we can make density maps in R. In this course we will use the <a href="http://pkgs.lesscrime.info/sfhotspot/">sfhotspot package</a> because it makes reasonable default decisions about how density maps should look, while still giving us control over their appearance if we want it. sfhotspot also has other useful functions that we will use in future chapters.</p>
<p>To create a density map using sfhotspot, we first use the <code>hotspot_kde()</code> function to convert a dataset of offence locations to an estimate of the density of offences for each cell in a grid. <code>hotspot_kde()</code> automatically chooses how big the cells in the grid should be (but we can set this ourselves if we want to).</p>
<p>Add this code to the script file for this chapter and then run that line of code:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_06.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Estimate density of bike thefts</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>bike_theft_density <span class="ot">&lt;-</span> <span class="fu">hotspot_kde</span>(</span>
<span id="cb2-3"><a href="#cb2-3"></a>  bike_thefts, </span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.5</span>, </span>
<span id="cb2-5"><a href="#cb2-5"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why did we specify <code>quiet = TRUE</code>?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <code>quiet = TRUE</code> argument to the <code>hotspot_*()</code> family of functions (including <code>hotspot_kde()</code>) stops the function from producing progress messages as we go along. If you experience any problems using the <code>hotspot_kde()</code> function, the best place to start in working out what has happened is to run the code again with the <code>quiet = TRUE</code> argument removed.</p>
</div>
</div>
</div>
<p>As usual, we can use the <code>head()</code> function to check what the resulting object looks like:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">head</span>(bike_theft_density)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 6 features and 2 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 490447.2 ymin: 5450107 xmax: 491647.2 ymax: 5450307
Projected CRS: WGS 84 / UTM zone 10N
# A tibble: 6 × 3
      n   kde                                                           geometry
  &lt;dbl&gt; &lt;dbl&gt;                                                      &lt;POLYGON [m]&gt;
1     0  2.76 ((490447.2 5450107, 490447.2 5450307, 490647.2 5450307, 490647.2 …
2     0  2.24 ((490647.2 5450107, 490647.2 5450307, 490847.2 5450307, 490847.2 …
3     0  2.04 ((490847.2 5450107, 490847.2 5450307, 491047.2 5450307, 491047.2 …
4     0  2.63 ((491047.2 5450107, 491047.2 5450307, 491247.2 5450307, 491247.2 …
5     0  3.24 ((491247.2 5450107, 491247.2 5450307, 491447.2 5450307, 491447.2 …
6     0  3.13 ((491447.2 5450107, 491447.2 5450307, 491647.2 5450307, 491647.2 …</code></pre>
</div>
</div>
<p>The <code>bike_theft_density</code> object created by <code>hotspot_kde()</code> contains three columns: <code>n</code> contains the count of bike thefts in each cell, <code>kde</code> contains the estimate of the density of thefts in each cell, and <code>geometry</code> contains the outline of each grid cell.</p>
<p>Since <code>hotspot_kde()</code> produces an SF object, we can add it to a map using the <code>geom_sf()</code> function. We can also use the <code>fill</code> aesthetic to specify that the fill colour of each grid cell should be determined based on the values of the <code>kde</code> column in the <code>bike_theft_density</code> object.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb5" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> kde), <span class="at">data =</span> bike_theft_density, <span class="at">colour =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We have already seen that we can set aesthetics such as colour and shape manually, but the <code>aes()</code> function allows us to specify that the values of different aesthetics should be controlled by columns in the data. The <code>aes()</code> function takes as its arguments pairs of values (combined with an <code>=</code> symbol) where the first value is an aesthetic and the second value is the name of a column in the data. For example, to use the colour of points on a map to represent different types of crime that were stored in a column in the data called <code>type</code>, we could use <code>aes(colour = type)</code>. In the map above, we use <code>aes(fill = kde)</code> to specify that the fill colour of the grid cells on the map should be controlled by the <code>kde</code> column in the data. This is called <em>mapping</em> a column to an aesthetic.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
When to specify values inside or outside <code>aes()</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>When should you specify the values of aesthetics inside <code>aes()</code> and when should you do it outside <code>aes()</code>?</p>
<ul>
<li>If you want an aesthetic to have a constant value for all the points, lines or other shapes in a layer, control the aesthetic <em>outside</em> <code>aes()</code>. For example, you could use <code>geom_sf(bike_thefts, colour = "mediumblue")</code> to make all the shapes in that layer blue.</li>
<li>If you want to vary the appearance of shapes according to values in the data, you should control the aesthetic <em>inside</em> <code>aes()</code>. For example, you could use <code>geom_sf(aes(colour = month), bike_thefts)</code> to vary the colour of shapes in a layer according to values of the <code>month</code> column in the data.</li>
</ul>
<p>If you specify a constant value for an aesthetic (e.g.&nbsp;<code>colour = "mediumblue"</code>) this will over-ride any mapping for that aesthetic provided by the <code>aes()</code> function (e.g.&nbsp;<code>aes(colour = month)</code>). If you have used <code>aes()</code> to specify that an aesthetic should be controlled based on a column in the data but find that the aesthetic is not changing based on the data, check you have not also specified a constant value for that aesthetic.</p>
<p><strong><code>aes()</code> must be the <em>first</em> argument in the <code>geom_*()</code> function.</strong></p>
</div>
</div>
<p>In this map, instead of seeing each crime as a separate point, we see the density of crime as the filled colour of cells in a grid. By comparing this density map to the point map we produced before, we can see that the density map makes the areas with the highest frequency of thefts slightly easier to identify (although we will improve it much further below).</p>
<p>You can also see that our map now has a legend, showing that higher densities of bike thefts are shown on the map in light blue and lower densities are shown in dark blue. The exact values shown in the legend are not particularly meaningful, so we can ignore these for now.</p>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Density mapping
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>What is a key advantage of using KDE over dot maps for crime data?</strong></p>
<div id="radio_OOPTIFQFUD" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_OOPTIFQFUD" value="answer"> <span>It helps make spatial patterns in data more apparent.</span></label><label><input type="radio" autocomplete="off" name="radio_OOPTIFQFUD" value=""> <span>It shows the exact location of each crime point.</span></label><label><input type="radio" autocomplete="off" name="radio_OOPTIFQFUD" value=""> <span>It allows for interactive maps that users can click on.</span></label><label><input type="radio" autocomplete="off" name="radio_OOPTIFQFUD" value=""> <span>It removes crime data points from the map.</span></label>
</div>
<p><strong>Which R function is used to create a density layer from point data?</strong></p>
<div id="radio_UIDXIRXXLG" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_UIDXIRXXLG" value=""> <span><code>ggplot()</code></span></label><label><input type="radio" autocomplete="off" name="radio_UIDXIRXXLG" value=""> <span><code>hotspot_density()</code></span></label><label><input type="radio" autocomplete="off" name="radio_UIDXIRXXLG" value="answer"> <span><code>hotspot_kde()</code></span></label><label><input type="radio" autocomplete="off" name="radio_UIDXIRXXLG" value=""> <span><code>st_point_to_kde()</code></span></label>
</div>
<p><strong>Which argument in <code>geom_sf()</code> is used to specify that the fill colour of grid cells should be determined by the KDE values?</strong></p>
<div id="radio_QTNWVFZHQM" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_QTNWVFZHQM" value=""> <span><code>colour</code></span></label><label><input type="radio" autocomplete="off" name="radio_QTNWVFZHQM" value="answer"> <span><code>fill</code></span></label><label><input type="radio" autocomplete="off" name="radio_QTNWVFZHQM" value=""> <span><code>shape</code></span></label><label><input type="radio" autocomplete="off" name="radio_QTNWVFZHQM" value=""> <span><code>size</code></span></label>
</div>
<p><strong>What does the <code>st_transform()</code> function do in spatial data operations?</strong></p>
<div id="radio_HCNKKKFXJZ" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_HCNKKKFXJZ" value=""> <span>It combines multiple spatial datasets into one.</span></label><label><input type="radio" autocomplete="off" name="radio_HCNKKKFXJZ" value=""> <span>It filters spatial data to show only relevant points.</span></label><label><input type="radio" autocomplete="off" name="radio_HCNKKKFXJZ" value=""> <span>It calculates the density of points in a specified area.</span></label><label><input type="radio" autocomplete="off" name="radio_HCNKKKFXJZ" value="answer"> <span>It changes the coordinate reference system of a spatial dataset.</span></label>
</div>
</div>
</div>
<section id="fine-tuning-cell-size-and-bandwidth" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="fine-tuning-cell-size-and-bandwidth"><span class="header-section-number">6.2.1</span> Fine-tuning cell size and bandwidth</h3>
<p>We can control the appearance of KDE maps in several ways. For example, we can vary the number of cells in the grid and the definition of what cells the kernel density estimation process should consider to be ‘nearby’ for the purposes of calculating weighted counts. Cells are considered to be ‘nearby’ to a particular cell if they are closer to that cell than a distance known as the KDE <em>bandwidth</em>.</p>
<p>By default, <code>hotspot_kde()</code> chooses the cell size and the bandwidth automatically. The maps below show how changing these defaults changes the appearance of our map (with the legend and axes removed to make the small maps clearer).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/bandwidth.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>By looking at the maps on the right-hand side, you can see that reducing the number of grid cells leads to a map that looks blocky and lacks information. Looking at the maps towards the top of the figure above, you can see that increasing the bandwidth relative to the default makes the density surface smoother. The smoother the surface, the less detail we can see about where crime is most concentrated, until on the top row we can see almost no information at all. On the other hand, if we reduce the bandwidth too much (the bottom row of maps) then almost no ‘nearby’ cells are included in the count and so it becomes more difficult to identify patterns.</p>
<p>In most cases, you will not need to change the cell size used in calculating the density of points on a map, but if you do then you can do this using the <code>cell_size</code> argument to <code>hotspot_kde()</code>. A cell size of about 200 metres is often a good choice for maps showing a whole city, such as our map of Vancouver.</p>
<p>Although you can set the bandwidth manually using the <code>bandwidth</code> argument to <code>hotspot_kde()</code>, you will almost never want to do this. Instead, you can vary the bandwidth relative to the automatically chosen default bandwidth by using the <code>bandwidth_adjust</code> argument. For example, if you wanted to see more detail in your map by using a smaller bandwidth, you could use <code>bandwidth_adjust = 0.75</code> or <code>bandwidth_adjust = 3/4</code> to set the bandwidth to be three-quarters of the default bandwidth.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Start with <code>bandwidth_adjust = 0.5</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>I recommend using a slightly smaller bandwidth than the default, so that your maps show a bit more detail. Try setting <code>bandwidth_adjust = 0.5</code> whenever you produce a density layer using <code>hotspot_kde()</code>, but remember to look at the map to see if you are happy with the result. If you are not happy, try varying the value of <code>bandwidth_adjust</code>. It is possible to set a value greater than 1, but it is very unlikely that this would produce the most-informative possible map.</p>
</div>
</div>
</section>
<section id="using-colour-to-show-density" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="using-colour-to-show-density"><span class="header-section-number">6.2.2</span> Using colour to show density</h3>
<p>The final way we can control the appearance of our density layer is to change the colour scheme used to represent density. To do this, we can use another type of function from the ggplot2 package: <em>scales</em>. Functions in the <code>scale_*()</code> family of functions allow us to control how the mapping between a column in the data and an aesthetic (colour, size, etc.) is represented visually. For example, which colour scheme is used to represent the density of thefts on our map.</p>
<p>There are many <code>scale_*()</code> functions, but the <code>scale_fill_distiller()</code> function produces several different colour scales that are specifically designed to be effective on maps.</p>
<p>Colour schemes can be divided into three types:</p>
<ul>
<li><em>sequential</em> colour schemes are useful for showing values from low to high,</li>
<li><em>diverging</em> colour schemes are useful for showing values relative to a meaningful central point, and</li>
<li><em>qualitative</em> colour schemes are useful for showing separate categories that can appear in any order and still be meaningful.</li>
</ul>
<p>In crime mapping we’re usually interested in showing how crime varies from low to high, so we need to use a <em>sequential</em> colour palette. There are 18 sequential colour schemes (or palettes) available in <code>scales_fill_distiller()</code>, each with a name:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/kde-colours-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Choosing the right type of colour scale
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is important to <strong>only use the right type of colour scale in the right circumstances</strong>, since using the wrong type of scale could end up misleading people reading your map. For example, a diverging colour scale gives the strong impression that the central point in the scale is meaningful.</p>
<p>In some circumstances this might be useful, for example if you wanted to show areas in which crime had increased in shades of one colour and areas in which crime had decreased in shades of another colour. In that case, a diverging scale would be appropriate because the central point represents something meaningful: no change in crime. If the central point is not meaningful, use a sequential colour scheme instead.</p>
<p>If you want to represent a categorical variable, you should use a categorical colour scale unless the categories have a natural order. For example, if you wanted to show ethnic groups on a map you would use a categorical colour scale, since there is no one order of ethnic groups that is any more meaningful than any other. If you wanted to represent days of the week with colour, then you might want to use a sequential colour scheme since the days of the week have a meaningful order.</p>
</div>
</div>
<p>By default, <code>scale_fill_distiller()</code> sets the <em>lowest</em> values to have the darkest colour. This often does not work well, but we can change this by setting the argument <code>direction = 1</code>. I recommend doing this in all cases.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/direction-map-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<p>You can think of all the functions that we can add to <code>ggplot()</code> as being like a stack of pancakes, with each new function being placed on the top of the stack. To change the colour of our map, we just add <code>scale_fill_distiller()</code> to the existing stack. Add this code to the script file <code>chapter_06.R</code> in RStudio:</p>
<div class="cell" data-exercise="true">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_06.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb6" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Plot density map</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> kde), <span class="at">data =</span> bike_theft_density, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"Oranges"</span>, <span class="at">direction =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/map-exercise8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="box reading">
<p>You can find out much more about how colours work in R by reading <a href="https://nrennie.rbind.io/blog/colours-in-r/"><em>Working with colours in R</em></a> and find many different colour palettes you can use with ggplot2 at the <a href="https://r-graph-gallery.com/color-palette-finder">Color Palette Finder</a>.</p>
</div>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Making density maps
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>What R package do we use to make density maps using the <code>hotspot_kde()</code> function?</strong></p>
<div id="radio_KTJNRODKHP" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_KTJNRODKHP" value=""> <span>dplyr</span></label><label><input type="radio" autocomplete="off" name="radio_KTJNRODKHP" value=""> <span>ggplot2</span></label><label><input type="radio" autocomplete="off" name="radio_KTJNRODKHP" value=""> <span>sf</span></label><label><input type="radio" autocomplete="off" name="radio_KTJNRODKHP" value="answer"> <span>sfhotspot</span></label>
</div>
<p><strong>What is the <code>bandwidth_adjust</code> argument of the function <code>hotspot_kde()</code> used for?</strong></p>
<div id="radio_WAISQFMIQU" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_WAISQFMIQU" value="answer"> <span>Adjusting the bandwidth of the density layer, relative to the default bandwidth</span></label><label><input type="radio" autocomplete="off" name="radio_WAISQFMIQU" value=""> <span>Adjusting the cell size of the density layer, relative to the default cell size</span></label><label><input type="radio" autocomplete="off" name="radio_WAISQFMIQU" value=""> <span>Adjusting the colour scheme used to represent density on the map</span></label><label><input type="radio" autocomplete="off" name="radio_WAISQFMIQU" value=""> <span>Adjusting the bandwidth of the density layer, relative to a bandwidth of zero</span></label>
</div>
<p><strong>In what circumstances is it appropriate to use a diverging colour scale, e.g.&nbsp;one that goes from blue to white to red?</strong></p>
<div id="radio_NGSUTRSUDL" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_NGSUTRSUDL" value=""> <span>To represent variation in a variable from low to high</span></label><label><input type="radio" autocomplete="off" name="radio_NGSUTRSUDL" value="answer"> <span>To represent variation in a variable above and below a meaningful mid-point</span></label><label><input type="radio" autocomplete="off" name="radio_NGSUTRSUDL" value=""> <span>To represent variation in a variable from high to low</span></label><label><input type="radio" autocomplete="off" name="radio_NGSUTRSUDL" value=""> <span>To represent categories in a categorical variable</span></label>
</div>
<p><strong>Why is it a bad idea to use a diverging colour scheme for crime density maps?</strong></p>
<div id="radio_FUWMKLTQKN" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_FUWMKLTQKN" value=""> <span>It highlights low-density areas more clearly.</span></label><label><input type="radio" autocomplete="off" name="radio_FUWMKLTQKN" value="answer"> <span>It can mislead the viewer by suggesting a central point of significance.</span></label><label><input type="radio" autocomplete="off" name="radio_FUWMKLTQKN" value=""> <span>It makes the map look too colorful, which can be distracting.</span></label><label><input type="radio" autocomplete="off" name="radio_FUWMKLTQKN" value=""> <span>It hides the areas with the highest crime density.</span></label>
</div>
</div>
</div>
</section>
</section>
<section id="clipping-map-layers" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="clipping-map-layers"><span class="header-section-number">6.3</span> Clipping map layers</h2>
<p>There is one limitation of the KDE layer on our map that we need to deal with. The area covered by the KDE layer is determined by the area covered by the point data that we provided to <code>hotspot_kde()</code>. More specifically, <code>hotspot_kde()</code> will calculate density values for every cell in the <em>convex hull</em> around the point data, i.e.&nbsp;for the smallest polygon that contains all the points in the data.</p>
<p>This can be a problem in some circumstances, because we do not necessarily have crime data for all the areas within the convex hull of the data, even though KDE values will be calculated for those areas. This could be misleading, since it will look like such areas have low crime density, when in fact we do not know what the density of crime in such areas is.</p>
<p>Fortunately, we can easily deal with this problem by <em>clipping</em> the KDE layer to the boundary of the area for which we have crime data. This means we will only show densities for cells for which we actually have data.</p>
<div class="columns">
<div class="column" style="padding-right: 1em;">
<p>A. We only have data on bike thefts from the City of Vancouver, so all the bike thefts in the data necessarily occurred within the city. We do not know what the density of crime outside the city is.</p>
<p><img src="../images/hull_clipping_1.jpg" class="img-fluid" style="width:100.0%"></p>
</div><div class="column" style="padding-left: 1em;">
<p>B. The KDE function only knows the theft locations, not the area in which thefts could have occurred. So the convex hull created by the KDE layer will not necessarily match the area of the data.</p>
<p><img src="../images/hull_clipping_2.jpg" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div class="columns">
<div class="column" style="padding-right: 1em;">
<p>C. In this case, that means some areas (shaded) will be included in the KDE layer even though they happened outside the area covered by the data, which could be misleading.</p>
<p><img src="../images/hull_clipping_3.jpg" class="img-fluid" style="width:100.0%"></p>
</div><div class="column" style="padding-left: 1em;">
<p>D. To avoid suggesting we know the density of crimes in areas for which we do not have data, we should clip the KDE layer to the boundary of the area for which we have data.</p>
<p><img src="../images/hull_clipping_4.jpg" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>To clip the KDE layer to the boundary of the area for which we have data, we need a new dataset that contains the boundary of the City of Vancouver. Fortunately this dataset is available online in a spatial format known as a <a href="https://en.wikipedia.org/wiki/GeoJSON">GeoJSON</a> file. GeoJSON is a spatial file format, so we can load it in R using the <code>read_sf()</code> function from the sf package.</p>
<p>Rather than add the code needed to load this dataset to the end of our script file, it will be neater to add it to the point in the file where we load the other data. That way, if we come back to the file later, all the code that loads datasets will be in one place and it will be easy to see what data is loaded by that script. Add this code to the <code>chapter_06.R</code> file, after the pipeline that loads and wrangles the bike-theft data and before code that creates the <code>bike_theft_density</code> object.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_06.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># Load Vancouver neighbourhood boundaries</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>vancouver_nbhds <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_neighbourhoods.geojson"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:32610"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>You might have noticed that as well as loading the boundary data with <code>read_sf()</code>, we have transformed the data to use the same co-ordinate system (EPSG:32610) as is used for the <code>bike_thefts</code> object. This is because we can only clip datasets that use the same co-ordinate system.</p>
<p>Before we clip the density layer to the city boundary, check that your file <code>chapter_06.R</code> looks like this:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_06.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb8" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># Load packages</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, sfhotspot, tidyverse)</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co"># Load and wrangle bike theft data</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb8-7"><a href="#cb8-7"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb8-8"><a href="#cb8-8"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co"># Load Vancouver neighbourhood boundaries</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>vancouver_nbhds <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_neighbourhoods.geojson"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb8-12"><a href="#cb8-12"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:32610"</span>)</span>
<span id="cb8-13"><a href="#cb8-13"></a></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="co"># Estimate density of bike thefts</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>bike_theft_density <span class="ot">&lt;-</span> <span class="fu">hotspot_kde</span>(</span>
<span id="cb8-16"><a href="#cb8-16"></a>  bike_thefts, </span>
<span id="cb8-17"><a href="#cb8-17"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.5</span>, </span>
<span id="cb8-18"><a href="#cb8-18"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb8-19"><a href="#cb8-19"></a>)</span>
<span id="cb8-20"><a href="#cb8-20"></a></span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="co"># Plot density map</span></span>
<span id="cb8-22"><a href="#cb8-22"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> kde), <span class="at">data =</span> bike_theft_density, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"Oranges"</span>, <span class="at">direction =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We can clip the KDE layer produced by <code>hotspot_kde()</code> to the boundary of the City of Vancouver using the <code>st_intersection()</code> function from the <code>sf</code> package. <code>st_intersection()</code> removes any rows from the dataset provided as the first argument that do not fall within the area covered by the dataset provided as the second argument. We can use <code>st_intersection()</code> to remove any cells in <code>bike_theft_density</code> that are outside the city outline stored in <code>vancouver_nbhds</code>.</p>
<p>We will now add the code needed to clip the KDE layer to the city boundary to the <code>chapter_06.R</code> script file. Since we do not need the unclipped version of the KDE layer, we don’t need to separately estimate the density and clip the result. Instead, we can combine the call to <code>st_intersection()</code> with the existing call to <code>hotspot_kde()</code> to form a pipeline using the pipe (<code>|&gt;</code>) operator. To do that, in the <code>chapter_06.R</code> file replace the line that creates the <code>bike_theft_density</code> object with this code:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_06.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb9" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># Estimate density of bike thefts and clip result</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>bike_theft_density_clip <span class="ot">&lt;-</span> bike_thefts <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="fu">hotspot_kde</span>(<span class="at">bandwidth_adjust =</span> <span class="fl">0.5</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="fu">st_intersection</span>(vancouver_nbhds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
</div>
<p>We can read this code as saying:</p>
<blockquote class="blockquote">
take the <code>bike_thefts</code> object, <br> … use it to estimate the density of thefts<br> … <em>and then</em> clip the resulting density object to the boundary stored in the <code>vancouver_nbhds</code> object.
</blockquote>
<p>If you aren’t comfortable with how the pipe operator works, you might want to refer back to <a href="../03_data_wrangling/index.html#sec-pipe-operator" class="quarto-xref"><span>Section 3.9</span></a>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>st_intersection()</code> requires both objects to use the same co-ordinate system
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>st_intersection()</code> function requires that both spatial layers have the same co-ordinate system. If the two layers use different co-ordinate systems, you will need to transform one of the layers using <code>st_transform()</code> so that it uses the same co-ordinate system as the other layer.</p>
<p>If you do not know which co-ordinate systems the layers use, you can use the <code>st_crs()</code> function to extract the co-ordinate system from one layer and pass that value as the second argument to <code>st_transform()</code>. For example:</p>
<div class="sourceCode" id="cb11" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">st_transform</span>(bike_theft_density, <span class="at">crs =</span> <span class="fu">st_crs</span>(vancouver_nbhds))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning message: <code>attribute values are assumed to be spatially constant</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>st_intersection()</code> produces a warning message:</p>
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially 
constant throughout all geometries</code></pre>
<p>As long as you are simply using <code>st_intersection()</code> to remove parts of the data outside a boundary, you can ignore this message.</p>
</div>
</div>
<p>We can quickly check the effect of clipping the density layer to the city boundary by producing a very basic map that shows both layers in separate colours. Run this code in the R Console:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb13" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_theft_density, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_theft_density_clip, <span class="at">fill =</span> <span class="st">"green"</span>) <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> vancouver_nbhds, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From this map, we can see that while the <code>bike_theft_density</code> object (shown in blue) contains cells outside the black city boundary, the <code>bike_theft_density_clip</code> object (shown in green) contains only cells inside the boundary.</p>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Quiz
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>What is the purpose of the <code>st_intersection()</code> function in spatial data manipulation?</strong></p>
<div id="radio_NYMPEPPVEC" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_NYMPEPPVEC" value=""> <span>To transform one dataset into another coordinate system.</span></label><label><input type="radio" autocomplete="off" name="radio_NYMPEPPVEC" value="answer"> <span>To clip a dataset to the boundary of another spatial layer.</span></label><label><input type="radio" autocomplete="off" name="radio_NYMPEPPVEC" value=""> <span>To merge multiple spatial layers into one.</span></label><label><input type="radio" autocomplete="off" name="radio_NYMPEPPVEC" value=""> <span>To calculate the centroid of spatial objects.</span></label>
</div>
<p><strong>Why is it important to clip a KDE layer to a relevant boundary in crime mapping?</strong></p>
<div id="radio_IDXCITKIJK" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_IDXCITKIJK" value=""> <span>To remove unnecessary layers.</span></label><label><input type="radio" autocomplete="off" name="radio_IDXCITKIJK" value=""> <span>To reduce the overall size of the dataset.</span></label><label><input type="radio" autocomplete="off" name="radio_IDXCITKIJK" value=""> <span>To improve the map’s aesthetic appearance.</span></label><label><input type="radio" autocomplete="off" name="radio_IDXCITKIJK" value="answer"> <span>To avoid showing incorrect density estimates for areas without data.</span></label>
</div>
</div>
</div>
</section>
<section id="sec-base-maps" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="sec-base-maps"><span class="header-section-number">6.4</span> Adding a base map</h2>
<p>The density map we have made is much more effective than a point map at allowing us to identify where the highest number of bike thefts in Vancouver occur. However, it’s still quite difficult to know <em>where</em> those places are, because we cannot easily work out where in the city these places are. We can make this much easier by adding a <em>base map</em> underneath the density layer.</p>
<p>We can add a base map using <code>annotation_map_tile()</code> function from the <a href="https://paleolimbot.github.io/ggspatial/">ggspatial package</a>. We can add <code>annotation_map_tile()</code> to a <code>ggplot()</code> stack in the same way that we would add <code>geom_*()</code> functions. Since we want the base map to appear <em>under</em> the density layer, we add the base map layer to the <code>ggplot()</code> stack <em>first</em>. So that we can see the base map underneath the density layer, we will also make the density layer semi-transparent using the <code>alpha</code> argument to <code>geom_sf()</code>.</p>
<p>Replace the existing <code>ggplot()</code> stack in the <code>chapter_06.R</code> file with this code and then run it:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_06.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb14" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb14-5"><a href="#cb14-5"></a>    <span class="at">data =</span> bike_theft_density_clip, </span>
<span id="cb14-6"><a href="#cb14-6"></a>    <span class="at">alpha =</span> <span class="fl">0.67</span>, </span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>  ) <span class="sc">+</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"Purples"</span>, <span class="at">direction =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The base maps returned by <code>annotation_map_tile()</code> are available at many different <a href="https://wiki.openstreetmap.org/wiki/Zoom_levels">zoom levels</a>, from level 1 that is useful for mapping the whole world in one map, to level 20 that can be used to map a single building. By default, <code>annotation_map_tile()</code> downloads tiles with slightly less detail than we might want, but we can fix this by using the argument <code>zoomin = 0</code>. We could also set a specific zoom level using the <code>zoom</code> argument.</p>
<p>For example, these maps show the same area around the UCL Jill Dando Institute with base maps at different zoom levels.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/zoom.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Choosing the right zoom level is a matter of balancing the level of detail in the map and the clarity of the image. In the maps above, zoom levels less than 12 tend to have pixelated images because they do not contain enough detail, while zoom levels greater than 12 contain too much detail and so the information is hard to read. But if this map covered a smaller or larger area, a different zoom level might be better. In general, setting <code>zoomin = 0</code> and <em>not</em> setting any value for the <code>zoom</code> argument – so that <code>annotation_map_tile()</code> chooses the zoom level automatically – will produce an acceptable map.</p>
<p><code>annotation_map_tile()</code> also gives us access to several different types of base map. The default style (seen in the maps above) is called ‘osm’ because it is the default style used by Open Street Map, the organisation that provides the map data. We can specify which style of base map we want using the <code>type</code> argument to <code>annotation_map_tile()</code>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/basemaps.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>You may want to experiment with different base map styles by using the <code>type</code> argument to <code>annotation_map_tile()</code>, e.g.&nbsp;using <code>annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none")</code>.</p>
<p>One final note about the <code>annotation_map_tile()</code> function: you might have noticed that when we have used it above we have always set the argument <code>progress = "none"</code>. This stops the function from printing a progress bar while it is downloading the map tiles. The progress bar can sometimes be useful, but when you include the output from an R function in a report (as you will learn to do in <a href="../14_writing_reports/index.html" class="quarto-xref"><span>Chapter 14</span></a>), the output from the progress bar is likely to interfere with the formatting of the report. To prevent that, we use the <code>progress = "none"</code> argument.</p>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Base maps
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>What is the purpose of adding a base map to a crime map in R?</strong></p>
<div id="radio_VBOXIBUNET" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_VBOXIBUNET" value=""> <span>To provide information about socio-economic conditions in different places.</span></label><label><input type="radio" autocomplete="off" name="radio_VBOXIBUNET" value="answer"> <span>To provide context on the locations of concentrations of crime.</span></label><label><input type="radio" autocomplete="off" name="radio_VBOXIBUNET" value=""> <span>To stop the map from appearing too visually cluttered</span></label><label><input type="radio" autocomplete="off" name="radio_VBOXIBUNET" value=""> <span>To make a map more visually attractive.</span></label>
</div>
<p><strong>Which R package is commonly used for adding base maps to crime maps?</strong></p>
<div id="radio_KGGIDAALTP" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_KGGIDAALTP" value=""> <span><code>ggplot2</code></span></label><label><input type="radio" autocomplete="off" name="radio_KGGIDAALTP" value=""> <span><code>ggmap</code></span></label><label><input type="radio" autocomplete="off" name="radio_KGGIDAALTP" value="answer"> <span><code>ggspatial</code></span></label><label><input type="radio" autocomplete="off" name="radio_KGGIDAALTP" value=""> <span><code>sfhotspot</code></span></label>
</div>
<p><strong>Why might you need to be careful in choosing the right base map when creating a crime map?</strong></p>
<div id="radio_JHEHGVYLBJ" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_JHEHGVYLBJ" value="answer"> <span>To ensure that it does not distract from the crime data.</span></label><label><input type="radio" autocomplete="off" name="radio_JHEHGVYLBJ" value=""> <span>To fit the base map to the full extent of the dataset.</span></label><label><input type="radio" autocomplete="off" name="radio_JHEHGVYLBJ" value=""> <span>To remove all geographic details and focus only on crime locations.</span></label><label><input type="radio" autocomplete="off" name="radio_JHEHGVYLBJ" value=""> <span>To add unnecessary elements to the map.</span></label>
</div>
</div>
</div>
</section>
<section id="sec-other-layers" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="sec-other-layers"><span class="header-section-number">6.5</span> Adding more layers</h2>
<p><img src="../images/pancakes.jpg" alt="a stack of pancakes" class="right-side-image"></p>
<p>Adding a base map underneath our density layer makes it easier to understand where in Vancouver the highest densities of bike theft are. But our map could make it easier still to see where clusters of thefts occur. We could, for example, add the names of different neighbourhoods in the city, and show the city limits so that we can tell which areas have no crime because crimes in those areas are not included in our data.</p>
<p>In an earlier section I suggested we can think of ggplot charts, including maps, as being like stacks of pancakes – each function we use to amend the appearance of our chart is added to the top of the stack. So to add another layer to our map, we just add another <code>geom_</code> function to our plot.</p>
<p><a href="https://stringr.tidyverse.org/" title="stringr website"><img src="../images/stringr.png" style="width: 33%; max-width: 150px; float: right; margin: 0 0 2em 2em;"></a></p>
<p>At the same time, we can also add labels to the plot at the centre of each neighbourhood using the <code>geom_sf_label()</code> function. <code>geom_sf_label()</code> works like <code>geom_sf()</code> in that it adds a spatial dataset to a map, but instead of adding the points, lines or polygons themselves, <code>geom_sf_label()</code> instead adds labels for those features.</p>
<p>We use the <code>aes()</code> function to specify which column in the <code>vancouver_nbhds</code> dataset we want to use for the label text. If we used <code>head(vancouver_nbhds)</code> to look at the columns in the data, we would see the neighbourhood names are contained in the column called <code>name</code>. Normally, we would use the code <code>aes(label = name)</code> to do this because the label aesthetic is used to set the label text. But in this case we also want to wrap the labels so that they don’t overlap adjacent neighbourhoods. To do this we can use the <code>str_wrap()</code> from the <a href="https://stringr.tidyverse.org">stringr package</a> (part of the tidyverse), so that instead our call to the <code>aes()</code> function becomes <code>aes(label = str_wrap(name, width = 10))</code>.</p>
<p>To see how <code>geom_sf_label()</code> works, let’s create a quick map in the R Console. Paste the following code into the Console and run it:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb15" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> vancouver_nbhds) <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="fu">geom_sf_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="at">width =</span> <span class="dv">10</span>)), <span class="at">data =</span> vancouver_nbhds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s add these labels to the map in our script file. At the same time we will change the style of the labels so that they look better on the map. Do do this, we will add several more arguments to <code>geom_sf_label()</code>:</p>
<ul>
<li><code>alpha = 0.5</code> to make the label background semi-transparent so that we can see the density layer underneath it,</li>
<li><code>colour = "seagreen3"</code> to slightly reduce the prominence of the label text to avoid distracting attention from the density layer,</li>
<li><code>lineheight = 1</code> to reduce the gap between lines in each label,</li>
<li><code>size = 2.5</code> to slightly reduce the size of the label text,</li>
<li><code>label.size = NA</code> to remove the default border around the label background.</li>
</ul>
<p>Replace the existing <code>ggplot()</code> stack in the <code>chapter_06.R</code> file with this stack and then run that code:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_06.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb16" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># Plot density map</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3"></a>  <span class="co"># Add base map</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>  <span class="co"># Add density layer</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb16-7"><a href="#cb16-7"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb16-8"><a href="#cb16-8"></a>    <span class="at">data =</span> bike_theft_density_clip, </span>
<span id="cb16-9"><a href="#cb16-9"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>, </span>
<span id="cb16-10"><a href="#cb16-10"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb16-11"><a href="#cb16-11"></a>  ) <span class="sc">+</span></span>
<span id="cb16-12"><a href="#cb16-12"></a>  <span class="co"># Add neighbourhood boundaries</span></span>
<span id="cb16-13"><a href="#cb16-13"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> vancouver_nbhds, <span class="at">colour =</span> <span class="st">"seagreen3"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb16-14"><a href="#cb16-14"></a>  <span class="co"># Add neighbourhood names</span></span>
<span id="cb16-15"><a href="#cb16-15"></a>  <span class="fu">geom_sf_label</span>(</span>
<span id="cb16-16"><a href="#cb16-16"></a>    <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">10</span>)), </span>
<span id="cb16-17"><a href="#cb16-17"></a>    <span class="at">data =</span> vancouver_nbhds, </span>
<span id="cb16-18"><a href="#cb16-18"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb16-19"><a href="#cb16-19"></a>    <span class="at">colour =</span> <span class="st">"seagreen"</span>, </span>
<span id="cb16-20"><a href="#cb16-20"></a>    <span class="at">lineheight =</span> <span class="dv">1</span>, </span>
<span id="cb16-21"><a href="#cb16-21"></a>    <span class="at">size =</span> <span class="fl">2.5</span>,</span>
<span id="cb16-22"><a href="#cb16-22"></a>    <span class="at">label.size =</span> <span class="cn">NA</span></span>
<span id="cb16-23"><a href="#cb16-23"></a>  ) <span class="sc">+</span></span>
<span id="cb16-24"><a href="#cb16-24"></a>  <span class="co"># Set the colour scale</span></span>
<span id="cb16-25"><a href="#cb16-25"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">direction =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From this map, we can see that bike theft in Vancouver is heavily concentrated in a handful of neighbourhoods, particularly the Downtown and West End neighbourhoods. This map is much more useful than the first map that we produced in <a href="../04_your_second_crime_map/index.html" class="quarto-xref"><span>Chapter 4</span></a> showing only the point location of each crime, since in this latest map we can see not only the greatest concentrations of bike thefts but how they relate to the different areas of the city.</p>
</section>
<section id="in-summary" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="in-summary"><span class="header-section-number">6.6</span> In summary</h2>
<p>In this chapter we have learned to produce a density map of crime. This type of map can be very useful in identifying where practitioners should focus efforts to respond to crime. For example, a map like this might help local police to decide where to send officers to carry out extra patrols, while a crime-prevention charity might decide to run events in particular areas to educate people on how best to protect their bikes.</p>
<p>Now that we have learned all the code for this chapter, your code file should look like this:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_06.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb17" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># Load packages</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, sfhotspot, tidyverse)</span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co"># Load and wrangle bike theft data</span></span>
<span id="cb17-5"><a href="#cb17-5"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-6"><a href="#cb17-6"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-8"><a href="#cb17-8"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span>
<span id="cb17-9"><a href="#cb17-9"></a></span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="co"># Load Vancouver neighbourhood boundaries</span></span>
<span id="cb17-11"><a href="#cb17-11"></a>vancouver_nbhds <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_neighbourhoods.geojson"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-12"><a href="#cb17-12"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:32610"</span>)</span>
<span id="cb17-13"><a href="#cb17-13"></a></span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="co"># Estimate density of bike thefts and clip result</span></span>
<span id="cb17-15"><a href="#cb17-15"></a>bike_theft_density_clip <span class="ot">&lt;-</span> bike_thefts <span class="sc">|&gt;</span> </span>
<span id="cb17-16"><a href="#cb17-16"></a>  <span class="fu">hotspot_kde</span>(<span class="at">bandwidth_adjust =</span> <span class="fl">0.5</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-17"><a href="#cb17-17"></a>  <span class="fu">st_intersection</span>(vancouver_nbhds)</span>
<span id="cb17-18"><a href="#cb17-18"></a></span>
<span id="cb17-19"><a href="#cb17-19"></a><span class="co"># Plot density map</span></span>
<span id="cb17-20"><a href="#cb17-20"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb17-21"><a href="#cb17-21"></a>  <span class="co"># Add base map</span></span>
<span id="cb17-22"><a href="#cb17-22"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb17-23"><a href="#cb17-23"></a>  <span class="co"># Add density layer</span></span>
<span id="cb17-24"><a href="#cb17-24"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb17-25"><a href="#cb17-25"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb17-26"><a href="#cb17-26"></a>    <span class="at">data =</span> bike_theft_density_clip, </span>
<span id="cb17-27"><a href="#cb17-27"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>, </span>
<span id="cb17-28"><a href="#cb17-28"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb17-29"><a href="#cb17-29"></a>  ) <span class="sc">+</span></span>
<span id="cb17-30"><a href="#cb17-30"></a>  <span class="co"># Add neighbourhood boundaries</span></span>
<span id="cb17-31"><a href="#cb17-31"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> vancouver_nbhds, <span class="at">colour =</span> <span class="st">"seagreen3"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb17-32"><a href="#cb17-32"></a>  <span class="co"># Add neighbourhood names</span></span>
<span id="cb17-33"><a href="#cb17-33"></a>  <span class="fu">geom_sf_label</span>(</span>
<span id="cb17-34"><a href="#cb17-34"></a>    <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">10</span>)), </span>
<span id="cb17-35"><a href="#cb17-35"></a>    <span class="at">data =</span> vancouver_nbhds, </span>
<span id="cb17-36"><a href="#cb17-36"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb17-37"><a href="#cb17-37"></a>    <span class="at">colour =</span> <span class="st">"seagreen"</span>, </span>
<span id="cb17-38"><a href="#cb17-38"></a>    <span class="at">lineheight =</span> <span class="dv">1</span>, </span>
<span id="cb17-39"><a href="#cb17-39"></a>    <span class="at">size =</span> <span class="fl">2.5</span>,</span>
<span id="cb17-40"><a href="#cb17-40"></a>    <span class="at">label.size =</span> <span class="cn">NA</span></span>
<span id="cb17-41"><a href="#cb17-41"></a>  ) <span class="sc">+</span></span>
<span id="cb17-42"><a href="#cb17-42"></a>  <span class="co"># Set the colour scale</span></span>
<span id="cb17-43"><a href="#cb17-43"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">direction =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Rows: 21918 Columns: 10
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (3): TYPE, HUNDRED_BLOCK, NEIGHBOURHOOD
dbl (7): YEAR, MONTH, DAY, HOUR, MINUTE, X, Y

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As you read through this code, you might notice that it’s easier to understand than it otherwise might be because:</p>
<ol type="1">
<li>The code is in a logical order: it starts with loading the necessary packages and data, then wrangles that data and finally produces the map.</li>
<li>The code includes <em>only</em> the permanent code needed to produce the final map, not any temporary code that we needed to produce the permanent code. If you aren’t sure about the distinction between permanent and temporary code, look back at <a href="../02_your_first_crime_map/index.html#sec-permanent-code" class="quarto-xref"><span>Section 2.2</span></a>.</li>
<li>Each part of the code is annotated with a comment: a line that starts <code>#</code> and explains what the following block of code does.</li>
</ol>
<p>Save the <code>chapter_06.R</code> file, then restart R to start a new session by clicking on the <code>Session</code> menu and then clicking <code>Restart R</code>. This creates a blank canvas for the next chapter.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tips for producing effective density maps
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Density layers on maps (e.g.&nbsp;a layer added using <code>geom_sf()</code> to display the result produced by <code>hotspot_kde()</code>) should be made semi-transparent so that readers can see the base map underneath. If a density layer is not semi-transparent then it is likely to be very difficult for readers to see exactly where areas of high density are in the real world. Try setting the argument <code>alpha = 0.7</code> in the call to the <code>geom_sf()</code> function, then change that value until you are happy with the visibility of both the density layer and the base map underneath.</li>
<li>Density layers should almost always only show a single type of crime – avoid calculating a single KDE layer based on data that includes more than one type of crime. There are two problems with combining data for multiple crime types to produce a single density layer. First, different crimes often concentrate in different places, so a combined map might end up showing concentrations inaccurately. Second, since the KDE process is based on the number of points, a density layer produced by combining data for multiple crimes will inevitably be more influenced by whichever crime type is more numerous. Since more minor crimes tend to be more common, this could mean that your density map points people towards areas with lots of minor crimes and away from places where more-serious crimes happen.</li>
<li>Avoid mapping ‘intangible’ crimes. These are crimes that are only ever recorded by police when officers happen to identify a crime while on patrol, rather than the crime usually being reported by the victim or a third-party. You should avoid mapping these types of crime because they generally reflect geographic concentrations of police patrol more than geographic concentrations of the crimes themselves. The most common intangible offences are drugs possession and weapons possession, which are detected incidentally by officers on patrol much more than they are reported to the police by the public.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Revision questions
</div>
</div>
<div class="callout-body-container callout-body">
<p>Answer these questions to check you have understood the main points covered in this chapter. Write between 50 and 100 words to answer each question.</p>
<ol type="1">
<li>What is kernel density estimation (KDE), and why is it useful for mapping crime patterns? Explain the process briefly.</li>
<li>Why are density maps often more effective than point maps for visualizing crime patterns? Provide an example to illustrate your answer.</li>
<li>What are the main factors to consider when adjusting the cell size and bandwidth for a KDE map? How can these adjustments affect the map’s appearance and usefulness?</li>
<li>Why is it important to clip density maps to the boundary of the area being analysed? Describe the steps required to achieve this in R.</li>
<li>How does the choice of colour scale affect the interpretation of density maps? Provide an example of when to use sequential, diverging, and categorical colour schemes.</li>
</ol>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";
  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    btn.onclick = check_func;
    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../05_code_with_style/index.html" class="pagination-link" aria-label="Code with style">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Code with style</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../07_map_context/index.html" class="pagination-link" aria-label="Giving a map context">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Giving a map context</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb20" data-shortcodes="false" data-code-line-numbers=""><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu"># Mapping crime patterns {#sec-mapping-patterns}</span></span>
<span id="cb20-2"><a href="#cb20-2"></a></span>
<span id="cb20-3"><a href="#cb20-3"></a>::: {.abstract}</span>
<span id="cb20-4"><a href="#cb20-4"></a>This chapter explores techniques for mapping crime patterns using R. You'll learn how to visualize where crimes are concentrated by transitioning from simple point maps to density maps. Key concepts include kernel density estimation (KDE), working with spatial data layers, and using colour schemes to enhance map clarity. The chapter also addresses practical challenges, such as managing data distortion in projected coordinate systems and clipping map layers to relevant boundaries. By the end, you'll be able to create informative, visually appealing maps that reveal meaningful patterns in crime data, laying the groundwork for more-advanced mapping techniques later in the course.</span>
<span id="cb20-5"><a href="#cb20-5"></a>:::</span>
<span id="cb20-6"><a href="#cb20-6"></a></span>
<span id="cb20-7"><a href="#cb20-7"></a></span>
<span id="cb20-8"><a href="#cb20-8"></a>::: {.callout-tip}</span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="fu">#### Before you start</span></span>
<span id="cb20-10"><a href="#cb20-10"></a></span>
<span id="cb20-11"><a href="#cb20-11"></a>Open RStudio or -- if you already have RStudio open -- click <span class="in">`Session`</span> then <span class="in">`Restart R`</span>. Make sure you're working inside the Crime Mapping RStudio project you created in @sec-create-project, then you're ready to start mapping.</span>
<span id="cb20-12"><a href="#cb20-12"></a>:::</span>
<span id="cb20-13"><a href="#cb20-13"></a></span>
<span id="cb20-14"><a href="#cb20-14"></a></span>
<span id="cb20-15"><a href="#cb20-15"></a><span class="in">```{r setup}</span></span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="in">#| echo: false</span></span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="in">#| include: false</span></span>
<span id="cb20-18"><a href="#cb20-18"></a></span>
<span id="cb20-19"><a href="#cb20-19"></a><span class="in"># Load packages</span></span>
<span id="cb20-20"><a href="#cb20-20"></a><span class="in">pacman::p_load(patchwork)</span></span>
<span id="cb20-21"><a href="#cb20-21"></a><span class="in">```</span></span>
<span id="cb20-22"><a href="#cb20-22"></a></span>
<span id="cb20-23"><a href="#cb20-23"></a></span>
<span id="cb20-24"><a href="#cb20-24"></a></span>
<span id="cb20-25"><a href="#cb20-25"></a><span class="fu">## Introduction</span></span>
<span id="cb20-26"><a href="#cb20-26"></a></span>
<span id="cb20-27"><a href="#cb20-27"></a>In @sec-second-map, we created a map showing bike thefts in the City of Vancouver. But it was hard to see the patterns of theft on this map because too many of the points representing theft locations overlapped. In fact, dot maps are almost never a good way to show patterns of crime. A better way to show where crime is concentrated on a map is to work out the *density* of crime in each area and then map that density. In this chapter we will learn how to estimate crime density and show it on a map.</span>
<span id="cb20-28"><a href="#cb20-28"></a></span>
<span id="cb20-29"><a href="#cb20-29"></a>Create a new R script file and save it as <span class="in">`chapter_06.R`</span>, then add this code from @sec-second-map:</span>
<span id="cb20-30"><a href="#cb20-30"></a></span>
<span id="cb20-33"><a href="#cb20-33"></a><span class="in">```{r}</span></span>
<span id="cb20-34"><a href="#cb20-34"></a><span class="co">#| output: false</span></span>
<span id="cb20-35"><a href="#cb20-35"></a><span class="co">#| filename: "chapter_06.R"</span></span>
<span id="cb20-36"><a href="#cb20-36"></a></span>
<span id="cb20-37"><a href="#cb20-37"></a><span class="co"># Load packages</span></span>
<span id="cb20-38"><a href="#cb20-38"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggspatial, sf, sfhotspot, tidyverse)</span>
<span id="cb20-39"><a href="#cb20-39"></a></span>
<span id="cb20-40"><a href="#cb20-40"></a><span class="co"># Load and wrangle bike theft data</span></span>
<span id="cb20-41"><a href="#cb20-41"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-42"><a href="#cb20-42"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-43"><a href="#cb20-43"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-44"><a href="#cb20-44"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span>
<span id="cb20-45"><a href="#cb20-45"></a><span class="in">```</span></span>
<span id="cb20-46"><a href="#cb20-46"></a></span>
<span id="cb20-47"><a href="#cb20-47"></a>Run this code. To do that, highlight all the lines of code and then either:</span>
<span id="cb20-48"><a href="#cb20-48"></a></span>
<span id="cb20-49"><a href="#cb20-49"></a><span class="ss">* </span>click the <span class="in">`Run`</span> button at the top of the R script panel, or</span>
<span id="cb20-50"><a href="#cb20-50"></a><span class="ss">* </span>press <span class="in">`Ctrl+Enter`</span> (Windows) or <span class="in">`Command+Return`</span> (Mac) on your keyboard.</span>
<span id="cb20-51"><a href="#cb20-51"></a></span>
<span id="cb20-52"><a href="#cb20-52"></a></span>
<span id="cb20-53"><a href="#cb20-53"></a></span>
<span id="cb20-54"><a href="#cb20-54"></a><span class="fu">## Mapping crime density</span></span>
<span id="cb20-55"><a href="#cb20-55"></a></span>
<span id="cb20-56"><a href="#cb20-56"></a>When we speak about the *density* of crime, we mean the relative concentration of points in each part of the area we are studying, i.e. how many points (representing bike thefts) are there in each part of the map _relative to all the other areas of the map_.</span>
<span id="cb20-57"><a href="#cb20-57"></a></span>
<span id="cb20-58"><a href="#cb20-58"></a>To estimate the density of points in different areas of the map, R uses a technique called *kernel density estimation* (KDE). To do this, R must:</span>
<span id="cb20-59"><a href="#cb20-59"></a></span>
<span id="cb20-60"><a href="#cb20-60"></a><span class="ss">  1. </span>divide the map into a grid of cells, each the same size,</span>
<span id="cb20-61"><a href="#cb20-61"></a><span class="ss">  2. </span>count the number of points in each cell,</span>
<span id="cb20-62"><a href="#cb20-62"></a><span class="ss">  3. </span>for each cell, count the number of points in nearby cells, but give less weight to (i.e. systematically undercount) those cells that are further away,</span>
<span id="cb20-63"><a href="#cb20-63"></a><span class="ss">  4. </span>for each cell, total up the count of points in that cell and the (weighted) count of points in nearby cells – this is the estimate of the density of points in that cell.</span>
<span id="cb20-64"><a href="#cb20-64"></a></span>
<span id="cb20-65"><a href="#cb20-65"></a>This procedure has the effect of producing a smooth surface representing crime density. </span>
<span id="cb20-66"><a href="#cb20-66"></a></span>
<span id="cb20-67"><a href="#cb20-67"></a></span>
<span id="cb20-68"><a href="#cb20-68"></a><span class="in">```{r kde-explanation}</span></span>
<span id="cb20-69"><a href="#cb20-69"></a><span class="in">#| eval: false</span></span>
<span id="cb20-70"><a href="#cb20-70"></a><span class="in">#| echo: false</span></span>
<span id="cb20-71"><a href="#cb20-71"></a></span>
<span id="cb20-72"><a href="#cb20-72"></a><span class="in">random_points &lt;- tibble(x = rnorm(50, sd = 50), y = rnorm(50, sd = 50)) |&gt; </span></span>
<span id="cb20-73"><a href="#cb20-73"></a><span class="in">  filter(between(x, -40 * 3, 40 * 3), between(y, -40 * 3, 40 * 3)) |&gt; </span></span>
<span id="cb20-74"><a href="#cb20-74"></a><span class="in">  # Choose any projected CRS</span></span>
<span id="cb20-75"><a href="#cb20-75"></a><span class="in">  st_as_sf(coords = c("x", "y"), crs = "EPSG:27700")</span></span>
<span id="cb20-76"><a href="#cb20-76"></a></span>
<span id="cb20-77"><a href="#cb20-77"></a><span class="in"># Create the grid separately, so we can be sure what limits it will have</span></span>
<span id="cb20-78"><a href="#cb20-78"></a><span class="in">random_points_grid &lt;- tibble(</span></span>
<span id="cb20-79"><a href="#cb20-79"></a><span class="in">  x = c(-40 * 3, 40 * 3, 40 * 3, -40 * 3), </span></span>
<span id="cb20-80"><a href="#cb20-80"></a><span class="in">  y = c(-40 * 3, 40 * 3, -40 * 3, 40 * 3)</span></span>
<span id="cb20-81"><a href="#cb20-81"></a><span class="in">) |&gt; </span></span>
<span id="cb20-82"><a href="#cb20-82"></a><span class="in">  st_as_sf(coords = c("x", "y"), crs = "EPSG:27700") |&gt; </span></span>
<span id="cb20-83"><a href="#cb20-83"></a><span class="in">  hotspot_grid(cell_size = 40)</span></span>
<span id="cb20-84"><a href="#cb20-84"></a></span>
<span id="cb20-85"><a href="#cb20-85"></a><span class="in">random_points_kde &lt;- random_points |&gt; </span></span>
<span id="cb20-86"><a href="#cb20-86"></a><span class="in">  hotspot_kde(grid = random_points_grid, quiet = TRUE) |&gt; </span></span>
<span id="cb20-87"><a href="#cb20-87"></a><span class="in">  mutate(</span></span>
<span id="cb20-88"><a href="#cb20-88"></a><span class="in">    label_n = if_else(n &gt; 0, n, NA_real_),</span></span>
<span id="cb20-89"><a href="#cb20-89"></a><span class="in">    label_kde = scales::number(kde, accuracy = 0.1)</span></span>
<span id="cb20-90"><a href="#cb20-90"></a><span class="in">  )</span></span>
<span id="cb20-91"><a href="#cb20-91"></a></span>
<span id="cb20-92"><a href="#cb20-92"></a><span class="in">random_points_kde[, c("coord_x", "coord_y")] &lt;- random_points_kde |&gt; </span></span>
<span id="cb20-93"><a href="#cb20-93"></a><span class="in">  st_centroid() |&gt; </span></span>
<span id="cb20-94"><a href="#cb20-94"></a><span class="in">  st_coordinates()</span></span>
<span id="cb20-95"><a href="#cb20-95"></a></span>
<span id="cb20-96"><a href="#cb20-96"></a><span class="in">kde_explanation &lt;- list()</span></span>
<span id="cb20-97"><a href="#cb20-97"></a></span>
<span id="cb20-98"><a href="#cb20-98"></a><span class="in">kde_explanation[["1"]] &lt;- ggplot(random_points_kde) +</span></span>
<span id="cb20-99"><a href="#cb20-99"></a><span class="in">  geom_sf(data = random_points, colour = "grey50") +</span></span>
<span id="cb20-100"><a href="#cb20-100"></a><span class="in">  geom_sf(fill = NA) +</span></span>
<span id="cb20-101"><a href="#cb20-101"></a><span class="in">  labs(</span></span>
<span id="cb20-102"><a href="#cb20-102"></a><span class="in">    title = str_wrap(</span></span>
<span id="cb20-103"><a href="#cb20-103"></a><span class="in">      "1. Create a grid of cells covering the area covered by the points", </span></span>
<span id="cb20-104"><a href="#cb20-104"></a><span class="in">      width = 36</span></span>
<span id="cb20-105"><a href="#cb20-105"></a><span class="in">    )</span></span>
<span id="cb20-106"><a href="#cb20-106"></a><span class="in">  ) +</span></span>
<span id="cb20-107"><a href="#cb20-107"></a><span class="in">  theme_void() +</span></span>
<span id="cb20-108"><a href="#cb20-108"></a><span class="in">  theme(</span></span>
<span id="cb20-109"><a href="#cb20-109"></a><span class="in">    plot.title = element_text(lineheight = 0.9, size = 10)</span></span>
<span id="cb20-110"><a href="#cb20-110"></a><span class="in">  )</span></span>
<span id="cb20-111"><a href="#cb20-111"></a></span>
<span id="cb20-112"><a href="#cb20-112"></a><span class="in">kde_explanation[["2"]] &lt;- ggplot(random_points_kde) +</span></span>
<span id="cb20-113"><a href="#cb20-113"></a><span class="in">  geom_sf(data = random_points, colour = "grey75") +</span></span>
<span id="cb20-114"><a href="#cb20-114"></a><span class="in">  geom_sf(fill = NA) +</span></span>
<span id="cb20-115"><a href="#cb20-115"></a><span class="in">  geom_sf_label(</span></span>
<span id="cb20-116"><a href="#cb20-116"></a><span class="in">    aes(label = label_n), </span></span>
<span id="cb20-117"><a href="#cb20-117"></a><span class="in">    na.rm = TRUE, </span></span>
<span id="cb20-118"><a href="#cb20-118"></a><span class="in">    fill = NA, </span></span>
<span id="cb20-119"><a href="#cb20-119"></a><span class="in">    label.size = NA,</span></span>
<span id="cb20-120"><a href="#cb20-120"></a><span class="in">    size = 2.25</span></span>
<span id="cb20-121"><a href="#cb20-121"></a><span class="in">  ) +</span></span>
<span id="cb20-122"><a href="#cb20-122"></a><span class="in">  labs(</span></span>
<span id="cb20-123"><a href="#cb20-123"></a><span class="in">    title = str_wrap(</span></span>
<span id="cb20-124"><a href="#cb20-124"></a><span class="in">      "2. Count the number of points in each cell", </span></span>
<span id="cb20-125"><a href="#cb20-125"></a><span class="in">      width = 36</span></span>
<span id="cb20-126"><a href="#cb20-126"></a><span class="in">    )</span></span>
<span id="cb20-127"><a href="#cb20-127"></a><span class="in">  ) +</span></span>
<span id="cb20-128"><a href="#cb20-128"></a><span class="in">  theme_void() +</span></span>
<span id="cb20-129"><a href="#cb20-129"></a><span class="in">  theme(</span></span>
<span id="cb20-130"><a href="#cb20-130"></a><span class="in">    plot.title = element_text(lineheight = 0.9, size = 10)</span></span>
<span id="cb20-131"><a href="#cb20-131"></a><span class="in">  )</span></span>
<span id="cb20-132"><a href="#cb20-132"></a></span>
<span id="cb20-133"><a href="#cb20-133"></a><span class="in">kde_aw &lt;- arrow(length = unit(1.5, "mm"), type = "closed")</span></span>
<span id="cb20-134"><a href="#cb20-134"></a></span>
<span id="cb20-135"><a href="#cb20-135"></a><span class="in">kde_explanation[["3"]] &lt;- ggplot() +</span></span>
<span id="cb20-136"><a href="#cb20-136"></a><span class="in">  geom_sf(data = random_points_kde, fill = NA) +</span></span>
<span id="cb20-137"><a href="#cb20-137"></a><span class="in">  geom_sf(</span></span>
<span id="cb20-138"><a href="#cb20-138"></a><span class="in">    data = filter(</span></span>
<span id="cb20-139"><a href="#cb20-139"></a><span class="in">      random_points_kde, </span></span>
<span id="cb20-140"><a href="#cb20-140"></a><span class="in">      between(coord_x, -20, 20), </span></span>
<span id="cb20-141"><a href="#cb20-141"></a><span class="in">      between(coord_y, -20, 20)</span></span>
<span id="cb20-142"><a href="#cb20-142"></a><span class="in">    ), </span></span>
<span id="cb20-143"><a href="#cb20-143"></a><span class="in">    colour = "darkred",</span></span>
<span id="cb20-144"><a href="#cb20-144"></a><span class="in">    fill = NA,</span></span>
<span id="cb20-145"><a href="#cb20-145"></a><span class="in">    linewidth = 1</span></span>
<span id="cb20-146"><a href="#cb20-146"></a><span class="in">  ) +</span></span>
<span id="cb20-147"><a href="#cb20-147"></a><span class="in">  geom_sf_label(</span></span>
<span id="cb20-148"><a href="#cb20-148"></a><span class="in">    aes(label = n), </span></span>
<span id="cb20-149"><a href="#cb20-149"></a><span class="in">    data = filter(</span></span>
<span id="cb20-150"><a href="#cb20-150"></a><span class="in">      random_points_kde, </span></span>
<span id="cb20-151"><a href="#cb20-151"></a><span class="in">      between(coord_x, -40, 40), </span></span>
<span id="cb20-152"><a href="#cb20-152"></a><span class="in">      between(coord_y, -40, 40)</span></span>
<span id="cb20-153"><a href="#cb20-153"></a><span class="in">    ), </span></span>
<span id="cb20-154"><a href="#cb20-154"></a><span class="in">    na.rm = TRUE, </span></span>
<span id="cb20-155"><a href="#cb20-155"></a><span class="in">    fill = NA, </span></span>
<span id="cb20-156"><a href="#cb20-156"></a><span class="in">    label.size = NA,</span></span>
<span id="cb20-157"><a href="#cb20-157"></a><span class="in">    size = 2.25</span></span>
<span id="cb20-158"><a href="#cb20-158"></a><span class="in">  ) +</span></span>
<span id="cb20-159"><a href="#cb20-159"></a><span class="in">  geom_circle(</span></span>
<span id="cb20-160"><a href="#cb20-160"></a><span class="in">    aes(x0 = x, y0 = y, r = r), </span></span>
<span id="cb20-161"><a href="#cb20-161"></a><span class="in">    data = tibble(x = 0, y = 0, r = 40 * 1.5), </span></span>
<span id="cb20-162"><a href="#cb20-162"></a><span class="in">    colour = "darkred", </span></span>
<span id="cb20-163"><a href="#cb20-163"></a><span class="in">    fill = NA, </span></span>
<span id="cb20-164"><a href="#cb20-164"></a><span class="in">    linetype = "23", </span></span>
<span id="cb20-165"><a href="#cb20-165"></a><span class="in">    size = 1.5</span></span>
<span id="cb20-166"><a href="#cb20-166"></a><span class="in">  ) +</span></span>
<span id="cb20-167"><a href="#cb20-167"></a><span class="in">  # Right</span></span>
<span id="cb20-168"><a href="#cb20-168"></a><span class="in">  annotate("segment", x = 12, y = 0, xend = 32, yend = 0, arrow = kde_aw, colour = "grey40") +</span></span>
<span id="cb20-169"><a href="#cb20-169"></a><span class="in">  # Lower right</span></span>
<span id="cb20-170"><a href="#cb20-170"></a><span class="in">  annotate("segment", x = 10, y = -10, xend = 30, yend = -30, arrow = kde_aw, colour = "grey40") +</span></span>
<span id="cb20-171"><a href="#cb20-171"></a><span class="in">  # Bottom</span></span>
<span id="cb20-172"><a href="#cb20-172"></a><span class="in">  annotate("segment", x = 0, y = -12, xend = 0, yend = -32, arrow = kde_aw, colour = "grey40") +</span></span>
<span id="cb20-173"><a href="#cb20-173"></a><span class="in">  # Lower left</span></span>
<span id="cb20-174"><a href="#cb20-174"></a><span class="in">  annotate("segment", x = -10, y = -10, xend = -30, yend = -30, arrow = kde_aw, colour = "grey40") +</span></span>
<span id="cb20-175"><a href="#cb20-175"></a><span class="in">  # Left</span></span>
<span id="cb20-176"><a href="#cb20-176"></a><span class="in">  annotate("segment", x = -12, y = 0, xend = -32, yend = 0, arrow = kde_aw, colour = "grey40") +</span></span>
<span id="cb20-177"><a href="#cb20-177"></a><span class="in">  # Upper left</span></span>
<span id="cb20-178"><a href="#cb20-178"></a><span class="in">  annotate("segment", x = -10, y = 10, xend = -30, yend = 30, arrow = kde_aw, colour = "grey40") +</span></span>
<span id="cb20-179"><a href="#cb20-179"></a><span class="in">  # Top</span></span>
<span id="cb20-180"><a href="#cb20-180"></a><span class="in">  annotate("segment", x = 0, y = 12, xend = 0, yend = 32, arrow = kde_aw, colour = "grey40") +</span></span>
<span id="cb20-181"><a href="#cb20-181"></a><span class="in">  # Upper right</span></span>
<span id="cb20-182"><a href="#cb20-182"></a><span class="in">  annotate("segment", x = 10, y = 10, xend = 30, yend = 30, arrow = kde_aw, colour = "grey40") +</span></span>
<span id="cb20-183"><a href="#cb20-183"></a><span class="in">  labs(</span></span>
<span id="cb20-184"><a href="#cb20-184"></a><span class="in">    title = str_wrap(</span></span>
<span id="cb20-185"><a href="#cb20-185"></a><span class="in">      "3. Identify the counts in the cells surrounding each cell", </span></span>
<span id="cb20-186"><a href="#cb20-186"></a><span class="in">      width = 36</span></span>
<span id="cb20-187"><a href="#cb20-187"></a><span class="in">    )</span></span>
<span id="cb20-188"><a href="#cb20-188"></a><span class="in">  ) +</span></span>
<span id="cb20-189"><a href="#cb20-189"></a><span class="in">  theme_void() +</span></span>
<span id="cb20-190"><a href="#cb20-190"></a><span class="in">  theme(</span></span>
<span id="cb20-191"><a href="#cb20-191"></a><span class="in">    plot.title = element_text(lineheight = 0.9, size = 10)</span></span>
<span id="cb20-192"><a href="#cb20-192"></a><span class="in">  )</span></span>
<span id="cb20-193"><a href="#cb20-193"></a></span>
<span id="cb20-194"><a href="#cb20-194"></a><span class="in">kde_explanation[["4"]] &lt;- ggplot(random_points_kde) +</span></span>
<span id="cb20-195"><a href="#cb20-195"></a><span class="in">  geom_sf(fill = NA) +</span></span>
<span id="cb20-196"><a href="#cb20-196"></a><span class="in">  geom_sf_label(</span></span>
<span id="cb20-197"><a href="#cb20-197"></a><span class="in">    aes(label = label_kde), </span></span>
<span id="cb20-198"><a href="#cb20-198"></a><span class="in">    na.rm = TRUE, </span></span>
<span id="cb20-199"><a href="#cb20-199"></a><span class="in">    fill = NA, </span></span>
<span id="cb20-200"><a href="#cb20-200"></a><span class="in">    label.size = NA,</span></span>
<span id="cb20-201"><a href="#cb20-201"></a><span class="in">    size = 2.25</span></span>
<span id="cb20-202"><a href="#cb20-202"></a><span class="in">  ) +</span></span>
<span id="cb20-203"><a href="#cb20-203"></a><span class="in">  labs(</span></span>
<span id="cb20-204"><a href="#cb20-204"></a><span class="in">    title = str_wrap(</span></span>
<span id="cb20-205"><a href="#cb20-205"></a><span class="in">      "4. Use those counts to estimate the underlying density", </span></span>
<span id="cb20-206"><a href="#cb20-206"></a><span class="in">      width = 36</span></span>
<span id="cb20-207"><a href="#cb20-207"></a><span class="in">    )</span></span>
<span id="cb20-208"><a href="#cb20-208"></a><span class="in">  ) +</span></span>
<span id="cb20-209"><a href="#cb20-209"></a><span class="in">  theme_void() +</span></span>
<span id="cb20-210"><a href="#cb20-210"></a><span class="in">  theme(</span></span>
<span id="cb20-211"><a href="#cb20-211"></a><span class="in">    plot.title = element_text(lineheight = 0.9, size = 10)</span></span>
<span id="cb20-212"><a href="#cb20-212"></a><span class="in">  )</span></span>
<span id="cb20-213"><a href="#cb20-213"></a></span>
<span id="cb20-214"><a href="#cb20-214"></a><span class="in">kde_explanation_plot &lt;- wrap_plots(kde_explanation, ncol = 2)</span></span>
<span id="cb20-215"><a href="#cb20-215"></a></span>
<span id="cb20-216"><a href="#cb20-216"></a><span class="in">ggsave(</span></span>
<span id="cb20-217"><a href="#cb20-217"></a><span class="in">  here::here("images/kde_explanation.jpg"), </span></span>
<span id="cb20-218"><a href="#cb20-218"></a><span class="in">  kde_explanation_plot, </span></span>
<span id="cb20-219"><a href="#cb20-219"></a><span class="in">  width = 800 / 150, </span></span>
<span id="cb20-220"><a href="#cb20-220"></a><span class="in">  height = 800 / 150, </span></span>
<span id="cb20-221"><a href="#cb20-221"></a><span class="in">  dpi = 150</span></span>
<span id="cb20-222"><a href="#cb20-222"></a><span class="in">)</span></span>
<span id="cb20-223"><a href="#cb20-223"></a><span class="in">```</span></span>
<span id="cb20-224"><a href="#cb20-224"></a></span>
<span id="cb20-225"><a href="#cb20-225"></a><span class="in">```{r kde-explanation-map}</span></span>
<span id="cb20-226"><a href="#cb20-226"></a><span class="in">#| echo: false</span></span>
<span id="cb20-227"><a href="#cb20-227"></a><span class="in">#| fig.align: center</span></span>
<span id="cb20-228"><a href="#cb20-228"></a><span class="in">#| out.width: 80%</span></span>
<span id="cb20-229"><a href="#cb20-229"></a></span>
<span id="cb20-230"><a href="#cb20-230"></a><span class="in">knitr::include_graphics(here::here("images/kde_explanation.jpg"))</span></span>
<span id="cb20-231"><a href="#cb20-231"></a><span class="in">```</span></span>
<span id="cb20-232"><a href="#cb20-232"></a></span>
<span id="cb20-233"><a href="#cb20-233"></a><span class="co">&lt;!-- We don't need to worry at this point about the details of how the counts are used to estimate the density of crimes. --&gt;</span></span>
<span id="cb20-234"><a href="#cb20-234"></a></span>
<span id="cb20-235"><a href="#cb20-235"></a>&lt;a href="https://github.com/mpjashby/sfhotspot/" title="sfhotspot website"&gt;&lt;img src="../images/sfhotspot.png" class="right-side-image"&gt;&lt;/a&gt;</span>
<span id="cb20-236"><a href="#cb20-236"></a></span>
<span id="cb20-237"><a href="#cb20-237"></a>There are several ways we can make density maps in R. In this course we will use the <span class="co">[</span><span class="ot">sfhotspot package</span><span class="co">](http://pkgs.lesscrime.info/sfhotspot/)</span> because it makes reasonable default decisions about how density maps should look, while still giving us control over their appearance if we want it. sfhotspot also has other useful functions that we will use in future chapters.</span>
<span id="cb20-238"><a href="#cb20-238"></a></span>
<span id="cb20-239"><a href="#cb20-239"></a>To create a density map using sfhotspot, we first use the <span class="in">`hotspot_kde()`</span> function to convert a dataset of offence locations to an estimate of the density of offences for each cell in a grid. <span class="in">`hotspot_kde()`</span> automatically chooses how big the cells in the grid should be (but we can set this ourselves if we want to).</span>
<span id="cb20-240"><a href="#cb20-240"></a></span>
<span id="cb20-241"><a href="#cb20-241"></a>Add this code to the script file for this chapter and then run that line of code:</span>
<span id="cb20-242"><a href="#cb20-242"></a></span>
<span id="cb20-245"><a href="#cb20-245"></a><span class="in">```{r}</span></span>
<span id="cb20-246"><a href="#cb20-246"></a><span class="co">#| filename: "chapter_06.R"</span></span>
<span id="cb20-247"><a href="#cb20-247"></a></span>
<span id="cb20-248"><a href="#cb20-248"></a><span class="co"># Estimate density of bike thefts</span></span>
<span id="cb20-249"><a href="#cb20-249"></a>bike_theft_density <span class="ot">&lt;-</span> <span class="fu">hotspot_kde</span>(</span>
<span id="cb20-250"><a href="#cb20-250"></a>  bike_thefts, </span>
<span id="cb20-251"><a href="#cb20-251"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.5</span>, </span>
<span id="cb20-252"><a href="#cb20-252"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb20-253"><a href="#cb20-253"></a>)</span>
<span id="cb20-254"><a href="#cb20-254"></a><span class="in">```</span></span>
<span id="cb20-255"><a href="#cb20-255"></a></span>
<span id="cb20-256"><a href="#cb20-256"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb20-257"><a href="#cb20-257"></a><span class="fu">#### Why did we specify `quiet = TRUE`?</span></span>
<span id="cb20-258"><a href="#cb20-258"></a></span>
<span id="cb20-259"><a href="#cb20-259"></a>The <span class="in">`quiet = TRUE`</span> argument to the <span class="in">`hotspot_*()`</span> family of functions (including <span class="in">`hotspot_kde()`</span>) stops the function from producing progress messages as we go along. If you experience any problems using the <span class="in">`hotspot_kde()`</span> function, the best place to start in working out what has happened is to run the code again with the <span class="in">`quiet = TRUE`</span> argument removed.</span>
<span id="cb20-260"><a href="#cb20-260"></a>:::</span>
<span id="cb20-261"><a href="#cb20-261"></a></span>
<span id="cb20-262"><a href="#cb20-262"></a>As usual, we can use the <span class="in">`head()`</span> function to check what the resulting object looks like:</span>
<span id="cb20-263"><a href="#cb20-263"></a></span>
<span id="cb20-266"><a href="#cb20-266"></a><span class="in">```{r}</span></span>
<span id="cb20-267"><a href="#cb20-267"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb20-268"><a href="#cb20-268"></a></span>
<span id="cb20-269"><a href="#cb20-269"></a><span class="fu">head</span>(bike_theft_density)</span>
<span id="cb20-270"><a href="#cb20-270"></a><span class="in">```</span></span>
<span id="cb20-271"><a href="#cb20-271"></a></span>
<span id="cb20-272"><a href="#cb20-272"></a>The <span class="in">`bike_theft_density`</span> object created by <span class="in">`hotspot_kde()`</span> contains three columns: <span class="in">`n`</span> contains the count of bike thefts in each cell, <span class="in">`kde`</span> contains the estimate of the density of thefts in each cell, and <span class="in">`geometry`</span> contains the outline of each grid cell.</span>
<span id="cb20-273"><a href="#cb20-273"></a></span>
<span id="cb20-274"><a href="#cb20-274"></a>Since <span class="in">`hotspot_kde()`</span> produces an SF object, we can add it to a map using the <span class="in">`geom_sf()`</span> function. We can also use the <span class="in">`fill`</span> aesthetic to specify that the fill colour of each grid cell should be determined based on the values of the <span class="in">`kde`</span> column in the <span class="in">`bike_theft_density`</span> object.</span>
<span id="cb20-275"><a href="#cb20-275"></a></span>
<span id="cb20-278"><a href="#cb20-278"></a><span class="in">```{r}</span></span>
<span id="cb20-279"><a href="#cb20-279"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb20-280"><a href="#cb20-280"></a></span>
<span id="cb20-281"><a href="#cb20-281"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-282"><a href="#cb20-282"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> kde), <span class="at">data =</span> bike_theft_density, <span class="at">colour =</span> <span class="cn">NA</span>)</span>
<span id="cb20-283"><a href="#cb20-283"></a><span class="in">```</span></span>
<span id="cb20-284"><a href="#cb20-284"></a></span>
<span id="cb20-285"><a href="#cb20-285"></a>We have already seen that we can set aesthetics such as colour and shape manually, but the <span class="in">`aes()`</span> function allows us to specify that the values of different aesthetics should be controlled by columns in the data. The <span class="in">`aes()`</span> function takes as its arguments pairs of values (combined with an <span class="in">`=`</span> symbol) where the first value is an aesthetic and the second value is the name of a column in the data. For example, to use the colour of points on a map to represent different types of crime that were stored in a column in the data called <span class="in">`type`</span>, we could use <span class="in">`aes(colour = type)`</span>. In the map above, we use <span class="in">`aes(fill = kde)`</span> to specify that the fill colour of the grid cells on the map should be controlled by the <span class="in">`kde`</span> column in the data. This is called _mapping_ a column to an aesthetic.</span>
<span id="cb20-286"><a href="#cb20-286"></a></span>
<span id="cb20-287"><a href="#cb20-287"></a></span>
<span id="cb20-288"><a href="#cb20-288"></a>::: {.callout-important}</span>
<span id="cb20-289"><a href="#cb20-289"></a><span class="fu">#### When to specify values inside or outside `aes()`</span></span>
<span id="cb20-290"><a href="#cb20-290"></a></span>
<span id="cb20-291"><a href="#cb20-291"></a>When should you specify the values of aesthetics inside <span class="in">`aes()`</span> and when should you do it outside <span class="in">`aes()`</span>?</span>
<span id="cb20-292"><a href="#cb20-292"></a></span>
<span id="cb20-293"><a href="#cb20-293"></a><span class="ss">  * </span>If you want an aesthetic to have a constant value for all the points, lines or other shapes in a layer, control the aesthetic _outside_ <span class="in">`aes()`</span>. For example, you could use <span class="in">`geom_sf(bike_thefts, colour = "mediumblue")`</span> to make all the shapes in that layer blue.</span>
<span id="cb20-294"><a href="#cb20-294"></a><span class="ss">  * </span>If you want to vary the appearance of shapes according to values in the data, you should control the aesthetic _inside_ <span class="in">`aes()`</span>. For example, you could use <span class="in">`geom_sf(aes(colour = month), bike_thefts)`</span> to vary the colour of shapes in a layer according to values of the <span class="in">`month`</span> column in the data.</span>
<span id="cb20-295"><a href="#cb20-295"></a></span>
<span id="cb20-296"><a href="#cb20-296"></a>If you specify a constant value for an aesthetic (e.g. <span class="in">`colour = "mediumblue"`</span>) this will over-ride any mapping for that aesthetic provided by the <span class="in">`aes()`</span> function (e.g. <span class="in">`aes(colour = month)`</span>). If you have used <span class="in">`aes()`</span> to specify that an aesthetic should be controlled based on a column in the data but find that the aesthetic is not changing based on the data, check you have not also specified a constant value for that aesthetic.</span>
<span id="cb20-297"><a href="#cb20-297"></a></span>
<span id="cb20-298"><a href="#cb20-298"></a>**`aes()` must be the _first_ argument in the `geom_*()` function.**</span>
<span id="cb20-299"><a href="#cb20-299"></a></span>
<span id="cb20-300"><a href="#cb20-300"></a>:::</span>
<span id="cb20-301"><a href="#cb20-301"></a></span>
<span id="cb20-302"><a href="#cb20-302"></a></span>
<span id="cb20-303"><a href="#cb20-303"></a>In this map, instead of seeing each crime as a separate point, we see the density of crime as the filled colour of cells in a grid. By comparing this density map to the point map we produced before, we can see that the density map makes the areas with the highest frequency of thefts slightly easier to identify (although we will improve it much further below).</span>
<span id="cb20-304"><a href="#cb20-304"></a></span>
<span id="cb20-305"><a href="#cb20-305"></a>You can also see that our map now has a legend, showing that higher densities of bike thefts are shown on the map in light blue and lower densities are shown in dark blue. The exact values shown in the legend are not particularly meaningful, so we can ignore these for now.</span>
<span id="cb20-306"><a href="#cb20-306"></a></span>
<span id="cb20-307"><a href="#cb20-307"></a></span>
<span id="cb20-308"><a href="#cb20-308"></a>::: {.callout-quiz .callout}</span>
<span id="cb20-309"><a href="#cb20-309"></a><span class="fu">#### Density mapping</span></span>
<span id="cb20-310"><a href="#cb20-310"></a></span>
<span id="cb20-311"><a href="#cb20-311"></a><span class="in">```{r density-quiz}</span></span>
<span id="cb20-312"><a href="#cb20-312"></a><span class="in">#| echo: false</span></span>
<span id="cb20-313"><a href="#cb20-313"></a></span>
<span id="cb20-314"><a href="#cb20-314"></a><span class="in">density_quiz1 &lt;- c(</span></span>
<span id="cb20-315"><a href="#cb20-315"></a><span class="in">  answer = "It helps make spatial patterns in data more apparent.",</span></span>
<span id="cb20-316"><a href="#cb20-316"></a><span class="in">  "It shows the exact location of each crime point.",</span></span>
<span id="cb20-317"><a href="#cb20-317"></a><span class="in">  "It allows for interactive maps that users can click on.",</span></span>
<span id="cb20-318"><a href="#cb20-318"></a><span class="in">  "It removes crime data points from the map."</span></span>
<span id="cb20-319"><a href="#cb20-319"></a><span class="in">)</span></span>
<span id="cb20-320"><a href="#cb20-320"></a></span>
<span id="cb20-321"><a href="#cb20-321"></a><span class="in">density_quiz2 &lt;- c(</span></span>
<span id="cb20-322"><a href="#cb20-322"></a><span class="in">  "`ggplot()`",</span></span>
<span id="cb20-323"><a href="#cb20-323"></a><span class="in">  "`hotspot_density()`", </span></span>
<span id="cb20-324"><a href="#cb20-324"></a><span class="in">  answer = "`hotspot_kde()`",</span></span>
<span id="cb20-325"><a href="#cb20-325"></a><span class="in">  "`st_point_to_kde()`"</span></span>
<span id="cb20-326"><a href="#cb20-326"></a><span class="in">)</span></span>
<span id="cb20-327"><a href="#cb20-327"></a></span>
<span id="cb20-328"><a href="#cb20-328"></a><span class="in">density_quiz3 &lt;- c("`colour`", answer = "`fill`", "`shape`", "`size`")</span></span>
<span id="cb20-329"><a href="#cb20-329"></a></span>
<span id="cb20-330"><a href="#cb20-330"></a><span class="in">density_quiz4 &lt;- c(</span></span>
<span id="cb20-331"><a href="#cb20-331"></a><span class="in">  "It combines multiple spatial datasets into one.",</span></span>
<span id="cb20-332"><a href="#cb20-332"></a><span class="in">  "It filters spatial data to show only relevant points.",</span></span>
<span id="cb20-333"><a href="#cb20-333"></a><span class="in">  "It calculates the density of points in a specified area.",</span></span>
<span id="cb20-334"><a href="#cb20-334"></a><span class="in">  answer = "It changes the coordinate reference system of a spatial dataset."</span></span>
<span id="cb20-335"><a href="#cb20-335"></a><span class="in">)</span></span>
<span id="cb20-336"><a href="#cb20-336"></a><span class="in">```</span></span>
<span id="cb20-337"><a href="#cb20-337"></a></span>
<span id="cb20-338"><a href="#cb20-338"></a></span>
<span id="cb20-339"><a href="#cb20-339"></a>**What is a key advantage of using KDE over dot maps for crime data?**</span>
<span id="cb20-340"><a href="#cb20-340"></a></span>
<span id="cb20-341"><a href="#cb20-341"></a><span class="in">`r webexercises::longmcq(density_quiz1)`</span></span>
<span id="cb20-342"><a href="#cb20-342"></a></span>
<span id="cb20-343"><a href="#cb20-343"></a></span>
<span id="cb20-344"><a href="#cb20-344"></a>**Which R function is used to create a density layer from point data?**</span>
<span id="cb20-345"><a href="#cb20-345"></a></span>
<span id="cb20-346"><a href="#cb20-346"></a><span class="in">`r webexercises::longmcq(density_quiz2)`</span></span>
<span id="cb20-347"><a href="#cb20-347"></a></span>
<span id="cb20-348"><a href="#cb20-348"></a></span>
<span id="cb20-349"><a href="#cb20-349"></a>**Which argument in `geom_sf()` is used to specify that the fill colour of grid cells should be determined by the KDE values?**</span>
<span id="cb20-350"><a href="#cb20-350"></a></span>
<span id="cb20-351"><a href="#cb20-351"></a><span class="in">`r webexercises::longmcq(density_quiz3)`</span></span>
<span id="cb20-352"><a href="#cb20-352"></a></span>
<span id="cb20-353"><a href="#cb20-353"></a></span>
<span id="cb20-354"><a href="#cb20-354"></a>**What does the `st_transform()` function do in spatial data operations?**</span>
<span id="cb20-355"><a href="#cb20-355"></a></span>
<span id="cb20-356"><a href="#cb20-356"></a><span class="in">`r webexercises::longmcq(density_quiz4)`</span></span>
<span id="cb20-357"><a href="#cb20-357"></a></span>
<span id="cb20-358"><a href="#cb20-358"></a></span>
<span id="cb20-359"><a href="#cb20-359"></a>:::</span>
<span id="cb20-360"><a href="#cb20-360"></a></span>
<span id="cb20-361"><a href="#cb20-361"></a></span>
<span id="cb20-362"><a href="#cb20-362"></a><span class="fu">### Fine-tuning cell size and bandwidth</span></span>
<span id="cb20-363"><a href="#cb20-363"></a></span>
<span id="cb20-364"><a href="#cb20-364"></a>We can control the appearance of KDE maps in several ways. For example, we can vary the number of cells in the grid and the definition of what cells the kernel density estimation process should consider to be 'nearby' for the purposes of calculating weighted counts. Cells are considered to be 'nearby' to a particular cell if they are closer to that cell than a distance known as the KDE *bandwidth*.</span>
<span id="cb20-365"><a href="#cb20-365"></a></span>
<span id="cb20-366"><a href="#cb20-366"></a>By default, <span class="in">`hotspot_kde()`</span> chooses the cell size and the bandwidth automatically. The maps below show how changing these defaults changes the appearance of our map (with the legend and axes removed to make the small maps clearer).</span>
<span id="cb20-367"><a href="#cb20-367"></a></span>
<span id="cb20-368"><a href="#cb20-368"></a><span class="in">```{r make-kde-bandwidth-map}</span></span>
<span id="cb20-369"><a href="#cb20-369"></a><span class="in">#| eval: false</span></span>
<span id="cb20-370"><a href="#cb20-370"></a><span class="in">#| echo: false</span></span>
<span id="cb20-371"><a href="#cb20-371"></a></span>
<span id="cb20-372"><a href="#cb20-372"></a><span class="in">bw_plot &lt;- tibble(</span></span>
<span id="cb20-373"><a href="#cb20-373"></a><span class="in">  cell_size = rep(c(0.5, 1, 2), 5), </span></span>
<span id="cb20-374"><a href="#cb20-374"></a><span class="in">  bw = rep(c(4, 2, 1, 0.5, 0.25), each = 3)</span></span>
<span id="cb20-375"><a href="#cb20-375"></a><span class="in">) |&gt; </span></span>
<span id="cb20-376"><a href="#cb20-376"></a><span class="in">  pmap(function(cell_size, bw) {</span></span>
<span id="cb20-377"><a href="#cb20-377"></a><span class="in">    bike_thefts |&gt; </span></span>
<span id="cb20-378"><a href="#cb20-378"></a><span class="in">      hotspot_kde(</span></span>
<span id="cb20-379"><a href="#cb20-379"></a><span class="in">        cell_size = sfhotspot:::set_cell_size(bike_thefts) * 4 * cell_size, </span></span>
<span id="cb20-380"><a href="#cb20-380"></a><span class="in">        bandwidth_adjust = bw, </span></span>
<span id="cb20-381"><a href="#cb20-381"></a><span class="in">        quiet = TRUE</span></span>
<span id="cb20-382"><a href="#cb20-382"></a><span class="in">      ) |&gt; </span></span>
<span id="cb20-383"><a href="#cb20-383"></a><span class="in">      ggplot() +</span></span>
<span id="cb20-384"><a href="#cb20-384"></a><span class="in">      geom_sf(aes(fill = kde), colour = NA) +</span></span>
<span id="cb20-385"><a href="#cb20-385"></a><span class="in">      labs(</span></span>
<span id="cb20-386"><a href="#cb20-386"></a><span class="in">        subtitle = str_glue("{cell_size}x default cell size\n{bw}x default bandwidth")</span></span>
<span id="cb20-387"><a href="#cb20-387"></a><span class="in">      ) +</span></span>
<span id="cb20-388"><a href="#cb20-388"></a><span class="in">      theme_void() +</span></span>
<span id="cb20-389"><a href="#cb20-389"></a><span class="in">      theme(</span></span>
<span id="cb20-390"><a href="#cb20-390"></a><span class="in">        legend.position = "none",</span></span>
<span id="cb20-391"><a href="#cb20-391"></a><span class="in">        plot.subtitle = element_text(size = 10)</span></span>
<span id="cb20-392"><a href="#cb20-392"></a><span class="in">      )</span></span>
<span id="cb20-393"><a href="#cb20-393"></a><span class="in">  }) |&gt; </span></span>
<span id="cb20-394"><a href="#cb20-394"></a><span class="in">  wrap_plots(ncol = 3)</span></span>
<span id="cb20-395"><a href="#cb20-395"></a></span>
<span id="cb20-396"><a href="#cb20-396"></a><span class="in">ggsave(</span></span>
<span id="cb20-397"><a href="#cb20-397"></a><span class="in">  here::here("images/bandwidth.jpg"), </span></span>
<span id="cb20-398"><a href="#cb20-398"></a><span class="in">  bw_plot, </span></span>
<span id="cb20-399"><a href="#cb20-399"></a><span class="in">  width = 800 / 150, </span></span>
<span id="cb20-400"><a href="#cb20-400"></a><span class="in">  height = 1200 / 150, </span></span>
<span id="cb20-401"><a href="#cb20-401"></a><span class="in">  dpi = 150</span></span>
<span id="cb20-402"><a href="#cb20-402"></a><span class="in">)</span></span>
<span id="cb20-403"><a href="#cb20-403"></a><span class="in">```</span></span>
<span id="cb20-404"><a href="#cb20-404"></a></span>
<span id="cb20-405"><a href="#cb20-405"></a><span class="in">```{r kde-bandwidth-map}</span></span>
<span id="cb20-406"><a href="#cb20-406"></a><span class="in">#| echo: false</span></span>
<span id="cb20-407"><a href="#cb20-407"></a><span class="in">#| fig.align: center</span></span>
<span id="cb20-408"><a href="#cb20-408"></a><span class="in">#| out.width: 100%</span></span>
<span id="cb20-409"><a href="#cb20-409"></a></span>
<span id="cb20-410"><a href="#cb20-410"></a><span class="in">knitr::include_graphics(here::here("images/bandwidth.jpg"))</span></span>
<span id="cb20-411"><a href="#cb20-411"></a><span class="in">```</span></span>
<span id="cb20-412"><a href="#cb20-412"></a></span>
<span id="cb20-413"><a href="#cb20-413"></a>By looking at the maps on the right-hand side, you can see that reducing the number of grid cells leads to a map that looks blocky and lacks information. Looking at the maps towards the top of the figure above, you can see that increasing the bandwidth relative to the default makes the density surface smoother. The smoother the surface, the less detail we can see about where crime is most concentrated, until on the top row we can see almost no information at all. On the other hand, if we reduce the bandwidth too much (the bottom row of maps) then almost no 'nearby' cells are included in the count and so it becomes more difficult to identify patterns.</span>
<span id="cb20-414"><a href="#cb20-414"></a></span>
<span id="cb20-415"><a href="#cb20-415"></a>In most cases, you will not need to change the cell size used in calculating the density of points on a map, but if you do then you can do this using the <span class="in">`cell_size`</span> argument to <span class="in">`hotspot_kde()`</span>. A cell size of about 200 metres is often a good choice for maps showing a whole city, such as our map of Vancouver.</span>
<span id="cb20-416"><a href="#cb20-416"></a></span>
<span id="cb20-417"><a href="#cb20-417"></a>Although you can set the bandwidth manually using the <span class="in">`bandwidth`</span> argument to <span class="in">`hotspot_kde()`</span>, you will almost never want to do this. Instead, you can vary the bandwidth relative to the automatically chosen default bandwidth by using the <span class="in">`bandwidth_adjust`</span> argument. For example, if you wanted to see more detail in your map by using a smaller bandwidth, you could use <span class="in">`bandwidth_adjust = 0.75`</span> or <span class="in">`bandwidth_adjust = 3/4`</span> to set the bandwidth to be three-quarters of the default bandwidth.</span>
<span id="cb20-418"><a href="#cb20-418"></a></span>
<span id="cb20-419"><a href="#cb20-419"></a></span>
<span id="cb20-420"><a href="#cb20-420"></a>::: {.callout-important}</span>
<span id="cb20-421"><a href="#cb20-421"></a><span class="fu">#### Start with `bandwidth_adjust = 0.5`</span></span>
<span id="cb20-422"><a href="#cb20-422"></a></span>
<span id="cb20-423"><a href="#cb20-423"></a>I recommend using a slightly smaller bandwidth than the default, so that your maps show a bit more detail. Try setting <span class="in">`bandwidth_adjust = 0.5`</span> whenever you produce a density layer using <span class="in">`hotspot_kde()`</span>, but remember to look at the map to see if you are happy with the result. If you are not happy, try varying the value of <span class="in">`bandwidth_adjust`</span>. It is possible to set a value greater than 1, but it is very unlikely that this would produce the most-informative possible map.</span>
<span id="cb20-424"><a href="#cb20-424"></a>:::</span>
<span id="cb20-425"><a href="#cb20-425"></a></span>
<span id="cb20-426"><a href="#cb20-426"></a></span>
<span id="cb20-427"><a href="#cb20-427"></a><span class="fu">### Using colour to show density</span></span>
<span id="cb20-428"><a href="#cb20-428"></a></span>
<span id="cb20-429"><a href="#cb20-429"></a>The final way we can control the appearance of our density layer is to change the colour scheme used to represent density. To do this, we can use another type of function from the ggplot2 package: _scales_. Functions in the `scale_*()` family of functions allow us to control how the mapping between a column in the data and an aesthetic (colour, size, etc.) is represented visually. For example, which colour scheme is used to represent the density of thefts on our map.</span>
<span id="cb20-430"><a href="#cb20-430"></a></span>
<span id="cb20-431"><a href="#cb20-431"></a>There are many <span class="in">`scale_*()`</span> functions, but the <span class="in">`scale_fill_distiller()`</span> function produces several different colour scales that are specifically designed to be effective on maps. </span>
<span id="cb20-432"><a href="#cb20-432"></a></span>
<span id="cb20-433"><a href="#cb20-433"></a>Colour schemes can be divided into three types:</span>
<span id="cb20-434"><a href="#cb20-434"></a></span>
<span id="cb20-435"><a href="#cb20-435"></a><span class="ss">  * </span>*sequential* colour schemes are useful for showing values from low to high,</span>
<span id="cb20-436"><a href="#cb20-436"></a><span class="ss">  * </span>*diverging* colour schemes are useful for showing values relative to a meaningful central point, and</span>
<span id="cb20-437"><a href="#cb20-437"></a><span class="ss">  * </span>*qualitative* colour schemes are useful for showing separate categories that can appear in any order and still be meaningful.</span>
<span id="cb20-438"><a href="#cb20-438"></a></span>
<span id="cb20-439"><a href="#cb20-439"></a>In crime mapping we're usually interested in showing how crime varies from low to high, so we need to use a _sequential_ colour palette. There are <span class="in">`r nrow(filter(RColorBrewer::brewer.pal.info, category == "seq"))`</span> sequential colour schemes (or palettes) available in <span class="in">`scales_fill_distiller()`</span>, each with a name:</span>
<span id="cb20-440"><a href="#cb20-440"></a></span>
<span id="cb20-441"><a href="#cb20-441"></a><span class="in">```{r kde-colours, out.width="100%"}</span></span>
<span id="cb20-442"><a href="#cb20-442"></a><span class="in">#| echo: false</span></span>
<span id="cb20-443"><a href="#cb20-443"></a></span>
<span id="cb20-444"><a href="#cb20-444"></a><span class="in">RColorBrewer::brewer.pal.info |&gt; </span></span>
<span id="cb20-445"><a href="#cb20-445"></a><span class="in">  rownames_to_column(var = "name") |&gt; </span></span>
<span id="cb20-446"><a href="#cb20-446"></a><span class="in">  filter(colorblind, category == "seq") |&gt; </span></span>
<span id="cb20-447"><a href="#cb20-447"></a><span class="in">  pmap(function (...) {</span></span>
<span id="cb20-448"><a href="#cb20-448"></a><span class="in">    current &lt;- tibble(...)</span></span>
<span id="cb20-449"><a href="#cb20-449"></a><span class="in">    ggplot() +</span></span>
<span id="cb20-450"><a href="#cb20-450"></a><span class="in">      geom_raster(aes(x = 1:9, y = 1, fill = as.factor(1:9))) +</span></span>
<span id="cb20-451"><a href="#cb20-451"></a><span class="in">      scale_fill_brewer(palette = current$name) +</span></span>
<span id="cb20-452"><a href="#cb20-452"></a><span class="in">      labs(subtitle = current$name) +</span></span>
<span id="cb20-453"><a href="#cb20-453"></a><span class="in">      theme_void() +</span></span>
<span id="cb20-454"><a href="#cb20-454"></a><span class="in">      theme(</span></span>
<span id="cb20-455"><a href="#cb20-455"></a><span class="in">        legend.position = "none", </span></span>
<span id="cb20-456"><a href="#cb20-456"></a><span class="in">        plot.subtitle = element_text(size = 8)</span></span>
<span id="cb20-457"><a href="#cb20-457"></a><span class="in">      )</span></span>
<span id="cb20-458"><a href="#cb20-458"></a><span class="in">  }) |&gt; </span></span>
<span id="cb20-459"><a href="#cb20-459"></a><span class="in">  wrap_plots()</span></span>
<span id="cb20-460"><a href="#cb20-460"></a><span class="in">```</span></span>
<span id="cb20-461"><a href="#cb20-461"></a></span>
<span id="cb20-462"><a href="#cb20-462"></a></span>
<span id="cb20-463"><a href="#cb20-463"></a>::: {.callout-important}</span>
<span id="cb20-464"><a href="#cb20-464"></a><span class="fu">#### Choosing the right type of colour scale</span></span>
<span id="cb20-465"><a href="#cb20-465"></a></span>
<span id="cb20-466"><a href="#cb20-466"></a>It is important to **only use the right type of colour scale in the right circumstances**, since using the wrong type of scale could end up misleading people reading your map. For example, a diverging colour scale gives the strong impression that the central point in the scale is meaningful. </span>
<span id="cb20-467"><a href="#cb20-467"></a></span>
<span id="cb20-468"><a href="#cb20-468"></a>In some circumstances this might be useful, for example if you wanted to show areas in which crime had increased in shades of one colour and areas in which crime had decreased in shades of another colour. In that case, a diverging scale would be appropriate because the central point represents something meaningful: no change in crime. If the central point is not meaningful, use a sequential colour scheme instead.</span>
<span id="cb20-469"><a href="#cb20-469"></a></span>
<span id="cb20-470"><a href="#cb20-470"></a>If you want to represent a categorical variable, you should use a categorical colour scale unless the categories have a natural order. For example, if you wanted to show ethnic groups on a map you would use a categorical colour scale, since there is no one order of ethnic groups that is any more meaningful than any other. If you wanted to represent days of the week with colour, then you might want to use a sequential colour scheme since the days of the week have a meaningful order.</span>
<span id="cb20-471"><a href="#cb20-471"></a>:::</span>
<span id="cb20-472"><a href="#cb20-472"></a></span>
<span id="cb20-473"><a href="#cb20-473"></a></span>
<span id="cb20-474"><a href="#cb20-474"></a>By default, <span class="in">`scale_fill_distiller()`</span> sets the _lowest_ values to have the darkest colour. This often does not work well, but we can change this by setting the argument <span class="in">`direction = 1`</span>. I recommend doing this in all cases.</span>
<span id="cb20-475"><a href="#cb20-475"></a></span>
<span id="cb20-476"><a href="#cb20-476"></a><span class="in">```{r direction-map, fig.align='center', out.width="80%"}</span></span>
<span id="cb20-477"><a href="#cb20-477"></a><span class="in">#| echo: false</span></span>
<span id="cb20-478"><a href="#cb20-478"></a></span>
<span id="cb20-479"><a href="#cb20-479"></a><span class="in">direction_map_neg &lt;- ggplot() +</span></span>
<span id="cb20-480"><a href="#cb20-480"></a><span class="in">  geom_sf(aes(fill = kde), data = bike_theft_density, colour = NA) +</span></span>
<span id="cb20-481"><a href="#cb20-481"></a><span class="in">  scale_fill_distiller(direction = -1) +</span></span>
<span id="cb20-482"><a href="#cb20-482"></a><span class="in">  labs(title = "direction = -1 (the default)") +</span></span>
<span id="cb20-483"><a href="#cb20-483"></a><span class="in">  theme_void() +</span></span>
<span id="cb20-484"><a href="#cb20-484"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb20-485"><a href="#cb20-485"></a></span>
<span id="cb20-486"><a href="#cb20-486"></a><span class="in">direction_map_pos &lt;- ggplot() +</span></span>
<span id="cb20-487"><a href="#cb20-487"></a><span class="in">  geom_sf(aes(fill = kde), data = bike_theft_density, colour = NA) +</span></span>
<span id="cb20-488"><a href="#cb20-488"></a><span class="in">  scale_fill_distiller(direction = 1) +</span></span>
<span id="cb20-489"><a href="#cb20-489"></a><span class="in">  labs(title = "direction = 1") +</span></span>
<span id="cb20-490"><a href="#cb20-490"></a><span class="in">  theme_void() +</span></span>
<span id="cb20-491"><a href="#cb20-491"></a><span class="in">  theme(legend.position = "bottom")</span></span>
<span id="cb20-492"><a href="#cb20-492"></a></span>
<span id="cb20-493"><a href="#cb20-493"></a><span class="in">direction_map_neg + direction_map_pos</span></span>
<span id="cb20-494"><a href="#cb20-494"></a><span class="in">```</span></span>
<span id="cb20-495"><a href="#cb20-495"></a></span>
<span id="cb20-496"><a href="#cb20-496"></a>You can think of all the functions that we can add to <span class="in">`ggplot()`</span> as being like a stack of pancakes, with each new function being placed on the top of the stack. To change the colour of our map, we just add <span class="in">`scale_fill_distiller()`</span> to the existing stack. Add this code to the script file <span class="in">`chapter_06.R`</span> in RStudio:</span>
<span id="cb20-497"><a href="#cb20-497"></a></span>
<span id="cb20-498"><a href="#cb20-498"></a><span class="in">```{r map-exercise8, exercise=TRUE}</span></span>
<span id="cb20-499"><a href="#cb20-499"></a><span class="in">#| filename: "chapter_06.R"</span></span>
<span id="cb20-500"><a href="#cb20-500"></a></span>
<span id="cb20-501"><a href="#cb20-501"></a><span class="in"># Plot density map</span></span>
<span id="cb20-502"><a href="#cb20-502"></a><span class="in">ggplot() +</span></span>
<span id="cb20-503"><a href="#cb20-503"></a><span class="in">  geom_sf(aes(fill = kde), data = bike_theft_density, colour = NA) +</span></span>
<span id="cb20-504"><a href="#cb20-504"></a><span class="in">  scale_fill_distiller(palette = "Oranges", direction = 1)</span></span>
<span id="cb20-505"><a href="#cb20-505"></a><span class="in">```</span></span>
<span id="cb20-506"><a href="#cb20-506"></a></span>
<span id="cb20-507"><a href="#cb20-507"></a></span>
<span id="cb20-508"><a href="#cb20-508"></a>::: {.box .reading}</span>
<span id="cb20-509"><a href="#cb20-509"></a></span>
<span id="cb20-510"><a href="#cb20-510"></a>You can find out much more about how colours work in R by reading <span class="co">[</span><span class="ot">_Working with colours in R_</span><span class="co">](https://nrennie.rbind.io/blog/colours-in-r/)</span> and find many different colour palettes you can use with ggplot2 at the <span class="co">[</span><span class="ot">Color Palette Finder</span><span class="co">](https://r-graph-gallery.com/color-palette-finder)</span>.</span>
<span id="cb20-511"><a href="#cb20-511"></a></span>
<span id="cb20-512"><a href="#cb20-512"></a>:::</span>
<span id="cb20-513"><a href="#cb20-513"></a></span>
<span id="cb20-514"><a href="#cb20-514"></a></span>
<span id="cb20-515"><a href="#cb20-515"></a>::: {.callout-quiz .callout}</span>
<span id="cb20-516"><a href="#cb20-516"></a><span class="fu">### Making density maps</span></span>
<span id="cb20-517"><a href="#cb20-517"></a></span>
<span id="cb20-518"><a href="#cb20-518"></a></span>
<span id="cb20-519"><a href="#cb20-519"></a><span class="in">```{r map-quiz}</span></span>
<span id="cb20-520"><a href="#cb20-520"></a><span class="in">#| echo: false</span></span>
<span id="cb20-521"><a href="#cb20-521"></a></span>
<span id="cb20-522"><a href="#cb20-522"></a><span class="in">map_quiz1 &lt;- c(</span></span>
<span id="cb20-523"><a href="#cb20-523"></a><span class="in">  "dplyr",</span></span>
<span id="cb20-524"><a href="#cb20-524"></a><span class="in">  "ggplot2",</span></span>
<span id="cb20-525"><a href="#cb20-525"></a><span class="in">  "sf",</span></span>
<span id="cb20-526"><a href="#cb20-526"></a><span class="in">  answer = "sfhotspot"</span></span>
<span id="cb20-527"><a href="#cb20-527"></a><span class="in">)</span></span>
<span id="cb20-528"><a href="#cb20-528"></a></span>
<span id="cb20-529"><a href="#cb20-529"></a><span class="in">map_quiz2 &lt;- c(</span></span>
<span id="cb20-530"><a href="#cb20-530"></a><span class="in">  answer = "Adjusting the bandwidth of the density layer, relative to the default bandwidth",</span></span>
<span id="cb20-531"><a href="#cb20-531"></a><span class="in">  "Adjusting the cell size of the density layer, relative to the default cell size",</span></span>
<span id="cb20-532"><a href="#cb20-532"></a><span class="in">  "Adjusting the colour scheme used to represent density on the map",</span></span>
<span id="cb20-533"><a href="#cb20-533"></a><span class="in">  "Adjusting the bandwidth of the density layer, relative to a bandwidth of zero"</span></span>
<span id="cb20-534"><a href="#cb20-534"></a><span class="in">)</span></span>
<span id="cb20-535"><a href="#cb20-535"></a></span>
<span id="cb20-536"><a href="#cb20-536"></a><span class="in">map_quiz3 &lt;- c(</span></span>
<span id="cb20-537"><a href="#cb20-537"></a><span class="in">  "To represent variation in a variable from low to high",</span></span>
<span id="cb20-538"><a href="#cb20-538"></a><span class="in">  answer = "To represent variation in a variable above and below a meaningful mid-point",</span></span>
<span id="cb20-539"><a href="#cb20-539"></a><span class="in">  "To represent variation in a variable from high to low",</span></span>
<span id="cb20-540"><a href="#cb20-540"></a><span class="in">  "To represent categories in a categorical variable"</span></span>
<span id="cb20-541"><a href="#cb20-541"></a><span class="in">)</span></span>
<span id="cb20-542"><a href="#cb20-542"></a></span>
<span id="cb20-543"><a href="#cb20-543"></a><span class="in">map_quiz4 &lt;- c(</span></span>
<span id="cb20-544"><a href="#cb20-544"></a><span class="in">  "It highlights low-density areas more clearly.",</span></span>
<span id="cb20-545"><a href="#cb20-545"></a><span class="in">  answer = "It can mislead the viewer by suggesting a central point of significance.",</span></span>
<span id="cb20-546"><a href="#cb20-546"></a><span class="in">  "It makes the map look too colorful, which can be distracting.",</span></span>
<span id="cb20-547"><a href="#cb20-547"></a><span class="in">  "It hides the areas with the highest crime density."</span></span>
<span id="cb20-548"><a href="#cb20-548"></a><span class="in">)</span></span>
<span id="cb20-549"><a href="#cb20-549"></a><span class="in">```</span></span>
<span id="cb20-550"><a href="#cb20-550"></a></span>
<span id="cb20-551"><a href="#cb20-551"></a>**What R package do we use to make density maps using the `hotspot_kde()` function?**</span>
<span id="cb20-552"><a href="#cb20-552"></a></span>
<span id="cb20-553"><a href="#cb20-553"></a><span class="in">`r webexercises::longmcq(map_quiz1)`</span></span>
<span id="cb20-554"><a href="#cb20-554"></a></span>
<span id="cb20-555"><a href="#cb20-555"></a></span>
<span id="cb20-556"><a href="#cb20-556"></a>**What is the `bandwidth_adjust` argument of the function `hotspot_kde()` used for?**</span>
<span id="cb20-557"><a href="#cb20-557"></a></span>
<span id="cb20-558"><a href="#cb20-558"></a><span class="in">`r webexercises::longmcq(map_quiz2)`</span></span>
<span id="cb20-559"><a href="#cb20-559"></a></span>
<span id="cb20-560"><a href="#cb20-560"></a></span>
<span id="cb20-561"><a href="#cb20-561"></a>**In what circumstances is it appropriate to use a diverging colour scale, e.g. one that goes from blue to white to red?**</span>
<span id="cb20-562"><a href="#cb20-562"></a></span>
<span id="cb20-563"><a href="#cb20-563"></a><span class="in">`r webexercises::longmcq(map_quiz3)`</span></span>
<span id="cb20-564"><a href="#cb20-564"></a></span>
<span id="cb20-565"><a href="#cb20-565"></a></span>
<span id="cb20-566"><a href="#cb20-566"></a>**Why is it a bad idea to use a diverging colour scheme for crime density maps?**</span>
<span id="cb20-567"><a href="#cb20-567"></a></span>
<span id="cb20-568"><a href="#cb20-568"></a><span class="in">`r webexercises::longmcq(map_quiz4)`</span></span>
<span id="cb20-569"><a href="#cb20-569"></a></span>
<span id="cb20-570"><a href="#cb20-570"></a></span>
<span id="cb20-571"><a href="#cb20-571"></a>:::</span>
<span id="cb20-572"><a href="#cb20-572"></a></span>
<span id="cb20-573"><a href="#cb20-573"></a></span>
<span id="cb20-574"><a href="#cb20-574"></a></span>
<span id="cb20-575"><a href="#cb20-575"></a><span class="fu">## Clipping map layers</span></span>
<span id="cb20-576"><a href="#cb20-576"></a></span>
<span id="cb20-577"><a href="#cb20-577"></a>There is one limitation of the KDE layer on our map that we need to deal with.</span>
<span id="cb20-578"><a href="#cb20-578"></a>The area covered by the KDE layer is determined by the area covered by the point</span>
<span id="cb20-579"><a href="#cb20-579"></a>data that we provided to <span class="in">`hotspot_kde()`</span>. More specifically, <span class="in">`hotspot_kde()`</span> </span>
<span id="cb20-580"><a href="#cb20-580"></a>will calculate density values for every cell in the _convex hull_ around the </span>
<span id="cb20-581"><a href="#cb20-581"></a>point data, i.e. for the smallest polygon that contains all the points in the </span>
<span id="cb20-582"><a href="#cb20-582"></a>data.</span>
<span id="cb20-583"><a href="#cb20-583"></a></span>
<span id="cb20-584"><a href="#cb20-584"></a>This can be a problem in some circumstances, because we do not necessarily have</span>
<span id="cb20-585"><a href="#cb20-585"></a>crime data for all the areas within the convex hull of the data, even though KDE</span>
<span id="cb20-586"><a href="#cb20-586"></a>values will be calculated for those areas. This could be misleading, since it</span>
<span id="cb20-587"><a href="#cb20-587"></a>will look like such areas have low crime density, when in fact we do not know</span>
<span id="cb20-588"><a href="#cb20-588"></a>what the density of crime in such areas is.</span>
<span id="cb20-589"><a href="#cb20-589"></a></span>
<span id="cb20-590"><a href="#cb20-590"></a>Fortunately, we can easily deal with this problem by _clipping_ the KDE layer to</span>
<span id="cb20-591"><a href="#cb20-591"></a>the boundary of the area for which we have crime data. This means we will only</span>
<span id="cb20-592"><a href="#cb20-592"></a>show densities for cells for which we actually have data.</span>
<span id="cb20-593"><a href="#cb20-593"></a></span>
<span id="cb20-594"><a href="#cb20-594"></a><span class="in">```{r make-clipping-explanation-map, eval=FALSE}</span></span>
<span id="cb20-595"><a href="#cb20-595"></a><span class="in">#| echo: false</span></span>
<span id="cb20-596"><a href="#cb20-596"></a></span>
<span id="cb20-597"><a href="#cb20-597"></a><span class="in">pacman::p_load(ggtext)</span></span>
<span id="cb20-598"><a href="#cb20-598"></a></span>
<span id="cb20-599"><a href="#cb20-599"></a><span class="in">bike_thefts_sample &lt;- bike_thefts |&gt; </span></span>
<span id="cb20-600"><a href="#cb20-600"></a><span class="in">  st_intersection(vancouver_boundary) |&gt; </span></span>
<span id="cb20-601"><a href="#cb20-601"></a><span class="in">  sample_frac(0.2)</span></span>
<span id="cb20-602"><a href="#cb20-602"></a><span class="in">bike_theft_hull &lt;- bike_thefts_sample |&gt; </span></span>
<span id="cb20-603"><a href="#cb20-603"></a><span class="in">  st_intersection(vancouver_boundary) |&gt; </span></span>
<span id="cb20-604"><a href="#cb20-604"></a><span class="in">  st_union() |&gt; </span></span>
<span id="cb20-605"><a href="#cb20-605"></a><span class="in">  st_convex_hull()</span></span>
<span id="cb20-606"><a href="#cb20-606"></a><span class="in">bike_theft_sample_kde &lt;- hotspot_kde(</span></span>
<span id="cb20-607"><a href="#cb20-607"></a><span class="in">  bike_thefts_sample, </span></span>
<span id="cb20-608"><a href="#cb20-608"></a><span class="in">  bandwidth_adjust = 0.5, </span></span>
<span id="cb20-609"><a href="#cb20-609"></a><span class="in">  quiet = TRUE</span></span>
<span id="cb20-610"><a href="#cb20-610"></a><span class="in">)</span></span>
<span id="cb20-611"><a href="#cb20-611"></a></span>
<span id="cb20-612"><a href="#cb20-612"></a></span>
<span id="cb20-613"><a href="#cb20-613"></a><span class="in"># First map ----</span></span>
<span id="cb20-614"><a href="#cb20-614"></a></span>
<span id="cb20-615"><a href="#cb20-615"></a><span class="in">hull_map_1 &lt;- ggplot() +</span></span>
<span id="cb20-616"><a href="#cb20-616"></a><span class="in">  geom_sf(data = bike_theft_hull, colour = NA, fill = NA) +</span></span>
<span id="cb20-617"><a href="#cb20-617"></a><span class="in">  geom_sf(data = vancouver_boundary, colour = NA, fill = NA) +</span></span>
<span id="cb20-618"><a href="#cb20-618"></a><span class="in">  geom_sf(data = bike_thefts_sample, colour = "grey50", size = 0.1) +</span></span>
<span id="cb20-619"><a href="#cb20-619"></a><span class="in">  geom_sf(data = vancouver_boundary, colour = "seagreen", fill = NA, linewidth = 0.75) +</span></span>
<span id="cb20-620"><a href="#cb20-620"></a><span class="in">  theme_void()</span></span>
<span id="cb20-621"><a href="#cb20-621"></a></span>
<span id="cb20-622"><a href="#cb20-622"></a><span class="in">ggsave(</span></span>
<span id="cb20-623"><a href="#cb20-623"></a><span class="in">  "inst/tutorials/05_your_second_crime_map/images/hull_clipping_1.jpg", </span></span>
<span id="cb20-624"><a href="#cb20-624"></a><span class="in">  hull_map_1, </span></span>
<span id="cb20-625"><a href="#cb20-625"></a><span class="in">  width = 400 / 150, </span></span>
<span id="cb20-626"><a href="#cb20-626"></a><span class="in">  height = 300 / 150, </span></span>
<span id="cb20-627"><a href="#cb20-627"></a><span class="in">  dpi = 150</span></span>
<span id="cb20-628"><a href="#cb20-628"></a><span class="in">)</span></span>
<span id="cb20-629"><a href="#cb20-629"></a></span>
<span id="cb20-630"><a href="#cb20-630"></a></span>
<span id="cb20-631"><a href="#cb20-631"></a><span class="in"># Second map ----</span></span>
<span id="cb20-632"><a href="#cb20-632"></a></span>
<span id="cb20-633"><a href="#cb20-633"></a><span class="in">hull_map_2 &lt;- ggplot() +</span></span>
<span id="cb20-634"><a href="#cb20-634"></a><span class="in">  geom_sf(data = bike_theft_hull, colour = NA, fill = NA) +</span></span>
<span id="cb20-635"><a href="#cb20-635"></a><span class="in">  geom_sf(data = vancouver_boundary, colour = NA, fill = NA) +</span></span>
<span id="cb20-636"><a href="#cb20-636"></a><span class="in">  geom_sf(data = bike_thefts_sample, colour = "grey50", size = 0.1) +</span></span>
<span id="cb20-637"><a href="#cb20-637"></a><span class="in">  geom_sf(data = bike_theft_hull, colour = "seagreen", fill = NA, linetype = "33", linewidth = 0.75) +</span></span>
<span id="cb20-638"><a href="#cb20-638"></a><span class="in">  theme_void()</span></span>
<span id="cb20-639"><a href="#cb20-639"></a></span>
<span id="cb20-640"><a href="#cb20-640"></a><span class="in">ggsave(</span></span>
<span id="cb20-641"><a href="#cb20-641"></a><span class="in">  "inst/tutorials/05_your_second_crime_map/images/hull_clipping_2.jpg", </span></span>
<span id="cb20-642"><a href="#cb20-642"></a><span class="in">  hull_map_2, </span></span>
<span id="cb20-643"><a href="#cb20-643"></a><span class="in">  width = 400 / 150, </span></span>
<span id="cb20-644"><a href="#cb20-644"></a><span class="in">  height = 300 / 150, </span></span>
<span id="cb20-645"><a href="#cb20-645"></a><span class="in">  dpi = 150</span></span>
<span id="cb20-646"><a href="#cb20-646"></a><span class="in">)</span></span>
<span id="cb20-647"><a href="#cb20-647"></a></span>
<span id="cb20-648"><a href="#cb20-648"></a></span>
<span id="cb20-649"><a href="#cb20-649"></a><span class="in"># Third map ----</span></span>
<span id="cb20-650"><a href="#cb20-650"></a></span>
<span id="cb20-651"><a href="#cb20-651"></a><span class="in">hull_map_3 &lt;- ggplot() +</span></span>
<span id="cb20-652"><a href="#cb20-652"></a><span class="in">  geom_sf(data = bike_theft_hull, colour = NA, fill = NA) +</span></span>
<span id="cb20-653"><a href="#cb20-653"></a><span class="in">  geom_sf(data = vancouver_boundary, colour = NA, fill = NA) +</span></span>
<span id="cb20-654"><a href="#cb20-654"></a><span class="in">  geom_sf(data = st_difference(bike_theft_hull, vancouver_boundary), colour = NA, fill = "seagreen3") +</span></span>
<span id="cb20-655"><a href="#cb20-655"></a><span class="in">  geom_sf(data = bike_thefts_sample, colour = "grey50", size = 0.1) +</span></span>
<span id="cb20-656"><a href="#cb20-656"></a><span class="in">  geom_sf(data = vancouver_boundary, colour = "seagreen", fill = NA, linewidth = 0.75) +</span></span>
<span id="cb20-657"><a href="#cb20-657"></a><span class="in">  geom_sf(data = bike_theft_hull, colour = "seagreen", fill = NA, linetype = "33", linewidth = 0.75) +</span></span>
<span id="cb20-658"><a href="#cb20-658"></a><span class="in">  theme_void()</span></span>
<span id="cb20-659"><a href="#cb20-659"></a></span>
<span id="cb20-660"><a href="#cb20-660"></a><span class="in">ggsave(</span></span>
<span id="cb20-661"><a href="#cb20-661"></a><span class="in">  "inst/tutorials/05_your_second_crime_map/images/hull_clipping_3.jpg", </span></span>
<span id="cb20-662"><a href="#cb20-662"></a><span class="in">  hull_map_3, </span></span>
<span id="cb20-663"><a href="#cb20-663"></a><span class="in">  width = 400 / 150, </span></span>
<span id="cb20-664"><a href="#cb20-664"></a><span class="in">  height = 300 / 150, </span></span>
<span id="cb20-665"><a href="#cb20-665"></a><span class="in">  dpi = 150</span></span>
<span id="cb20-666"><a href="#cb20-666"></a><span class="in">)</span></span>
<span id="cb20-667"><a href="#cb20-667"></a></span>
<span id="cb20-668"><a href="#cb20-668"></a></span>
<span id="cb20-669"><a href="#cb20-669"></a><span class="in"># Fourth map ----</span></span>
<span id="cb20-670"><a href="#cb20-670"></a></span>
<span id="cb20-671"><a href="#cb20-671"></a><span class="in">hull_map_4 &lt;- ggplot() +</span></span>
<span id="cb20-672"><a href="#cb20-672"></a><span class="in">  geom_sf(data = bike_theft_hull, colour = NA, fill = NA) +</span></span>
<span id="cb20-673"><a href="#cb20-673"></a><span class="in">  geom_sf(data = vancouver_boundary, colour = NA, fill = NA) +</span></span>
<span id="cb20-674"><a href="#cb20-674"></a><span class="in">  geom_sf(</span></span>
<span id="cb20-675"><a href="#cb20-675"></a><span class="in">    aes(fill = kde),</span></span>
<span id="cb20-676"><a href="#cb20-676"></a><span class="in">    data = st_intersection(bike_theft_sample_kde, vancouver_boundary),</span></span>
<span id="cb20-677"><a href="#cb20-677"></a><span class="in">    colour = NA</span></span>
<span id="cb20-678"><a href="#cb20-678"></a><span class="in">  ) +</span></span>
<span id="cb20-679"><a href="#cb20-679"></a><span class="in">  geom_sf(data = vancouver_boundary, colour = "seagreen", fill = NA, linewidth = 0.75) +</span></span>
<span id="cb20-680"><a href="#cb20-680"></a><span class="in">  geom_sf(data = bike_theft_hull, colour = "seagreen", fill = NA, linetype = "33", linewidth = 0.75) +</span></span>
<span id="cb20-681"><a href="#cb20-681"></a><span class="in">  scale_fill_distiller(palette = "Greens", direction = 1) +</span></span>
<span id="cb20-682"><a href="#cb20-682"></a><span class="in">  theme_void() +</span></span>
<span id="cb20-683"><a href="#cb20-683"></a><span class="in">  theme(</span></span>
<span id="cb20-684"><a href="#cb20-684"></a><span class="in">    legend.position = "none"</span></span>
<span id="cb20-685"><a href="#cb20-685"></a><span class="in">  )</span></span>
<span id="cb20-686"><a href="#cb20-686"></a></span>
<span id="cb20-687"><a href="#cb20-687"></a><span class="in">ggsave(</span></span>
<span id="cb20-688"><a href="#cb20-688"></a><span class="in">  "inst/tutorials/05_your_second_crime_map/images/hull_clipping_4.jpg", </span></span>
<span id="cb20-689"><a href="#cb20-689"></a><span class="in">  hull_map_4, </span></span>
<span id="cb20-690"><a href="#cb20-690"></a><span class="in">  width = 400 / 150, </span></span>
<span id="cb20-691"><a href="#cb20-691"></a><span class="in">  height = 300 / 150, </span></span>
<span id="cb20-692"><a href="#cb20-692"></a><span class="in">  dpi = 150</span></span>
<span id="cb20-693"><a href="#cb20-693"></a><span class="in">)</span></span>
<span id="cb20-694"><a href="#cb20-694"></a><span class="in">```</span></span>
<span id="cb20-695"><a href="#cb20-695"></a></span>
<span id="cb20-696"><a href="#cb20-696"></a>:::: {.columns}</span>
<span id="cb20-697"><a href="#cb20-697"></a></span>
<span id="cb20-698"><a href="#cb20-698"></a></span>
<span id="cb20-699"><a href="#cb20-699"></a>::: {.column width="50%" style="padding-right: 1em;"}</span>
<span id="cb20-700"><a href="#cb20-700"></a></span>
<span id="cb20-701"><a href="#cb20-701"></a>A. We only have data on bike thefts from the City of Vancouver, so all the bike </span>
<span id="cb20-702"><a href="#cb20-702"></a>thefts in the data necessarily occurred within the city. We do not know what the</span>
<span id="cb20-703"><a href="#cb20-703"></a>density of crime outside the city is.</span>
<span id="cb20-704"><a href="#cb20-704"></a></span>
<span id="cb20-705"><a href="#cb20-705"></a><span class="al">![](../images/hull_clipping_1.jpg)</span>{width=100%}</span>
<span id="cb20-706"><a href="#cb20-706"></a></span>
<span id="cb20-707"><a href="#cb20-707"></a>:::</span>
<span id="cb20-708"><a href="#cb20-708"></a></span>
<span id="cb20-709"><a href="#cb20-709"></a></span>
<span id="cb20-710"><a href="#cb20-710"></a>::: {.column width="50%" style="padding-left: 1em;"}</span>
<span id="cb20-711"><a href="#cb20-711"></a></span>
<span id="cb20-712"><a href="#cb20-712"></a>B. The KDE function only knows the theft locations, not the area in which thefts </span>
<span id="cb20-713"><a href="#cb20-713"></a>could have occurred. So the convex hull created by the KDE layer will not </span>
<span id="cb20-714"><a href="#cb20-714"></a>necessarily match the area of the data.</span>
<span id="cb20-715"><a href="#cb20-715"></a></span>
<span id="cb20-716"><a href="#cb20-716"></a><span class="al">![](../images/hull_clipping_2.jpg)</span>{width=100%}</span>
<span id="cb20-717"><a href="#cb20-717"></a></span>
<span id="cb20-718"><a href="#cb20-718"></a>:::</span>
<span id="cb20-719"><a href="#cb20-719"></a></span>
<span id="cb20-720"><a href="#cb20-720"></a></span>
<span id="cb20-721"><a href="#cb20-721"></a>::::</span>
<span id="cb20-722"><a href="#cb20-722"></a></span>
<span id="cb20-723"><a href="#cb20-723"></a></span>
<span id="cb20-724"><a href="#cb20-724"></a>:::: {.columns}</span>
<span id="cb20-725"><a href="#cb20-725"></a></span>
<span id="cb20-726"><a href="#cb20-726"></a></span>
<span id="cb20-727"><a href="#cb20-727"></a>::: {.column width="50%" style="padding-right: 1em;"}</span>
<span id="cb20-728"><a href="#cb20-728"></a></span>
<span id="cb20-729"><a href="#cb20-729"></a>C. In this case, that means some areas (shaded) will be included in the KDE </span>
<span id="cb20-730"><a href="#cb20-730"></a>layer even though they happened outside the area covered by the data, which </span>
<span id="cb20-731"><a href="#cb20-731"></a>could be misleading.</span>
<span id="cb20-732"><a href="#cb20-732"></a></span>
<span id="cb20-733"><a href="#cb20-733"></a><span class="al">![](../images/hull_clipping_3.jpg)</span>{width=100%}</span>
<span id="cb20-734"><a href="#cb20-734"></a></span>
<span id="cb20-735"><a href="#cb20-735"></a>:::</span>
<span id="cb20-736"><a href="#cb20-736"></a></span>
<span id="cb20-737"><a href="#cb20-737"></a></span>
<span id="cb20-738"><a href="#cb20-738"></a>::: {.column width="50%" style="padding-left: 1em;"}</span>
<span id="cb20-739"><a href="#cb20-739"></a></span>
<span id="cb20-740"><a href="#cb20-740"></a>D. To avoid suggesting we know the density of crimes in areas for which we do </span>
<span id="cb20-741"><a href="#cb20-741"></a>not have data, we should clip the KDE layer to the boundary of the area for </span>
<span id="cb20-742"><a href="#cb20-742"></a>which we have data.</span>
<span id="cb20-743"><a href="#cb20-743"></a></span>
<span id="cb20-744"><a href="#cb20-744"></a><span class="al">![](../images/hull_clipping_4.jpg)</span>{width=100%}</span>
<span id="cb20-745"><a href="#cb20-745"></a>:::</span>
<span id="cb20-746"><a href="#cb20-746"></a></span>
<span id="cb20-747"><a href="#cb20-747"></a></span>
<span id="cb20-748"><a href="#cb20-748"></a>::::</span>
<span id="cb20-749"><a href="#cb20-749"></a></span>
<span id="cb20-750"><a href="#cb20-750"></a></span>
<span id="cb20-751"><a href="#cb20-751"></a>To clip the KDE layer to the boundary of the area for which we have data, we need a new dataset that contains the boundary of the City of Vancouver. Fortunately this dataset is available online in a spatial format known as a <span class="co">[</span><span class="ot">GeoJSON</span><span class="co">](https://en.wikipedia.org/wiki/GeoJSON)</span> file. GeoJSON is a spatial file format, so we can load it in R using the <span class="in">`read_sf()`</span> function from the sf package.</span>
<span id="cb20-752"><a href="#cb20-752"></a></span>
<span id="cb20-753"><a href="#cb20-753"></a>Rather than add the code needed to load this dataset to the end of our script file, it will be neater to add it to the point in the file where we load the other data. That way, if we come back to the file later, all the code that loads datasets will be in one place and it will be easy to see what data is loaded by that script. Add this code to the <span class="in">`chapter_06.R`</span> file, after the pipeline that loads and wrangles the bike-theft data and before code that creates the <span class="in">`bike_theft_density`</span> object.</span>
<span id="cb20-754"><a href="#cb20-754"></a></span>
<span id="cb20-757"><a href="#cb20-757"></a><span class="in">```{r}</span></span>
<span id="cb20-758"><a href="#cb20-758"></a><span class="co">#| filename: "chapter_06.R"</span></span>
<span id="cb20-759"><a href="#cb20-759"></a></span>
<span id="cb20-760"><a href="#cb20-760"></a><span class="co"># Load Vancouver neighbourhood boundaries</span></span>
<span id="cb20-761"><a href="#cb20-761"></a>vancouver_nbhds <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_neighbourhoods.geojson"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-762"><a href="#cb20-762"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:32610"</span>)</span>
<span id="cb20-763"><a href="#cb20-763"></a><span class="in">```</span></span>
<span id="cb20-764"><a href="#cb20-764"></a></span>
<span id="cb20-765"><a href="#cb20-765"></a>You might have noticed that as well as loading the boundary data with <span class="in">`read_sf()`</span>, we have transformed the data to use the same co-ordinate system (EPSG:32610) as is used for the <span class="in">`bike_thefts`</span> object. This is because we can only clip datasets that use the same co-ordinate system.</span>
<span id="cb20-766"><a href="#cb20-766"></a></span>
<span id="cb20-767"><a href="#cb20-767"></a>Before we clip the density layer to the city boundary, check that your file <span class="in">`chapter_06.R`</span> looks like this:</span>
<span id="cb20-768"><a href="#cb20-768"></a></span>
<span id="cb20-771"><a href="#cb20-771"></a><span class="in">```{r}</span></span>
<span id="cb20-772"><a href="#cb20-772"></a><span class="co">#| eval: false</span></span>
<span id="cb20-773"><a href="#cb20-773"></a><span class="co">#| filename: "chapter_06.R"</span></span>
<span id="cb20-774"><a href="#cb20-774"></a></span>
<span id="cb20-775"><a href="#cb20-775"></a><span class="co"># Load packages</span></span>
<span id="cb20-776"><a href="#cb20-776"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, sfhotspot, tidyverse)</span>
<span id="cb20-777"><a href="#cb20-777"></a></span>
<span id="cb20-778"><a href="#cb20-778"></a><span class="co"># Load and wrangle bike theft data</span></span>
<span id="cb20-779"><a href="#cb20-779"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-780"><a href="#cb20-780"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-781"><a href="#cb20-781"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-782"><a href="#cb20-782"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span>
<span id="cb20-783"><a href="#cb20-783"></a></span>
<span id="cb20-784"><a href="#cb20-784"></a><span class="co"># Load Vancouver neighbourhood boundaries</span></span>
<span id="cb20-785"><a href="#cb20-785"></a>vancouver_nbhds <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_neighbourhoods.geojson"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-786"><a href="#cb20-786"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:32610"</span>)</span>
<span id="cb20-787"><a href="#cb20-787"></a></span>
<span id="cb20-788"><a href="#cb20-788"></a><span class="co"># Estimate density of bike thefts</span></span>
<span id="cb20-789"><a href="#cb20-789"></a>bike_theft_density <span class="ot">&lt;-</span> <span class="fu">hotspot_kde</span>(</span>
<span id="cb20-790"><a href="#cb20-790"></a>  bike_thefts, </span>
<span id="cb20-791"><a href="#cb20-791"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.5</span>, </span>
<span id="cb20-792"><a href="#cb20-792"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb20-793"><a href="#cb20-793"></a>)</span>
<span id="cb20-794"><a href="#cb20-794"></a></span>
<span id="cb20-795"><a href="#cb20-795"></a><span class="co"># Plot density map</span></span>
<span id="cb20-796"><a href="#cb20-796"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-797"><a href="#cb20-797"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> kde), <span class="at">data =</span> bike_theft_density, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb20-798"><a href="#cb20-798"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"Oranges"</span>, <span class="at">direction =</span> <span class="dv">1</span>)</span>
<span id="cb20-799"><a href="#cb20-799"></a><span class="in">```</span></span>
<span id="cb20-800"><a href="#cb20-800"></a></span>
<span id="cb20-801"><a href="#cb20-801"></a></span>
<span id="cb20-802"><a href="#cb20-802"></a>We can clip the KDE layer produced by <span class="in">`hotspot_kde()`</span> to the boundary of the City of Vancouver using the <span class="in">`st_intersection()`</span> function from the <span class="in">`sf`</span> package. <span class="in">`st_intersection()`</span> removes any rows from the dataset provided as the first argument that do not fall within the area covered by the dataset provided as the</span>
<span id="cb20-803"><a href="#cb20-803"></a>second argument. We can use <span class="in">`st_intersection()`</span> to remove any cells in <span class="in">`bike_theft_density`</span> that are outside the city outline stored in <span class="in">`vancouver_nbhds`</span>.</span>
<span id="cb20-804"><a href="#cb20-804"></a></span>
<span id="cb20-805"><a href="#cb20-805"></a>We will now add the code needed to clip the KDE layer to the city boundary to the <span class="in">`chapter_06.R`</span> script file. Since we do not need the unclipped version of the KDE layer, we don't need to separately estimate the density and clip the result. Instead, we can combine the call to <span class="in">`st_intersection()`</span> with the existing call to <span class="in">`hotspot_kde()`</span> to form a pipeline using the pipe (<span class="in">`|&gt;`</span>) operator. To do that, in the <span class="in">`chapter_06.R`</span> file replace the line that creates the <span class="in">`bike_theft_density`</span> object with this code:</span>
<span id="cb20-806"><a href="#cb20-806"></a></span>
<span id="cb20-809"><a href="#cb20-809"></a><span class="in">```{r}</span></span>
<span id="cb20-810"><a href="#cb20-810"></a><span class="co">#| filename: "chapter_06.R"</span></span>
<span id="cb20-811"><a href="#cb20-811"></a></span>
<span id="cb20-812"><a href="#cb20-812"></a><span class="co"># Estimate density of bike thefts and clip result</span></span>
<span id="cb20-813"><a href="#cb20-813"></a>bike_theft_density_clip <span class="ot">&lt;-</span> bike_thefts <span class="sc">|&gt;</span> </span>
<span id="cb20-814"><a href="#cb20-814"></a>  <span class="fu">hotspot_kde</span>(<span class="at">bandwidth_adjust =</span> <span class="fl">0.5</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-815"><a href="#cb20-815"></a>  <span class="fu">st_intersection</span>(vancouver_nbhds)</span>
<span id="cb20-816"><a href="#cb20-816"></a><span class="in">```</span></span>
<span id="cb20-817"><a href="#cb20-817"></a></span>
<span id="cb20-818"><a href="#cb20-818"></a>We can read this code as saying: </span>
<span id="cb20-819"><a href="#cb20-819"></a></span>
<span id="cb20-820"><a href="#cb20-820"></a>&lt;blockquote&gt;</span>
<span id="cb20-821"><a href="#cb20-821"></a>take the <span class="in">`bike_thefts`</span> object, &lt;br&gt;</span>
<span id="cb20-822"><a href="#cb20-822"></a>… use it to estimate the density of thefts&lt;br&gt;</span>
<span id="cb20-823"><a href="#cb20-823"></a>… _and then_ clip the resulting density object to the boundary stored in the <span class="in">`vancouver_nbhds`</span> object.</span>
<span id="cb20-824"><a href="#cb20-824"></a>&lt;/blockquote&gt;</span>
<span id="cb20-825"><a href="#cb20-825"></a></span>
<span id="cb20-826"><a href="#cb20-826"></a>If you aren't comfortable with how the pipe operator works, you might want to refer back to @sec-pipe-operator.</span>
<span id="cb20-827"><a href="#cb20-827"></a></span>
<span id="cb20-828"><a href="#cb20-828"></a></span>
<span id="cb20-829"><a href="#cb20-829"></a>::: {.callout-important}</span>
<span id="cb20-830"><a href="#cb20-830"></a><span class="fu">#### `st_intersection()` requires both objects to use the same co-ordinate system</span></span>
<span id="cb20-831"><a href="#cb20-831"></a></span>
<span id="cb20-832"><a href="#cb20-832"></a>The <span class="in">`st_intersection()`</span> function requires that both spatial layers have the same co-ordinate system. If the two layers use different co-ordinate systems, you will need to transform one of the layers using <span class="in">`st_transform()`</span> so that it uses the same co-ordinate system as the other layer.</span>
<span id="cb20-833"><a href="#cb20-833"></a></span>
<span id="cb20-834"><a href="#cb20-834"></a>If you do not know which co-ordinate systems the layers use, you can use the <span class="in">`st_crs()`</span> function to extract the co-ordinate system from one layer and pass that value as the second argument to <span class="in">`st_transform()`</span>. For example:</span>
<span id="cb20-835"><a href="#cb20-835"></a></span>
<span id="cb20-836"><a href="#cb20-836"></a><span class="in">```r</span></span>
<span id="cb20-837"><a href="#cb20-837"></a><span class="fu">st_transform</span>(bike_theft_density, <span class="at">crs =</span> <span class="fu">st_crs</span>(vancouver_nbhds))</span>
<span id="cb20-838"><a href="#cb20-838"></a><span class="in">```</span></span>
<span id="cb20-839"><a href="#cb20-839"></a></span>
<span id="cb20-840"><a href="#cb20-840"></a>:::</span>
<span id="cb20-841"><a href="#cb20-841"></a></span>
<span id="cb20-842"><a href="#cb20-842"></a>::: {.callout-important}</span>
<span id="cb20-843"><a href="#cb20-843"></a><span class="fu">#### Warning message: `attribute values are assumed to be spatially constant`</span></span>
<span id="cb20-844"><a href="#cb20-844"></a></span>
<span id="cb20-845"><a href="#cb20-845"></a><span class="in">`st_intersection()`</span> produces a warning message:</span>
<span id="cb20-846"><a href="#cb20-846"></a></span>
<span id="cb20-847"><a href="#cb20-847"></a><span class="in">```</span></span>
<span id="cb20-848"><a href="#cb20-848"></a><span class="in">Warning: attribute variables are assumed to be spatially </span></span>
<span id="cb20-849"><a href="#cb20-849"></a><span class="in">constant throughout all geometries</span></span>
<span id="cb20-850"><a href="#cb20-850"></a><span class="in">```</span></span>
<span id="cb20-851"><a href="#cb20-851"></a></span>
<span id="cb20-852"><a href="#cb20-852"></a>As long as you are simply using <span class="in">`st_intersection()`</span> to remove parts of the data outside a boundary, you can ignore this message.</span>
<span id="cb20-853"><a href="#cb20-853"></a></span>
<span id="cb20-854"><a href="#cb20-854"></a>:::</span>
<span id="cb20-855"><a href="#cb20-855"></a></span>
<span id="cb20-856"><a href="#cb20-856"></a>We can quickly check the effect of clipping the density layer to the city boundary by producing a very basic map that shows both layers in separate colours. Run this code in the R Console:</span>
<span id="cb20-857"><a href="#cb20-857"></a></span>
<span id="cb20-858"><a href="#cb20-858"></a></span>
<span id="cb20-861"><a href="#cb20-861"></a><span class="in">```{r}</span></span>
<span id="cb20-862"><a href="#cb20-862"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb20-863"><a href="#cb20-863"></a></span>
<span id="cb20-864"><a href="#cb20-864"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-865"><a href="#cb20-865"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_theft_density, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb20-866"><a href="#cb20-866"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_theft_density_clip, <span class="at">fill =</span> <span class="st">"green"</span>) <span class="sc">+</span></span>
<span id="cb20-867"><a href="#cb20-867"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> vancouver_nbhds, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="dv">1</span>)</span>
<span id="cb20-868"><a href="#cb20-868"></a><span class="in">```</span></span>
<span id="cb20-869"><a href="#cb20-869"></a></span>
<span id="cb20-870"><a href="#cb20-870"></a>From this map, we can see that while the <span class="in">`bike_theft_density`</span> object (shown in blue) contains cells outside the black city boundary, the <span class="in">`bike_theft_density_clip`</span> object (shown in green) contains only cells inside the boundary.</span>
<span id="cb20-871"><a href="#cb20-871"></a></span>
<span id="cb20-872"><a href="#cb20-872"></a></span>
<span id="cb20-873"><a href="#cb20-873"></a>::: {.callout-quiz .callout}</span>
<span id="cb20-874"><a href="#cb20-874"></a></span>
<span id="cb20-875"><a href="#cb20-875"></a><span class="in">```{r clipping_quiz}</span></span>
<span id="cb20-876"><a href="#cb20-876"></a><span class="in">#| echo: false</span></span>
<span id="cb20-877"><a href="#cb20-877"></a></span>
<span id="cb20-878"><a href="#cb20-878"></a><span class="in">clipping_quiz1 &lt;- c(</span></span>
<span id="cb20-879"><a href="#cb20-879"></a><span class="in">  "To transform one dataset into another coordinate system.",</span></span>
<span id="cb20-880"><a href="#cb20-880"></a><span class="in">  answer = "To clip a dataset to the boundary of another spatial layer.",</span></span>
<span id="cb20-881"><a href="#cb20-881"></a><span class="in">  "To merge multiple spatial layers into one.",</span></span>
<span id="cb20-882"><a href="#cb20-882"></a><span class="in">  "To calculate the centroid of spatial objects."  </span></span>
<span id="cb20-883"><a href="#cb20-883"></a><span class="in">)</span></span>
<span id="cb20-884"><a href="#cb20-884"></a></span>
<span id="cb20-885"><a href="#cb20-885"></a><span class="in">clipping_quiz2 &lt;- c(</span></span>
<span id="cb20-886"><a href="#cb20-886"></a><span class="in">  "To remove unnecessary layers.",</span></span>
<span id="cb20-887"><a href="#cb20-887"></a><span class="in">  "To reduce the overall size of the dataset.",</span></span>
<span id="cb20-888"><a href="#cb20-888"></a><span class="in">  "To improve the map’s aesthetic appearance.",</span></span>
<span id="cb20-889"><a href="#cb20-889"></a><span class="in">  answer = "To avoid showing incorrect density estimates for areas without data."</span></span>
<span id="cb20-890"><a href="#cb20-890"></a><span class="in">)</span></span>
<span id="cb20-891"><a href="#cb20-891"></a><span class="in">```</span></span>
<span id="cb20-892"><a href="#cb20-892"></a></span>
<span id="cb20-893"><a href="#cb20-893"></a></span>
<span id="cb20-894"><a href="#cb20-894"></a>**What is the purpose of the `st_intersection()` function in spatial data manipulation?**</span>
<span id="cb20-895"><a href="#cb20-895"></a></span>
<span id="cb20-896"><a href="#cb20-896"></a><span class="in">`r webexercises::longmcq(clipping_quiz1)`</span></span>
<span id="cb20-897"><a href="#cb20-897"></a></span>
<span id="cb20-898"><a href="#cb20-898"></a></span>
<span id="cb20-899"><a href="#cb20-899"></a>**Why is it important to clip a KDE layer to a relevant boundary in crime mapping?**</span>
<span id="cb20-900"><a href="#cb20-900"></a></span>
<span id="cb20-901"><a href="#cb20-901"></a><span class="in">`r webexercises::longmcq(clipping_quiz2)`</span></span>
<span id="cb20-902"><a href="#cb20-902"></a></span>
<span id="cb20-903"><a href="#cb20-903"></a></span>
<span id="cb20-904"><a href="#cb20-904"></a>:::</span>
<span id="cb20-905"><a href="#cb20-905"></a></span>
<span id="cb20-906"><a href="#cb20-906"></a></span>
<span id="cb20-907"><a href="#cb20-907"></a></span>
<span id="cb20-908"><a href="#cb20-908"></a><span class="fu">## Adding a base map {#sec-base-maps}</span></span>
<span id="cb20-909"><a href="#cb20-909"></a></span>
<span id="cb20-910"><a href="#cb20-910"></a>The density map we have made is much more effective than a point map at allowing us to identify where the highest number of bike thefts in Vancouver occur. However, it's still quite difficult to know *where* those places are, because we cannot easily work out where in the city these places are. We can make this much easier by adding a *base map* underneath the density layer.</span>
<span id="cb20-911"><a href="#cb20-911"></a></span>
<span id="cb20-912"><a href="#cb20-912"></a>We can add a base map using <span class="in">`annotation_map_tile()`</span> function from the <span class="co">[</span><span class="ot">ggspatial package</span><span class="co">](https://paleolimbot.github.io/ggspatial/)</span>. We can add <span class="in">`annotation_map_tile()`</span> to a <span class="in">`ggplot()`</span> stack in the same way that we would add <span class="in">`geom_*()`</span> functions. Since we want the base map to appear _under_ the density layer, we add the base map layer to the `ggplot()` stack _first_. So that we can see the base map underneath the density layer, we will also make the density layer semi-transparent using the <span class="in">`alpha`</span> argument to <span class="in">`geom_sf()`</span>.</span>
<span id="cb20-913"><a href="#cb20-913"></a></span>
<span id="cb20-914"><a href="#cb20-914"></a>Replace the existing <span class="in">`ggplot()`</span> stack in the <span class="in">`chapter_06.R`</span> file with this code and then run it:</span>
<span id="cb20-915"><a href="#cb20-915"></a></span>
<span id="cb20-918"><a href="#cb20-918"></a><span class="in">```{r}</span></span>
<span id="cb20-919"><a href="#cb20-919"></a><span class="co">#| filename: "chapter_06.R"</span></span>
<span id="cb20-920"><a href="#cb20-920"></a></span>
<span id="cb20-921"><a href="#cb20-921"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-922"><a href="#cb20-922"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb20-923"><a href="#cb20-923"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb20-924"><a href="#cb20-924"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb20-925"><a href="#cb20-925"></a>    <span class="at">data =</span> bike_theft_density_clip, </span>
<span id="cb20-926"><a href="#cb20-926"></a>    <span class="at">alpha =</span> <span class="fl">0.67</span>, </span>
<span id="cb20-927"><a href="#cb20-927"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb20-928"><a href="#cb20-928"></a>  ) <span class="sc">+</span></span>
<span id="cb20-929"><a href="#cb20-929"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"Purples"</span>, <span class="at">direction =</span> <span class="dv">1</span>)</span>
<span id="cb20-930"><a href="#cb20-930"></a><span class="in">```</span></span>
<span id="cb20-931"><a href="#cb20-931"></a></span>
<span id="cb20-932"><a href="#cb20-932"></a>The base maps returned by <span class="in">`annotation_map_tile()`</span> are available at many different <span class="co">[</span><span class="ot">zoom levels</span><span class="co">](https://wiki.openstreetmap.org/wiki/Zoom_levels)</span>, from level 1 that is useful for mapping the whole world in one map, to level 20 that can be used to map a single building. By default, <span class="in">`annotation_map_tile()`</span> downloads tiles with slightly less detail than we might want, but we can fix this by using the argument <span class="in">`zoomin = 0`</span>. We could also set a specific zoom level using the <span class="in">`zoom`</span> argument.</span>
<span id="cb20-933"><a href="#cb20-933"></a></span>
<span id="cb20-934"><a href="#cb20-934"></a>For example, these maps show the same area around the UCL Jill Dando Institute with base maps at different zoom levels.</span>
<span id="cb20-935"><a href="#cb20-935"></a></span>
<span id="cb20-936"><a href="#cb20-936"></a><span class="in">```{r make-zoom-map}</span></span>
<span id="cb20-937"><a href="#cb20-937"></a><span class="in">#| eval: false</span></span>
<span id="cb20-938"><a href="#cb20-938"></a><span class="in">#| echo: false</span></span>
<span id="cb20-939"><a href="#cb20-939"></a></span>
<span id="cb20-940"><a href="#cb20-940"></a><span class="in">jdi &lt;- c(-0.12979747256628416, 51.52501948280652) |&gt; </span></span>
<span id="cb20-941"><a href="#cb20-941"></a><span class="in">  st_point() |&gt; </span></span>
<span id="cb20-942"><a href="#cb20-942"></a><span class="in">  st_sfc(crs = "EPSG:4326") |&gt; </span></span>
<span id="cb20-943"><a href="#cb20-943"></a><span class="in">  st_transform("EPSG:27700") |&gt; </span></span>
<span id="cb20-944"><a href="#cb20-944"></a><span class="in">  st_buffer(2000)</span></span>
<span id="cb20-945"><a href="#cb20-945"></a></span>
<span id="cb20-946"><a href="#cb20-946"></a><span class="in">zoom_map &lt;- map(8:16, function(zoom_level) {</span></span>
<span id="cb20-947"><a href="#cb20-947"></a><span class="in">  ggplot() + </span></span>
<span id="cb20-948"><a href="#cb20-948"></a><span class="in">    annotation_map_tile(zoom = zoom_level, progress = "none") +</span></span>
<span id="cb20-949"><a href="#cb20-949"></a><span class="in">    geom_sf(data = jdi, colour = NA, fill = NA) +</span></span>
<span id="cb20-950"><a href="#cb20-950"></a><span class="in">    labs(subtitle = str_glue("zoom level {zoom_level}")) +</span></span>
<span id="cb20-951"><a href="#cb20-951"></a><span class="in">    theme_void() +</span></span>
<span id="cb20-952"><a href="#cb20-952"></a><span class="in">    theme(</span></span>
<span id="cb20-953"><a href="#cb20-953"></a><span class="in">      panel.border = element_rect(colour = "black", fill = NA, size = 1),</span></span>
<span id="cb20-954"><a href="#cb20-954"></a><span class="in">      plot.margin = unit(c(6, 6, 6, 6), "pt"),</span></span>
<span id="cb20-955"><a href="#cb20-955"></a><span class="in">      plot.subtitle = element_text(size = 10)</span></span>
<span id="cb20-956"><a href="#cb20-956"></a><span class="in">    )</span></span>
<span id="cb20-957"><a href="#cb20-957"></a><span class="in">}) |&gt; </span></span>
<span id="cb20-958"><a href="#cb20-958"></a><span class="in">  wrap_plots(ncol = 3)</span></span>
<span id="cb20-959"><a href="#cb20-959"></a></span>
<span id="cb20-960"><a href="#cb20-960"></a><span class="in">ggsave(</span></span>
<span id="cb20-961"><a href="#cb20-961"></a><span class="in">  here::here("images/zoom.jpg"), </span></span>
<span id="cb20-962"><a href="#cb20-962"></a><span class="in">  zoom_map, </span></span>
<span id="cb20-963"><a href="#cb20-963"></a><span class="in">  width = 800 / 150, </span></span>
<span id="cb20-964"><a href="#cb20-964"></a><span class="in">  height = 800 / 150, </span></span>
<span id="cb20-965"><a href="#cb20-965"></a><span class="in">  dpi = 150</span></span>
<span id="cb20-966"><a href="#cb20-966"></a><span class="in">)</span></span>
<span id="cb20-967"><a href="#cb20-967"></a><span class="in">```</span></span>
<span id="cb20-968"><a href="#cb20-968"></a></span>
<span id="cb20-969"><a href="#cb20-969"></a><span class="in">```{r zoom-map}</span></span>
<span id="cb20-970"><a href="#cb20-970"></a><span class="in">#| echo: false</span></span>
<span id="cb20-971"><a href="#cb20-971"></a><span class="in">#| fig.align: center</span></span>
<span id="cb20-972"><a href="#cb20-972"></a><span class="in">#| out.width: 100%</span></span>
<span id="cb20-973"><a href="#cb20-973"></a></span>
<span id="cb20-974"><a href="#cb20-974"></a><span class="in">knitr::include_graphics(here::here("images/zoom.jpg"))</span></span>
<span id="cb20-975"><a href="#cb20-975"></a><span class="in">```</span></span>
<span id="cb20-976"><a href="#cb20-976"></a></span>
<span id="cb20-977"><a href="#cb20-977"></a>Choosing the right zoom level is a matter of balancing the level of detail in the map and the clarity of the image. In the maps above, zoom levels less than 12 tend to have pixelated images because they do not contain enough detail, while zoom levels greater than 12 contain too much detail and so the information is hard to read. But if this map covered a smaller or larger area, a different zoom level might be better. In general, setting <span class="in">`zoomin = 0`</span> and _not_ setting any value for the <span class="in">`zoom`</span> argument -- so that <span class="in">`annotation_map_tile()`</span> chooses the zoom level automatically -- will produce an acceptable map.</span>
<span id="cb20-978"><a href="#cb20-978"></a></span>
<span id="cb20-979"><a href="#cb20-979"></a><span class="in">`annotation_map_tile()`</span> also gives us access to several different types of base map. The default style (seen in the maps above) is called 'osm' because it is the default style used by Open Street Map, the organisation that provides the map data. We can specify which style of base map we want using the <span class="in">`type`</span> argument to <span class="in">`annotation_map_tile()`</span>.</span>
<span id="cb20-980"><a href="#cb20-980"></a></span>
<span id="cb20-981"><a href="#cb20-981"></a><span class="in">```{r make-basemaps-map}</span></span>
<span id="cb20-982"><a href="#cb20-982"></a><span class="in">#| eval: false</span></span>
<span id="cb20-983"><a href="#cb20-983"></a><span class="in">#| echo: false</span></span>
<span id="cb20-984"><a href="#cb20-984"></a></span>
<span id="cb20-985"><a href="#cb20-985"></a><span class="in">basemaps_map &lt;- c(</span></span>
<span id="cb20-986"><a href="#cb20-986"></a><span class="in">  "osm", "opencycle", "hotstyle",  "stamenbw", "stamenwatercolor", </span></span>
<span id="cb20-987"><a href="#cb20-987"></a><span class="in">  "osmtransport", "thunderforestlandscape", "thunderforestoutdoors", </span></span>
<span id="cb20-988"><a href="#cb20-988"></a><span class="in">  "cartodark", "cartolight"</span></span>
<span id="cb20-989"><a href="#cb20-989"></a><span class="in">) |&gt; </span></span>
<span id="cb20-990"><a href="#cb20-990"></a><span class="in">  map(function (x) {</span></span>
<span id="cb20-991"><a href="#cb20-991"></a><span class="in">    ggplot() +</span></span>
<span id="cb20-992"><a href="#cb20-992"></a><span class="in">      annotation_map_tile(type = x, zoom = 12, progress = "none") +</span></span>
<span id="cb20-993"><a href="#cb20-993"></a><span class="in">      geom_sf(data = jdi, colour = NA, fill = NA) +</span></span>
<span id="cb20-994"><a href="#cb20-994"></a><span class="in">      labs(subtitle = if_else(x == "osm", "osm (default)", x)) +</span></span>
<span id="cb20-995"><a href="#cb20-995"></a><span class="in">      theme_void() +</span></span>
<span id="cb20-996"><a href="#cb20-996"></a><span class="in">      theme(</span></span>
<span id="cb20-997"><a href="#cb20-997"></a><span class="in">        panel.border = element_rect(colour = "black", fill = NA, size = 1),</span></span>
<span id="cb20-998"><a href="#cb20-998"></a><span class="in">        plot.margin = unit(c(6, 6, 6, 6), "pt"),</span></span>
<span id="cb20-999"><a href="#cb20-999"></a><span class="in">        plot.subtitle = element_text(size = 10)</span></span>
<span id="cb20-1000"><a href="#cb20-1000"></a><span class="in">      )</span></span>
<span id="cb20-1001"><a href="#cb20-1001"></a><span class="in">  }) |&gt; </span></span>
<span id="cb20-1002"><a href="#cb20-1002"></a><span class="in">  wrap_plots(ncol = 3)</span></span>
<span id="cb20-1003"><a href="#cb20-1003"></a></span>
<span id="cb20-1004"><a href="#cb20-1004"></a><span class="in">ggsave(</span></span>
<span id="cb20-1005"><a href="#cb20-1005"></a><span class="in">  here::here("images/basemaps.jpg"), </span></span>
<span id="cb20-1006"><a href="#cb20-1006"></a><span class="in">  basemaps_map, </span></span>
<span id="cb20-1007"><a href="#cb20-1007"></a><span class="in">  width = 800 / 150, </span></span>
<span id="cb20-1008"><a href="#cb20-1008"></a><span class="in">  height = 1200 / 150, </span></span>
<span id="cb20-1009"><a href="#cb20-1009"></a><span class="in">  dpi = 150</span></span>
<span id="cb20-1010"><a href="#cb20-1010"></a><span class="in">)</span></span>
<span id="cb20-1011"><a href="#cb20-1011"></a><span class="in">```</span></span>
<span id="cb20-1012"><a href="#cb20-1012"></a></span>
<span id="cb20-1013"><a href="#cb20-1013"></a><span class="in">```{r basemaps-map}</span></span>
<span id="cb20-1014"><a href="#cb20-1014"></a><span class="in">#| echo: false</span></span>
<span id="cb20-1015"><a href="#cb20-1015"></a><span class="in">#| fig.align: center</span></span>
<span id="cb20-1016"><a href="#cb20-1016"></a><span class="in">#| out.width: 100%</span></span>
<span id="cb20-1017"><a href="#cb20-1017"></a></span>
<span id="cb20-1018"><a href="#cb20-1018"></a><span class="in">knitr::include_graphics(here::here("images/basemaps.jpg"))</span></span>
<span id="cb20-1019"><a href="#cb20-1019"></a><span class="in">```</span></span>
<span id="cb20-1020"><a href="#cb20-1020"></a></span>
<span id="cb20-1021"><a href="#cb20-1021"></a>You may want to experiment with different base map styles by using the <span class="in">`type`</span> argument to <span class="in">`annotation_map_tile()`</span>, e.g. using <span class="in">`annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none")`</span>.</span>
<span id="cb20-1022"><a href="#cb20-1022"></a></span>
<span id="cb20-1023"><a href="#cb20-1023"></a>One final note about the <span class="in">`annotation_map_tile()`</span> function: you might have noticed that when we have used it above we have always set the argument <span class="in">`progress = "none"`</span>. This stops the function from printing a progress bar while it is downloading the map tiles. The progress bar can sometimes be useful, but when you include the output from an R function in a report (as you will learn to do in @sec-reports), the output from the progress bar is likely to interfere with the formatting of the report. To prevent that, we use the <span class="in">`progress = "none"`</span> argument.</span>
<span id="cb20-1024"><a href="#cb20-1024"></a></span>
<span id="cb20-1025"><a href="#cb20-1025"></a></span>
<span id="cb20-1026"><a href="#cb20-1026"></a>::: {.callout-quiz .callout}</span>
<span id="cb20-1027"><a href="#cb20-1027"></a><span class="fu">#### Base maps</span></span>
<span id="cb20-1028"><a href="#cb20-1028"></a></span>
<span id="cb20-1029"><a href="#cb20-1029"></a><span class="in">```{r base_map_quiz}</span></span>
<span id="cb20-1030"><a href="#cb20-1030"></a><span class="in">#| echo: false</span></span>
<span id="cb20-1031"><a href="#cb20-1031"></a></span>
<span id="cb20-1032"><a href="#cb20-1032"></a><span class="in">base_map_quiz1 &lt;- c(</span></span>
<span id="cb20-1033"><a href="#cb20-1033"></a><span class="in">  "To provide information about socio-economic conditions in different places.",</span></span>
<span id="cb20-1034"><a href="#cb20-1034"></a><span class="in">  answer = "To provide context on the locations of concentrations of crime.",</span></span>
<span id="cb20-1035"><a href="#cb20-1035"></a><span class="in">  "To stop the map from appearing too visually cluttered",</span></span>
<span id="cb20-1036"><a href="#cb20-1036"></a><span class="in">  "To make a map more visually attractive."</span></span>
<span id="cb20-1037"><a href="#cb20-1037"></a><span class="in">)</span></span>
<span id="cb20-1038"><a href="#cb20-1038"></a></span>
<span id="cb20-1039"><a href="#cb20-1039"></a><span class="in">base_map_quiz2 &lt;- c(</span></span>
<span id="cb20-1040"><a href="#cb20-1040"></a><span class="in">  "`ggplot2`", </span></span>
<span id="cb20-1041"><a href="#cb20-1041"></a><span class="in">  "`ggmap`", </span></span>
<span id="cb20-1042"><a href="#cb20-1042"></a><span class="in">  answer = "`ggspatial`", </span></span>
<span id="cb20-1043"><a href="#cb20-1043"></a><span class="in">  "`sfhotspot`"</span></span>
<span id="cb20-1044"><a href="#cb20-1044"></a><span class="in">)</span></span>
<span id="cb20-1045"><a href="#cb20-1045"></a></span>
<span id="cb20-1046"><a href="#cb20-1046"></a><span class="in">base_map_quiz3 &lt;- c(</span></span>
<span id="cb20-1047"><a href="#cb20-1047"></a><span class="in">  answer = "To ensure that it does not distract from the crime data.",</span></span>
<span id="cb20-1048"><a href="#cb20-1048"></a><span class="in">  "To fit the base map to the full extent of the dataset.",</span></span>
<span id="cb20-1049"><a href="#cb20-1049"></a><span class="in">  "To remove all geographic details and focus only on crime locations.",</span></span>
<span id="cb20-1050"><a href="#cb20-1050"></a><span class="in">  "To add unnecessary elements to the map."</span></span>
<span id="cb20-1051"><a href="#cb20-1051"></a><span class="in">)</span></span>
<span id="cb20-1052"><a href="#cb20-1052"></a><span class="in">```</span></span>
<span id="cb20-1053"><a href="#cb20-1053"></a></span>
<span id="cb20-1054"><a href="#cb20-1054"></a></span>
<span id="cb20-1055"><a href="#cb20-1055"></a>**What is the purpose of adding a base map to a crime map in R?**</span>
<span id="cb20-1056"><a href="#cb20-1056"></a></span>
<span id="cb20-1057"><a href="#cb20-1057"></a><span class="in">`r webexercises::longmcq(base_map_quiz1)`</span></span>
<span id="cb20-1058"><a href="#cb20-1058"></a></span>
<span id="cb20-1059"><a href="#cb20-1059"></a></span>
<span id="cb20-1060"><a href="#cb20-1060"></a>**Which R package is commonly used for adding base maps to crime maps?**</span>
<span id="cb20-1061"><a href="#cb20-1061"></a></span>
<span id="cb20-1062"><a href="#cb20-1062"></a><span class="in">`r webexercises::longmcq(base_map_quiz2)`</span></span>
<span id="cb20-1063"><a href="#cb20-1063"></a></span>
<span id="cb20-1064"><a href="#cb20-1064"></a></span>
<span id="cb20-1065"><a href="#cb20-1065"></a>**Why might you need to be careful in choosing the right base map when creating a crime map?**</span>
<span id="cb20-1066"><a href="#cb20-1066"></a></span>
<span id="cb20-1067"><a href="#cb20-1067"></a><span class="in">`r webexercises::longmcq(base_map_quiz3)`</span></span>
<span id="cb20-1068"><a href="#cb20-1068"></a></span>
<span id="cb20-1069"><a href="#cb20-1069"></a></span>
<span id="cb20-1070"><a href="#cb20-1070"></a>:::</span>
<span id="cb20-1071"><a href="#cb20-1071"></a></span>
<span id="cb20-1072"><a href="#cb20-1072"></a></span>
<span id="cb20-1073"><a href="#cb20-1073"></a></span>
<span id="cb20-1074"><a href="#cb20-1074"></a><span class="fu">## Adding more layers {#sec-other-layers}</span></span>
<span id="cb20-1075"><a href="#cb20-1075"></a></span>
<span id="cb20-1076"><a href="#cb20-1076"></a>&lt;img src="../images/pancakes.jpg" alt="a stack of pancakes" class="right-side-image"&gt;</span>
<span id="cb20-1077"><a href="#cb20-1077"></a></span>
<span id="cb20-1078"><a href="#cb20-1078"></a>Adding a base map underneath our density layer makes it easier to understand where in Vancouver the highest densities of bike theft are. But our map could make it easier still to see where clusters of thefts occur. We could, for example, add the names of different neighbourhoods in the city, and show the city limits so that we can tell which areas have no crime because crimes in those areas are not included in our data.</span>
<span id="cb20-1079"><a href="#cb20-1079"></a></span>
<span id="cb20-1080"><a href="#cb20-1080"></a>In an earlier section I suggested we can think of ggplot charts, including maps, as being like stacks of pancakes -- each function we use to amend the appearance of our chart is added to the top of the stack. So to add another layer to our map, we just add another <span class="in">`geom_`</span> function to our plot.</span>
<span id="cb20-1081"><a href="#cb20-1081"></a></span>
<span id="cb20-1082"><a href="#cb20-1082"></a>&lt;a href="https://stringr.tidyverse.org/" title="stringr website"&gt;&lt;img src="../images/stringr.png" style="width: 33%; max-width: 150px; float: right; margin: 0 0 2em 2em;"&gt;&lt;/a&gt;</span>
<span id="cb20-1083"><a href="#cb20-1083"></a></span>
<span id="cb20-1084"><a href="#cb20-1084"></a>At the same time, we can also add labels to the plot at the centre of each neighbourhood using the <span class="in">`geom_sf_label()`</span> function. <span class="in">`geom_sf_label()`</span> works like <span class="in">`geom_sf()`</span> in that it adds a spatial dataset to a map, but instead of adding the points, lines or polygons themselves, <span class="in">`geom_sf_label()`</span> instead adds labels for those features. </span>
<span id="cb20-1085"><a href="#cb20-1085"></a></span>
<span id="cb20-1086"><a href="#cb20-1086"></a>We use the <span class="in">`aes()`</span> function to specify which column in the <span class="in">`vancouver_nbhds`</span> dataset we want to use for the label text. If we used <span class="in">`head(vancouver_nbhds)`</span> to look at the columns in the data, we would see the neighbourhood names are contained in the column called <span class="in">`name`</span>. Normally, we would use the code <span class="in">`aes(label = name)`</span> to do this because the label aesthetic is used to set the label text. But in this case we also want to wrap the labels so that they don't overlap adjacent neighbourhoods. To do this we can use the <span class="in">`str_wrap()`</span> from the <span class="co">[</span><span class="ot">stringr package</span><span class="co">](https://stringr.tidyverse.org)</span> (part of the tidyverse), so that instead our call to the <span class="in">`aes()`</span> function becomes <span class="in">`aes(label = str_wrap(name, width = 10))`</span>.</span>
<span id="cb20-1087"><a href="#cb20-1087"></a></span>
<span id="cb20-1088"><a href="#cb20-1088"></a>To see how <span class="in">`geom_sf_label()`</span> works, let's create a quick map in the R Console. Paste the following code into the Console and run it:</span>
<span id="cb20-1089"><a href="#cb20-1089"></a></span>
<span id="cb20-1092"><a href="#cb20-1092"></a><span class="in">```{r}</span></span>
<span id="cb20-1093"><a href="#cb20-1093"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb20-1094"><a href="#cb20-1094"></a></span>
<span id="cb20-1095"><a href="#cb20-1095"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-1096"><a href="#cb20-1096"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> vancouver_nbhds) <span class="sc">+</span></span>
<span id="cb20-1097"><a href="#cb20-1097"></a>  <span class="fu">geom_sf_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="at">width =</span> <span class="dv">10</span>)), <span class="at">data =</span> vancouver_nbhds)</span>
<span id="cb20-1098"><a href="#cb20-1098"></a><span class="in">```</span></span>
<span id="cb20-1099"><a href="#cb20-1099"></a></span>
<span id="cb20-1100"><a href="#cb20-1100"></a>Now let's add these labels to the map in our script file. At the same time we will change the style of the labels so that they look better on the map. Do do this, we will add several more arguments to <span class="in">`geom_sf_label()`</span>:</span>
<span id="cb20-1101"><a href="#cb20-1101"></a></span>
<span id="cb20-1102"><a href="#cb20-1102"></a><span class="ss">  * </span><span class="in">`alpha = 0.5`</span> to make the label background semi-transparent so that we can</span>
<span id="cb20-1103"><a href="#cb20-1103"></a>    see the density layer underneath it,</span>
<span id="cb20-1104"><a href="#cb20-1104"></a><span class="ss">  * </span><span class="in">`colour = "seagreen3"`</span> to slightly reduce the prominence of the label text </span>
<span id="cb20-1105"><a href="#cb20-1105"></a>    to avoid distracting attention from the density layer,</span>
<span id="cb20-1106"><a href="#cb20-1106"></a><span class="ss">  * </span><span class="in">`lineheight = 1`</span> to reduce the gap between lines in each label,</span>
<span id="cb20-1107"><a href="#cb20-1107"></a><span class="ss">  * </span><span class="in">`size = 2.5`</span> to slightly reduce the size of the label text,</span>
<span id="cb20-1108"><a href="#cb20-1108"></a><span class="ss">  * </span><span class="in">`label.size = NA`</span> to remove the default border around the label background.</span>
<span id="cb20-1109"><a href="#cb20-1109"></a></span>
<span id="cb20-1110"><a href="#cb20-1110"></a>Replace the existing <span class="in">`ggplot()`</span> stack in the <span class="in">`chapter_06.R`</span> file with this stack and then run that code:</span>
<span id="cb20-1111"><a href="#cb20-1111"></a></span>
<span id="cb20-1114"><a href="#cb20-1114"></a><span class="in">```{r}</span></span>
<span id="cb20-1115"><a href="#cb20-1115"></a><span class="co">#| filename: "chapter_06.R"</span></span>
<span id="cb20-1116"><a href="#cb20-1116"></a></span>
<span id="cb20-1117"><a href="#cb20-1117"></a><span class="co"># Plot density map</span></span>
<span id="cb20-1118"><a href="#cb20-1118"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-1119"><a href="#cb20-1119"></a>  <span class="co"># Add base map</span></span>
<span id="cb20-1120"><a href="#cb20-1120"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb20-1121"><a href="#cb20-1121"></a>  <span class="co"># Add density layer</span></span>
<span id="cb20-1122"><a href="#cb20-1122"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb20-1123"><a href="#cb20-1123"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb20-1124"><a href="#cb20-1124"></a>    <span class="at">data =</span> bike_theft_density_clip, </span>
<span id="cb20-1125"><a href="#cb20-1125"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>, </span>
<span id="cb20-1126"><a href="#cb20-1126"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb20-1127"><a href="#cb20-1127"></a>  ) <span class="sc">+</span></span>
<span id="cb20-1128"><a href="#cb20-1128"></a>  <span class="co"># Add neighbourhood boundaries</span></span>
<span id="cb20-1129"><a href="#cb20-1129"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> vancouver_nbhds, <span class="at">colour =</span> <span class="st">"seagreen3"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb20-1130"><a href="#cb20-1130"></a>  <span class="co"># Add neighbourhood names</span></span>
<span id="cb20-1131"><a href="#cb20-1131"></a>  <span class="fu">geom_sf_label</span>(</span>
<span id="cb20-1132"><a href="#cb20-1132"></a>    <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">10</span>)), </span>
<span id="cb20-1133"><a href="#cb20-1133"></a>    <span class="at">data =</span> vancouver_nbhds, </span>
<span id="cb20-1134"><a href="#cb20-1134"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb20-1135"><a href="#cb20-1135"></a>    <span class="at">colour =</span> <span class="st">"seagreen"</span>, </span>
<span id="cb20-1136"><a href="#cb20-1136"></a>    <span class="at">lineheight =</span> <span class="dv">1</span>, </span>
<span id="cb20-1137"><a href="#cb20-1137"></a>    <span class="at">size =</span> <span class="fl">2.5</span>,</span>
<span id="cb20-1138"><a href="#cb20-1138"></a>    <span class="at">label.size =</span> <span class="cn">NA</span></span>
<span id="cb20-1139"><a href="#cb20-1139"></a>  ) <span class="sc">+</span></span>
<span id="cb20-1140"><a href="#cb20-1140"></a>  <span class="co"># Set the colour scale</span></span>
<span id="cb20-1141"><a href="#cb20-1141"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">direction =</span> <span class="dv">1</span>)</span>
<span id="cb20-1142"><a href="#cb20-1142"></a><span class="in">```</span></span>
<span id="cb20-1143"><a href="#cb20-1143"></a></span>
<span id="cb20-1144"><a href="#cb20-1144"></a>From this map, we can see that bike theft in Vancouver is heavily concentrated in a handful of neighbourhoods, particularly the Downtown and West End neighbourhoods. This map is much more useful than the first map that we produced in @sec-second-map showing only the point location of each crime, since in this latest map we can see not only the greatest concentrations of bike thefts but how they relate to the different areas of the city. </span>
<span id="cb20-1145"><a href="#cb20-1145"></a></span>
<span id="cb20-1146"><a href="#cb20-1146"></a></span>
<span id="cb20-1147"><a href="#cb20-1147"></a><span class="fu">## In summary</span></span>
<span id="cb20-1148"><a href="#cb20-1148"></a></span>
<span id="cb20-1149"><a href="#cb20-1149"></a>In this chapter we have learned to produce a density map of crime. This type of map can be very useful in identifying where practitioners should focus efforts to respond to crime. For example, a map like this might help local police to decide where to send officers to carry out extra patrols, while a crime-prevention charity might decide to run events in particular areas to educate people on how best to protect their bikes.</span>
<span id="cb20-1150"><a href="#cb20-1150"></a></span>
<span id="cb20-1151"><a href="#cb20-1151"></a>Now that we have learned all the code for this chapter, your code file should look like this:</span>
<span id="cb20-1152"><a href="#cb20-1152"></a></span>
<span id="cb20-1155"><a href="#cb20-1155"></a><span class="in">```{r}</span></span>
<span id="cb20-1156"><a href="#cb20-1156"></a><span class="co">#| eval: false</span></span>
<span id="cb20-1157"><a href="#cb20-1157"></a><span class="co">#| filename: "chapter_06.R"</span></span>
<span id="cb20-1158"><a href="#cb20-1158"></a></span>
<span id="cb20-1159"><a href="#cb20-1159"></a><span class="co"># Load packages</span></span>
<span id="cb20-1160"><a href="#cb20-1160"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, sfhotspot, tidyverse)</span>
<span id="cb20-1161"><a href="#cb20-1161"></a></span>
<span id="cb20-1162"><a href="#cb20-1162"></a><span class="co"># Load and wrangle bike theft data</span></span>
<span id="cb20-1163"><a href="#cb20-1163"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1164"><a href="#cb20-1164"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-1165"><a href="#cb20-1165"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-1166"><a href="#cb20-1166"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span>
<span id="cb20-1167"><a href="#cb20-1167"></a></span>
<span id="cb20-1168"><a href="#cb20-1168"></a><span class="co"># Load Vancouver neighbourhood boundaries</span></span>
<span id="cb20-1169"><a href="#cb20-1169"></a>vancouver_nbhds <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_neighbourhoods.geojson"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-1170"><a href="#cb20-1170"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:32610"</span>)</span>
<span id="cb20-1171"><a href="#cb20-1171"></a></span>
<span id="cb20-1172"><a href="#cb20-1172"></a><span class="co"># Estimate density of bike thefts and clip result</span></span>
<span id="cb20-1173"><a href="#cb20-1173"></a>bike_theft_density_clip <span class="ot">&lt;-</span> bike_thefts <span class="sc">|&gt;</span> </span>
<span id="cb20-1174"><a href="#cb20-1174"></a>  <span class="fu">hotspot_kde</span>(<span class="at">bandwidth_adjust =</span> <span class="fl">0.5</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-1175"><a href="#cb20-1175"></a>  <span class="fu">st_intersection</span>(vancouver_nbhds)</span>
<span id="cb20-1176"><a href="#cb20-1176"></a></span>
<span id="cb20-1177"><a href="#cb20-1177"></a><span class="co"># Plot density map</span></span>
<span id="cb20-1178"><a href="#cb20-1178"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-1179"><a href="#cb20-1179"></a>  <span class="co"># Add base map</span></span>
<span id="cb20-1180"><a href="#cb20-1180"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb20-1181"><a href="#cb20-1181"></a>  <span class="co"># Add density layer</span></span>
<span id="cb20-1182"><a href="#cb20-1182"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb20-1183"><a href="#cb20-1183"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb20-1184"><a href="#cb20-1184"></a>    <span class="at">data =</span> bike_theft_density_clip, </span>
<span id="cb20-1185"><a href="#cb20-1185"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>, </span>
<span id="cb20-1186"><a href="#cb20-1186"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb20-1187"><a href="#cb20-1187"></a>  ) <span class="sc">+</span></span>
<span id="cb20-1188"><a href="#cb20-1188"></a>  <span class="co"># Add neighbourhood boundaries</span></span>
<span id="cb20-1189"><a href="#cb20-1189"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> vancouver_nbhds, <span class="at">colour =</span> <span class="st">"seagreen3"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb20-1190"><a href="#cb20-1190"></a>  <span class="co"># Add neighbourhood names</span></span>
<span id="cb20-1191"><a href="#cb20-1191"></a>  <span class="fu">geom_sf_label</span>(</span>
<span id="cb20-1192"><a href="#cb20-1192"></a>    <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">10</span>)), </span>
<span id="cb20-1193"><a href="#cb20-1193"></a>    <span class="at">data =</span> vancouver_nbhds, </span>
<span id="cb20-1194"><a href="#cb20-1194"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb20-1195"><a href="#cb20-1195"></a>    <span class="at">colour =</span> <span class="st">"seagreen"</span>, </span>
<span id="cb20-1196"><a href="#cb20-1196"></a>    <span class="at">lineheight =</span> <span class="dv">1</span>, </span>
<span id="cb20-1197"><a href="#cb20-1197"></a>    <span class="at">size =</span> <span class="fl">2.5</span>,</span>
<span id="cb20-1198"><a href="#cb20-1198"></a>    <span class="at">label.size =</span> <span class="cn">NA</span></span>
<span id="cb20-1199"><a href="#cb20-1199"></a>  ) <span class="sc">+</span></span>
<span id="cb20-1200"><a href="#cb20-1200"></a>  <span class="co"># Set the colour scale</span></span>
<span id="cb20-1201"><a href="#cb20-1201"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">direction =</span> <span class="dv">1</span>)</span>
<span id="cb20-1202"><a href="#cb20-1202"></a><span class="in">```</span></span>
<span id="cb20-1203"><a href="#cb20-1203"></a></span>
<span id="cb20-1206"><a href="#cb20-1206"></a><span class="in">```{r}</span></span>
<span id="cb20-1207"><a href="#cb20-1207"></a><span class="co">#| echo: false</span></span>
<span id="cb20-1208"><a href="#cb20-1208"></a></span>
<span id="cb20-1209"><a href="#cb20-1209"></a><span class="co"># Load packages</span></span>
<span id="cb20-1210"><a href="#cb20-1210"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, sfhotspot, tidyverse)</span>
<span id="cb20-1211"><a href="#cb20-1211"></a></span>
<span id="cb20-1212"><a href="#cb20-1212"></a><span class="co"># Load and wrangle bike theft data</span></span>
<span id="cb20-1213"><a href="#cb20-1213"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1214"><a href="#cb20-1214"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-1215"><a href="#cb20-1215"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-1216"><a href="#cb20-1216"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span>
<span id="cb20-1217"><a href="#cb20-1217"></a></span>
<span id="cb20-1218"><a href="#cb20-1218"></a><span class="co"># Load Vancouver neighbourhood boundaries</span></span>
<span id="cb20-1219"><a href="#cb20-1219"></a>vancouver_nbhds <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_neighbourhoods.geojson"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-1220"><a href="#cb20-1220"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:32610"</span>)</span>
<span id="cb20-1221"><a href="#cb20-1221"></a></span>
<span id="cb20-1222"><a href="#cb20-1222"></a><span class="co"># Estimate density of bike thefts and clip result</span></span>
<span id="cb20-1223"><a href="#cb20-1223"></a>bike_theft_density_clip <span class="ot">&lt;-</span> bike_thefts <span class="sc">|&gt;</span> </span>
<span id="cb20-1224"><a href="#cb20-1224"></a>  <span class="fu">hotspot_kde</span>(<span class="at">bandwidth_adjust =</span> <span class="fl">0.5</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-1225"><a href="#cb20-1225"></a>  <span class="fu">st_intersection</span>(vancouver_nbhds)</span>
<span id="cb20-1226"><a href="#cb20-1226"></a></span>
<span id="cb20-1227"><a href="#cb20-1227"></a><span class="co"># Plot density map</span></span>
<span id="cb20-1228"><a href="#cb20-1228"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-1229"><a href="#cb20-1229"></a>  <span class="co"># Add base map</span></span>
<span id="cb20-1230"><a href="#cb20-1230"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb20-1231"><a href="#cb20-1231"></a>  <span class="co"># Add density layer</span></span>
<span id="cb20-1232"><a href="#cb20-1232"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb20-1233"><a href="#cb20-1233"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb20-1234"><a href="#cb20-1234"></a>    <span class="at">data =</span> bike_theft_density_clip, </span>
<span id="cb20-1235"><a href="#cb20-1235"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>, </span>
<span id="cb20-1236"><a href="#cb20-1236"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb20-1237"><a href="#cb20-1237"></a>  ) <span class="sc">+</span></span>
<span id="cb20-1238"><a href="#cb20-1238"></a>  <span class="co"># Add neighbourhood boundaries</span></span>
<span id="cb20-1239"><a href="#cb20-1239"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> vancouver_nbhds, <span class="at">colour =</span> <span class="st">"seagreen3"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb20-1240"><a href="#cb20-1240"></a>  <span class="co"># Add neighbourhood names</span></span>
<span id="cb20-1241"><a href="#cb20-1241"></a>  <span class="fu">geom_sf_label</span>(</span>
<span id="cb20-1242"><a href="#cb20-1242"></a>    <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_wrap</span>(name, <span class="dv">10</span>)), </span>
<span id="cb20-1243"><a href="#cb20-1243"></a>    <span class="at">data =</span> vancouver_nbhds, </span>
<span id="cb20-1244"><a href="#cb20-1244"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb20-1245"><a href="#cb20-1245"></a>    <span class="at">colour =</span> <span class="st">"seagreen"</span>, </span>
<span id="cb20-1246"><a href="#cb20-1246"></a>    <span class="at">lineheight =</span> <span class="dv">1</span>, </span>
<span id="cb20-1247"><a href="#cb20-1247"></a>    <span class="at">size =</span> <span class="fl">2.5</span>,</span>
<span id="cb20-1248"><a href="#cb20-1248"></a>    <span class="at">label.size =</span> <span class="cn">NA</span></span>
<span id="cb20-1249"><a href="#cb20-1249"></a>  ) <span class="sc">+</span></span>
<span id="cb20-1250"><a href="#cb20-1250"></a>  <span class="co"># Set the colour scale</span></span>
<span id="cb20-1251"><a href="#cb20-1251"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">direction =</span> <span class="dv">1</span>)</span>
<span id="cb20-1252"><a href="#cb20-1252"></a><span class="in">```</span></span>
<span id="cb20-1253"><a href="#cb20-1253"></a></span>
<span id="cb20-1254"><a href="#cb20-1254"></a>As you read through this code, you might notice that it's easier to understand than it otherwise might be because:</span>
<span id="cb20-1255"><a href="#cb20-1255"></a></span>
<span id="cb20-1256"><a href="#cb20-1256"></a><span class="ss">1. </span>The code is in a logical order: it starts with loading the necessary packages and data, then wrangles that data and finally produces the map.</span>
<span id="cb20-1257"><a href="#cb20-1257"></a><span class="ss">2. </span>The code includes _only_ the permanent code needed to produce the final map, not any temporary code that we needed to produce the permanent code. If you aren't sure about the distinction between permanent and temporary code, look back at @sec-permanent-code.</span>
<span id="cb20-1258"><a href="#cb20-1258"></a><span class="ss">3. </span>Each part of the code is annotated with a comment: a line that starts <span class="in">`# `</span> and explains what the following block of code does.</span>
<span id="cb20-1259"><a href="#cb20-1259"></a></span>
<span id="cb20-1260"><a href="#cb20-1260"></a>Save the <span class="in">`chapter_06.R`</span> file, then restart R to start a new session by clicking on the <span class="in">`Session`</span> menu and then clicking <span class="in">`Restart R`</span>. This creates a blank canvas for the next chapter.</span>
<span id="cb20-1261"><a href="#cb20-1261"></a></span>
<span id="cb20-1262"><a href="#cb20-1262"></a>::: {.callout-tip}</span>
<span id="cb20-1263"><a href="#cb20-1263"></a></span>
<span id="cb20-1264"><a href="#cb20-1264"></a><span class="fu">#### Tips for producing effective density maps</span></span>
<span id="cb20-1265"><a href="#cb20-1265"></a></span>
<span id="cb20-1266"><a href="#cb20-1266"></a><span class="ss">* </span>Density layers on maps (e.g. a layer added using <span class="in">`geom_sf()`</span> to display the result produced by <span class="in">`hotspot_kde()`</span>) should be made semi-transparent so that readers can see the base map underneath. If a density layer is not semi-transparent then it is likely to be very difficult for readers to see exactly where areas of high density are in the real world. Try setting the argument <span class="in">`alpha = 0.7`</span> in the call to the <span class="in">`geom_sf()`</span> function, then change that value until you are happy with the visibility of both the density layer and the base map underneath.</span>
<span id="cb20-1267"><a href="#cb20-1267"></a><span class="ss">* </span>Density layers should almost always only show a single type of crime -- avoid calculating a single KDE layer based on data that includes more than one type of crime. There are two problems with combining data for multiple crime types to produce a single density layer. First, different crimes often concentrate in different places, so a combined map might end up showing concentrations inaccurately. Second, since the KDE process is based on the number of points, a density layer produced by combining data for multiple crimes will inevitably be more influenced by whichever crime type is more numerous. Since more minor crimes tend to be more common, this could mean that your density map points people towards areas with lots of minor crimes and away from places where more-serious crimes happen.</span>
<span id="cb20-1268"><a href="#cb20-1268"></a><span class="ss">* </span>Avoid mapping 'intangible' crimes. These are crimes that are only ever recorded by police when officers happen to identify a crime while on patrol, rather than the crime usually being reported by the victim or a third-party. You should avoid mapping these types of crime because they generally reflect geographic concentrations of police patrol more than geographic concentrations of the crimes themselves. The most common intangible offences are drugs possession and weapons possession, which are detected incidentally by officers on patrol much more than they are reported to the police by the public.</span>
<span id="cb20-1269"><a href="#cb20-1269"></a>:::</span>
<span id="cb20-1270"><a href="#cb20-1270"></a></span>
<span id="cb20-1271"><a href="#cb20-1271"></a></span>
<span id="cb20-1272"><a href="#cb20-1272"></a>::: {.callout-quiz .callout}</span>
<span id="cb20-1273"><a href="#cb20-1273"></a><span class="fu">### Revision questions {.unnumbered}</span></span>
<span id="cb20-1274"><a href="#cb20-1274"></a></span>
<span id="cb20-1275"><a href="#cb20-1275"></a>Answer these questions to check you have understood the main points covered in this chapter. Write between 50 and 100 words to answer each question.</span>
<span id="cb20-1276"><a href="#cb20-1276"></a></span>
<span id="cb20-1277"><a href="#cb20-1277"></a><span class="ss">1. </span>What is kernel density estimation (KDE), and why is it useful for mapping crime patterns? Explain the process briefly.</span>
<span id="cb20-1278"><a href="#cb20-1278"></a><span class="ss">2. </span>Why are density maps often more effective than point maps for visualizing crime patterns? Provide an example to illustrate your answer.</span>
<span id="cb20-1279"><a href="#cb20-1279"></a><span class="ss">3. </span>What are the main factors to consider when adjusting the cell size and bandwidth for a KDE map? How can these adjustments affect the map's appearance and usefulness?</span>
<span id="cb20-1280"><a href="#cb20-1280"></a><span class="ss">4. </span>Why is it important to clip density maps to the boundary of the area being analysed? Describe the steps required to achieve this in R.</span>
<span id="cb20-1281"><a href="#cb20-1281"></a><span class="ss">5. </span>How does the choice of colour scale affect the interpretation of density maps? Provide an example of when to use sequential, diverging, and categorical colour schemes.</span>
<span id="cb20-1282"><a href="#cb20-1282"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by/4.0/">
<p>This book is available under a Creative Commons Attribution 4.0 International licence</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>