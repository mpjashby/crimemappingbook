<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Your second crime map – Learn Crime Mapping with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../05_code_with_style/index.html" rel="next">
<link href="../03_data_wrangling/index.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<!-- START OF INCLUDED HEADER -->

<!--
This file contains code that will be included in the header of each page of the
quarto book
-->

<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>

<!-- END OF INCLUDED HEADER -->


<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../include/webex.css">
<meta name="twitter:title" content="4&nbsp; Your second crime map – Learn Crime Mapping with R">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="../images/cover_image.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../04_your_second_crime_map/index.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Your second crime map</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/cover_image.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Learn Crime Mapping with R</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/mpjashby/crimemappingbook/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../learn_crime_mapping_with_r.epub" title="Download ePub" class="quarto-navigation-tool px-1" aria-label="Download ePub"><i class="bi bi-journal"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install the software needed for this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_getting_started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_your_first_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Your first crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_data_wrangling/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_your_second_crime_map/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Your second crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_code_with_style/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Code with style</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_mapping_crime_patterns/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping crime patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_map_context/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Giving a map context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_handling_bugs/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Handling bugs in your code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_mapping_areas/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Mapping area data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../10_place_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../11_mapping_hotspots/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../12_messy_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../13_crime_series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Mapping crime series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../14_writing_reports/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Writing reports in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../15_no_maps/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Presenting spatial data without maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../16_mapping_time/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Mapping crime over time</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/read_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Functions for reading data into R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/map_checklist.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Checklist: Making a good crime map</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/common_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Common R errors and how to fix them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/functions_to_avoid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Some R functions you should avoid</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/handling_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Checklist: handling code errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">In this chapter</h2>
   
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">4.1</span> Introduction</a></li>
  <li><a href="#handling-spatial-data" id="toc-handling-spatial-data" class="nav-link" data-scroll-target="#handling-spatial-data"><span class="header-section-number">4.2</span> Handling spatial data</a></li>
  <li><a href="#spatial-data-in-r" id="toc-spatial-data-in-r" class="nav-link" data-scroll-target="#spatial-data-in-r"><span class="header-section-number">4.3</span> Spatial data in R</a></li>
  <li><a href="#producing-maps-in-r" id="toc-producing-maps-in-r" class="nav-link" data-scroll-target="#producing-maps-in-r"><span class="header-section-number">4.4</span> Producing maps in R</a></li>
  <li><a href="#in-summary" id="toc-in-summary" class="nav-link" data-scroll-target="#in-summary"><span class="header-section-number">4.5</span> In summary</a></li>
  </ul>
<div class="toc-actions"><ul class="collapse"><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-second-map" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Your second crime map</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="abstract">
<p>This chapter guides you through the process of creating a crime map in R, focusing on each step in detail. You will learn how to work with spatial data, including how to load data and convert it into a format suitable for mapping. By the end of this chapter you’ll be able to visualize crime data effectively, creating a clear and accurate map. Let’s dive into the process and start mapping!</p>
</div>
<section id="introduction" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">4.1</span> Introduction</h2>
<p>In <a href="../02_your_first_crime_map/index.html" class="quarto-xref"><span>Chapter 2</span></a> we produced a simple map of a particular type of crime in a neighbourhood, but we skipped over a lot of the details of how to do it. In this chapter we will make another crime map, this time focusing more on each step in the process. We will then build on this in <a href="../06_mapping_crime_patterns/index.html" class="quarto-xref"><span>Chapter 6</span></a> to make a better crime map.</p>
<p>In this chapter (and <a href="../06_mapping_crime_patterns/index.html" class="quarto-xref"><span>Chapter 6</span></a>) we will make a map of bicycle thefts in Vancouver in 2020. At the end of <a href="../06_mapping_crime_patterns/index.html" class="quarto-xref"><span>Chapter 6</span></a>, the final map will look something like this.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/vancouver_bike_thefts.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<p>Before we get into the detail of how to make this map, watch this video that goes over the main points of the code we will use. This video covers the code for both this chapter and <a href="../06_mapping_crime_patterns/index.html" class="quarto-xref"><span>Chapter 6</span></a>.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/apKeAbHuNFo" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
</section>
<section id="handling-spatial-data" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="handling-spatial-data"><span class="header-section-number">4.2</span> Handling spatial data</h2>
<p>Maps are visual representations of spatial data. Spatial data is special because each row in the data is associated with some geographic feature such as a building, a street or the boundary of a neighbourhood. This adds some quirks that we have to understand to work with spatial data successfully.</p>
<p>Maps are made up of multiple layers of spatial data that are styled to represent features of interest and then stacked on top of one another to make the finished map. Watch this video to learn more about spatial layers and the different types of data that we can use in maps.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/fr0CPO9Ot9Q" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Quiz
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Which of the following best describes the three ways computers store spatial features?</strong></p>
<div id="radio_WGBLLQKPMB" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_WGBLLQKPMB" value=""> <span>Points, polygons, and events</span></label><label><input type="radio" autocomplete="off" name="radio_WGBLLQKPMB" value="answer"> <span>Points, lines, and polygons</span></label><label><input type="radio" autocomplete="off" name="radio_WGBLLQKPMB" value=""> <span>Layers, rasters, and vectors</span></label><label><input type="radio" autocomplete="off" name="radio_WGBLLQKPMB" value=""> <span>Features, base maps, and grid cells</span></label>
</div>
<p><strong>What is the purpose of a base map in mapping?</strong></p>
<div id="radio_EZKKPDWNYU" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_EZKKPDWNYU" value=""> <span>To provide a single layer showing all features on a map</span></label><label><input type="radio" autocomplete="off" name="radio_EZKKPDWNYU" value=""> <span>To allow individual access to points, lines, and polygons</span></label><label><input type="radio" autocomplete="off" name="radio_EZKKPDWNYU" value=""> <span>To replace all other map layers</span></label><label><input type="radio" autocomplete="off" name="radio_EZKKPDWNYU" value="answer"> <span>To simplify data by combining and styling different features</span></label>
</div>
<p><strong>What happens when too much detail is included on a map?</strong></p>
<div id="radio_MDZBAYOYSM" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_MDZBAYOYSM" value=""> <span>The map becomes easier to interpret</span></label><label><input type="radio" autocomplete="off" name="radio_MDZBAYOYSM" value=""> <span>The map’s layers automatically simplify</span></label><label><input type="radio" autocomplete="off" name="radio_MDZBAYOYSM" value="answer"> <span>The data becomes harder to work with and visualize effectively</span></label><label><input type="radio" autocomplete="off" name="radio_MDZBAYOYSM" value=""> <span>The map’s scale adjusts to include all details</span></label>
</div>
<p><strong>What is a raster layer?</strong></p>
<div id="radio_RBFXMKQROC" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_RBFXMKQROC" value=""> <span>A dataset storing only lines and polygons</span></label><label><input type="radio" autocomplete="off" name="radio_RBFXMKQROC" value="answer"> <span>A grid of cells that simplifies data by representing features with single values</span></label><label><input type="radio" autocomplete="off" name="radio_RBFXMKQROC" value=""> <span>A detailed layer that preserves all original data</span></label><label><input type="radio" autocomplete="off" name="radio_RBFXMKQROC" value=""> <span>A stack of feature layers</span></label>
</div>
<p><strong>Why is it common to store data about different types of features in separate files?</strong></p>
<div id="radio_PCNXAQURAK" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_PCNXAQURAK" value=""> <span>Most files cannot handle large amounts of data</span></label><label><input type="radio" autocomplete="off" name="radio_PCNXAQURAK" value=""> <span>It is easier to create maps with fewer data files</span></label><label><input type="radio" autocomplete="off" name="radio_PCNXAQURAK" value="answer"> <span>In most spatial data formats, each file is limited to storing points, lines, or polygons, not all three</span></label><label><input type="radio" autocomplete="off" name="radio_PCNXAQURAK" value=""> <span>Storing all features in one file makes maps less detailed</span></label>
</div>
</div>
</div>
<p>Points, lines and polygons in spatial data are known as <em>geometric objects</em> or simply <em>geometries</em>. Spatial data is data that has a geometric object (e.g.&nbsp;a pair of co-ordinates representing a crime location) associated with each row.</p>
<section id="representing-places-on-the-earth" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="representing-places-on-the-earth"><span class="header-section-number">4.2.1</span> Representing places on the earth</h3>
<p>With any spatial data, we need a way of describing where on the earth a particular point (such as the location of a crime or the corner of a building) is located. Watch this video to find out about the different co-ordinate systems we can use to do this.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/8L6EXiuckLo" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Quiz
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>What are co-ordinates used for?</strong></p>
<div id="radio_YJAPJTVPCR" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_YJAPJTVPCR" value=""> <span>To measure the distance between two locations</span></label><label><input type="radio" autocomplete="off" name="radio_YJAPJTVPCR" value="answer"> <span>To specify a location on the Earth’s surface relative to a reference point</span></label><label><input type="radio" autocomplete="off" name="radio_YJAPJTVPCR" value=""> <span>To calculate the area of a geographic region</span></label><label><input type="radio" autocomplete="off" name="radio_YJAPJTVPCR" value=""> <span>To determine the altitude of a point on the Earth</span></label>
</div>
<p><strong>What is the geographic co-ordinate system based on?</strong></p>
<div id="radio_KAUXFNKKTQ" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_KAUXFNKKTQ" value=""> <span>Latitude and altitude</span></label><label><input type="radio" autocomplete="off" name="radio_KAUXFNKKTQ" value=""> <span>Longitude and elevation</span></label><label><input type="radio" autocomplete="off" name="radio_KAUXFNKKTQ" value=""> <span>Latitude and grid distances</span></label><label><input type="radio" autocomplete="off" name="radio_KAUXFNKKTQ" value="answer"> <span>Latitude and longitude</span></label>
</div>
<p><strong>Why are degrees of latitude and longitude difficult to use for everyday measurements?</strong></p>
<div id="radio_QCVGBHUNGB" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_QCVGBHUNGB" value=""> <span>They are too small to measure accurately</span></label><label><input type="radio" autocomplete="off" name="radio_QCVGBHUNGB" value=""> <span>They are not precise enough for spatial analysis</span></label><label><input type="radio" autocomplete="off" name="radio_QCVGBHUNGB" value="answer"> <span>They do not correspond to easily understandable units like metres</span></label><label><input type="radio" autocomplete="off" name="radio_QCVGBHUNGB" value=""> <span>They only work in polar regions</span></label>
</div>
<p><strong>What can happen if you use a co-ordinate system designed for a different part of the globe?</strong></p>
<div id="radio_IORTVRYWNG" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_IORTVRYWNG" value="answer"> <span>The map may have errors or show distorted features</span></label><label><input type="radio" autocomplete="off" name="radio_IORTVRYWNG" value=""> <span>The map will automatically adjust to the correct region</span></label><label><input type="radio" autocomplete="off" name="radio_IORTVRYWNG" value=""> <span>The dataset will not load</span></label><label><input type="radio" autocomplete="off" name="radio_IORTVRYWNG" value=""> <span>The co-ordinates will convert to the nearest global standard</span></label>
</div>
<p><strong>What is a practical way to find out which co-ordinate system a dataset uses if it’s not embedded in the file?</strong></p>
<div id="radio_NBNKVJBOUF" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_NBNKVJBOUF" value=""> <span>Guess based on the region it represents</span></label><label><input type="radio" autocomplete="off" name="radio_NBNKVJBOUF" value=""> <span>Check the size of the dataset file</span></label><label><input type="radio" autocomplete="off" name="radio_NBNKVJBOUF" value="answer"> <span>Ask the person or organization that provided the data</span></label><label><input type="radio" autocomplete="off" name="radio_NBNKVJBOUF" value=""> <span>Compare it with another dataset from a different region</span></label>
</div>
</div>
</div>
</section>
</section>
<section id="spatial-data-in-r" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="spatial-data-in-r"><span class="header-section-number">4.3</span> Spatial data in R</h2>
<p class="full-width-image">
<img src="../images/sf.jpg" alt="Abstract images of furry monsters moving pieces of maps around">
</p>
<p>There are several packages that handle raster map data from different sources – one of them is the <a href="https://paleolimbot.github.io/ggspatial/">ggspatial package</a> that we have already used to load the base map of Atlanta for the homicide map we made in <a href="../02_your_first_crime_map/index.html" class="quarto-xref"><span>Chapter 2</span></a>.</p>
<p><a href="https://r-spatial.github.io/sf/" title="sf website"><img src="../images/sf-package.gif" class="right-side-image"></a></p>
<p>Vector data can be handled in R using functions from the <a href="https://r-spatial.github.io/sf/">sf package</a>. SF stands for ‘simple features’, which is a standard for storing spatial data. SF objects are data frames that have a special column to hold the geometry (point, line or polygon) associated with each row in the data. SF objects also understand what co-ordinate system the geometry are described in. This means SF objects can be transformed between co-ordinate systems and combined together in layers on a map.</p>
<p>There a lots of functions in the sf package for handling spatial data. Almost all of these functions begin with the letters <code>st_</code> (e.g.&nbsp;<code>st_read()</code>), which makes it easy to identify that those functions are designed to be used on SF objects.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Functions in the sf package start with the letters <code>st_</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>The names of almost all functions in the sf package start with the letters <code>st_</code>, <em>not</em> the letters <code>sf_</code>.</p>
</div>
</div>
<section id="reading-spatial-data" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="reading-spatial-data"><span class="header-section-number">4.3.1</span> Reading spatial data</h3>
<p>To get started, open a blank R script file (using <code>File &gt; New File &gt; R Script</code>), then save it with the name <code>chapter_04.R</code>. Now add the code needed to load the sf and tidyverse packages:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_04.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Load packages</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, sfhotspot, tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The special features of spatial data – needing to store geometries, details of the projection used etc. – mean that spatial data is often stored in special file formats. There are lots of spatial-data formats, but fortunately almost all of them can be read by the <code>st_read()</code> function. This means we do not need to learn a different function for each spatial-data format.</p>
<p>While datasets with line or polygon geometries must almost always be stored in specific spatial-data formats, point data can also be stored in common data formats such as Excel and <abbr title="comma-separated values">CSV</abbr> files. The <a href="https://geodash.vpd.ca/opendata/">data for this chapter</a> is provided by the Vancouver Police Department in a CSV file (gzipped to reduce the file size). The file is located at:</p>
<pre data-code-line-numbers=""><code>https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz</code></pre>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What does the <code>.gz</code> at the end of this URL mean?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>CSV files can hold very large amounts of data, but at the cost of the size of the file becoming very large. We can reduce the size of a CSV file (or most other types of file) by compressing the file. You may be familiar with <code>.zip</code> compressed files. <a href="https://en.wikipedia.org/wiki/Gzip">Gzip</a> is another way of compressing files. Gzipped files have the file extension <code>.gz</code>. <code>read_csv()</code> can automatically decompress gzipped files, so we can treat a gzipped CSV file just the same as an uncompressed CSV file.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Loading data from a CSV file
</div>
</div>
<div class="callout-body-container callout-body">
<p>Thinking back to what we learned in <a href="../03_data_wrangling/index.html#sec-read-data" class="quarto-xref"><span>Section 3.2</span></a>, add a new line of code to the file <code>chapter_04.R</code> to load this dataset and store it in an object called <code>thefts</code>. If you need help, you can click the ‘Solution’ button below.</p>
<div class="webex-solution">
<button>
Solution
</button>
<p>Since the data are stored in a regular CSV file, we can use the <code>read_csv()</code> function from the readr package to read the file, and the assignment operator <code>&lt;-</code> to store the data in the object <code>thefts</code>. <code>read_csv()</code> can read directly from a URL, so there is no need to download the data first.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_04.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Viewing the first few rows of a dataset
</div>
</div>
<div class="callout-body-container callout-body">
<p>Now that you have stored the data in the <code>thefts</code> object, what code is needed to view the first few rows of data? Type the code into the R Console and press <code>Enter</code>/<code>Return</code> to run it. Click the ‘Solution’ button to check your code.</p>
<div class="webex-solution">
<button>
Solution
</button>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb4" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">head</span>(thefts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="reading-data-files-from-your-computer" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="reading-data-files-from-your-computer"><span class="header-section-number">4.3.2</span> Reading data files from your computer</h3>
<p>The data consists of 21,918 rows, each representing one theft. Before we can map this data, we will need to do some minor data wrangling to get it into the format we want.</p>
<p>So far we have created datasets by loading data directly from URLs, such as the URL for the Vancouver thefts data we loaded in the previous section. But we can also load datasets that are already stored on our own computers. To do this, we need to know the <em>file path</em> that specifies where a particular file is stored.</p>
<p>You might have encountered file paths before, but you may not. A typical file path looks like this on a Mac or Linux computer:</p>
<pre data-code-line-numbers=""><code>/Users/john_smith/Documents/Crime Mapping/vancouver_thefts.csv</code></pre>
<p>or like this on Windows:</p>
<pre data-code-line-numbers=""><code>C:\Users\john_smith\Documents\Crime Mapping\vancouver_thefts.csv</code></pre>
<p>The important thing to note here is that computers store files such as <code>vancouver_thefts.csv</code> in folders (also called directories), which are themselves often stored inside larger folders, etc. A file path tells a computer where to find a particular file. The file paths above can be read as telling the computer to open the <code>Users</code> directory, then the <code>john_smith</code> directory, then the <code>Documents</code> directory, then the <code>Crime Mapping</code> directory, and finally the file <code>vancouver_thefts.csv</code>.</p>
<p>You can find the file path of a particular file by typing <code>file.choose()</code> in the R console. This will open a new window that allows you to search or browse for a particular file. When you choose the file, R will print the file path in the console.</p>
<p>The two file paths shown above are called <em>absolute</em> file paths, because they show the full location of a particular file on the computer. But there are two problems with absolute paths: they can be very long so they clutter up your code, and (more importantly) they are only correct for a specific computer. If you write an R script that includes either of the file paths above, then you give that file for me to run, the code will immediately produce an error because there is no directory <code>/Users/john_smith</code> on my computer.</p>
<p>We can deal with that problem in a few ways. The first is to use a <em>relative path</em>. This specifies the location of a file not on the computer as a whole, but relative to the directory we are currently working in. This <em>working directory</em> will depend on how your version of RStudio is configured, but you can find out the working directory by typing <code>getwd()</code> in the R console. This will print the absolute path of the working directory for whatever you are currently working on in RStudio.</p>
<p>Imagine our working directory is <code>/Users/john_smith/Documents/Crime Mapping/</code>. If we wanted to open the file <code>/Users/john_smith/Documents/Crime Mapping/vancouver_thefts.csv</code>, we could use the absolute file path:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">read_csv</span>(<span class="st">"/Users/john_smith/Documents/Crime Mapping/vancouver_thefts.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, since the file is stored in our current working directory, we could also open the file like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">read_csv</span>(<span class="st">"vancouver_thefts.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This works because when we provide a relative path (e.g.&nbsp;one that does not begin with <code>/</code> on Mac or <code>C:\</code> on Windows), R treats the path as being relative to the current working directory. Since the file <code>vancouver_thefts.csv</code> is in the working directory, we don’t need to specify anything other than the file name.</p>
<p>If we wanted to read from a file that was in a directory <em>within</em> the working directory – e.g.&nbsp;<code>/Users/john_smith/Documents/Crime Mapping/original_data/canada/vancouver_crime.gpkg</code> – then we just need to specify where the file is relative to the working directory:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">read_sf</span>(<span class="st">"original_data/canada/vancouver_crime.gpkg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>File paths in your code can make it harder to make sure your code is <em>portable</em>, i.e.&nbsp;that it can be used by other people. This is because the file structure on someone else’s computer is likely to be different from the file structure on your computer.</p>
<p>You might think code portability doesn’t matter, because you are not planning to share your code with anyone. But it’s quite possible that you will want to:</p>
<ul>
<li>Re-use code yourself on a different computer, e.g.&nbsp;if you replace your current computer with a new one.</li>
<li>Send the code to someone else to get help with a problem.</li>
<li>Send the code to someone else who has asked for help from you.</li>
</ul>
<p>To help keep your code portable:</p>
<ul>
<li>Where possible, include in your code any code needed to download the necessary data from the internet. This is what we most-often do in this course.</li>
<li>If the data is not available online, you will need to distribute the data along with your code. In that case, tell anyone you send you code to that they should keep the code file and data files in the same directory, then you can just refer to each data file by its name (e.g.&nbsp;<code>read_csv("vancouver_thefts.csv")</code>).</li>
<li>Avoid using absolute file paths in your code, since these will almost certainly produce an error if anyone tries to run your code on another computer.</li>
</ul>
</div>
</div>
</section>
<section id="cleaning-column-names" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="cleaning-column-names"><span class="header-section-number">4.3.3</span> Cleaning column names</h3>
<p class="full-width-image">
<img src="../images/janitor_clean_names.jpg" alt="Cartoon showing a beaver feeding variables with messy names into a machine marked 'clean_names()' that has consistent variable names coming out of the other side.">
</p>
<p>Typos are one of the most frequent causes of errors in any coding language. One way to avoid typos is to follow some basic rules when we write code. We will learn more about these rules in <a href="../05_code_with_style/index.html" class="quarto-xref"><span>Chapter 5</span></a>, but for now we can just learn one rule: column names in datasets should use what is known as <code>snake_case</code>, i.e.&nbsp;they should be all lower case and words should be separated by underscore characters (<code>_</code>). This makes your code easier to read and means you don’t have to remember whether you called a column <code>crime_count</code>, <code>crimecount</code>, <code>CrimeCount</code> or <code>CRIMECOUNT</code>.</p>
<p><a href="http://sfirke.github.io/janitor/" title="janitor package website"><img src="../images/janitor.png" class="right-side-image"></a></p>
<p>At the moment, the column names in the <code>thefts</code> dataset are upper-case letters. Rather than having to remember this, we can easily convert them to snake case using the <code>clean_names()</code> function from the <a href="http://sfirke.github.io/janitor/">janitor package</a>. To use a function from a package, we usually first load the package using the <code>pacman::p_load()</code> function. In this case, we probably won’t want to use any other functions from the <code>janitor</code> package, so instead of loading the whole package we will use this one function directly. To do this, we write the function name with the package name added to the front, separated by two colons <code>::</code>.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_04.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb10" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>thefts <span class="ot">&lt;-</span> janitor<span class="sc">::</span><span class="fu">clean_names</span>(thefts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Add the code above to the <code>chapter_04.R</code> file and run that line of code. If you now run <code>head(thefts)</code> in the R Console, you will see that the data has stayed the same but all the column names are now in snake case. <code>clean_names()</code> would also have replaced any spaces with underscores, tried to separate words in the variable names and cleaned up several other potential problems. For this reason it is common to call <code>janitor::clean_names()</code> straight away after loading a dataset so that you can be confident that the column names will be in the format you expect.</p>
<p>If we wanted to use the <code>clean_names()</code> function again, we would have to include the package name and <code>::</code> each time, so if our code was going to make repeated use of the function then it would probably be easier to load the package using the <code>pacman::p_load()</code> function as we have done in previous chapters.</p>
</section>
<section id="converting-our-data-to-an-sf-object" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4" class="anchored" data-anchor-id="converting-our-data-to-an-sf-object"><span class="header-section-number">4.3.4</span> Converting our data to an SF object</h3>
<p>At present, the data in the <code>thefts</code> object is just a regular tibble. We could not use it to make a map because R does not know which columns represent the geometry, or what co-ordinate system the locations are recorded in. We can deal with this by converting the data to an SF object using the <code>st_as_sf()</code> function from the <code>sf</code> package.</p>
<p>The data provided by the Vancouver Police use the UTM zone 10N co-ordinate system. <abbr title="Universal Transverse Mercator">UTM</abbr> is a system for assigning co-ordinates to any location on earth relative to a designated local reference point for the UTM zone covering that part of the planet. The ‘N’ at the end of the zone name 10N refers to the northern hemisphere.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Co-ordinate reference systems are specific to one part of the globe
</div>
</div>
<div class="callout-body-container callout-body">
<p>In almost all cases, co-ordinate reference systems only work for the part of the world that they were designed for. So we should not use the UTM zone 10N co-ordinate system to map data outside the area for which it was designed (broadly speaking, the west coast of North America from Los Angeles to Vancouver, and the part of Canada directly north of Vancouver extending as far as the north pole). If we were to use the UTM zone 10N co-ordinate system for data from another part of the world, we would be very likely to get error messages or strange results.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/utm_vancouver.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can convert the <code>thefts</code> tibble to an SF object using the <code>st_as_sf()</code> function (remember, all functions in the <code>sf</code> package start with <code>st_</code>, which can sometimes make the function names a little confusing). We specify which columns in the data represent the geometry (in this case, the <code>x</code> and <code>y</code> columns), and what co-ordinate system the data uses.</p>
<p>Co-ordinate systems can be specified in lots of ways (some very complicated), but the easiest is to specify the <abbr title="European Petroleum Survey Group">EPSG</abbr> code for the relevant system. An EPSG code is a unique reference number for a particular co-ordinate system that R can look up in a database to get the information needed to display the data on a map. The EPSG code for the UTM zone 10N is <code>EPSG:32610</code>.</p>
<p>Add this code to the <code>chapter_04.R</code> file in RStudio.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_04.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb11" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>thefts_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(thefts, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>If you look at the contents of the <code>thefts_sf</code> object by running <code>head(thefts_sf)</code> in the R Console, you’ll see that there is a new column called <code>geometry</code>. This column contains the co-ordinates of each bike theft. But crucially, it stores those co-ordinates in a format that R recognises represent specific locations on the surface of the earth, which means the co-ordinates can be used to make maps.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is important to remember that we should only use <code>st_as_sf()</code> to convert a <em>non-spatial</em> dataset (such as a tibble) into a spatial dataset (an SF object). If we use <code>st_as_sf()</code> on an object that is already an SF object, this can have unexpected results and lead to errors in your code.</p>
<p>The easy way to think about this is that if you have loaded a dataset with <code>read_sf()</code> or <code>st_read()</code> then you have already created an SF object, so you don’t need <code>st_as_sf()</code>. If you have loaded a dataset with any other function that reads data (such as <code>read_csv()</code> or <code>read_excel()</code>) then you will need to use <code>st_as_sf()</code> if you want to plot the data on a map. Most importantly, do not use <code>st_as_sf()</code> if you loaded a dataset with <code>read_sf()</code> or <code>st_read()</code>.</p>
</div>
</div>
</section>
<section id="finding-bike-thefts-in-our-data" class="level3" data-number="4.3.5">
<h3 data-number="4.3.5" class="anchored" data-anchor-id="finding-bike-thefts-in-our-data"><span class="header-section-number">4.3.5</span> Finding bike thefts in our data</h3>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Choosing only some rows in a dataset
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you look through the contents of the <code>thefts_sf</code> object by running <code>head(thefts_sf)</code> in the R Console, you will see that not all of the rows relate to bicycle thefts. The <code>type</code> column shows that the dataset also includes thefts from vehicles, for example. To choose only those rows containing bicycle thefts, which function from the <code>dplyr</code> package would we used? If you need help, you can think back to <a href="../03_data_wrangling/index.html" class="quarto-xref"><span>Chapter 3</span></a> or have a look at the <a href="https://rstudio.github.io/cheatsheets/html/data-transformation.html">Data transformation with dplyr cheat sheet</a>.</p>
<p><strong>Which function from the <code>dplyr</code> package should we use to remove all the rows from our dataset except those for bicycle thefts?</strong></p>
<div id="radio_DHQTAMKVVI" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_DHQTAMKVVI" value=""> <span><code>select()</code></span></label><label><input type="radio" autocomplete="off" name="radio_DHQTAMKVVI" value="answer"> <span><code>filter()</code></span></label><label><input type="radio" autocomplete="off" name="radio_DHQTAMKVVI" value=""> <span><code>mutate()</code></span></label><label><input type="radio" autocomplete="off" name="radio_DHQTAMKVVI" value=""> <span><code>summarise()</code></span></label>
</div>
<p>Add code to the <code>chapter_04.R</code> file to create a new object called <code>bike_thefts</code> that contains only the rows in the <code>thefts_sf</code> object that relate to bicycle theft. If you get stuck, you can hit the ‘Hint’ button below to get help, but try to find the answer on your own first! Once you’ve finished the code, click the ‘Solution’ button to check your code.</p>
<div class="webex-solution">
<button>
Hint
</button>
<p>Use the <code>filter()</code> function to choose particular rows in a dataset. The syntax for <code>filter()</code> is <code>filter(dataset, column_name == "value")</code>. Replace <code>dataset</code> with the name of the SF object we created from the <code>thefts</code> tibble, <code>column_name</code> with the name of the column containing the offence type and <code>value</code> with the offence type for bicycle theft.</p>
</div>
<div class="webex-solution">
<button>
Solution
</button>
<p>The correct code to store only bicycle thefts in a new object is:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_04.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb12" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">filter</span>(thefts_sf, type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
<p>Our data is now ready for us to make our crime map!</p>
<p>So far in this chapter we have used several functions – <code>read_csv()</code>, <code>clean_names()</code>, <code>st_as_sf()</code> and <code>filter()</code> to produce an SF object representing the locations of bike thefts. Since we have done this step by step, we have created a different object to store the result produced by each function. But since we only need the final dataset, our code would be a lot easier to read if we used the pipe operator (<code>|&gt;</code>) to run all these functions in one go. Delete the relevant lines from the <code>chapter_04.R</code> script file and replace them with this code:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_04.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb13" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># Load packages</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, sfhotspot, tidyverse)</span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co"># Load and wrangle bike theft data</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
</section>
<section id="producing-maps-in-r" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="producing-maps-in-r"><span class="header-section-number">4.4</span> Producing maps in R</h2>
<p>Now that we have our data, we can use it to create a map of bicycle theft in Vancouver. Before we start, let’s take another look at our dataset so that we know which columns contain which data.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb14" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">head</span>(bike_thefts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 6 features and 8 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 488371.3 ymin: 5452696 xmax: 494295.1 ymax: 5458232
Projected CRS: WGS 84 / UTM zone 10N
# A tibble: 6 × 9
  type              year month   day  hour minute hundred_block    neighbourhood
  &lt;chr&gt;            &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;            &lt;chr&gt;        
1 Theft of Bicycle  2020     1     1     0      0 12XX VENABLES ST Strathcona   
2 Theft of Bicycle  2020     1     1     0      0 20XX MAPLE ST    Kitsilano    
3 Theft of Bicycle  2020     1     1    13      0 7XX PACIFIC BLVD Central Busi…
4 Theft of Bicycle  2020     1     1    20      0 53XX VINE ST     Arbutus Ridge
5 Theft of Bicycle  2020     1     3    11     55 65XX ANGUS DR    Kerrisdale   
6 Theft of Bicycle  2020     1     3    14      0 4XX E 10TH AVE   Mount Pleasa…
# ℹ 1 more variable: geometry &lt;POINT [m]&gt;</code></pre>
</div>
</div>
<section id="introduction-to-ggplot2" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="introduction-to-ggplot2"><span class="header-section-number">4.4.1</span> Introduction to ggplot2</h3>
<p class="full-width-image">
<img src="../images/ggplot2_masterpiece.jpg" alt="Cartoon showing several furry monsters with paint brushes painting several different types of chart. Above them is the text 'ggplot2: build a data masterpiece'.">
</p>
<p>A map is a specialised type of chart, so we can make maps using the <a href="https://ggplot2.tidyverse.org/">ggplot2 package</a> that is widely used to create other types of chart in R. ggplot2 charts are made up of layers, so they’re well suited to making maps.</p>
<p><a href="https://ggplot2.tidyverse.org/" title="ggplot2 website"><img src="../images/ggplot2.png" style="width: 33%; max-width: 150px; float: right; margin: 0 0 2em 2em;"></a></p>
<p>The most-basic crime map that we can make simply plots the locations of crimes with no context. However, this almost never makes a <em>good</em> crime map because if there are more than a few crimes it becomes hard to see patterns in the data. But we can use a basic dot map as the foundation on which we can build a better map later on.</p>
<p>ggplot2 plots work by building up a chart using different functions, each of which adds or modifies some part of the chart. Building a plot starts with calling the <code>ggplot()</code> function, with each subsequent function being added to the plot definition using the <code>+</code> operator. Note that while the package is called ggplot2, the function in that package used to create plots is called <code>ggplot()</code>, <em>not</em> <code>ggplot2()</code>.</p>
<p>The most-important of the ggplot2 functions are those beginning with <code>geom_</code>, which add graphical elements to the chart. If you want to add a layer to your chart showing a scatter plot, you use the <code>geom_point()</code> function, while if you want to make a line chart you use <code>geom_line()</code>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/example-charts-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<p>There are lots of <code>geom_</code> functions available for representing data on charts in different ways. For maps, we can use the <code>geom_sf()</code> function that is designed to add spatial data (in the form of an SF object such as our <code>bike_thefts</code> data) to a chart, making it into a map. So to simply plot the points in our bicycle-theft data, we can use the code:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb16" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_thefts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>geom_sf()</code> only works with SF objects
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>geom_sf()</code> only works on SF objects, which is why we needed to convert the original tibble of data to an SF object using <code>st_as_sf()</code>. If you try to use <code>geom_sf()</code> on a dataset that is not stored as an SF object, R will produce an error.</p>
</div>
</div>
<p>By convention, each function that we add to <code>ggplot()</code> to change the appearance of our map goes on a new line (this makes the code easier to read) and all but the first line is indented by two spaces. RStudio does this indenting automatically if the previous line ends with a <code>+</code> symbol, since RStudio then understands that there is more code to come on the next line.</p>
<p>The map above shows the bike-theft data, but it is obviously not a very useful map. Fortunately, we can use the features of the ggplot2 package to build on this basic map.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Avoid dot maps
</div>
</div>
<div class="callout-body-container callout-body">
<p>Unless we want to produce a map of only a very small number of crimes (like the Atlanta downtown homicides map we produced in <a href="../02_your_first_crime_map/index.html" class="quarto-xref"><span>Chapter 2</span></a>), it is unlikely that a point map will be very useful.</p>
<p>In fact, <strong>if you find yourself making map with each crime represented by a separate point, you should probably stop and ask yourself if that is really the best way to achieve your goal</strong> – it will almost always be better to map the data in another way.</p>
</div>
</div>
</section>
<section id="controlling-aesthetics" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="controlling-aesthetics"><span class="header-section-number">4.4.2</span> Controlling aesthetics</h3>
<p>We can change the appearance of the points by specifying various arguments to the <code>geom_sf()</code> function. These arguments are called <em>aesthetics</em>, because they control the aesthetic appearance of the geometric objects (points, lines etc.) that are produced by a <code>geom_</code> function. There are lots of aesthetics, but some of the most common are:</p>
<ul>
<li><code>colour</code> controls the colour of points and lines (for polygons, it controls the colour of the border around the polygon edge) – you can also use the spelling <code>color</code> for this argument and get an identical result,</li>
<li><code>fill</code> controls the colour used to fill polygons or points that use a shape capable of having different colours in the centre and around the edge (<code>fill</code> has no meaning for lines),</li>
<li><code>shape</code> controls the shape (circle, triangle, square etc.) of points (it has no meaning for lines or polygons),</li>
<li><code>size</code> controls the size of points and text,</li>
<li><code>linewidth</code> controls the width of lines, including the borders around the edges of polygons, and</li>
<li><code>alpha</code> controls the transparency of a layer (<code>alpha = 1</code> equals fully opaque, <code>alpha = 0</code> means fully transparent).</li>
</ul>
<p><code>colour</code> and <code>fill</code> can be specified using <a href="http://bc.bojanorama.pl/wp-content/uploads/2013/04/rcolorsheet.pdf">any one of 657 R colour names</a> or using a <a href="https://htmlcolorcodes.com/#color-codes">hexidecimal (‘hex’) colour code</a>. Values of <code>size</code> don’t relate to any unit of size (e.g.&nbsp;millimetres or points), so it’s easiest to set the size of points and text by trial and error.</p>
<p>There are 25 built-in shapes for points in R (shape 16 is the default):</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<p>We use aesthetics such as <code>colour</code>, <code>fill</code>, etc. to change the appearance of layers on a map by adding the aesthetic as an argument to the <code>geom_*()</code> function that creates the relevant layer. For example, we could change the points on our map to be red squares rather than the default black circles using this code:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb17" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_thefts, <span class="at">shape =</span> <span class="dv">15</span>, <span class="at">colour =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As we have said, this basic map is not very useful. We can see that there seems to be a cluster of bike thefts towards the top (north) of the map, but it is difficult to see how important this cluster is because so many of the points overlap. Overlapping points are a particular problem in maps, because if there are multiple crimes at the same location then the points representing those crimes will be exactly on top of one another and it will be impossible to see whether there is one crime at a particular location or 100.</p>
<p>One way to deal with this problem is to make the points semi-transparent so that overlapping points appear darker. This often works better if we also make the points slightly smaller at the same time. We can use the <code>alpha</code> and <code>size</code> aesthetics to make the points smaller (relative to the default for points of <code>size = 1</code>) and semi-transparent.</p>
<p>Add this code to your script file:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_04.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb18" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># Create a basic crime map</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_thefts, <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Making the points semi-transparent goes some way to making it easier to see where bike theft is most common in Vancouver, but the pattern is not clear and it is not possible to tell which darker points represent a handful of crimes at the same location and which represent hundreds of crimes at the same location.</p>
<p>To make our map truly useful, we need to use a different technique. In chapter <a href="../06_mapping_crime_patterns/index.html" class="quarto-xref"><span>Chapter 6</span></a> we will learn how to identify crime patterns by mapping the <em>density</em> of crime.</p>
<p>Save the <code>chapter_04.R</code> file, then restart R to start a new session by clicking on the <code>Session</code> menu and then clicking <code>Restart R</code>. This creates a blank canvas for the next chapter.</p>
</section>
</section>
<section id="in-summary" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="in-summary"><span class="header-section-number">4.5</span> In summary</h2>
<p>In this chapter we have learned more about each specific step in the process of creating a basic crime map. Concepts such as co-ordinate reference systems and EPSG codes can be hard to understand at first, but you will get used to them as you use them to make more maps, so that by the end of this book you will be confident applying those ideas in a wide range of contexts.</p>
<p>At the moment, your script file should look like this.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter_04.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb19" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># Load packages</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, sfhotspot, tidyverse)</span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="co"># Load and wrangle bike theft data</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb19-7"><a href="#cb19-7"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-8"><a href="#cb19-8"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span>
<span id="cb19-9"><a href="#cb19-9"></a></span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="co"># Create a basic crime map</span></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb19-12"><a href="#cb19-12"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_thefts, <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>At the moment, it isn’t very easy to see patterns on this map, since so many of the points overlap. In <a href="../06_mapping_crime_patterns/index.html" class="quarto-xref"><span>Chapter 6</span></a>, we will learn how to make this map much better by converting it into a density map.</p>
<p>Remember: whenever you create a dot map, ask yourself if a density map would be more useful.</p>
</div>
</div>
<div class="box reading">
<p>You can find out more about some of the things we have covered in this chapter using these resources:</p>
<ul>
<li>Understand more about the history of trying to develop accurate map projections in this short video: <a href="https://youtu.be/kIID5FDi2JQ">Why all world maps are wrong</a>.</li>
<li>Find out more about making all sorts of charts (not just maps) with the <code>ggplot2</code> package in the <a href="https://r4ds.hadley.nz/data-visualize.html">Data Visualisation chapter of <em>R for Data Science</em></a> by Hadley Wickham and Garrett Grolemund.</li>
<li>Learn more about making maps using simple features in <a href="https://r-spatial.org/book/01-hello.html">Chapter 1 of <em>Spatial Data Science</em></a> by Edzer Pebesma and Roger Bivand.</li>
</ul>
</div>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Revision questions
</div>
</div>
<div class="callout-body-container callout-body">
<p>Answer these questions to check you have understood the main points covered in this chapter. Write between 50 and 100 words to answer each question.</p>
<ol type="1">
<li>What is spatial data, and how does it differ from other types of data? Provide examples of spatial features commonly used in crime mapping.</li>
<li>Explain the role of coordinate systems in mapping. Why is it important to use the correct coordinate system for a specific dataset?</li>
<li>Discuss the challenges of using file paths in R scripts and how relative file paths improve code portability.</li>
<li>Why is it helpful to use the pipe operator (<code>|&gt;</code> in R) when working with multiple functions? Provide an example from the chapter.</li>
<li>Explain how the <code>select()</code> function in dplyr is used to manage columns in a dataset. How can it help when working with large spatial datasets?</li>
</ol>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";
  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    btn.onclick = check_func;
    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../03_data_wrangling/index.html" class="pagination-link" aria-label="Wrangling data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../05_code_with_style/index.html" class="pagination-link" aria-label="Code with style">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Code with style</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb20" data-shortcodes="false" data-code-line-numbers=""><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu"># Your second crime map {#sec-second-map}</span></span>
<span id="cb20-2"><a href="#cb20-2"></a></span>
<span id="cb20-3"><a href="#cb20-3"></a>::: {.abstract}</span>
<span id="cb20-4"><a href="#cb20-4"></a>This chapter guides you through the process of creating a crime map in R, focusing on each step in detail. You will learn how to work with spatial data, including how to load data and convert it into a format suitable for mapping. By the end of this chapter you'll be able to visualize crime data effectively, creating a clear and accurate map. Let's dive into the process and start mapping!</span>
<span id="cb20-5"><a href="#cb20-5"></a>:::</span>
<span id="cb20-6"><a href="#cb20-6"></a></span>
<span id="cb20-7"><a href="#cb20-7"></a></span>
<span id="cb20-8"><a href="#cb20-8"></a></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="in">```{r setup}</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="in">#| echo: false</span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="in">#| include: false</span></span>
<span id="cb20-12"><a href="#cb20-12"></a></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="in"># Load packages</span></span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="in">pacman::p_load(ggspatial, patchwork, sf, tidyverse)</span></span>
<span id="cb20-15"><a href="#cb20-15"></a></span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="in"># Load data</span></span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="in">thefts &lt;- janitor::clean_names(read_csv("https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"))</span></span>
<span id="cb20-18"><a href="#cb20-18"></a><span class="in">thefts_sf &lt;- st_as_sf(thefts, coords = c("x", "y"), crs = 32610, remove = FALSE)</span></span>
<span id="cb20-19"><a href="#cb20-19"></a><span class="in">bike_thefts &lt;- filter(thefts_sf, type == "Theft of Bicycle")</span></span>
<span id="cb20-20"><a href="#cb20-20"></a><span class="in">```</span></span>
<span id="cb20-21"><a href="#cb20-21"></a></span>
<span id="cb20-22"><a href="#cb20-22"></a></span>
<span id="cb20-23"><a href="#cb20-23"></a></span>
<span id="cb20-24"><a href="#cb20-24"></a><span class="fu">## Introduction</span></span>
<span id="cb20-25"><a href="#cb20-25"></a></span>
<span id="cb20-26"><a href="#cb20-26"></a>In @sec-first-map we produced a simple map of a particular type of crime in a neighbourhood, but we skipped over a lot of the details of how to do it. In this chapter we will make another crime map, this time focusing more on each step in the process. We will then build on this in @sec-mapping-patterns to make a better crime map.</span>
<span id="cb20-27"><a href="#cb20-27"></a></span>
<span id="cb20-28"><a href="#cb20-28"></a>In this chapter (and @sec-mapping-patterns) we will make a map of bicycle thefts in Vancouver in 2020. At the end of @sec-mapping-patterns, the final map will look something like this.</span>
<span id="cb20-29"><a href="#cb20-29"></a></span>
<span id="cb20-30"><a href="#cb20-30"></a><span class="in">```{r make-final-map}</span></span>
<span id="cb20-31"><a href="#cb20-31"></a><span class="in">#| eval: false</span></span>
<span id="cb20-32"><a href="#cb20-32"></a><span class="in">#| echo: false</span></span>
<span id="cb20-33"><a href="#cb20-33"></a></span>
<span id="cb20-34"><a href="#cb20-34"></a><span class="in"># THIS CODE DOES NOT RUN BY DEFAULT, SINCE LEARNR SOMETIMES RUNS THE CODE EVEN</span></span>
<span id="cb20-35"><a href="#cb20-35"></a><span class="in"># WHEN THE FILE ALREADY EXISTS, AND THE FILE WILL ALWAYS EXIST WHEN THE TUTORIAL</span></span>
<span id="cb20-36"><a href="#cb20-36"></a><span class="in"># IS DEPLOYED. THE CODE IS JUST HERE FOR FUTURE REFERENCE IF NEEDED. </span></span>
<span id="cb20-37"><a href="#cb20-37"></a><span class="in"># </span></span>
<span id="cb20-38"><a href="#cb20-38"></a><span class="in"># IF YOU NEED TO RE-CREATE THE FILE, RUN THE CODE MANUALLY.</span></span>
<span id="cb20-39"><a href="#cb20-39"></a></span>
<span id="cb20-40"><a href="#cb20-40"></a><span class="in">bike_theft_density_bw_half_clipped &lt;- bike_thefts |&gt; </span></span>
<span id="cb20-41"><a href="#cb20-41"></a><span class="in">  hotspot_kde(bandwidth_adjust = 0.5, quiet = TRUE) |&gt; </span></span>
<span id="cb20-42"><a href="#cb20-42"></a><span class="in">  st_transform("EPSG:4326") |&gt; </span></span>
<span id="cb20-43"><a href="#cb20-43"></a><span class="in">  st_intersection(nbhds)</span></span>
<span id="cb20-44"><a href="#cb20-44"></a></span>
<span id="cb20-45"><a href="#cb20-45"></a><span class="in">vancouver_bike_thefts_map &lt;- ggplot() +</span></span>
<span id="cb20-46"><a href="#cb20-46"></a><span class="in">  annotation_map_tile(type = "cartolight", zoom = 13, progress = "none") +</span></span>
<span id="cb20-47"><a href="#cb20-47"></a><span class="in">  geom_sf(</span></span>
<span id="cb20-48"><a href="#cb20-48"></a><span class="in">    aes(fill = kde), </span></span>
<span id="cb20-49"><a href="#cb20-49"></a><span class="in">    data = bike_theft_density_bw_half_clipped, </span></span>
<span id="cb20-50"><a href="#cb20-50"></a><span class="in">    alpha = 0.67, </span></span>
<span id="cb20-51"><a href="#cb20-51"></a><span class="in">    colour = NA</span></span>
<span id="cb20-52"><a href="#cb20-52"></a><span class="in">  ) +</span></span>
<span id="cb20-53"><a href="#cb20-53"></a><span class="in">  geom_sf(data = nbhds, colour = "seagreen3", fill = NA) +</span></span>
<span id="cb20-54"><a href="#cb20-54"></a><span class="in">  geom_sf_label(</span></span>
<span id="cb20-55"><a href="#cb20-55"></a><span class="in">    aes(label = str_wrap(name, 10)), </span></span>
<span id="cb20-56"><a href="#cb20-56"></a><span class="in">    data = nbhds, </span></span>
<span id="cb20-57"><a href="#cb20-57"></a><span class="in">    alpha = 0.5,</span></span>
<span id="cb20-58"><a href="#cb20-58"></a><span class="in">    colour = "seagreen", </span></span>
<span id="cb20-59"><a href="#cb20-59"></a><span class="in">    lineheight = 1, </span></span>
<span id="cb20-60"><a href="#cb20-60"></a><span class="in">    size = 2.5,</span></span>
<span id="cb20-61"><a href="#cb20-61"></a><span class="in">    label.size = NA</span></span>
<span id="cb20-62"><a href="#cb20-62"></a><span class="in">  ) +</span></span>
<span id="cb20-63"><a href="#cb20-63"></a><span class="in">  scale_fill_distiller(direction = 1) +</span></span>
<span id="cb20-64"><a href="#cb20-64"></a><span class="in">  theme_void() +</span></span>
<span id="cb20-65"><a href="#cb20-65"></a><span class="in">  theme(</span></span>
<span id="cb20-66"><a href="#cb20-66"></a><span class="in">    legend.position = "none",</span></span>
<span id="cb20-67"><a href="#cb20-67"></a><span class="in">    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)</span></span>
<span id="cb20-68"><a href="#cb20-68"></a><span class="in">  )</span></span>
<span id="cb20-69"><a href="#cb20-69"></a></span>
<span id="cb20-70"><a href="#cb20-70"></a><span class="in"># Save the map</span></span>
<span id="cb20-71"><a href="#cb20-71"></a><span class="in">ggsave(</span></span>
<span id="cb20-72"><a href="#cb20-72"></a><span class="in">  here::here("images/vancouver_bike_thefts.jpg"), </span></span>
<span id="cb20-73"><a href="#cb20-73"></a><span class="in">  vancouver_bike_thefts_map,</span></span>
<span id="cb20-74"><a href="#cb20-74"></a><span class="in">  width = 800 / 150, </span></span>
<span id="cb20-75"><a href="#cb20-75"></a><span class="in">  dpi = 150</span></span>
<span id="cb20-76"><a href="#cb20-76"></a><span class="in">)</span></span>
<span id="cb20-77"><a href="#cb20-77"></a><span class="in">```</span></span>
<span id="cb20-78"><a href="#cb20-78"></a></span>
<span id="cb20-79"><a href="#cb20-79"></a><span class="in">```{r show-final-map}</span></span>
<span id="cb20-80"><a href="#cb20-80"></a><span class="in">#| echo: false</span></span>
<span id="cb20-81"><a href="#cb20-81"></a><span class="in">#| fig-align: center</span></span>
<span id="cb20-82"><a href="#cb20-82"></a><span class="in">#| out-width: 80%</span></span>
<span id="cb20-83"><a href="#cb20-83"></a></span>
<span id="cb20-84"><a href="#cb20-84"></a><span class="in">knitr::include_graphics(here::here("images/vancouver_bike_thefts.jpg"))</span></span>
<span id="cb20-85"><a href="#cb20-85"></a><span class="in">```</span></span>
<span id="cb20-86"><a href="#cb20-86"></a></span>
<span id="cb20-87"><a href="#cb20-87"></a></span>
<span id="cb20-88"><a href="#cb20-88"></a>Before we get into the detail of how to make this map, watch this video that goes over the main points of the code we will use. This video covers the code for both this chapter and @sec-mapping-patterns.</span>
<span id="cb20-89"><a href="#cb20-89"></a></span>
<span id="cb20-90"><a href="#cb20-90"></a>{{&lt; video https://youtu.be/apKeAbHuNFo &gt;}}</span>
<span id="cb20-91"><a href="#cb20-91"></a></span>
<span id="cb20-92"><a href="#cb20-92"></a></span>
<span id="cb20-93"><a href="#cb20-93"></a><span class="fu">## Handling spatial data</span></span>
<span id="cb20-94"><a href="#cb20-94"></a></span>
<span id="cb20-95"><a href="#cb20-95"></a>Maps are visual representations of spatial data. Spatial data is special because each row in the data is associated with some geographic feature such as a building, a street or the boundary of a neighbourhood. This adds some quirks that we have to understand to work with spatial data successfully.</span>
<span id="cb20-96"><a href="#cb20-96"></a></span>
<span id="cb20-97"><a href="#cb20-97"></a>Maps are made up of multiple layers of spatial data that are styled to represent features of interest and then stacked on top of one another to make the finished map. Watch this video to learn more about spatial layers and the different types of data that we can use in maps.</span>
<span id="cb20-98"><a href="#cb20-98"></a></span>
<span id="cb20-99"><a href="#cb20-99"></a>{{&lt; video https://youtu.be/fr0CPO9Ot9Q &gt;}}</span>
<span id="cb20-100"><a href="#cb20-100"></a></span>
<span id="cb20-101"><a href="#cb20-101"></a></span>
<span id="cb20-102"><a href="#cb20-102"></a>::: {.callout-quiz .callout}</span>
<span id="cb20-103"><a href="#cb20-103"></a></span>
<span id="cb20-104"><a href="#cb20-104"></a><span class="in">```{r spatial-data-quiz}</span></span>
<span id="cb20-105"><a href="#cb20-105"></a><span class="in">#| echo: false</span></span>
<span id="cb20-106"><a href="#cb20-106"></a></span>
<span id="cb20-107"><a href="#cb20-107"></a><span class="in">spatial_data_quiz1 &lt;- c(</span></span>
<span id="cb20-108"><a href="#cb20-108"></a><span class="in">  "Points, polygons, and events",</span></span>
<span id="cb20-109"><a href="#cb20-109"></a><span class="in">  answer = "Points, lines, and polygons",</span></span>
<span id="cb20-110"><a href="#cb20-110"></a><span class="in">  "Layers, rasters, and vectors",</span></span>
<span id="cb20-111"><a href="#cb20-111"></a><span class="in">  "Features, base maps, and grid cells"</span></span>
<span id="cb20-112"><a href="#cb20-112"></a><span class="in">)</span></span>
<span id="cb20-113"><a href="#cb20-113"></a></span>
<span id="cb20-114"><a href="#cb20-114"></a><span class="in">spatial_data_quiz2 &lt;- c(</span></span>
<span id="cb20-115"><a href="#cb20-115"></a><span class="in">  "To provide a single layer showing all features on a map",</span></span>
<span id="cb20-116"><a href="#cb20-116"></a><span class="in">  "To allow individual access to points, lines, and polygons",</span></span>
<span id="cb20-117"><a href="#cb20-117"></a><span class="in">  "To replace all other map layers",</span></span>
<span id="cb20-118"><a href="#cb20-118"></a><span class="in">  answer = "To simplify data by combining and styling different features"</span></span>
<span id="cb20-119"><a href="#cb20-119"></a><span class="in">)</span></span>
<span id="cb20-120"><a href="#cb20-120"></a></span>
<span id="cb20-121"><a href="#cb20-121"></a><span class="in">spatial_data_quiz3 &lt;- c(</span></span>
<span id="cb20-122"><a href="#cb20-122"></a><span class="in">  "The map becomes easier to interpret",</span></span>
<span id="cb20-123"><a href="#cb20-123"></a><span class="in">  "The map’s layers automatically simplify",</span></span>
<span id="cb20-124"><a href="#cb20-124"></a><span class="in">  answer = "The data becomes harder to work with and visualize effectively",</span></span>
<span id="cb20-125"><a href="#cb20-125"></a><span class="in">  "The map’s scale adjusts to include all details"</span></span>
<span id="cb20-126"><a href="#cb20-126"></a><span class="in">)</span></span>
<span id="cb20-127"><a href="#cb20-127"></a></span>
<span id="cb20-128"><a href="#cb20-128"></a><span class="in">spatial_data_quiz4 &lt;- c(</span></span>
<span id="cb20-129"><a href="#cb20-129"></a><span class="in">  "A dataset storing only lines and polygons",</span></span>
<span id="cb20-130"><a href="#cb20-130"></a><span class="in">  answer = "A grid of cells that simplifies data by representing features with single values",</span></span>
<span id="cb20-131"><a href="#cb20-131"></a><span class="in">  "A detailed layer that preserves all original data",</span></span>
<span id="cb20-132"><a href="#cb20-132"></a><span class="in">  "A stack of feature layers"</span></span>
<span id="cb20-133"><a href="#cb20-133"></a><span class="in">)</span></span>
<span id="cb20-134"><a href="#cb20-134"></a></span>
<span id="cb20-135"><a href="#cb20-135"></a><span class="in">spatial_data_quiz5 &lt;- c(</span></span>
<span id="cb20-136"><a href="#cb20-136"></a><span class="in">  "Most files cannot handle large amounts of data",</span></span>
<span id="cb20-137"><a href="#cb20-137"></a><span class="in">  "It is easier to create maps with fewer data files",</span></span>
<span id="cb20-138"><a href="#cb20-138"></a><span class="in">  answer = "In most spatial data formats, each file is limited to storing points, lines, or polygons, not all three",</span></span>
<span id="cb20-139"><a href="#cb20-139"></a><span class="in">  "Storing all features in one file makes maps less detailed"</span></span>
<span id="cb20-140"><a href="#cb20-140"></a><span class="in">)</span></span>
<span id="cb20-141"><a href="#cb20-141"></a><span class="in">```</span></span>
<span id="cb20-142"><a href="#cb20-142"></a></span>
<span id="cb20-143"><a href="#cb20-143"></a></span>
<span id="cb20-144"><a href="#cb20-144"></a>**Which of the following best describes the three ways computers store spatial features?**</span>
<span id="cb20-145"><a href="#cb20-145"></a></span>
<span id="cb20-146"><a href="#cb20-146"></a><span class="in">`r webexercises::longmcq(spatial_data_quiz1)`</span></span>
<span id="cb20-147"><a href="#cb20-147"></a></span>
<span id="cb20-148"><a href="#cb20-148"></a></span>
<span id="cb20-149"><a href="#cb20-149"></a>**What is the purpose of a base map in mapping?**</span>
<span id="cb20-150"><a href="#cb20-150"></a></span>
<span id="cb20-151"><a href="#cb20-151"></a><span class="in">`r webexercises::longmcq(spatial_data_quiz2)`</span></span>
<span id="cb20-152"><a href="#cb20-152"></a></span>
<span id="cb20-153"><a href="#cb20-153"></a></span>
<span id="cb20-154"><a href="#cb20-154"></a>**What happens when too much detail is included on a map?**</span>
<span id="cb20-155"><a href="#cb20-155"></a></span>
<span id="cb20-156"><a href="#cb20-156"></a><span class="in">`r webexercises::longmcq(spatial_data_quiz3)`</span></span>
<span id="cb20-157"><a href="#cb20-157"></a></span>
<span id="cb20-158"><a href="#cb20-158"></a></span>
<span id="cb20-159"><a href="#cb20-159"></a>**What is a raster layer?**</span>
<span id="cb20-160"><a href="#cb20-160"></a></span>
<span id="cb20-161"><a href="#cb20-161"></a><span class="in">`r webexercises::longmcq(spatial_data_quiz4)`</span></span>
<span id="cb20-162"><a href="#cb20-162"></a></span>
<span id="cb20-163"><a href="#cb20-163"></a></span>
<span id="cb20-164"><a href="#cb20-164"></a>**Why is it common to store data about different types of features in separate files?**</span>
<span id="cb20-165"><a href="#cb20-165"></a></span>
<span id="cb20-166"><a href="#cb20-166"></a><span class="in">`r webexercises::longmcq(spatial_data_quiz5)`</span></span>
<span id="cb20-167"><a href="#cb20-167"></a></span>
<span id="cb20-168"><a href="#cb20-168"></a></span>
<span id="cb20-169"><a href="#cb20-169"></a>:::</span>
<span id="cb20-170"><a href="#cb20-170"></a></span>
<span id="cb20-171"><a href="#cb20-171"></a></span>
<span id="cb20-172"><a href="#cb20-172"></a>Points, lines and polygons in spatial data are known as *geometric objects* or simply *geometries*. Spatial data is data that has a geometric object (e.g. a pair of co-ordinates representing a crime location) associated with each row.</span>
<span id="cb20-173"><a href="#cb20-173"></a></span>
<span id="cb20-174"><a href="#cb20-174"></a></span>
<span id="cb20-175"><a href="#cb20-175"></a><span class="fu">### Representing places on the earth</span></span>
<span id="cb20-176"><a href="#cb20-176"></a></span>
<span id="cb20-177"><a href="#cb20-177"></a>With any spatial data, we need a way of describing where on the earth a particular point (such as the location of a crime or the corner of a building) is located. Watch this video to find out about the different co-ordinate systems we can use to do this.</span>
<span id="cb20-178"><a href="#cb20-178"></a></span>
<span id="cb20-179"><a href="#cb20-179"></a>{{&lt; video https://youtu.be/8L6EXiuckLo &gt;}}</span>
<span id="cb20-180"><a href="#cb20-180"></a></span>
<span id="cb20-181"><a href="#cb20-181"></a></span>
<span id="cb20-182"><a href="#cb20-182"></a>::: {.callout-quiz .callout}</span>
<span id="cb20-183"><a href="#cb20-183"></a></span>
<span id="cb20-184"><a href="#cb20-184"></a><span class="in">```{r places-quiz}</span></span>
<span id="cb20-185"><a href="#cb20-185"></a><span class="in">#| echo: false</span></span>
<span id="cb20-186"><a href="#cb20-186"></a></span>
<span id="cb20-187"><a href="#cb20-187"></a><span class="in">places_quiz1 &lt;- c(</span></span>
<span id="cb20-188"><a href="#cb20-188"></a><span class="in">  "To measure the distance between two locations",</span></span>
<span id="cb20-189"><a href="#cb20-189"></a><span class="in">  answer = "To specify a location on the Earth’s surface relative to a reference point",</span></span>
<span id="cb20-190"><a href="#cb20-190"></a><span class="in">  "To calculate the area of a geographic region",</span></span>
<span id="cb20-191"><a href="#cb20-191"></a><span class="in">  "To determine the altitude of a point on the Earth"</span></span>
<span id="cb20-192"><a href="#cb20-192"></a><span class="in">)</span></span>
<span id="cb20-193"><a href="#cb20-193"></a></span>
<span id="cb20-194"><a href="#cb20-194"></a><span class="in">places_quiz2 &lt;- c(</span></span>
<span id="cb20-195"><a href="#cb20-195"></a><span class="in">  "Latitude and altitude",</span></span>
<span id="cb20-196"><a href="#cb20-196"></a><span class="in">  "Longitude and elevation",</span></span>
<span id="cb20-197"><a href="#cb20-197"></a><span class="in">  "Latitude and grid distances",</span></span>
<span id="cb20-198"><a href="#cb20-198"></a><span class="in">  answer = "Latitude and longitude"</span></span>
<span id="cb20-199"><a href="#cb20-199"></a><span class="in">)</span></span>
<span id="cb20-200"><a href="#cb20-200"></a></span>
<span id="cb20-201"><a href="#cb20-201"></a><span class="in">places_quiz3 &lt;- c(</span></span>
<span id="cb20-202"><a href="#cb20-202"></a><span class="in">  "They are too small to measure accurately",</span></span>
<span id="cb20-203"><a href="#cb20-203"></a><span class="in">  "They are not precise enough for spatial analysis",</span></span>
<span id="cb20-204"><a href="#cb20-204"></a><span class="in">  answer = "They do not correspond to easily understandable units like metres",</span></span>
<span id="cb20-205"><a href="#cb20-205"></a><span class="in">  "They only work in polar regions"</span></span>
<span id="cb20-206"><a href="#cb20-206"></a><span class="in">)</span></span>
<span id="cb20-207"><a href="#cb20-207"></a></span>
<span id="cb20-208"><a href="#cb20-208"></a><span class="in">places_quiz4 &lt;- c(</span></span>
<span id="cb20-209"><a href="#cb20-209"></a><span class="in">  answer = "The map may have errors or show distorted features",</span></span>
<span id="cb20-210"><a href="#cb20-210"></a><span class="in">  "The map will automatically adjust to the correct region",</span></span>
<span id="cb20-211"><a href="#cb20-211"></a><span class="in">  "The dataset will not load",</span></span>
<span id="cb20-212"><a href="#cb20-212"></a><span class="in">  "The co-ordinates will convert to the nearest global standard"</span></span>
<span id="cb20-213"><a href="#cb20-213"></a><span class="in">)</span></span>
<span id="cb20-214"><a href="#cb20-214"></a></span>
<span id="cb20-215"><a href="#cb20-215"></a><span class="in">places_quiz5 &lt;- c(</span></span>
<span id="cb20-216"><a href="#cb20-216"></a><span class="in">  "Guess based on the region it represents",</span></span>
<span id="cb20-217"><a href="#cb20-217"></a><span class="in">  "Check the size of the dataset file",</span></span>
<span id="cb20-218"><a href="#cb20-218"></a><span class="in">  answer = "Ask the person or organization that provided the data",</span></span>
<span id="cb20-219"><a href="#cb20-219"></a><span class="in">  "Compare it with another dataset from a different region"</span></span>
<span id="cb20-220"><a href="#cb20-220"></a><span class="in">)</span></span>
<span id="cb20-221"><a href="#cb20-221"></a><span class="in">```</span></span>
<span id="cb20-222"><a href="#cb20-222"></a></span>
<span id="cb20-223"><a href="#cb20-223"></a></span>
<span id="cb20-224"><a href="#cb20-224"></a>**What are co-ordinates used for?**</span>
<span id="cb20-225"><a href="#cb20-225"></a></span>
<span id="cb20-226"><a href="#cb20-226"></a><span class="in">`r webexercises::longmcq(places_quiz1)`</span></span>
<span id="cb20-227"><a href="#cb20-227"></a></span>
<span id="cb20-228"><a href="#cb20-228"></a></span>
<span id="cb20-229"><a href="#cb20-229"></a>**What is the geographic co-ordinate system based on?**</span>
<span id="cb20-230"><a href="#cb20-230"></a></span>
<span id="cb20-231"><a href="#cb20-231"></a><span class="in">`r webexercises::longmcq(places_quiz2)`</span></span>
<span id="cb20-232"><a href="#cb20-232"></a></span>
<span id="cb20-233"><a href="#cb20-233"></a></span>
<span id="cb20-234"><a href="#cb20-234"></a>**Why are degrees of latitude and longitude difficult to use for everyday measurements?**</span>
<span id="cb20-235"><a href="#cb20-235"></a></span>
<span id="cb20-236"><a href="#cb20-236"></a><span class="in">`r webexercises::longmcq(places_quiz3)`</span></span>
<span id="cb20-237"><a href="#cb20-237"></a></span>
<span id="cb20-238"><a href="#cb20-238"></a></span>
<span id="cb20-239"><a href="#cb20-239"></a>**What can happen if you use a co-ordinate system designed for a different part of the globe?**</span>
<span id="cb20-240"><a href="#cb20-240"></a></span>
<span id="cb20-241"><a href="#cb20-241"></a><span class="in">`r webexercises::longmcq(places_quiz4)`</span></span>
<span id="cb20-242"><a href="#cb20-242"></a></span>
<span id="cb20-243"><a href="#cb20-243"></a></span>
<span id="cb20-244"><a href="#cb20-244"></a>**What is a practical way to find out which co-ordinate system a dataset uses if it’s not embedded in the file?**</span>
<span id="cb20-245"><a href="#cb20-245"></a></span>
<span id="cb20-246"><a href="#cb20-246"></a><span class="in">`r webexercises::longmcq(places_quiz5)`</span></span>
<span id="cb20-247"><a href="#cb20-247"></a></span>
<span id="cb20-248"><a href="#cb20-248"></a></span>
<span id="cb20-249"><a href="#cb20-249"></a>:::</span>
<span id="cb20-250"><a href="#cb20-250"></a></span>
<span id="cb20-251"><a href="#cb20-251"></a></span>
<span id="cb20-252"><a href="#cb20-252"></a><span class="fu">## Spatial data in R</span></span>
<span id="cb20-253"><a href="#cb20-253"></a></span>
<span id="cb20-254"><a href="#cb20-254"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/sf.jpg" alt="Abstract images of furry monsters moving pieces of maps around"&gt;&lt;/p&gt;</span>
<span id="cb20-255"><a href="#cb20-255"></a></span>
<span id="cb20-256"><a href="#cb20-256"></a>There are several packages that handle raster map data from different sources – one of them is the <span class="co">[</span><span class="ot">ggspatial package</span><span class="co">](https://paleolimbot.github.io/ggspatial/)</span> that we have already used to load the base map of Atlanta for the homicide map we made in @sec-first-map.</span>
<span id="cb20-257"><a href="#cb20-257"></a></span>
<span id="cb20-258"><a href="#cb20-258"></a>&lt;a href="https://r-spatial.github.io/sf/" title="sf website"&gt;&lt;img src="../images/sf-package.gif" class="right-side-image"&gt;&lt;/a&gt;</span>
<span id="cb20-259"><a href="#cb20-259"></a></span>
<span id="cb20-260"><a href="#cb20-260"></a>Vector data can be handled in R using functions from the <span class="co">[</span><span class="ot">sf package</span><span class="co">](https://r-spatial.github.io/sf/)</span>. SF stands for 'simple features', which is a standard for storing spatial data. SF objects are data frames that have a special column to hold the geometry (point, line or polygon) associated with each row in the data. SF objects also understand what co-ordinate system the geometry are described in. This means SF objects can be transformed between co-ordinate systems and combined together in layers on a map.</span>
<span id="cb20-261"><a href="#cb20-261"></a></span>
<span id="cb20-262"><a href="#cb20-262"></a>There a lots of functions in the sf package for handling spatial data. Almost all of these functions begin with the letters <span class="in">`st_`</span> (e.g. <span class="in">`st_read()`</span>), which makes it easy to identify that those functions are designed to be used on SF objects.</span>
<span id="cb20-263"><a href="#cb20-263"></a></span>
<span id="cb20-264"><a href="#cb20-264"></a></span>
<span id="cb20-265"><a href="#cb20-265"></a>::: {.callout-important}</span>
<span id="cb20-266"><a href="#cb20-266"></a><span class="fu">#### Functions in the sf package start with the letters `st_`</span></span>
<span id="cb20-267"><a href="#cb20-267"></a></span>
<span id="cb20-268"><a href="#cb20-268"></a>The names of almost all functions in the sf package start with the letters <span class="in">`st_`</span>, _not_ the letters `sf_`.</span>
<span id="cb20-269"><a href="#cb20-269"></a>:::</span>
<span id="cb20-270"><a href="#cb20-270"></a></span>
<span id="cb20-271"><a href="#cb20-271"></a></span>
<span id="cb20-272"><a href="#cb20-272"></a><span class="fu">### Reading spatial data</span></span>
<span id="cb20-273"><a href="#cb20-273"></a></span>
<span id="cb20-274"><a href="#cb20-274"></a>To get started, open a blank R script file (using <span class="in">`File &gt; New File &gt; R Script`</span>), then save it with the name <span class="in">`chapter_04.R`</span>. Now add the code needed to load the sf and tidyverse packages:</span>
<span id="cb20-275"><a href="#cb20-275"></a></span>
<span id="cb20-278"><a href="#cb20-278"></a><span class="in">```{r}</span></span>
<span id="cb20-279"><a href="#cb20-279"></a><span class="co">#| filename: "chapter_04.R"</span></span>
<span id="cb20-280"><a href="#cb20-280"></a></span>
<span id="cb20-281"><a href="#cb20-281"></a><span class="co"># Load packages</span></span>
<span id="cb20-282"><a href="#cb20-282"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, sfhotspot, tidyverse)</span>
<span id="cb20-283"><a href="#cb20-283"></a><span class="in">```</span></span>
<span id="cb20-284"><a href="#cb20-284"></a></span>
<span id="cb20-285"><a href="#cb20-285"></a>The special features of spatial data -- needing to store geometries, details of the projection used etc. -- mean that spatial data is often stored in special file formats. There are lots of spatial-data formats, but fortunately almost all of them can be read by the <span class="in">`st_read()`</span> function. This means we do not need to learn a different function for each spatial-data format.</span>
<span id="cb20-286"><a href="#cb20-286"></a></span>
<span id="cb20-287"><a href="#cb20-287"></a>While datasets with line or polygon geometries must almost always be stored in specific spatial-data formats, point data can also be stored in common data formats such as Excel and &lt;abbr title="comma-separated values"&gt;CSV&lt;/abbr&gt; files. The <span class="co">[</span><span class="ot">data for this chapter</span><span class="co">](https://geodash.vpd.ca/opendata/)</span> is provided by the Vancouver Police Department in a CSV file (gzipped to reduce the file size).</span>
<span id="cb20-288"><a href="#cb20-288"></a>The file is located at:</span>
<span id="cb20-289"><a href="#cb20-289"></a></span>
<span id="cb20-290"><a href="#cb20-290"></a><span class="in">```</span></span>
<span id="cb20-291"><a href="#cb20-291"></a><span class="in">https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz</span></span>
<span id="cb20-292"><a href="#cb20-292"></a><span class="in">```</span></span>
<span id="cb20-293"><a href="#cb20-293"></a></span>
<span id="cb20-294"><a href="#cb20-294"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb20-295"><a href="#cb20-295"></a><span class="fu">#### What does the `.gz` at the end of this URL mean?</span></span>
<span id="cb20-296"><a href="#cb20-296"></a></span>
<span id="cb20-297"><a href="#cb20-297"></a>CSV files can hold very large amounts of data, but at the cost of the size of the file becoming very large. We can reduce the size of a CSV file (or most other types of file) by compressing the file. You may be familiar with <span class="in">`.zip`</span> compressed files. <span class="co">[</span><span class="ot">Gzip</span><span class="co">](https://en.wikipedia.org/wiki/Gzip)</span> is another way of compressing files. Gzipped files have the file extension <span class="in">`.gz`</span>. <span class="in">`read_csv()`</span> can automatically decompress gzipped files, so we can treat a gzipped CSV file just the same as an uncompressed CSV file.</span>
<span id="cb20-298"><a href="#cb20-298"></a>:::</span>
<span id="cb20-299"><a href="#cb20-299"></a></span>
<span id="cb20-300"><a href="#cb20-300"></a>::: {.callout-quiz .callout}</span>
<span id="cb20-301"><a href="#cb20-301"></a><span class="fu">#### Loading data from a CSV file</span></span>
<span id="cb20-302"><a href="#cb20-302"></a></span>
<span id="cb20-303"><a href="#cb20-303"></a>Thinking back to what we learned in @sec-read-data, add a new line of code to the file <span class="in">`chapter_04.R`</span> to load this dataset and store it in an object called <span class="in">`thefts`</span>. If you need help, you can click the 'Solution' button below.</span>
<span id="cb20-304"><a href="#cb20-304"></a></span>
<span id="cb20-305"><a href="#cb20-305"></a><span class="in">`r webexercises::hide()`</span></span>
<span id="cb20-306"><a href="#cb20-306"></a></span>
<span id="cb20-307"><a href="#cb20-307"></a>Since the data are stored in a regular CSV file, we can use the <span class="in">`read_csv()`</span> function from the readr package to read the file, and the assignment operator <span class="in">`&lt;-`</span> to store the data in the object <span class="in">`thefts`</span>. <span class="in">`read_csv()`</span> can read directly from a URL, so there is no need to download the data first.</span>
<span id="cb20-308"><a href="#cb20-308"></a></span>
<span id="cb20-311"><a href="#cb20-311"></a><span class="in">```{r}</span></span>
<span id="cb20-312"><a href="#cb20-312"></a><span class="co">#| eval: false</span></span>
<span id="cb20-313"><a href="#cb20-313"></a><span class="co">#| filename: "chapter_04.R"</span></span>
<span id="cb20-314"><a href="#cb20-314"></a></span>
<span id="cb20-315"><a href="#cb20-315"></a>thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>)</span>
<span id="cb20-316"><a href="#cb20-316"></a><span class="in">```</span></span>
<span id="cb20-317"><a href="#cb20-317"></a></span>
<span id="cb20-318"><a href="#cb20-318"></a><span class="in">`r webexercises::unhide()`</span></span>
<span id="cb20-319"><a href="#cb20-319"></a></span>
<span id="cb20-320"><a href="#cb20-320"></a>:::</span>
<span id="cb20-321"><a href="#cb20-321"></a></span>
<span id="cb20-322"><a href="#cb20-322"></a>::: {.callout-quiz .callout}</span>
<span id="cb20-323"><a href="#cb20-323"></a><span class="fu">#### Viewing the first few rows of a dataset</span></span>
<span id="cb20-324"><a href="#cb20-324"></a></span>
<span id="cb20-325"><a href="#cb20-325"></a>Now that you have stored the data in the <span class="in">`thefts`</span> object, what code is needed to view the first few rows of data? Type the code into the R Console and press <span class="in">`Enter`</span>/<span class="in">`Return`</span> to run it. Click the 'Solution' button to check your code.</span>
<span id="cb20-326"><a href="#cb20-326"></a></span>
<span id="cb20-327"><a href="#cb20-327"></a><span class="in">`r webexercises::hide()`</span></span>
<span id="cb20-328"><a href="#cb20-328"></a></span>
<span id="cb20-331"><a href="#cb20-331"></a><span class="in">```{r}</span></span>
<span id="cb20-332"><a href="#cb20-332"></a><span class="co">#| eval: false</span></span>
<span id="cb20-333"><a href="#cb20-333"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb20-334"><a href="#cb20-334"></a></span>
<span id="cb20-335"><a href="#cb20-335"></a><span class="fu">head</span>(thefts)</span>
<span id="cb20-336"><a href="#cb20-336"></a><span class="in">```</span></span>
<span id="cb20-337"><a href="#cb20-337"></a></span>
<span id="cb20-338"><a href="#cb20-338"></a><span class="in">`r webexercises::unhide()`</span></span>
<span id="cb20-339"><a href="#cb20-339"></a></span>
<span id="cb20-340"><a href="#cb20-340"></a>:::</span>
<span id="cb20-341"><a href="#cb20-341"></a></span>
<span id="cb20-342"><a href="#cb20-342"></a></span>
<span id="cb20-343"><a href="#cb20-343"></a><span class="fu">### Reading data files from your computer</span></span>
<span id="cb20-344"><a href="#cb20-344"></a></span>
<span id="cb20-345"><a href="#cb20-345"></a>The data consists of <span class="in">`r scales::comma(nrow(thefts))`</span> rows, each representing one theft. Before we can map this data, we will need to do some minor data wrangling to get it into the format we want.</span>
<span id="cb20-346"><a href="#cb20-346"></a></span>
<span id="cb20-347"><a href="#cb20-347"></a>So far we have created datasets by loading data directly from URLs, such as the URL for the Vancouver thefts data we loaded in the previous section. But we can also load datasets that are already stored on our own computers. To do this, we need to know the _file path_ that specifies where a particular file is stored.</span>
<span id="cb20-348"><a href="#cb20-348"></a></span>
<span id="cb20-349"><a href="#cb20-349"></a>You might have encountered file paths before, but you may not. A typical file path looks like this on a Mac or Linux computer:</span>
<span id="cb20-350"><a href="#cb20-350"></a></span>
<span id="cb20-351"><a href="#cb20-351"></a><span class="in">```</span></span>
<span id="cb20-352"><a href="#cb20-352"></a><span class="in">/Users/john_smith/Documents/Crime Mapping/vancouver_thefts.csv</span></span>
<span id="cb20-353"><a href="#cb20-353"></a><span class="in">```</span></span>
<span id="cb20-354"><a href="#cb20-354"></a></span>
<span id="cb20-355"><a href="#cb20-355"></a>or like this on Windows:</span>
<span id="cb20-356"><a href="#cb20-356"></a></span>
<span id="cb20-357"><a href="#cb20-357"></a><span class="in">```</span></span>
<span id="cb20-358"><a href="#cb20-358"></a><span class="in">C:\Users\john_smith\Documents\Crime Mapping\vancouver_thefts.csv</span></span>
<span id="cb20-359"><a href="#cb20-359"></a><span class="in">```</span></span>
<span id="cb20-360"><a href="#cb20-360"></a></span>
<span id="cb20-361"><a href="#cb20-361"></a>The important thing to note here is that computers store files such as <span class="in">`vancouver_thefts.csv`</span> in folders (also called directories), which are themselves often stored inside larger folders, etc. A file path tells a computer where to find a particular file. The file paths above can be read as telling the computer to open the <span class="in">`Users`</span> directory, then the <span class="in">`john_smith`</span> directory, then the <span class="in">`Documents`</span> directory, then the <span class="in">`Crime Mapping`</span> directory, and finally the file <span class="in">`vancouver_thefts.csv`</span>.</span>
<span id="cb20-362"><a href="#cb20-362"></a></span>
<span id="cb20-363"><a href="#cb20-363"></a>You can find the file path of a particular file by typing <span class="in">`file.choose()`</span> in the R console. This will open a new window that allows you to search or browse for a particular file. When you choose the file, R will print the file path in the console.</span>
<span id="cb20-364"><a href="#cb20-364"></a></span>
<span id="cb20-365"><a href="#cb20-365"></a>The two file paths shown above are called _absolute_ file paths, because they show the full location of a particular file on the computer. But there are two problems with absolute paths: they can be very long so they clutter up your code, and (more importantly) they are only correct for a specific computer. If you write an R script that includes either of the file paths above, then you give that file for me to run, the code will immediately produce an error because there is no directory <span class="in">`/Users/john_smith`</span> on my computer.</span>
<span id="cb20-366"><a href="#cb20-366"></a></span>
<span id="cb20-367"><a href="#cb20-367"></a>We can deal with that problem in a few ways. The first is to use a _relative path_. This specifies the location of a file not on the computer as a whole, but relative to the directory we are currently working in. This _working directory_ will depend on how your version of RStudio is configured, but you can find out the working directory by typing <span class="in">`getwd()`</span> in the R console. This will print the absolute path of the working directory for whatever you are currently working on</span>
<span id="cb20-368"><a href="#cb20-368"></a>in RStudio. </span>
<span id="cb20-369"><a href="#cb20-369"></a></span>
<span id="cb20-370"><a href="#cb20-370"></a>Imagine our working directory is <span class="in">`/Users/john_smith/Documents/Crime Mapping/`</span>. If we wanted to open the file <span class="in">`/Users/john_smith/Documents/Crime Mapping/vancouver_thefts.csv`</span>, we could use the absolute file path:</span>
<span id="cb20-371"><a href="#cb20-371"></a></span>
<span id="cb20-374"><a href="#cb20-374"></a><span class="in">```{r}</span></span>
<span id="cb20-375"><a href="#cb20-375"></a><span class="co">#| eval: false</span></span>
<span id="cb20-376"><a href="#cb20-376"></a></span>
<span id="cb20-377"><a href="#cb20-377"></a><span class="fu">read_csv</span>(<span class="st">"/Users/john_smith/Documents/Crime Mapping/vancouver_thefts.csv"</span>)</span>
<span id="cb20-378"><a href="#cb20-378"></a><span class="in">```</span></span>
<span id="cb20-379"><a href="#cb20-379"></a></span>
<span id="cb20-380"><a href="#cb20-380"></a>However, since the file is stored in our current working directory, we could also open the file like this:</span>
<span id="cb20-381"><a href="#cb20-381"></a></span>
<span id="cb20-382"><a href="#cb20-382"></a></span>
<span id="cb20-385"><a href="#cb20-385"></a><span class="in">```{r}</span></span>
<span id="cb20-386"><a href="#cb20-386"></a><span class="co">#| eval: false</span></span>
<span id="cb20-387"><a href="#cb20-387"></a></span>
<span id="cb20-388"><a href="#cb20-388"></a><span class="fu">read_csv</span>(<span class="st">"vancouver_thefts.csv"</span>)</span>
<span id="cb20-389"><a href="#cb20-389"></a><span class="in">```</span></span>
<span id="cb20-390"><a href="#cb20-390"></a></span>
<span id="cb20-391"><a href="#cb20-391"></a>This works because when we provide a relative path (e.g. one that does not begin with <span class="in">`/`</span> on Mac or <span class="in">`C:\`</span> on Windows), R treats the path as being relative to the current working directory. Since the file <span class="in">`vancouver_thefts.csv`</span> is in the working directory, we don't need to specify anything other than the file name.</span>
<span id="cb20-392"><a href="#cb20-392"></a></span>
<span id="cb20-393"><a href="#cb20-393"></a>If we wanted to read from a file that was in a directory _within_ the working directory – e.g. <span class="in">`/Users/john_smith/Documents/Crime Mapping/original_data/canada/vancouver_crime.gpkg`</span> – then we just need to specify where the file is relative to the working directory:</span>
<span id="cb20-394"><a href="#cb20-394"></a></span>
<span id="cb20-397"><a href="#cb20-397"></a><span class="in">```{r}</span></span>
<span id="cb20-398"><a href="#cb20-398"></a><span class="co">#| eval: false</span></span>
<span id="cb20-399"><a href="#cb20-399"></a></span>
<span id="cb20-400"><a href="#cb20-400"></a><span class="fu">read_sf</span>(<span class="st">"original_data/canada/vancouver_crime.gpkg"</span>)</span>
<span id="cb20-401"><a href="#cb20-401"></a><span class="in">```</span></span>
<span id="cb20-402"><a href="#cb20-402"></a></span>
<span id="cb20-403"><a href="#cb20-403"></a></span>
<span id="cb20-404"><a href="#cb20-404"></a>::: {.callout-important}</span>
<span id="cb20-405"><a href="#cb20-405"></a></span>
<span id="cb20-406"><a href="#cb20-406"></a>File paths in your code can make it harder to make sure your code is _portable_, i.e. that it can be used by other people. This is because the file structure on someone else's computer is likely to be different from the file structure on your computer.</span>
<span id="cb20-407"><a href="#cb20-407"></a></span>
<span id="cb20-408"><a href="#cb20-408"></a>You might think code portability doesn't matter, because you are not planning to share your code with anyone. But it's quite possible that you will want to:</span>
<span id="cb20-409"><a href="#cb20-409"></a></span>
<span id="cb20-410"><a href="#cb20-410"></a><span class="ss">  * </span>Re-use code yourself on a different computer, e.g. if you replace your current computer with a new one.</span>
<span id="cb20-411"><a href="#cb20-411"></a><span class="ss">  * </span>Send the code to someone else to get help with a problem.</span>
<span id="cb20-412"><a href="#cb20-412"></a><span class="ss">  * </span>Send the code to someone else who has asked for help from you.</span>
<span id="cb20-413"><a href="#cb20-413"></a></span>
<span id="cb20-414"><a href="#cb20-414"></a>To help keep your code portable:</span>
<span id="cb20-415"><a href="#cb20-415"></a></span>
<span id="cb20-416"><a href="#cb20-416"></a><span class="ss">  * </span>Where possible, include in your code any code needed to download the necessary data from the internet. This is what we most-often do in this course.</span>
<span id="cb20-417"><a href="#cb20-417"></a><span class="ss">  * </span>If the data is not available online, you will need to distribute the data along with your code. In that case, tell anyone you send you code to that they should keep the code file and data files in the same directory, then you can just refer to each data file by its name (e.g. <span class="in">`read_csv("vancouver_thefts.csv")`</span>).</span>
<span id="cb20-418"><a href="#cb20-418"></a><span class="ss">  * </span>Avoid using absolute file paths in your code, since these will almost certainly produce an error if anyone tries to run your code on another computer.</span>
<span id="cb20-419"><a href="#cb20-419"></a></span>
<span id="cb20-420"><a href="#cb20-420"></a>:::</span>
<span id="cb20-421"><a href="#cb20-421"></a></span>
<span id="cb20-422"><a href="#cb20-422"></a></span>
<span id="cb20-423"><a href="#cb20-423"></a><span class="fu">### Cleaning column names</span></span>
<span id="cb20-424"><a href="#cb20-424"></a></span>
<span id="cb20-425"><a href="#cb20-425"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/janitor_clean_names.jpg" alt="Cartoon showing a beaver feeding variables with messy names into a machine marked 'clean_names()' that has consistent variable names coming out of the other side."&gt;&lt;/p&gt;</span>
<span id="cb20-426"><a href="#cb20-426"></a></span>
<span id="cb20-427"><a href="#cb20-427"></a>Typos are one of the most frequent causes of errors in any coding language. One way to avoid typos is to follow some basic rules when we write code. We will learn more about these rules in @sec-code-style, but for now we can just learn one rule: column names in datasets should use what is known as <span class="in">`snake_case`</span>, i.e. they should be all lower case and words should be separated by underscore characters (<span class="in">`_`</span>). This makes your code easier to read and means you don't have to remember whether you called a column <span class="in">`crime_count`</span>, <span class="in">`crimecount`</span>, <span class="in">`CrimeCount`</span> or <span class="in">`CRIMECOUNT`</span>. </span>
<span id="cb20-428"><a href="#cb20-428"></a></span>
<span id="cb20-429"><a href="#cb20-429"></a>&lt;a href="http://sfirke.github.io/janitor/" title="janitor package website"&gt;&lt;img src="../images/janitor.png" class="right-side-image"&gt;&lt;/a&gt;</span>
<span id="cb20-430"><a href="#cb20-430"></a></span>
<span id="cb20-431"><a href="#cb20-431"></a>At the moment, the column names in the <span class="in">`thefts`</span> dataset are upper-case letters. Rather than having to remember this, we can easily convert them to snake case using the <span class="in">`clean_names()`</span> function from the <span class="co">[</span><span class="ot">janitor package</span><span class="co">](http://sfirke.github.io/janitor/)</span>. To use a function from a package, we usually first load the package using the <span class="in">`pacman::p_load()`</span> function. In this case, we probably won't want to use any other functions from the <span class="in">`janitor`</span> package, so instead of loading the whole package we will use this one function directly. To do this, we write the function name with the package name added to the front, separated by two colons <span class="in">`::`</span>.</span>
<span id="cb20-432"><a href="#cb20-432"></a></span>
<span id="cb20-435"><a href="#cb20-435"></a><span class="in">```{r}</span></span>
<span id="cb20-436"><a href="#cb20-436"></a><span class="co">#| filename: "chapter_04.R"</span></span>
<span id="cb20-437"><a href="#cb20-437"></a></span>
<span id="cb20-438"><a href="#cb20-438"></a>thefts <span class="ot">&lt;-</span> janitor<span class="sc">::</span><span class="fu">clean_names</span>(thefts)</span>
<span id="cb20-439"><a href="#cb20-439"></a><span class="in">```</span></span>
<span id="cb20-440"><a href="#cb20-440"></a></span>
<span id="cb20-441"><a href="#cb20-441"></a>Add the code above to the <span class="in">`chapter_04.R`</span> file and run that line of code. If you now run <span class="in">`head(thefts)`</span> in the R Console, you will see that the data has stayed the same but all the column names are now in snake case. <span class="in">`clean_names()`</span> would also have replaced any spaces with underscores, tried to separate words in the variable names and cleaned up several other potential problems. For this reason it is common to call <span class="in">`janitor::clean_names()`</span> straight away after loading a dataset so that you can be confident that the column names will be in the format you expect.</span>
<span id="cb20-442"><a href="#cb20-442"></a></span>
<span id="cb20-443"><a href="#cb20-443"></a>If we wanted to use the <span class="in">`clean_names()`</span> function again, we would have to include the package name and <span class="in">`::`</span> each time, so if our code was going to make repeated use of the function then it would probably be easier to load the package using</span>
<span id="cb20-444"><a href="#cb20-444"></a>the <span class="in">`pacman::p_load()`</span> function as we have done in previous chapters.</span>
<span id="cb20-445"><a href="#cb20-445"></a></span>
<span id="cb20-446"><a href="#cb20-446"></a></span>
<span id="cb20-447"><a href="#cb20-447"></a><span class="fu">### Converting our data to an SF object</span></span>
<span id="cb20-448"><a href="#cb20-448"></a></span>
<span id="cb20-449"><a href="#cb20-449"></a>At present, the data in the <span class="in">`thefts`</span> object is just a regular tibble. We could not use it to make a map because R does not know which columns represent the geometry, or what co-ordinate system the locations are recorded in. We can deal with this by converting the data to an SF object using the <span class="in">`st_as_sf()`</span> function from the <span class="in">`sf`</span> package.</span>
<span id="cb20-450"><a href="#cb20-450"></a></span>
<span id="cb20-451"><a href="#cb20-451"></a>The data provided by the Vancouver Police use the UTM zone 10N co-ordinate system. &lt;abbr title="Universal Transverse Mercator"&gt;UTM&lt;/abbr&gt; is a system for assigning co-ordinates to any location on earth relative to a designated local reference point for the UTM zone covering that part of the planet. The 'N' at the end of the zone name 10N refers to the northern hemisphere.</span>
<span id="cb20-452"><a href="#cb20-452"></a></span>
<span id="cb20-453"><a href="#cb20-453"></a>::: {.callout-important}</span>
<span id="cb20-454"><a href="#cb20-454"></a><span class="fu">#### Co-ordinate reference systems are specific to one part of the globe</span></span>
<span id="cb20-455"><a href="#cb20-455"></a></span>
<span id="cb20-456"><a href="#cb20-456"></a>In almost all cases, co-ordinate reference systems only work for the part of the world that they were designed for. So we should not use the UTM zone 10N co-ordinate system to map data outside the area for which it was designed (broadly speaking, the west coast of North America from Los Angeles to Vancouver, and the part of Canada directly north of Vancouver extending as far as the north pole). If we were to use the UTM zone 10N co-ordinate system for data from another part of the world, we would be very likely to get error messages or strange results.</span>
<span id="cb20-457"><a href="#cb20-457"></a>:::</span>
<span id="cb20-458"><a href="#cb20-458"></a></span>
<span id="cb20-459"><a href="#cb20-459"></a></span>
<span id="cb20-460"><a href="#cb20-460"></a><span class="in">```{r make-utm-map}</span></span>
<span id="cb20-461"><a href="#cb20-461"></a><span class="in">#| eval: false</span></span>
<span id="cb20-462"><a href="#cb20-462"></a><span class="in">#| echo: false</span></span>
<span id="cb20-463"><a href="#cb20-463"></a></span>
<span id="cb20-464"><a href="#cb20-464"></a><span class="in">vancouver &lt;- st_point(c(-123.1207, 49.2827), dim = "XY") |&gt; </span></span>
<span id="cb20-465"><a href="#cb20-465"></a><span class="in">  st_sfc(crs = 4326) |&gt; </span></span>
<span id="cb20-466"><a href="#cb20-466"></a><span class="in">  st_as_sf() |&gt; </span></span>
<span id="cb20-467"><a href="#cb20-467"></a><span class="in">  mutate(name = "Vancouver")</span></span>
<span id="cb20-468"><a href="#cb20-468"></a></span>
<span id="cb20-469"><a href="#cb20-469"></a><span class="in">land &lt;- suppressMessages(rnaturalearth::ne_download(</span></span>
<span id="cb20-470"><a href="#cb20-470"></a><span class="in">  scale = 50, type = "land", category = "physical", returnclass = "sf"</span></span>
<span id="cb20-471"><a href="#cb20-471"></a><span class="in">)) |&gt; </span></span>
<span id="cb20-472"><a href="#cb20-472"></a><span class="in">  filter(scalerank == 0)</span></span>
<span id="cb20-473"><a href="#cb20-473"></a></span>
<span id="cb20-474"><a href="#cb20-474"></a><span class="in">utm_zones &lt;- st_read("https://opendata.arcgis.com/datasets/b294795270aa4fb3bd25286bf09edc51_0.geojson") |&gt; </span></span>
<span id="cb20-475"><a href="#cb20-475"></a><span class="in">  janitor::clean_names() |&gt; </span></span>
<span id="cb20-476"><a href="#cb20-476"></a><span class="in">  mutate(</span></span>
<span id="cb20-477"><a href="#cb20-477"></a><span class="in">    hemisphere = ifelse(row %in% LETTERS[1:13], "southern", "northern")</span></span>
<span id="cb20-478"><a href="#cb20-478"></a><span class="in">  ) |&gt; </span></span>
<span id="cb20-479"><a href="#cb20-479"></a><span class="in">  select(zone, hemisphere, geometry) |&gt; </span></span>
<span id="cb20-480"><a href="#cb20-480"></a><span class="in">  group_by(zone, hemisphere) |&gt; </span></span>
<span id="cb20-481"><a href="#cb20-481"></a><span class="in">  summarise()</span></span>
<span id="cb20-482"><a href="#cb20-482"></a></span>
<span id="cb20-483"><a href="#cb20-483"></a><span class="in">bbox &lt;- utm_zones |&gt; </span></span>
<span id="cb20-484"><a href="#cb20-484"></a><span class="in">  filter(zone %in% 8:12, hemisphere == "northern") |&gt; </span></span>
<span id="cb20-485"><a href="#cb20-485"></a><span class="in">  st_buffer(1) |&gt; </span></span>
<span id="cb20-486"><a href="#cb20-486"></a><span class="in">  st_bbox()</span></span>
<span id="cb20-487"><a href="#cb20-487"></a></span>
<span id="cb20-488"><a href="#cb20-488"></a><span class="in">utm_centroids &lt;- utm_zones |&gt; </span></span>
<span id="cb20-489"><a href="#cb20-489"></a><span class="in">  st_centroid() |&gt; </span></span>
<span id="cb20-490"><a href="#cb20-490"></a><span class="in">  mutate(</span></span>
<span id="cb20-491"><a href="#cb20-491"></a><span class="in">    zone_label = str_glue("zone {zone}{str_to_upper(str_sub(hemisphere, 1, 1))}")</span></span>
<span id="cb20-492"><a href="#cb20-492"></a><span class="in">  ) |&gt; </span></span>
<span id="cb20-493"><a href="#cb20-493"></a><span class="in">  st_crop(bbox)</span></span>
<span id="cb20-494"><a href="#cb20-494"></a></span>
<span id="cb20-495"><a href="#cb20-495"></a><span class="in">utm_vancouver &lt;- ggplot() +</span></span>
<span id="cb20-496"><a href="#cb20-496"></a><span class="in">  geom_sf(data = st_crop(land, bbox), colour = NA) +</span></span>
<span id="cb20-497"><a href="#cb20-497"></a><span class="in">  geom_sf(</span></span>
<span id="cb20-498"><a href="#cb20-498"></a><span class="in">    data = st_crop(st_cast(utm_zones, "LINESTRING"), bbox), </span></span>
<span id="cb20-499"><a href="#cb20-499"></a><span class="in">    colour = "grey50", </span></span>
<span id="cb20-500"><a href="#cb20-500"></a><span class="in">    fill = NA, </span></span>
<span id="cb20-501"><a href="#cb20-501"></a><span class="in">    linetype = "24"</span></span>
<span id="cb20-502"><a href="#cb20-502"></a><span class="in">  ) +</span></span>
<span id="cb20-503"><a href="#cb20-503"></a><span class="in">  geom_sf(</span></span>
<span id="cb20-504"><a href="#cb20-504"></a><span class="in">    data = st_crop(filter(utm_zones, zone == 10, hemisphere == "northern"), bbox),</span></span>
<span id="cb20-505"><a href="#cb20-505"></a><span class="in">    colour = "black", </span></span>
<span id="cb20-506"><a href="#cb20-506"></a><span class="in">    fill = NA</span></span>
<span id="cb20-507"><a href="#cb20-507"></a><span class="in">  ) +</span></span>
<span id="cb20-508"><a href="#cb20-508"></a><span class="in">  geom_sf(data = vancouver) +</span></span>
<span id="cb20-509"><a href="#cb20-509"></a><span class="in">  geom_sf_text(aes(label = zone_label), data = utm_centroids) +</span></span>
<span id="cb20-510"><a href="#cb20-510"></a><span class="in">  geom_sf_label(</span></span>
<span id="cb20-511"><a href="#cb20-511"></a><span class="in">    aes(label = name), </span></span>
<span id="cb20-512"><a href="#cb20-512"></a><span class="in">    data = vancouver, </span></span>
<span id="cb20-513"><a href="#cb20-513"></a><span class="in">    fill = "grey90", </span></span>
<span id="cb20-514"><a href="#cb20-514"></a><span class="in">    hjust = 0, </span></span>
<span id="cb20-515"><a href="#cb20-515"></a><span class="in">    nudge_x = 0.3, </span></span>
<span id="cb20-516"><a href="#cb20-516"></a><span class="in">    label.size = 0</span></span>
<span id="cb20-517"><a href="#cb20-517"></a><span class="in">  ) +</span></span>
<span id="cb20-518"><a href="#cb20-518"></a><span class="in">  scale_x_continuous(expand = c(0, 0)) +</span></span>
<span id="cb20-519"><a href="#cb20-519"></a><span class="in">  scale_y_continuous(limits = c(41, 51), expand = c(0, 0)) +</span></span>
<span id="cb20-520"><a href="#cb20-520"></a><span class="in">  labs(</span></span>
<span id="cb20-521"><a href="#cb20-521"></a><span class="in">    title = "Vancouver in UTM zone 10N", </span></span>
<span id="cb20-522"><a href="#cb20-522"></a><span class="in">    x = NULL, </span></span>
<span id="cb20-523"><a href="#cb20-523"></a><span class="in">    y = NULL,</span></span>
<span id="cb20-524"><a href="#cb20-524"></a><span class="in">    caption = "Made with Natural Earth. Free vector and raster map data @ naturalearthdata.com"</span></span>
<span id="cb20-525"><a href="#cb20-525"></a><span class="in">  ) +</span></span>
<span id="cb20-526"><a href="#cb20-526"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb20-527"><a href="#cb20-527"></a><span class="in">  theme(plot.caption = element_text(colour = "grey50"))</span></span>
<span id="cb20-528"><a href="#cb20-528"></a></span>
<span id="cb20-529"><a href="#cb20-529"></a><span class="in">ggsave(</span></span>
<span id="cb20-530"><a href="#cb20-530"></a><span class="in">  here::here("images/utm_vancouver.jpg"), </span></span>
<span id="cb20-531"><a href="#cb20-531"></a><span class="in">  utm_vancouver, </span></span>
<span id="cb20-532"><a href="#cb20-532"></a><span class="in">  width = 800 / 150, </span></span>
<span id="cb20-533"><a href="#cb20-533"></a><span class="in">  height = 500 / 150, </span></span>
<span id="cb20-534"><a href="#cb20-534"></a><span class="in">  dpi = 150</span></span>
<span id="cb20-535"><a href="#cb20-535"></a><span class="in">)</span></span>
<span id="cb20-536"><a href="#cb20-536"></a><span class="in">```</span></span>
<span id="cb20-537"><a href="#cb20-537"></a></span>
<span id="cb20-538"><a href="#cb20-538"></a><span class="in">```{r utm-map}</span></span>
<span id="cb20-539"><a href="#cb20-539"></a><span class="in">#| echo: false</span></span>
<span id="cb20-540"><a href="#cb20-540"></a><span class="in">#| fig.align: center</span></span>
<span id="cb20-541"><a href="#cb20-541"></a><span class="in">#| out.width: 80%</span></span>
<span id="cb20-542"><a href="#cb20-542"></a></span>
<span id="cb20-543"><a href="#cb20-543"></a><span class="in">knitr::include_graphics(here::here("images/utm_vancouver.jpg"))</span></span>
<span id="cb20-544"><a href="#cb20-544"></a><span class="in">```</span></span>
<span id="cb20-545"><a href="#cb20-545"></a></span>
<span id="cb20-546"><a href="#cb20-546"></a>We can convert the <span class="in">`thefts`</span> tibble to an SF object using the <span class="in">`st_as_sf()`</span> function (remember, all functions in the <span class="in">`sf`</span> package start with <span class="in">`st_`</span>, which can sometimes make the function names a little confusing). We specify which columns in the data represent the geometry (in this case, the <span class="in">`x`</span> and <span class="in">`y`</span> columns), and what co-ordinate system the data uses. </span>
<span id="cb20-547"><a href="#cb20-547"></a></span>
<span id="cb20-548"><a href="#cb20-548"></a>Co-ordinate systems can be specified in lots of ways (some very complicated), but the easiest is to specify the &lt;abbr title="European Petroleum Survey Group"&gt;EPSG&lt;/abbr&gt; code for the relevant system. An EPSG code is a unique reference number for a particular co-ordinate system that R can look up in a database to get the information needed to display the data on a map. The EPSG code for the UTM zone 10N is <span class="in">`EPSG:32610`</span>.</span>
<span id="cb20-549"><a href="#cb20-549"></a></span>
<span id="cb20-550"><a href="#cb20-550"></a>Add this code to the <span class="in">`chapter_04.R`</span> file in RStudio.</span>
<span id="cb20-551"><a href="#cb20-551"></a></span>
<span id="cb20-554"><a href="#cb20-554"></a><span class="in">```{r}</span></span>
<span id="cb20-555"><a href="#cb20-555"></a><span class="co">#| filename: "chapter_04.R"</span></span>
<span id="cb20-556"><a href="#cb20-556"></a></span>
<span id="cb20-557"><a href="#cb20-557"></a>thefts_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(thefts, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>)</span>
<span id="cb20-558"><a href="#cb20-558"></a><span class="in">```</span></span>
<span id="cb20-559"><a href="#cb20-559"></a></span>
<span id="cb20-560"><a href="#cb20-560"></a>If you look at the contents of the <span class="in">`thefts_sf`</span> object by running <span class="in">`head(thefts_sf)`</span> in the R Console, you'll see that there is a new column called <span class="in">`geometry`</span>. This column contains the co-ordinates of each bike theft. But crucially, it stores those co-ordinates in a format that R recognises represent specific locations on the surface of the earth, which means the co-ordinates can be used to make maps.</span>
<span id="cb20-561"><a href="#cb20-561"></a></span>
<span id="cb20-562"><a href="#cb20-562"></a></span>
<span id="cb20-563"><a href="#cb20-563"></a>::: {.callout-important}</span>
<span id="cb20-564"><a href="#cb20-564"></a></span>
<span id="cb20-565"><a href="#cb20-565"></a>It is important to remember that we should only use <span class="in">`st_as_sf()`</span> to convert a *non-spatial* dataset (such as a tibble) into a spatial dataset (an SF object). If we use <span class="in">`st_as_sf()`</span> on an object that is already an SF object, this can have unexpected results and lead to errors in your code.</span>
<span id="cb20-566"><a href="#cb20-566"></a></span>
<span id="cb20-567"><a href="#cb20-567"></a>The easy way to think about this is that if you have loaded a dataset with <span class="in">`read_sf()`</span> or <span class="in">`st_read()`</span> then you have already created an SF object, so you don't need <span class="in">`st_as_sf()`</span>. If you have loaded a dataset with any other function that reads data (such as <span class="in">`read_csv()`</span> or <span class="in">`read_excel()`</span>) then you will need to use <span class="in">`st_as_sf()`</span> if you want to plot the data on a map. Most importantly, do not use <span class="in">`st_as_sf()`</span> if you loaded a dataset with <span class="in">`read_sf()`</span> or <span class="in">`st_read()`</span>.</span>
<span id="cb20-568"><a href="#cb20-568"></a>:::</span>
<span id="cb20-569"><a href="#cb20-569"></a></span>
<span id="cb20-570"><a href="#cb20-570"></a></span>
<span id="cb20-571"><a href="#cb20-571"></a></span>
<span id="cb20-572"><a href="#cb20-572"></a><span class="fu">### Finding bike thefts in our data</span></span>
<span id="cb20-573"><a href="#cb20-573"></a></span>
<span id="cb20-574"><a href="#cb20-574"></a></span>
<span id="cb20-575"><a href="#cb20-575"></a>::: {.callout-quiz .callout}</span>
<span id="cb20-576"><a href="#cb20-576"></a><span class="fu">#### Choosing only some rows in a dataset</span></span>
<span id="cb20-577"><a href="#cb20-577"></a></span>
<span id="cb20-578"><a href="#cb20-578"></a>If you look through the contents of the <span class="in">`thefts_sf`</span> object by running <span class="in">`head(thefts_sf)`</span> in the R Console, you will see that not all of the rows relate to bicycle thefts. The <span class="in">`type`</span> column shows that the dataset also includes thefts from vehicles, for example. To choose only those rows containing bicycle thefts, which function from the <span class="in">`dplyr`</span> package would we used? If you need help, you can think back to @sec-wrangling-data or have a look at the <span class="co">[</span><span class="ot">Data transformation with dplyr cheat sheet</span><span class="co">](https://rstudio.github.io/cheatsheets/html/data-transformation.html)</span>.</span>
<span id="cb20-579"><a href="#cb20-579"></a></span>
<span id="cb20-580"><a href="#cb20-580"></a>**Which function from the `dplyr` package should we use to remove all the rows from our dataset except those for bicycle thefts?**</span>
<span id="cb20-581"><a href="#cb20-581"></a></span>
<span id="cb20-582"><a href="#cb20-582"></a><span class="in">```{r filter-quiz}</span></span>
<span id="cb20-583"><a href="#cb20-583"></a><span class="in">#| echo: false</span></span>
<span id="cb20-584"><a href="#cb20-584"></a></span>
<span id="cb20-585"><a href="#cb20-585"></a><span class="in">filter_quiz &lt;- c(</span></span>
<span id="cb20-586"><a href="#cb20-586"></a><span class="in">  "`select()`",</span></span>
<span id="cb20-587"><a href="#cb20-587"></a><span class="in">  answer = "`filter()`",</span></span>
<span id="cb20-588"><a href="#cb20-588"></a><span class="in">  "`mutate()`",</span></span>
<span id="cb20-589"><a href="#cb20-589"></a><span class="in">  "`summarise()`"</span></span>
<span id="cb20-590"><a href="#cb20-590"></a><span class="in">)</span></span>
<span id="cb20-591"><a href="#cb20-591"></a><span class="in">```</span></span>
<span id="cb20-592"><a href="#cb20-592"></a></span>
<span id="cb20-593"><a href="#cb20-593"></a><span class="in">`r webexercises::longmcq(filter_quiz)`</span></span>
<span id="cb20-594"><a href="#cb20-594"></a></span>
<span id="cb20-595"><a href="#cb20-595"></a>Add code to the <span class="in">`chapter_04.R`</span> file to create a new object called <span class="in">`bike_thefts`</span> that contains only the rows in the <span class="in">`thefts_sf`</span> object that relate to bicycle theft. If you get stuck, you can hit the 'Hint' button below to get help, but try to find the answer on your own first! Once you've finished the code, click the 'Solution' button to check your code.</span>
<span id="cb20-596"><a href="#cb20-596"></a></span>
<span id="cb20-597"><a href="#cb20-597"></a><span class="in">`r webexercises::hide("Hint")`</span></span>
<span id="cb20-598"><a href="#cb20-598"></a></span>
<span id="cb20-599"><a href="#cb20-599"></a>Use the <span class="in">`filter()`</span> function to choose particular rows in a dataset. The syntax for <span class="in">`filter()`</span> is <span class="in">`filter(dataset, column_name == "value")`</span>. Replace <span class="in">`dataset`</span> with the name of the SF object we created from the <span class="in">`thefts`</span> tibble, <span class="in">`column_name`</span> with the name of the column containing the offence type and <span class="in">`value`</span> with the offence type for bicycle theft.</span>
<span id="cb20-600"><a href="#cb20-600"></a></span>
<span id="cb20-601"><a href="#cb20-601"></a><span class="in">`r webexercises::unhide()`</span></span>
<span id="cb20-602"><a href="#cb20-602"></a></span>
<span id="cb20-603"><a href="#cb20-603"></a><span class="in">`r webexercises::hide()`</span></span>
<span id="cb20-604"><a href="#cb20-604"></a></span>
<span id="cb20-605"><a href="#cb20-605"></a>The correct code to store only bicycle thefts in a new object is:</span>
<span id="cb20-606"><a href="#cb20-606"></a></span>
<span id="cb20-609"><a href="#cb20-609"></a><span class="in">```{r}</span></span>
<span id="cb20-610"><a href="#cb20-610"></a><span class="co">#| filename: "chapter_04.R"</span></span>
<span id="cb20-611"><a href="#cb20-611"></a></span>
<span id="cb20-612"><a href="#cb20-612"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">filter</span>(thefts_sf, type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span>
<span id="cb20-613"><a href="#cb20-613"></a><span class="in">```</span></span>
<span id="cb20-614"><a href="#cb20-614"></a></span>
<span id="cb20-615"><a href="#cb20-615"></a><span class="in">`r webexercises::unhide()`</span></span>
<span id="cb20-616"><a href="#cb20-616"></a></span>
<span id="cb20-617"><a href="#cb20-617"></a>:::</span>
<span id="cb20-618"><a href="#cb20-618"></a></span>
<span id="cb20-619"><a href="#cb20-619"></a>Our data is now ready for us to make our crime map!</span>
<span id="cb20-620"><a href="#cb20-620"></a></span>
<span id="cb20-621"><a href="#cb20-621"></a>So far in this chapter we have used several functions -- <span class="in">`read_csv()`</span>, <span class="in">`clean_names()`</span>, <span class="in">`st_as_sf()`</span> and <span class="in">`filter()`</span> to produce an SF object representing the locations of bike thefts. Since we have done this step by step, we have created a different object to store the result produced by each function. But since we only need the final dataset, our code would be a lot easier to read if we used the pipe operator (<span class="in">`|&gt;`</span>) to run all these functions in one go. Delete the relevant lines from the <span class="in">`chapter_04.R`</span> script file and replace them with this code:</span>
<span id="cb20-622"><a href="#cb20-622"></a></span>
<span id="cb20-625"><a href="#cb20-625"></a><span class="in">```{r}</span></span>
<span id="cb20-626"><a href="#cb20-626"></a><span class="co">#| eval: false</span></span>
<span id="cb20-627"><a href="#cb20-627"></a><span class="co">#| filename: "chapter_04.R"</span></span>
<span id="cb20-628"><a href="#cb20-628"></a></span>
<span id="cb20-629"><a href="#cb20-629"></a><span class="co"># Load packages</span></span>
<span id="cb20-630"><a href="#cb20-630"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, sfhotspot, tidyverse)</span>
<span id="cb20-631"><a href="#cb20-631"></a></span>
<span id="cb20-632"><a href="#cb20-632"></a><span class="co"># Load and wrangle bike theft data</span></span>
<span id="cb20-633"><a href="#cb20-633"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-634"><a href="#cb20-634"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-635"><a href="#cb20-635"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-636"><a href="#cb20-636"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span>
<span id="cb20-637"><a href="#cb20-637"></a><span class="in">```</span></span>
<span id="cb20-638"><a href="#cb20-638"></a></span>
<span id="cb20-639"><a href="#cb20-639"></a></span>
<span id="cb20-640"><a href="#cb20-640"></a></span>
<span id="cb20-641"><a href="#cb20-641"></a><span class="fu">## Producing maps in R</span></span>
<span id="cb20-642"><a href="#cb20-642"></a></span>
<span id="cb20-643"><a href="#cb20-643"></a>Now that we have our data, we can use it to create a map of bicycle theft in Vancouver. Before we start, let's take another look at our dataset so that we know which columns contain which data. </span>
<span id="cb20-644"><a href="#cb20-644"></a></span>
<span id="cb20-647"><a href="#cb20-647"></a><span class="in">```{r}</span></span>
<span id="cb20-648"><a href="#cb20-648"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb20-649"><a href="#cb20-649"></a></span>
<span id="cb20-650"><a href="#cb20-650"></a><span class="fu">head</span>(bike_thefts)</span>
<span id="cb20-651"><a href="#cb20-651"></a><span class="in">```</span></span>
<span id="cb20-652"><a href="#cb20-652"></a></span>
<span id="cb20-653"><a href="#cb20-653"></a></span>
<span id="cb20-654"><a href="#cb20-654"></a><span class="fu">### Introduction to ggplot2</span></span>
<span id="cb20-655"><a href="#cb20-655"></a></span>
<span id="cb20-656"><a href="#cb20-656"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/ggplot2_masterpiece.jpg" alt="Cartoon showing several furry monsters with paint brushes painting several different types of chart. Above them is the text 'ggplot2: build a data masterpiece'."&gt;&lt;/p&gt;</span>
<span id="cb20-657"><a href="#cb20-657"></a></span>
<span id="cb20-658"><a href="#cb20-658"></a>A map is a specialised type of chart, so we can make maps using the <span class="co">[</span><span class="ot">ggplot2 package</span><span class="co">](https://ggplot2.tidyverse.org/)</span> that is widely used to create other types of chart in R. ggplot2 charts are made up of layers, so they're well suited to making maps.</span>
<span id="cb20-659"><a href="#cb20-659"></a></span>
<span id="cb20-660"><a href="#cb20-660"></a>&lt;a href="https://ggplot2.tidyverse.org/" title="ggplot2 website"&gt;&lt;img src="../images/ggplot2.png" style="width: 33%; max-width: 150px; float: right; margin: 0 0 2em 2em;"&gt;&lt;/a&gt;</span>
<span id="cb20-661"><a href="#cb20-661"></a></span>
<span id="cb20-662"><a href="#cb20-662"></a>The most-basic crime map that we can make simply plots the locations of crimes with no context. However, this almost never makes a *good* crime map because if there are more than a few crimes it becomes hard to see patterns in the data. But we can use a basic dot map as the foundation on which we can build a better map later on.</span>
<span id="cb20-663"><a href="#cb20-663"></a></span>
<span id="cb20-664"><a href="#cb20-664"></a>ggplot2 plots work by building up a chart using different functions, each of which adds or modifies some part of the chart. Building a plot starts with calling the <span class="in">`ggplot()`</span> function, with each subsequent function being added to </span>
<span id="cb20-665"><a href="#cb20-665"></a>the plot definition using the <span class="in">`+`</span> operator. Note that while the package is called ggplot2, the function in that package used to create plots is called <span class="in">`ggplot()`</span>, *not* <span class="in">`ggplot2()`</span>.</span>
<span id="cb20-666"><a href="#cb20-666"></a></span>
<span id="cb20-667"><a href="#cb20-667"></a>The most-important of the ggplot2 functions are those beginning with <span class="in">`geom_`</span>, which add graphical elements to the chart. If you want to add a layer to your chart showing a scatter plot, you use the <span class="in">`geom_point()`</span> function, while if you </span>
<span id="cb20-668"><a href="#cb20-668"></a>want to make a line chart you use <span class="in">`geom_line()`</span>.</span>
<span id="cb20-669"><a href="#cb20-669"></a></span>
<span id="cb20-670"><a href="#cb20-670"></a><span class="in">```{r example-charts, fig.align="center", out.width="80%"}</span></span>
<span id="cb20-671"><a href="#cb20-671"></a><span class="in">#| echo: false</span></span>
<span id="cb20-672"><a href="#cb20-672"></a></span>
<span id="cb20-673"><a href="#cb20-673"></a><span class="in">ex_point &lt;- tibble(x = rnorm(50, 10, 1), y = rnorm(50, 10, 1)) |&gt; </span></span>
<span id="cb20-674"><a href="#cb20-674"></a><span class="in">  ggplot() +</span></span>
<span id="cb20-675"><a href="#cb20-675"></a><span class="in">  aes(x = x, y = y) +</span></span>
<span id="cb20-676"><a href="#cb20-676"></a><span class="in">  geom_point() +</span></span>
<span id="cb20-677"><a href="#cb20-677"></a><span class="in">  labs(title = "A scatter plot using geom_point()") +</span></span>
<span id="cb20-678"><a href="#cb20-678"></a><span class="in">  theme_minimal()</span></span>
<span id="cb20-679"><a href="#cb20-679"></a></span>
<span id="cb20-680"><a href="#cb20-680"></a><span class="in">ex_line &lt;- tibble(x = 1:10, y = rpois(10, 5)) |&gt; </span></span>
<span id="cb20-681"><a href="#cb20-681"></a><span class="in">  ggplot() +</span></span>
<span id="cb20-682"><a href="#cb20-682"></a><span class="in">  aes(x = x, y = y) +</span></span>
<span id="cb20-683"><a href="#cb20-683"></a><span class="in">  geom_line() +</span></span>
<span id="cb20-684"><a href="#cb20-684"></a><span class="in">  scale_y_continuous(limits = c(0, NA)) +</span></span>
<span id="cb20-685"><a href="#cb20-685"></a><span class="in">  labs(title = "A line chart using geom_line()") +</span></span>
<span id="cb20-686"><a href="#cb20-686"></a><span class="in">  theme_minimal()</span></span>
<span id="cb20-687"><a href="#cb20-687"></a></span>
<span id="cb20-688"><a href="#cb20-688"></a><span class="in">wrap_plots(ex_point, ex_line, ncol = 2)</span></span>
<span id="cb20-689"><a href="#cb20-689"></a><span class="in">```</span></span>
<span id="cb20-690"><a href="#cb20-690"></a></span>
<span id="cb20-691"><a href="#cb20-691"></a>There are lots of <span class="in">`geom_`</span> functions available for representing data on charts in different ways. For maps, we can use the <span class="in">`geom_sf()`</span> function that is designed to add spatial data (in the form of an SF object such as our <span class="in">`bike_thefts`</span> data) to a chart, making it into a map. So to simply plot the points in our bicycle-theft data, we can use the code:</span>
<span id="cb20-692"><a href="#cb20-692"></a></span>
<span id="cb20-695"><a href="#cb20-695"></a><span class="in">```{r}</span></span>
<span id="cb20-696"><a href="#cb20-696"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb20-697"><a href="#cb20-697"></a></span>
<span id="cb20-698"><a href="#cb20-698"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-699"><a href="#cb20-699"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_thefts)</span>
<span id="cb20-700"><a href="#cb20-700"></a><span class="in">```</span></span>
<span id="cb20-701"><a href="#cb20-701"></a></span>
<span id="cb20-702"><a href="#cb20-702"></a></span>
<span id="cb20-703"><a href="#cb20-703"></a>::: {.callout-important}</span>
<span id="cb20-704"><a href="#cb20-704"></a><span class="fu">#### `geom_sf()` only works with SF objects</span></span>
<span id="cb20-705"><a href="#cb20-705"></a></span>
<span id="cb20-706"><a href="#cb20-706"></a><span class="in">`geom_sf()`</span> only works on SF objects, which is why we needed to convert the original tibble of data to an SF object using <span class="in">`st_as_sf()`</span>. If you try to use <span class="in">`geom_sf()`</span> on a dataset that is not stored as an SF object, R will produce an error.</span>
<span id="cb20-707"><a href="#cb20-707"></a></span>
<span id="cb20-708"><a href="#cb20-708"></a>:::</span>
<span id="cb20-709"><a href="#cb20-709"></a></span>
<span id="cb20-710"><a href="#cb20-710"></a></span>
<span id="cb20-711"><a href="#cb20-711"></a>By convention, each function that we add to <span class="in">`ggplot()`</span> to change the appearance of our map goes on a new line (this makes the code easier to read) and all but the first line is indented by two spaces. RStudio does this indenting automatically if the previous line ends with a <span class="in">`+`</span> symbol, since RStudio then understands that there is more code to come on the next line.</span>
<span id="cb20-712"><a href="#cb20-712"></a></span>
<span id="cb20-713"><a href="#cb20-713"></a>The map above shows the bike-theft data, but it is obviously not a very useful map. Fortunately, we can use the features of the ggplot2 package to build on this basic map.</span>
<span id="cb20-714"><a href="#cb20-714"></a></span>
<span id="cb20-715"><a href="#cb20-715"></a></span>
<span id="cb20-716"><a href="#cb20-716"></a>::: {.callout-important}</span>
<span id="cb20-717"><a href="#cb20-717"></a><span class="fu">#### Avoid dot maps</span></span>
<span id="cb20-718"><a href="#cb20-718"></a></span>
<span id="cb20-719"><a href="#cb20-719"></a>Unless we want to produce a map of only a very small number of crimes (like the Atlanta downtown homicides map we produced in @sec-first-map), it is unlikely that a point map will be very useful. </span>
<span id="cb20-720"><a href="#cb20-720"></a></span>
<span id="cb20-721"><a href="#cb20-721"></a>In fact, **if you find yourself making map with each crime represented by a separate point, you should probably stop and ask yourself if that is really the best way to achieve your goal** -- it will almost always be better to map the data in another way.</span>
<span id="cb20-722"><a href="#cb20-722"></a>:::</span>
<span id="cb20-723"><a href="#cb20-723"></a></span>
<span id="cb20-724"><a href="#cb20-724"></a></span>
<span id="cb20-725"><a href="#cb20-725"></a><span class="fu">### Controlling aesthetics</span></span>
<span id="cb20-726"><a href="#cb20-726"></a></span>
<span id="cb20-727"><a href="#cb20-727"></a>We can change the appearance of the points by specifying various arguments to the <span class="in">`geom_sf()`</span> function. These arguments are called *aesthetics*, because they control the aesthetic appearance of the geometric objects (points, lines etc.) that are produced by a <span class="in">`geom_`</span> function. There are lots of aesthetics, but some of the most common are:</span>
<span id="cb20-728"><a href="#cb20-728"></a></span>
<span id="cb20-729"><a href="#cb20-729"></a><span class="ss">  * </span><span class="in">`colour`</span> controls the colour of points and lines (for polygons, it controls the colour of the border around the polygon edge) – you can also use the spelling <span class="in">`color`</span> for this argument and get an identical result,</span>
<span id="cb20-730"><a href="#cb20-730"></a><span class="ss">  * </span><span class="in">`fill`</span> controls the colour used to fill polygons or points that use a shape capable of having different colours in the centre and around the edge (<span class="in">`fill`</span> has no meaning for lines),</span>
<span id="cb20-731"><a href="#cb20-731"></a><span class="ss">  * </span><span class="in">`shape`</span> controls the shape (circle, triangle, square etc.) of points (it has no meaning for lines or polygons),</span>
<span id="cb20-732"><a href="#cb20-732"></a><span class="ss">  * </span><span class="in">`size`</span> controls the size of points and text,</span>
<span id="cb20-733"><a href="#cb20-733"></a><span class="ss">  * </span><span class="in">`linewidth`</span> controls the width of lines, including the borders around the edges of polygons, and</span>
<span id="cb20-734"><a href="#cb20-734"></a><span class="ss">  * </span><span class="in">`alpha`</span> controls the transparency of a layer (<span class="in">`alpha = 1`</span> equals fully opaque, <span class="in">`alpha = 0`</span> means fully transparent).</span>
<span id="cb20-735"><a href="#cb20-735"></a></span>
<span id="cb20-736"><a href="#cb20-736"></a><span class="in">`colour`</span> and <span class="in">`fill`</span> can be specified using <span class="co">[</span><span class="ot">any one of 657 R colour names</span><span class="co">](http://bc.bojanorama.pl/wp-content/uploads/2013/04/rcolorsheet.pdf)</span> or using a <span class="co">[</span><span class="ot">hexidecimal ('hex') colour code</span><span class="co">](https://htmlcolorcodes.com/#color-codes)</span>. Values of <span class="in">`size`</span> don't relate to any unit of size (e.g. millimetres or points), so it's easiest to set the size of points and text by trial and error.</span>
<span id="cb20-737"><a href="#cb20-737"></a></span>
<span id="cb20-738"><a href="#cb20-738"></a>There are 25 built-in shapes for points in R (shape 16 is the default):</span>
<span id="cb20-739"><a href="#cb20-739"></a></span>
<span id="cb20-742"><a href="#cb20-742"></a><span class="in">```{r}</span></span>
<span id="cb20-743"><a href="#cb20-743"></a><span class="co">#| echo: false</span></span>
<span id="cb20-744"><a href="#cb20-744"></a><span class="co">#| fig.align: center</span></span>
<span id="cb20-745"><a href="#cb20-745"></a><span class="co">#| out.width: 80%</span></span>
<span id="cb20-746"><a href="#cb20-746"></a></span>
<span id="cb20-747"><a href="#cb20-747"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">shape =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">24</span>), <span class="fu">aes</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="at">shape =</span> shape)) <span class="sc">+</span></span>
<span id="cb20-748"><a href="#cb20-748"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> <span class="st">"darkblue"</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>, <span class="at">shape =</span> shape), <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb20-749"><a href="#cb20-749"></a>  <span class="fu">scale_colour_identity</span>(<span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">"colour"</span>, <span class="st">"fill"</span>)) <span class="sc">+</span></span>
<span id="cb20-750"><a href="#cb20-750"></a>  <span class="fu">scale_shape_identity</span>() <span class="sc">+</span></span>
<span id="cb20-751"><a href="#cb20-751"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-752"><a href="#cb20-752"></a>    <span class="at">title =</span> <span class="st">"Available shapes in R"</span>, </span>
<span id="cb20-753"><a href="#cb20-753"></a>    <span class="at">subtitle =</span> <span class="fu">str_wrap</span>(<span class="st">"Shapes 0 to 20 use the colour aesthetic. Shapes 21 to 24 have separate values of the colour and fill aesthetics"</span>, <span class="dv">90</span>)</span>
<span id="cb20-754"><a href="#cb20-754"></a>  ) <span class="sc">+</span></span>
<span id="cb20-755"><a href="#cb20-755"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(shape)) <span class="sc">+</span></span>
<span id="cb20-756"><a href="#cb20-756"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb20-757"><a href="#cb20-757"></a><span class="in">```</span></span>
<span id="cb20-758"><a href="#cb20-758"></a></span>
<span id="cb20-759"><a href="#cb20-759"></a></span>
<span id="cb20-760"><a href="#cb20-760"></a>We use aesthetics such as <span class="in">`colour`</span>, <span class="in">`fill`</span>, etc. to change the appearance of layers on a map by adding the aesthetic as an argument to the <span class="in">`geom_*()`</span> function that creates the relevant layer. For example, we could change the points on our map to be red squares rather than the default black circles using this code:</span>
<span id="cb20-761"><a href="#cb20-761"></a></span>
<span id="cb20-764"><a href="#cb20-764"></a><span class="in">```{r}</span></span>
<span id="cb20-765"><a href="#cb20-765"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb20-766"><a href="#cb20-766"></a></span>
<span id="cb20-767"><a href="#cb20-767"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-768"><a href="#cb20-768"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_thefts, <span class="at">shape =</span> <span class="dv">15</span>, <span class="at">colour =</span> <span class="st">"red"</span>)</span>
<span id="cb20-769"><a href="#cb20-769"></a><span class="in">```</span></span>
<span id="cb20-770"><a href="#cb20-770"></a></span>
<span id="cb20-771"><a href="#cb20-771"></a>As we have said, this basic map is not very useful. We can see that there seems to be a cluster of bike thefts towards the top (north) of the map, but it is difficult to see how important this cluster is because so many of the points overlap. Overlapping points are a particular problem in maps, because if there are multiple crimes at the same location then the points representing those crimes will be exactly on top of one another and it will be impossible to see whether there is one crime at a particular location or 100.</span>
<span id="cb20-772"><a href="#cb20-772"></a></span>
<span id="cb20-773"><a href="#cb20-773"></a>One way to deal with this problem is to make the points semi-transparent so that overlapping points appear darker. This often works better if we also make the points slightly smaller at the same time. We can use the <span class="in">`alpha`</span> and <span class="in">`size`</span> </span>
<span id="cb20-774"><a href="#cb20-774"></a>aesthetics to make the points smaller (relative to the default for points of <span class="in">`size = 1`</span>) and semi-transparent.</span>
<span id="cb20-775"><a href="#cb20-775"></a></span>
<span id="cb20-776"><a href="#cb20-776"></a>Add this code to your script file:</span>
<span id="cb20-777"><a href="#cb20-777"></a></span>
<span id="cb20-780"><a href="#cb20-780"></a><span class="in">```{r}</span></span>
<span id="cb20-781"><a href="#cb20-781"></a><span class="co">#| filename: "chapter_04.R"</span></span>
<span id="cb20-782"><a href="#cb20-782"></a></span>
<span id="cb20-783"><a href="#cb20-783"></a><span class="co"># Create a basic crime map</span></span>
<span id="cb20-784"><a href="#cb20-784"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-785"><a href="#cb20-785"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_thefts, <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>)</span>
<span id="cb20-786"><a href="#cb20-786"></a><span class="in">```</span></span>
<span id="cb20-787"><a href="#cb20-787"></a></span>
<span id="cb20-788"><a href="#cb20-788"></a>Making the points semi-transparent goes some way to making it easier to see where bike theft is most common in Vancouver, but the pattern is not clear and it is not possible to tell which darker points represent a handful of crimes at the same location and which represent hundreds of crimes at the same location. </span>
<span id="cb20-789"><a href="#cb20-789"></a></span>
<span id="cb20-790"><a href="#cb20-790"></a>To make our map truly useful, we need to use a different technique. In chapter @sec-mapping-patterns we will learn how to identify crime patterns by mapping the _density_ of crime.</span>
<span id="cb20-791"><a href="#cb20-791"></a></span>
<span id="cb20-792"><a href="#cb20-792"></a>Save the <span class="in">`chapter_04.R`</span> file, then restart R to start a new session by clicking on the <span class="in">`Session`</span> menu and then clicking <span class="in">`Restart R`</span>. This creates a blank canvas for the next chapter.</span>
<span id="cb20-793"><a href="#cb20-793"></a></span>
<span id="cb20-794"><a href="#cb20-794"></a></span>
<span id="cb20-795"><a href="#cb20-795"></a><span class="fu">## In summary</span></span>
<span id="cb20-796"><a href="#cb20-796"></a></span>
<span id="cb20-797"><a href="#cb20-797"></a>In this chapter we have learned more about each specific step in the process of creating a basic crime map. Concepts such as co-ordinate reference systems and EPSG codes can be hard to understand at first, but you will get used to them as you use them to make more maps, so that by the end of this book you will be confident applying those ideas in a wide range of contexts.</span>
<span id="cb20-798"><a href="#cb20-798"></a></span>
<span id="cb20-799"><a href="#cb20-799"></a>At the moment, your script file should look like this.</span>
<span id="cb20-800"><a href="#cb20-800"></a></span>
<span id="cb20-803"><a href="#cb20-803"></a><span class="in">```{r}</span></span>
<span id="cb20-804"><a href="#cb20-804"></a><span class="co">#| eval: false</span></span>
<span id="cb20-805"><a href="#cb20-805"></a><span class="co">#| filename: "chapter_04.R"</span></span>
<span id="cb20-806"><a href="#cb20-806"></a></span>
<span id="cb20-807"><a href="#cb20-807"></a><span class="co"># Load packages</span></span>
<span id="cb20-808"><a href="#cb20-808"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, sfhotspot, tidyverse)</span>
<span id="cb20-809"><a href="#cb20-809"></a></span>
<span id="cb20-810"><a href="#cb20-810"></a><span class="co"># Load and wrangle bike theft data</span></span>
<span id="cb20-811"><a href="#cb20-811"></a>bike_thefts <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-812"><a href="#cb20-812"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-813"><a href="#cb20-813"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:32610"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-814"><a href="#cb20-814"></a>  <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Theft of Bicycle"</span>)</span>
<span id="cb20-815"><a href="#cb20-815"></a></span>
<span id="cb20-816"><a href="#cb20-816"></a><span class="co"># Create a basic crime map</span></span>
<span id="cb20-817"><a href="#cb20-817"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-818"><a href="#cb20-818"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bike_thefts, <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>)</span>
<span id="cb20-819"><a href="#cb20-819"></a><span class="in">```</span></span>
<span id="cb20-820"><a href="#cb20-820"></a></span>
<span id="cb20-821"><a href="#cb20-821"></a>::: {.callout-important}</span>
<span id="cb20-822"><a href="#cb20-822"></a>At the moment, it isn't very easy to see patterns on this map, since so many of the points overlap. In @sec-mapping-patterns, we will learn how to make this map much better by converting it into a density map. </span>
<span id="cb20-823"><a href="#cb20-823"></a></span>
<span id="cb20-824"><a href="#cb20-824"></a>Remember: whenever you create a dot map, ask yourself if a density map would be more useful.</span>
<span id="cb20-825"><a href="#cb20-825"></a>:::</span>
<span id="cb20-826"><a href="#cb20-826"></a></span>
<span id="cb20-827"><a href="#cb20-827"></a></span>
<span id="cb20-828"><a href="#cb20-828"></a>::: {.box .reading}</span>
<span id="cb20-829"><a href="#cb20-829"></a></span>
<span id="cb20-830"><a href="#cb20-830"></a>You can find out more about some of the things we have covered in this chapter using these resources:</span>
<span id="cb20-831"><a href="#cb20-831"></a></span>
<span id="cb20-832"><a href="#cb20-832"></a><span class="ss">  * </span>Understand more about the history of trying to develop accurate map </span>
<span id="cb20-833"><a href="#cb20-833"></a>    projections in this short video: <span class="co">[</span><span class="ot">Why all world maps are wrong</span><span class="co">](https://youtu.be/kIID5FDi2JQ)</span>.</span>
<span id="cb20-834"><a href="#cb20-834"></a><span class="ss">  * </span>Find out more about making all sorts of charts (not just maps) with the </span>
<span id="cb20-835"><a href="#cb20-835"></a>    <span class="in">`ggplot2`</span> package in the <span class="co">[</span><span class="ot">Data Visualisation chapter of *R for Data Science*</span><span class="co">](https://r4ds.hadley.nz/data-visualize.html)</span></span>
<span id="cb20-836"><a href="#cb20-836"></a>    by Hadley Wickham and Garrett Grolemund.</span>
<span id="cb20-837"><a href="#cb20-837"></a><span class="ss">  * </span>Learn more about making maps using simple features in <span class="co">[</span><span class="ot">Chapter 1 of *Spatial Data Science*</span><span class="co">](https://r-spatial.org/book/01-hello.html)</span></span>
<span id="cb20-838"><a href="#cb20-838"></a>    by Edzer Pebesma and Roger Bivand.</span>
<span id="cb20-839"><a href="#cb20-839"></a></span>
<span id="cb20-840"><a href="#cb20-840"></a>:::</span>
<span id="cb20-841"><a href="#cb20-841"></a></span>
<span id="cb20-842"><a href="#cb20-842"></a></span>
<span id="cb20-843"><a href="#cb20-843"></a>::: {.callout-quiz .callout}</span>
<span id="cb20-844"><a href="#cb20-844"></a><span class="fu">### Revision questions</span></span>
<span id="cb20-845"><a href="#cb20-845"></a></span>
<span id="cb20-846"><a href="#cb20-846"></a>Answer these questions to check you have understood the main points covered in this chapter. Write between 50 and 100 words to answer each question.</span>
<span id="cb20-847"><a href="#cb20-847"></a></span>
<span id="cb20-848"><a href="#cb20-848"></a><span class="ss">1. </span>What is spatial data, and how does it differ from other types of data? Provide examples of spatial features commonly used in crime mapping.</span>
<span id="cb20-849"><a href="#cb20-849"></a><span class="ss">2. </span>Explain the role of coordinate systems in mapping. Why is it important to use the correct coordinate system for a specific dataset?</span>
<span id="cb20-850"><a href="#cb20-850"></a><span class="ss">3. </span>Discuss the challenges of using file paths in R scripts and how relative file paths improve code portability.</span>
<span id="cb20-851"><a href="#cb20-851"></a><span class="ss">4. </span>Why is it helpful to use the pipe operator (<span class="in">`|&gt;`</span> in R) when working with multiple functions? Provide an example from the chapter.</span>
<span id="cb20-852"><a href="#cb20-852"></a><span class="ss">5. </span>Explain how the <span class="in">`select()`</span> function in dplyr is used to manage columns in a dataset. How can it help when working with large spatial datasets?</span>
<span id="cb20-853"><a href="#cb20-853"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by/4.0/">
<p>This book is available under a Creative Commons Attribution 4.0 International licence</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>