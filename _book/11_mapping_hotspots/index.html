<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>11&nbsp; Mapping hotspots – Learn Crime Mapping with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../12_messy_data/index.html" rel="next">
<link href="../10_place_data/index.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-854d42f42d0f6b455b86ad16a464e311.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<!-- START OF INCLUDED HEADER -->

<!--
This file contains code that will be included in the header of each page of the
quarto book
-->

<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>

<!-- END OF INCLUDED HEADER -->

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../include/webex.css">
<meta name="twitter:title" content="11&nbsp; Mapping hotspots – Learn Crime Mapping with R">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="../images/cover_image.png">
<meta name="twitter:image:alt" content="">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../11_mapping_hotspots/index.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/cover_image.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Learn Crime Mapping with R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mpjashby/crimemappingbook/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install the software needed for this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_getting_started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_your_first_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Your first crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_data_wrangling/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_your_second_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Your second crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_code_with_style/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Code with style</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_mapping_crime_patterns/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping crime patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_map_context/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Giving a map context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_handling_bugs/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Handling bugs in your code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_mapping_areas/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Mapping area data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../10_place_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../11_mapping_hotspots/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../12_messy_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../13_crime_series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Mapping crime series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../14_writing_reports/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Writing reports in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../15_no_maps/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Presenting spatial data without maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../16_mapping_time/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Mapping crime over time</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/read_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Functions for reading data into R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/map_checklist.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Checklist: Making a good crime map</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/common_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Common R errors and how to fix them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/functions_to_avoid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Some R functions you should avoid</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/handling_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Checklist: handling code errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">In this chapter</h2>
   
  <ul>
  <li><a href="#what-is-a-hotspot" id="toc-what-is-a-hotspot" class="nav-link active" data-scroll-target="#what-is-a-hotspot"><span class="header-section-number">11.1</span> What is a hotspot?</a></li>
  <li><a href="#showing-the-density-of-risk" id="toc-showing-the-density-of-risk" class="nav-link" data-scroll-target="#showing-the-density-of-risk"><span class="header-section-number">11.2</span> Showing the density of risk</a>
  <ul class="collapse">
  <li><a href="#data-wrangling" id="toc-data-wrangling" class="nav-link" data-scroll-target="#data-wrangling"><span class="header-section-number">11.2.1</span> Data wrangling</a></li>
  <li><a href="#calculating-dual-kernel-density" id="toc-calculating-dual-kernel-density" class="nav-link" data-scroll-target="#calculating-dual-kernel-density"><span class="header-section-number">11.2.2</span> Calculating dual kernel density</a></li>
  </ul></li>
  <li><a href="#finding-hotspots" id="toc-finding-hotspots" class="nav-link" data-scroll-target="#finding-hotspots"><span class="header-section-number">11.3</span> Finding hotspots</a></li>
  <li><a href="#putting-it-all-together" id="toc-putting-it-all-together" class="nav-link" data-scroll-target="#putting-it-all-together"><span class="header-section-number">11.4</span> Putting it all together</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-mapping-hotspots" class="quarto-section-identifier"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="abstract">
<p>This chapter introduces the concept of crime hotspots and their significance in crime analysis. You will learn how to define hotspots, understand their different types, and explore why crime tends to cluster in specific areas. Using R, we will demonstrate methods to map hotspots effectively, helping to visualize high-risk areas. The chapter also covers techniques such as dual kernel density estimation to measure crime risk. By the end, you will have practical skills to create crime hotspot maps, aiding in data-driven decision-making for crime prevention and law enforcement strategies.</p>
</div>
<section id="what-is-a-hotspot" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="what-is-a-hotspot"><span class="header-section-number">11.1</span> What is a hotspot?</h2>
<p>Crime is heavily concentrated in several different ways. A small number of offenders commit a large proportion of crime (even though most people commit minor offences occasionally) and a small number of people are repeatedly victimised. For most types of crime, a large proportion of crime occurs in a small number of places. <strong>A hotspot is a specific location or small area where an unusual amount of criminal activity occurs</strong>.</p>
<p>Crime hotspots can occur in several different forms. Watch this video to understand why hotspots are important in understanding and responding to crime.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/ug-ZhvvQjmw" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>Some places are <em>chronic</em> hotspots – they have more crime than surrounding areas over a sustained period (which may appear to be permanent). Chronic hotspots are often generated by a facility that draws vulnerable people into an area, such as a tourist attraction that draws crowds of people who are vulnerable to pickpocketing. Other places are <em>acute</em> hotspots, in which crime increases in a place that previously experienced no or few crimes. This may be the result of some change in the environment or how it’s managed, such as new management that ignores drug dealing at a bar that the previous owners would have not tolerated.</p>
<p>When analysing hotspots, it is best to focus on <em>small</em> areas such as an apartment block, a shopping centre, a park or a single street. Focusing on smaller areas is important because resources to respond to crime are almost always limited, so it is important that those resources are directed where the problem is worst.</p>
<p>Analysing larger areas, such as a neighbourhood or a police sector, is much more difficult because larger areas are always made up of many smaller areas, each of which might be quite different from one another. This means that the factors causing one street to be a hotspot might be quite different from the factors that make another street in the same district into a hotspot. Conflating different problems with different causes makes it much harder to find effective ways to reduce crime in any one place.</p>
<p>These difficulties can be avoided (at least partly) by keeping hotspots small: in an urban area, a useful rule of thumb is that you should be able to stand in the middle of a hotspot and see the whole hotspot area.</p>
<p>Being able to identify hotspots using crime mapping is important because it forms a vital first step in many place-focused responses to crime. As an example of this, watch this video about how police in Philadelphia worked with researchers to use crime mapping to identify where to deploy foot patrols to reduce crime.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/0NUQsK0vnnM" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>In this chapter we will learn how to make maps that could be useful in identifying and responding to hotspots of crime. As an example, we will create this map showing hotspots of robbery in Nottingham, England.</p>
<p class="full-width-image">
<img src="../images/nottingham_robbery_map.jpg" alt="A hotspot map of robberies in Nottingham">
</p>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Crime hotspots
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Which one of these statements is true?</strong></p>
<div id="radio_GATMREWFGP" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_GATMREWFGP" value=""> <span>Crime is extremely geographically concentrated – we can expect half of crime to be concentrated in about 1% of micro places</span></label><label><input type="radio" autocomplete="off" name="radio_GATMREWFGP" value="answer"> <span>Crime is very geographically concentrated – we can expect half of crime to be concentrated in about 5% of micro places</span></label><label><input type="radio" autocomplete="off" name="radio_GATMREWFGP" value=""> <span>Crime is slightly geographically concentrated – we can expect half of crime to be concentrated in about one quarter of micro places</span></label><label><input type="radio" autocomplete="off" name="radio_GATMREWFGP" value=""> <span>Crime is usually not geographically concentrated at micro places</span></label>
</div>
</div>
</div>
</section>
<section id="showing-the-density-of-risk" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="showing-the-density-of-risk"><span class="header-section-number">11.2</span> Showing the density of risk</h2>
<p>In <a href="../09_mapping_areas/index.html" class="quarto-xref"><span>Chapter 9</span></a> we learned how to produce maps showing the <em>incidence rate</em> of crime by dividing the number of crimes by a measure of the population at risk of being targeted. We will often only have population estimates for areas, such as census estimates of the number of people living in an area. But for some crimes we have access to estimates of the people (or, more often, objects) at risk of being a target of a particular crime. In these cases, we can produce better maps of the risk of crime in different areas by producing a <em>dual KDE</em> map that shows the density of crime <em>risk</em> in different places.</p>
<p>To create a dual KDE map, we must estimate the density of crime and compare it to an estimate the density of the population at risk. Since an incidence rate is calculated as the number of crimes divided by the number of people or objects at risk, we can calculate the density of risk by dividing the density of crime estimated for each cell in the grid by the density of population estimated for the same cell. The <code>hotspot_dual_kde()</code> function from the sfhotspot package does this for us.</p>
<p>To illustrate making a dual KDE map, we will use reports of burglaries in three wards in Nottingham in 2020. Since the essential element of the crime of burglary in England is that an offender enters a <em>building</em> as a trespasser in order to steal something, the best measure of the population at risk of burglary is the number of <em>buildings</em> in each area (the definition of burglary is more complicated than this, but we don’t need to worry about that here).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What’s the difference between theft, burglary and robbery?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Definitions of crime vary between countries. But theft (sometimes called <em>larceny</em>) is usually defined as the act of dishonestly taking property belonging to another person while intending to keep (not just borrow) the property or treat it as the offender’s own. Shoplifting, bike theft, car theft and pickpocketing are all types of theft.</p>
<p>Burglary and robbery are both special types of theft. A burglary is a theft committed inside a building that the offender does not have the owner’s permission to be in. The most obvious type of burglary is when an offender breaks into a victim’s home and steals valuables from inside. But burglary can also be committed in non-residential buildings: some types of business are frequent targets of burglary.</p>
<p>A robbery is a theft in which the offender uses violence or the threat of violence against the victim. It is important to remember that burglary and robbery are separate crimes. Since robbery requires (the threat of) violence against a person, robbery risk is usually described in terms of the number of robberies for a certain number of <em>people</em>. Burglary, on the other hand, can only take place in a building, so burglary risk is usually described in terms of the number of burglaries for a certain number of <em>premises</em>.</p>
</div>
</div>
</div>
<p>Burglary is a good example of why the routine activities approach to thinking about crime that we introduced in <a href="../01_getting_started/index.html" class="quarto-xref"><span>Chapter 1</span></a> emphasises thinking about <em>targets</em> of crime rather than focusing only on crime <em>victims</em>. In the case of burglary, one person might be the owner of a large number of buildings (e.g.&nbsp;a farm with lots of out-buildings) or lots of people might own a single building (such as a house converted into flats). By thinking about the targets that are attacked by offenders, we can identify that burglary rates should be calculated based on buildings rather than, for example, residential population. Note that if our crime data only included <em>residential</em> burglaries then we would want to use <em>residential</em> buildings as our denominator, but in this case we have data for all burglaries, both residential and non-residential.</p>
<section id="data-wrangling" class="level3" data-number="11.2.1">
<h3 data-number="11.2.1" class="anchored" data-anchor-id="data-wrangling"><span class="header-section-number">11.2.1</span> Data wrangling</h3>
<p>Before we can create our dual KDE layer, we have to complete some data wrangling. We will extract the boundaries for the wards of interest from a dataset of boundaries for all wards in Nottingham using <code>filter()</code> as we have done previously. To extract only the burglaries occurring in those three wards from a dataset of all burglaries in Nottingham, we will use <code>st_intersection()</code>. We will also transform both datasets to use the British National Grid (EPSG:27700), since we will need to do that anyway before calculating the KDE values.</p>
<p>Open RStudio and make sure you are working within the project you created in <a href="../01_getting_started/index.html#sec-create-project" class="quarto-xref"><span>Section 1.4.2</span></a>. Create a new R script file and save it as <code>chapter11a.R</code>. Paste the following code into that file and run it.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter11a.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Load packages</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggspatial, osmdata, sf, sfhotspot, tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># Load dataset of wards in Nottingham and choose the ones we want</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>wards <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="fu">filter</span>(ward_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Castle"</span>, <span class="st">"Lenton &amp; Wollaton East"</span>, <span class="st">"Meadows"</span>))</span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co"># Load dataset of burglaries and keep only those in the wards of interest</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>burglaries <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_burglary.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-11"><a href="#cb1-11"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-12"><a href="#cb1-12"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="fu">st_intersection</span>(wards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We do not have a source of open data for all the buildings in Nottingham, so we will use the osmdata package to get the locations of buildings from OpenStreetMap (OSM). You may remember from <a href="../10_place_data/index.html" class="quarto-xref"><span>Chapter 10</span></a> that to do this we need to know which key (and possibly value) the OSM database uses for storing the locations of buildings. The OSM feature key for a building is ‘building’ and it is not necessary to specify a value (since we want to capture all types of building). The osmdata package expects data to use the WGS84 co-ordinate reference system, so we must also make sure any data sources we use are projected using that system (EPSG:4326).</p>
<p>Add this code to your R script and run it.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter11a.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>nottingham_buildings <span class="ot">&lt;-</span> wards <span class="sc">|&gt;</span> </span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="co"># Transform ward boundaries to CRS needed by `opq()`</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="co"># Calculate bounding box</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb2-6"><a href="#cb2-6"></a>  <span class="co"># Set up OSM query</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>  <span class="fu">opq</span>() <span class="sc">|&gt;</span> </span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="co"># Add type of feature to fetch</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"building"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="co"># Fetch features from OSM database</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="fu">osmdata_sf</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s look at the content of the <code>nottingham_buildings</code> object:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>nottingham_buildings</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Object of class 'osmdata' with:
                 $bbox : 52.9173362670705,-1.21712477980417,52.9596833099217,-1.13020878819132
        $overpass_call : The call submitted to the overpass API
                 $meta : metadata including timestamp and version numbers
           $osm_points : 'sf' Simple Features Collection with 164495 points
            $osm_lines : 'sf' Simple Features Collection with 44 linestrings
         $osm_polygons : 'sf' Simple Features Collection with 30468 polygons
       $osm_multilines : 'sf' Simple Features Collection with 2 multilinestrings
    $osm_multipolygons : 'sf' Simple Features Collection with 69 multipolygons</code></pre>
</div>
</div>
<p>Looking at the <code>nottingham_buildings</code> object, we can see that OSM contains data on buildings stored as points, polygons and multipolygons (we can ignore the few linestrings tagged as buildings, since it doesn’t make sense for a building to be represented as a line rather than a point or a polygon).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What is a multipolygon?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>OpenStreetMap stores features in several different ways. The most basic types are points, lines and polygons. But there are also multipolygons (and multilines). These are features that represent complex structures such as clusters of buildings that are separate structures but are related to each other. For example, a hospital with several buildings might be represented in OpenStreetMap as a single multipolygon feature. A multipolygon might also be used to represent complex building shapes such as buildings with a courtyard or light well in the middle.</p>
</div>
</div>
</div>
<p>Let’s create a simple map of the results produced by <code>osmdata_sf()</code>, comparing them to the buildings shown on a base map to check that OSM has reasonable coverage of the buildings in these three wards. This code uses the <code>pluck()</code> function from the purrr package (part of the tidyverse) to extract the different elements from the <code>nottingham_buildings</code> object.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb5" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="co"># Add building features stored as points</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb5-5"><a href="#cb5-5"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_points"</span>), </span>
<span id="cb5-6"><a href="#cb5-6"></a>    <span class="at">colour =</span> <span class="st">"green"</span>,</span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="at">size =</span> <span class="fl">0.1</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>  ) <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>  <span class="co"># Add building features stored as polygons</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb5-11"><a href="#cb5-11"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_polygons"</span>), </span>
<span id="cb5-12"><a href="#cb5-12"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb5-13"><a href="#cb5-13"></a>    <span class="at">fill =</span> <span class="st">"blue"</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>  ) <span class="sc">+</span> </span>
<span id="cb5-15"><a href="#cb5-15"></a>  <span class="co"># Add building features stored as multi-polygons</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb5-17"><a href="#cb5-17"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_multipolygons"</span>), </span>
<span id="cb5-18"><a href="#cb5-18"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb5-19"><a href="#cb5-19"></a>    <span class="at">fill =</span> <span class="st">"darkred"</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>  ) <span class="sc">+</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="at">colour =</span> <span class="st">"red"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">1.25</span>) <span class="sc">+</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>osmdata_sf()</code> returns data for a bounding box
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember that <code>osmdata_sf()</code> gets OSM data for the area covered by the <em>bounding box</em> of the input feature, not the feature boundaries. This means some of the buildings returned by the code above will be outside the wards we are interested in. We will deal with that shortly.</p>
</div>
</div>
<p>It looks like almost all the streets in the three wards we are interested in are lined with buildings in the OSM data, which is what we would expect of streets in an urban area. There are some streets without buildings in the top-left of the map, but these streets are outside our three wards so this does not matter.</p>
<p>We can also see from this map that the 164,495 point features in the OSM data (shown as green dots on the map) typically represent the corners of buildings that are also represented as polygons, so we know we can ignore the points layer within the OSM data.</p>
<p>Since the <code>hotspot_dual_kde()</code> function works on points, we need to convert the polygon and multipolygon layers to points by calculating their centroids, then merge the two layers together. This will generate a warning that <code>st_centroid does not give correct centroids for longitude/latitude data</code> but we can ignore this because the calculated centroids will be good enough for our purposes (if we wanted to, we could transform the data to use the British National Grid, calculate the centroids and then transform it back).</p>
<p>Since we are only interested in those buildings in three particular wards, we can also at this stage remove any buildings that are outside those wards using <code>st_intersection()</code>, as we have already done for the <code>burglaries</code> object. Since the <code>wards</code> object uses the British National Grid and <code>st_intersection()</code> requires both datasets to use the same co-ordinate system, we will transform the building centroids before clipping them.</p>
<p>Add this code to the <code>chapter11a.R</code> file and run it.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter11a.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb6" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Extract polygon/multipolygon layers and combine them into a single object</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>nottingham_building_centroids <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_polygons"</span>), </span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_multipolygons"</span>)</span>
<span id="cb6-5"><a href="#cb6-5"></a>) <span class="sc">|&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="co"># Convert polygons to points</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>  <span class="fu">st_centroid</span>() <span class="sc">|&gt;</span> </span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="co"># Transform to same CRS as `wards` object</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="co"># Remove any points outside the wards of interest</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>  <span class="fu">st_intersection</span>(wards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: st_centroid assumes attributes are constant over geometries</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What does the warning <code>st_centroid assumes …</code> mean?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>You might have seen a warning saying <code>st_centroid assumes attributes are constant over geometries of x</code>. You will see this warning when you use the <code>st_centroid()</code> function. It is there to remind you that columns in the original data (which the SF package refers to as the <em>attributes</em> associated with each spatial feature) refer to the polygon as a whole, but in the object produced by <code>st_centroid()</code> it will appear that the columns relate to the centroid point. In many cases this will not be a problem, but it could expose you to the ecological fallacy so it is sometimes useful to be reminded.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What does the warning <code>attribute variables are assumed …</code> mean?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>st_intersection()</code> produces a warning message whenever it is used:</p>
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout all geometries</code></pre>
<p>As long as you are simply using <code>st_intersection()</code> to remove parts of the data outside a boundary, you can ignore this message.</p>
</div>
</div>
</div>
</section>
<section id="calculating-dual-kernel-density" class="level3" data-number="11.2.2">
<h3 data-number="11.2.2" class="anchored" data-anchor-id="calculating-dual-kernel-density"><span class="header-section-number">11.2.2</span> Calculating dual kernel density</h3>
<p>We now have the object <code>burglaries</code> that contains the locations of each burglary in the three Nottingham wards that we are interested in, and the object <code>nottingham_building_centroids</code> that contains the centroids of each building in those three wards. We can use these layers to estimate the density of burglaries and buildings, then combine these to estimate the density of burglary risk.</p>
<p><code>hotspot_dual_kde()</code> works in the same way as <code>hotspot_kde()</code>, except that it requires two datasets. In this case, that means one dataset of crime locations and one dataset of building locations. <code>hotspot_dual_kde()</code> will set the cell size and bandwidth automatically, but we can set them manually using the <code>cell_size</code>, <code>bandwidth_adjust</code> and <code>grid</code> arguments in the same way we have done for <code>hotspot_kde()</code>. In this case, we will use the <code>hotspot_grid()</code> helper function to create a grid based on the boundaries of the wards we are interested in. All the spatial objects we are going to use here have co-ordinates specified using the British National Grid because we have already transformed them, so we do not need to do any transformation here.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter11a.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb10" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># Estimate density of burglary risk</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>burglary_risk <span class="ot">&lt;-</span> <span class="fu">hotspot_dual_kde</span>(</span>
<span id="cb10-3"><a href="#cb10-3"></a>  burglaries, </span>
<span id="cb10-4"><a href="#cb10-4"></a>  nottingham_building_centroids, </span>
<span id="cb10-5"><a href="#cb10-5"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, </span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="at">grid =</span> <span class="fu">hotspot_grid</span>(wards, <span class="at">cell_size =</span> <span class="dv">100</span>),</span>
<span id="cb10-7"><a href="#cb10-7"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb10-9"><a href="#cb10-9"></a>  <span class="fu">st_intersection</span>(wards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
</div>
<p>The <code>burglary_risk</code> object looks like this:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb12" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">head</span>(burglary_risk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 6 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 455826.6 ymin: 338782.9 xmax: 456354.2 ymax: 338909
Projected CRS: OSGB36 / British National Grid
# A tibble: 6 × 5
      n    kde ward_code ward_name                                      geometry
  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;                                     &lt;POLYGON [m]&gt;
1     0 0.0824 E05012277 Castle    ((456061.5 338809, 456061.5 338799.8, 456006…
2     0 0.0815 E05012277 Castle    ((456061.5 338809, 456161.5 338809, 456161.5…
3     0 0.107  E05012277 Castle    ((456161.5 338809, 456261.5 338809, 456261.5…
4     0 0.121  E05012277 Castle    ((456261.5 338809, 456354.2 338809, 456261.5…
5     0 0.168  E05012277 Castle    ((455861.5 338909, 455861.5 338888.8, 455826…
6     0 0.171  E05012277 Castle    ((455861.5 338909, 455961.5 338909, 455961.5…</code></pre>
</div>
</div>
<p>You might recall from earlier in this chapter that the value of the <code>kde</code> column in the object produced by <code>hotspot_dual_kde()</code> is calculated by dividing the density of burglary in each grid cell by the density of buildings in the same grid cell. There are two cases where this will produce a result that is not a finite number:</p>
<ul>
<li>If, for a particular cell, the density of burglaries and density of buildings are both zero, dividing one by the other will produce the result <code>NaN</code>, for ‘not a number’.</li>
<li>If the density of burglaries is greater than zero but the density of buildings is exactly zero, the result will be <code>Inf</code>, for ‘infinite’.</li>
</ul>
<p>Since it is not possible to calculate burglary risk in either of those cases, we can exclude these cases from the <code>burglary_risk</code> object by using <code>filter()</code> together with the <code>is.finite()</code> function (R does not count <code>NaN</code> as a finite number):</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter11a.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb14" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>burglary_risk_filtered <span class="ot">&lt;-</span> <span class="fu">filter</span>(burglary_risk, <span class="fu">is.finite</span>(kde))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>You might wonder why we didn’t simply add <code>filter()</code> to the existing pipeline that creates the <code>burglary_risk</code> object. It is because we will need the unfiltered object in the next section of this chapter, but in your own code it will be better to add <code>filter(is.finite(kde))</code> to the pipeline after <code>st_intersection()</code>. But for now …</p>
<p>We can plot the estimate of the density of burglary risk. By controlling for the density of buildings, this map shows us where building owners <em>on average</em> face the highest risk of being burgled. This might be useful in working out, for example, which building owners should be offered visits from a crime-prevention advisor or funding to install crime-prevention measures.</p>
<p>Add this code to your script file and run it to produce a map:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter11a.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb15" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="co"># Add burglary risk layer</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb15-5"><a href="#cb15-5"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb15-6"><a href="#cb15-6"></a>    <span class="at">data =</span> burglary_risk_filtered, </span>
<span id="cb15-7"><a href="#cb15-7"></a>    <span class="at">alpha =</span> <span class="fl">0.8</span>, </span>
<span id="cb15-8"><a href="#cb15-8"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb15-9"><a href="#cb15-9"></a>  ) <span class="sc">+</span></span>
<span id="cb15-10"><a href="#cb15-10"></a>  <span class="co"># Add ward boundaries</span></span>
<span id="cb15-11"><a href="#cb15-11"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span> </span>
<span id="cb15-12"><a href="#cb15-12"></a>  <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb15-13"><a href="#cb15-13"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(burglary_risk_filtered, <span class="st">"kde"</span>)),</span>
<span id="cb15-14"><a href="#cb15-14"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>),</span>
<span id="cb15-15"><a href="#cb15-15"></a>    <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb15-16"><a href="#cb15-16"></a>  ) <span class="sc">+</span></span>
<span id="cb15-17"><a href="#cb15-17"></a>  <span class="fu">labs</span>(</span>
<span id="cb15-18"><a href="#cb15-18"></a>      <span class="at">title =</span> <span class="st">"Burglary risk in south-west Nottingham"</span>,</span>
<span id="cb15-19"><a href="#cb15-19"></a>      <span class="at">subtitle =</span> <span class="fu">str_glue</span>(</span>
<span id="cb15-20"><a href="#cb15-20"></a>        <span class="st">"dual kernel density of burglary risk in Castle, Lenton &amp; Wollaton "</span>,</span>
<span id="cb15-21"><a href="#cb15-21"></a>        <span class="st">"East and Meadows wards"</span></span>
<span id="cb15-22"><a href="#cb15-22"></a>      ),</span>
<span id="cb15-23"><a href="#cb15-23"></a>      <span class="at">caption =</span> <span class="fu">str_glue</span>(</span>
<span id="cb15-24"><a href="#cb15-24"></a>        <span class="st">"Contains public sector information licensed under the Open "</span>,</span>
<span id="cb15-25"><a href="#cb15-25"></a>        <span class="st">"Government Licence v3.0"</span></span>
<span id="cb15-26"><a href="#cb15-26"></a>      ),</span>
<span id="cb15-27"><a href="#cb15-27"></a>      <span class="at">fill =</span> <span class="st">"density of burglary risk, 2020"</span></span>
<span id="cb15-28"><a href="#cb15-28"></a>  ) <span class="sc">+</span></span>
<span id="cb15-29"><a href="#cb15-29"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb15-30"><a href="#cb15-30"></a>  <span class="fu">theme</span>(</span>
<span id="cb15-31"><a href="#cb15-31"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb15-32"><a href="#cb15-32"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey40"</span>),</span>
<span id="cb15-33"><a href="#cb15-33"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">6</span>, <span class="at">b =</span> <span class="dv">6</span>)),</span>
<span id="cb15-34"><a href="#cb15-34"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey50"</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>)</span>
<span id="cb15-35"><a href="#cb15-35"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>You might think this map looks strange: almost all the burglary risk seems to be concentrated in one grid cell on the left-hand side of the map. This illustrates one of the limitations of grid-based approaches to understanding the concentration of crime in different places. The northern half of the Lenton &amp; Wollaton East Ward (the western-most of the three wards shown on this map) is home to the University of Nottingham main campus. This campus consists of dozens of separate buildings, each of which could be burgled. But when a university building is burgled and that is reported to the police, the police record that crime as having happened at the university’s main administration building (because that is the postal address of the university). This means that while all the burglaries occurring over a large area are recorded as occurring in one grid cell, the corresponding building centroids are spread out over a large number of grid cells. That means when we calculate the incidence rate of burglary for this map, we get an inaccurate picture.</p>
<p>Whenever you use police-recorded data – or any other administrative data collected by a government agency – it is important to think about how that data was collected and what limitations it may have. There are some common issues that you should look out for when dealing with police-recorded crime locations:</p>
<ul>
<li>Assaults that are disclosed by people attending hospital for their injuries are sometimes recorded as having occurred at the hospital (since that’s where police have been called to) rather than at the actual location they occurred.</li>
<li>Drugs and weapons discovered when arrested people are searched at the police station are sometimes recorded as illegal possession of drugs/weapons at the station, rather than at the location where the person was first stopped by police.</li>
<li>Crimes on public transport are sometimes recorded as having occurred at the nearest station, or at station where the victim ended their journey, rather than at the location where they actually occurred.</li>
</ul>
<p>If we wanted to understand burglary risk on the University of Nottingham campus, it would probably be necessary to use a different dataset (for example using records kept by the university security department).</p>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Dual kernel density
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Which <em>one</em> of these statements is true?</strong></p>
<div id="radio_BKGMJEHANN" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_BKGMJEHANN" value=""> <span><code>hotspot_dual_kde()</code> can work on any co-ordinates, whether they use a geographic co-ordinate system (i.e.&nbsp;longitude and latitude) or a projected system.</span></label><label><input type="radio" autocomplete="off" name="radio_BKGMJEHANN" value="answer"> <span><code>hotspot_dual_kde()</code> requires co-ordinates to use a projected co-ordinate system (i.e.&nbsp;not longitude and latitude).</span></label><label><input type="radio" autocomplete="off" name="radio_BKGMJEHANN" value=""> <span><code>hotspot_dual_kde()</code> requires co-ordinates to use a geographic co-ordinate system (i.e.&nbsp;longitude and latitude).</span></label><label><input type="radio" autocomplete="off" name="radio_BKGMJEHANN" value=""> <span><code>hotspot_dual_kde()</code> does not work with co-ordinates, so it does not matter which type of co-ordinate system a dataset uses.</span></label>
</div>
<p><strong>Why do we usually clip the result of <code>hotspot_dual_kde()</code> using <code>st_intersection()</code>?</strong></p>
<div id="radio_ZVVITWQJVK" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_ZVVITWQJVK" value=""> <span>To make our maps look nicer.</span></label><label><input type="radio" autocomplete="off" name="radio_ZVVITWQJVK" value=""> <span>To transform the co-ordinate system our data uses from the system <code>hotspot_dual_kde()</code> uses to the one we need to produce a map.</span></label><label><input type="radio" autocomplete="off" name="radio_ZVVITWQJVK" value="answer"> <span>To eliminate any areas that we do not have data for, since displaying KDE values for such areas on a map might be misleading.</span></label><label><input type="radio" autocomplete="off" name="radio_ZVVITWQJVK" value=""> <span>To make it easier to see the other layers on our map.</span></label>
</div>
</div>
</div>
</section>
</section>
<section id="finding-hotspots" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="finding-hotspots"><span class="header-section-number">11.3</span> Finding hotspots</h2>
<p>We now know how to produce a better map of the density of crime in different areas. But how do we know which areas count as hotspots and which don’t?</p>
<!--

There are several ways to answer this question. If we were planning a particular activity to respond to a crime problem, we might know what resources we had available to respond. For example, we might know that we have enough funding to provide crime-prevention visits to 100 locations. In that case, we can order the cells in a KDE object according to which have the highest estimates of risk, then count all the premises in each cell until we have reached our limit.

To do this, we need to know how many buildings are in each grid cell (we already know how many burglaries occurred in each grid cell -- that value is in the `n` column of the `burglary_risk` object). We have already learned how to count crimes in areas when we learned about mapping area data. When we want to count crimes in each cell in a grid, we can use the `hotspot_count()` function from the `sfhotspot` package to count the number of buildings in each grid cell. We will then be able to combine those building counts to the estimates of burglary risk we have already calculated.


::: {.callout-important}

So that we can join the building counts to the burglary risk estimates, it is important that both layers are based on the same grid. In the code above we created a grid with the code `hotspot_grid(wards, cell_size = 100)`, so to make sure we use the same grid to count buildings we can either use that same code again, or we could have saved the result of that code as an object (maybe called `nottingham_wards_grid`) and then provided that object to the `grid` argument of both `hotspot_dual_kde()` and `hotspot_count()`.

Note that the results of `hotspot_dual_kde()` and `hotspot_count()` will only have the same structure before we wrangle then any further, for example by using `filter()` as in the previous section. That is why we saved an unfiltered version of the dataset in the `burglary_risk` object.
:::






::: {.cell filename='chapter11a.R'}

```{.r .cell-code}
# Count number of buildings in each grid cell
building_counts <- hotspot_count(
  nottingham_building_centroids, 
  grid = hotspot_grid(wards, cell_size = 100)
) |> 
  # Clip the result to the area for which we have data
  st_intersection(wards)
```
:::






The `building_counts` and `burglary_risk` objects have the same structure: each row represents a cell in the same grid, and the rows are in the same order (because both grids were created by identical calls to `hotspot_grid()`). This means we can combine the two objects using the `bind_cols()` function from the dplyr package (part of the tidyverse). 






::: {.cell filename='R Console'}

```{.r .cell-code}
# Combine burglary and building counts
burglary_risk_bldg <- bind_cols(burglary_risk, building_counts)
```

::: {.cell-output .cell-output-stderr}

```
New names:
• `n` -> `n...1`
• `ward_code` -> `ward_code...3`
• `ward_name` -> `ward_name...4`
• `geometry` -> `geometry...5`
• `n` -> `n...6`
• `ward_code` -> `ward_code...7`
• `ward_name` -> `ward_name...8`
• `geometry` -> `geometry...9`
```


:::
:::

::: {.cell filename='R Console'}

```{.r .cell-code}
head(burglary_risk_bldg)
```

::: {.cell-output .cell-output-stdout}

```
# A tibble: 6 × 9
  n...1    kde ward_code...3 ward_name...4                    geometry...5 n...6
  <dbl>  <dbl> <chr>         <chr>                           <POLYGON [m]> <dbl>
1     0 0.0824 E05012277     Castle        ((456061.5 338809, 456061.5 33…     0
2     0 0.0815 E05012277     Castle        ((456061.5 338809, 456161.5 33…     0
3     0 0.107  E05012277     Castle        ((456161.5 338809, 456261.5 33…     1
4     0 0.121  E05012277     Castle        ((456261.5 338809, 456354.2 33…     1
5     0 0.168  E05012277     Castle        ((455861.5 338909, 455861.5 33…     2
6     0 0.171  E05012277     Castle        ((455861.5 338909, 455961.5 33…     4
# ℹ 3 more variables: ward_code...7 <chr>, ward_name...8 <chr>,
#   geometry...9 <POLYGON [m]>
```


:::
:::






Looking at this object, we can see that `bind_cols()` has changed the column names. This is because some of the column names were duplicated across the two datasets. Some of these new column names, such as `ward_code...3` would be difficult to work with, so lets go back and remove duplicate columns before we combine the two datasets together.






::: {.cell exercise='true' filename='chapter11a.R'}

```{.r .cell-code}
burglary_risk_bldg <- burglary_risk |> 
  # Keep only the `n` and `kde` columns, renaming `n` to `burglary_count`
  # because there is also a column called `n` in the `building_counts` object
  select(burglary_count = n, kde) |> 
  # Remove the geometry column (since an identical one exists in 
  # `building_counts`). Note that we do this separately because we can't use
  # `select()` to remove the `geometry` column.
  st_drop_geometry() |> 
  bind_cols(building_counts) |> 
  # Give the building-count column a better name
  rename(building_count = n) |> 
  # After calling `bind_cols()` it is safe to use `filter()` to wrangle the
  # data
  filter(is.finite(kde))
```
:::






We can now order the dataset with the cells with highest burglary risk at the top and calculate the *cumulative total* (also called a running total) of buildings using the `cumsum()` ('cumulative sum') function. We can use this running total to find the 100 buildings in the cells with highest burglary risk.






::: {.cell filename='chapter11a.R'}

```{.r .cell-code}
cells_for_prevention <- burglary_risk_bldg |> 
  # Arrange cells from highest to lowest burglary risk
  arrange(desc(kde)) |> 
  # Count the number of buildings in a cell and all the cells with higher 
  # burglary risk than that cell
  mutate(sum_buildings = cumsum(building_count)) |> 
  # Keep only those cells that contain the first 100 buildings
  filter(sum_buildings < 100)
```
:::






We could now plot the `cells_for_prevention` object on a map to show the grid cells containing the buildings that would receive the crime-prevention visits. We could also use `st_intersection()` to identify those rows in the dataset of buildings in the `nottingham_building_centroids` object that were in the top grid cells, which would give us a list of buildings to visit.


### Distinguishing hotspots from random variation

-->
<p>Each of the 16 density maps below show density estimates based on 1,000 points placed completely at random on 16 different maps. There are no real patterns in the data except for statistical noise. Nevertheless, the KDE process makes it appear that there are patterns in the data.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/random-map-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is a problem because we might end up responding to an apparent problem that is nothing but an artefact of the random variation that we expect to see in many processes, including crime.</p>
<p>If the police and other agencies looked at these patterns and did nothing in response to them, it is likely that over time some of the areas with high density would become areas of low density, and <em>vice versa</em>. However, the harm caused by crime means it is very hard for agencies to justify sitting back and do nothing to respond to it – many people would consider it immoral to do so. So police and other agencies are very likely to try to respond to crime patterns, even if those patterns might have occurred by chance. This is very frustrating, because if we were to go back and look at the same data in a few months time it is very likely that the apparent hotspots would have shifted to somewhere different, making all the effort spent in responding to crime seem worthless (which, if the apparent patterns were actually artefacts of the KDE process, it may have been).</p>
<p>You might be thinking it’s better safe than sorry, and that police should respond to the apparent patterns just in case they represent real concentrations in crime. But police resources are always scarce, so responding to one problem in one place means not responding to another problem in another place. This is known as the <em>opportunity cost</em> of acting: if police focus their limited resources in one area, that comes at the cost of not being able to deploy those resources in other areas that might need it more.</p>
<p>We can try to avoid this problem of wasting resources responding to random variation in crime by determining whether the number of crimes in an area is more than the greatest number we would reasonably expect if there were no actual patterns in the data (if you have studied statistics before, you might recognise this as a description of a <em>null hypothesis</em>, but you don’t need to have studied statistics to apply the techniques in this course).</p>
<p>To determine if the number of crimes in each area is greater than we would expect by chance, we can use the <em>Getis-Ord Gi* statistic</em> (also called the <em>local G</em> statistic, spoken out-loud as the <em>G-I star statistic</em>). If the Gi* statistic for an area is greater than a certain value, we can say that the number of crimes in that area is higher than we would expect if there were no patterns in the data. We will call areas with more crimes than we would expect by chance as <em>hotspots</em>.</p>
<p>We can calculate the Gi* statistic using the <code>hotspot_gistar()</code> function from the sfhotspot package. This works in a similar way to the <code>hotspot_kde()</code> function, in that it takes an SF object of the locations of crimes and returns an SF object with a grid of cells, along with the Gi* value for each grid cell. Like <code>hotspot_kde()</code>, <code>hotspot_gistar()</code> will choose default values for several ways in which we could fine-tune the calculation of the Gi* statistic, but we could over-ride these defaults if we wanted to.</p>
<p>Open a new R script file and save it as <code>chapter11b.R</code>.</p>
<p>In this example, we will find the hotspots of robbery in Nottingham in 2020, based on a grid of 100-metre cells. We will store this in an object called <code>robbery</code>, transform it to use the British National Grid co-ordinate system (so we can specify the cell size in metres) and then use the resulting object to calculate the Gi* values.</p>
<p>Add this code to the new script file and run it.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter11b.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb16" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># Prepare ----------------------------------------------------------------------</span></span>
<span id="cb16-2"><a href="#cb16-2"></a></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="co"># Load packages</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggspatial, sf, sfhotspot, tidyverse)</span>
<span id="cb16-5"><a href="#cb16-5"></a></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="co"># Load Nottingham robbery data</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>robbery <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-8"><a href="#cb16-8"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-9"><a href="#cb16-9"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb16-10"><a href="#cb16-10"></a></span>
<span id="cb16-11"><a href="#cb16-11"></a></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="co"># Find significant grid cells --------------------------------------------------</span></span>
<span id="cb16-13"><a href="#cb16-13"></a></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="co"># Calculate Gi* statistic</span></span>
<span id="cb16-15"><a href="#cb16-15"></a>robbery_gistar <span class="ot">&lt;-</span> <span class="fu">hotspot_gistar</span>(</span>
<span id="cb16-16"><a href="#cb16-16"></a>  robbery, </span>
<span id="cb16-17"><a href="#cb16-17"></a>  <span class="at">cell_size =</span> <span class="dv">100</span>, </span>
<span id="cb16-18"><a href="#cb16-18"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, </span>
<span id="cb16-19"><a href="#cb16-19"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb16-20"><a href="#cb16-20"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Rows: 555 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): location, lsoa_code
dbl  (2): longitude, latitude
date (1): month

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>Instead of using <code>head()</code> to view the first few rows of the object we have just created, let’s use <code>sample_n()</code> to return a random sample of rows from that object:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb18" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">sample_n</span>(robbery_gistar, <span class="at">size =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 10 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 453367.5 ymin: 335174.1 xmax: 460267.5 ymax: 344574.1
Projected CRS: OSGB36 / British National Grid
# A tibble: 10 × 5
       n     kde gistar  pvalue                                         geometry
 * &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;                                    &lt;POLYGON [m]&gt;
 1     0 0.00229 -0.498 0.618   ((453367.5 340474.1, 453367.5 340574.1, 453467.…
 2     0 0       -0.498 0.618   ((454667.5 336674.1, 454667.5 336774.1, 454767.…
 3     0 0       -0.498 0.618   ((458767.5 338374.1, 458767.5 338474.1, 458867.…
 4     0 0       -0.498 0.618   ((455367.5 337574.1, 455367.5 337674.1, 455467.…
 5     0 0       -0.498 0.618   ((456967.5 336974.1, 456967.5 337074.1, 457067.…
 6     0 0       -0.498 0.618   ((456267.5 335174.1, 456267.5 335274.1, 456367.…
 7     0 0       -0.498 0.618   ((460167.5 339974.1, 460167.5 340074.1, 460267.…
 8     1 8.29     2.82  0.00484 ((455267.5 340274.1, 455267.5 340374.1, 455367.…
 9     0 0       -0.498 0.618   ((455467.5 337874.1, 455467.5 337974.1, 455567.…
10     0 0.556   -0.498 0.618   ((453567.5 344474.1, 453567.5 344574.1, 453667.…</code></pre>
</div>
</div>
<p>The <code>robbery_gistar</code> object contains one row for each cell in a grid of cells covering the area of the robbery data. Each row has four columns:</p>
<ul>
<li><code>n</code> shows the number of robberies that occurred in that grid cell,</li>
<li><code>kde</code> shows the density of robberies in that cell,</li>
<li><code>gistar</code> shows the Gi* value for that cell, and</li>
<li><code>pvalue</code> shows the <span class="math inline">\(p\)</span>-value for that cell.</li>
</ul>
<p>The Gi* statistic is an example of a more general group of statistics called <span class="math inline">\(Z\)</span> <em>scores</em>. Statisticians and data analysts compare the <span class="math inline">\(Z\)</span> scores produced by statistical procedures such as <code>hotspot_gistar()</code> to reference values to decide if a <span class="math inline">\(Z\)</span> score is large enough to be treated as statistically significant, i.e.&nbsp;if it is large enough to conclude that it is larger than we would expect if there were no actual patterns in the data. Deciding on the right reference value to compare a <span class="math inline">\(Z\)</span> score to can be difficult because of what’s known as the multiple comparison problem (which we don’t need to go into detail about). Fortunately, the values in the <code>pvalue</code> column have already been automatically adjusted to take account of the multiple comparison problem, so we can interpret the <span class="math inline">\(p\)</span>-values instead of interpreting the Gi* statistic directly.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Filter data before calcuating Gi* values
</div>
</div>
<div class="callout-body-container callout-body">
<p>Since Gi* is a relative measure, if you have data for a large area (e.g.&nbsp;a country) but only want to show data for a smaller area (e.g.&nbsp;a city), the Gi* values will be influenced by the large areas with no crime and all of the city is likely to be identified as a hotspot. To prevent this, it is important to clip the dataset <em>before</em> calculating the Gi* values, as well as then clipping afterwards where necessary.</p>
</div>
</div>
<p>By convention, <span class="math inline">\(p\)</span>-values are considered to be significant if they are <em>less than 0.05</em>. So if <span class="math inline">\(p&lt;0.05\)</span>, we can say that the number of robberies occurring in a given grid cell is significantly different from zero. Values of Gi* greater than zero indicate cells with more robberies than expected and values of Gi* less than zero indicate cells with fewer robberies than expected. We can combine these two values to find cells with significantly <em>more</em> robberies than expected by chance, which are those cells for which <span class="math inline">\(Z&gt;0\)</span> and <span class="math inline">\(p&lt;0.05\)</span>. To put that into R code, we would write <code>gistar &gt; 0</code> and <code>p &lt; 0.05</code>.</p>
<p>We could use this information in various ways. For example, if we wanted to give local police officers a printed map of which areas to patrol, we could simply show the significant hotspot cells over a base map.</p>
<div class="cell" data-exercise="true">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb20" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb20-4"><a href="#cb20-4"></a>    <span class="at">data =</span> <span class="fu">filter</span>(robbery_gistar, gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>), </span>
<span id="cb20-5"><a href="#cb20-5"></a>    <span class="at">fill =</span> <span class="st">"red"</span>, </span>
<span id="cb20-6"><a href="#cb20-6"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>,</span>
<span id="cb20-7"><a href="#cb20-7"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb20-8"><a href="#cb20-8"></a>  ) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/hotspot-exercise4-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Since <code>hotspot_gistar()</code> also estimates density for each grid cell, we could more usefully show the <em>density</em> of robberies in each cell, but only for cells that the Gi* values showed were significant hotspots.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter11b.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb21" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># Plot map ---------------------------------------------------------------------</span></span>
<span id="cb21-2"><a href="#cb21-2"></a></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb21-6"><a href="#cb21-6"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde),</span>
<span id="cb21-7"><a href="#cb21-7"></a>    <span class="at">data =</span> <span class="fu">filter</span>(robbery_gistar, gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>), </span>
<span id="cb21-8"><a href="#cb21-8"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>,</span>
<span id="cb21-9"><a href="#cb21-9"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb21-10"><a href="#cb21-10"></a>  ) <span class="sc">+</span></span>
<span id="cb21-11"><a href="#cb21-11"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-12"><a href="#cb21-12"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb21-13"><a href="#cb21-13"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>This map could be very useful for police officers deciding where to conduct anti-robbery patrols, because it not only shows the areas with the highest density of robberies but only shows those areas if there are more robberies than we would expect by chance. This makes it more likely that officers won’t waste time chasing apparent patterns that are actually the result of random variation.</p>
<p>One limitation of this map, though, is that it’s hard to see the hotspots that have the lowest KDE values. It is important to be able to see these cells, since they have a higher density of robbery than we would expect by chance even if that density is lower than for some other cells. To deal with this problem, we can use a different colour scale so that instead of the colours varying between light blue and dark blue, they instead vary between mid blue and dark blue.</p>
<p>To do that, we replace <code>scale_fill_distiller()</code> in our <code>ggplot()</code> stack with another scale function: <code>scale_fill_gradient()</code>. This allows us to specify two colours and ggplot2 will automatically create a gradient of colours between them. We can specify colours in R in several ways, but the code below uses the <code>rgb()</code> helper function to specify a colour as being made of up of three components: <strong>r</strong>ed, <strong>g</strong>reen and <strong>b</strong>blue. Each of these is specified as a value between zero and one, with higher values giving lighter shades. You can see this approach being used in the final script file below.</p>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Gi*
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong><code>robbery_gi</code> is an object storing a result produced by the <code>hotspot_gistar()</code> function. Which of these pieces of code could be used to extract <em>only</em> those rows in the data with significant p-values?</strong></p>
<div id="radio_EOICBTBWFC" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_EOICBTBWFC" value="answer"> <span><code>filter(robbery_gi, pvalue &lt; 0.05)</code></span></label><label><input type="radio" autocomplete="off" name="radio_EOICBTBWFC" value=""> <span><code>filter(robbery_gi, pvalue &gt; 0.05)</code></span></label><label><input type="radio" autocomplete="off" name="radio_EOICBTBWFC" value=""> <span><code>filter(robbery_gi, pvalue &lt;= 0.05)</code></span></label><label><input type="radio" autocomplete="off" name="radio_EOICBTBWFC" value=""> <span><code>filter(robbery_gi, pvalue == 0.05)</code></span></label>
</div>
<p><strong>Which <em>one</em> of these statements is true about an SF object called <code>robberies_in_nottingham</code>?</strong></p>
<div id="radio_ANGFCDPRYC" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_ANGFCDPRYC" value=""> <span>We can remove the <code>geometry</code> column with the code <code>select(robberies_in_nottingham, -geometry)</code>.</span></label><label><input type="radio" autocomplete="off" name="radio_ANGFCDPRYC" value=""> <span>We can remove the <code>geometry</code> column with the code <code>filter(robberies_in_nottingham, -geometry)</code>.</span></label><label><input type="radio" autocomplete="off" name="radio_ANGFCDPRYC" value="answer"> <span>We cannot remove the <code>geometry</code> column of an SF object with <code>select()</code>, so we must use <code>st_drop_geometry()</code> instead.</span></label><label><input type="radio" autocomplete="off" name="radio_ANGFCDPRYC" value=""> <span>There is no way to remove the <code>geometry</code> column from an SF object.</span></label>
</div>
</div>
</div>
</section>
<section id="putting-it-all-together" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="putting-it-all-together"><span class="header-section-number">11.4</span> Putting it all together</h2>
<p>In this chapter we have learned about hotspots, how to create dual KDE maps and how to find significant hotspots using the Gi* statistic. We can put this all together to create a complete script for producing a map of robbery hotspots in Nottingham</p>
<p>The following code is all that is needed to produce this map. Read through the comments accompanying the code to see how what we have learned in this chapter fits together, then run the code to produce the map.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>chapter11b.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb22" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># Prepare ----------------------------------------------------------------------</span></span>
<span id="cb22-2"><a href="#cb22-2"></a></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="co"># Load packages</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggspatial, sf, sfhotspot, tidyverse)</span>
<span id="cb22-5"><a href="#cb22-5"></a></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="co"># Load data and transform to British National Grid, which is easier to work with</span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="co"># for functions that use spatial units such as metres</span></span>
<span id="cb22-8"><a href="#cb22-8"></a>robbery <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-9"><a href="#cb22-9"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-10"><a href="#cb22-10"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb22-11"><a href="#cb22-11"></a>nottingham_wards <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-12"><a href="#cb22-12"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb22-13"><a href="#cb22-13"></a></span>
<span id="cb22-14"><a href="#cb22-14"></a></span>
<span id="cb22-15"><a href="#cb22-15"></a><span class="co"># Find significant grid cells --------------------------------------------------</span></span>
<span id="cb22-16"><a href="#cb22-16"></a></span>
<span id="cb22-17"><a href="#cb22-17"></a><span class="co"># Calculate Gi* statistic, filter for only significant hotspot cells and clip to</span></span>
<span id="cb22-18"><a href="#cb22-18"></a><span class="co"># the city boundary</span></span>
<span id="cb22-19"><a href="#cb22-19"></a>robbery_gistar <span class="ot">&lt;-</span> robbery <span class="sc">|&gt;</span> </span>
<span id="cb22-20"><a href="#cb22-20"></a>  <span class="fu">hotspot_gistar</span>(<span class="at">cell_size =</span> <span class="dv">100</span>, <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-21"><a href="#cb22-21"></a>  <span class="fu">filter</span>(gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-22"><a href="#cb22-22"></a>  <span class="fu">st_intersection</span>(nottingham_wards)</span>
<span id="cb22-23"><a href="#cb22-23"></a></span>
<span id="cb22-24"><a href="#cb22-24"></a></span>
<span id="cb22-25"><a href="#cb22-25"></a><span class="co"># Plot map ---------------------------------------------------------------------</span></span>
<span id="cb22-26"><a href="#cb22-26"></a></span>
<span id="cb22-27"><a href="#cb22-27"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb22-28"><a href="#cb22-28"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb22-29"><a href="#cb22-29"></a>  <span class="co"># Add density for significant cells</span></span>
<span id="cb22-30"><a href="#cb22-30"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb22-31"><a href="#cb22-31"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb22-32"><a href="#cb22-32"></a>    <span class="at">data =</span> robbery_gistar, </span>
<span id="cb22-33"><a href="#cb22-33"></a>    <span class="at">alpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb22-34"><a href="#cb22-34"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb22-35"><a href="#cb22-35"></a>  ) <span class="sc">+</span></span>
<span id="cb22-36"><a href="#cb22-36"></a>  <span class="co"># Add ward boundaries</span></span>
<span id="cb22-37"><a href="#cb22-37"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> nottingham_wards, <span class="at">colour =</span> <span class="st">"grey70"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb22-38"><a href="#cb22-38"></a>  <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb22-39"><a href="#cb22-39"></a>    <span class="at">low =</span> <span class="fu">rgb</span>(<span class="fl">0.8</span>, <span class="fl">0.8</span>, <span class="dv">1</span>), </span>
<span id="cb22-40"><a href="#cb22-40"></a>    <span class="at">high =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb22-41"><a href="#cb22-41"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(robbery_gistar, kde)),</span>
<span id="cb22-42"><a href="#cb22-42"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>)</span>
<span id="cb22-43"><a href="#cb22-43"></a>  ) <span class="sc">+</span></span>
<span id="cb22-44"><a href="#cb22-44"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb22-45"><a href="#cb22-45"></a>  <span class="fu">labs</span>(</span>
<span id="cb22-46"><a href="#cb22-46"></a>      <span class="at">title =</span> <span class="st">"Nottingham robbery hotspots"</span>,</span>
<span id="cb22-47"><a href="#cb22-47"></a>      <span class="at">subtitle =</span> <span class="fu">str_glue</span>(</span>
<span id="cb22-48"><a href="#cb22-48"></a>        <span class="st">"density of robbery in places with more violence than expected by "</span>,</span>
<span id="cb22-49"><a href="#cb22-49"></a>        <span class="st">"chance"</span></span>
<span id="cb22-50"><a href="#cb22-50"></a>      ),</span>
<span id="cb22-51"><a href="#cb22-51"></a>      <span class="co"># Don't forget to add the licence statement -- it's a legal requirement!</span></span>
<span id="cb22-52"><a href="#cb22-52"></a>      <span class="at">caption =</span> <span class="fu">str_glue</span>(</span>
<span id="cb22-53"><a href="#cb22-53"></a>        <span class="st">"Contains public sector information licensed under the Open "</span>,</span>
<span id="cb22-54"><a href="#cb22-54"></a>        <span class="st">"Government Licence v3.0. Map data from OpenStreetMap."</span></span>
<span id="cb22-55"><a href="#cb22-55"></a>      ),</span>
<span id="cb22-56"><a href="#cb22-56"></a>      <span class="at">fill =</span> <span class="fu">str_wrap</span>(<span class="st">"density of robbery at significant hotspots, 2022"</span>, <span class="dv">15</span>)</span>
<span id="cb22-57"><a href="#cb22-57"></a>  ) <span class="sc">+</span></span>
<span id="cb22-58"><a href="#cb22-58"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb22-59"><a href="#cb22-59"></a>  <span class="fu">theme</span>(</span>
<span id="cb22-60"><a href="#cb22-60"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey40"</span>, <span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb22-61"><a href="#cb22-61"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">6</span>, <span class="at">b =</span> <span class="dv">6</span>)),</span>
<span id="cb22-62"><a href="#cb22-62"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey50"</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>)</span>
<span id="cb22-63"><a href="#cb22-63"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Rows: 555 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): location, lsoa_code
dbl  (2): longitude, latitude
date (1): month

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Check your knowledge: Revision questions
</div>
</div>
<div class="callout-body-container callout-body">
<p>Answer these questions to check you have understood the main points covered in this chapter. Write between 50 and 100 words to answer each question.</p>
<ol type="1">
<li>What are crime hotspots, and why are they important in crime analysis?</li>
<li>How do chronic and acute crime hotspots differ?</li>
<li>Why should hotspot analysis focus on small geographic areas rather than larger administrative regions?</li>
<li>What is dual kernel density estimation (dual KDE), and how does it improve crime hotspot analysis?</li>
<li>How can crime hotspot maps be used to inform crime prevention strategies?</li>
</ol>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";
  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    btn.onclick = check_func;
    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../10_place_data/index.html" class="pagination-link" aria-label="Using data about places">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../12_messy_data/index.html" class="pagination-link" aria-label="Handling messy data">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb25" data-shortcodes="false" data-code-line-numbers=""><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb25-1"><a href="#cb25-1"></a><span class="co">---</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="an">execute:</span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="co">  freeze: auto</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="co">---</span></span>
<span id="cb25-5"><a href="#cb25-5"></a></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="fu"># Mapping hotspots {#sec-mapping-hotspots}</span></span>
<span id="cb25-7"><a href="#cb25-7"></a></span>
<span id="cb25-8"><a href="#cb25-8"></a></span>
<span id="cb25-9"><a href="#cb25-9"></a>::: {.abstract}</span>
<span id="cb25-10"><a href="#cb25-10"></a>This chapter introduces the concept of crime hotspots and their significance in crime analysis. You will learn how to define hotspots, understand their different types, and explore why crime tends to cluster in specific areas. Using R, we will demonstrate methods to map hotspots effectively, helping to visualize high-risk areas. The chapter also covers techniques such as dual kernel density estimation to measure crime risk. By the end, you will have practical skills to create crime hotspot maps, aiding in data-driven decision-making for crime prevention and law enforcement strategies.</span>
<span id="cb25-11"><a href="#cb25-11"></a>:::</span>
<span id="cb25-12"><a href="#cb25-12"></a></span>
<span id="cb25-13"><a href="#cb25-13"></a></span>
<span id="cb25-14"><a href="#cb25-14"></a></span>
<span id="cb25-15"><a href="#cb25-15"></a><span class="fu">## What is a hotspot?</span></span>
<span id="cb25-16"><a href="#cb25-16"></a></span>
<span id="cb25-17"><a href="#cb25-17"></a>Crime is heavily concentrated in several different ways. A small number of offenders commit a large proportion of crime (even though most people commit minor offences occasionally) and a small number of people are repeatedly victimised. For most types of crime, a large proportion of crime occurs in a small number of places. **A hotspot is a specific location or small area where an unusual amount of criminal activity occurs**.</span>
<span id="cb25-18"><a href="#cb25-18"></a></span>
<span id="cb25-19"><a href="#cb25-19"></a>Crime hotspots can occur in several different forms. Watch this video to understand why hotspots are important in understanding and responding to crime.</span>
<span id="cb25-20"><a href="#cb25-20"></a></span>
<span id="cb25-21"><a href="#cb25-21"></a>{{&lt; video https://youtu.be/ug-ZhvvQjmw &gt;}}</span>
<span id="cb25-22"><a href="#cb25-22"></a></span>
<span id="cb25-23"><a href="#cb25-23"></a>Some places are *chronic* hotspots -- they have more crime than surrounding areas over a sustained period (which may appear to be permanent). Chronic hotspots are often generated by a facility that draws vulnerable people into an area, such as a tourist attraction that draws crowds of people who are vulnerable to pickpocketing. Other places are *acute* hotspots, in which crime increases in a place that previously experienced no or few crimes. This may be the result of some change in the environment or how it's managed, such as new management that ignores drug dealing at a bar that the previous owners would have not tolerated.</span>
<span id="cb25-24"><a href="#cb25-24"></a></span>
<span id="cb25-25"><a href="#cb25-25"></a>When analysing hotspots, it is best to focus on *small* areas such as an apartment block, a shopping centre, a park or a single street. Focusing on smaller areas is important because resources to respond to crime are almost always limited, so it is important that those resources are directed where the problem is worst. </span>
<span id="cb25-26"><a href="#cb25-26"></a></span>
<span id="cb25-27"><a href="#cb25-27"></a>Analysing larger areas, such as a neighbourhood or a police sector, is much more difficult because larger areas are always made up of many smaller areas, each of which might be quite different from one another. This means that the factors causing one street to be a hotspot might be quite different from the factors that make another street in the same district into a hotspot. Conflating different problems with different causes makes it much harder to find effective ways to reduce crime in any one place. </span>
<span id="cb25-28"><a href="#cb25-28"></a></span>
<span id="cb25-29"><a href="#cb25-29"></a>These difficulties can be avoided (at least partly) by keeping hotspots small: in an urban area, a useful rule of thumb is that you should be able to stand in the middle of a hotspot and see the whole hotspot area.</span>
<span id="cb25-30"><a href="#cb25-30"></a></span>
<span id="cb25-31"><a href="#cb25-31"></a>Being able to identify hotspots using crime mapping is important because it forms a vital first step in many place-focused responses to crime. As an example of this, watch this video about how police in Philadelphia worked with researchers to use crime mapping to identify where to deploy foot patrols to reduce crime.</span>
<span id="cb25-32"><a href="#cb25-32"></a></span>
<span id="cb25-33"><a href="#cb25-33"></a></span>
<span id="cb25-34"><a href="#cb25-34"></a>{{&lt; video https://youtu.be/0NUQsK0vnnM &gt;}}</span>
<span id="cb25-35"><a href="#cb25-35"></a></span>
<span id="cb25-36"><a href="#cb25-36"></a></span>
<span id="cb25-37"><a href="#cb25-37"></a>In this chapter we will learn how to make maps that could be useful in identifying and responding to hotspots of crime. As an example, we will create this map showing hotspots of robbery in Nottingham, England.</span>
<span id="cb25-38"><a href="#cb25-38"></a></span>
<span id="cb25-39"><a href="#cb25-39"></a></span>
<span id="cb25-40"><a href="#cb25-40"></a><span class="in">```{r make-robbery-map, eval=FALSE, echo=FALSE}</span></span>
<span id="cb25-41"><a href="#cb25-41"></a><span class="in"># This dataset is not loaded above, so we load it here</span></span>
<span id="cb25-42"><a href="#cb25-42"></a><span class="in">nottingham &lt;- read_sf("https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg") |&gt; </span></span>
<span id="cb25-43"><a href="#cb25-43"></a><span class="in">  st_transform("EPSG:27700")</span></span>
<span id="cb25-44"><a href="#cb25-44"></a></span>
<span id="cb25-45"><a href="#cb25-45"></a><span class="in">robbery_gi &lt;- robbery |&gt; </span></span>
<span id="cb25-46"><a href="#cb25-46"></a><span class="in">  hotspot_gistar(cell_size = 100, bandwidth_adjust = 0.25) |&gt; </span></span>
<span id="cb25-47"><a href="#cb25-47"></a><span class="in">  filter(gistar &gt; 0, pvalue &lt; 0.05) |&gt; </span></span>
<span id="cb25-48"><a href="#cb25-48"></a><span class="in">  st_intersection(nottingham)</span></span>
<span id="cb25-49"><a href="#cb25-49"></a></span>
<span id="cb25-50"><a href="#cb25-50"></a><span class="in">nottingham_robbery_map &lt;- ggplot() + </span></span>
<span id="cb25-51"><a href="#cb25-51"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb25-52"><a href="#cb25-52"></a><span class="in">  geom_sf(</span></span>
<span id="cb25-53"><a href="#cb25-53"></a><span class="in">    aes(fill = kde), </span></span>
<span id="cb25-54"><a href="#cb25-54"></a><span class="in">    data = robbery_gi, </span></span>
<span id="cb25-55"><a href="#cb25-55"></a><span class="in">    alpha = 0.8,</span></span>
<span id="cb25-56"><a href="#cb25-56"></a><span class="in">    colour = NA</span></span>
<span id="cb25-57"><a href="#cb25-57"></a><span class="in">  ) +</span></span>
<span id="cb25-58"><a href="#cb25-58"></a><span class="in">  geom_sf(data = nottingham, colour = "grey70", fill = NA) +</span></span>
<span id="cb25-59"><a href="#cb25-59"></a><span class="in">  scale_fill_gradient(</span></span>
<span id="cb25-60"><a href="#cb25-60"></a><span class="in">    low = "lightblue",</span></span>
<span id="cb25-61"><a href="#cb25-61"></a><span class="in">    high = "darkblue",</span></span>
<span id="cb25-62"><a href="#cb25-62"></a><span class="in">    breaks = range(pull(robbery_gi, kde)),</span></span>
<span id="cb25-63"><a href="#cb25-63"></a><span class="in">    labels = c("lower", "higher")</span></span>
<span id="cb25-64"><a href="#cb25-64"></a><span class="in">  ) +</span></span>
<span id="cb25-65"><a href="#cb25-65"></a><span class="in">  fixed_plot_aspect() +</span></span>
<span id="cb25-66"><a href="#cb25-66"></a><span class="in">  labs(</span></span>
<span id="cb25-67"><a href="#cb25-67"></a><span class="in">      title = "Nottingham robbery hotspots",</span></span>
<span id="cb25-68"><a href="#cb25-68"></a><span class="in">      subtitle = str_glue(</span></span>
<span id="cb25-69"><a href="#cb25-69"></a><span class="in">        "density of robbery in places with more violence than expected by ",</span></span>
<span id="cb25-70"><a href="#cb25-70"></a><span class="in">        "chance"</span></span>
<span id="cb25-71"><a href="#cb25-71"></a><span class="in">      ),</span></span>
<span id="cb25-72"><a href="#cb25-72"></a><span class="in">      # Don't forget to add the licence statement -- it's a legal requirement!</span></span>
<span id="cb25-73"><a href="#cb25-73"></a><span class="in">      caption = str_wrap(</span></span>
<span id="cb25-74"><a href="#cb25-74"></a><span class="in">        str_glue(</span></span>
<span id="cb25-75"><a href="#cb25-75"></a><span class="in">          "Contains public sector information licensed under the Open ",</span></span>
<span id="cb25-76"><a href="#cb25-76"></a><span class="in">          "Government Licence v3.0. Map data from OpenStreetMap."</span></span>
<span id="cb25-77"><a href="#cb25-77"></a><span class="in">        ),</span></span>
<span id="cb25-78"><a href="#cb25-78"></a><span class="in">        width = 60</span></span>
<span id="cb25-79"><a href="#cb25-79"></a><span class="in">      ),</span></span>
<span id="cb25-80"><a href="#cb25-80"></a><span class="in">      fill = str_wrap("density of robbery at significant hotspots, 2022", 15)</span></span>
<span id="cb25-81"><a href="#cb25-81"></a><span class="in">  ) +</span></span>
<span id="cb25-82"><a href="#cb25-82"></a><span class="in">  theme_void() +</span></span>
<span id="cb25-83"><a href="#cb25-83"></a><span class="in">  theme(</span></span>
<span id="cb25-84"><a href="#cb25-84"></a><span class="in">    legend.text = element_text(size = rel(0.7)),</span></span>
<span id="cb25-85"><a href="#cb25-85"></a><span class="in">    legend.title = element_text(size = rel(0.8)),</span></span>
<span id="cb25-86"><a href="#cb25-86"></a><span class="in">    plot.caption = element_text(colour = "grey40", hjust = 0),</span></span>
<span id="cb25-87"><a href="#cb25-87"></a><span class="in">    plot.subtitle = element_text(margin = margin(t = 6, b = 6), size = rel(0.7)),</span></span>
<span id="cb25-88"><a href="#cb25-88"></a><span class="in">    plot.title = element_text(colour = "grey50", face = "bold", size = rel(1.2))</span></span>
<span id="cb25-89"><a href="#cb25-89"></a><span class="in">  )</span></span>
<span id="cb25-90"><a href="#cb25-90"></a></span>
<span id="cb25-91"><a href="#cb25-91"></a><span class="in">ggsave(</span></span>
<span id="cb25-92"><a href="#cb25-92"></a><span class="in">  here::here("images/nottingham_robbery_map.jpg"), </span></span>
<span id="cb25-93"><a href="#cb25-93"></a><span class="in">  nottingham_robbery_map,</span></span>
<span id="cb25-94"><a href="#cb25-94"></a><span class="in">  width = 900 / 150,</span></span>
<span id="cb25-95"><a href="#cb25-95"></a><span class="in">  height = 800 / 150,</span></span>
<span id="cb25-96"><a href="#cb25-96"></a><span class="in">  dpi = 150</span></span>
<span id="cb25-97"><a href="#cb25-97"></a><span class="in">)</span></span>
<span id="cb25-98"><a href="#cb25-98"></a><span class="in">```</span></span>
<span id="cb25-99"><a href="#cb25-99"></a></span>
<span id="cb25-100"><a href="#cb25-100"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/nottingham_robbery_map.jpg" alt="A hotspot map of robberies in Nottingham"&gt;&lt;/p&gt;</span>
<span id="cb25-101"><a href="#cb25-101"></a></span>
<span id="cb25-102"><a href="#cb25-102"></a></span>
<span id="cb25-103"><a href="#cb25-103"></a>::: {.callout-quiz .callout}</span>
<span id="cb25-104"><a href="#cb25-104"></a></span>
<span id="cb25-105"><a href="#cb25-105"></a><span class="fu">#### Crime hotspots</span></span>
<span id="cb25-106"><a href="#cb25-106"></a></span>
<span id="cb25-107"><a href="#cb25-107"></a><span class="in">```{r why-maps-quiz}</span></span>
<span id="cb25-108"><a href="#cb25-108"></a><span class="in">#| echo: false</span></span>
<span id="cb25-109"><a href="#cb25-109"></a></span>
<span id="cb25-110"><a href="#cb25-110"></a><span class="in">hotspot_quiz1 &lt;- c(</span></span>
<span id="cb25-111"><a href="#cb25-111"></a><span class="in">  "Crime is extremely geographically concentrated – we can expect half of crime to be concentrated in about 1% of micro places",</span></span>
<span id="cb25-112"><a href="#cb25-112"></a><span class="in">  answer = "Crime is very geographically concentrated – we can expect half of crime to be concentrated in about 5% of micro places",</span></span>
<span id="cb25-113"><a href="#cb25-113"></a><span class="in">  "Crime is slightly geographically concentrated – we can expect half of crime to be concentrated in about one quarter of micro places",</span></span>
<span id="cb25-114"><a href="#cb25-114"></a><span class="in">  "Crime is usually not geographically concentrated at micro places"</span></span>
<span id="cb25-115"><a href="#cb25-115"></a><span class="in">)</span></span>
<span id="cb25-116"><a href="#cb25-116"></a><span class="in">```</span></span>
<span id="cb25-117"><a href="#cb25-117"></a></span>
<span id="cb25-118"><a href="#cb25-118"></a>**Which one of these statements is true?**</span>
<span id="cb25-119"><a href="#cb25-119"></a></span>
<span id="cb25-120"><a href="#cb25-120"></a><span class="in">`r webexercises::longmcq(hotspot_quiz1)`</span></span>
<span id="cb25-121"><a href="#cb25-121"></a></span>
<span id="cb25-122"><a href="#cb25-122"></a></span>
<span id="cb25-123"><a href="#cb25-123"></a>:::</span>
<span id="cb25-124"><a href="#cb25-124"></a></span>
<span id="cb25-125"><a href="#cb25-125"></a></span>
<span id="cb25-126"><a href="#cb25-126"></a><span class="fu">## Showing the density of risk</span></span>
<span id="cb25-127"><a href="#cb25-127"></a></span>
<span id="cb25-128"><a href="#cb25-128"></a>In @sec-mapping-area-data we learned how to produce maps showing the *incidence rate* of crime by dividing the number of crimes by a measure of the population at risk of being targeted. We will often only have population estimates for areas, such as census estimates of the number of people living in an area. But for some crimes we have access to estimates of the people (or, more often, objects) at risk of being a target of a particular crime. In these cases, we can produce better maps of the risk of crime in different areas by producing a *dual KDE* map that shows the density of crime *risk* in different places.</span>
<span id="cb25-129"><a href="#cb25-129"></a></span>
<span id="cb25-130"><a href="#cb25-130"></a>To create a dual KDE map, we must estimate the density of crime and compare it to an estimate the density of the population at risk. Since an incidence rate is calculated as the number of crimes divided by the number of people or objects at risk, we can calculate the density of risk by dividing the density of crime estimated for each cell in the grid by the density of population estimated for the same cell. The <span class="in">`hotspot_dual_kde()`</span> function from the sfhotspot package does this for us.</span>
<span id="cb25-131"><a href="#cb25-131"></a></span>
<span id="cb25-132"><a href="#cb25-132"></a>To illustrate making a dual KDE map, we will use reports of burglaries in three wards in Nottingham in 2020. Since the essential element of the crime of burglary in England is that an offender enters a _building_ as a trespasser in order to steal something, the best measure of the population at risk of burglary is the number of _buildings_ in each area (the definition of burglary is more complicated than this, but we don't need to worry about that here). </span>
<span id="cb25-133"><a href="#cb25-133"></a></span>
<span id="cb25-134"><a href="#cb25-134"></a></span>
<span id="cb25-135"><a href="#cb25-135"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb25-136"><a href="#cb25-136"></a><span class="fu">#### What's the difference between theft, burglary and robbery?</span></span>
<span id="cb25-137"><a href="#cb25-137"></a></span>
<span id="cb25-138"><a href="#cb25-138"></a>Definitions of crime vary between countries. But theft (sometimes called _larceny_) is usually defined as the act of dishonestly taking property belonging to another person while intending to keep (not just borrow) the property or treat it as the offender's own. Shoplifting, bike theft, car theft and pickpocketing are all types of theft.</span>
<span id="cb25-139"><a href="#cb25-139"></a></span>
<span id="cb25-140"><a href="#cb25-140"></a>Burglary and robbery are both special types of theft. A burglary is a theft committed inside a building that the offender does not have the owner's permission to be in. The most obvious type of burglary is when an offender breaks into a victim's home and steals valuables from inside. But burglary can also be committed in non-residential buildings: some types of business are frequent targets of burglary.</span>
<span id="cb25-141"><a href="#cb25-141"></a></span>
<span id="cb25-142"><a href="#cb25-142"></a>A robbery is a theft in which the offender uses violence or the threat of violence against the victim. It is important to remember that burglary and robbery are separate crimes. Since robbery requires (the threat of) violence against a person, robbery risk is usually described in terms of the number of robberies for a certain number of _people_. Burglary, on the other hand, can only take place in a building, so burglary risk is usually described in terms of the number of burglaries for a certain number of _premises_.</span>
<span id="cb25-143"><a href="#cb25-143"></a>:::</span>
<span id="cb25-144"><a href="#cb25-144"></a></span>
<span id="cb25-145"><a href="#cb25-145"></a></span>
<span id="cb25-146"><a href="#cb25-146"></a>Burglary is a good example of why the routine activities approach to thinking about crime that we introduced in @sec-getting-started emphasises thinking about _targets_ of crime rather than focusing only on crime _victims_. In the case of burglary, one person might be the owner of a large number of buildings (e.g. a farm with lots of out-buildings) or lots of people might own a single building (such as a house converted into flats). By thinking about the targets that are attacked by offenders, we can identify that burglary rates should be calculated based on buildings rather than, for example, residential population. Note that if our crime data only included _residential_ burglaries then we would want to use _residential_ buildings as our denominator, but in this case we have data for all burglaries, both residential and non-residential.</span>
<span id="cb25-147"><a href="#cb25-147"></a></span>
<span id="cb25-148"><a href="#cb25-148"></a></span>
<span id="cb25-149"><a href="#cb25-149"></a><span class="fu">### Data wrangling</span></span>
<span id="cb25-150"><a href="#cb25-150"></a></span>
<span id="cb25-151"><a href="#cb25-151"></a>Before we can create our dual KDE layer, we have to complete some data wrangling. We will extract the boundaries for the wards of interest from a dataset of boundaries for all wards in Nottingham using <span class="in">`filter()`</span> as we have done previously. To extract only the burglaries occurring in those three wards from a dataset of all burglaries in Nottingham, we will use <span class="in">`st_intersection()`</span>. We will also transform both datasets to use the British National Grid (EPSG:27700), since we will need to do that anyway before calculating the KDE values.</span>
<span id="cb25-152"><a href="#cb25-152"></a></span>
<span id="cb25-153"><a href="#cb25-153"></a>Open RStudio and make sure you are working within the project you created in @sec-create-project. Create a new R script file and save it as <span class="in">`chapter11a.R`</span>. Paste the following code into that file and run it.</span>
<span id="cb25-154"><a href="#cb25-154"></a></span>
<span id="cb25-155"><a href="#cb25-155"></a></span>
<span id="cb25-158"><a href="#cb25-158"></a><span class="in">```{r}</span></span>
<span id="cb25-159"><a href="#cb25-159"></a><span class="co">#| eval: false</span></span>
<span id="cb25-160"><a href="#cb25-160"></a><span class="co">#| filename: "chapter11a.R"</span></span>
<span id="cb25-161"><a href="#cb25-161"></a></span>
<span id="cb25-162"><a href="#cb25-162"></a><span class="co"># Load packages</span></span>
<span id="cb25-163"><a href="#cb25-163"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggspatial, osmdata, sf, sfhotspot, tidyverse)</span>
<span id="cb25-164"><a href="#cb25-164"></a></span>
<span id="cb25-165"><a href="#cb25-165"></a><span class="co"># Load dataset of wards in Nottingham and choose the ones we want</span></span>
<span id="cb25-166"><a href="#cb25-166"></a>wards <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-167"><a href="#cb25-167"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-168"><a href="#cb25-168"></a>  <span class="fu">filter</span>(ward_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Castle"</span>, <span class="st">"Lenton &amp; Wollaton East"</span>, <span class="st">"Meadows"</span>))</span>
<span id="cb25-169"><a href="#cb25-169"></a></span>
<span id="cb25-170"><a href="#cb25-170"></a><span class="co"># Load dataset of burglaries and keep only those in the wards of interest</span></span>
<span id="cb25-171"><a href="#cb25-171"></a>burglaries <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_burglary.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-172"><a href="#cb25-172"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-173"><a href="#cb25-173"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-174"><a href="#cb25-174"></a>  <span class="fu">st_intersection</span>(wards)</span>
<span id="cb25-175"><a href="#cb25-175"></a><span class="in">```</span></span>
<span id="cb25-176"><a href="#cb25-176"></a></span>
<span id="cb25-177"><a href="#cb25-177"></a></span>
<span id="cb25-180"><a href="#cb25-180"></a><span class="in">```{r}</span></span>
<span id="cb25-181"><a href="#cb25-181"></a><span class="co">#| include: false</span></span>
<span id="cb25-182"><a href="#cb25-182"></a></span>
<span id="cb25-183"><a href="#cb25-183"></a><span class="co"># Load packages</span></span>
<span id="cb25-184"><a href="#cb25-184"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggspatial, osmdata, sf, sfhotspot, tidyverse)</span>
<span id="cb25-185"><a href="#cb25-185"></a></span>
<span id="cb25-186"><a href="#cb25-186"></a><span class="co"># Load dataset of wards in Nottingham and choose the ones we want</span></span>
<span id="cb25-187"><a href="#cb25-187"></a>wards <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-188"><a href="#cb25-188"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-189"><a href="#cb25-189"></a>  <span class="fu">filter</span>(ward_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Castle"</span>, <span class="st">"Lenton &amp; Wollaton East"</span>, <span class="st">"Meadows"</span>))</span>
<span id="cb25-190"><a href="#cb25-190"></a></span>
<span id="cb25-191"><a href="#cb25-191"></a><span class="co"># Load dataset of burglaries and keep only those in the wards of interest</span></span>
<span id="cb25-192"><a href="#cb25-192"></a>burglaries <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_burglary.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-193"><a href="#cb25-193"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-194"><a href="#cb25-194"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-195"><a href="#cb25-195"></a>  <span class="fu">st_intersection</span>(wards)</span>
<span id="cb25-196"><a href="#cb25-196"></a><span class="in">```</span></span>
<span id="cb25-197"><a href="#cb25-197"></a></span>
<span id="cb25-198"><a href="#cb25-198"></a></span>
<span id="cb25-199"><a href="#cb25-199"></a>We do not have a source of open data for all the buildings in Nottingham, so we will use the osmdata package to get the locations of buildings from OpenStreetMap (OSM). You may remember from @sec-place-data that to do this we need to know which key (and possibly value) the OSM database uses for storing the locations of buildings. The OSM feature key for a building is 'building' and it is not necessary to specify a value (since we want to capture all types of building). The osmdata package expects data to use the WGS84 co-ordinate reference system, so we must also make sure any data sources we use are </span>
<span id="cb25-200"><a href="#cb25-200"></a>projected using that system (EPSG:4326).</span>
<span id="cb25-201"><a href="#cb25-201"></a></span>
<span id="cb25-202"><a href="#cb25-202"></a>Add this code to your R script and run it.</span>
<span id="cb25-203"><a href="#cb25-203"></a></span>
<span id="cb25-206"><a href="#cb25-206"></a><span class="in">```{r}</span></span>
<span id="cb25-207"><a href="#cb25-207"></a><span class="co">#| filename: "chapter11a.R"</span></span>
<span id="cb25-208"><a href="#cb25-208"></a></span>
<span id="cb25-209"><a href="#cb25-209"></a>nottingham_buildings <span class="ot">&lt;-</span> wards <span class="sc">|&gt;</span> </span>
<span id="cb25-210"><a href="#cb25-210"></a>  <span class="co"># Transform ward boundaries to CRS needed by `opq()`</span></span>
<span id="cb25-211"><a href="#cb25-211"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-212"><a href="#cb25-212"></a>  <span class="co"># Calculate bounding box</span></span>
<span id="cb25-213"><a href="#cb25-213"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb25-214"><a href="#cb25-214"></a>  <span class="co"># Set up OSM query</span></span>
<span id="cb25-215"><a href="#cb25-215"></a>  <span class="fu">opq</span>() <span class="sc">|&gt;</span> </span>
<span id="cb25-216"><a href="#cb25-216"></a>  <span class="co"># Add type of feature to fetch</span></span>
<span id="cb25-217"><a href="#cb25-217"></a>  <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"building"</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-218"><a href="#cb25-218"></a>  <span class="co"># Fetch features from OSM database</span></span>
<span id="cb25-219"><a href="#cb25-219"></a>  <span class="fu">osmdata_sf</span>()</span>
<span id="cb25-220"><a href="#cb25-220"></a><span class="in">```</span></span>
<span id="cb25-221"><a href="#cb25-221"></a></span>
<span id="cb25-222"><a href="#cb25-222"></a></span>
<span id="cb25-223"><a href="#cb25-223"></a>Let's look at the content of the <span class="in">`nottingham_buildings`</span> object:</span>
<span id="cb25-224"><a href="#cb25-224"></a></span>
<span id="cb25-225"><a href="#cb25-225"></a></span>
<span id="cb25-228"><a href="#cb25-228"></a><span class="in">```{r}</span></span>
<span id="cb25-229"><a href="#cb25-229"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb25-230"><a href="#cb25-230"></a></span>
<span id="cb25-231"><a href="#cb25-231"></a>nottingham_buildings</span>
<span id="cb25-232"><a href="#cb25-232"></a><span class="in">```</span></span>
<span id="cb25-233"><a href="#cb25-233"></a></span>
<span id="cb25-234"><a href="#cb25-234"></a></span>
<span id="cb25-235"><a href="#cb25-235"></a>Looking at the <span class="in">`nottingham_buildings`</span> object, we can see that OSM contains data on buildings stored as points, polygons and multipolygons (we can ignore the few linestrings tagged as buildings, since it doesn't make sense for a building to be represented as a line rather than a point or a polygon). </span>
<span id="cb25-236"><a href="#cb25-236"></a></span>
<span id="cb25-237"><a href="#cb25-237"></a></span>
<span id="cb25-238"><a href="#cb25-238"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb25-239"><a href="#cb25-239"></a><span class="fu">#### What is a multipolygon?</span></span>
<span id="cb25-240"><a href="#cb25-240"></a></span>
<span id="cb25-241"><a href="#cb25-241"></a>OpenStreetMap stores features in several different ways. The most basic types are points, lines and polygons. But there are also multipolygons (and multilines). These are features that represent complex structures such as clusters of buildings that are separate structures but are related to each other. For example, a hospital with several buildings might be represented in OpenStreetMap as a single multipolygon feature. A multipolygon might also be used to represent complex building shapes such as buildings with a courtyard or light well in the middle.</span>
<span id="cb25-242"><a href="#cb25-242"></a>:::</span>
<span id="cb25-243"><a href="#cb25-243"></a></span>
<span id="cb25-244"><a href="#cb25-244"></a></span>
<span id="cb25-245"><a href="#cb25-245"></a>Let's create a simple map of the results produced by <span class="in">`osmdata_sf()`</span>, comparing them to the buildings shown on a base map to check that OSM has reasonable coverage of the buildings in these three wards. This code uses the <span class="in">`pluck()`</span> function from the purrr package (part of the tidyverse) to extract the different elements from the <span class="in">`nottingham_buildings`</span> object.</span>
<span id="cb25-246"><a href="#cb25-246"></a></span>
<span id="cb25-247"><a href="#cb25-247"></a></span>
<span id="cb25-250"><a href="#cb25-250"></a><span class="in">```{r}</span></span>
<span id="cb25-251"><a href="#cb25-251"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb25-252"><a href="#cb25-252"></a><span class="co">#| fig-asp: 1</span></span>
<span id="cb25-253"><a href="#cb25-253"></a><span class="co">#| out-width: "100%"</span></span>
<span id="cb25-254"><a href="#cb25-254"></a></span>
<span id="cb25-255"><a href="#cb25-255"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb25-256"><a href="#cb25-256"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb25-257"><a href="#cb25-257"></a>  <span class="co"># Add building features stored as points</span></span>
<span id="cb25-258"><a href="#cb25-258"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb25-259"><a href="#cb25-259"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_points"</span>), </span>
<span id="cb25-260"><a href="#cb25-260"></a>    <span class="at">colour =</span> <span class="st">"green"</span>,</span>
<span id="cb25-261"><a href="#cb25-261"></a>    <span class="at">size =</span> <span class="fl">0.1</span></span>
<span id="cb25-262"><a href="#cb25-262"></a>  ) <span class="sc">+</span></span>
<span id="cb25-263"><a href="#cb25-263"></a>  <span class="co"># Add building features stored as polygons</span></span>
<span id="cb25-264"><a href="#cb25-264"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb25-265"><a href="#cb25-265"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_polygons"</span>), </span>
<span id="cb25-266"><a href="#cb25-266"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb25-267"><a href="#cb25-267"></a>    <span class="at">fill =</span> <span class="st">"blue"</span></span>
<span id="cb25-268"><a href="#cb25-268"></a>  ) <span class="sc">+</span> </span>
<span id="cb25-269"><a href="#cb25-269"></a>  <span class="co"># Add building features stored as multi-polygons</span></span>
<span id="cb25-270"><a href="#cb25-270"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb25-271"><a href="#cb25-271"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_multipolygons"</span>), </span>
<span id="cb25-272"><a href="#cb25-272"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb25-273"><a href="#cb25-273"></a>    <span class="at">fill =</span> <span class="st">"darkred"</span></span>
<span id="cb25-274"><a href="#cb25-274"></a>  ) <span class="sc">+</span></span>
<span id="cb25-275"><a href="#cb25-275"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="at">colour =</span> <span class="st">"red"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">1.25</span>) <span class="sc">+</span></span>
<span id="cb25-276"><a href="#cb25-276"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb25-277"><a href="#cb25-277"></a><span class="in">```</span></span>
<span id="cb25-278"><a href="#cb25-278"></a></span>
<span id="cb25-279"><a href="#cb25-279"></a></span>
<span id="cb25-280"><a href="#cb25-280"></a>::: {.callout-important}</span>
<span id="cb25-281"><a href="#cb25-281"></a><span class="fu">#### `osmdata_sf()` returns data for a bounding box</span></span>
<span id="cb25-282"><a href="#cb25-282"></a></span>
<span id="cb25-283"><a href="#cb25-283"></a>Remember that <span class="in">`osmdata_sf()`</span> gets OSM data for the area covered by the _bounding box_ of the input feature, not the feature boundaries. This means some of the buildings returned by the code above will be outside the wards we are interested in. We will deal with that shortly.</span>
<span id="cb25-284"><a href="#cb25-284"></a></span>
<span id="cb25-285"><a href="#cb25-285"></a>:::</span>
<span id="cb25-286"><a href="#cb25-286"></a></span>
<span id="cb25-287"><a href="#cb25-287"></a></span>
<span id="cb25-288"><a href="#cb25-288"></a>It looks like almost all the streets in the three wards we are interested in are lined with buildings in the OSM data, which is what we would expect of streets in an urban area. There are some streets without buildings in the top-left of the map, but these streets are outside our three wards so this does not matter.</span>
<span id="cb25-289"><a href="#cb25-289"></a></span>
<span id="cb25-290"><a href="#cb25-290"></a>We can also see from this map that the <span class="in">`r scales::comma(nrow(pluck(nottingham_buildings, "osm_points")))`</span> point features in the OSM data (shown as green dots on the map) typically represent the corners of buildings that are also represented as polygons, so we know we can ignore the points layer within the OSM data.</span>
<span id="cb25-291"><a href="#cb25-291"></a></span>
<span id="cb25-292"><a href="#cb25-292"></a>Since the <span class="in">`hotspot_dual_kde()`</span> function works on points, we need to convert the polygon and multipolygon layers to points by calculating their centroids, then merge the two layers together. This will generate a warning that <span class="in">`st_centroid does not give correct centroids for longitude/latitude data`</span> but we can ignore this because the calculated centroids will be good enough for our purposes (if we wanted to, we could transform the data to use the British National Grid, calculate the centroids and then transform it back).</span>
<span id="cb25-293"><a href="#cb25-293"></a></span>
<span id="cb25-294"><a href="#cb25-294"></a>Since we are only interested in those buildings in three particular wards, we can also at this stage remove any buildings that are outside those wards using <span class="in">`st_intersection()`</span>, as we have already done for the <span class="in">`burglaries`</span> object. Since the <span class="in">`wards`</span> object uses the British National Grid and <span class="in">`st_intersection()`</span> requires both datasets to use the same co-ordinate system, we will transform the building centroids before clipping them.</span>
<span id="cb25-295"><a href="#cb25-295"></a></span>
<span id="cb25-296"><a href="#cb25-296"></a>Add this code to the <span class="in">`chapter11a.R`</span> file and run it.</span>
<span id="cb25-297"><a href="#cb25-297"></a></span>
<span id="cb25-300"><a href="#cb25-300"></a><span class="in">```{r}</span></span>
<span id="cb25-301"><a href="#cb25-301"></a><span class="co">#| filename: "chapter11a.R"</span></span>
<span id="cb25-302"><a href="#cb25-302"></a></span>
<span id="cb25-303"><a href="#cb25-303"></a><span class="co"># Extract polygon/multipolygon layers and combine them into a single object</span></span>
<span id="cb25-304"><a href="#cb25-304"></a>nottingham_building_centroids <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb25-305"><a href="#cb25-305"></a>  <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_polygons"</span>), </span>
<span id="cb25-306"><a href="#cb25-306"></a>  <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_multipolygons"</span>)</span>
<span id="cb25-307"><a href="#cb25-307"></a>) <span class="sc">|&gt;</span></span>
<span id="cb25-308"><a href="#cb25-308"></a>  <span class="co"># Convert polygons to points</span></span>
<span id="cb25-309"><a href="#cb25-309"></a>  <span class="fu">st_centroid</span>() <span class="sc">|&gt;</span> </span>
<span id="cb25-310"><a href="#cb25-310"></a>  <span class="co"># Transform to same CRS as `wards` object</span></span>
<span id="cb25-311"><a href="#cb25-311"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-312"><a href="#cb25-312"></a>  <span class="co"># Remove any points outside the wards of interest</span></span>
<span id="cb25-313"><a href="#cb25-313"></a>  <span class="fu">st_intersection</span>(wards)</span>
<span id="cb25-314"><a href="#cb25-314"></a><span class="in">```</span></span>
<span id="cb25-315"><a href="#cb25-315"></a></span>
<span id="cb25-316"><a href="#cb25-316"></a></span>
<span id="cb25-317"><a href="#cb25-317"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb25-318"><a href="#cb25-318"></a><span class="fu">#### What does the warning `st_centroid assumes …` mean?</span></span>
<span id="cb25-319"><a href="#cb25-319"></a></span>
<span id="cb25-320"><a href="#cb25-320"></a>You might have seen a warning saying <span class="in">`st_centroid assumes attributes are constant over geometries of x`</span>. You will see this warning when you use the <span class="in">`st_centroid()`</span> function. It is there to remind you that columns in the original data (which the SF package refers to as the _attributes_ associated with each spatial feature) refer to the polygon as a whole, but in the object produced by <span class="in">`st_centroid()`</span> it will appear that the columns relate to the centroid point. In many cases this will not be a problem, but it could expose you to the ecological fallacy so it is sometimes useful to be reminded.</span>
<span id="cb25-321"><a href="#cb25-321"></a>:::</span>
<span id="cb25-322"><a href="#cb25-322"></a></span>
<span id="cb25-323"><a href="#cb25-323"></a></span>
<span id="cb25-324"><a href="#cb25-324"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb25-325"><a href="#cb25-325"></a><span class="fu">#### What does the warning `attribute variables are assumed …` mean?</span></span>
<span id="cb25-326"><a href="#cb25-326"></a></span>
<span id="cb25-327"><a href="#cb25-327"></a><span class="in">`st_intersection()`</span> produces a warning message whenever it is used:</span>
<span id="cb25-328"><a href="#cb25-328"></a></span>
<span id="cb25-329"><a href="#cb25-329"></a><span class="in">```</span></span>
<span id="cb25-330"><a href="#cb25-330"></a><span class="in">Warning: attribute variables are assumed to be spatially constant throughout all geometries</span></span>
<span id="cb25-331"><a href="#cb25-331"></a><span class="in">```</span></span>
<span id="cb25-332"><a href="#cb25-332"></a></span>
<span id="cb25-333"><a href="#cb25-333"></a>As long as you are simply using <span class="in">`st_intersection()`</span> to remove parts of the data outside a boundary, you can ignore this message.</span>
<span id="cb25-334"><a href="#cb25-334"></a>:::</span>
<span id="cb25-335"><a href="#cb25-335"></a></span>
<span id="cb25-336"><a href="#cb25-336"></a></span>
<span id="cb25-337"><a href="#cb25-337"></a><span class="fu">### Calculating dual kernel density</span></span>
<span id="cb25-338"><a href="#cb25-338"></a></span>
<span id="cb25-339"><a href="#cb25-339"></a>We now have the object <span class="in">`burglaries`</span> that contains the locations of each burglary in the three Nottingham wards that we are interested in, and the object <span class="in">`nottingham_building_centroids`</span> that contains the centroids of each building in those three wards. We can use these layers to estimate the density of burglaries and buildings, then combine these to estimate the density of burglary risk.</span>
<span id="cb25-340"><a href="#cb25-340"></a></span>
<span id="cb25-341"><a href="#cb25-341"></a><span class="in">`hotspot_dual_kde()`</span> works in the same way as <span class="in">`hotspot_kde()`</span>, except that it requires two datasets. In this case, that means one dataset of crime locations and one dataset of building locations. <span class="in">`hotspot_dual_kde()`</span> will set the cell size and bandwidth automatically, but we can set them manually using the <span class="in">`cell_size`</span>, <span class="in">`bandwidth_adjust`</span> and <span class="in">`grid`</span> arguments in the same way we have done for <span class="in">`hotspot_kde()`</span>. In this case, we will use the <span class="in">`hotspot_grid()`</span> helper function to create a grid based on the boundaries of the wards we are interested in. All the spatial objects we are going to use here have co-ordinates specified using the British National Grid because we have already transformed them, so we do not need to do any transformation here.</span>
<span id="cb25-342"><a href="#cb25-342"></a></span>
<span id="cb25-343"><a href="#cb25-343"></a></span>
<span id="cb25-346"><a href="#cb25-346"></a><span class="in">```{r}</span></span>
<span id="cb25-347"><a href="#cb25-347"></a><span class="co">#| filename: "chapter11a.R"</span></span>
<span id="cb25-348"><a href="#cb25-348"></a></span>
<span id="cb25-349"><a href="#cb25-349"></a><span class="co"># Estimate density of burglary risk</span></span>
<span id="cb25-350"><a href="#cb25-350"></a>burglary_risk <span class="ot">&lt;-</span> <span class="fu">hotspot_dual_kde</span>(</span>
<span id="cb25-351"><a href="#cb25-351"></a>  burglaries, </span>
<span id="cb25-352"><a href="#cb25-352"></a>  nottingham_building_centroids, </span>
<span id="cb25-353"><a href="#cb25-353"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, </span>
<span id="cb25-354"><a href="#cb25-354"></a>  <span class="at">grid =</span> <span class="fu">hotspot_grid</span>(wards, <span class="at">cell_size =</span> <span class="dv">100</span>),</span>
<span id="cb25-355"><a href="#cb25-355"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb25-356"><a href="#cb25-356"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb25-357"><a href="#cb25-357"></a>  <span class="fu">st_intersection</span>(wards)</span>
<span id="cb25-358"><a href="#cb25-358"></a><span class="in">```</span></span>
<span id="cb25-359"><a href="#cb25-359"></a></span>
<span id="cb25-360"><a href="#cb25-360"></a></span>
<span id="cb25-361"><a href="#cb25-361"></a>The <span class="in">`burglary_risk`</span> object looks like this:</span>
<span id="cb25-362"><a href="#cb25-362"></a></span>
<span id="cb25-363"><a href="#cb25-363"></a></span>
<span id="cb25-366"><a href="#cb25-366"></a><span class="in">```{r}</span></span>
<span id="cb25-367"><a href="#cb25-367"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb25-368"><a href="#cb25-368"></a></span>
<span id="cb25-369"><a href="#cb25-369"></a><span class="fu">head</span>(burglary_risk)</span>
<span id="cb25-370"><a href="#cb25-370"></a><span class="in">```</span></span>
<span id="cb25-371"><a href="#cb25-371"></a></span>
<span id="cb25-372"><a href="#cb25-372"></a></span>
<span id="cb25-373"><a href="#cb25-373"></a>You might recall from earlier in this chapter that the value of the <span class="in">`kde`</span> column in the object produced by <span class="in">`hotspot_dual_kde()`</span> is calculated by dividing the density of burglary in each grid cell by the density of buildings in the same grid cell. There are two cases where this will produce a result that is not a finite number:</span>
<span id="cb25-374"><a href="#cb25-374"></a></span>
<span id="cb25-375"><a href="#cb25-375"></a><span class="ss">  * </span>If, for a particular cell, the density of burglaries and density of buildings are both zero, dividing one by the other will produce the result <span class="in">`NaN`</span>, for 'not a number'.</span>
<span id="cb25-376"><a href="#cb25-376"></a><span class="ss">  * </span>If the density of burglaries is greater than zero but the density of buildings is exactly zero, the result will be <span class="in">`Inf`</span>, for 'infinite'.</span>
<span id="cb25-377"><a href="#cb25-377"></a></span>
<span id="cb25-378"><a href="#cb25-378"></a>Since it is not possible to calculate burglary risk in either of those cases, we can exclude these cases from the <span class="in">`burglary_risk`</span> object by using <span class="in">`filter()`</span> together with the <span class="in">`is.finite()`</span> function (R does not count <span class="in">`NaN`</span> as a finite number):</span>
<span id="cb25-379"><a href="#cb25-379"></a></span>
<span id="cb25-382"><a href="#cb25-382"></a><span class="in">```{r}</span></span>
<span id="cb25-383"><a href="#cb25-383"></a><span class="co">#| filename: "chapter11a.R"</span></span>
<span id="cb25-384"><a href="#cb25-384"></a></span>
<span id="cb25-385"><a href="#cb25-385"></a>burglary_risk_filtered <span class="ot">&lt;-</span> <span class="fu">filter</span>(burglary_risk, <span class="fu">is.finite</span>(kde))</span>
<span id="cb25-386"><a href="#cb25-386"></a><span class="in">```</span></span>
<span id="cb25-387"><a href="#cb25-387"></a></span>
<span id="cb25-388"><a href="#cb25-388"></a>You might wonder why we didn't simply add <span class="in">`filter()`</span> to the existing pipeline that creates the <span class="in">`burglary_risk`</span> object. It is because we will need the unfiltered object in the next section of this chapter, but in your own code it will be better to add <span class="in">`filter(is.finite(kde))`</span> to the pipeline after <span class="in">`st_intersection()`</span>. But for now …</span>
<span id="cb25-389"><a href="#cb25-389"></a></span>
<span id="cb25-390"><a href="#cb25-390"></a>We can plot the estimate of the density of burglary risk. By controlling for the density of buildings, this map shows us where building owners *on average* face the highest risk of being burgled. This might be useful in working out, for example, which building owners should be offered visits from a crime-prevention advisor or funding to install crime-prevention measures.</span>
<span id="cb25-391"><a href="#cb25-391"></a></span>
<span id="cb25-392"><a href="#cb25-392"></a>Add this code to your script file and run it to produce a map:</span>
<span id="cb25-393"><a href="#cb25-393"></a></span>
<span id="cb25-394"><a href="#cb25-394"></a></span>
<span id="cb25-397"><a href="#cb25-397"></a><span class="in">```{r}</span></span>
<span id="cb25-398"><a href="#cb25-398"></a><span class="co">#| filename: "chapter11a.R"</span></span>
<span id="cb25-399"><a href="#cb25-399"></a><span class="co">#| fig-asp: 1</span></span>
<span id="cb25-400"><a href="#cb25-400"></a><span class="co">#| out-width: "100%"</span></span>
<span id="cb25-401"><a href="#cb25-401"></a></span>
<span id="cb25-402"><a href="#cb25-402"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb25-403"><a href="#cb25-403"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb25-404"><a href="#cb25-404"></a>  <span class="co"># Add burglary risk layer</span></span>
<span id="cb25-405"><a href="#cb25-405"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb25-406"><a href="#cb25-406"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb25-407"><a href="#cb25-407"></a>    <span class="at">data =</span> burglary_risk_filtered, </span>
<span id="cb25-408"><a href="#cb25-408"></a>    <span class="at">alpha =</span> <span class="fl">0.8</span>, </span>
<span id="cb25-409"><a href="#cb25-409"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb25-410"><a href="#cb25-410"></a>  ) <span class="sc">+</span></span>
<span id="cb25-411"><a href="#cb25-411"></a>  <span class="co"># Add ward boundaries</span></span>
<span id="cb25-412"><a href="#cb25-412"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span> </span>
<span id="cb25-413"><a href="#cb25-413"></a>  <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb25-414"><a href="#cb25-414"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(burglary_risk_filtered, <span class="st">"kde"</span>)),</span>
<span id="cb25-415"><a href="#cb25-415"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>),</span>
<span id="cb25-416"><a href="#cb25-416"></a>    <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb25-417"><a href="#cb25-417"></a>  ) <span class="sc">+</span></span>
<span id="cb25-418"><a href="#cb25-418"></a>  <span class="fu">labs</span>(</span>
<span id="cb25-419"><a href="#cb25-419"></a>      <span class="at">title =</span> <span class="st">"Burglary risk in south-west Nottingham"</span>,</span>
<span id="cb25-420"><a href="#cb25-420"></a>      <span class="at">subtitle =</span> <span class="fu">str_glue</span>(</span>
<span id="cb25-421"><a href="#cb25-421"></a>        <span class="st">"dual kernel density of burglary risk in Castle, Lenton &amp; Wollaton "</span>,</span>
<span id="cb25-422"><a href="#cb25-422"></a>        <span class="st">"East and Meadows wards"</span></span>
<span id="cb25-423"><a href="#cb25-423"></a>      ),</span>
<span id="cb25-424"><a href="#cb25-424"></a>      <span class="at">caption =</span> <span class="fu">str_glue</span>(</span>
<span id="cb25-425"><a href="#cb25-425"></a>        <span class="st">"Contains public sector information licensed under the Open "</span>,</span>
<span id="cb25-426"><a href="#cb25-426"></a>        <span class="st">"Government Licence v3.0"</span></span>
<span id="cb25-427"><a href="#cb25-427"></a>      ),</span>
<span id="cb25-428"><a href="#cb25-428"></a>      <span class="at">fill =</span> <span class="st">"density of burglary risk, 2020"</span></span>
<span id="cb25-429"><a href="#cb25-429"></a>  ) <span class="sc">+</span></span>
<span id="cb25-430"><a href="#cb25-430"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb25-431"><a href="#cb25-431"></a>  <span class="fu">theme</span>(</span>
<span id="cb25-432"><a href="#cb25-432"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb25-433"><a href="#cb25-433"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey40"</span>),</span>
<span id="cb25-434"><a href="#cb25-434"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">6</span>, <span class="at">b =</span> <span class="dv">6</span>)),</span>
<span id="cb25-435"><a href="#cb25-435"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey50"</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>)</span>
<span id="cb25-436"><a href="#cb25-436"></a>  )</span>
<span id="cb25-437"><a href="#cb25-437"></a><span class="in">```</span></span>
<span id="cb25-438"><a href="#cb25-438"></a></span>
<span id="cb25-439"><a href="#cb25-439"></a></span>
<span id="cb25-440"><a href="#cb25-440"></a>You might think this map looks strange: almost all the burglary risk seems to be concentrated in one grid cell on the left-hand side of the map. This illustrates one of the limitations of grid-based approaches to understanding the concentration of crime in different places. The northern half of the Lenton &amp; Wollaton East Ward (the western-most of the three wards shown on this map) is home to the University of Nottingham main campus. This campus consists of dozens of separate buildings, each of which could be burgled. But when a university building is burgled and that is reported to the police, the police record that crime as having happened at the university's main administration building (because that is the postal address of the university). This means that while all the burglaries occurring over a large area are recorded as occurring in one grid cell, the corresponding building centroids are spread out over a large number of grid cells. That means when we calculate the incidence rate of burglary for this map, we get an inaccurate picture.</span>
<span id="cb25-441"><a href="#cb25-441"></a></span>
<span id="cb25-442"><a href="#cb25-442"></a>Whenever you use police-recorded data -- or any other administrative data collected by a government agency -- it is important to think about how that data was collected and what limitations it may have. There are some common issues that you should look out for when dealing with police-recorded crime locations:</span>
<span id="cb25-443"><a href="#cb25-443"></a></span>
<span id="cb25-444"><a href="#cb25-444"></a><span class="ss">* </span>Assaults that are disclosed by people attending hospital for their injuries are sometimes recorded as having occurred at the hospital (since that's where police have been called to) rather than at the actual location they occurred.</span>
<span id="cb25-445"><a href="#cb25-445"></a><span class="ss">* </span>Drugs and weapons discovered when arrested people are searched at the police station are sometimes recorded as illegal possession of drugs/weapons at the station, rather than at the location where the person was first stopped by police.</span>
<span id="cb25-446"><a href="#cb25-446"></a><span class="ss">* </span>Crimes on public transport are sometimes recorded as having occurred at the nearest station, or at station where the victim ended their journey, rather than at the location where they actually occurred.</span>
<span id="cb25-447"><a href="#cb25-447"></a></span>
<span id="cb25-448"><a href="#cb25-448"></a>If we wanted to understand burglary risk on the University of Nottingham campus, it would probably be necessary to use a different dataset (for example using records kept by the university security department).</span>
<span id="cb25-449"><a href="#cb25-449"></a></span>
<span id="cb25-450"><a href="#cb25-450"></a></span>
<span id="cb25-451"><a href="#cb25-451"></a>::: {.callout-quiz .callout}</span>
<span id="cb25-452"><a href="#cb25-452"></a><span class="fu">### Dual kernel density</span></span>
<span id="cb25-453"><a href="#cb25-453"></a></span>
<span id="cb25-454"><a href="#cb25-454"></a><span class="in">```{r dual-kde-quiz}</span></span>
<span id="cb25-455"><a href="#cb25-455"></a><span class="in">#| echo: false</span></span>
<span id="cb25-456"><a href="#cb25-456"></a></span>
<span id="cb25-457"><a href="#cb25-457"></a><span class="in">dual_kde_quiz1 &lt;- c(</span></span>
<span id="cb25-458"><a href="#cb25-458"></a><span class="in">    "`hotspot_dual_kde()` can work on any co-ordinates, whether they use a geographic co-ordinate system (i.e. longitude and latitude) or a projected system.",</span></span>
<span id="cb25-459"><a href="#cb25-459"></a><span class="in">    answer = "`hotspot_dual_kde()` requires co-ordinates to use a projected co-ordinate system (i.e. not longitude and latitude).",</span></span>
<span id="cb25-460"><a href="#cb25-460"></a><span class="in">    "`hotspot_dual_kde()` requires co-ordinates to use a geographic co-ordinate system (i.e. longitude and latitude).",</span></span>
<span id="cb25-461"><a href="#cb25-461"></a><span class="in">    "`hotspot_dual_kde()` does not work with co-ordinates, so it does not matter which type of co-ordinate system a dataset uses."</span></span>
<span id="cb25-462"><a href="#cb25-462"></a><span class="in">)</span></span>
<span id="cb25-463"><a href="#cb25-463"></a></span>
<span id="cb25-464"><a href="#cb25-464"></a><span class="in">dual_kde_quiz2 &lt;- c(</span></span>
<span id="cb25-465"><a href="#cb25-465"></a><span class="in">    "To make our maps look nicer.",</span></span>
<span id="cb25-466"><a href="#cb25-466"></a><span class="in">    "To transform the co-ordinate system our data uses from the system `hotspot_dual_kde()` uses to the one we need to produce a map.",</span></span>
<span id="cb25-467"><a href="#cb25-467"></a><span class="in">    answer = "To eliminate any areas that we do not have data for, since displaying KDE values for such areas on a map might be misleading.",</span></span>
<span id="cb25-468"><a href="#cb25-468"></a><span class="in">    "To make it easier to see the other layers on our map."</span></span>
<span id="cb25-469"><a href="#cb25-469"></a><span class="in">)</span></span>
<span id="cb25-470"><a href="#cb25-470"></a><span class="in">```</span></span>
<span id="cb25-471"><a href="#cb25-471"></a></span>
<span id="cb25-472"><a href="#cb25-472"></a></span>
<span id="cb25-473"><a href="#cb25-473"></a>**Which *one* of these statements is true?**</span>
<span id="cb25-474"><a href="#cb25-474"></a></span>
<span id="cb25-475"><a href="#cb25-475"></a><span class="in">`r webexercises::longmcq(dual_kde_quiz1)`</span></span>
<span id="cb25-476"><a href="#cb25-476"></a></span>
<span id="cb25-477"><a href="#cb25-477"></a></span>
<span id="cb25-478"><a href="#cb25-478"></a>**Why do we usually clip the result of `hotspot_dual_kde()` using `st_intersection()`?**</span>
<span id="cb25-479"><a href="#cb25-479"></a></span>
<span id="cb25-480"><a href="#cb25-480"></a><span class="in">`r webexercises::longmcq(dual_kde_quiz2)`</span></span>
<span id="cb25-481"><a href="#cb25-481"></a></span>
<span id="cb25-482"><a href="#cb25-482"></a></span>
<span id="cb25-483"><a href="#cb25-483"></a>:::</span>
<span id="cb25-484"><a href="#cb25-484"></a></span>
<span id="cb25-485"><a href="#cb25-485"></a></span>
<span id="cb25-486"><a href="#cb25-486"></a></span>
<span id="cb25-487"><a href="#cb25-487"></a><span class="fu">## Finding hotspots</span></span>
<span id="cb25-488"><a href="#cb25-488"></a></span>
<span id="cb25-489"><a href="#cb25-489"></a>We now know how to produce a better map of the density of crime in different areas. But how do we know which areas count as hotspots and which don't? </span>
<span id="cb25-490"><a href="#cb25-490"></a></span>
<span id="cb25-491"><a href="#cb25-491"></a></span>
<span id="cb25-492"><a href="#cb25-492"></a><span class="co">&lt;!--</span></span>
<span id="cb25-493"><a href="#cb25-493"></a></span>
<span id="cb25-494"><a href="#cb25-494"></a><span class="co">There are several ways to answer this question. If we were planning a particular activity to respond to a crime problem, we might know what resources we had available to respond. For example, we might know that we have enough funding to provide crime-prevention visits to 100 locations. In that case, we can order the cells in a KDE object according to which have the highest estimates of risk, then count all the premises in each cell until we have reached our limit.</span></span>
<span id="cb25-495"><a href="#cb25-495"></a></span>
<span id="cb25-496"><a href="#cb25-496"></a><span class="co">To do this, we need to know how many buildings are in each grid cell (we already know how many burglaries occurred in each grid cell -- that value is in the `n` column of the `burglary_risk` object). We have already learned how to count crimes in areas when we learned about mapping area data. When we want to count crimes in each cell in a grid, we can use the `hotspot_count()` function from the `sfhotspot` package to count the number of buildings in each grid cell. We will then be able to combine those building counts to the estimates of burglary risk we have already calculated.</span></span>
<span id="cb25-497"><a href="#cb25-497"></a></span>
<span id="cb25-498"><a href="#cb25-498"></a></span>
<span id="cb25-499"><a href="#cb25-499"></a><span class="co">::: {.callout-important}</span></span>
<span id="cb25-500"><a href="#cb25-500"></a></span>
<span id="cb25-501"><a href="#cb25-501"></a><span class="co">So that we can join the building counts to the burglary risk estimates, it is important that both layers are based on the same grid. In the code above we created a grid with the code `hotspot_grid(wards, cell_size = 100)`, so to make sure we use the same grid to count buildings we can either use that same code again, or we could have saved the result of that code as an object (maybe called `nottingham_wards_grid`) and then provided that object to the `grid` argument of both `hotspot_dual_kde()` and `hotspot_count()`.</span></span>
<span id="cb25-502"><a href="#cb25-502"></a></span>
<span id="cb25-503"><a href="#cb25-503"></a><span class="co">Note that the results of `hotspot_dual_kde()` and `hotspot_count()` will only have the same structure before we wrangle then any further, for example by using `filter()` as in the previous section. That is why we saved an unfiltered version of the dataset in the `burglary_risk` object.</span></span>
<span id="cb25-504"><a href="#cb25-504"></a><span class="co">:::</span></span>
<span id="cb25-505"><a href="#cb25-505"></a></span>
<span id="cb25-506"><a href="#cb25-506"></a></span>
<span id="cb25-509"><a href="#cb25-509"></a><span class="in">```{r}</span></span>
<span id="cb25-510"><a href="#cb25-510"></a><span class="co">#| warning: false</span></span>
<span id="cb25-511"><a href="#cb25-511"></a><span class="co">#| filename: "chapter11a.R"</span></span>
<span id="cb25-512"><a href="#cb25-512"></a></span>
<span id="cb25-513"><a href="#cb25-513"></a><span class="co"># Count number of buildings in each grid cell</span></span>
<span id="cb25-514"><a href="#cb25-514"></a><span class="co">building_counts &lt;- hotspot_count(</span></span>
<span id="cb25-515"><a href="#cb25-515"></a><span class="co">  nottingham_building_centroids, </span></span>
<span id="cb25-516"><a href="#cb25-516"></a><span class="co">  grid = hotspot_grid(wards, cell_size = 100)</span></span>
<span id="cb25-517"><a href="#cb25-517"></a><span class="co">) |&gt; </span></span>
<span id="cb25-518"><a href="#cb25-518"></a><span class="co">  # Clip the result to the area for which we have data</span></span>
<span id="cb25-519"><a href="#cb25-519"></a><span class="co">  st_intersection(wards)</span></span>
<span id="cb25-520"><a href="#cb25-520"></a><span class="co">```</span></span>
<span id="cb25-521"><a href="#cb25-521"></a></span>
<span id="cb25-522"><a href="#cb25-522"></a></span>
<span id="cb25-523"><a href="#cb25-523"></a><span class="co">The `building_counts` and `burglary_risk` objects have the same structure: each row represents a cell in the same grid, and the rows are in the same order (because both grids were created by identical calls to `hotspot_grid()`). This means we can combine the two objects using the `bind_cols()` function from the dplyr package (part of the tidyverse). </span></span>
<span id="cb25-524"><a href="#cb25-524"></a></span>
<span id="cb25-525"><a href="#cb25-525"></a></span>
<span id="cb25-528"><a href="#cb25-528"></a><span class="in">```{r}</span></span>
<span id="cb25-529"><a href="#cb25-529"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb25-530"><a href="#cb25-530"></a></span>
<span id="cb25-531"><a href="#cb25-531"></a><span class="co"># Combine burglary and building counts</span></span>
<span id="cb25-532"><a href="#cb25-532"></a><span class="co">burglary_risk_bldg &lt;- bind_cols(burglary_risk, building_counts)</span></span>
<span id="cb25-533"><a href="#cb25-533"></a><span class="co">```</span></span>
<span id="cb25-534"><a href="#cb25-534"></a></span>
<span id="cb25-535"><a href="#cb25-535"></a></span>
<span id="cb25-538"><a href="#cb25-538"></a><span class="in">```{r}</span></span>
<span id="cb25-539"><a href="#cb25-539"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb25-540"><a href="#cb25-540"></a></span>
<span id="cb25-541"><a href="#cb25-541"></a><span class="co">head(burglary_risk_bldg)</span></span>
<span id="cb25-542"><a href="#cb25-542"></a><span class="co">```</span></span>
<span id="cb25-543"><a href="#cb25-543"></a></span>
<span id="cb25-544"><a href="#cb25-544"></a></span>
<span id="cb25-545"><a href="#cb25-545"></a><span class="co">Looking at this object, we can see that `bind_cols()` has changed the column names. This is because some of the column names were duplicated across the two datasets. Some of these new column names, such as `ward_code...3` would be difficult to work with, so lets go back and remove duplicate columns before we combine the two datasets together.</span></span>
<span id="cb25-546"><a href="#cb25-546"></a></span>
<span id="cb25-547"><a href="#cb25-547"></a></span>
<span id="cb25-548"><a href="#cb25-548"></a><span class="co">```{r count-exercise3, exercise=TRUE}</span></span>
<span id="cb25-549"><a href="#cb25-549"></a><span class="co">#| filename: "chapter11a.R"</span></span>
<span id="cb25-550"><a href="#cb25-550"></a></span>
<span id="cb25-551"><a href="#cb25-551"></a><span class="co">burglary_risk_bldg &lt;- burglary_risk |&gt; </span></span>
<span id="cb25-552"><a href="#cb25-552"></a><span class="co">  # Keep only the `n` and `kde` columns, renaming `n` to `burglary_count`</span></span>
<span id="cb25-553"><a href="#cb25-553"></a><span class="co">  # because there is also a column called `n` in the `building_counts` object</span></span>
<span id="cb25-554"><a href="#cb25-554"></a><span class="co">  select(burglary_count = n, kde) |&gt; </span></span>
<span id="cb25-555"><a href="#cb25-555"></a><span class="co">  # Remove the geometry column (since an identical one exists in </span></span>
<span id="cb25-556"><a href="#cb25-556"></a><span class="co">  # `building_counts`). Note that we do this separately because we can't use</span></span>
<span id="cb25-557"><a href="#cb25-557"></a><span class="co">  # `select()` to remove the `geometry` column.</span></span>
<span id="cb25-558"><a href="#cb25-558"></a><span class="co">  st_drop_geometry() |&gt; </span></span>
<span id="cb25-559"><a href="#cb25-559"></a><span class="co">  bind_cols(building_counts) |&gt; </span></span>
<span id="cb25-560"><a href="#cb25-560"></a><span class="co">  # Give the building-count column a better name</span></span>
<span id="cb25-561"><a href="#cb25-561"></a><span class="co">  rename(building_count = n) |&gt; </span></span>
<span id="cb25-562"><a href="#cb25-562"></a><span class="co">  # After calling `bind_cols()` it is safe to use `filter()` to wrangle the</span></span>
<span id="cb25-563"><a href="#cb25-563"></a><span class="co">  # data</span></span>
<span id="cb25-564"><a href="#cb25-564"></a><span class="co">  filter(is.finite(kde))</span></span>
<span id="cb25-565"><a href="#cb25-565"></a><span class="co">```</span></span>
<span id="cb25-566"><a href="#cb25-566"></a></span>
<span id="cb25-567"><a href="#cb25-567"></a></span>
<span id="cb25-568"><a href="#cb25-568"></a><span class="co">We can now order the dataset with the cells with highest burglary risk at the top and calculate the *cumulative total* (also called a running total) of buildings using the `cumsum()` ('cumulative sum') function. We can use this running total to find the 100 buildings in the cells with highest burglary risk.</span></span>
<span id="cb25-569"><a href="#cb25-569"></a></span>
<span id="cb25-570"><a href="#cb25-570"></a></span>
<span id="cb25-573"><a href="#cb25-573"></a><span class="in">```{r}</span></span>
<span id="cb25-574"><a href="#cb25-574"></a><span class="co">#| filename: "chapter11a.R"</span></span>
<span id="cb25-575"><a href="#cb25-575"></a></span>
<span id="cb25-576"><a href="#cb25-576"></a><span class="co">cells_for_prevention &lt;- burglary_risk_bldg |&gt; </span></span>
<span id="cb25-577"><a href="#cb25-577"></a><span class="co">  # Arrange cells from highest to lowest burglary risk</span></span>
<span id="cb25-578"><a href="#cb25-578"></a><span class="co">  arrange(desc(kde)) |&gt; </span></span>
<span id="cb25-579"><a href="#cb25-579"></a><span class="co">  # Count the number of buildings in a cell and all the cells with higher </span></span>
<span id="cb25-580"><a href="#cb25-580"></a><span class="co">  # burglary risk than that cell</span></span>
<span id="cb25-581"><a href="#cb25-581"></a><span class="co">  mutate(sum_buildings = cumsum(building_count)) |&gt; </span></span>
<span id="cb25-582"><a href="#cb25-582"></a><span class="co">  # Keep only those cells that contain the first 100 buildings</span></span>
<span id="cb25-583"><a href="#cb25-583"></a><span class="co">  filter(sum_buildings &lt; 100)</span></span>
<span id="cb25-584"><a href="#cb25-584"></a><span class="co">```</span></span>
<span id="cb25-585"><a href="#cb25-585"></a></span>
<span id="cb25-586"><a href="#cb25-586"></a></span>
<span id="cb25-587"><a href="#cb25-587"></a><span class="co">We could now plot the `cells_for_prevention` object on a map to show the grid cells containing the buildings that would receive the crime-prevention visits. We could also use `st_intersection()` to identify those rows in the dataset of buildings in the `nottingham_building_centroids` object that were in the top grid cells, which would give us a list of buildings to visit.</span></span>
<span id="cb25-588"><a href="#cb25-588"></a></span>
<span id="cb25-589"><a href="#cb25-589"></a></span>
<span id="cb25-590"><a href="#cb25-590"></a><span class="al">###</span><span class="co"> Distinguishing hotspots from random variation</span></span>
<span id="cb25-591"><a href="#cb25-591"></a></span>
<span id="cb25-592"><a href="#cb25-592"></a><span class="co">--&gt;</span></span>
<span id="cb25-593"><a href="#cb25-593"></a></span>
<span id="cb25-594"><a href="#cb25-594"></a></span>
<span id="cb25-595"><a href="#cb25-595"></a>Each of the 16 density maps below show density estimates based on 1,000 points placed completely at random on 16 different maps. There are no real patterns in the data except for statistical noise. Nevertheless, the KDE process makes it appear that there are patterns in the data.</span>
<span id="cb25-596"><a href="#cb25-596"></a></span>
<span id="cb25-597"><a href="#cb25-597"></a></span>
<span id="cb25-598"><a href="#cb25-598"></a><span class="in">```{r random-map}</span></span>
<span id="cb25-599"><a href="#cb25-599"></a><span class="in">#| echo: false</span></span>
<span id="cb25-600"><a href="#cb25-600"></a><span class="in">#| fig-asp: 1</span></span>
<span id="cb25-601"><a href="#cb25-601"></a><span class="in">#| fig-align: "center"</span></span>
<span id="cb25-602"><a href="#cb25-602"></a></span>
<span id="cb25-603"><a href="#cb25-603"></a><span class="in">tibble(</span></span>
<span id="cb25-604"><a href="#cb25-604"></a><span class="in">  x = runif(n = 1000 * 16, min = 0, max = 100), </span></span>
<span id="cb25-605"><a href="#cb25-605"></a><span class="in">  y = runif(n = 1000 * 16, min = 0, max = 100),</span></span>
<span id="cb25-606"><a href="#cb25-606"></a><span class="in">  group = rep(1:16, each = 1000)</span></span>
<span id="cb25-607"><a href="#cb25-607"></a><span class="in">)  |&gt;  </span></span>
<span id="cb25-608"><a href="#cb25-608"></a><span class="in">  ggplot() + </span></span>
<span id="cb25-609"><a href="#cb25-609"></a><span class="in">  geom_density_2d_filled(aes(x, y), bins = 9) + </span></span>
<span id="cb25-610"><a href="#cb25-610"></a><span class="in">  scale_fill_brewer(</span></span>
<span id="cb25-611"><a href="#cb25-611"></a><span class="in">    labels = c("lower", rep("", 7), "higher"),</span></span>
<span id="cb25-612"><a href="#cb25-612"></a><span class="in">    palette = "Oranges", </span></span>
<span id="cb25-613"><a href="#cb25-613"></a><span class="in">    direction = 1,</span></span>
<span id="cb25-614"><a href="#cb25-614"></a><span class="in">    guide = guide_legend(reverse = TRUE)</span></span>
<span id="cb25-615"><a href="#cb25-615"></a><span class="in">  ) +</span></span>
<span id="cb25-616"><a href="#cb25-616"></a><span class="in">  facet_wrap(vars(group), ncol = 4) +</span></span>
<span id="cb25-617"><a href="#cb25-617"></a><span class="in">  coord_fixed() +</span></span>
<span id="cb25-618"><a href="#cb25-618"></a><span class="in">  labs(fill = "density") +</span></span>
<span id="cb25-619"><a href="#cb25-619"></a><span class="in">  theme_void() +</span></span>
<span id="cb25-620"><a href="#cb25-620"></a><span class="in">  theme(strip.text = element_blank())</span></span>
<span id="cb25-621"><a href="#cb25-621"></a><span class="in">```</span></span>
<span id="cb25-622"><a href="#cb25-622"></a></span>
<span id="cb25-623"><a href="#cb25-623"></a></span>
<span id="cb25-624"><a href="#cb25-624"></a>This is a problem because we might end up responding to an apparent problem that is nothing but an artefact of the random variation that we expect to see in many processes, including crime.</span>
<span id="cb25-625"><a href="#cb25-625"></a></span>
<span id="cb25-626"><a href="#cb25-626"></a>If the police and other agencies looked at these patterns and did nothing in response to them, it is likely that over time some of the areas with high density would become areas of low density, and _vice versa_. However, the harm caused by crime means it is very hard for agencies to justify sitting back and do nothing to respond to it -- many people would consider it immoral to do so. So police and other agencies are very likely to try to respond to crime patterns, even if those patterns might have occurred by chance. This is very frustrating, because if we were to go back and look at the same data in a few months time it is very likely that the apparent hotspots would have shifted to somewhere different, making all the effort spent in responding to crime seem worthless (which, if the apparent patterns were actually artefacts of the KDE process, it may have been).</span>
<span id="cb25-627"><a href="#cb25-627"></a></span>
<span id="cb25-628"><a href="#cb25-628"></a>You might be thinking it's better safe than sorry, and that police should respond to the apparent patterns just in case they represent real concentrations in crime. But police resources are always scarce, so responding to one problem in one place means not responding to another problem in another place. This is known as the _opportunity cost_ of acting: if police focus their limited resources in one area, that comes at the cost of not being able to deploy those resources in other areas that might need it more.</span>
<span id="cb25-629"><a href="#cb25-629"></a></span>
<span id="cb25-630"><a href="#cb25-630"></a>We can try to avoid this problem of wasting resources responding to random variation in crime by determining whether the number of crimes in an area is more than the greatest number we would reasonably expect if there were no actual patterns in the data (if you have studied statistics before, you might recognise this as a description of a *null hypothesis*, but you don't need to have studied statistics to apply the techniques in this course).</span>
<span id="cb25-631"><a href="#cb25-631"></a></span>
<span id="cb25-632"><a href="#cb25-632"></a>To determine if the number of crimes in each area is greater than we would expect by chance, we can use the *Getis-Ord Gi\* statistic* (also called the *local G* statistic, spoken out-loud as the *G-I star statistic*). If the Gi* statistic for an area is greater than a certain value, we can say that the number of crimes in that area is higher than we would expect if there were no patterns in the data. We will call areas with more crimes than we would expect by chance as _hotspots_.</span>
<span id="cb25-633"><a href="#cb25-633"></a></span>
<span id="cb25-634"><a href="#cb25-634"></a>We can calculate the Gi* statistic using the <span class="in">`hotspot_gistar()`</span> function from the sfhotspot package. This works in a similar way to the <span class="in">`hotspot_kde()`</span> function, in that it takes an SF object of the locations of crimes and returns an SF object with a grid of cells, along with the Gi* value for each grid cell. Like <span class="in">`hotspot_kde()`</span>, <span class="in">`hotspot_gistar()`</span> will choose default values for several ways in which we could fine-tune the calculation of the Gi* statistic, but we could over-ride these defaults if we wanted to.</span>
<span id="cb25-635"><a href="#cb25-635"></a></span>
<span id="cb25-636"><a href="#cb25-636"></a>Open a new R script file and save it as <span class="in">`chapter11b.R`</span>.</span>
<span id="cb25-637"><a href="#cb25-637"></a></span>
<span id="cb25-638"><a href="#cb25-638"></a>In this example, we will find the hotspots of robbery in Nottingham in 2020, based on a grid of 100-metre cells. We will store this in an object called <span class="in">`robbery`</span>, transform it to use the British National Grid co-ordinate system (so we can specify the cell size in metres) and then use the resulting object to calculate the Gi* values.</span>
<span id="cb25-639"><a href="#cb25-639"></a></span>
<span id="cb25-640"><a href="#cb25-640"></a>Add this code to the new script file and run it.</span>
<span id="cb25-641"><a href="#cb25-641"></a></span>
<span id="cb25-644"><a href="#cb25-644"></a><span class="in">```{r}</span></span>
<span id="cb25-645"><a href="#cb25-645"></a><span class="co">#| eval: false</span></span>
<span id="cb25-646"><a href="#cb25-646"></a><span class="co">#| filename: "chapter11b.R"</span></span>
<span id="cb25-647"><a href="#cb25-647"></a></span>
<span id="cb25-648"><a href="#cb25-648"></a><span class="co"># Prepare ----------------------------------------------------------------------</span></span>
<span id="cb25-649"><a href="#cb25-649"></a></span>
<span id="cb25-650"><a href="#cb25-650"></a><span class="co"># Load packages</span></span>
<span id="cb25-651"><a href="#cb25-651"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggspatial, sf, sfhotspot, tidyverse)</span>
<span id="cb25-652"><a href="#cb25-652"></a></span>
<span id="cb25-653"><a href="#cb25-653"></a><span class="co"># Load Nottingham robbery data</span></span>
<span id="cb25-654"><a href="#cb25-654"></a>robbery <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-655"><a href="#cb25-655"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-656"><a href="#cb25-656"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb25-657"><a href="#cb25-657"></a></span>
<span id="cb25-658"><a href="#cb25-658"></a></span>
<span id="cb25-659"><a href="#cb25-659"></a><span class="co"># Find significant grid cells --------------------------------------------------</span></span>
<span id="cb25-660"><a href="#cb25-660"></a></span>
<span id="cb25-661"><a href="#cb25-661"></a><span class="co"># Calculate Gi* statistic</span></span>
<span id="cb25-662"><a href="#cb25-662"></a>robbery_gistar <span class="ot">&lt;-</span> <span class="fu">hotspot_gistar</span>(</span>
<span id="cb25-663"><a href="#cb25-663"></a>  robbery, </span>
<span id="cb25-664"><a href="#cb25-664"></a>  <span class="at">cell_size =</span> <span class="dv">100</span>, </span>
<span id="cb25-665"><a href="#cb25-665"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, </span>
<span id="cb25-666"><a href="#cb25-666"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb25-667"><a href="#cb25-667"></a>)</span>
<span id="cb25-668"><a href="#cb25-668"></a><span class="in">```</span></span>
<span id="cb25-669"><a href="#cb25-669"></a></span>
<span id="cb25-672"><a href="#cb25-672"></a><span class="in">```{r}</span></span>
<span id="cb25-673"><a href="#cb25-673"></a><span class="co">#| echo: false</span></span>
<span id="cb25-674"><a href="#cb25-674"></a></span>
<span id="cb25-675"><a href="#cb25-675"></a><span class="co"># Prepare ----------------------------------------------------------------------</span></span>
<span id="cb25-676"><a href="#cb25-676"></a></span>
<span id="cb25-677"><a href="#cb25-677"></a><span class="co"># Load packages</span></span>
<span id="cb25-678"><a href="#cb25-678"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggspatial, sf, sfhotspot, tidyverse)</span>
<span id="cb25-679"><a href="#cb25-679"></a></span>
<span id="cb25-680"><a href="#cb25-680"></a><span class="co"># Load data and transform to British National Grid, which is easier to work with</span></span>
<span id="cb25-681"><a href="#cb25-681"></a><span class="co"># for functions that use spatial units such as metres</span></span>
<span id="cb25-682"><a href="#cb25-682"></a>robbery <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-683"><a href="#cb25-683"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-684"><a href="#cb25-684"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb25-685"><a href="#cb25-685"></a>nottingham_wards <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-686"><a href="#cb25-686"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb25-687"><a href="#cb25-687"></a></span>
<span id="cb25-688"><a href="#cb25-688"></a></span>
<span id="cb25-689"><a href="#cb25-689"></a><span class="co"># Find significant grid cells --------------------------------------------------</span></span>
<span id="cb25-690"><a href="#cb25-690"></a></span>
<span id="cb25-691"><a href="#cb25-691"></a><span class="co"># Calculate Gi* statistic</span></span>
<span id="cb25-692"><a href="#cb25-692"></a>robbery_gistar <span class="ot">&lt;-</span> <span class="fu">hotspot_gistar</span>(</span>
<span id="cb25-693"><a href="#cb25-693"></a>  robbery, </span>
<span id="cb25-694"><a href="#cb25-694"></a>  <span class="at">cell_size =</span> <span class="dv">100</span>, </span>
<span id="cb25-695"><a href="#cb25-695"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, </span>
<span id="cb25-696"><a href="#cb25-696"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb25-697"><a href="#cb25-697"></a>)</span>
<span id="cb25-698"><a href="#cb25-698"></a><span class="in">```</span></span>
<span id="cb25-699"><a href="#cb25-699"></a></span>
<span id="cb25-700"><a href="#cb25-700"></a></span>
<span id="cb25-701"><a href="#cb25-701"></a>Instead of using <span class="in">`head()`</span> to view the first few rows of the object we have just created, let's use <span class="in">`sample_n()`</span> to return a random sample of rows from that object:</span>
<span id="cb25-702"><a href="#cb25-702"></a></span>
<span id="cb25-703"><a href="#cb25-703"></a></span>
<span id="cb25-706"><a href="#cb25-706"></a><span class="in">```{r}</span></span>
<span id="cb25-707"><a href="#cb25-707"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb25-708"><a href="#cb25-708"></a></span>
<span id="cb25-709"><a href="#cb25-709"></a><span class="fu">sample_n</span>(robbery_gistar, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb25-710"><a href="#cb25-710"></a><span class="in">```</span></span>
<span id="cb25-711"><a href="#cb25-711"></a></span>
<span id="cb25-712"><a href="#cb25-712"></a></span>
<span id="cb25-713"><a href="#cb25-713"></a>The <span class="in">`robbery_gistar`</span> object contains one row for each cell in a grid of cells covering the area of the robbery data. Each row has four columns:</span>
<span id="cb25-714"><a href="#cb25-714"></a></span>
<span id="cb25-715"><a href="#cb25-715"></a><span class="ss">  * </span><span class="in">`n`</span> shows the number of robberies that occurred in that grid cell,</span>
<span id="cb25-716"><a href="#cb25-716"></a><span class="ss">  * </span><span class="in">`kde`</span> shows the density of robberies in that cell,</span>
<span id="cb25-717"><a href="#cb25-717"></a><span class="ss">  * </span><span class="in">`gistar`</span> shows the Gi* value for that cell, and</span>
<span id="cb25-718"><a href="#cb25-718"></a><span class="ss">  * </span><span class="in">`pvalue`</span> shows the $p$-value for that cell.</span>
<span id="cb25-719"><a href="#cb25-719"></a></span>
<span id="cb25-720"><a href="#cb25-720"></a>The Gi* statistic is an example of a more general group of statistics called $Z$ *scores*. Statisticians and data analysts compare the $Z$ scores produced by statistical procedures such as `hotspot_gistar()` to reference values to decide if a $Z$ score is large enough to be treated as statistically significant, i.e. if it is large enough to conclude that it is larger than we would expect if there were no actual patterns in the data. Deciding on the right reference value to compare a $Z$ score to can be difficult because of what's known as the multiple comparison problem (which we don't need to go into detail about). Fortunately, the values in the `pvalue` column have already been automatically adjusted to take account of the multiple comparison problem, so we can interpret the $p$-values instead of interpreting the Gi* statistic directly.</span>
<span id="cb25-721"><a href="#cb25-721"></a></span>
<span id="cb25-722"><a href="#cb25-722"></a></span>
<span id="cb25-723"><a href="#cb25-723"></a>::: {.callout-important}</span>
<span id="cb25-724"><a href="#cb25-724"></a><span class="fu">#### Filter data before calcuating Gi* values</span></span>
<span id="cb25-725"><a href="#cb25-725"></a></span>
<span id="cb25-726"><a href="#cb25-726"></a>Since Gi* is a relative measure, if you have data for a large area (e.g. a country) but only want to show data for a smaller area (e.g. a city), the Gi* values will be influenced by the large areas with no crime and all of the city is likely to be identified as a hotspot. To prevent this, it is important to clip the dataset _before_ calculating the Gi* values, as well as then clipping afterwards where necessary.</span>
<span id="cb25-727"><a href="#cb25-727"></a>:::</span>
<span id="cb25-728"><a href="#cb25-728"></a></span>
<span id="cb25-729"><a href="#cb25-729"></a></span>
<span id="cb25-730"><a href="#cb25-730"></a>By convention, $p$-values are considered to be significant if they are _less than 0.05_. So if $p&lt;0.05$, we can say that the number of robberies occurring in a given grid cell is significantly different from zero. Values of Gi* greater than zero indicate cells with more robberies than expected and values of Gi* less than zero indicate cells with fewer robberies than expected. We can combine these two values to find cells with significantly _more_ robberies than expected by chance, which are those cells for which $Z&gt;0$ and $p&lt;0.05$. To put that into R code, we would write <span class="in">`gistar &gt; 0`</span> and <span class="in">`p &lt; 0.05`</span>.</span>
<span id="cb25-731"><a href="#cb25-731"></a></span>
<span id="cb25-732"><a href="#cb25-732"></a>We could use this information in various ways. For example, if we wanted to give local police officers a printed map of which areas to patrol, we could simply show the significant hotspot cells over a base map.</span>
<span id="cb25-733"><a href="#cb25-733"></a></span>
<span id="cb25-734"><a href="#cb25-734"></a></span>
<span id="cb25-735"><a href="#cb25-735"></a><span class="in">```{r hotspot-exercise4, exercise=TRUE, message=FALSE, fig.asp=1, out.width="100%"}</span></span>
<span id="cb25-736"><a href="#cb25-736"></a><span class="in">#| filename: "R Console"</span></span>
<span id="cb25-737"><a href="#cb25-737"></a><span class="in">#| fig-asp: 1</span></span>
<span id="cb25-738"><a href="#cb25-738"></a><span class="in">#| out-width: "100%"</span></span>
<span id="cb25-739"><a href="#cb25-739"></a></span>
<span id="cb25-740"><a href="#cb25-740"></a><span class="in">ggplot() +</span></span>
<span id="cb25-741"><a href="#cb25-741"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb25-742"><a href="#cb25-742"></a><span class="in">  geom_sf(</span></span>
<span id="cb25-743"><a href="#cb25-743"></a><span class="in">    data = filter(robbery_gistar, gistar &gt; 0, pvalue &lt; 0.05), </span></span>
<span id="cb25-744"><a href="#cb25-744"></a><span class="in">    fill = "red", </span></span>
<span id="cb25-745"><a href="#cb25-745"></a><span class="in">    alpha = 0.75,</span></span>
<span id="cb25-746"><a href="#cb25-746"></a><span class="in">    colour = NA</span></span>
<span id="cb25-747"><a href="#cb25-747"></a><span class="in">  ) +</span></span>
<span id="cb25-748"><a href="#cb25-748"></a><span class="in">  fixed_plot_aspect() +</span></span>
<span id="cb25-749"><a href="#cb25-749"></a><span class="in">  theme_void()</span></span>
<span id="cb25-750"><a href="#cb25-750"></a><span class="in">```</span></span>
<span id="cb25-751"><a href="#cb25-751"></a></span>
<span id="cb25-752"><a href="#cb25-752"></a></span>
<span id="cb25-753"><a href="#cb25-753"></a>Since <span class="in">`hotspot_gistar()`</span> also estimates density for each grid cell, we could more usefully show the _density_ of robberies in each cell, but only for cells that the Gi* values showed were significant hotspots.</span>
<span id="cb25-754"><a href="#cb25-754"></a></span>
<span id="cb25-755"><a href="#cb25-755"></a></span>
<span id="cb25-758"><a href="#cb25-758"></a><span class="in">```{r}</span></span>
<span id="cb25-759"><a href="#cb25-759"></a><span class="co">#| filename: "chapter11b.R"</span></span>
<span id="cb25-760"><a href="#cb25-760"></a><span class="co">#| fig-asp: 1</span></span>
<span id="cb25-761"><a href="#cb25-761"></a><span class="co">#| out-width: "100%"</span></span>
<span id="cb25-762"><a href="#cb25-762"></a></span>
<span id="cb25-763"><a href="#cb25-763"></a><span class="co"># Plot map ---------------------------------------------------------------------</span></span>
<span id="cb25-764"><a href="#cb25-764"></a></span>
<span id="cb25-765"><a href="#cb25-765"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb25-766"><a href="#cb25-766"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb25-767"><a href="#cb25-767"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb25-768"><a href="#cb25-768"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde),</span>
<span id="cb25-769"><a href="#cb25-769"></a>    <span class="at">data =</span> <span class="fu">filter</span>(robbery_gistar, gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>), </span>
<span id="cb25-770"><a href="#cb25-770"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>,</span>
<span id="cb25-771"><a href="#cb25-771"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb25-772"><a href="#cb25-772"></a>  ) <span class="sc">+</span></span>
<span id="cb25-773"><a href="#cb25-773"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb25-774"><a href="#cb25-774"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb25-775"><a href="#cb25-775"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb25-776"><a href="#cb25-776"></a><span class="in">```</span></span>
<span id="cb25-777"><a href="#cb25-777"></a></span>
<span id="cb25-778"><a href="#cb25-778"></a></span>
<span id="cb25-779"><a href="#cb25-779"></a>This map could be very useful for police officers deciding where to conduct anti-robbery patrols, because it not only shows the areas with the highest density of robberies but only shows those areas if there are more robberies than we would expect by chance. This makes it more likely that officers won't waste time chasing apparent patterns that are actually the result of random variation.</span>
<span id="cb25-780"><a href="#cb25-780"></a></span>
<span id="cb25-781"><a href="#cb25-781"></a>One limitation of this map, though, is that it's hard to see the hotspots that have the lowest KDE values. It is important to be able to see these cells, since they have a higher density of robbery than we would expect by chance even if that density is lower than for some other cells. To deal with this problem, we can use a different colour scale so that instead of the colours varying between light blue and dark blue, they instead vary between mid blue and dark blue. </span>
<span id="cb25-782"><a href="#cb25-782"></a></span>
<span id="cb25-783"><a href="#cb25-783"></a>To do that, we replace <span class="in">`scale_fill_distiller()`</span> in our <span class="in">`ggplot()`</span> stack with another scale function: <span class="in">`scale_fill_gradient()`</span>. This allows us to specify two colours and ggplot2 will automatically create a gradient of colours between them. We can specify colours in R in several ways, but the code below uses the <span class="in">`rgb()`</span> helper function to specify a colour as being made of up of three components: **r**ed, **g**reen and **b**blue. Each of these is specified as a value between zero and one, with higher values giving lighter shades. You can see this approach being used in the final script file below.</span>
<span id="cb25-784"><a href="#cb25-784"></a></span>
<span id="cb25-785"><a href="#cb25-785"></a></span>
<span id="cb25-786"><a href="#cb25-786"></a>::: {.callout-quiz .callout}</span>
<span id="cb25-787"><a href="#cb25-787"></a><span class="fu">#### Gi*</span></span>
<span id="cb25-788"><a href="#cb25-788"></a></span>
<span id="cb25-789"><a href="#cb25-789"></a><span class="in">```{r gistar-quiz}</span></span>
<span id="cb25-790"><a href="#cb25-790"></a><span class="in">#| echo: false</span></span>
<span id="cb25-791"><a href="#cb25-791"></a></span>
<span id="cb25-792"><a href="#cb25-792"></a><span class="in">gistar_quiz1 &lt;- c(</span></span>
<span id="cb25-793"><a href="#cb25-793"></a><span class="in">  answer = "`filter(robbery_gi, pvalue &lt; 0.05)`",</span></span>
<span id="cb25-794"><a href="#cb25-794"></a><span class="in">  "`filter(robbery_gi, pvalue &gt; 0.05)`",</span></span>
<span id="cb25-795"><a href="#cb25-795"></a><span class="in">  "`filter(robbery_gi, pvalue &lt;= 0.05)`",</span></span>
<span id="cb25-796"><a href="#cb25-796"></a><span class="in">  "`filter(robbery_gi, pvalue == 0.05)`"</span></span>
<span id="cb25-797"><a href="#cb25-797"></a><span class="in">)</span></span>
<span id="cb25-798"><a href="#cb25-798"></a></span>
<span id="cb25-799"><a href="#cb25-799"></a><span class="in">gistar_quiz2 &lt;- c(</span></span>
<span id="cb25-800"><a href="#cb25-800"></a><span class="in">  "We can remove the `geometry` column with the code `select(robberies_in_nottingham, -geometry)`.",</span></span>
<span id="cb25-801"><a href="#cb25-801"></a><span class="in">  "We can remove the `geometry` column with the code `filter(robberies_in_nottingham, -geometry)`.",</span></span>
<span id="cb25-802"><a href="#cb25-802"></a><span class="in">  answer = "We cannot remove the `geometry` column of an SF object with `select()`, so we must use `st_drop_geometry()` instead.",</span></span>
<span id="cb25-803"><a href="#cb25-803"></a><span class="in">  "There is no way to remove the `geometry` column from an SF object."</span></span>
<span id="cb25-804"><a href="#cb25-804"></a><span class="in">)</span></span>
<span id="cb25-805"><a href="#cb25-805"></a><span class="in">```</span></span>
<span id="cb25-806"><a href="#cb25-806"></a></span>
<span id="cb25-807"><a href="#cb25-807"></a>**`robbery_gi` is an object storing a result produced by the `hotspot_gistar()` function. Which of these pieces of code could be used to extract _only_ those rows in the data with significant p-values?**</span>
<span id="cb25-808"><a href="#cb25-808"></a></span>
<span id="cb25-809"><a href="#cb25-809"></a><span class="in">`r webexercises::longmcq(gistar_quiz1)`</span></span>
<span id="cb25-810"><a href="#cb25-810"></a></span>
<span id="cb25-811"><a href="#cb25-811"></a></span>
<span id="cb25-812"><a href="#cb25-812"></a>**Which *one* of these statements is true about an SF object called `robberies_in_nottingham`?**</span>
<span id="cb25-813"><a href="#cb25-813"></a></span>
<span id="cb25-814"><a href="#cb25-814"></a><span class="in">`r webexercises::longmcq(gistar_quiz2)`</span></span>
<span id="cb25-815"><a href="#cb25-815"></a></span>
<span id="cb25-816"><a href="#cb25-816"></a></span>
<span id="cb25-817"><a href="#cb25-817"></a>:::</span>
<span id="cb25-818"><a href="#cb25-818"></a></span>
<span id="cb25-819"><a href="#cb25-819"></a></span>
<span id="cb25-820"><a href="#cb25-820"></a></span>
<span id="cb25-821"><a href="#cb25-821"></a><span class="fu">## Putting it all together</span></span>
<span id="cb25-822"><a href="#cb25-822"></a></span>
<span id="cb25-823"><a href="#cb25-823"></a>In this chapter we have learned about hotspots, how to create dual KDE maps and how to find significant hotspots using the Gi* statistic. We can put this all together to create a complete script for producing a map of robbery hotspots in Nottingham</span>
<span id="cb25-824"><a href="#cb25-824"></a></span>
<span id="cb25-825"><a href="#cb25-825"></a>The following code is all that is needed to produce this map. Read through the comments accompanying the code to see how what we have learned in this chapter fits together, then run the code to produce the map. </span>
<span id="cb25-826"><a href="#cb25-826"></a></span>
<span id="cb25-827"><a href="#cb25-827"></a></span>
<span id="cb25-830"><a href="#cb25-830"></a><span class="in">```{r}</span></span>
<span id="cb25-831"><a href="#cb25-831"></a><span class="co">#| eval: false</span></span>
<span id="cb25-832"><a href="#cb25-832"></a><span class="co">#| filename: "chapter11b.R"</span></span>
<span id="cb25-833"><a href="#cb25-833"></a></span>
<span id="cb25-834"><a href="#cb25-834"></a><span class="co"># Prepare ----------------------------------------------------------------------</span></span>
<span id="cb25-835"><a href="#cb25-835"></a></span>
<span id="cb25-836"><a href="#cb25-836"></a><span class="co"># Load packages</span></span>
<span id="cb25-837"><a href="#cb25-837"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggspatial, sf, sfhotspot, tidyverse)</span>
<span id="cb25-838"><a href="#cb25-838"></a></span>
<span id="cb25-839"><a href="#cb25-839"></a><span class="co"># Load data and transform to British National Grid, which is easier to work with</span></span>
<span id="cb25-840"><a href="#cb25-840"></a><span class="co"># for functions that use spatial units such as metres</span></span>
<span id="cb25-841"><a href="#cb25-841"></a>robbery <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-842"><a href="#cb25-842"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-843"><a href="#cb25-843"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb25-844"><a href="#cb25-844"></a>nottingham_wards <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-845"><a href="#cb25-845"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb25-846"><a href="#cb25-846"></a></span>
<span id="cb25-847"><a href="#cb25-847"></a></span>
<span id="cb25-848"><a href="#cb25-848"></a><span class="co"># Find significant grid cells --------------------------------------------------</span></span>
<span id="cb25-849"><a href="#cb25-849"></a></span>
<span id="cb25-850"><a href="#cb25-850"></a><span class="co"># Calculate Gi* statistic, filter for only significant hotspot cells and clip to</span></span>
<span id="cb25-851"><a href="#cb25-851"></a><span class="co"># the city boundary</span></span>
<span id="cb25-852"><a href="#cb25-852"></a>robbery_gistar <span class="ot">&lt;-</span> robbery <span class="sc">|&gt;</span> </span>
<span id="cb25-853"><a href="#cb25-853"></a>  <span class="fu">hotspot_gistar</span>(<span class="at">cell_size =</span> <span class="dv">100</span>, <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-854"><a href="#cb25-854"></a>  <span class="fu">filter</span>(gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-855"><a href="#cb25-855"></a>  <span class="fu">st_intersection</span>(nottingham_wards)</span>
<span id="cb25-856"><a href="#cb25-856"></a></span>
<span id="cb25-857"><a href="#cb25-857"></a></span>
<span id="cb25-858"><a href="#cb25-858"></a><span class="co"># Plot map ---------------------------------------------------------------------</span></span>
<span id="cb25-859"><a href="#cb25-859"></a></span>
<span id="cb25-860"><a href="#cb25-860"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb25-861"><a href="#cb25-861"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb25-862"><a href="#cb25-862"></a>  <span class="co"># Add density for significant cells</span></span>
<span id="cb25-863"><a href="#cb25-863"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb25-864"><a href="#cb25-864"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb25-865"><a href="#cb25-865"></a>    <span class="at">data =</span> robbery_gistar, </span>
<span id="cb25-866"><a href="#cb25-866"></a>    <span class="at">alpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb25-867"><a href="#cb25-867"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb25-868"><a href="#cb25-868"></a>  ) <span class="sc">+</span></span>
<span id="cb25-869"><a href="#cb25-869"></a>  <span class="co"># Add ward boundaries</span></span>
<span id="cb25-870"><a href="#cb25-870"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> nottingham_wards, <span class="at">colour =</span> <span class="st">"grey70"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb25-871"><a href="#cb25-871"></a>  <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb25-872"><a href="#cb25-872"></a>    <span class="at">low =</span> <span class="fu">rgb</span>(<span class="fl">0.8</span>, <span class="fl">0.8</span>, <span class="dv">1</span>), </span>
<span id="cb25-873"><a href="#cb25-873"></a>    <span class="at">high =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb25-874"><a href="#cb25-874"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(robbery_gistar, kde)),</span>
<span id="cb25-875"><a href="#cb25-875"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>)</span>
<span id="cb25-876"><a href="#cb25-876"></a>  ) <span class="sc">+</span></span>
<span id="cb25-877"><a href="#cb25-877"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb25-878"><a href="#cb25-878"></a>  <span class="fu">labs</span>(</span>
<span id="cb25-879"><a href="#cb25-879"></a>      <span class="at">title =</span> <span class="st">"Nottingham robbery hotspots"</span>,</span>
<span id="cb25-880"><a href="#cb25-880"></a>      <span class="at">subtitle =</span> <span class="fu">str_glue</span>(</span>
<span id="cb25-881"><a href="#cb25-881"></a>        <span class="st">"density of robbery in places with more violence than expected by "</span>,</span>
<span id="cb25-882"><a href="#cb25-882"></a>        <span class="st">"chance"</span></span>
<span id="cb25-883"><a href="#cb25-883"></a>      ),</span>
<span id="cb25-884"><a href="#cb25-884"></a>      <span class="co"># Don't forget to add the licence statement -- it's a legal requirement!</span></span>
<span id="cb25-885"><a href="#cb25-885"></a>      <span class="at">caption =</span> <span class="fu">str_glue</span>(</span>
<span id="cb25-886"><a href="#cb25-886"></a>        <span class="st">"Contains public sector information licensed under the Open "</span>,</span>
<span id="cb25-887"><a href="#cb25-887"></a>        <span class="st">"Government Licence v3.0. Map data from OpenStreetMap."</span></span>
<span id="cb25-888"><a href="#cb25-888"></a>      ),</span>
<span id="cb25-889"><a href="#cb25-889"></a>      <span class="at">fill =</span> <span class="fu">str_wrap</span>(<span class="st">"density of robbery at significant hotspots, 2022"</span>, <span class="dv">15</span>)</span>
<span id="cb25-890"><a href="#cb25-890"></a>  ) <span class="sc">+</span></span>
<span id="cb25-891"><a href="#cb25-891"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb25-892"><a href="#cb25-892"></a>  <span class="fu">theme</span>(</span>
<span id="cb25-893"><a href="#cb25-893"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey40"</span>, <span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb25-894"><a href="#cb25-894"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">6</span>, <span class="at">b =</span> <span class="dv">6</span>)),</span>
<span id="cb25-895"><a href="#cb25-895"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey50"</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>)</span>
<span id="cb25-896"><a href="#cb25-896"></a>  )</span>
<span id="cb25-897"><a href="#cb25-897"></a><span class="in">```</span></span>
<span id="cb25-898"><a href="#cb25-898"></a></span>
<span id="cb25-899"><a href="#cb25-899"></a></span>
<span id="cb25-902"><a href="#cb25-902"></a><span class="in">```{r}</span></span>
<span id="cb25-903"><a href="#cb25-903"></a><span class="co">#| echo: false</span></span>
<span id="cb25-904"><a href="#cb25-904"></a><span class="co">#| fig-asp: 1</span></span>
<span id="cb25-905"><a href="#cb25-905"></a><span class="co">#| out-width: "100%"</span></span>
<span id="cb25-906"><a href="#cb25-906"></a></span>
<span id="cb25-907"><a href="#cb25-907"></a><span class="co"># Load packages</span></span>
<span id="cb25-908"><a href="#cb25-908"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggspatial, sf, sfhotspot, tidyverse)</span>
<span id="cb25-909"><a href="#cb25-909"></a></span>
<span id="cb25-910"><a href="#cb25-910"></a><span class="co"># Load data and transform to British National Grid, which is easier to work with</span></span>
<span id="cb25-911"><a href="#cb25-911"></a><span class="co"># for functions that use spatial units such as metres</span></span>
<span id="cb25-912"><a href="#cb25-912"></a>robbery <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-913"><a href="#cb25-913"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-914"><a href="#cb25-914"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb25-915"><a href="#cb25-915"></a>nottingham_wards <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-916"><a href="#cb25-916"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb25-917"><a href="#cb25-917"></a></span>
<span id="cb25-918"><a href="#cb25-918"></a></span>
<span id="cb25-919"><a href="#cb25-919"></a><span class="co"># Find significant grid cells --------------------------------------------------</span></span>
<span id="cb25-920"><a href="#cb25-920"></a></span>
<span id="cb25-921"><a href="#cb25-921"></a><span class="co"># Calculate Gi* statistic, filter for only significant hotspot cells and clip to</span></span>
<span id="cb25-922"><a href="#cb25-922"></a><span class="co"># the city boundary</span></span>
<span id="cb25-923"><a href="#cb25-923"></a>robbery_gistar <span class="ot">&lt;-</span> robbery <span class="sc">|&gt;</span> </span>
<span id="cb25-924"><a href="#cb25-924"></a>  <span class="fu">hotspot_gistar</span>(<span class="at">cell_size =</span> <span class="dv">100</span>, <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-925"><a href="#cb25-925"></a>  <span class="fu">filter</span>(gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-926"><a href="#cb25-926"></a>  <span class="fu">st_intersection</span>(nottingham_wards)</span>
<span id="cb25-927"><a href="#cb25-927"></a></span>
<span id="cb25-928"><a href="#cb25-928"></a></span>
<span id="cb25-929"><a href="#cb25-929"></a><span class="co"># Plot map ---------------------------------------------------------------------</span></span>
<span id="cb25-930"><a href="#cb25-930"></a></span>
<span id="cb25-931"><a href="#cb25-931"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb25-932"><a href="#cb25-932"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb25-933"><a href="#cb25-933"></a>  <span class="co"># Add density for significant cells</span></span>
<span id="cb25-934"><a href="#cb25-934"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb25-935"><a href="#cb25-935"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb25-936"><a href="#cb25-936"></a>    <span class="at">data =</span> robbery_gistar, </span>
<span id="cb25-937"><a href="#cb25-937"></a>    <span class="at">alpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb25-938"><a href="#cb25-938"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb25-939"><a href="#cb25-939"></a>  ) <span class="sc">+</span></span>
<span id="cb25-940"><a href="#cb25-940"></a>  <span class="co"># Add ward boundaries</span></span>
<span id="cb25-941"><a href="#cb25-941"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> nottingham_wards, <span class="at">colour =</span> <span class="st">"grey70"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb25-942"><a href="#cb25-942"></a>  <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb25-943"><a href="#cb25-943"></a>    <span class="at">low =</span> <span class="fu">rgb</span>(<span class="fl">0.8</span>, <span class="fl">0.8</span>, <span class="dv">1</span>), </span>
<span id="cb25-944"><a href="#cb25-944"></a>    <span class="at">high =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb25-945"><a href="#cb25-945"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(robbery_gistar, kde)),</span>
<span id="cb25-946"><a href="#cb25-946"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>)</span>
<span id="cb25-947"><a href="#cb25-947"></a>  ) <span class="sc">+</span></span>
<span id="cb25-948"><a href="#cb25-948"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb25-949"><a href="#cb25-949"></a>  <span class="fu">labs</span>(</span>
<span id="cb25-950"><a href="#cb25-950"></a>      <span class="at">title =</span> <span class="st">"Nottingham robbery hotspots"</span>,</span>
<span id="cb25-951"><a href="#cb25-951"></a>      <span class="at">subtitle =</span> <span class="fu">str_glue</span>(</span>
<span id="cb25-952"><a href="#cb25-952"></a>        <span class="st">"density of robbery in places with more violence than expected by "</span>,</span>
<span id="cb25-953"><a href="#cb25-953"></a>        <span class="st">"chance"</span></span>
<span id="cb25-954"><a href="#cb25-954"></a>      ),</span>
<span id="cb25-955"><a href="#cb25-955"></a>      <span class="co"># Don't forget to add the licence statement -- it's a legal requirement!</span></span>
<span id="cb25-956"><a href="#cb25-956"></a>      <span class="at">caption =</span> <span class="fu">str_glue</span>(</span>
<span id="cb25-957"><a href="#cb25-957"></a>        <span class="st">"Contains public sector information licensed under the Open "</span>,</span>
<span id="cb25-958"><a href="#cb25-958"></a>        <span class="st">"Government Licence v3.0. Map data from OpenStreetMap."</span></span>
<span id="cb25-959"><a href="#cb25-959"></a>      ),</span>
<span id="cb25-960"><a href="#cb25-960"></a>      <span class="at">fill =</span> <span class="fu">str_wrap</span>(<span class="st">"density of robbery at significant hotspots, 2022"</span>, <span class="dv">15</span>)</span>
<span id="cb25-961"><a href="#cb25-961"></a>  ) <span class="sc">+</span></span>
<span id="cb25-962"><a href="#cb25-962"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb25-963"><a href="#cb25-963"></a>  <span class="fu">theme</span>(</span>
<span id="cb25-964"><a href="#cb25-964"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey40"</span>, <span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb25-965"><a href="#cb25-965"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">6</span>, <span class="at">b =</span> <span class="dv">6</span>)),</span>
<span id="cb25-966"><a href="#cb25-966"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey50"</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>)</span>
<span id="cb25-967"><a href="#cb25-967"></a>  )</span>
<span id="cb25-968"><a href="#cb25-968"></a><span class="in">```</span></span>
<span id="cb25-969"><a href="#cb25-969"></a></span>
<span id="cb25-970"><a href="#cb25-970"></a></span>
<span id="cb25-971"><a href="#cb25-971"></a>::: {.callout-quiz .callout}</span>
<span id="cb25-972"><a href="#cb25-972"></a><span class="fu">#### Check your knowledge: Revision questions</span></span>
<span id="cb25-973"><a href="#cb25-973"></a></span>
<span id="cb25-974"><a href="#cb25-974"></a>Answer these questions to check you have understood the main points covered in this chapter. Write between 50 and 100 words to answer each question.</span>
<span id="cb25-975"><a href="#cb25-975"></a></span>
<span id="cb25-976"><a href="#cb25-976"></a><span class="ss">1. </span>What are crime hotspots, and why are they important in crime analysis?</span>
<span id="cb25-977"><a href="#cb25-977"></a><span class="ss">2. </span>How do chronic and acute crime hotspots differ?</span>
<span id="cb25-978"><a href="#cb25-978"></a><span class="ss">3. </span>Why should hotspot analysis focus on small geographic areas rather than larger administrative regions?</span>
<span id="cb25-979"><a href="#cb25-979"></a><span class="ss">4. </span>What is dual kernel density estimation (dual KDE), and how does it improve crime hotspot analysis?</span>
<span id="cb25-980"><a href="#cb25-980"></a><span class="ss">5. </span>How can crime hotspot maps be used to inform crime prevention strategies?</span>
<span id="cb25-981"><a href="#cb25-981"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by/4.0/">
<p>This book is available under a Creative Commons Attribution 4.0 International licence</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>