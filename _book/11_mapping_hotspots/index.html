<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>11&nbsp; Mapping hotspots – Learn Crime Mapping with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../12_messy_data/index.html" rel="next">
<link href="../10_place_data/index.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-854d42f42d0f6b455b86ad16a464e311.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<!-- START OF INCLUDED HEADER -->

<!--
This file contains code that will be included in the header of each page of the
quarto book
-->

<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>

<!-- END OF INCLUDED HEADER -->

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../include/webex.css">
<meta name="twitter:title" content="11&nbsp; Mapping hotspots – Learn Crime Mapping with R">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="../images/cover_image.png">
<meta name="twitter:image:alt" content="">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../11_mapping_hotspots/index.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/cover_image.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Learn Crime Mapping with R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mpjashby/crimemappingbook/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install the software needed for this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_getting_started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_your_first_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Your first crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_data_wrangling/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_your_second_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Your second crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_code_with_style/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Code with style</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_mapping_crime_patterns/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping crime patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_map_context/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Giving a map context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_handling_bugs/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Handling bugs in your code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_mapping_areas/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Mapping area data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../10_place_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../11_mapping_hotspots/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../12_messy_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../13_crime_series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Mapping crime series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../14_writing_reports/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Writing reports in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../15_no_maps/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Presenting spatial data without maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../16_mapping_time/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Mapping crime over time</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/read_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Functions for reading data into R #sec-load-functions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/map_checklist.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Checklist: Making a good crime map</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/common_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Common R errors and how to fix them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/functions_to_avoid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Some R functions you should avoid</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/handling_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Checklist: handling code errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">In this chapter</h2>
   
  <ul>
  <li><a href="#what-is-a-hotspot" id="toc-what-is-a-hotspot" class="nav-link active" data-scroll-target="#what-is-a-hotspot"><span class="header-section-number">11.1</span> What is a hotspot?</a>
  <ul class="collapse">
  <li><a href="#check-your-understanding" id="toc-check-your-understanding" class="nav-link" data-scroll-target="#check-your-understanding"><span class="header-section-number">11.1.1</span> Check your understanding</a></li>
  </ul></li>
  <li><a href="#showing-the-density-of-risk" id="toc-showing-the-density-of-risk" class="nav-link" data-scroll-target="#showing-the-density-of-risk"><span class="header-section-number">11.2</span> Showing the density of risk</a>
  <ul class="collapse">
  <li><a href="#data-wrangling" id="toc-data-wrangling" class="nav-link" data-scroll-target="#data-wrangling"><span class="header-section-number">11.2.1</span> Data wrangling</a></li>
  <li><a href="#calculating-dual-kernel-density" id="toc-calculating-dual-kernel-density" class="nav-link" data-scroll-target="#calculating-dual-kernel-density"><span class="header-section-number">11.2.2</span> Calculating dual kernel density</a></li>
  <li><a href="#check-your-understanding-1" id="toc-check-your-understanding-1" class="nav-link" data-scroll-target="#check-your-understanding-1"><span class="header-section-number">11.2.3</span> Check your understanding</a></li>
  </ul></li>
  <li><a href="#finding-hotspots" id="toc-finding-hotspots" class="nav-link" data-scroll-target="#finding-hotspots"><span class="header-section-number">11.3</span> Finding hotspots</a>
  <ul class="collapse">
  <li><a href="#distinguishing-hotspots-from-random-variation" id="toc-distinguishing-hotspots-from-random-variation" class="nav-link" data-scroll-target="#distinguishing-hotspots-from-random-variation"><span class="header-section-number">11.3.1</span> Distinguishing hotspots from random variation</a></li>
  <li><a href="#check-your-understanding-2" id="toc-check-your-understanding-2" class="nav-link" data-scroll-target="#check-your-understanding-2"><span class="header-section-number">11.3.2</span> Check your understanding</a></li>
  </ul></li>
  <li><a href="#putting-it-all-together" id="toc-putting-it-all-together" class="nav-link" data-scroll-target="#putting-it-all-together"><span class="header-section-number">11.4</span> Putting it all together</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-mapping-hotspots" class="quarto-section-identifier"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Learn what crime hotspots are, why they are important and how to map them.</strong></p>
<div class="box load-tutorial">
<p>To load the <a href="../#how-to-use-this-book">interactive tutorial</a> for this chapter, copy and paste the following code into the RStudio console:</p>
<div class="sourceCode" id="cb1" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>crimemapping<span class="sc">::</span><span class="fu">tutorial</span>(<span class="st">"11_mapping_hotspots"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and press <code>Enter</code>.</p>
</div>
<section id="what-is-a-hotspot" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="what-is-a-hotspot"><span class="header-section-number">11.1</span> What is a hotspot?</h2>
<p>Crime is heavily concentrated in several different ways. A small number of offenders commit a large proportion of crime (even though most people commit minor offences occasionally) and a small number of people are repeatedly victimised. For most types of crime, a large proportion of crime occurs in a small number of places. <strong>A hotspot is a specific location or small area where an unusual amount of criminal activity occurs</strong>.</p>
<p>Crime hotspots can occur in several different forms. Watch this video to understand why hotspots are important in understanding and responding to crime.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/ug-ZhvvQjmw" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>Some places are <em>chronic</em> hotspots – they have more crime than surrounding areas over a sustained period (which may appear to be permanent). Chronic hotspots are often generated by a facility that draws vulnerable people into an area, such as a tourist attraction that draws crowds of people who are vulnerable to pickpocketing. Other places are <em>acute</em> hotspots, in which crime increases in a place that previously experienced no or few crimes. This may be the result of some change in the environment or how it’s managed, such as new management at a bar that ignores drug dealing that the previous owners would have not permitted.</p>
<p>When analysing hotspots, it is best to focus on <em>small</em> areas such as an apartment block, a shopping centre, a park or a single street. Focusing on smaller areas is important because resources to respond to crime are almost always limited, so it is important that those resources are directed where the problem is worst.</p>
<p>Analysing larger areas, such as a neighbourhood or a police sector, is much more difficult because larger areas are always made up of many smaller areas, each of which might be quite different from one another. This means that the factors causing one street to be a hotspot might be quite different from the factors that make another street in the same district into a hotspot. Conflating different problems with different causes makes it much harder to find effective ways to reduce crime in any one place.</p>
<p>These difficulties can be avoided (at least partly) by keeping hotspots small: in an urban area, a useful rule of thumb is that you should be able to stand in the middle of a hotspot and see the whole hotspot area.</p>
<p>Being able to identify hotspots using crime mapping is important because it forms a vital first step in many place-focused responses to crime. As an example of this, watch this video about how police in Philadelphia worked with researchers to use crime mapping to identify where to deploy foot patrols to reduce crime.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/0NUQsK0vnnM" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>In this tutorial we will learn how to make maps that could be useful in identifying and responding to hotspots of crime. As an example, we will create this map showing hotspots of robbery in Nottingham, England.</p>
<p class="full-width-image">
<img src="images/nottingham_robbery_map.jpg" alt="A hotspot map of robberies in Nottingham" style="max-height: 700px;">
</p>
<section id="check-your-understanding" class="level3 tutorial" data-number="11.1.1">
<h3 class="tutorial anchored" data-number="11.1.1" data-anchor-id="check-your-understanding"><span class="header-section-number">11.1.1</span> Check your understanding</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">quiz</span>(</span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="at">caption =</span> <span class="st">""</span>,</span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="fu">question</span>(<span class="st">"Which *one* of these statements is true?"</span>,</span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="fu">answer</span>(<span class="st">"Crime is very geographically concentrated – we can expect half of crime to be concentrated in about 5% of micro places"</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="fu">answer</span>(<span class="st">"Crime is usually not geographically concentrated at micro places"</span>),</span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="fu">answer</span>(<span class="st">"Crime is slightly geographically concentrated – we can expect half of crime to be concentrated in about one quarter of micro places"</span>),</span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="fu">answer</span>(<span class="st">"Crime is extremely geographically concentrated – we can expect half of crime to be concentrated in about 1% of micro places"</span>),</span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="at">correct =</span> <span class="st">"That's correct – based on previous studies, we can expect half of crime to be concentrated in about 5% of micro places"</span>,</span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="at">incorrect =</span> <span class="st">"That's not correct – try re-watching the first video above and then try the question again."</span>,</span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  )</span>
<span id="cb2-13"><a href="#cb2-13"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="showing-the-density-of-risk" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="showing-the-density-of-risk"><span class="header-section-number">11.2</span> Showing the density of risk</h2>
<p>In the tutorial on mapping area data we learned how to produce maps showing the <em>incidence rate</em> of crime by dividing the number of crimes by a measure of the population at risk of being targeted. We will often only have population estimates for areas, such as census estimates of the number of people living in an area. But for some crimes we have access to estimates of the people (or, more often, objects) at risk of being a target of a particular crime. In these cases, we can produce better maps of the risk of crime in different areas by producing a <em>dual KDE</em> map that shows the density of crime <em>risk</em> in different places.</p>
<p>To create a dual KDE map, we must estimate the density of crime and compare it to an estimate the density of the population at risk. Since the incidence rate is calculated as the number of crimes divided by the number of people or objects at risk, we can calculate the density of risk by dividing the density of crime estimated for each cell in the grid by the density of population estimated for the same cell. The <code>hotspot_dual_kde()</code> function from the <code>sfhotspot</code> package does this for us.</p>
<p>To illustrate making a dual KDE map, we will use reports of burglaries in three wards in Nottingham in 2020. Since the essential element of the crime of burglary in England is that an offender enters a <em>building</em> as a trespasser in order to steal something, the best measure of the population at risk of burglary is the number of <em>buildings</em> in each area (the definition of burglary is more complicated than this, but we don’t need to worry about that here).</p>
<p>Burglary is a good example of why the routine activities approach to thinking about crime that we introduced in a previous tutorial emphasises thinking about <em>targets</em> of crime rather than focusing only on crime <em>victims</em>. In the case of burglary, one person might be the owner of a large number of buildings (e.g.&nbsp;a farm with lots of out-buildings) or lots of people might own a single building (such as a house converted into flats). By thinking about the targets that are attacked by offenders, we can identify that burglary rates should be calculated based on buildings rather than, for example, residential population. Note that if our crime data only included <em>residential</em> burglaries then we would want to use <em>residential</em> buildings as our denominator, but in this case we have data for all burglaries, both residential and non-residential.</p>
<section id="data-wrangling" class="level3" data-number="11.2.1">
<h3 data-number="11.2.1" class="anchored" data-anchor-id="data-wrangling"><span class="header-section-number">11.2.1</span> Data wrangling</h3>
<p>Before we can create our dual KDE layer, we have to complete some data wrangling. We will extract the boundaries for the wards of interest from a dataset of boundaries for all wards in Nottingham using <code>filter()</code> as we have done previously. To extract only the burglaries occurring in those three wards from a dataset of all burglaries in Nottingham, we will use <code>st_intersection()</code>. We will also transform both datasets to use the British National Grid (EPSG code 27700), since we will need to do that anyway before calculating the KDE values.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>wards <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="fu">filter</span>(ward_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Castle"</span>, <span class="st">"Lenton &amp; Wollaton East"</span>, <span class="st">"Meadows"</span>))</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>burglaries <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_burglary.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="fu">st_intersection</span>(wards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Rows: 1795 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): location, lsoa_code
dbl  (2): longitude, latitude
date (1): month

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
</div>
<div class="box notewell">
<p><code>st_intersection()</code> can take longer to run than the maximum time limit for running code within this tutorial. If you see an error saying <code>Your code ran  longer than the permitted time limit for this exercise</code> or <code>reached elapsed time  limit</code>, you can continue with the rest of the tutorial as usual.</p>
</div>
<p>We do not have a source of open data for all the buildings in Nottingham, so we will use the <code>osmdata</code> package to get the locations of buildings from OpenStreetMap (OSM). You may remember from a previous tutorial that to do this we need to know which key (and possibly value) the OSM database uses for storing the locations of buildings. The OSM feature key for a building is ‘building’ and it is not necessary to specify a value (since we want to capture all types of building). The <code>osmdata</code> package expects data to use the WGS84 co-ordinate reference system, so we must also make sure any data sources we use are projected using that system (EPSG code 4326).</p>
<div class="tutorial">
<p>Run the code needed to download data from OSM for all the buildings in the three wards we are interested in and store it in an object called <code>nottingham_buildings</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># To download OSM data, use:</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">#   * `st_transform()` to transform the data to use the WGS84 co-ordinate system</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">#   * `st_bbox()` to calculate the bounding box of the wards</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">#   * `opq()` to set up the OSM query </span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#   * `add_osm_feature()` to specify what type of features to download</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">#   * `osmdata_sf()` to download the data as an SF object</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">library</span>(osmdata)</span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a>nottingham_buildings <span class="ot">&lt;-</span> wards <span class="sc">|&gt;</span> </span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="fu">opq</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-7"><a href="#cb7-7"></a>  <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"?????"</span>) <span class="sc">|&gt;</span>  <span class="co"># &lt;- specify type of data here</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>  <span class="fu">osmdata_sf</span>()</span>
<span id="cb7-9"><a href="#cb7-9"></a></span>
<span id="cb7-10"><a href="#cb7-10"></a>nottingham_buildings</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Object of class 'osmdata' with:
                 $bbox : 52.9173362670705,-1.21712477980417,52.9596833099217,-1.13020878819132
        $overpass_call : The call submitted to the overpass API
                 $meta : metadata including timestamp and version numbers
           $osm_points : 'sf' Simple Features Collection with 0 points
            $osm_lines : NULL
         $osm_polygons : 'sf' Simple Features Collection with 0 polygons
       $osm_multilines : NULL
    $osm_multipolygons : NULL</code></pre>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">library</span>(osmdata)</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a>nottingham_buildings <span class="ot">&lt;-</span> wards <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="fu">opq</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"building"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="fu">osmdata_sf</span>()</span>
<span id="cb9-9"><a href="#cb9-9"></a></span>
<span id="cb9-10"><a href="#cb9-10"></a>nottingham_buildings</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Object of class 'osmdata' with:
                 $bbox : 52.9173362670705,-1.21712477980417,52.9596833099217,-1.13020878819132
        $overpass_call : The call submitted to the overpass API
                 $meta : metadata including timestamp and version numbers
           $osm_points : 'sf' Simple Features Collection with 164398 points
            $osm_lines : 'sf' Simple Features Collection with 44 linestrings
         $osm_polygons : 'sf' Simple Features Collection with 30465 polygons
       $osm_multilines : 'sf' Simple Features Collection with 2 multilinestrings
    $osm_multipolygons : 'sf' Simple Features Collection with 69 multipolygons</code></pre>
</div>
</div>
<p>Looking at the <code>nottingham_buildings</code> object, we can see that OSM contains data on buildings stored as points, polygons and multipolygons (we can ignore the few linestrings tagged as buildings, since it doesn’t make sense for a building to be represented as a single line rather than a point or a polygon).</p>
<div class="box extra-detail">
<h5 id="risk-box1-title" class="box-title anchored">
What is a multipolygon?
</h5>
<div id="risk-box1" class="box-content">
<p>OpenStreetMap stores features in several different ways. The most basic types are points, lines and polygons. But there are also multipolygons (and multilines). These are features that represent complex structures such as clusters of buildings that are separate structures but are related to each other. For example, a hospital with several buildings might be represented in OpenStreetMap as a single multipolygon feature.</p>
</div>
</div>
<script>
$("#risk-box1-title").click(function () { $("#risk-box1").toggle("slow") })
</script>
<p>Let’s plot these features on a base map to check that OSM has reasonable coverage of the buildings in these three wards.</p>
<div class="cell" data-exercise="true" data-exercise.lines="23">
<div class="sourceCode cell-code" id="cb11" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartodark"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="co"># Add building features stored as points</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb11-5"><a href="#cb11-5"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_points"</span>), </span>
<span id="cb11-6"><a href="#cb11-6"></a>    <span class="at">colour =</span> <span class="st">"green"</span>,</span>
<span id="cb11-7"><a href="#cb11-7"></a>    <span class="at">size =</span> <span class="fl">0.1</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>  ) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>  <span class="co"># Add building features stored as polygons</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb11-11"><a href="#cb11-11"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_polygons"</span>), </span>
<span id="cb11-12"><a href="#cb11-12"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb11-13"><a href="#cb11-13"></a>    <span class="at">fill =</span> <span class="st">"blue"</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>  ) <span class="sc">+</span> </span>
<span id="cb11-15"><a href="#cb11-15"></a>  <span class="co"># Add building features stored as multi-polygons</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb11-17"><a href="#cb11-17"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_multipolygons"</span>), </span>
<span id="cb11-18"><a href="#cb11-18"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb11-19"><a href="#cb11-19"></a>    <span class="at">fill =</span> <span class="st">"darkred"</span></span>
<span id="cb11-20"><a href="#cb11-20"></a>  ) <span class="sc">+</span></span>
<span id="cb11-21"><a href="#cb11-21"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="at">colour =</span> <span class="st">"red"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">1.25</span>) <span class="sc">+</span></span>
<span id="cb11-22"><a href="#cb11-22"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/risk-exercise3-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="box notewell">
<p>Remember that <code>osmdata_sf()</code> gets OSM data for the area covered by the <em>bounding box</em> of the input feature, not the feature boundaries. This means some of the buildings returned by the code above will be outside the wards we are interested in. We will deal with this in a minute.</p>
</div>
<p>It looks like almost all the streets in the three wards we are interested in are lined with buildings in the OSM data, which is what we would expect of streets in an urban area. There are some streets without buildings in the top-left of the map, but these streets are outside our three wards so this does not matter.</p>
<p>We can also see from this map that the 164,398 point features in the OSM data (shown as green dots on the map) typically represent the corners of buildings that are also represented as polygons, so we know we can ignore the points layer within the OSM data.</p>
<p>Since the <code>hotspot_dual_kde()</code> function works on points, we need to convert the polygon and multipolygon layers to points by calculating their centroids, then merge the two layers together. This will generate a warning that <code>st_centroid does not give correct centroids for longitude/latitude data</code> but we can ignore this because the calculated centroids will be good enough for our purposes (if we wanted to, we could transform the data to use the British National Grid, calculate the centroids and then transform it back).</p>
<p>Since we are only interested in those buildings in three particular wards, we can also at this stage remove any buildings that are outside those wards using <code>st_intersection()</code>, as we have already done for the <code>burglaries</code> object. Since the <code>wards</code> object uses the British National Grid and <code>st_intersection()</code> requires both datasets to use the same co-ordinate system, we will transform the building centroids before clipping them.</p>
<div class="box extra-detail">
<h5 id="risk-box2-title" class="box-title anchored">
What does the warning <code>st_centroid assumes …</code> mean?
</h5>
<div id="risk-box2" class="box-content">
<p>You might have seen a warning saying <code>st_centroid assumes attributes are constant over geometries of x</code>. You will see this warning when you use the <code>st_centroid()</code> function. It is there to remind you that columns in the original data (which the SF package refers to as the <em>attributes</em> associated with each spatial feature) refer to the polygon as a whole, but in the object produced by <code>st_centroid()</code> it will appear that the columns relate to the centroid point. In many cases this will not be a problem, but it could expose you to the ecological fallacy so it is sometimes useful to be reminded.</p>
</div>
</div>
<script>
$("#risk-box2-title").click(function () { $("#risk-box2").toggle("slow") })
</script>
<div class="box extra-detail">
<h5 id="risk-box3-title" class="box-title anchored">
What does the warning <code>attribute variables are assumed …</code> mean?
</h5>
<div id="risk-box3" class="box-content">
<p><code>st_intersection()</code> produces a warning message whenever it is used:</p>
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout all
geometries</code></pre>
<p>As long as you are simply using <code>st_intersection()</code> to remove parts of the data outside a boundary, you can ignore this message.</p>
</div>
</div>
<script>
$("#risk-box3-title").click(function () { $("#risk-box3").toggle("slow") })
</script>
</section>
<section id="calculating-dual-kernel-density" class="level3" data-number="11.2.2">
<h3 data-number="11.2.2" class="anchored" data-anchor-id="calculating-dual-kernel-density"><span class="header-section-number">11.2.2</span> Calculating dual kernel density</h3>
<p>We now have the object <code>burglaries</code> that contains the locations of each burglary in the three Nottingham wards that we are interested in, and the object <code>nottingham_building_centroids</code> that contains the centroids of each building in those three wards. We can use these layers to estimate the density of burglaries and buildings, then combine these to estimate the density of burglary risk.</p>
<p><code>hotspot_dual_kde()</code> works in the same way as <code>hotspot_kde()</code>, except that it requires two datasets. In this case, that means one dataset of crime locations and one dataset of building locations. <code>hotspot_dual_kde()</code> will set the cell size and bandwidth automatically, but we can set them manually using the <code>cell_size</code>, <code>bandwidth_adjust</code> and <code>grid</code> arguments in the same way we have done for <code>hotspot_kde()</code>. In this case, we will use the <code>hotspot_grid()</code> helper function to create a grid based on the boundaries of the wards we are interested in. All the spatial objects we are going to use here have co-ordinates specified using the British National Grid because we have already transformed them, so we do not need to do any transformation here.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb13" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>burglary_risk <span class="ot">&lt;-</span> <span class="fu">hotspot_dual_kde</span>(</span>
<span id="cb13-2"><a href="#cb13-2"></a>  burglaries, </span>
<span id="cb13-3"><a href="#cb13-3"></a>  nottingham_building_centroids, </span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, </span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="at">grid =</span> <span class="fu">hotspot_grid</span>(wards, <span class="at">cell_size =</span> <span class="dv">100</span>),</span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="fu">st_intersection</span>(wards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">head</span>(burglary_risk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 6 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 455826.6 ymin: 338782.9 xmax: 456354.2 ymax: 338909
Projected CRS: OSGB36 / British National Grid
# A tibble: 6 × 5
      n    kde ward_code ward_name                                      geometry
  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;                                     &lt;POLYGON [m]&gt;
1     0 0.0175 E05012277 Castle    ((456061.5 338809, 456061.5 338799.8, 456006…
2     0 0.0172 E05012277 Castle    ((456061.5 338809, 456161.5 338809, 456161.5…
3     0 0.0222 E05012277 Castle    ((456161.5 338809, 456261.5 338809, 456261.5…
4     0 0.0271 E05012277 Castle    ((456261.5 338809, 456354.2 338809, 456261.5…
5     0 0.0204 E05012277 Castle    ((455861.5 338909, 455861.5 338888.8, 455826…
6     0 0.0264 E05012277 Castle    ((455861.5 338909, 455961.5 338909, 455961.5…</code></pre>
</div>
</div>
<p>You might recall from earlier in this tutorial that the value of the <code>kde</code> column in the object produced by <code>hotspot_dual_kde()</code> is calculated by dividing the density of burglary in each grid cell by the density of buildings in the same grid cell. There are two cases where this will produce a result that is not a finite number:</p>
<ul>
<li>If, for a particular cell, the density of burglaries and density of buildings are both zero, dividing one by the other will produce the result <code>NaN</code>, for ‘not a number’.</li>
<li>If the density of burglaries is greater than zero but the density of buildings is exactly zero, the result will be <code>Inf</code>, for ‘infinite’.</li>
</ul>
<p>Since it is not possible to calculate burglary risk in either of those cases, we can exclude these cases from the <code>burglary_risk</code> object by using <code>filter()</code> together with the <code>is.finite()</code> function (R does not count <code>NaN</code> as a finite number):</p>
<div class="sourceCode" id="cb17" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>burglary_risk <span class="ot">&lt;-</span> <span class="fu">hotspot_dual_kde</span>(</span>
<span id="cb17-2"><a href="#cb17-2"></a>  burglaries, </span>
<span id="cb17-3"><a href="#cb17-3"></a>  nottingham_building_centroids, </span>
<span id="cb17-4"><a href="#cb17-4"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, </span>
<span id="cb17-5"><a href="#cb17-5"></a>  <span class="at">grid =</span> <span class="fu">hotspot_grid</span>(wards, <span class="at">cell_size =</span> <span class="dv">100</span>)</span>
<span id="cb17-6"><a href="#cb17-6"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="fu">st_intersection</span>(wards)</span>
<span id="cb17-8"><a href="#cb17-8"></a></span>
<span id="cb17-9"><a href="#cb17-9"></a>burglary_risk_filtered <span class="ot">&lt;-</span> <span class="fu">filter</span>(burglary_risk, <span class="fu">is.finite</span>(kde))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You might wonder why we didn’t simply add <code>filter()</code> to the existing pipeline that creates the <code>burglary_risk</code> object. It is because we will need the unfiltered object in the next section. But for now …</p>
<p>We can plot the estimate of the density of burglary risk. By controlling for the density of buildings, this map shows us where building owners <em>on average</em> face the highest risk of being burgled. This might be useful in working out, for example, which building owners should be offered visits from a crime-prevention advisor or funding to install crime-prevention measures.</p>
<div class="cell" data-layout-align="center" data-exercise="true" data-exercise.lines="36">
<div class="sourceCode cell-code" id="cb18" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="co"># Add burglary risk layer</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb18-5"><a href="#cb18-5"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb18-6"><a href="#cb18-6"></a>    <span class="at">data =</span> burglary_risk_filtered, </span>
<span id="cb18-7"><a href="#cb18-7"></a>    <span class="at">alpha =</span> <span class="fl">0.8</span>, </span>
<span id="cb18-8"><a href="#cb18-8"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb18-9"><a href="#cb18-9"></a>  ) <span class="sc">+</span></span>
<span id="cb18-10"><a href="#cb18-10"></a>  <span class="co"># Add ward boundaries</span></span>
<span id="cb18-11"><a href="#cb18-11"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span> </span>
<span id="cb18-12"><a href="#cb18-12"></a>  <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb18-13"><a href="#cb18-13"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(burglary_risk_filtered, <span class="st">"kde"</span>)),</span>
<span id="cb18-14"><a href="#cb18-14"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>),</span>
<span id="cb18-15"><a href="#cb18-15"></a>    <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb18-16"><a href="#cb18-16"></a>  ) <span class="sc">+</span></span>
<span id="cb18-17"><a href="#cb18-17"></a>  <span class="fu">labs</span>(</span>
<span id="cb18-18"><a href="#cb18-18"></a>      <span class="at">title =</span> <span class="st">"Burglary risk in south-west Nottingham"</span>,</span>
<span id="cb18-19"><a href="#cb18-19"></a>      <span class="at">subtitle =</span> <span class="fu">str_glue</span>(</span>
<span id="cb18-20"><a href="#cb18-20"></a>        <span class="st">"dual kernel density of burglary risk in Castle, Lenton &amp; Wollaton "</span>,</span>
<span id="cb18-21"><a href="#cb18-21"></a>        <span class="st">"East and Meadows wards"</span></span>
<span id="cb18-22"><a href="#cb18-22"></a>      ),</span>
<span id="cb18-23"><a href="#cb18-23"></a>      <span class="at">caption =</span> <span class="fu">str_glue</span>(</span>
<span id="cb18-24"><a href="#cb18-24"></a>        <span class="st">"Contains public sector information licensed under the Open "</span>,</span>
<span id="cb18-25"><a href="#cb18-25"></a>        <span class="st">"Government Licence v3.0"</span></span>
<span id="cb18-26"><a href="#cb18-26"></a>      ),</span>
<span id="cb18-27"><a href="#cb18-27"></a>      <span class="at">fill =</span> <span class="st">"density of burglary risk, 2020"</span></span>
<span id="cb18-28"><a href="#cb18-28"></a>  ) <span class="sc">+</span></span>
<span id="cb18-29"><a href="#cb18-29"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb18-30"><a href="#cb18-30"></a>  <span class="fu">theme</span>(</span>
<span id="cb18-31"><a href="#cb18-31"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb18-32"><a href="#cb18-32"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey40"</span>),</span>
<span id="cb18-33"><a href="#cb18-33"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">6</span>, <span class="at">b =</span> <span class="dv">6</span>)),</span>
<span id="cb18-34"><a href="#cb18-34"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey50"</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>)</span>
<span id="cb18-35"><a href="#cb18-35"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/risk-exercise6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="check-your-understanding-1" class="level3 tutorial" data-number="11.2.3">
<h3 class="tutorial anchored" data-number="11.2.3" data-anchor-id="check-your-understanding-1"><span class="header-section-number">11.2.3</span> Check your understanding</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">quiz</span>(</span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="at">caption =</span> <span class="st">""</span>,</span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="fu">question</span>(<span class="st">"Which *one* of these statements is true?"</span>,</span>
<span id="cb19-5"><a href="#cb19-5"></a>    <span class="fu">answer</span>(<span class="st">"`hotspot_dual_kde()` requires co-ordinates to use a projected co-ordinate system (i.e. not longitude and latitude)."</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-6"><a href="#cb19-6"></a>    <span class="fu">answer</span>(<span class="st">"`hotspot_dual_kde()` can work on any co-ordinates, whether they use a geographic co-ordinate system (i.e. longitude and latitude) or a projected system."</span>),</span>
<span id="cb19-7"><a href="#cb19-7"></a>    <span class="fu">answer</span>(<span class="st">"`hotspot_dual_kde()` requires co-ordinates to use a geographic co-ordinate system (i.e. longitude and latitude)."</span>),</span>
<span id="cb19-8"><a href="#cb19-8"></a>    <span class="fu">answer</span>(<span class="st">"`hotspot_dual_kde()` does not work with co-ordinates, so it does not matter which type of co-ordinate system a dataset uses."</span>),</span>
<span id="cb19-9"><a href="#cb19-9"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-10"><a href="#cb19-10"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb19-11"><a href="#cb19-11"></a>  ),</span>
<span id="cb19-12"><a href="#cb19-12"></a>  </span>
<span id="cb19-13"><a href="#cb19-13"></a>  <span class="fu">question</span>(</span>
<span id="cb19-14"><a href="#cb19-14"></a>    <span class="st">"Why do we usually clip the result of `hotspot_dual_kde()` using `st_intersection()`?"</span>,</span>
<span id="cb19-15"><a href="#cb19-15"></a>    <span class="fu">answer</span>(<span class="st">"To eliminate any areas that we do not have data for, since displaying KDE values for such areas on a map might be misleading."</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-16"><a href="#cb19-16"></a>    <span class="fu">answer</span>(<span class="st">"To make our maps look nicer."</span>),</span>
<span id="cb19-17"><a href="#cb19-17"></a>    <span class="fu">answer</span>(<span class="st">"To transform the co-ordinate system our data uses from the system `hotspot_dual_kde()` uses to the one we need to produce a map."</span>),</span>
<span id="cb19-18"><a href="#cb19-18"></a>    <span class="fu">answer</span>(<span class="st">"To make it easier to see the other layers on our map."</span>),</span>
<span id="cb19-19"><a href="#cb19-19"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-20"><a href="#cb19-20"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb19-21"><a href="#cb19-21"></a>  )</span>
<span id="cb19-22"><a href="#cb19-22"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="finding-hotspots" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="finding-hotspots"><span class="header-section-number">11.3</span> Finding hotspots</h2>
<p>We now know how to produce a better map of the density of crime in different areas. But how do we know which areas count as hotspots and which don’t?</p>
<p>There are several ways to answer this question. If we were planning a particular activity to respond to a crime problem, we might know what resources we had available to respond. For example, we might know that we have enough funding to provide crime-prevention visits to 100 locations. In that case, we can order the cells in a KDE object according to which have the highest estimates of risk, then count all the premises in each cell until we have reached our limit.</p>
<p>To do this, we need to know how many buildings are in each grid cell. We have already learned how to count crimes in areas when we learned about mapping area data. When we want to count crimes in each cell in a grid, we can use the <code>hotspot_count()</code> function from the <code>sfhotspot</code> package to count the number of buildings in each grid cell. We will then be able to combine those building counts to the estimates of burglary risk we have already calculated.</p>
<div class="box notewell">
<p>So that we can join the building counts to the burglary risk estimates, it is important that both layers are based on the same grid. In the code above we created a grid with the code <code>hotspot_grid(wards, cell_size = 100)</code>, so to make sure we use the same grid to count buildings we can either use that same code again, or we could have saved the result of that code as an object (maybe called <code>nottingham_wards_grid</code>) and then provided that object to the <code>grid</code> argument of both <code>hotspot_dual_kde()</code> and <code>hotspot_count()</code>.</p>
<p>Note that the results of <code>hotspot_dual_kde()</code> and <code>hotspot_count()</code> will only have the same structure before we wrangle then any further, for example by using <code>filter()</code> as in the previous section. This is why we saved an unfiltered version of the dataset in the <code>burglary_risk</code> object.</p>
</div>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb20" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>building_counts <span class="ot">&lt;-</span> <span class="fu">hotspot_count</span>(</span>
<span id="cb20-2"><a href="#cb20-2"></a>  nottingham_building_centroids, </span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="at">grid =</span> <span class="fu">hotspot_grid</span>(wards, <span class="at">cell_size =</span> <span class="dv">100</span>)</span>
<span id="cb20-4"><a href="#cb20-4"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="co"># Clip the result to the area for which we have data</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>  <span class="fu">st_intersection</span>(wards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">head</span>(building_counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 6 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 455826.6 ymin: 338782.9 xmax: 456354.2 ymax: 338909
Projected CRS: OSGB36 / British National Grid
# A tibble: 6 × 4
      n ward_code ward_name                                             geometry
  &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;                                            &lt;POLYGON [m]&gt;
1     0 E05012277 Castle    ((456061.5 338809, 456061.5 338799.8, 456006.6 3388…
2     0 E05012277 Castle    ((456061.5 338809, 456161.5 338809, 456161.5 338790…
3     1 E05012277 Castle    ((456161.5 338809, 456261.5 338809, 456261.5 338786…
4     1 E05012277 Castle    ((456261.5 338809, 456354.2 338809, 456261.5 338786…
5     2 E05012277 Castle    ((455861.5 338909, 455861.5 338888.8, 455826.6 3389…
6     4 E05012277 Castle    ((455861.5 338909, 455961.5 338909, 455961.5 338830…</code></pre>
</div>
</div>
<p>The <code>building_counts</code> and <code>burglary_risk</code> objects have the same structure: each row represents a cell in the same grid, and the rows are in the same order (because both grids were created by identical calls to <code>hotspot_grid()</code>). This means we can combine the two objects using the <code>bind_cols()</code> function from the <code>dplyr</code> package (part of the tidyverse).</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb24" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>burglary_risk_bldg <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(burglary_risk, building_counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>New names:
• `n` -&gt; `n...1`
• `ward_code` -&gt; `ward_code...3`
• `ward_name` -&gt; `ward_name...4`
• `geometry` -&gt; `geometry...5`
• `n` -&gt; `n...6`
• `ward_code` -&gt; `ward_code...7`
• `ward_name` -&gt; `ward_name...8`
• `geometry` -&gt; `geometry...9`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">head</span>(burglary_risk_bldg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 6 × 9
  n...1    kde ward_code...3 ward_name...4                    geometry...5 n...6
  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;                           &lt;POLYGON [m]&gt; &lt;dbl&gt;
1     0 0.0175 E05012277     Castle        ((456061.5 338809, 456061.5 33…     0
2     0 0.0172 E05012277     Castle        ((456061.5 338809, 456161.5 33…     0
3     0 0.0222 E05012277     Castle        ((456161.5 338809, 456261.5 33…     1
4     0 0.0271 E05012277     Castle        ((456261.5 338809, 456354.2 33…     1
5     0 0.0204 E05012277     Castle        ((455861.5 338909, 455861.5 33…     2
6     0 0.0264 E05012277     Castle        ((455861.5 338909, 455961.5 33…     4
# ℹ 3 more variables: ward_code...7 &lt;chr&gt;, ward_name...8 &lt;chr&gt;,
#   geometry...9 &lt;POLYGON [m]&gt;</code></pre>
</div>
</div>
<p>Looking at this object, we can see that <code>bind_cols()</code> has changed the column names. This is because some of the column names were duplicated across the two datasets. Some of these new column names, such as <code>ward_code...3</code> would be difficult to work with, so lets go back and remove duplicate columns before we combine the two datasets together.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb28" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>burglary_risk_bldg <span class="ot">&lt;-</span> burglary_risk <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2"></a>  <span class="co"># Keep only the `n` and `kde` columns, renaming `n` to `burglary_count`</span></span>
<span id="cb28-3"><a href="#cb28-3"></a>  <span class="co"># because there is also a column called `n` in the `building_counts` object</span></span>
<span id="cb28-4"><a href="#cb28-4"></a>  <span class="fu">select</span>(<span class="at">burglary_count =</span> n, kde) <span class="sc">|&gt;</span> </span>
<span id="cb28-5"><a href="#cb28-5"></a>  <span class="co"># Remove the geometry column (since an identical one exists in </span></span>
<span id="cb28-6"><a href="#cb28-6"></a>  <span class="co"># `building_counts`). Note that we do this separately because we can't use</span></span>
<span id="cb28-7"><a href="#cb28-7"></a>  <span class="co"># `select()` to remove the `geometry` column.</span></span>
<span id="cb28-8"><a href="#cb28-8"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-9"><a href="#cb28-9"></a>  <span class="fu">bind_cols</span>(building_counts) <span class="sc">|&gt;</span> </span>
<span id="cb28-10"><a href="#cb28-10"></a>  <span class="co"># After calling `bind_cols()` it is safe to use `filter()` to wrangle the</span></span>
<span id="cb28-11"><a href="#cb28-11"></a>  <span class="co"># data</span></span>
<span id="cb28-12"><a href="#cb28-12"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(kde))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now order the dataset with the cells with highest burglary risk at the top and calculate the <em>cumulative total</em> (also called a running total) of buildings using the <code>cumsum()</code> function. We can use this running total to find the 100 buildings in the cells with highest burglary risk.</p>
<p>We could now plot the <code>cells_for_prevention</code> object on a map to show the grid cells containing the buildings that would receive the crime-prevention visits. We could also use <code>st_join()</code> to join those cells to the dataset of buildings in the <code>nottingham_building_centroids</code> object, which would give us a list of buildings to visit.</p>
<section id="distinguishing-hotspots-from-random-variation" class="level3" data-number="11.3.1">
<h3 data-number="11.3.1" class="anchored" data-anchor-id="distinguishing-hotspots-from-random-variation"><span class="header-section-number">11.3.1</span> Distinguishing hotspots from random variation</h3>
<p>The density maps below show density estimates based on 1,000 points placed completely at random on 16 different maps. There are no real patterns in the data except for statistical noise. Nevertheless, the KDE process makes it appear that there are patterns in the data (if you reload this tutorial, these maps will change appearance completely, since the random numbers used for the x and y co-ordinates of the points will be regenerated).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">tibble</span>(</span>
<span id="cb29-2"><a href="#cb29-2"></a>  <span class="at">x =</span> <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1000</span> <span class="sc">*</span> <span class="dv">16</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">100</span>), </span>
<span id="cb29-3"><a href="#cb29-3"></a>  <span class="at">y =</span> <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1000</span> <span class="sc">*</span> <span class="dv">16</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">100</span>),</span>
<span id="cb29-4"><a href="#cb29-4"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>, <span class="at">each =</span> <span class="dv">1000</span>)</span>
<span id="cb29-5"><a href="#cb29-5"></a>)  <span class="sc">|&gt;</span>  </span>
<span id="cb29-6"><a href="#cb29-6"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb29-7"><a href="#cb29-7"></a>  <span class="fu">geom_density_2d_filled</span>(<span class="fu">aes</span>(x, y), <span class="at">bins =</span> <span class="dv">9</span>) <span class="sc">+</span> </span>
<span id="cb29-8"><a href="#cb29-8"></a>  <span class="fu">scale_fill_brewer</span>(</span>
<span id="cb29-9"><a href="#cb29-9"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="fu">rep</span>(<span class="st">""</span>, <span class="dv">7</span>), <span class="st">"higher"</span>),</span>
<span id="cb29-10"><a href="#cb29-10"></a>    <span class="at">palette =</span> <span class="st">"Oranges"</span>, </span>
<span id="cb29-11"><a href="#cb29-11"></a>    <span class="at">direction =</span> <span class="dv">1</span>,</span>
<span id="cb29-12"><a href="#cb29-12"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-13"><a href="#cb29-13"></a>  ) <span class="sc">+</span></span>
<span id="cb29-14"><a href="#cb29-14"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(group), <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb29-15"><a href="#cb29-15"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb29-16"><a href="#cb29-16"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"density"</span>) <span class="sc">+</span></span>
<span id="cb29-17"><a href="#cb29-17"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb29-18"><a href="#cb29-18"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/random-map-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is a problem because we might end up responding to an apparent problem that is nothing but an artefact of the random variation that we expect to see in many processes, including crime.</p>
<p>If the police and other agencies looked at these patterns and did nothing in response to them, it is likely that over time some of the areas with high density would become areas of low density, and <em>vice versa</em>. However, the harm caused by crime means it is very hard for agencies to justify sitting back and do nothing to respond to it – many people would consider it immoral to do so. So police and other agencies are very likely to try to respond to crime patterns, even if those patterns might have occurred by chance. This is very frustrating, because if we were to go back and look at the same data in a few months time it is very likely that the apparent hotspots would have shifted to somewhere different, making all the effort spent in responding to crime seem worthless (which, if the apparent patterns were actually artefacts of the KDE process, it may have been).</p>
<p>You might be thinking it’s better safe than sorry, and that police should respond to the apparent patterns just in case they represent real concentrations in crime. But police resources are always scarce, so responding to one problem in one place means not responding to another problem in another place. This is known as the <em>opportunity cost</em> of acting: if police focus their limited resources in one area, that comes at the cost of not being able to deploy those resources in other areas that might need it more.</p>
<p>We can try to avoid this problem of wasting resources responding to random variation in crime by determining whether the number of crimes in an area is more than the greatest number we would reasonably expect if there were no actual patterns in the data (if you have studied statistics before, you might recognise this as a description of a <em>null hypothesis</em>, but you don’t need to have studied statistics to apply the techniques in this course).</p>
<p>To determine if the number of crimes in each area is greater than we would expect by chance, we can use the <em>Getis-Ord Gi* statistic</em> (also called the <em>local G</em> statistic, spoken out-loud as the <em>G-I star statistic</em>). If the Gi* statistic for an area is greater than a certain value, we can say that the number of crimes in that area is higher than we would expect if there were no patterns in the data. We will call areas with more crimes than we would expect by chance as <em>hotspots</em>.</p>
<p>To see how this is done, watch this video that walks through the code needed to make a hotspot map using the Gi* statistic.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/VhVBfvfp8OY" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>We can calculate the Gi* statistic using the <code>hotspot_gistar()</code> function from the <code>sfhotspot</code> package. This works in a similar way to the <code>hotspot_kde()</code> function, in that it takes an SF object of the locations of crimes and returns an SF object with a grid of cells, along with the Gi* value for each grid cell. Like <code>hotspot_kde()</code>, <code>hotspot_gistar()</code> will choose default values for several ways in which we could fine-tune the calculation of the Gi* statistic, but we could over-ride these defaults if we wanted to.</p>
<p>In this example, we will find the hotspots of robbery in Nottingham in 2020, based on a grid of 100-metre cells. We will store this in an object called <code>robbery</code>, transform it to use the British National Grid co-ordinate system (so we can specify the cell size in metres) and then use the resulting object to calculate the Gi* values.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb30" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>robbery <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb30-3"><a href="#cb30-3"></a>  <span class="fu">st_transform</span>(<span class="dv">27700</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Rows: 555 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): location, lsoa_code
dbl  (2): longitude, latitude
date (1): month

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>robbery_gistar <span class="ot">&lt;-</span> <span class="fu">hotspot_gistar</span>(robbery, <span class="at">cell_size =</span> <span class="dv">100</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-2"><a href="#cb32-2"></a></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="co"># Use the `sample_n()` function from the `dplyr` package to return a random</span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="co"># sample of 10 rows from the result</span></span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="fu">sample_n</span>(robbery_gistar, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 10 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 451367.5 ymin: 334874.1 xmax: 456867.5 ymax: 345774.1
Projected CRS: OSGB36 / British National Grid
# A tibble: 10 × 5
       n   kde gistar pvalue                                            geometry
 * &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;                                       &lt;POLYGON [m]&gt;
 1     0 32.9  -0.498  0.618 ((454667.5 344874.1, 454667.5 344974.1, 454767.5 3…
 2     0 23.3   0.331  0.741 ((455267.5 339074.1, 455267.5 339174.1, 455367.5 3…
 3     0  7.62 -0.498  0.618 ((455967.5 337774.1, 455967.5 337874.1, 456067.5 3…
 4     0 14.7  -0.498  0.618 ((453067.5 344174.1, 453067.5 344274.1, 453167.5 3…
 5     0  4.44 -0.407  0.684 ((452367.5 344774.1, 452367.5 344874.1, 452467.5 3…
 6     0  4.71 -0.498  0.618 ((454567.5 335874.1, 454567.5 335974.1, 454667.5 3…
 7     0 19.4  -0.498  0.618 ((454867.5 334874.1, 454867.5 334974.1, 454967.5 3…
 8     0  5.66 -0.498  0.618 ((451367.5 339674.1, 451367.5 339774.1, 451467.5 3…
 9     1 12.0   0.331  0.741 ((456767.5 345674.1, 456767.5 345774.1, 456867.5 3…
10     0 15.8   0.331  0.741 ((452667.5 343074.1, 452667.5 343174.1, 452767.5 3…</code></pre>
</div>
</div>
<p>The <code>robbery_gistar</code> object contains one row for each cell in a grid of cells covering the area of the robbery data. Each row has four columns:</p>
<ul>
<li><code>n</code> shows the number of robberies that occurred in that grid cell,</li>
<li><code>kde</code> shows the density of robberies in that cell,</li>
<li><code>gistar</code> shows the Gi* value for that cell, and</li>
<li><code>pvalue</code> shows the <span class="math inline">\(p\)</span>-value for that cell.</li>
</ul>
<p>The Gi* statistic is an example of a more general group of statistics called <span class="math inline">\(Z\)</span> <em>scores</em>. Statisticians and data analysts compare the <span class="math inline">\(Z\)</span> scores produced by statistical procedures such as <code>hotspot_gistar()</code> to reference values to decide if a <span class="math inline">\(Z\)</span> score is large enough to be treated as statistically significant, i.e.&nbsp; if it is large enough to conclude that it is larger than we would expect if there were no actual patterns in the data. Deciding on the right reference value to compare a <span class="math inline">\(Z\)</span> score to can be difficult because of what’s known as the multiple comparison problem (which we don’t need to go into detail about). Fortunately, the values in the <code>pvalue</code> column have already been automatically adjusted to take account of the multiple comparison problem, so we can interpret the <span class="math inline">\(p\)</span>-values instead of interpreting the Gi* statistic directly.</p>
<div class="box notewell">
<p>Since Gi* is a relative measure, if you have data for a large area (e.g.&nbsp;a country) but only want to show data for a smaller area (e.g.&nbsp;a city), the Gi* values will be influenced by the large areas with no crime and all of the city is likely to be identified as a hotspot. To prevent this, it is important to clip the dataset before calculating the Gi* values, as well as then clipping afterwards where necessary.</p>
</div>
<p>By convention, <span class="math inline">\(p\)</span>-values are considered to be significant if they are <em>less than 0.05</em>. So if <span class="math inline">\(p&lt;0.05\)</span>, we can say that the number of robberies occurring in a given grid cell is significantly different from zero. Values of Gi* greater than zero indicate cells with more robberies than expected and values of Gi* less than zero indicate cells with fewer robberies than expected. We can combine these two values to find cells with significantly <em>more</em> robberies than expected by chance, which are those cells for which <span class="math inline">\(Z&gt;0\)</span> and <span class="math inline">\(p&lt;0.05\)</span>. To put that into R code, we would write <code>gistar &gt; 0</code> and <code>p &lt; 0.05</code>.</p>
<p>We could use this information in various ways. For example, if we wanted to give local police officers a printed map of which areas to patrol, we could simply show the significant hotspot cells over a base map.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb34" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="co"># Plot a map</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb34-5"><a href="#cb34-5"></a>    <span class="at">data =</span> <span class="fu">filter</span>(robbery_gistar, gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>), </span>
<span id="cb34-6"><a href="#cb34-6"></a>    <span class="at">fill =</span> <span class="st">"red"</span>, </span>
<span id="cb34-7"><a href="#cb34-7"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>,</span>
<span id="cb34-8"><a href="#cb34-8"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb34-9"><a href="#cb34-9"></a>  ) <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb34-11"><a href="#cb34-11"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/hotspot-exercise4-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Since <code>hotspot_gistar()</code> also estimates density for each grid cell, we could more usefully show the density of robberies in each cell, but only for cells that the Gi* values showed were significant hotspots.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb35" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb35-4"><a href="#cb35-4"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde),</span>
<span id="cb35-5"><a href="#cb35-5"></a>    <span class="at">data =</span> <span class="fu">filter</span>(robbery_gistar, gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>), </span>
<span id="cb35-6"><a href="#cb35-6"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>,</span>
<span id="cb35-7"><a href="#cb35-7"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb35-8"><a href="#cb35-8"></a>  ) <span class="sc">+</span></span>
<span id="cb35-9"><a href="#cb35-9"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb35-10"><a href="#cb35-10"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb35-11"><a href="#cb35-11"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/hotspot-exercise5-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>This map could be very useful for police officers deciding where to conduct anti-robbery patrols, because it not only shows the areas with the highest density of robberies but only shows those areas if there are more robberies than we would expect by chance. This makes it more likely that officers won’t waste time chasing apparent patterns that are actually the result of random variation.</p>
</section>
<section id="check-your-understanding-2" class="level3 tutorial" data-number="11.3.2">
<h3 class="tutorial anchored" data-number="11.3.2" data-anchor-id="check-your-understanding-2"><span class="header-section-number">11.3.2</span> Check your understanding</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">quiz</span>(</span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="at">caption =</span> <span class="st">""</span>,</span>
<span id="cb36-3"><a href="#cb36-3"></a></span>
<span id="cb36-4"><a href="#cb36-4"></a>  <span class="fu">question</span>(<span class="st">"`robbery_gi` is an object storing a result produced by the `hotspot_gistar()` function. Which of these pieces of code could be used to extract _only_ those rows in the data with significant p-values?"</span>,</span>
<span id="cb36-5"><a href="#cb36-5"></a>    <span class="fu">answer</span>(<span class="st">"`filter(robbery_gi, pvalue &lt; 0.05)`"</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb36-6"><a href="#cb36-6"></a>    <span class="fu">answer</span>(</span>
<span id="cb36-7"><a href="#cb36-7"></a>      <span class="st">"`filter(robbery_gi, pvalue &gt; 0.05)`"</span>,</span>
<span id="cb36-8"><a href="#cb36-8"></a>      <span class="at">message =</span> <span class="st">"That code would extract only _non-significant_ p-values. Try again!"</span></span>
<span id="cb36-9"><a href="#cb36-9"></a>    ),</span>
<span id="cb36-10"><a href="#cb36-10"></a>    <span class="fu">answer</span>(</span>
<span id="cb36-11"><a href="#cb36-11"></a>      <span class="st">"`filter(robbery_gi, pvalue &lt;= 0.05)`"</span>,</span>
<span id="cb36-12"><a href="#cb36-12"></a>      <span class="at">message =</span> <span class="st">"Almost right, but not quite. Try re-reading the section of the tutorial above."</span></span>
<span id="cb36-13"><a href="#cb36-13"></a>    ),</span>
<span id="cb36-14"><a href="#cb36-14"></a>    <span class="fu">answer</span>(</span>
<span id="cb36-15"><a href="#cb36-15"></a>      <span class="st">"`filter(robbery_gi, pvalue == 0.05)`"</span>,</span>
<span id="cb36-16"><a href="#cb36-16"></a>      <span class="at">message =</span> <span class="st">"That's not right. Try re-reading the section of the tutorial above."</span></span>
<span id="cb36-17"><a href="#cb36-17"></a>    ),</span>
<span id="cb36-18"><a href="#cb36-18"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb36-19"><a href="#cb36-19"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb36-20"><a href="#cb36-20"></a>  ),</span>
<span id="cb36-21"><a href="#cb36-21"></a>  </span>
<span id="cb36-22"><a href="#cb36-22"></a>  <span class="fu">question</span>(<span class="st">"Which *one* of these statements is true about an SF object called `robberies_in_nottingham`?"</span>,</span>
<span id="cb36-23"><a href="#cb36-23"></a>    <span class="fu">answer</span>(<span class="st">"We cannot remove the `geometry` column of an SF object with `select()`, so we must use `st_drop_geometry()` instead."</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb36-24"><a href="#cb36-24"></a>    <span class="fu">answer</span>(<span class="st">"We can remove the `geometry` column with the code `select(robberies_in_nottingham, -geometry)`."</span>),</span>
<span id="cb36-25"><a href="#cb36-25"></a>    <span class="fu">answer</span>(<span class="st">"We can remove the `geometry` column with the code `filter(robberies_in_nottingham, -geometry)`."</span>),</span>
<span id="cb36-26"><a href="#cb36-26"></a>    <span class="fu">answer</span>(<span class="st">"There is no way to remove the `geometry` column from an SF object."</span>),</span>
<span id="cb36-27"><a href="#cb36-27"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb36-28"><a href="#cb36-28"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb36-29"><a href="#cb36-29"></a>  )</span>
<span id="cb36-30"><a href="#cb36-30"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="putting-it-all-together" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="putting-it-all-together"><span class="header-section-number">11.4</span> Putting it all together</h2>
<div class="box welldone">
<p>In this tutorial we have learned about hotspots, how to create dual KDE maps and how to find significant hotspots using the Gi* statistic. We can put this all together to create a complete script for producing a map of robbery hotspots in Nottingham</p>
</div>
<p>The following code is all that is needed to produce this map. Read through the comments accompanying the code to see how what we have learned in this tutorial fits together, then run the code to produce the map.</p>
<div class="box notewell">
<p>It is possible that this code will not run in this tutorial window because of limits on how long code can run in an R tutorial. If that happens, paste the code below into a blank R script in RStudio and run it from there to see the map.</p>
</div>
<div class="cell" data-exercise="true" data-exercise.lines="66">
<div class="sourceCode cell-code" id="cb37" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># Prepare ----------------------------------------------------------------------</span></span>
<span id="cb37-2"><a href="#cb37-2"></a></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="co"># Load packages</span></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="fu">library</span>(sf)</span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="fu">library</span>(sfhotspot)</span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb37-8"><a href="#cb37-8"></a></span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="co"># Load data and transform to British National Grid, which is easier to work with</span></span>
<span id="cb37-10"><a href="#cb37-10"></a><span class="co"># for functions that use spatial units such as metres</span></span>
<span id="cb37-11"><a href="#cb37-11"></a>robbery <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-12"><a href="#cb37-12"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-13"><a href="#cb37-13"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb37-14"><a href="#cb37-14"></a>nottingham_wards <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-15"><a href="#cb37-15"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb37-16"><a href="#cb37-16"></a></span>
<span id="cb37-17"><a href="#cb37-17"></a></span>
<span id="cb37-18"><a href="#cb37-18"></a><span class="co"># Find significant grid cells --------------------------------------------------</span></span>
<span id="cb37-19"><a href="#cb37-19"></a></span>
<span id="cb37-20"><a href="#cb37-20"></a><span class="co"># Calculate Gi* statistic, filter for only significant hotspot cells and clip to</span></span>
<span id="cb37-21"><a href="#cb37-21"></a><span class="co"># the city boundary</span></span>
<span id="cb37-22"><a href="#cb37-22"></a>robbery_gi <span class="ot">&lt;-</span> robbery <span class="sc">|&gt;</span> </span>
<span id="cb37-23"><a href="#cb37-23"></a>  <span class="fu">hotspot_gistar</span>(<span class="at">cell_size =</span> <span class="dv">100</span>, <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-24"><a href="#cb37-24"></a>  <span class="fu">filter</span>(gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-25"><a href="#cb37-25"></a>  <span class="fu">st_intersection</span>(nottingham_wards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="co"># Plot map ---------------------------------------------------------------------</span></span>
<span id="cb39-2"><a href="#cb39-2"></a></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb39-4"><a href="#cb39-4"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>  <span class="co"># Add density for significant cells</span></span>
<span id="cb39-6"><a href="#cb39-6"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb39-7"><a href="#cb39-7"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb39-8"><a href="#cb39-8"></a>    <span class="at">data =</span> robbery_gi, </span>
<span id="cb39-9"><a href="#cb39-9"></a>    <span class="at">alpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb39-10"><a href="#cb39-10"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb39-11"><a href="#cb39-11"></a>  ) <span class="sc">+</span></span>
<span id="cb39-12"><a href="#cb39-12"></a>  <span class="co"># Add ward boundaries</span></span>
<span id="cb39-13"><a href="#cb39-13"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> nottingham_wards, <span class="at">colour =</span> <span class="st">"grey70"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb39-14"><a href="#cb39-14"></a>  <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb39-15"><a href="#cb39-15"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(robbery_gi, kde)),</span>
<span id="cb39-16"><a href="#cb39-16"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>),</span>
<span id="cb39-17"><a href="#cb39-17"></a>    <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb39-18"><a href="#cb39-18"></a>  ) <span class="sc">+</span></span>
<span id="cb39-19"><a href="#cb39-19"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb39-20"><a href="#cb39-20"></a>  <span class="fu">labs</span>(</span>
<span id="cb39-21"><a href="#cb39-21"></a>      <span class="at">title =</span> <span class="st">"Nottingham robbery hotspots"</span>,</span>
<span id="cb39-22"><a href="#cb39-22"></a>      <span class="at">subtitle =</span> <span class="fu">str_glue</span>(</span>
<span id="cb39-23"><a href="#cb39-23"></a>        <span class="st">"density of robbery in places with more violence than expected by "</span>,</span>
<span id="cb39-24"><a href="#cb39-24"></a>        <span class="st">"chance"</span></span>
<span id="cb39-25"><a href="#cb39-25"></a>      ),</span>
<span id="cb39-26"><a href="#cb39-26"></a>      <span class="co"># Don't forget to add the licence statement -- it's a legal requirement!</span></span>
<span id="cb39-27"><a href="#cb39-27"></a>      <span class="at">caption =</span> <span class="fu">str_glue</span>(</span>
<span id="cb39-28"><a href="#cb39-28"></a>        <span class="st">"Contains public sector information licensed under the Open "</span>,</span>
<span id="cb39-29"><a href="#cb39-29"></a>        <span class="st">"Government Licence v3.0. Map data from OpenStreetMap."</span></span>
<span id="cb39-30"><a href="#cb39-30"></a>      ),</span>
<span id="cb39-31"><a href="#cb39-31"></a>      <span class="at">fill =</span> <span class="fu">str_wrap</span>(<span class="st">"density of robbery at significant hotspots, 2022"</span>, <span class="dv">15</span>)</span>
<span id="cb39-32"><a href="#cb39-32"></a>  ) <span class="sc">+</span></span>
<span id="cb39-33"><a href="#cb39-33"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb39-34"><a href="#cb39-34"></a>  <span class="fu">theme</span>(</span>
<span id="cb39-35"><a href="#cb39-35"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey40"</span>, <span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb39-36"><a href="#cb39-36"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">6</span>, <span class="at">b =</span> <span class="dv">6</span>)),</span>
<span id="cb39-37"><a href="#cb39-37"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey50"</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>)</span>
<span id="cb39-38"><a href="#cb39-38"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/final-exercise1-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";
  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    btn.onclick = check_func;
    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../10_place_data/index.html" class="pagination-link" aria-label="Using data about places">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../12_messy_data/index.html" class="pagination-link" aria-label="Handling messy data">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb40" data-shortcodes="false" data-code-line-numbers=""><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb40-1"><a href="#cb40-1"></a><span class="co">---</span></span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="an">execute:</span></span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="co">  freeze: auto</span></span>
<span id="cb40-4"><a href="#cb40-4"></a><span class="co">---</span></span>
<span id="cb40-5"><a href="#cb40-5"></a></span>
<span id="cb40-6"><a href="#cb40-6"></a><span class="fu"># Mapping hotspots {#sec-mapping-hotspots}</span></span>
<span id="cb40-7"><a href="#cb40-7"></a></span>
<span id="cb40-8"><a href="#cb40-8"></a></span>
<span id="cb40-9"><a href="#cb40-9"></a>**Learn what crime hotspots are, why they are important and how to map them.**</span>
<span id="cb40-10"><a href="#cb40-10"></a></span>
<span id="cb40-11"><a href="#cb40-11"></a></span>
<span id="cb40-12"><a href="#cb40-12"></a>::: {.box .load-tutorial}</span>
<span id="cb40-13"><a href="#cb40-13"></a>To load the <span class="co">[</span><span class="ot">interactive tutorial</span><span class="co">](../#how-to-use-this-book)</span> for this chapter, copy and paste the following code into the RStudio console:</span>
<span id="cb40-14"><a href="#cb40-14"></a></span>
<span id="cb40-15"><a href="#cb40-15"></a><span class="in">```r</span></span>
<span id="cb40-16"><a href="#cb40-16"></a>crimemapping<span class="sc">::</span><span class="fu">tutorial</span>(<span class="st">"11_mapping_hotspots"</span>)</span>
<span id="cb40-17"><a href="#cb40-17"></a><span class="in">```</span></span>
<span id="cb40-18"><a href="#cb40-18"></a></span>
<span id="cb40-19"><a href="#cb40-19"></a>and press <span class="in">`Enter`</span>.</span>
<span id="cb40-20"><a href="#cb40-20"></a>:::</span>
<span id="cb40-21"><a href="#cb40-21"></a></span>
<span id="cb40-22"><a href="#cb40-22"></a></span>
<span id="cb40-23"><a href="#cb40-23"></a><span class="in">```{r setup, include=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb40-24"><a href="#cb40-24"></a><span class="in">#| echo: false</span></span>
<span id="cb40-25"><a href="#cb40-25"></a><span class="in">#| include: false</span></span>
<span id="cb40-26"><a href="#cb40-26"></a></span>
<span id="cb40-27"><a href="#cb40-27"></a><span class="in">source(here::here("mask_learnr_functions.R"))</span></span>
<span id="cb40-28"><a href="#cb40-28"></a></span>
<span id="cb40-29"><a href="#cb40-29"></a></span>
<span id="cb40-30"><a href="#cb40-30"></a></span>
<span id="cb40-31"><a href="#cb40-31"></a><span class="in"># Load packages</span></span>
<span id="cb40-32"><a href="#cb40-32"></a><span class="in">library(ggspatial)</span></span>
<span id="cb40-33"><a href="#cb40-33"></a><span class="in">library(osmdata)</span></span>
<span id="cb40-34"><a href="#cb40-34"></a><span class="in">library(sf)</span></span>
<span id="cb40-35"><a href="#cb40-35"></a><span class="in">library(sfhotspot)</span></span>
<span id="cb40-36"><a href="#cb40-36"></a><span class="in">library(tidyverse)</span></span>
<span id="cb40-37"><a href="#cb40-37"></a></span>
<span id="cb40-38"><a href="#cb40-38"></a></span>
<span id="cb40-39"><a href="#cb40-39"></a><span class="in"># Load data --------------------------------------------------------------------</span></span>
<span id="cb40-40"><a href="#cb40-40"></a></span>
<span id="cb40-41"><a href="#cb40-41"></a></span>
<span id="cb40-42"><a href="#cb40-42"></a><span class="in">## Boundaries ----</span></span>
<span id="cb40-43"><a href="#cb40-43"></a></span>
<span id="cb40-44"><a href="#cb40-44"></a><span class="in">wards &lt;- read_sf("https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg") |&gt; </span></span>
<span id="cb40-45"><a href="#cb40-45"></a><span class="in">  st_transform("EPSG:27700") |&gt; </span></span>
<span id="cb40-46"><a href="#cb40-46"></a><span class="in">  filter(ward_name %in% c("Castle", "Lenton &amp; Wollaton East", "Meadows"))</span></span>
<span id="cb40-47"><a href="#cb40-47"></a></span>
<span id="cb40-48"><a href="#cb40-48"></a><span class="in">burglaries &lt;- read_csv("https://mpjashby.github.io/crimemappingdata/nottingham_burglary.csv.gz") |&gt; </span></span>
<span id="cb40-49"><a href="#cb40-49"></a><span class="in">  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) |&gt; </span></span>
<span id="cb40-50"><a href="#cb40-50"></a><span class="in">  st_transform("EPSG:27700") |&gt; </span></span>
<span id="cb40-51"><a href="#cb40-51"></a><span class="in">  st_intersection(wards)</span></span>
<span id="cb40-52"><a href="#cb40-52"></a></span>
<span id="cb40-53"><a href="#cb40-53"></a><span class="in">robbery &lt;- read_csv("https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz") |&gt; </span></span>
<span id="cb40-54"><a href="#cb40-54"></a><span class="in">  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) |&gt; </span></span>
<span id="cb40-55"><a href="#cb40-55"></a><span class="in">  st_transform(27700)</span></span>
<span id="cb40-56"><a href="#cb40-56"></a></span>
<span id="cb40-57"><a href="#cb40-57"></a><span class="in">robbery_gistar &lt;- hotspot_gistar(robbery, cell_size = 100)</span></span>
<span id="cb40-58"><a href="#cb40-58"></a></span>
<span id="cb40-59"><a href="#cb40-59"></a></span>
<span id="cb40-60"><a href="#cb40-60"></a><span class="in">## Buildings ----</span></span>
<span id="cb40-61"><a href="#cb40-61"></a></span>
<span id="cb40-62"><a href="#cb40-62"></a><span class="in">if (file.exists("www/nottingham_buildings.Rds")) {</span></span>
<span id="cb40-63"><a href="#cb40-63"></a><span class="in">  nottingham_buildings &lt;- read_rds("www/nottingham_buildings.Rds")</span></span>
<span id="cb40-64"><a href="#cb40-64"></a><span class="in">} else {</span></span>
<span id="cb40-65"><a href="#cb40-65"></a><span class="in">  nottingham_buildings &lt;- wards |&gt; </span></span>
<span id="cb40-66"><a href="#cb40-66"></a><span class="in">    st_transform("EPSG:4326") |&gt; </span></span>
<span id="cb40-67"><a href="#cb40-67"></a><span class="in">    st_bbox() |&gt; </span></span>
<span id="cb40-68"><a href="#cb40-68"></a><span class="in">    opq() |&gt; </span></span>
<span id="cb40-69"><a href="#cb40-69"></a><span class="in">    add_osm_feature(key = "building") |&gt; </span></span>
<span id="cb40-70"><a href="#cb40-70"></a><span class="in">    osmdata_sf()</span></span>
<span id="cb40-71"><a href="#cb40-71"></a><span class="in">}</span></span>
<span id="cb40-72"><a href="#cb40-72"></a></span>
<span id="cb40-73"><a href="#cb40-73"></a><span class="in">nottingham_building_centroids &lt;- bind_rows(</span></span>
<span id="cb40-74"><a href="#cb40-74"></a><span class="in">  st_centroid(pluck(nottingham_buildings, "osm_polygons")),</span></span>
<span id="cb40-75"><a href="#cb40-75"></a><span class="in">  st_centroid(pluck(nottingham_buildings, "osm_multipolygons"))</span></span>
<span id="cb40-76"><a href="#cb40-76"></a><span class="in">) |&gt; </span></span>
<span id="cb40-77"><a href="#cb40-77"></a><span class="in">  st_transform("EPSG:27700") |&gt; </span></span>
<span id="cb40-78"><a href="#cb40-78"></a><span class="in">  st_intersection(wards)</span></span>
<span id="cb40-79"><a href="#cb40-79"></a></span>
<span id="cb40-80"><a href="#cb40-80"></a><span class="in">building_counts &lt;- hotspot_count(</span></span>
<span id="cb40-81"><a href="#cb40-81"></a><span class="in">  nottingham_building_centroids, </span></span>
<span id="cb40-82"><a href="#cb40-82"></a><span class="in">  grid = hotspot_grid(wards, cell_size = 100)</span></span>
<span id="cb40-83"><a href="#cb40-83"></a><span class="in">) |&gt; </span></span>
<span id="cb40-84"><a href="#cb40-84"></a><span class="in">  # Clip the result to the area for which we have data</span></span>
<span id="cb40-85"><a href="#cb40-85"></a><span class="in">  st_intersection(wards)</span></span>
<span id="cb40-86"><a href="#cb40-86"></a></span>
<span id="cb40-87"><a href="#cb40-87"></a></span>
<span id="cb40-88"><a href="#cb40-88"></a><span class="in">## Burglary risk ----</span></span>
<span id="cb40-89"><a href="#cb40-89"></a></span>
<span id="cb40-90"><a href="#cb40-90"></a><span class="in">if (file.exists("www/nottingham_burglary_risk.Rds")) {</span></span>
<span id="cb40-91"><a href="#cb40-91"></a></span>
<span id="cb40-92"><a href="#cb40-92"></a><span class="in">  burglary_risk &lt;- read_rds("www/nottingham_burglary_risk.Rds")</span></span>
<span id="cb40-93"><a href="#cb40-93"></a></span>
<span id="cb40-94"><a href="#cb40-94"></a><span class="in">} else {</span></span>
<span id="cb40-95"><a href="#cb40-95"></a></span>
<span id="cb40-96"><a href="#cb40-96"></a><span class="in">  burglary_risk &lt;- hotspot_dual_kde(</span></span>
<span id="cb40-97"><a href="#cb40-97"></a><span class="in">    burglaries, </span></span>
<span id="cb40-98"><a href="#cb40-98"></a><span class="in">    nottingham_building_centroids, </span></span>
<span id="cb40-99"><a href="#cb40-99"></a><span class="in">    bandwidth_adjust = 0.25, </span></span>
<span id="cb40-100"><a href="#cb40-100"></a><span class="in">    grid = hotspot_grid(wards, cell_size = 100)</span></span>
<span id="cb40-101"><a href="#cb40-101"></a><span class="in">  ) |&gt; </span></span>
<span id="cb40-102"><a href="#cb40-102"></a><span class="in">    st_intersection(wards)</span></span>
<span id="cb40-103"><a href="#cb40-103"></a><span class="in">  </span></span>
<span id="cb40-104"><a href="#cb40-104"></a><span class="in">  write_rds(burglary_risk, "www/nottingham_burglary_risk.Rds", compress = "gz")</span></span>
<span id="cb40-105"><a href="#cb40-105"></a><span class="in">  </span></span>
<span id="cb40-106"><a href="#cb40-106"></a><span class="in">}</span></span>
<span id="cb40-107"><a href="#cb40-107"></a></span>
<span id="cb40-108"><a href="#cb40-108"></a><span class="in">burglary_risk_filtered &lt;- filter(burglary_risk, is.finite(kde))</span></span>
<span id="cb40-109"><a href="#cb40-109"></a></span>
<span id="cb40-110"><a href="#cb40-110"></a><span class="in">burglary_risk_bldg &lt;- burglary_risk |&gt; </span></span>
<span id="cb40-111"><a href="#cb40-111"></a><span class="in">  select(burglary_count = n, kde) |&gt; </span></span>
<span id="cb40-112"><a href="#cb40-112"></a><span class="in">  st_drop_geometry() |&gt; </span></span>
<span id="cb40-113"><a href="#cb40-113"></a><span class="in">  bind_cols(building_counts) |&gt; </span></span>
<span id="cb40-114"><a href="#cb40-114"></a><span class="in">  filter(is.finite(kde))</span></span>
<span id="cb40-115"><a href="#cb40-115"></a><span class="in">```</span></span>
<span id="cb40-116"><a href="#cb40-116"></a></span>
<span id="cb40-117"><a href="#cb40-117"></a></span>
<span id="cb40-118"><a href="#cb40-118"></a></span>
<span id="cb40-119"><a href="#cb40-119"></a><span class="fu">## What is a hotspot?</span></span>
<span id="cb40-120"><a href="#cb40-120"></a></span>
<span id="cb40-121"><a href="#cb40-121"></a>Crime is heavily concentrated in several different ways. A small number of </span>
<span id="cb40-122"><a href="#cb40-122"></a>offenders commit a large proportion of crime (even though most people commit </span>
<span id="cb40-123"><a href="#cb40-123"></a>minor offences occasionally) and a small number of people are repeatedly </span>
<span id="cb40-124"><a href="#cb40-124"></a>victimised. For most types of crime, a large proportion of crime occurs in a </span>
<span id="cb40-125"><a href="#cb40-125"></a>small number of places. **A hotspot is a specific location or small area where </span>
<span id="cb40-126"><a href="#cb40-126"></a>an unusual amount of criminal activity occurs**.</span>
<span id="cb40-127"><a href="#cb40-127"></a></span>
<span id="cb40-128"><a href="#cb40-128"></a>Crime hotspots can occur in several different forms. Watch this video to </span>
<span id="cb40-129"><a href="#cb40-129"></a>understand why hotspots are important in understanding and responding to crime.</span>
<span id="cb40-130"><a href="#cb40-130"></a></span>
<span id="cb40-131"><a href="#cb40-131"></a>{{&lt; video https://youtu.be/ug-ZhvvQjmw &gt;}}</span>
<span id="cb40-132"><a href="#cb40-132"></a></span>
<span id="cb40-133"><a href="#cb40-133"></a>Some places are *chronic* hotspots -- they have more crime than surrounding</span>
<span id="cb40-134"><a href="#cb40-134"></a>areas over a sustained period (which may appear to be permanent). Chronic</span>
<span id="cb40-135"><a href="#cb40-135"></a>hotspots are often generated by a facility that draws vulnerable people into an</span>
<span id="cb40-136"><a href="#cb40-136"></a>area, such as a tourist attraction that draws crowds of people who are</span>
<span id="cb40-137"><a href="#cb40-137"></a>vulnerable to pickpocketing. Other places are *acute* hotspots, in which crime</span>
<span id="cb40-138"><a href="#cb40-138"></a>increases in a place that previously experienced no or few crimes. This may be</span>
<span id="cb40-139"><a href="#cb40-139"></a>the result of some change in the environment or how it's managed, such as new</span>
<span id="cb40-140"><a href="#cb40-140"></a>management at a bar that ignores drug dealing that the previous owners would</span>
<span id="cb40-141"><a href="#cb40-141"></a>have not permitted.</span>
<span id="cb40-142"><a href="#cb40-142"></a></span>
<span id="cb40-143"><a href="#cb40-143"></a>When analysing hotspots, it is best to focus on *small* areas such as an</span>
<span id="cb40-144"><a href="#cb40-144"></a>apartment block, a shopping centre, a park or a single street. Focusing on </span>
<span id="cb40-145"><a href="#cb40-145"></a>smaller areas is important because resources to respond to crime are almost </span>
<span id="cb40-146"><a href="#cb40-146"></a>always limited, so it is important that those resources are directed where the</span>
<span id="cb40-147"><a href="#cb40-147"></a>problem is worst. </span>
<span id="cb40-148"><a href="#cb40-148"></a></span>
<span id="cb40-149"><a href="#cb40-149"></a>Analysing larger areas, such as a neighbourhood or a police sector, is much more </span>
<span id="cb40-150"><a href="#cb40-150"></a>difficult because larger areas are always made up of many smaller areas, each of </span>
<span id="cb40-151"><a href="#cb40-151"></a>which might be quite different from one another. This means that the factors </span>
<span id="cb40-152"><a href="#cb40-152"></a>causing one street to be a hotspot might be quite different from the factors </span>
<span id="cb40-153"><a href="#cb40-153"></a>that make another street in the same district into a hotspot. Conflating </span>
<span id="cb40-154"><a href="#cb40-154"></a>different problems with different causes makes it much harder to find effective </span>
<span id="cb40-155"><a href="#cb40-155"></a>ways to reduce crime in any one place. </span>
<span id="cb40-156"><a href="#cb40-156"></a></span>
<span id="cb40-157"><a href="#cb40-157"></a>These difficulties can be avoided (at least partly) by keeping hotspots small: </span>
<span id="cb40-158"><a href="#cb40-158"></a>in an urban area, a useful rule of thumb is that you should be able to stand in </span>
<span id="cb40-159"><a href="#cb40-159"></a>the middle of a hotspot and see the whole hotspot area.</span>
<span id="cb40-160"><a href="#cb40-160"></a></span>
<span id="cb40-161"><a href="#cb40-161"></a>Being able to identify hotspots using crime mapping is important because it </span>
<span id="cb40-162"><a href="#cb40-162"></a>forms a vital first step in many place-focused responses to crime. As an example</span>
<span id="cb40-163"><a href="#cb40-163"></a>of this, watch this video about how police in Philadelphia worked with </span>
<span id="cb40-164"><a href="#cb40-164"></a>researchers to use crime mapping to identify where to deploy foot patrols to</span>
<span id="cb40-165"><a href="#cb40-165"></a>reduce crime.</span>
<span id="cb40-166"><a href="#cb40-166"></a></span>
<span id="cb40-167"><a href="#cb40-167"></a>{{&lt; video https://youtu.be/0NUQsK0vnnM &gt;}}</span>
<span id="cb40-168"><a href="#cb40-168"></a></span>
<span id="cb40-169"><a href="#cb40-169"></a></span>
<span id="cb40-170"><a href="#cb40-170"></a>In this tutorial we will learn how to make maps that could be useful in </span>
<span id="cb40-171"><a href="#cb40-171"></a>identifying and responding to hotspots of crime. As an example, we will create</span>
<span id="cb40-172"><a href="#cb40-172"></a>this map showing hotspots of robbery in Nottingham, England.</span>
<span id="cb40-173"><a href="#cb40-173"></a></span>
<span id="cb40-174"><a href="#cb40-174"></a></span>
<span id="cb40-175"><a href="#cb40-175"></a><span class="in">```{r make-robbery-map, eval=FALSE, echo=FALSE}</span></span>
<span id="cb40-176"><a href="#cb40-176"></a><span class="in"># This dataset is not loaded above, so we load it here</span></span>
<span id="cb40-177"><a href="#cb40-177"></a><span class="in">nottingham &lt;- read_sf("https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg") |&gt; </span></span>
<span id="cb40-178"><a href="#cb40-178"></a><span class="in">  st_transform("EPSG:27700")</span></span>
<span id="cb40-179"><a href="#cb40-179"></a></span>
<span id="cb40-180"><a href="#cb40-180"></a><span class="in">robbery_gi &lt;- robbery |&gt; </span></span>
<span id="cb40-181"><a href="#cb40-181"></a><span class="in">  hotspot_gistar(cell_size = 100, bandwidth_adjust = 0.25) |&gt; </span></span>
<span id="cb40-182"><a href="#cb40-182"></a><span class="in">  filter(gistar &gt; 0, pvalue &lt; 0.05) |&gt; </span></span>
<span id="cb40-183"><a href="#cb40-183"></a><span class="in">  st_intersection(nottingham)</span></span>
<span id="cb40-184"><a href="#cb40-184"></a></span>
<span id="cb40-185"><a href="#cb40-185"></a><span class="in">nottingham_robbery_map &lt;- ggplot() + </span></span>
<span id="cb40-186"><a href="#cb40-186"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb40-187"><a href="#cb40-187"></a><span class="in">  geom_sf(</span></span>
<span id="cb40-188"><a href="#cb40-188"></a><span class="in">    aes(fill = kde), </span></span>
<span id="cb40-189"><a href="#cb40-189"></a><span class="in">    data = robbery_gi, </span></span>
<span id="cb40-190"><a href="#cb40-190"></a><span class="in">    alpha = 0.8,</span></span>
<span id="cb40-191"><a href="#cb40-191"></a><span class="in">    colour = NA</span></span>
<span id="cb40-192"><a href="#cb40-192"></a><span class="in">  ) +</span></span>
<span id="cb40-193"><a href="#cb40-193"></a><span class="in">  geom_sf(data = nottingham, colour = "grey70", fill = NA) +</span></span>
<span id="cb40-194"><a href="#cb40-194"></a><span class="in">  scale_fill_gradient(</span></span>
<span id="cb40-195"><a href="#cb40-195"></a><span class="in">    low = "lightblue",</span></span>
<span id="cb40-196"><a href="#cb40-196"></a><span class="in">    high = "darkblue",</span></span>
<span id="cb40-197"><a href="#cb40-197"></a><span class="in">    breaks = range(pull(robbery_gi, kde)),</span></span>
<span id="cb40-198"><a href="#cb40-198"></a><span class="in">    labels = c("lower", "higher")</span></span>
<span id="cb40-199"><a href="#cb40-199"></a><span class="in">  ) +</span></span>
<span id="cb40-200"><a href="#cb40-200"></a><span class="in">  fixed_plot_aspect() +</span></span>
<span id="cb40-201"><a href="#cb40-201"></a><span class="in">  labs(</span></span>
<span id="cb40-202"><a href="#cb40-202"></a><span class="in">      title = "Nottingham robbery hotspots",</span></span>
<span id="cb40-203"><a href="#cb40-203"></a><span class="in">      subtitle = str_glue(</span></span>
<span id="cb40-204"><a href="#cb40-204"></a><span class="in">        "density of robbery in places with more violence than expected by ",</span></span>
<span id="cb40-205"><a href="#cb40-205"></a><span class="in">        "chance"</span></span>
<span id="cb40-206"><a href="#cb40-206"></a><span class="in">      ),</span></span>
<span id="cb40-207"><a href="#cb40-207"></a><span class="in">      # Don't forget to add the licence statement -- it's a legal requirement!</span></span>
<span id="cb40-208"><a href="#cb40-208"></a><span class="in">      caption = str_wrap(</span></span>
<span id="cb40-209"><a href="#cb40-209"></a><span class="in">        str_glue(</span></span>
<span id="cb40-210"><a href="#cb40-210"></a><span class="in">          "Contains public sector information licensed under the Open ",</span></span>
<span id="cb40-211"><a href="#cb40-211"></a><span class="in">          "Government Licence v3.0. Map data from OpenStreetMap."</span></span>
<span id="cb40-212"><a href="#cb40-212"></a><span class="in">        ),</span></span>
<span id="cb40-213"><a href="#cb40-213"></a><span class="in">        width = 60</span></span>
<span id="cb40-214"><a href="#cb40-214"></a><span class="in">      ),</span></span>
<span id="cb40-215"><a href="#cb40-215"></a><span class="in">      fill = str_wrap("density of robbery at significant hotspots, 2022", 15)</span></span>
<span id="cb40-216"><a href="#cb40-216"></a><span class="in">  ) +</span></span>
<span id="cb40-217"><a href="#cb40-217"></a><span class="in">  theme_void() +</span></span>
<span id="cb40-218"><a href="#cb40-218"></a><span class="in">  theme(</span></span>
<span id="cb40-219"><a href="#cb40-219"></a><span class="in">    legend.text = element_text(size = rel(0.7)),</span></span>
<span id="cb40-220"><a href="#cb40-220"></a><span class="in">    legend.title = element_text(size = rel(0.8)),</span></span>
<span id="cb40-221"><a href="#cb40-221"></a><span class="in">    plot.caption = element_text(colour = "grey40", hjust = 0),</span></span>
<span id="cb40-222"><a href="#cb40-222"></a><span class="in">    plot.subtitle = element_text(margin = margin(t = 6, b = 6), size = rel(0.7)),</span></span>
<span id="cb40-223"><a href="#cb40-223"></a><span class="in">    plot.title = element_text(colour = "grey50", face = "bold", size = rel(1.2))</span></span>
<span id="cb40-224"><a href="#cb40-224"></a><span class="in">  )</span></span>
<span id="cb40-225"><a href="#cb40-225"></a></span>
<span id="cb40-226"><a href="#cb40-226"></a><span class="in">ggsave(</span></span>
<span id="cb40-227"><a href="#cb40-227"></a><span class="in">  here::here("inst/tutorials/11_mapping_hotspots/images/nottingham_robbery_map.jpg"), </span></span>
<span id="cb40-228"><a href="#cb40-228"></a><span class="in">  nottingham_robbery_map,</span></span>
<span id="cb40-229"><a href="#cb40-229"></a><span class="in">  width = 900 / 150,</span></span>
<span id="cb40-230"><a href="#cb40-230"></a><span class="in">  height = 800 / 150,</span></span>
<span id="cb40-231"><a href="#cb40-231"></a><span class="in">  dpi = 150</span></span>
<span id="cb40-232"><a href="#cb40-232"></a><span class="in">)</span></span>
<span id="cb40-233"><a href="#cb40-233"></a><span class="in">```</span></span>
<span id="cb40-234"><a href="#cb40-234"></a></span>
<span id="cb40-235"><a href="#cb40-235"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/nottingham_robbery_map.jpg" alt="A hotspot map of robberies in Nottingham" style="max-height: 700px;"&gt;&lt;/p&gt;</span>
<span id="cb40-236"><a href="#cb40-236"></a></span>
<span id="cb40-237"><a href="#cb40-237"></a></span>
<span id="cb40-238"><a href="#cb40-238"></a><span class="fu">### Check your understanding {.tutorial}</span></span>
<span id="cb40-239"><a href="#cb40-239"></a></span>
<span id="cb40-240"><a href="#cb40-240"></a><span class="in">```{r why-maps-quiz}</span></span>
<span id="cb40-241"><a href="#cb40-241"></a><span class="in">quiz(</span></span>
<span id="cb40-242"><a href="#cb40-242"></a><span class="in">  caption = "",</span></span>
<span id="cb40-243"><a href="#cb40-243"></a><span class="in">  question("Which *one* of these statements is true?",</span></span>
<span id="cb40-244"><a href="#cb40-244"></a><span class="in">    answer("Crime is very geographically concentrated – we can expect half of crime to be concentrated in about 5% of micro places", correct = TRUE),</span></span>
<span id="cb40-245"><a href="#cb40-245"></a><span class="in">    answer("Crime is usually not geographically concentrated at micro places"),</span></span>
<span id="cb40-246"><a href="#cb40-246"></a><span class="in">    answer("Crime is slightly geographically concentrated – we can expect half of crime to be concentrated in about one quarter of micro places"),</span></span>
<span id="cb40-247"><a href="#cb40-247"></a><span class="in">    answer("Crime is extremely geographically concentrated – we can expect half of crime to be concentrated in about 1% of micro places"),</span></span>
<span id="cb40-248"><a href="#cb40-248"></a><span class="in">    correct = "That's correct – based on previous studies, we can expect half of crime to be concentrated in about 5% of micro places",</span></span>
<span id="cb40-249"><a href="#cb40-249"></a><span class="in">    incorrect = "That's not correct – try re-watching the first video above and then try the question again.",</span></span>
<span id="cb40-250"><a href="#cb40-250"></a><span class="in">    allow_retry = TRUE,</span></span>
<span id="cb40-251"><a href="#cb40-251"></a><span class="in">    random_answer_order = TRUE</span></span>
<span id="cb40-252"><a href="#cb40-252"></a><span class="in">  )</span></span>
<span id="cb40-253"><a href="#cb40-253"></a><span class="in">)</span></span>
<span id="cb40-254"><a href="#cb40-254"></a><span class="in">```</span></span>
<span id="cb40-255"><a href="#cb40-255"></a></span>
<span id="cb40-256"><a href="#cb40-256"></a></span>
<span id="cb40-257"><a href="#cb40-257"></a></span>
<span id="cb40-258"><a href="#cb40-258"></a><span class="fu">## Showing the density of risk</span></span>
<span id="cb40-259"><a href="#cb40-259"></a></span>
<span id="cb40-260"><a href="#cb40-260"></a>In the tutorial on mapping area data we learned how to produce maps showing the</span>
<span id="cb40-261"><a href="#cb40-261"></a>*incidence rate* of crime by dividing the number of crimes by a measure of the</span>
<span id="cb40-262"><a href="#cb40-262"></a>population at risk of being targeted. We will often only have population </span>
<span id="cb40-263"><a href="#cb40-263"></a>estimates for areas, such as census estimates of the number of people living in</span>
<span id="cb40-264"><a href="#cb40-264"></a>an area. But for some crimes we have access to estimates of the people (or,</span>
<span id="cb40-265"><a href="#cb40-265"></a>more often, objects) at risk of being a target of a particular crime. In these</span>
<span id="cb40-266"><a href="#cb40-266"></a>cases, we can produce better maps of the risk of crime in different areas by</span>
<span id="cb40-267"><a href="#cb40-267"></a>producing a *dual KDE* map that shows the density of crime *risk* in different</span>
<span id="cb40-268"><a href="#cb40-268"></a>places.</span>
<span id="cb40-269"><a href="#cb40-269"></a></span>
<span id="cb40-270"><a href="#cb40-270"></a>To create a dual KDE map, we must estimate the density of crime and compare it </span>
<span id="cb40-271"><a href="#cb40-271"></a>to an estimate the density of the population at risk. Since the incidence rate </span>
<span id="cb40-272"><a href="#cb40-272"></a>is calculated as the number of crimes divided by the number of people or objects </span>
<span id="cb40-273"><a href="#cb40-273"></a>at risk, we can calculate the density of risk by dividing the density of crime </span>
<span id="cb40-274"><a href="#cb40-274"></a>estimated for each cell in the grid by the density of population estimated for </span>
<span id="cb40-275"><a href="#cb40-275"></a>the same cell. The <span class="in">`hotspot_dual_kde()`</span> function from the <span class="in">`sfhotspot`</span> package</span>
<span id="cb40-276"><a href="#cb40-276"></a>does this for us.</span>
<span id="cb40-277"><a href="#cb40-277"></a></span>
<span id="cb40-278"><a href="#cb40-278"></a>To illustrate making a dual KDE map, we will use reports of burglaries in three </span>
<span id="cb40-279"><a href="#cb40-279"></a>wards in Nottingham in 2020. Since the essential element of the crime of </span>
<span id="cb40-280"><a href="#cb40-280"></a>burglary in England is that an offender enters a _building_ as a trespasser in </span>
<span id="cb40-281"><a href="#cb40-281"></a>order to steal something, the best measure of the population at risk of burglary </span>
<span id="cb40-282"><a href="#cb40-282"></a>is the number of _buildings_ in each area (the definition of burglary is more </span>
<span id="cb40-283"><a href="#cb40-283"></a>complicated than this, but we don't need to worry about that here). </span>
<span id="cb40-284"><a href="#cb40-284"></a></span>
<span id="cb40-285"><a href="#cb40-285"></a>Burglary is a good example of why the routine activities approach to thinking </span>
<span id="cb40-286"><a href="#cb40-286"></a>about crime that we introduced in a previous tutorial emphasises thinking about </span>
<span id="cb40-287"><a href="#cb40-287"></a>_targets_ of crime rather than focusing only on crime _victims_. In the case of</span>
<span id="cb40-288"><a href="#cb40-288"></a>burglary, one person might be the owner of a large number of buildings (e.g. a </span>
<span id="cb40-289"><a href="#cb40-289"></a>farm with lots of out-buildings) or lots of people might own a single building </span>
<span id="cb40-290"><a href="#cb40-290"></a>(such as a house converted into flats). By thinking about the targets that are </span>
<span id="cb40-291"><a href="#cb40-291"></a>attacked by offenders, we can identify that burglary rates should be calculated </span>
<span id="cb40-292"><a href="#cb40-292"></a>based on buildings rather than, for example, residential population. Note that </span>
<span id="cb40-293"><a href="#cb40-293"></a>if our crime data only included _residential_ burglaries then we would want to</span>
<span id="cb40-294"><a href="#cb40-294"></a>use _residential_ buildings as our denominator, but in this case we have data</span>
<span id="cb40-295"><a href="#cb40-295"></a>for all burglaries, both residential and non-residential.</span>
<span id="cb40-296"><a href="#cb40-296"></a></span>
<span id="cb40-297"><a href="#cb40-297"></a></span>
<span id="cb40-298"><a href="#cb40-298"></a><span class="fu">### Data wrangling</span></span>
<span id="cb40-299"><a href="#cb40-299"></a></span>
<span id="cb40-300"><a href="#cb40-300"></a>Before we can create our dual KDE layer, we have to complete some data </span>
<span id="cb40-301"><a href="#cb40-301"></a>wrangling. We will extract the boundaries for the wards of interest from a </span>
<span id="cb40-302"><a href="#cb40-302"></a>dataset of boundaries for all wards in Nottingham using <span class="in">`filter()`</span> as we have </span>
<span id="cb40-303"><a href="#cb40-303"></a>done previously. To extract only the burglaries occurring in those three wards </span>
<span id="cb40-304"><a href="#cb40-304"></a>from a dataset of all burglaries in Nottingham, we will use <span class="in">`st_intersection()`</span>.</span>
<span id="cb40-305"><a href="#cb40-305"></a>We will also transform both datasets to use the British National Grid (EPSG code</span>
<span id="cb40-306"><a href="#cb40-306"></a>27700), since we will need to do that anyway before calculating the KDE values.</span>
<span id="cb40-307"><a href="#cb40-307"></a></span>
<span id="cb40-308"><a href="#cb40-308"></a><span class="in">```{r risk-exercise1, exercise=TRUE}</span></span>
<span id="cb40-309"><a href="#cb40-309"></a><span class="in">wards &lt;- read_sf("https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg") |&gt; </span></span>
<span id="cb40-310"><a href="#cb40-310"></a><span class="in">  st_transform("EPSG:27700") |&gt; </span></span>
<span id="cb40-311"><a href="#cb40-311"></a><span class="in">  filter(ward_name %in% c("Castle", "Lenton &amp; Wollaton East", "Meadows"))</span></span>
<span id="cb40-312"><a href="#cb40-312"></a></span>
<span id="cb40-313"><a href="#cb40-313"></a><span class="in">burglaries &lt;- read_csv("https://mpjashby.github.io/crimemappingdata/nottingham_burglary.csv.gz") |&gt; </span></span>
<span id="cb40-314"><a href="#cb40-314"></a><span class="in">  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) |&gt; </span></span>
<span id="cb40-315"><a href="#cb40-315"></a><span class="in">  st_transform("EPSG:27700") |&gt; </span></span>
<span id="cb40-316"><a href="#cb40-316"></a><span class="in">  st_intersection(wards)</span></span>
<span id="cb40-317"><a href="#cb40-317"></a><span class="in">```</span></span>
<span id="cb40-318"><a href="#cb40-318"></a></span>
<span id="cb40-319"><a href="#cb40-319"></a></span>
<span id="cb40-320"><a href="#cb40-320"></a>::: {.box .notewell}</span>
<span id="cb40-321"><a href="#cb40-321"></a></span>
<span id="cb40-322"><a href="#cb40-322"></a><span class="in">`st_intersection()`</span> can take longer to run than the maximum time limit for </span>
<span id="cb40-323"><a href="#cb40-323"></a>running code within this tutorial. If you see an error saying `Your code ran </span>
<span id="cb40-324"><a href="#cb40-324"></a>longer than the permitted time limit for this exercise<span class="in">` or `</span>reached elapsed time </span>
<span id="cb40-325"><a href="#cb40-325"></a>limit`, you can continue with the rest of the tutorial as usual.</span>
<span id="cb40-326"><a href="#cb40-326"></a></span>
<span id="cb40-327"><a href="#cb40-327"></a>:::</span>
<span id="cb40-328"><a href="#cb40-328"></a></span>
<span id="cb40-329"><a href="#cb40-329"></a></span>
<span id="cb40-330"><a href="#cb40-330"></a>We do not have a source of open data for all the buildings in Nottingham, so we</span>
<span id="cb40-331"><a href="#cb40-331"></a>will use the <span class="in">`osmdata`</span> package to get the locations of buildings from </span>
<span id="cb40-332"><a href="#cb40-332"></a>OpenStreetMap (OSM). You may remember from a previous tutorial that to do this </span>
<span id="cb40-333"><a href="#cb40-333"></a>we need to know which key (and possibly value) the OSM database uses for storing</span>
<span id="cb40-334"><a href="#cb40-334"></a>the locations of buildings. The OSM feature key for a building is 'building' </span>
<span id="cb40-335"><a href="#cb40-335"></a>and it is not necessary to specify a value (since we want to capture all types </span>
<span id="cb40-336"><a href="#cb40-336"></a>of building). The <span class="in">`osmdata`</span> package expects data to use the WGS84 co-ordinate </span>
<span id="cb40-337"><a href="#cb40-337"></a>reference system, so we must also make sure any data sources we use are </span>
<span id="cb40-338"><a href="#cb40-338"></a>projected using that system (EPSG code 4326).</span>
<span id="cb40-339"><a href="#cb40-339"></a></span>
<span id="cb40-340"><a href="#cb40-340"></a></span>
<span id="cb40-341"><a href="#cb40-341"></a></span>
<span id="cb40-342"><a href="#cb40-342"></a>::: {.tutorial}</span>
<span id="cb40-343"><a href="#cb40-343"></a></span>
<span id="cb40-344"><a href="#cb40-344"></a>Run the code needed to download data from OSM for all the buildings in the three </span>
<span id="cb40-345"><a href="#cb40-345"></a>wards we are interested in and store it in an object called </span>
<span id="cb40-346"><a href="#cb40-346"></a><span class="in">`nottingham_buildings`</span>. </span>
<span id="cb40-347"><a href="#cb40-347"></a></span>
<span id="cb40-348"><a href="#cb40-348"></a><span class="in">```{r risk-exercise2, exercise=TRUE, exercise.lines=10}</span></span>
<span id="cb40-349"><a href="#cb40-349"></a></span>
<span id="cb40-350"><a href="#cb40-350"></a><span class="in">```</span></span>
<span id="cb40-351"><a href="#cb40-351"></a></span>
<span id="cb40-352"><a href="#cb40-352"></a><span class="in">```{r risk-exercise2-hint-1, eval=FALSE, echo=FALSE}</span></span>
<span id="cb40-353"><a href="#cb40-353"></a><span class="in"># Remember to load the `osmdata` package</span></span>
<span id="cb40-354"><a href="#cb40-354"></a><span class="in">```</span></span>
<span id="cb40-355"><a href="#cb40-355"></a></span>
<span id="cb40-356"><a href="#cb40-356"></a><span class="in">```{r risk-exercise2-hint-2}</span></span>
<span id="cb40-357"><a href="#cb40-357"></a><span class="in"># To download OSM data, use:</span></span>
<span id="cb40-358"><a href="#cb40-358"></a><span class="in">#   * `st_transform()` to transform the data to use the WGS84 co-ordinate system</span></span>
<span id="cb40-359"><a href="#cb40-359"></a><span class="in">#   * `st_bbox()` to calculate the bounding box of the wards</span></span>
<span id="cb40-360"><a href="#cb40-360"></a><span class="in">#   * `opq()` to set up the OSM query </span></span>
<span id="cb40-361"><a href="#cb40-361"></a><span class="in">#   * `add_osm_feature()` to specify what type of features to download</span></span>
<span id="cb40-362"><a href="#cb40-362"></a><span class="in">#   * `osmdata_sf()` to download the data as an SF object</span></span>
<span id="cb40-363"><a href="#cb40-363"></a><span class="in">```</span></span>
<span id="cb40-364"><a href="#cb40-364"></a></span>
<span id="cb40-365"><a href="#cb40-365"></a><span class="in">```{r risk-exercise2-hint-3}</span></span>
<span id="cb40-366"><a href="#cb40-366"></a><span class="in">library(osmdata)</span></span>
<span id="cb40-367"><a href="#cb40-367"></a></span>
<span id="cb40-368"><a href="#cb40-368"></a><span class="in">nottingham_buildings &lt;- wards |&gt; </span></span>
<span id="cb40-369"><a href="#cb40-369"></a><span class="in">  st_transform("EPSG:4326") |&gt; </span></span>
<span id="cb40-370"><a href="#cb40-370"></a><span class="in">  st_bbox() |&gt; </span></span>
<span id="cb40-371"><a href="#cb40-371"></a><span class="in">  opq() |&gt; </span></span>
<span id="cb40-372"><a href="#cb40-372"></a><span class="in">  add_osm_feature(key = "?????") |&gt;  # &lt;- specify type of data here</span></span>
<span id="cb40-373"><a href="#cb40-373"></a><span class="in">  osmdata_sf()</span></span>
<span id="cb40-374"><a href="#cb40-374"></a></span>
<span id="cb40-375"><a href="#cb40-375"></a><span class="in">nottingham_buildings</span></span>
<span id="cb40-376"><a href="#cb40-376"></a><span class="in">```</span></span>
<span id="cb40-377"><a href="#cb40-377"></a></span>
<span id="cb40-378"><a href="#cb40-378"></a>:::</span>
<span id="cb40-379"><a href="#cb40-379"></a></span>
<span id="cb40-380"><a href="#cb40-380"></a></span>
<span id="cb40-381"><a href="#cb40-381"></a><span class="in">```{r risk-exercise2-hint-4}</span></span>
<span id="cb40-382"><a href="#cb40-382"></a><span class="in">library(osmdata)</span></span>
<span id="cb40-383"><a href="#cb40-383"></a></span>
<span id="cb40-384"><a href="#cb40-384"></a><span class="in">nottingham_buildings &lt;- wards |&gt; </span></span>
<span id="cb40-385"><a href="#cb40-385"></a><span class="in">  st_transform("EPSG:4326") |&gt; </span></span>
<span id="cb40-386"><a href="#cb40-386"></a><span class="in">  st_bbox() |&gt; </span></span>
<span id="cb40-387"><a href="#cb40-387"></a><span class="in">  opq() |&gt; </span></span>
<span id="cb40-388"><a href="#cb40-388"></a><span class="in">  add_osm_feature(key = "building") |&gt; </span></span>
<span id="cb40-389"><a href="#cb40-389"></a><span class="in">  osmdata_sf()</span></span>
<span id="cb40-390"><a href="#cb40-390"></a></span>
<span id="cb40-391"><a href="#cb40-391"></a><span class="in">nottingham_buildings</span></span>
<span id="cb40-392"><a href="#cb40-392"></a><span class="in">```</span></span>
<span id="cb40-393"><a href="#cb40-393"></a></span>
<span id="cb40-394"><a href="#cb40-394"></a>Looking at the <span class="in">`nottingham_buildings`</span> object, we can see that OSM contains data</span>
<span id="cb40-395"><a href="#cb40-395"></a>on buildings stored as points, polygons and multipolygons (we can ignore the</span>
<span id="cb40-396"><a href="#cb40-396"></a>few linestrings tagged as buildings, since it doesn't make sense for a building</span>
<span id="cb40-397"><a href="#cb40-397"></a>to be represented as a single line rather than a point or a polygon). </span>
<span id="cb40-398"><a href="#cb40-398"></a></span>
<span id="cb40-399"><a href="#cb40-399"></a></span>
<span id="cb40-400"><a href="#cb40-400"></a>&lt;div class="box extra-detail"&gt;</span>
<span id="cb40-401"><a href="#cb40-401"></a></span>
<span id="cb40-402"><a href="#cb40-402"></a>&lt;h5 id="risk-box1-title" class="box-title"&gt;What is a multipolygon?&lt;/h5&gt;</span>
<span id="cb40-403"><a href="#cb40-403"></a></span>
<span id="cb40-404"><a href="#cb40-404"></a>&lt;div id="risk-box1" class="box-content"&gt;</span>
<span id="cb40-405"><a href="#cb40-405"></a></span>
<span id="cb40-406"><a href="#cb40-406"></a>OpenStreetMap stores features in several different ways. The most basic types</span>
<span id="cb40-407"><a href="#cb40-407"></a>are points, lines and polygons. But there are also multipolygons (and</span>
<span id="cb40-408"><a href="#cb40-408"></a>multilines). These are features that represent complex structures such as </span>
<span id="cb40-409"><a href="#cb40-409"></a>clusters of buildings that are separate structures but are related to each </span>
<span id="cb40-410"><a href="#cb40-410"></a>other. For example, a hospital with several buildings might be represented in</span>
<span id="cb40-411"><a href="#cb40-411"></a>OpenStreetMap as a single multipolygon feature.</span>
<span id="cb40-412"><a href="#cb40-412"></a></span>
<span id="cb40-413"><a href="#cb40-413"></a>&lt;/div&gt;</span>
<span id="cb40-414"><a href="#cb40-414"></a></span>
<span id="cb40-415"><a href="#cb40-415"></a>&lt;/div&gt;</span>
<span id="cb40-416"><a href="#cb40-416"></a></span>
<span id="cb40-417"><a href="#cb40-417"></a>&lt;script&gt;</span>
<span id="cb40-418"><a href="#cb40-418"></a><span class="fu">$</span>(<span class="st">"#risk-box1-title"</span>)<span class="op">.</span><span class="fu">click</span>(<span class="kw">function</span> () { <span class="fu">$</span>(<span class="st">"#risk-box1"</span>)<span class="op">.</span><span class="fu">toggle</span>(<span class="st">"slow"</span>) })</span>
<span id="cb40-419"><a href="#cb40-419"></a>&lt;/script&gt;</span>
<span id="cb40-420"><a href="#cb40-420"></a></span>
<span id="cb40-421"><a href="#cb40-421"></a></span>
<span id="cb40-422"><a href="#cb40-422"></a>Let's plot these features on a base map to check that OSM has reasonable </span>
<span id="cb40-423"><a href="#cb40-423"></a>coverage of the buildings in these three wards.</span>
<span id="cb40-424"><a href="#cb40-424"></a></span>
<span id="cb40-425"><a href="#cb40-425"></a><span class="in">```{r risk-exercise3, exercise=TRUE, message=FALSE, exercise.lines=23, fig.asp=1, out.width="100%"}</span></span>
<span id="cb40-426"><a href="#cb40-426"></a><span class="in">ggplot() +</span></span>
<span id="cb40-427"><a href="#cb40-427"></a><span class="in">  annotation_map_tile(type = "cartodark", zoomin = 0, progress = "none") +</span></span>
<span id="cb40-428"><a href="#cb40-428"></a><span class="in">  # Add building features stored as points</span></span>
<span id="cb40-429"><a href="#cb40-429"></a><span class="in">  geom_sf(</span></span>
<span id="cb40-430"><a href="#cb40-430"></a><span class="in">    data = pluck(nottingham_buildings, "osm_points"), </span></span>
<span id="cb40-431"><a href="#cb40-431"></a><span class="in">    colour = "green",</span></span>
<span id="cb40-432"><a href="#cb40-432"></a><span class="in">    size = 0.1</span></span>
<span id="cb40-433"><a href="#cb40-433"></a><span class="in">  ) +</span></span>
<span id="cb40-434"><a href="#cb40-434"></a><span class="in">  # Add building features stored as polygons</span></span>
<span id="cb40-435"><a href="#cb40-435"></a><span class="in">  geom_sf(</span></span>
<span id="cb40-436"><a href="#cb40-436"></a><span class="in">    data = pluck(nottingham_buildings, "osm_polygons"), </span></span>
<span id="cb40-437"><a href="#cb40-437"></a><span class="in">    colour = NA,</span></span>
<span id="cb40-438"><a href="#cb40-438"></a><span class="in">    fill = "blue"</span></span>
<span id="cb40-439"><a href="#cb40-439"></a><span class="in">  ) + </span></span>
<span id="cb40-440"><a href="#cb40-440"></a><span class="in">  # Add building features stored as multi-polygons</span></span>
<span id="cb40-441"><a href="#cb40-441"></a><span class="in">  geom_sf(</span></span>
<span id="cb40-442"><a href="#cb40-442"></a><span class="in">    data = pluck(nottingham_buildings, "osm_multipolygons"), </span></span>
<span id="cb40-443"><a href="#cb40-443"></a><span class="in">    colour = NA,</span></span>
<span id="cb40-444"><a href="#cb40-444"></a><span class="in">    fill = "darkred"</span></span>
<span id="cb40-445"><a href="#cb40-445"></a><span class="in">  ) +</span></span>
<span id="cb40-446"><a href="#cb40-446"></a><span class="in">  geom_sf(data = wards, colour = "red", fill = NA, linewidth = 1.25) +</span></span>
<span id="cb40-447"><a href="#cb40-447"></a><span class="in">  theme_void()</span></span>
<span id="cb40-448"><a href="#cb40-448"></a><span class="in">```</span></span>
<span id="cb40-449"><a href="#cb40-449"></a></span>
<span id="cb40-450"><a href="#cb40-450"></a></span>
<span id="cb40-451"><a href="#cb40-451"></a>::: {.box .notewell}</span>
<span id="cb40-452"><a href="#cb40-452"></a></span>
<span id="cb40-453"><a href="#cb40-453"></a>Remember that <span class="in">`osmdata_sf()`</span> gets OSM data for the area covered by the _bounding </span>
<span id="cb40-454"><a href="#cb40-454"></a>box_ of the input feature, not the feature boundaries. This means some of the</span>
<span id="cb40-455"><a href="#cb40-455"></a>buildings returned by the code above will be outside the wards we are interested</span>
<span id="cb40-456"><a href="#cb40-456"></a>in. We will deal with this in a minute.</span>
<span id="cb40-457"><a href="#cb40-457"></a></span>
<span id="cb40-458"><a href="#cb40-458"></a>:::</span>
<span id="cb40-459"><a href="#cb40-459"></a></span>
<span id="cb40-460"><a href="#cb40-460"></a></span>
<span id="cb40-461"><a href="#cb40-461"></a>It looks like almost all the streets in the three wards we are interested in are</span>
<span id="cb40-462"><a href="#cb40-462"></a>lined with buildings in the OSM data, which is what we would expect of streets</span>
<span id="cb40-463"><a href="#cb40-463"></a>in an urban area. There are some streets without buildings in the top-left of </span>
<span id="cb40-464"><a href="#cb40-464"></a>the map, but these streets are outside our three wards so this does not matter.</span>
<span id="cb40-465"><a href="#cb40-465"></a></span>
<span id="cb40-466"><a href="#cb40-466"></a>We can also see from this map that the </span>
<span id="cb40-467"><a href="#cb40-467"></a><span class="in">`r scales::comma(nrow(pluck(nottingham_buildings, "osm_points")))`</span> point </span>
<span id="cb40-468"><a href="#cb40-468"></a>features in the OSM data (shown as green dots on the map) typically represent </span>
<span id="cb40-469"><a href="#cb40-469"></a>the corners of buildings that are also represented as polygons, so we know we </span>
<span id="cb40-470"><a href="#cb40-470"></a>can ignore the points layer within the OSM data.</span>
<span id="cb40-471"><a href="#cb40-471"></a></span>
<span id="cb40-472"><a href="#cb40-472"></a>Since the <span class="in">`hotspot_dual_kde()`</span> function works on points, we need to convert the </span>
<span id="cb40-473"><a href="#cb40-473"></a>polygon and multipolygon layers to points by calculating their centroids, then </span>
<span id="cb40-474"><a href="#cb40-474"></a>merge the two layers together. This will generate a warning that </span>
<span id="cb40-475"><a href="#cb40-475"></a><span class="in">`st_centroid does not give correct centroids for longitude/latitude data`</span> but we</span>
<span id="cb40-476"><a href="#cb40-476"></a>can ignore this because the calculated centroids will be good enough for our</span>
<span id="cb40-477"><a href="#cb40-477"></a>purposes (if we wanted to, we could transform the data to use the British </span>
<span id="cb40-478"><a href="#cb40-478"></a>National Grid, calculate the centroids and then transform it back).</span>
<span id="cb40-479"><a href="#cb40-479"></a></span>
<span id="cb40-480"><a href="#cb40-480"></a>Since we are only interested in those buildings in three particular wards, we</span>
<span id="cb40-481"><a href="#cb40-481"></a>can also at this stage remove any buildings that are outside those wards using</span>
<span id="cb40-482"><a href="#cb40-482"></a><span class="in">`st_intersection()`</span>, as we have already done for the <span class="in">`burglaries`</span> object. Since</span>
<span id="cb40-483"><a href="#cb40-483"></a>the <span class="in">`wards`</span> object uses the British National Grid and <span class="in">`st_intersection()`</span></span>
<span id="cb40-484"><a href="#cb40-484"></a>requires both datasets to use the same co-ordinate system, we will transform</span>
<span id="cb40-485"><a href="#cb40-485"></a>the building centroids before clipping them.</span>
<span id="cb40-486"><a href="#cb40-486"></a></span>
<span id="cb40-487"><a href="#cb40-487"></a><span class="in">```{r risk-exercise4, exercise=TRUE, eval=FALSE, echo=FALSE}</span></span>
<span id="cb40-488"><a href="#cb40-488"></a><span class="in">nottingham_building_centroids &lt;- bind_rows(</span></span>
<span id="cb40-489"><a href="#cb40-489"></a><span class="in">  st_centroid(pluck(nottingham_buildings, "osm_polygons")),</span></span>
<span id="cb40-490"><a href="#cb40-490"></a><span class="in">  st_centroid(pluck(nottingham_buildings, "osm_multipolygons"))</span></span>
<span id="cb40-491"><a href="#cb40-491"></a><span class="in">) |&gt; </span></span>
<span id="cb40-492"><a href="#cb40-492"></a><span class="in">  st_transform("EPSG:27700") |&gt; </span></span>
<span id="cb40-493"><a href="#cb40-493"></a><span class="in">  st_intersection(wards)</span></span>
<span id="cb40-494"><a href="#cb40-494"></a><span class="in">```</span></span>
<span id="cb40-495"><a href="#cb40-495"></a></span>
<span id="cb40-496"><a href="#cb40-496"></a></span>
<span id="cb40-497"><a href="#cb40-497"></a>&lt;div class="box extra-detail"&gt;</span>
<span id="cb40-498"><a href="#cb40-498"></a></span>
<span id="cb40-499"><a href="#cb40-499"></a>&lt;h5 id="risk-box2-title" class="box-title"&gt;What does the warning <span class="in">`st_centroid assumes …`</span> mean?&lt;/h5&gt;</span>
<span id="cb40-500"><a href="#cb40-500"></a></span>
<span id="cb40-501"><a href="#cb40-501"></a>&lt;div id="risk-box2" class="box-content"&gt;</span>
<span id="cb40-502"><a href="#cb40-502"></a></span>
<span id="cb40-503"><a href="#cb40-503"></a>You might have seen a warning saying </span>
<span id="cb40-504"><a href="#cb40-504"></a><span class="in">`st_centroid assumes attributes are constant over geometries of x`</span>. You will see</span>
<span id="cb40-505"><a href="#cb40-505"></a>this warning when you use the <span class="in">`st_centroid()`</span> function. It is there to remind</span>
<span id="cb40-506"><a href="#cb40-506"></a>you that columns in the original data (which the SF package refers to as the</span>
<span id="cb40-507"><a href="#cb40-507"></a>_attributes_ associated with each spatial feature) refer to the polygon as a </span>
<span id="cb40-508"><a href="#cb40-508"></a>whole, but in the object produced by <span class="in">`st_centroid()`</span> it will appear that the</span>
<span id="cb40-509"><a href="#cb40-509"></a>columns relate to the centroid point. In many cases this will not be a problem,</span>
<span id="cb40-510"><a href="#cb40-510"></a>but it could expose you to the ecological fallacy so it is sometimes useful to </span>
<span id="cb40-511"><a href="#cb40-511"></a>be reminded.</span>
<span id="cb40-512"><a href="#cb40-512"></a></span>
<span id="cb40-513"><a href="#cb40-513"></a>&lt;/div&gt;</span>
<span id="cb40-514"><a href="#cb40-514"></a></span>
<span id="cb40-515"><a href="#cb40-515"></a>&lt;/div&gt;</span>
<span id="cb40-516"><a href="#cb40-516"></a></span>
<span id="cb40-517"><a href="#cb40-517"></a>&lt;script&gt;</span>
<span id="cb40-518"><a href="#cb40-518"></a><span class="fu">$</span>(<span class="st">"#risk-box2-title"</span>)<span class="op">.</span><span class="fu">click</span>(<span class="kw">function</span> () { <span class="fu">$</span>(<span class="st">"#risk-box2"</span>)<span class="op">.</span><span class="fu">toggle</span>(<span class="st">"slow"</span>) })</span>
<span id="cb40-519"><a href="#cb40-519"></a>&lt;/script&gt;</span>
<span id="cb40-520"><a href="#cb40-520"></a></span>
<span id="cb40-521"><a href="#cb40-521"></a></span>
<span id="cb40-522"><a href="#cb40-522"></a>&lt;div class="box extra-detail"&gt;</span>
<span id="cb40-523"><a href="#cb40-523"></a></span>
<span id="cb40-524"><a href="#cb40-524"></a>&lt;h5 id="risk-box3-title" class="box-title"&gt;What does the warning <span class="in">`attribute variables are assumed …`</span> mean?&lt;/h5&gt;</span>
<span id="cb40-525"><a href="#cb40-525"></a></span>
<span id="cb40-526"><a href="#cb40-526"></a>&lt;div id="risk-box3" class="box-content"&gt;</span>
<span id="cb40-527"><a href="#cb40-527"></a></span>
<span id="cb40-528"><a href="#cb40-528"></a><span class="in">`st_intersection()`</span> produces a warning message whenever it is used:</span>
<span id="cb40-529"><a href="#cb40-529"></a></span>
<span id="cb40-530"><a href="#cb40-530"></a><span class="in">```</span></span>
<span id="cb40-531"><a href="#cb40-531"></a><span class="in">Warning: attribute variables are assumed to be spatially constant throughout all</span></span>
<span id="cb40-532"><a href="#cb40-532"></a><span class="in">geometries</span></span>
<span id="cb40-533"><a href="#cb40-533"></a><span class="in">```</span></span>
<span id="cb40-534"><a href="#cb40-534"></a></span>
<span id="cb40-535"><a href="#cb40-535"></a>As long as you are simply using <span class="in">`st_intersection()`</span> to remove parts of the data</span>
<span id="cb40-536"><a href="#cb40-536"></a>outside a boundary, you can ignore this message.</span>
<span id="cb40-537"><a href="#cb40-537"></a></span>
<span id="cb40-538"><a href="#cb40-538"></a>&lt;/div&gt;</span>
<span id="cb40-539"><a href="#cb40-539"></a></span>
<span id="cb40-540"><a href="#cb40-540"></a>&lt;/div&gt;</span>
<span id="cb40-541"><a href="#cb40-541"></a></span>
<span id="cb40-542"><a href="#cb40-542"></a>&lt;script&gt;</span>
<span id="cb40-543"><a href="#cb40-543"></a><span class="fu">$</span>(<span class="st">"#risk-box3-title"</span>)<span class="op">.</span><span class="fu">click</span>(<span class="kw">function</span> () { <span class="fu">$</span>(<span class="st">"#risk-box3"</span>)<span class="op">.</span><span class="fu">toggle</span>(<span class="st">"slow"</span>) })</span>
<span id="cb40-544"><a href="#cb40-544"></a>&lt;/script&gt;</span>
<span id="cb40-545"><a href="#cb40-545"></a></span>
<span id="cb40-546"><a href="#cb40-546"></a></span>
<span id="cb40-547"><a href="#cb40-547"></a><span class="fu">### Calculating dual kernel density</span></span>
<span id="cb40-548"><a href="#cb40-548"></a></span>
<span id="cb40-549"><a href="#cb40-549"></a>We now have the object <span class="in">`burglaries`</span> that contains the locations of each burglary</span>
<span id="cb40-550"><a href="#cb40-550"></a>in the three Nottingham wards that we are interested in, and the object</span>
<span id="cb40-551"><a href="#cb40-551"></a><span class="in">`nottingham_building_centroids`</span> that contains the centroids of each building in</span>
<span id="cb40-552"><a href="#cb40-552"></a>those three wards. We can use these layers to estimate the density of burglaries</span>
<span id="cb40-553"><a href="#cb40-553"></a>and buildings, then combine these to estimate the density of burglary risk.</span>
<span id="cb40-554"><a href="#cb40-554"></a></span>
<span id="cb40-555"><a href="#cb40-555"></a><span class="in">`hotspot_dual_kde()`</span> works in the same way as <span class="in">`hotspot_kde()`</span>, except that it</span>
<span id="cb40-556"><a href="#cb40-556"></a>requires two datasets. In this case, that means one dataset of crime locations </span>
<span id="cb40-557"><a href="#cb40-557"></a>and one dataset of building locations. <span class="in">`hotspot_dual_kde()`</span> will set the cell </span>
<span id="cb40-558"><a href="#cb40-558"></a>size and bandwidth automatically, but we can set them manually using the </span>
<span id="cb40-559"><a href="#cb40-559"></a><span class="in">`cell_size`</span>, <span class="in">`bandwidth_adjust`</span> and <span class="in">`grid`</span> arguments in the same way we have </span>
<span id="cb40-560"><a href="#cb40-560"></a>done for <span class="in">`hotspot_kde()`</span>. In this case, we will use the <span class="in">`hotspot_grid()`</span> helper </span>
<span id="cb40-561"><a href="#cb40-561"></a>function to create a grid based on the boundaries of the wards we are interested </span>
<span id="cb40-562"><a href="#cb40-562"></a>in. All the spatial objects we are going to use here have co-ordinates specified </span>
<span id="cb40-563"><a href="#cb40-563"></a>using the British National Grid because we have already transformed them, so we </span>
<span id="cb40-564"><a href="#cb40-564"></a>do not need to do any transformation here.</span>
<span id="cb40-565"><a href="#cb40-565"></a></span>
<span id="cb40-566"><a href="#cb40-566"></a><span class="in">```{r risk-exercise5, exercise=TRUE}</span></span>
<span id="cb40-567"><a href="#cb40-567"></a><span class="in">burglary_risk &lt;- hotspot_dual_kde(</span></span>
<span id="cb40-568"><a href="#cb40-568"></a><span class="in">  burglaries, </span></span>
<span id="cb40-569"><a href="#cb40-569"></a><span class="in">  nottingham_building_centroids, </span></span>
<span id="cb40-570"><a href="#cb40-570"></a><span class="in">  bandwidth_adjust = 0.25, </span></span>
<span id="cb40-571"><a href="#cb40-571"></a><span class="in">  grid = hotspot_grid(wards, cell_size = 100),</span></span>
<span id="cb40-572"><a href="#cb40-572"></a><span class="in">  quiet = TRUE</span></span>
<span id="cb40-573"><a href="#cb40-573"></a><span class="in">) |&gt; </span></span>
<span id="cb40-574"><a href="#cb40-574"></a><span class="in">  st_intersection(wards)</span></span>
<span id="cb40-575"><a href="#cb40-575"></a></span>
<span id="cb40-576"><a href="#cb40-576"></a><span class="in">head(burglary_risk)</span></span>
<span id="cb40-577"><a href="#cb40-577"></a><span class="in">```</span></span>
<span id="cb40-578"><a href="#cb40-578"></a></span>
<span id="cb40-579"><a href="#cb40-579"></a>You might recall from earlier in this tutorial that the value of the <span class="in">`kde`</span></span>
<span id="cb40-580"><a href="#cb40-580"></a>column in the object produced by <span class="in">`hotspot_dual_kde()`</span> is calculated by dividing</span>
<span id="cb40-581"><a href="#cb40-581"></a>the density of burglary in each grid cell by the density of buildings in the</span>
<span id="cb40-582"><a href="#cb40-582"></a>same grid cell. There are two cases where this will produce a result that is not</span>
<span id="cb40-583"><a href="#cb40-583"></a>a finite number:</span>
<span id="cb40-584"><a href="#cb40-584"></a></span>
<span id="cb40-585"><a href="#cb40-585"></a><span class="ss">  * </span>If, for a particular cell, the density of burglaries and density of </span>
<span id="cb40-586"><a href="#cb40-586"></a>    buildings are both zero, dividing one by the other will produce the result </span>
<span id="cb40-587"><a href="#cb40-587"></a>    <span class="in">`NaN`</span>, for 'not a number'.</span>
<span id="cb40-588"><a href="#cb40-588"></a><span class="ss">  * </span>If the density of burglaries is greater than zero but the density of </span>
<span id="cb40-589"><a href="#cb40-589"></a>    buildings is exactly zero, the result will be <span class="in">`Inf`</span>, for 'infinite'.</span>
<span id="cb40-590"><a href="#cb40-590"></a></span>
<span id="cb40-591"><a href="#cb40-591"></a>Since it is not possible to calculate burglary risk in either of those cases, we</span>
<span id="cb40-592"><a href="#cb40-592"></a>can exclude these cases from the <span class="in">`burglary_risk`</span> object by using <span class="in">`filter()`</span></span>
<span id="cb40-593"><a href="#cb40-593"></a>together with the <span class="in">`is.finite()`</span> function (R does not count <span class="in">`NaN`</span> as a finite </span>
<span id="cb40-594"><a href="#cb40-594"></a>number):</span>
<span id="cb40-595"><a href="#cb40-595"></a></span>
<span id="cb40-596"><a href="#cb40-596"></a><span class="in">```r</span></span>
<span id="cb40-597"><a href="#cb40-597"></a>burglary_risk <span class="ot">&lt;-</span> <span class="fu">hotspot_dual_kde</span>(</span>
<span id="cb40-598"><a href="#cb40-598"></a>  burglaries, </span>
<span id="cb40-599"><a href="#cb40-599"></a>  nottingham_building_centroids, </span>
<span id="cb40-600"><a href="#cb40-600"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, </span>
<span id="cb40-601"><a href="#cb40-601"></a>  <span class="at">grid =</span> <span class="fu">hotspot_grid</span>(wards, <span class="at">cell_size =</span> <span class="dv">100</span>)</span>
<span id="cb40-602"><a href="#cb40-602"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb40-603"><a href="#cb40-603"></a>  <span class="fu">st_intersection</span>(wards)</span>
<span id="cb40-604"><a href="#cb40-604"></a></span>
<span id="cb40-605"><a href="#cb40-605"></a>burglary_risk_filtered <span class="ot">&lt;-</span> <span class="fu">filter</span>(burglary_risk, <span class="fu">is.finite</span>(kde))</span>
<span id="cb40-606"><a href="#cb40-606"></a><span class="in">```</span></span>
<span id="cb40-607"><a href="#cb40-607"></a></span>
<span id="cb40-608"><a href="#cb40-608"></a>You might wonder why we didn't simply add <span class="in">`filter()`</span> to the existing pipeline</span>
<span id="cb40-609"><a href="#cb40-609"></a>that creates the <span class="in">`burglary_risk`</span> object. It is because we will need the </span>
<span id="cb40-610"><a href="#cb40-610"></a>unfiltered object in the next section. But for now …</span>
<span id="cb40-611"><a href="#cb40-611"></a></span>
<span id="cb40-612"><a href="#cb40-612"></a>We can plot the estimate of the density of burglary risk. By controlling</span>
<span id="cb40-613"><a href="#cb40-613"></a>for the density of buildings, this map shows us where building owners *on </span>
<span id="cb40-614"><a href="#cb40-614"></a>average* face the highest risk of being burgled. This might be useful in working</span>
<span id="cb40-615"><a href="#cb40-615"></a>out, for example, which building owners should be offered visits from a </span>
<span id="cb40-616"><a href="#cb40-616"></a>crime-prevention advisor or funding to install crime-prevention measures.</span>
<span id="cb40-617"><a href="#cb40-617"></a></span>
<span id="cb40-618"><a href="#cb40-618"></a><span class="in">```{r risk-exercise6, exercise=TRUE, message=FALSE, exercise.lines=36, fig.align='center', fig.asp=1}</span></span>
<span id="cb40-619"><a href="#cb40-619"></a><span class="in">ggplot() +</span></span>
<span id="cb40-620"><a href="#cb40-620"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb40-621"><a href="#cb40-621"></a><span class="in">  # Add burglary risk layer</span></span>
<span id="cb40-622"><a href="#cb40-622"></a><span class="in">  geom_sf(</span></span>
<span id="cb40-623"><a href="#cb40-623"></a><span class="in">    aes(fill = kde), </span></span>
<span id="cb40-624"><a href="#cb40-624"></a><span class="in">    data = burglary_risk_filtered, </span></span>
<span id="cb40-625"><a href="#cb40-625"></a><span class="in">    alpha = 0.8, </span></span>
<span id="cb40-626"><a href="#cb40-626"></a><span class="in">    colour = NA</span></span>
<span id="cb40-627"><a href="#cb40-627"></a><span class="in">  ) +</span></span>
<span id="cb40-628"><a href="#cb40-628"></a><span class="in">  # Add ward boundaries</span></span>
<span id="cb40-629"><a href="#cb40-629"></a><span class="in">  geom_sf(data = wards, fill = NA) + </span></span>
<span id="cb40-630"><a href="#cb40-630"></a><span class="in">  scale_fill_distiller(</span></span>
<span id="cb40-631"><a href="#cb40-631"></a><span class="in">    breaks = range(pull(burglary_risk_filtered, "kde")),</span></span>
<span id="cb40-632"><a href="#cb40-632"></a><span class="in">    labels = c("lower", "higher"),</span></span>
<span id="cb40-633"><a href="#cb40-633"></a><span class="in">    direction = 1</span></span>
<span id="cb40-634"><a href="#cb40-634"></a><span class="in">  ) +</span></span>
<span id="cb40-635"><a href="#cb40-635"></a><span class="in">  labs(</span></span>
<span id="cb40-636"><a href="#cb40-636"></a><span class="in">      title = "Burglary risk in south-west Nottingham",</span></span>
<span id="cb40-637"><a href="#cb40-637"></a><span class="in">      subtitle = str_glue(</span></span>
<span id="cb40-638"><a href="#cb40-638"></a><span class="in">        "dual kernel density of burglary risk in Castle, Lenton &amp; Wollaton ",</span></span>
<span id="cb40-639"><a href="#cb40-639"></a><span class="in">        "East and Meadows wards"</span></span>
<span id="cb40-640"><a href="#cb40-640"></a><span class="in">      ),</span></span>
<span id="cb40-641"><a href="#cb40-641"></a><span class="in">      caption = str_glue(</span></span>
<span id="cb40-642"><a href="#cb40-642"></a><span class="in">        "Contains public sector information licensed under the Open ",</span></span>
<span id="cb40-643"><a href="#cb40-643"></a><span class="in">        "Government Licence v3.0"</span></span>
<span id="cb40-644"><a href="#cb40-644"></a><span class="in">      ),</span></span>
<span id="cb40-645"><a href="#cb40-645"></a><span class="in">      fill = "density of burglary risk, 2020"</span></span>
<span id="cb40-646"><a href="#cb40-646"></a><span class="in">  ) +</span></span>
<span id="cb40-647"><a href="#cb40-647"></a><span class="in">  theme_void() +</span></span>
<span id="cb40-648"><a href="#cb40-648"></a><span class="in">  theme(</span></span>
<span id="cb40-649"><a href="#cb40-649"></a><span class="in">    legend.position = "bottom",</span></span>
<span id="cb40-650"><a href="#cb40-650"></a><span class="in">    plot.caption = element_text(colour = "grey40"),</span></span>
<span id="cb40-651"><a href="#cb40-651"></a><span class="in">    plot.subtitle = element_text(margin = margin(t = 6, b = 6)),</span></span>
<span id="cb40-652"><a href="#cb40-652"></a><span class="in">    plot.title = element_text(colour = "grey50", face = "bold", size = 16)</span></span>
<span id="cb40-653"><a href="#cb40-653"></a><span class="in">  )</span></span>
<span id="cb40-654"><a href="#cb40-654"></a><span class="in">```</span></span>
<span id="cb40-655"><a href="#cb40-655"></a></span>
<span id="cb40-656"><a href="#cb40-656"></a></span>
<span id="cb40-657"><a href="#cb40-657"></a><span class="fu">### Check your understanding {.tutorial}</span></span>
<span id="cb40-658"><a href="#cb40-658"></a></span>
<span id="cb40-659"><a href="#cb40-659"></a><span class="in">```{r dual-kde-quiz}</span></span>
<span id="cb40-660"><a href="#cb40-660"></a><span class="in">quiz(</span></span>
<span id="cb40-661"><a href="#cb40-661"></a><span class="in">  caption = "",</span></span>
<span id="cb40-662"><a href="#cb40-662"></a></span>
<span id="cb40-663"><a href="#cb40-663"></a><span class="in">  question("Which *one* of these statements is true?",</span></span>
<span id="cb40-664"><a href="#cb40-664"></a><span class="in">    answer("`hotspot_dual_kde()` requires co-ordinates to use a projected co-ordinate system (i.e. not longitude and latitude).", correct = TRUE),</span></span>
<span id="cb40-665"><a href="#cb40-665"></a><span class="in">    answer("`hotspot_dual_kde()` can work on any co-ordinates, whether they use a geographic co-ordinate system (i.e. longitude and latitude) or a projected system."),</span></span>
<span id="cb40-666"><a href="#cb40-666"></a><span class="in">    answer("`hotspot_dual_kde()` requires co-ordinates to use a geographic co-ordinate system (i.e. longitude and latitude)."),</span></span>
<span id="cb40-667"><a href="#cb40-667"></a><span class="in">    answer("`hotspot_dual_kde()` does not work with co-ordinates, so it does not matter which type of co-ordinate system a dataset uses."),</span></span>
<span id="cb40-668"><a href="#cb40-668"></a><span class="in">    allow_retry = TRUE,</span></span>
<span id="cb40-669"><a href="#cb40-669"></a><span class="in">    random_answer_order = TRUE</span></span>
<span id="cb40-670"><a href="#cb40-670"></a><span class="in">  ),</span></span>
<span id="cb40-671"><a href="#cb40-671"></a><span class="in">  </span></span>
<span id="cb40-672"><a href="#cb40-672"></a><span class="in">  question(</span></span>
<span id="cb40-673"><a href="#cb40-673"></a><span class="in">    "Why do we usually clip the result of `hotspot_dual_kde()` using `st_intersection()`?",</span></span>
<span id="cb40-674"><a href="#cb40-674"></a><span class="in">    answer("To eliminate any areas that we do not have data for, since displaying KDE values for such areas on a map might be misleading.", correct = TRUE),</span></span>
<span id="cb40-675"><a href="#cb40-675"></a><span class="in">    answer("To make our maps look nicer."),</span></span>
<span id="cb40-676"><a href="#cb40-676"></a><span class="in">    answer("To transform the co-ordinate system our data uses from the system `hotspot_dual_kde()` uses to the one we need to produce a map."),</span></span>
<span id="cb40-677"><a href="#cb40-677"></a><span class="in">    answer("To make it easier to see the other layers on our map."),</span></span>
<span id="cb40-678"><a href="#cb40-678"></a><span class="in">    allow_retry = TRUE,</span></span>
<span id="cb40-679"><a href="#cb40-679"></a><span class="in">    random_answer_order = TRUE</span></span>
<span id="cb40-680"><a href="#cb40-680"></a><span class="in">  )</span></span>
<span id="cb40-681"><a href="#cb40-681"></a><span class="in">)</span></span>
<span id="cb40-682"><a href="#cb40-682"></a><span class="in">```</span></span>
<span id="cb40-683"><a href="#cb40-683"></a></span>
<span id="cb40-684"><a href="#cb40-684"></a></span>
<span id="cb40-685"><a href="#cb40-685"></a></span>
<span id="cb40-686"><a href="#cb40-686"></a><span class="fu">## Finding hotspots</span></span>
<span id="cb40-687"><a href="#cb40-687"></a></span>
<span id="cb40-688"><a href="#cb40-688"></a>We now know how to produce a better map of the density of crime in different</span>
<span id="cb40-689"><a href="#cb40-689"></a>areas. But how do we know which areas count as hotspots and which don't? </span>
<span id="cb40-690"><a href="#cb40-690"></a></span>
<span id="cb40-691"><a href="#cb40-691"></a>There are several ways to answer this question. If we were planning a particular</span>
<span id="cb40-692"><a href="#cb40-692"></a>activity to respond to a crime problem, we might know what resources we had</span>
<span id="cb40-693"><a href="#cb40-693"></a>available to respond. For example, we might know that we have enough funding to</span>
<span id="cb40-694"><a href="#cb40-694"></a>provide crime-prevention visits to 100 locations. In that case, we can order the</span>
<span id="cb40-695"><a href="#cb40-695"></a>cells in a KDE object according to which have the highest estimates of risk, </span>
<span id="cb40-696"><a href="#cb40-696"></a>then count all the premises in each cell until we have reached our limit.</span>
<span id="cb40-697"><a href="#cb40-697"></a></span>
<span id="cb40-698"><a href="#cb40-698"></a>To do this, we need to know how many buildings are in each grid cell. We have</span>
<span id="cb40-699"><a href="#cb40-699"></a>already learned how to count crimes in areas when we learned about mapping area</span>
<span id="cb40-700"><a href="#cb40-700"></a>data. When we want to count crimes in each cell in a grid, we can use the </span>
<span id="cb40-701"><a href="#cb40-701"></a><span class="in">`hotspot_count()`</span> function from the <span class="in">`sfhotspot`</span> package to count the number of</span>
<span id="cb40-702"><a href="#cb40-702"></a>buildings in each grid cell. We will then be able to combine those building </span>
<span id="cb40-703"><a href="#cb40-703"></a>counts to the estimates of burglary risk we have already calculated.</span>
<span id="cb40-704"><a href="#cb40-704"></a></span>
<span id="cb40-705"><a href="#cb40-705"></a></span>
<span id="cb40-706"><a href="#cb40-706"></a>::: {.box .notewell}</span>
<span id="cb40-707"><a href="#cb40-707"></a></span>
<span id="cb40-708"><a href="#cb40-708"></a>So that we can join the building counts to the burglary risk estimates, it is</span>
<span id="cb40-709"><a href="#cb40-709"></a>important that both layers are based on the same grid. In the code above we</span>
<span id="cb40-710"><a href="#cb40-710"></a>created a grid with the code <span class="in">`hotspot_grid(wards, cell_size = 100)`</span>, so to make</span>
<span id="cb40-711"><a href="#cb40-711"></a>sure we use the same grid to count buildings we can either use that same code</span>
<span id="cb40-712"><a href="#cb40-712"></a>again, or we could have saved the result of that code as an object (maybe called</span>
<span id="cb40-713"><a href="#cb40-713"></a><span class="in">`nottingham_wards_grid`</span>) and then provided that object to the <span class="in">`grid`</span> argument of</span>
<span id="cb40-714"><a href="#cb40-714"></a>both <span class="in">`hotspot_dual_kde()`</span> and <span class="in">`hotspot_count()`</span>.</span>
<span id="cb40-715"><a href="#cb40-715"></a></span>
<span id="cb40-716"><a href="#cb40-716"></a>Note that the results of <span class="in">`hotspot_dual_kde()`</span> and <span class="in">`hotspot_count()`</span> will only</span>
<span id="cb40-717"><a href="#cb40-717"></a>have the same structure before we wrangle then any further, for example by using</span>
<span id="cb40-718"><a href="#cb40-718"></a><span class="in">`filter()`</span> as in the previous section. This is why we saved an unfiltered </span>
<span id="cb40-719"><a href="#cb40-719"></a>version of the dataset in the <span class="in">`burglary_risk`</span> object.</span>
<span id="cb40-720"><a href="#cb40-720"></a></span>
<span id="cb40-721"><a href="#cb40-721"></a>:::</span>
<span id="cb40-722"><a href="#cb40-722"></a></span>
<span id="cb40-723"><a href="#cb40-723"></a></span>
<span id="cb40-724"><a href="#cb40-724"></a><span class="in">```{r count-exercise1, exercise=TRUE}</span></span>
<span id="cb40-725"><a href="#cb40-725"></a><span class="in">building_counts &lt;- hotspot_count(</span></span>
<span id="cb40-726"><a href="#cb40-726"></a><span class="in">  nottingham_building_centroids, </span></span>
<span id="cb40-727"><a href="#cb40-727"></a><span class="in">  grid = hotspot_grid(wards, cell_size = 100)</span></span>
<span id="cb40-728"><a href="#cb40-728"></a><span class="in">) |&gt; </span></span>
<span id="cb40-729"><a href="#cb40-729"></a><span class="in">  # Clip the result to the area for which we have data</span></span>
<span id="cb40-730"><a href="#cb40-730"></a><span class="in">  st_intersection(wards)</span></span>
<span id="cb40-731"><a href="#cb40-731"></a></span>
<span id="cb40-732"><a href="#cb40-732"></a><span class="in">head(building_counts)</span></span>
<span id="cb40-733"><a href="#cb40-733"></a><span class="in">```</span></span>
<span id="cb40-734"><a href="#cb40-734"></a></span>
<span id="cb40-735"><a href="#cb40-735"></a>The <span class="in">`building_counts`</span> and <span class="in">`burglary_risk`</span> objects have the same structure: each</span>
<span id="cb40-736"><a href="#cb40-736"></a>row represents a cell in the same grid, and the rows are in the same order </span>
<span id="cb40-737"><a href="#cb40-737"></a>(because both grids were created by identical calls to <span class="in">`hotspot_grid()`</span>). This</span>
<span id="cb40-738"><a href="#cb40-738"></a>means we can combine the two objects using the <span class="in">`bind_cols()`</span> function from the </span>
<span id="cb40-739"><a href="#cb40-739"></a><span class="in">`dplyr`</span> package (part of the tidyverse). </span>
<span id="cb40-740"><a href="#cb40-740"></a></span>
<span id="cb40-741"><a href="#cb40-741"></a><span class="in">```{r count-exercise2, exercise=TRUE}</span></span>
<span id="cb40-742"><a href="#cb40-742"></a><span class="in">burglary_risk_bldg &lt;- bind_cols(burglary_risk, building_counts)</span></span>
<span id="cb40-743"><a href="#cb40-743"></a></span>
<span id="cb40-744"><a href="#cb40-744"></a><span class="in">head(burglary_risk_bldg)</span></span>
<span id="cb40-745"><a href="#cb40-745"></a><span class="in">```</span></span>
<span id="cb40-746"><a href="#cb40-746"></a></span>
<span id="cb40-747"><a href="#cb40-747"></a>Looking at this object, we can see that <span class="in">`bind_cols()`</span> has changed the column</span>
<span id="cb40-748"><a href="#cb40-748"></a>names. This is because some of the column names were duplicated across the two</span>
<span id="cb40-749"><a href="#cb40-749"></a>datasets. Some of these new column names, such as <span class="in">`ward_code...3`</span> would be</span>
<span id="cb40-750"><a href="#cb40-750"></a>difficult to work with, so lets go back and remove duplicate columns before we</span>
<span id="cb40-751"><a href="#cb40-751"></a>combine the two datasets together.</span>
<span id="cb40-752"><a href="#cb40-752"></a></span>
<span id="cb40-753"><a href="#cb40-753"></a><span class="in">```{r count-exercise3, exercise=TRUE}</span></span>
<span id="cb40-754"><a href="#cb40-754"></a><span class="in">burglary_risk_bldg &lt;- burglary_risk |&gt; </span></span>
<span id="cb40-755"><a href="#cb40-755"></a><span class="in">  # Keep only the `n` and `kde` columns, renaming `n` to `burglary_count`</span></span>
<span id="cb40-756"><a href="#cb40-756"></a><span class="in">  # because there is also a column called `n` in the `building_counts` object</span></span>
<span id="cb40-757"><a href="#cb40-757"></a><span class="in">  select(burglary_count = n, kde) |&gt; </span></span>
<span id="cb40-758"><a href="#cb40-758"></a><span class="in">  # Remove the geometry column (since an identical one exists in </span></span>
<span id="cb40-759"><a href="#cb40-759"></a><span class="in">  # `building_counts`). Note that we do this separately because we can't use</span></span>
<span id="cb40-760"><a href="#cb40-760"></a><span class="in">  # `select()` to remove the `geometry` column.</span></span>
<span id="cb40-761"><a href="#cb40-761"></a><span class="in">  st_drop_geometry() |&gt; </span></span>
<span id="cb40-762"><a href="#cb40-762"></a><span class="in">  bind_cols(building_counts) |&gt; </span></span>
<span id="cb40-763"><a href="#cb40-763"></a><span class="in">  # After calling `bind_cols()` it is safe to use `filter()` to wrangle the</span></span>
<span id="cb40-764"><a href="#cb40-764"></a><span class="in">  # data</span></span>
<span id="cb40-765"><a href="#cb40-765"></a><span class="in">  filter(is.finite(kde))</span></span>
<span id="cb40-766"><a href="#cb40-766"></a><span class="in">```</span></span>
<span id="cb40-767"><a href="#cb40-767"></a></span>
<span id="cb40-768"><a href="#cb40-768"></a>We can now order the dataset with the cells with highest burglary risk at the </span>
<span id="cb40-769"><a href="#cb40-769"></a>top and calculate the *cumulative total* (also called a running total) of </span>
<span id="cb40-770"><a href="#cb40-770"></a>buildings using the <span class="in">`cumsum()`</span> function. We can use this running total to find </span>
<span id="cb40-771"><a href="#cb40-771"></a>the 100 buildings in the cells with highest burglary risk.</span>
<span id="cb40-772"><a href="#cb40-772"></a></span>
<span id="cb40-773"><a href="#cb40-773"></a><span class="in">```{r count-exercise4, exercise=TRUE, exercise.lines=13, eval=FALSE, echo=FALSE}</span></span>
<span id="cb40-774"><a href="#cb40-774"></a><span class="in">cells_for_prevention &lt;- burglary_risk_bldg |&gt; </span></span>
<span id="cb40-775"><a href="#cb40-775"></a><span class="in">  # Arrange cells from highest to lowest burglary risk</span></span>
<span id="cb40-776"><a href="#cb40-776"></a><span class="in">  arrange(desc(kde)) |&gt; </span></span>
<span id="cb40-777"><a href="#cb40-777"></a><span class="in">  # Count the number of buildings in a cell and all the cells with higher </span></span>
<span id="cb40-778"><a href="#cb40-778"></a><span class="in">  # burglary risk than that cell</span></span>
<span id="cb40-779"><a href="#cb40-779"></a><span class="in">  mutate(sum_buildings = cumsum(n)) |&gt; </span></span>
<span id="cb40-780"><a href="#cb40-780"></a><span class="in">  # Keep only those cells that contain the first 100 buildings</span></span>
<span id="cb40-781"><a href="#cb40-781"></a><span class="in">  filter(sum_buildings &lt; 100)</span></span>
<span id="cb40-782"><a href="#cb40-782"></a></span>
<span id="cb40-783"><a href="#cb40-783"></a><span class="in">head(cells_for_prevention)</span></span>
<span id="cb40-784"><a href="#cb40-784"></a><span class="in">```</span></span>
<span id="cb40-785"><a href="#cb40-785"></a></span>
<span id="cb40-786"><a href="#cb40-786"></a>We could now plot the <span class="in">`cells_for_prevention`</span> object on a map to show the grid</span>
<span id="cb40-787"><a href="#cb40-787"></a>cells containing the buildings that would receive the crime-prevention visits.</span>
<span id="cb40-788"><a href="#cb40-788"></a>We could also use <span class="in">`st_join()`</span> to join those cells to the dataset of buildings</span>
<span id="cb40-789"><a href="#cb40-789"></a>in the <span class="in">`nottingham_building_centroids`</span> object, which would give us a list of</span>
<span id="cb40-790"><a href="#cb40-790"></a>buildings to visit.</span>
<span id="cb40-791"><a href="#cb40-791"></a></span>
<span id="cb40-792"><a href="#cb40-792"></a></span>
<span id="cb40-793"><a href="#cb40-793"></a></span>
<span id="cb40-794"><a href="#cb40-794"></a><span class="fu">### Distinguishing hotspots from random variation</span></span>
<span id="cb40-795"><a href="#cb40-795"></a></span>
<span id="cb40-796"><a href="#cb40-796"></a>The density maps below show density estimates based on 1,000 points placed </span>
<span id="cb40-797"><a href="#cb40-797"></a>completely at random on 16 different maps. There are no real patterns in the </span>
<span id="cb40-798"><a href="#cb40-798"></a>data except for statistical noise. Nevertheless, the KDE process makes it appear </span>
<span id="cb40-799"><a href="#cb40-799"></a>that there are patterns in the data (if you reload this tutorial, these maps </span>
<span id="cb40-800"><a href="#cb40-800"></a>will change appearance completely, since the random numbers used for the x and y </span>
<span id="cb40-801"><a href="#cb40-801"></a>co-ordinates of the points will be regenerated).</span>
<span id="cb40-802"><a href="#cb40-802"></a></span>
<span id="cb40-803"><a href="#cb40-803"></a><span class="in">```{r random-map, fig.asp=1, fig.align='center'}</span></span>
<span id="cb40-804"><a href="#cb40-804"></a><span class="in">tibble(</span></span>
<span id="cb40-805"><a href="#cb40-805"></a><span class="in">  x = runif(n = 1000 * 16, min = 0, max = 100), </span></span>
<span id="cb40-806"><a href="#cb40-806"></a><span class="in">  y = runif(n = 1000 * 16, min = 0, max = 100),</span></span>
<span id="cb40-807"><a href="#cb40-807"></a><span class="in">  group = rep(1:16, each = 1000)</span></span>
<span id="cb40-808"><a href="#cb40-808"></a><span class="in">)  |&gt;  </span></span>
<span id="cb40-809"><a href="#cb40-809"></a><span class="in">  ggplot() + </span></span>
<span id="cb40-810"><a href="#cb40-810"></a><span class="in">  geom_density_2d_filled(aes(x, y), bins = 9) + </span></span>
<span id="cb40-811"><a href="#cb40-811"></a><span class="in">  scale_fill_brewer(</span></span>
<span id="cb40-812"><a href="#cb40-812"></a><span class="in">    labels = c("lower", rep("", 7), "higher"),</span></span>
<span id="cb40-813"><a href="#cb40-813"></a><span class="in">    palette = "Oranges", </span></span>
<span id="cb40-814"><a href="#cb40-814"></a><span class="in">    direction = 1,</span></span>
<span id="cb40-815"><a href="#cb40-815"></a><span class="in">    guide = guide_legend(reverse = TRUE)</span></span>
<span id="cb40-816"><a href="#cb40-816"></a><span class="in">  ) +</span></span>
<span id="cb40-817"><a href="#cb40-817"></a><span class="in">  facet_wrap(vars(group), ncol = 4) +</span></span>
<span id="cb40-818"><a href="#cb40-818"></a><span class="in">  coord_fixed() +</span></span>
<span id="cb40-819"><a href="#cb40-819"></a><span class="in">  labs(fill = "density") +</span></span>
<span id="cb40-820"><a href="#cb40-820"></a><span class="in">  theme_void() +</span></span>
<span id="cb40-821"><a href="#cb40-821"></a><span class="in">  theme(strip.text = element_blank())</span></span>
<span id="cb40-822"><a href="#cb40-822"></a><span class="in">```</span></span>
<span id="cb40-823"><a href="#cb40-823"></a></span>
<span id="cb40-824"><a href="#cb40-824"></a>This is a problem because we might end up responding to an apparent problem that</span>
<span id="cb40-825"><a href="#cb40-825"></a>is nothing but an artefact of the random variation that we expect to see in many</span>
<span id="cb40-826"><a href="#cb40-826"></a>processes, including crime.</span>
<span id="cb40-827"><a href="#cb40-827"></a></span>
<span id="cb40-828"><a href="#cb40-828"></a>If the police and other agencies looked at these patterns and did nothing in</span>
<span id="cb40-829"><a href="#cb40-829"></a>response to them, it is likely that over time some of the areas with high</span>
<span id="cb40-830"><a href="#cb40-830"></a>density would become areas of low density, and _vice versa_. However, the harm</span>
<span id="cb40-831"><a href="#cb40-831"></a>caused by crime means it is very hard for agencies to justify sitting back and</span>
<span id="cb40-832"><a href="#cb40-832"></a>do nothing to respond to it -- many people would consider it immoral to do so.</span>
<span id="cb40-833"><a href="#cb40-833"></a>So police and other agencies are very likely to try to respond to crime </span>
<span id="cb40-834"><a href="#cb40-834"></a>patterns, even if those patterns might have occurred by chance. This is very</span>
<span id="cb40-835"><a href="#cb40-835"></a>frustrating, because if we were to go back and look at the same data in a few</span>
<span id="cb40-836"><a href="#cb40-836"></a>months time it is very likely that the apparent hotspots would have shifted to</span>
<span id="cb40-837"><a href="#cb40-837"></a>somewhere different, making all the effort spent in responding to crime seem</span>
<span id="cb40-838"><a href="#cb40-838"></a>worthless (which, if the apparent patterns were actually artefacts of the KDE</span>
<span id="cb40-839"><a href="#cb40-839"></a>process, it may have been).</span>
<span id="cb40-840"><a href="#cb40-840"></a></span>
<span id="cb40-841"><a href="#cb40-841"></a>You might be thinking it's better safe than sorry, and that police should </span>
<span id="cb40-842"><a href="#cb40-842"></a>respond to the apparent patterns just in case they represent real concentrations</span>
<span id="cb40-843"><a href="#cb40-843"></a>in crime. But police resources are always scarce, so responding to one problem </span>
<span id="cb40-844"><a href="#cb40-844"></a>in one place means not responding to another problem in another place. This is</span>
<span id="cb40-845"><a href="#cb40-845"></a>known as the _opportunity cost_ of acting: if police focus their limited </span>
<span id="cb40-846"><a href="#cb40-846"></a>resources in one area, that comes at the cost of not being able to deploy those</span>
<span id="cb40-847"><a href="#cb40-847"></a>resources in other areas that might need it more.</span>
<span id="cb40-848"><a href="#cb40-848"></a></span>
<span id="cb40-849"><a href="#cb40-849"></a>We can try to avoid this problem of wasting resources responding to random</span>
<span id="cb40-850"><a href="#cb40-850"></a>variation in crime by determining whether the number of crimes in an area is</span>
<span id="cb40-851"><a href="#cb40-851"></a>more than the greatest number we would reasonably expect if there were no actual</span>
<span id="cb40-852"><a href="#cb40-852"></a>patterns in the data (if you have studied statistics before, you might recognise</span>
<span id="cb40-853"><a href="#cb40-853"></a>this as a description of a *null hypothesis*, but you don't need to have studied</span>
<span id="cb40-854"><a href="#cb40-854"></a>statistics to apply the techniques in this course).</span>
<span id="cb40-855"><a href="#cb40-855"></a></span>
<span id="cb40-856"><a href="#cb40-856"></a>To determine if the number of crimes in each area is greater than we would </span>
<span id="cb40-857"><a href="#cb40-857"></a>expect by chance, we can use the *Getis-Ord Gi\* statistic* (also called the</span>
<span id="cb40-858"><a href="#cb40-858"></a>*local G* statistic, spoken out-loud as the *G-I star statistic*). If the Gi* </span>
<span id="cb40-859"><a href="#cb40-859"></a>statistic for an area is greater than a certain value, we can say that the </span>
<span id="cb40-860"><a href="#cb40-860"></a>number of crimes in that area is higher than we would expect if there were no </span>
<span id="cb40-861"><a href="#cb40-861"></a>patterns in the data. We will call areas with more crimes than we would expect</span>
<span id="cb40-862"><a href="#cb40-862"></a>by chance as _hotspots_.</span>
<span id="cb40-863"><a href="#cb40-863"></a></span>
<span id="cb40-864"><a href="#cb40-864"></a>To see how this is done, watch this video that walks through the code needed to </span>
<span id="cb40-865"><a href="#cb40-865"></a>make a hotspot map using the Gi* statistic.</span>
<span id="cb40-866"><a href="#cb40-866"></a></span>
<span id="cb40-867"><a href="#cb40-867"></a>{{&lt; video https://youtu.be/VhVBfvfp8OY &gt;}}</span>
<span id="cb40-868"><a href="#cb40-868"></a></span>
<span id="cb40-869"><a href="#cb40-869"></a>We can calculate the Gi* statistic using the <span class="in">`hotspot_gistar()`</span> function from </span>
<span id="cb40-870"><a href="#cb40-870"></a>the <span class="in">`sfhotspot`</span> package. This works in a similar way to the <span class="in">`hotspot_kde()`</span></span>
<span id="cb40-871"><a href="#cb40-871"></a>function, in that it takes an SF object of the locations of crimes and returns </span>
<span id="cb40-872"><a href="#cb40-872"></a>an SF object with a grid of cells, along with the Gi* value for each grid cell.</span>
<span id="cb40-873"><a href="#cb40-873"></a>Like <span class="in">`hotspot_kde()`</span>, <span class="in">`hotspot_gistar()`</span> will choose default values for several</span>
<span id="cb40-874"><a href="#cb40-874"></a>ways in which we could fine-tune the calculation of the Gi* statistic, but we </span>
<span id="cb40-875"><a href="#cb40-875"></a>could over-ride these defaults if we wanted to.</span>
<span id="cb40-876"><a href="#cb40-876"></a></span>
<span id="cb40-877"><a href="#cb40-877"></a>In this example, we will find the hotspots of robbery in Nottingham in 2020,</span>
<span id="cb40-878"><a href="#cb40-878"></a>based on a grid of 100-metre cells. We will store this in an object called</span>
<span id="cb40-879"><a href="#cb40-879"></a><span class="in">`robbery`</span>, transform it to use the British National Grid co-ordinate system (so</span>
<span id="cb40-880"><a href="#cb40-880"></a>we can specify the cell size in metres) and then use the resulting object to </span>
<span id="cb40-881"><a href="#cb40-881"></a>calculate the Gi* values.</span>
<span id="cb40-882"><a href="#cb40-882"></a></span>
<span id="cb40-883"><a href="#cb40-883"></a><span class="in">```{r hotspot-exercise3, exercise=TRUE}</span></span>
<span id="cb40-884"><a href="#cb40-884"></a><span class="in">robbery &lt;- read_csv("https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz") |&gt; </span></span>
<span id="cb40-885"><a href="#cb40-885"></a><span class="in">  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) |&gt; </span></span>
<span id="cb40-886"><a href="#cb40-886"></a><span class="in">  st_transform(27700)</span></span>
<span id="cb40-887"><a href="#cb40-887"></a></span>
<span id="cb40-888"><a href="#cb40-888"></a><span class="in">robbery_gistar &lt;- hotspot_gistar(robbery, cell_size = 100, quiet = TRUE)</span></span>
<span id="cb40-889"><a href="#cb40-889"></a></span>
<span id="cb40-890"><a href="#cb40-890"></a><span class="in"># Use the `sample_n()` function from the `dplyr` package to return a random</span></span>
<span id="cb40-891"><a href="#cb40-891"></a><span class="in"># sample of 10 rows from the result</span></span>
<span id="cb40-892"><a href="#cb40-892"></a><span class="in">sample_n(robbery_gistar, 10)</span></span>
<span id="cb40-893"><a href="#cb40-893"></a><span class="in">```</span></span>
<span id="cb40-894"><a href="#cb40-894"></a></span>
<span id="cb40-895"><a href="#cb40-895"></a>The <span class="in">`robbery_gistar`</span> object contains one row for each cell in a grid of cells</span>
<span id="cb40-896"><a href="#cb40-896"></a>covering the area of the robbery data. Each row has four columns:</span>
<span id="cb40-897"><a href="#cb40-897"></a></span>
<span id="cb40-898"><a href="#cb40-898"></a><span class="ss">  * </span><span class="in">`n`</span> shows the number of robberies that occurred in that grid cell,</span>
<span id="cb40-899"><a href="#cb40-899"></a><span class="ss">  * </span><span class="in">`kde`</span> shows the density of robberies in that cell,</span>
<span id="cb40-900"><a href="#cb40-900"></a><span class="ss">  * </span><span class="in">`gistar`</span> shows the Gi* value for that cell, and</span>
<span id="cb40-901"><a href="#cb40-901"></a><span class="ss">  * </span><span class="in">`pvalue`</span> shows the $p$-value for that cell.</span>
<span id="cb40-902"><a href="#cb40-902"></a></span>
<span id="cb40-903"><a href="#cb40-903"></a>The Gi* statistic is an example of a more general group of statistics called</span>
<span id="cb40-904"><a href="#cb40-904"></a>$Z$ *scores*. Statisticians and data analysts compare the $Z$ scores produced by </span>
<span id="cb40-905"><a href="#cb40-905"></a>statistical procedures such as <span class="in">`hotspot_gistar()`</span> to reference values to decide </span>
<span id="cb40-906"><a href="#cb40-906"></a>if a $Z$ score is large enough to be treated as statistically significant, i.e. </span>
<span id="cb40-907"><a href="#cb40-907"></a>if it is large enough to conclude that it is larger than we would expect if </span>
<span id="cb40-908"><a href="#cb40-908"></a>there were no actual patterns in the data. Deciding on the right reference value </span>
<span id="cb40-909"><a href="#cb40-909"></a>to compare a $Z$ score to can be difficult because of what's known as the </span>
<span id="cb40-910"><a href="#cb40-910"></a>multiple comparison problem (which we don't need to go into detail about).</span>
<span id="cb40-911"><a href="#cb40-911"></a>Fortunately, the values in the <span class="in">`pvalue`</span> column have already been automatically</span>
<span id="cb40-912"><a href="#cb40-912"></a>adjusted to take account of the multiple comparison problem, so we can interpret </span>
<span id="cb40-913"><a href="#cb40-913"></a>the $p$-values instead of interpreting the Gi* statistic directly.</span>
<span id="cb40-914"><a href="#cb40-914"></a></span>
<span id="cb40-915"><a href="#cb40-915"></a></span>
<span id="cb40-916"><a href="#cb40-916"></a>::: {.box .notewell}</span>
<span id="cb40-917"><a href="#cb40-917"></a></span>
<span id="cb40-918"><a href="#cb40-918"></a>Since Gi* is a relative measure, if you have data for a large area (e.g. a </span>
<span id="cb40-919"><a href="#cb40-919"></a>country) but only want to show data for a smaller area (e.g. a city), the Gi* </span>
<span id="cb40-920"><a href="#cb40-920"></a>values will be influenced by the large areas with no crime and all of the city </span>
<span id="cb40-921"><a href="#cb40-921"></a>is likely to be identified as a hotspot. To prevent this, it is important to </span>
<span id="cb40-922"><a href="#cb40-922"></a>clip the dataset before calculating the Gi* values, as well as then clipping </span>
<span id="cb40-923"><a href="#cb40-923"></a>afterwards where necessary.</span>
<span id="cb40-924"><a href="#cb40-924"></a></span>
<span id="cb40-925"><a href="#cb40-925"></a>:::</span>
<span id="cb40-926"><a href="#cb40-926"></a></span>
<span id="cb40-927"><a href="#cb40-927"></a></span>
<span id="cb40-928"><a href="#cb40-928"></a>By convention, $p$-values are considered to be significant if they are _less </span>
<span id="cb40-929"><a href="#cb40-929"></a>than 0.05_. So if $p&lt;0.05$, we can say that the number of robberies occurring in </span>
<span id="cb40-930"><a href="#cb40-930"></a>a given grid cell is significantly different from zero. Values of Gi* greater </span>
<span id="cb40-931"><a href="#cb40-931"></a>than zero indicate cells with more robberies than expected and values of Gi* </span>
<span id="cb40-932"><a href="#cb40-932"></a>less than zero indicate cells with fewer robberies than expected. We can combine </span>
<span id="cb40-933"><a href="#cb40-933"></a>these two values to find cells with significantly _more_ robberies than expected</span>
<span id="cb40-934"><a href="#cb40-934"></a>by chance, which are those cells for which $Z&gt;0$ and $p&lt;0.05$. To put that into</span>
<span id="cb40-935"><a href="#cb40-935"></a>R code, we would write <span class="in">`gistar &gt; 0`</span> and <span class="in">`p &lt; 0.05`</span>.</span>
<span id="cb40-936"><a href="#cb40-936"></a></span>
<span id="cb40-937"><a href="#cb40-937"></a>We could use this information in various ways. For example, if we wanted to give</span>
<span id="cb40-938"><a href="#cb40-938"></a>local police officers a printed map of which areas to patrol, we could simply</span>
<span id="cb40-939"><a href="#cb40-939"></a>show the significant hotspot cells over a base map.</span>
<span id="cb40-940"><a href="#cb40-940"></a></span>
<span id="cb40-941"><a href="#cb40-941"></a><span class="in">```{r hotspot-exercise4, exercise=TRUE, message=FALSE, fig.asp=1, out.width="100%"}</span></span>
<span id="cb40-942"><a href="#cb40-942"></a><span class="in"># Plot a map</span></span>
<span id="cb40-943"><a href="#cb40-943"></a><span class="in">ggplot() +</span></span>
<span id="cb40-944"><a href="#cb40-944"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb40-945"><a href="#cb40-945"></a><span class="in">  geom_sf(</span></span>
<span id="cb40-946"><a href="#cb40-946"></a><span class="in">    data = filter(robbery_gistar, gistar &gt; 0, pvalue &lt; 0.05), </span></span>
<span id="cb40-947"><a href="#cb40-947"></a><span class="in">    fill = "red", </span></span>
<span id="cb40-948"><a href="#cb40-948"></a><span class="in">    alpha = 0.75,</span></span>
<span id="cb40-949"><a href="#cb40-949"></a><span class="in">    colour = NA</span></span>
<span id="cb40-950"><a href="#cb40-950"></a><span class="in">  ) +</span></span>
<span id="cb40-951"><a href="#cb40-951"></a><span class="in">  fixed_plot_aspect() +</span></span>
<span id="cb40-952"><a href="#cb40-952"></a><span class="in">  theme_void()</span></span>
<span id="cb40-953"><a href="#cb40-953"></a><span class="in">```</span></span>
<span id="cb40-954"><a href="#cb40-954"></a></span>
<span id="cb40-955"><a href="#cb40-955"></a>Since <span class="in">`hotspot_gistar()`</span> also estimates density for each grid cell, we could </span>
<span id="cb40-956"><a href="#cb40-956"></a>more usefully show the density of robberies in each cell, but only for cells </span>
<span id="cb40-957"><a href="#cb40-957"></a>that the Gi* values showed were significant hotspots.</span>
<span id="cb40-958"><a href="#cb40-958"></a></span>
<span id="cb40-959"><a href="#cb40-959"></a><span class="in">```{r hotspot-exercise5, exercise=TRUE, fig.asp=1, out.width="100%"}</span></span>
<span id="cb40-960"><a href="#cb40-960"></a><span class="in">ggplot() +</span></span>
<span id="cb40-961"><a href="#cb40-961"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb40-962"><a href="#cb40-962"></a><span class="in">  geom_sf(</span></span>
<span id="cb40-963"><a href="#cb40-963"></a><span class="in">    aes(fill = kde),</span></span>
<span id="cb40-964"><a href="#cb40-964"></a><span class="in">    data = filter(robbery_gistar, gistar &gt; 0, pvalue &lt; 0.05), </span></span>
<span id="cb40-965"><a href="#cb40-965"></a><span class="in">    alpha = 0.75,</span></span>
<span id="cb40-966"><a href="#cb40-966"></a><span class="in">    colour = NA</span></span>
<span id="cb40-967"><a href="#cb40-967"></a><span class="in">  ) +</span></span>
<span id="cb40-968"><a href="#cb40-968"></a><span class="in">  scale_fill_distiller(direction = 1) + </span></span>
<span id="cb40-969"><a href="#cb40-969"></a><span class="in">  fixed_plot_aspect() +</span></span>
<span id="cb40-970"><a href="#cb40-970"></a><span class="in">  theme_void()</span></span>
<span id="cb40-971"><a href="#cb40-971"></a><span class="in">```</span></span>
<span id="cb40-972"><a href="#cb40-972"></a></span>
<span id="cb40-973"><a href="#cb40-973"></a>This map could be very useful for police officers deciding where to conduct</span>
<span id="cb40-974"><a href="#cb40-974"></a>anti-robbery patrols, because it not only shows the areas with the highest</span>
<span id="cb40-975"><a href="#cb40-975"></a>density of robberies but only shows those areas if there are more robberies</span>
<span id="cb40-976"><a href="#cb40-976"></a>than we would expect by chance. This makes it more likely that officers won't</span>
<span id="cb40-977"><a href="#cb40-977"></a>waste time chasing apparent patterns that are actually the result of random</span>
<span id="cb40-978"><a href="#cb40-978"></a>variation.</span>
<span id="cb40-979"><a href="#cb40-979"></a></span>
<span id="cb40-980"><a href="#cb40-980"></a></span>
<span id="cb40-981"><a href="#cb40-981"></a><span class="fu">### Check your understanding {.tutorial}</span></span>
<span id="cb40-982"><a href="#cb40-982"></a></span>
<span id="cb40-983"><a href="#cb40-983"></a><span class="in">```{r gistar-quiz}</span></span>
<span id="cb40-984"><a href="#cb40-984"></a><span class="in">quiz(</span></span>
<span id="cb40-985"><a href="#cb40-985"></a><span class="in">  caption = "",</span></span>
<span id="cb40-986"><a href="#cb40-986"></a></span>
<span id="cb40-987"><a href="#cb40-987"></a><span class="in">  question("`robbery_gi` is an object storing a result produced by the `hotspot_gistar()` function. Which of these pieces of code could be used to extract _only_ those rows in the data with significant p-values?",</span></span>
<span id="cb40-988"><a href="#cb40-988"></a><span class="in">    answer("`filter(robbery_gi, pvalue &lt; 0.05)`", correct = TRUE),</span></span>
<span id="cb40-989"><a href="#cb40-989"></a><span class="in">    answer(</span></span>
<span id="cb40-990"><a href="#cb40-990"></a><span class="in">      "`filter(robbery_gi, pvalue &gt; 0.05)`",</span></span>
<span id="cb40-991"><a href="#cb40-991"></a><span class="in">      message = "That code would extract only _non-significant_ p-values. Try again!"</span></span>
<span id="cb40-992"><a href="#cb40-992"></a><span class="in">    ),</span></span>
<span id="cb40-993"><a href="#cb40-993"></a><span class="in">    answer(</span></span>
<span id="cb40-994"><a href="#cb40-994"></a><span class="in">      "`filter(robbery_gi, pvalue &lt;= 0.05)`",</span></span>
<span id="cb40-995"><a href="#cb40-995"></a><span class="in">      message = "Almost right, but not quite. Try re-reading the section of the tutorial above."</span></span>
<span id="cb40-996"><a href="#cb40-996"></a><span class="in">    ),</span></span>
<span id="cb40-997"><a href="#cb40-997"></a><span class="in">    answer(</span></span>
<span id="cb40-998"><a href="#cb40-998"></a><span class="in">      "`filter(robbery_gi, pvalue == 0.05)`",</span></span>
<span id="cb40-999"><a href="#cb40-999"></a><span class="in">      message = "That's not right. Try re-reading the section of the tutorial above."</span></span>
<span id="cb40-1000"><a href="#cb40-1000"></a><span class="in">    ),</span></span>
<span id="cb40-1001"><a href="#cb40-1001"></a><span class="in">    allow_retry = TRUE,</span></span>
<span id="cb40-1002"><a href="#cb40-1002"></a><span class="in">    random_answer_order = TRUE</span></span>
<span id="cb40-1003"><a href="#cb40-1003"></a><span class="in">  ),</span></span>
<span id="cb40-1004"><a href="#cb40-1004"></a><span class="in">  </span></span>
<span id="cb40-1005"><a href="#cb40-1005"></a><span class="in">  question("Which *one* of these statements is true about an SF object called `robberies_in_nottingham`?",</span></span>
<span id="cb40-1006"><a href="#cb40-1006"></a><span class="in">    answer("We cannot remove the `geometry` column of an SF object with `select()`, so we must use `st_drop_geometry()` instead.", correct = TRUE),</span></span>
<span id="cb40-1007"><a href="#cb40-1007"></a><span class="in">    answer("We can remove the `geometry` column with the code `select(robberies_in_nottingham, -geometry)`."),</span></span>
<span id="cb40-1008"><a href="#cb40-1008"></a><span class="in">    answer("We can remove the `geometry` column with the code `filter(robberies_in_nottingham, -geometry)`."),</span></span>
<span id="cb40-1009"><a href="#cb40-1009"></a><span class="in">    answer("There is no way to remove the `geometry` column from an SF object."),</span></span>
<span id="cb40-1010"><a href="#cb40-1010"></a><span class="in">    allow_retry = TRUE,</span></span>
<span id="cb40-1011"><a href="#cb40-1011"></a><span class="in">    random_answer_order = TRUE</span></span>
<span id="cb40-1012"><a href="#cb40-1012"></a><span class="in">  )</span></span>
<span id="cb40-1013"><a href="#cb40-1013"></a><span class="in">)</span></span>
<span id="cb40-1014"><a href="#cb40-1014"></a><span class="in">```</span></span>
<span id="cb40-1015"><a href="#cb40-1015"></a></span>
<span id="cb40-1016"><a href="#cb40-1016"></a></span>
<span id="cb40-1017"><a href="#cb40-1017"></a></span>
<span id="cb40-1018"><a href="#cb40-1018"></a><span class="fu">## Putting it all together</span></span>
<span id="cb40-1019"><a href="#cb40-1019"></a></span>
<span id="cb40-1020"><a href="#cb40-1020"></a>::: {.box .welldone}</span>
<span id="cb40-1021"><a href="#cb40-1021"></a></span>
<span id="cb40-1022"><a href="#cb40-1022"></a>In this tutorial we have learned about hotspots, how to create dual KDE maps and </span>
<span id="cb40-1023"><a href="#cb40-1023"></a>how to find significant hotspots using the Gi* statistic. We can put this all</span>
<span id="cb40-1024"><a href="#cb40-1024"></a>together to create a complete script for producing a map of robbery hotspots in</span>
<span id="cb40-1025"><a href="#cb40-1025"></a>Nottingham</span>
<span id="cb40-1026"><a href="#cb40-1026"></a></span>
<span id="cb40-1027"><a href="#cb40-1027"></a>:::</span>
<span id="cb40-1028"><a href="#cb40-1028"></a></span>
<span id="cb40-1029"><a href="#cb40-1029"></a>The following code is all that is needed to produce this map. Read through the</span>
<span id="cb40-1030"><a href="#cb40-1030"></a>comments accompanying the code to see how what we have learned in this tutorial</span>
<span id="cb40-1031"><a href="#cb40-1031"></a>fits together, then run the code to produce the map. </span>
<span id="cb40-1032"><a href="#cb40-1032"></a></span>
<span id="cb40-1033"><a href="#cb40-1033"></a></span>
<span id="cb40-1034"><a href="#cb40-1034"></a>::: {.box .notewell}</span>
<span id="cb40-1035"><a href="#cb40-1035"></a></span>
<span id="cb40-1036"><a href="#cb40-1036"></a>It is possible that this code will not run in this tutorial window because of </span>
<span id="cb40-1037"><a href="#cb40-1037"></a>limits on how long code can run in an R tutorial. If that happens, paste the </span>
<span id="cb40-1038"><a href="#cb40-1038"></a>code below into a blank R script in RStudio and run it from there to see the </span>
<span id="cb40-1039"><a href="#cb40-1039"></a>map.</span>
<span id="cb40-1040"><a href="#cb40-1040"></a></span>
<span id="cb40-1041"><a href="#cb40-1041"></a>:::</span>
<span id="cb40-1042"><a href="#cb40-1042"></a></span>
<span id="cb40-1043"><a href="#cb40-1043"></a></span>
<span id="cb40-1044"><a href="#cb40-1044"></a><span class="in">```{r final-exercise1, exercise=TRUE, exercise.lines=66, message=FALSE, fig.asp=1, out.width="100%"}</span></span>
<span id="cb40-1045"><a href="#cb40-1045"></a><span class="in"># Prepare ----------------------------------------------------------------------</span></span>
<span id="cb40-1046"><a href="#cb40-1046"></a></span>
<span id="cb40-1047"><a href="#cb40-1047"></a><span class="in"># Load packages</span></span>
<span id="cb40-1048"><a href="#cb40-1048"></a><span class="in">library(ggspatial)</span></span>
<span id="cb40-1049"><a href="#cb40-1049"></a><span class="in">library(sf)</span></span>
<span id="cb40-1050"><a href="#cb40-1050"></a><span class="in">library(sfhotspot)</span></span>
<span id="cb40-1051"><a href="#cb40-1051"></a><span class="in">library(tidyverse)</span></span>
<span id="cb40-1052"><a href="#cb40-1052"></a></span>
<span id="cb40-1053"><a href="#cb40-1053"></a><span class="in"># Load data and transform to British National Grid, which is easier to work with</span></span>
<span id="cb40-1054"><a href="#cb40-1054"></a><span class="in"># for functions that use spatial units such as metres</span></span>
<span id="cb40-1055"><a href="#cb40-1055"></a><span class="in">robbery &lt;- read_csv("https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz") |&gt; </span></span>
<span id="cb40-1056"><a href="#cb40-1056"></a><span class="in">  st_as_sf(coords = c("longitude", "latitude"), crs = "EPSG:4326") |&gt; </span></span>
<span id="cb40-1057"><a href="#cb40-1057"></a><span class="in">  st_transform("EPSG:27700")</span></span>
<span id="cb40-1058"><a href="#cb40-1058"></a><span class="in">nottingham_wards &lt;- read_sf("https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg") |&gt; </span></span>
<span id="cb40-1059"><a href="#cb40-1059"></a><span class="in">  st_transform("EPSG:27700")</span></span>
<span id="cb40-1060"><a href="#cb40-1060"></a></span>
<span id="cb40-1061"><a href="#cb40-1061"></a></span>
<span id="cb40-1062"><a href="#cb40-1062"></a><span class="in"># Find significant grid cells --------------------------------------------------</span></span>
<span id="cb40-1063"><a href="#cb40-1063"></a></span>
<span id="cb40-1064"><a href="#cb40-1064"></a><span class="in"># Calculate Gi* statistic, filter for only significant hotspot cells and clip to</span></span>
<span id="cb40-1065"><a href="#cb40-1065"></a><span class="in"># the city boundary</span></span>
<span id="cb40-1066"><a href="#cb40-1066"></a><span class="in">robbery_gi &lt;- robbery |&gt; </span></span>
<span id="cb40-1067"><a href="#cb40-1067"></a><span class="in">  hotspot_gistar(cell_size = 100, bandwidth_adjust = 0.25, quiet = TRUE) |&gt; </span></span>
<span id="cb40-1068"><a href="#cb40-1068"></a><span class="in">  filter(gistar &gt; 0, pvalue &lt; 0.05) |&gt; </span></span>
<span id="cb40-1069"><a href="#cb40-1069"></a><span class="in">  st_intersection(nottingham_wards)</span></span>
<span id="cb40-1070"><a href="#cb40-1070"></a></span>
<span id="cb40-1071"><a href="#cb40-1071"></a></span>
<span id="cb40-1072"><a href="#cb40-1072"></a><span class="in"># Plot map ---------------------------------------------------------------------</span></span>
<span id="cb40-1073"><a href="#cb40-1073"></a></span>
<span id="cb40-1074"><a href="#cb40-1074"></a><span class="in">ggplot() + </span></span>
<span id="cb40-1075"><a href="#cb40-1075"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb40-1076"><a href="#cb40-1076"></a><span class="in">  # Add density for significant cells</span></span>
<span id="cb40-1077"><a href="#cb40-1077"></a><span class="in">  geom_sf(</span></span>
<span id="cb40-1078"><a href="#cb40-1078"></a><span class="in">    aes(fill = kde), </span></span>
<span id="cb40-1079"><a href="#cb40-1079"></a><span class="in">    data = robbery_gi, </span></span>
<span id="cb40-1080"><a href="#cb40-1080"></a><span class="in">    alpha = 0.8,</span></span>
<span id="cb40-1081"><a href="#cb40-1081"></a><span class="in">    colour = NA</span></span>
<span id="cb40-1082"><a href="#cb40-1082"></a><span class="in">  ) +</span></span>
<span id="cb40-1083"><a href="#cb40-1083"></a><span class="in">  # Add ward boundaries</span></span>
<span id="cb40-1084"><a href="#cb40-1084"></a><span class="in">  geom_sf(data = nottingham_wards, colour = "grey70", fill = NA) +</span></span>
<span id="cb40-1085"><a href="#cb40-1085"></a><span class="in">  scale_fill_distiller(</span></span>
<span id="cb40-1086"><a href="#cb40-1086"></a><span class="in">    breaks = range(pull(robbery_gi, kde)),</span></span>
<span id="cb40-1087"><a href="#cb40-1087"></a><span class="in">    labels = c("lower", "higher"),</span></span>
<span id="cb40-1088"><a href="#cb40-1088"></a><span class="in">    direction = 1</span></span>
<span id="cb40-1089"><a href="#cb40-1089"></a><span class="in">  ) +</span></span>
<span id="cb40-1090"><a href="#cb40-1090"></a><span class="in">  fixed_plot_aspect() +</span></span>
<span id="cb40-1091"><a href="#cb40-1091"></a><span class="in">  labs(</span></span>
<span id="cb40-1092"><a href="#cb40-1092"></a><span class="in">      title = "Nottingham robbery hotspots",</span></span>
<span id="cb40-1093"><a href="#cb40-1093"></a><span class="in">      subtitle = str_glue(</span></span>
<span id="cb40-1094"><a href="#cb40-1094"></a><span class="in">        "density of robbery in places with more violence than expected by ",</span></span>
<span id="cb40-1095"><a href="#cb40-1095"></a><span class="in">        "chance"</span></span>
<span id="cb40-1096"><a href="#cb40-1096"></a><span class="in">      ),</span></span>
<span id="cb40-1097"><a href="#cb40-1097"></a><span class="in">      # Don't forget to add the licence statement -- it's a legal requirement!</span></span>
<span id="cb40-1098"><a href="#cb40-1098"></a><span class="in">      caption = str_glue(</span></span>
<span id="cb40-1099"><a href="#cb40-1099"></a><span class="in">        "Contains public sector information licensed under the Open ",</span></span>
<span id="cb40-1100"><a href="#cb40-1100"></a><span class="in">        "Government Licence v3.0. Map data from OpenStreetMap."</span></span>
<span id="cb40-1101"><a href="#cb40-1101"></a><span class="in">      ),</span></span>
<span id="cb40-1102"><a href="#cb40-1102"></a><span class="in">      fill = str_wrap("density of robbery at significant hotspots, 2022", 15)</span></span>
<span id="cb40-1103"><a href="#cb40-1103"></a><span class="in">  ) +</span></span>
<span id="cb40-1104"><a href="#cb40-1104"></a><span class="in">  theme_void() +</span></span>
<span id="cb40-1105"><a href="#cb40-1105"></a><span class="in">  theme(</span></span>
<span id="cb40-1106"><a href="#cb40-1106"></a><span class="in">    plot.caption = element_text(colour = "grey40", hjust = 0),</span></span>
<span id="cb40-1107"><a href="#cb40-1107"></a><span class="in">    plot.subtitle = element_text(margin = margin(t = 6, b = 6)),</span></span>
<span id="cb40-1108"><a href="#cb40-1108"></a><span class="in">    plot.title = element_text(colour = "grey50", face = "bold", size = 16)</span></span>
<span id="cb40-1109"><a href="#cb40-1109"></a><span class="in">  )</span></span>
<span id="cb40-1110"><a href="#cb40-1110"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by/4.0/">
<p>This book is available under a Creative Commons Attribution 4.0 International licence</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>