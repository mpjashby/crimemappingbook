<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Learn crime mapping with R - 11&nbsp; Crime Mapping: Mapping hotspots</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../12_messy_data/index.html" rel="next">
<link href="../10_place_data/index.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><!-- START OF INCLUDED HEADER --><!--
This file contains code that will be included in the header of each page of the
quarto book
--><script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script><!-- END OF INCLUDED HEADER --><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="../css/styles.css">
<meta name="twitter:title" content="Learn crime mapping with R - 11&nbsp; Crime Mapping: Mapping hotspots">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../11_mapping_hotspots/index.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Crime Mapping: Mapping hotspots</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Learn crime mapping with R</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/mpjashby/crimemappingbook/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../learn_crime_mapping_with_r.epub" title="Download ePub" class="quarto-navigation-tool px-1" aria-label="Download ePub"><i class="bi bi-journal"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../00_setup/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install the software needed for this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_getting_started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_your_first_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Your first crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_data_wrangling/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_code_with_style/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Code with style</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_your_second_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Your second crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_map_context/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Giving a map context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_handling_bugs/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Handling bugs in your code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_projects/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Don’t get lost in data analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_mapping_areas/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Mapping area data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../10_place_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Crime Mapping: Using data about places</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../11_mapping_hotspots/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Crime Mapping: Mapping hotspots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../12_messy_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../13_crime_series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Mapping crime series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../14_writing_reports/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Writing reports in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../15_no_maps/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Presenting spatial data without maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../16_mapping_time/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Mapping crime over time</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/read_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Functions for reading data into R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/common_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Common R errors and how to fix them</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
    <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">In this chapter</h2>
   
  <ul class="collapse">
<li><a href="#what-is-a-hotspot" id="toc-what-is-a-hotspot" class="nav-link active" data-scroll-target="#what-is-a-hotspot"><span class="header-section-number">11.1</span> What is a hotspot?</a></li>
  <li><a href="#showing-the-density-of-risk" id="toc-showing-the-density-of-risk" class="nav-link" data-scroll-target="#showing-the-density-of-risk"><span class="header-section-number">11.2</span> Showing the density of risk</a></li>
  <li><a href="#finding-hotspots" id="toc-finding-hotspots" class="nav-link" data-scroll-target="#finding-hotspots"><span class="header-section-number">11.3</span> Finding hotspots</a></li>
  <li><a href="#putting-it-all-together" id="toc-putting-it-all-together" class="nav-link" data-scroll-target="#putting-it-all-together"><span class="header-section-number">11.4</span> Putting it all together</a></li>
  </ul><div class="toc-actions"><ul class="collapse"><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Crime Mapping: Mapping hotspots</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p><strong>Learn what crime hotspots are, why they are important and how to map them.</strong></p>
<div class="box load-tutorial">
<p>To load the <a href="../#how-to-use-this-book">interactive tutorial</a> for this chapter, copy and paste the following code into the RStudio console:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>crimemapping<span class="sc">::</span><span class="fu">tutorial</span>(<span class="st">"11_mapping_hotspots"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and press <code>Enter</code>.</p>
</div>
<section id="what-is-a-hotspot" class="level2" data-number="11.1"><h2 data-number="11.1" class="anchored" data-anchor-id="what-is-a-hotspot">
<span class="header-section-number">11.1</span> What is a hotspot?</h2>
<p>Crime is heavily concentrated in several different ways. A small number of offenders commit a large proportion of crime (even though most people commit minor offences occasionally) and a small number of people are repeatedly victimised. For most types of crime, a large proportion of crime occurs in a small number of places. <strong>A hotspot is a specific location or small area where an unusual amount of criminal activity occurs</strong>.</p>
<p>Crime hotspots can occur in several different forms. Watch this video to understand why hotspots are important in understanding and responding to crime.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/ug-ZhvvQjmw" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>Some places are <em>chronic</em> hotspots – they have more crime than surrounding areas over a sustained period (which may appear to be permanent). Chronic hotspots are often generated by a facility that draws vulnerable people into an area, such as a tourist attraction that draws crowds of people who are vulnerable to pickpocketing. Other places are <em>acute</em> hotspots, in which crime increases in a place that previously experienced no or few crimes. This may be the result of some change in the environment or how it’s managed, such as new management at a bar that ignores drug dealing that the previous owners would have not permitted.</p>
<p>When analysing hotspots, it is best to focus on <em>small</em> areas such as an apartment block, a shopping centre, a park or a single street. Focusing on smaller areas is important because resources to respond to crime are almost always limited, so it is important that those resources are directed where the problem is worst.</p>
<p>Analysing larger areas, such as a neighbourhood or a police sector, is much more difficult because larger areas are always made up of many smaller areas, each of which might be quite different from one another. This means that the factors causing one street to be a hotspot might be quite different from the factors that make another street in the same district into a hotspot. Conflating different problems with different causes makes it much harder to find effective ways to reduce crime in any one place.</p>
<p>These difficulties can be avoided (at least partly) by keeping hotspots small: in an urban area, a useful rule of thumb is that you should be able to stand in the middle of a hotspot and see the whole hotspot area.</p>
<p>Being able to identify hotspots using crime mapping is important because it forms a vital first step in many place-focused responses to crime. As an example of this, watch this video about how police in Philadelphia worked with researchers to use crime mapping to identify where to deploy foot patrols to reduce crime.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/0NUQsK0vnnM" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>In this tutorial we will learn how to make maps that could be useful in identifying and responding to hotspots of crime. As an example, we will create this map showing hotspots of robbery in Nottingham, England.</p>
<p class="full-width-image">
<img src="images/nottingham_robbery_map.jpg" alt="A hotspot map of robberies in Nottingham" style="max-height: 700px;"></p>
<section id="check-your-understanding" class="level3 tutorial" data-number="11.1.1"><h3 class="tutorial anchored" data-number="11.1.1" data-anchor-id="check-your-understanding">
<span class="header-section-number">11.1.1</span> Check your understanding</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">quiz</span>(</span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="at">caption =</span> <span class="st">""</span>,</span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="fu">question</span>(<span class="st">"Which *one* of these statements is true?"</span>,</span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="fu">answer</span>(<span class="st">"Crime is very geographically concentrated – we can expect half of crime to be concentrated in about 5% of micro places"</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="fu">answer</span>(<span class="st">"Crime is usually not geographically concentrated at micro places"</span>),</span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="fu">answer</span>(<span class="st">"Crime is slightly geographically concentrated – we can expect half of crime to be concentrated in about one quarter of micro places"</span>),</span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="fu">answer</span>(<span class="st">"Crime is extremely geographically concentrated – we can expect half of crime to be concentrated in about 1% of micro places"</span>),</span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="at">correct =</span> <span class="st">"That's correct – based on previous studies, we can expect half of crime to be concentrated in about 5% of micro places"</span>,</span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="at">incorrect =</span> <span class="st">"That's not correct – try re-watching the first video above and then try the question again."</span>,</span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  )</span>
<span id="cb2-13"><a href="#cb2-13"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="showing-the-density-of-risk" class="level2" data-number="11.2"><h2 data-number="11.2" class="anchored" data-anchor-id="showing-the-density-of-risk">
<span class="header-section-number">11.2</span> Showing the density of risk</h2>
<p>In the tutorial on mapping area data we learned how to produce maps showing the <em>incidence rate</em> of crime by dividing the number of crimes by a measure of the population at risk of being targeted. We will often only have population estimates for areas, such as census estimates of the number of people living in an area. But for some crimes we have access to estimates of the people (or, more often, objects) at risk of being a target of a particular crime. In these cases, we can produce better maps of the risk of crime in different areas by producing a <em>dual KDE</em> map that shows the density of crime <em>risk</em> in different places.</p>
<p>To create a dual KDE map, we must estimate the density of crime and compare it to an estimate the density of the population at risk. Since the incidence rate is calculated as the number of crimes divided by the number of people or objects at risk, we can calculate the density of risk by dividing the density of crime estimated for each cell in the grid by the density of population estimated for the same cell. The <code>hotspot_dual_kde()</code> function from the <code>sfhotspot</code> package does this for us.</p>
<p>To illustrate making a dual KDE map, we will use reports of burglaries in three wards in Nottingham in 2020. Since the essential element of the crime of burglary in England is that an offender enters a <em>building</em> as a trespasser in order to steal something, the best measure of the population at risk of burglary is the number of <em>buildings</em> in each area (the definition of burglary is more complicated than this, but we don’t need to worry about that here).</p>
<p>Burglary is a good example of why the routine activities approach to thinking about crime that we introduced in a previous tutorial emphasises thinking about <em>targets</em> of crime rather than focusing only on crime <em>victims</em>. In the case of burglary, one person might be the owner of a large number of buildings (e.g.&nbsp;a farm with lots of out-buildings) or lots of people might own a single building (such as a house converted into flats). By thinking about the targets that are attacked by offenders, we can identify that burglary rates should be calculated based on buildings rather than, for example, residential population. Note that if our crime data only included <em>residential</em> burglaries then we would want to use <em>residential</em> buildings as our denominator, but in this case we have data for all burglaries, both residential and non-residential.</p>
<section id="data-wrangling" class="level3" data-number="11.2.1"><h3 data-number="11.2.1" class="anchored" data-anchor-id="data-wrangling">
<span class="header-section-number">11.2.1</span> Data wrangling</h3>
<p>Before we can create our dual KDE layer, we have to complete some data wrangling. We will extract the boundaries for the wards of interest from a dataset of boundaries for all wards in Nottingham using <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> as we have done previously. To extract only the burglaries occurring in those three wards from a dataset of all burglaries in Nottingham, we will use <code>st_intersection()</code>. We will also transform both datasets to use the British National Grid (EPSG code 27700), since we will need to do that anyway before calculating the KDE values.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>wards <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="fu">filter</span>(ward_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Castle"</span>, <span class="st">"Lenton &amp; Wollaton East"</span>, <span class="st">"Meadows"</span>))</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>burglaries <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_burglary.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="fu">st_intersection</span>(wards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 1795 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): location, lsoa_code
dbl  (2): longitude, latitude
date (1): month

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
</div>
<div class="box notewell">
<p><code>st_intersection()</code> can take longer to run than the maximum time limit for running code within this tutorial. If you see an error saying <code>Your code ran  longer than the permitted time limit for this exercise</code> or <code>reached elapsed time  limit</code>, you can continue with the rest of the tutorial as usual.</p>
</div>
<p>We do not have a source of open data for all the buildings in Nottingham, so we will use the <code>osmdata</code> package to get the locations of buildings from OpenStreetMap (OSM). You may remember from a previous tutorial that to do this we need to know which key (and possibly value) the OSM database uses for storing the locations of buildings. The OSM feature key for a building is ‘building’ and it is not necessary to specify a value (since we want to capture all types of building). The <code>osmdata</code> package expects data to use the WGS84 co-ordinate reference system, so we must also make sure any data sources we use are projected using that system (EPSG code 4326).</p>
<div class="tutorial">
<p>Run the code needed to download data from OSM for all the buildings in the three wards we are interested in and store it in an object called <code>nottingham_buildings</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># To download OSM data, use:</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">#   * `st_transform()` to transform the data to use the WGS84 co-ordinate system</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">#   * `st_bbox()` to calculate the bounding box of the wards</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">#   * `opq()` to set up the OSM query </span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#   * `add_osm_feature()` to specify what type of features to download</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">#   * `osmdata_sf()` to download the data as an SF object</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">library</span>(osmdata)</span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a>nottingham_buildings <span class="ot">&lt;-</span> wards <span class="sc">|&gt;</span> </span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="fu">opq</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-7"><a href="#cb7-7"></a>  <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"?????"</span>) <span class="sc">|&gt;</span>  <span class="co"># &lt;- specify type of data here</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>  <span class="fu">osmdata_sf</span>()</span>
<span id="cb7-9"><a href="#cb7-9"></a></span>
<span id="cb7-10"><a href="#cb7-10"></a>nottingham_buildings</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Object of class 'osmdata' with:
                 $bbox : 52.9173362670705,-1.21712477980417,52.9596833099217,-1.13020878819132
        $overpass_call : The call submitted to the overpass API
                 $meta : metadata including timestamp and version numbers
           $osm_points : 'sf' Simple Features Collection with 0 points
            $osm_lines : NULL
         $osm_polygons : 'sf' Simple Features Collection with 0 polygons
       $osm_multilines : NULL
    $osm_multipolygons : NULL</code></pre>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">library</span>(osmdata)</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a>nottingham_buildings <span class="ot">&lt;-</span> wards <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="fu">opq</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"building"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="fu">osmdata_sf</span>()</span>
<span id="cb9-9"><a href="#cb9-9"></a></span>
<span id="cb9-10"><a href="#cb9-10"></a>nottingham_buildings</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Object of class 'osmdata' with:
                 $bbox : 52.9173362670705,-1.21712477980417,52.9596833099217,-1.13020878819132
        $overpass_call : The call submitted to the overpass API
                 $meta : metadata including timestamp and version numbers
           $osm_points : 'sf' Simple Features Collection with 163813 points
            $osm_lines : 'sf' Simple Features Collection with 45 linestrings
         $osm_polygons : 'sf' Simple Features Collection with 30363 polygons
       $osm_multilines : 'sf' Simple Features Collection with 2 multilinestrings
    $osm_multipolygons : 'sf' Simple Features Collection with 69 multipolygons</code></pre>
</div>
</div>
<p>Looking at the <code>nottingham_buildings</code> object, we can see that OSM contains data on buildings stored as points, polygons and multipolygons (we can ignore the few linestrings tagged as buildings, since it doesn’t make sense for a building to be represented as a single line rather than a point or a polygon).</p>
<div class="box extra-detail">
<h5 id="risk-box1-title" class="box-title anchored">
What is a multipolygon?
</h5>
<div id="risk-box1" class="box-content">
<p>OpenStreetMap stores features in several different ways. The most basic types are points, lines and polygons. But there are also multipolygons (and multilines). These are features that represent complex structures such as clusters of buildings that are separate structures but are related to each other. For example, a hospital with several buildings might be represented in OpenStreetMap as a single multipolygon feature.</p>
</div>
</div>
<script>
$("#risk-box1-title").click(function () { $("#risk-box1").toggle("slow") })
</script><p>Let’s plot these features on a base map to check that OSM has reasonable coverage of the buildings in these three wards.</p>
<div class="cell" data-exercise="true" data-exercise.lines="23">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartodark"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="co"># Add building features stored as points</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb11-5"><a href="#cb11-5"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_points"</span>), </span>
<span id="cb11-6"><a href="#cb11-6"></a>    <span class="at">colour =</span> <span class="st">"green"</span>,</span>
<span id="cb11-7"><a href="#cb11-7"></a>    <span class="at">size =</span> <span class="fl">0.1</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>  ) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>  <span class="co"># Add building features stored as polygons</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb11-11"><a href="#cb11-11"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_polygons"</span>), </span>
<span id="cb11-12"><a href="#cb11-12"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb11-13"><a href="#cb11-13"></a>    <span class="at">fill =</span> <span class="st">"blue"</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>  ) <span class="sc">+</span> </span>
<span id="cb11-15"><a href="#cb11-15"></a>  <span class="co"># Add building features stored as multi-polygons</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb11-17"><a href="#cb11-17"></a>    <span class="at">data =</span> <span class="fu">pluck</span>(nottingham_buildings, <span class="st">"osm_multipolygons"</span>), </span>
<span id="cb11-18"><a href="#cb11-18"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb11-19"><a href="#cb11-19"></a>    <span class="at">fill =</span> <span class="st">"darkred"</span></span>
<span id="cb11-20"><a href="#cb11-20"></a>  ) <span class="sc">+</span></span>
<span id="cb11-21"><a href="#cb11-21"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="at">colour =</span> <span class="st">"red"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">1.25</span>) <span class="sc">+</span></span>
<span id="cb11-22"><a href="#cb11-22"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/risk-exercise3-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="box notewell">
<p>Remember that <code>osmdata_sf()</code> gets OSM data for the area covered by the <em>bounding box</em> of the input feature, not the feature boundaries. This means some of the buildings returned by the code above will be outside the wards we are interested in. We will deal with this in a minute.</p>
</div>
<p>It looks like almost all the streets in the three wards we are interested in are lined with buildings in the OSM data, which is what we would expect of streets in an urban area. There are some streets without buildings in the top-left of the map, but these streets are outside our three wards so this does not matter.</p>
<p>We can also see from this map that the 163,813 point features in the OSM data (shown as green dots on the map) typically represent the corners of buildings that are also represented as polygons, so we know we can ignore the points layer within the OSM data.</p>
<p>Since the <code>hotspot_dual_kde()</code> function works on points, we need to convert the polygon and multipolygon layers to points by calculating their centroids, then merge the two layers together. This will generate a warning that <code>st_centroid does not give correct centroids for longitude/latitude data</code> but we can ignore this because the calculated centroids will be good enough for our purposes (if we wanted to, we could transform the data to use the British National Grid, calculate the centroids and then transform it back).</p>
<p>Since we are only interested in those buildings in three particular wards, we can also at this stage remove any buildings that are outside those wards using <code>st_intersection()</code>, as we have already done for the <code>burglaries</code> object. Since the <code>wards</code> object uses the British National Grid and <code>st_intersection()</code> requires both datasets to use the same co-ordinate system, we will transform the building centroids before clipping them.</p>
<div class="box extra-detail">
<h5 id="risk-box2-title" class="box-title anchored">
What does the warning <code>st_centroid assumes …</code> mean?
</h5>
<div id="risk-box2" class="box-content">
<p>You might have seen a warning saying <code>st_centroid assumes attributes are constant over geometries of x</code>. You will see this warning when you use the <code>st_centroid()</code> function. It is there to remind you that columns in the original data (which the SF package refers to as the <em>attributes</em> associated with each spatial feature) refer to the polygon as a whole, but in the object produced by <code>st_centroid()</code> it will appear that the columns relate to the centroid point. In many cases this will not be a problem, but it could expose you to the ecological fallacy so it is sometimes useful to be reminded.</p>
</div>
</div>
<script>
$("#risk-box2-title").click(function () { $("#risk-box2").toggle("slow") })
</script><div class="box extra-detail">
<h5 id="risk-box3-title" class="box-title anchored">
What does the warning <code>attribute variables are assumed …</code> mean?
</h5>
<div id="risk-box3" class="box-content">
<p><code>st_intersection()</code> produces a warning message whenever it is used:</p>
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout all
geometries</code></pre>
<p>As long as you are simply using <code>st_intersection()</code> to remove parts of the data outside a boundary, you can ignore this message.</p>
</div>
</div>
<script>
$("#risk-box3-title").click(function () { $("#risk-box3").toggle("slow") })
</script></section><section id="calculating-dual-kernel-density" class="level3" data-number="11.2.2"><h3 data-number="11.2.2" class="anchored" data-anchor-id="calculating-dual-kernel-density">
<span class="header-section-number">11.2.2</span> Calculating dual kernel density</h3>
<p>We now have the object <code>burglaries</code> that contains the locations of each burglary in the three Nottingham wards that we are interested in, and the object <code>nottingham_building_centroids</code> that contains the centroids of each building in those three wards. We can use these layers to estimate the density of burglaries and buildings, then combine these to estimate the density of burglary risk.</p>
<p><code>hotspot_dual_kde()</code> works in the same way as <code>hotspot_kde()</code>, except that it requires two datasets. In this case, that means one dataset of crime locations and one dataset of building locations. <code>hotspot_dual_kde()</code> will set the cell size and bandwidth automatically, but we can set them manually using the <code>cell_size</code>, <code>bandwidth_adjust</code> and <code>grid</code> arguments in the same way we have done for <code>hotspot_kde()</code>. In this case, we will use the <code>hotspot_grid()</code> helper function to create a grid based on the boundaries of the wards we are interested in. All the spatial objects we are going to use here have co-ordinates specified using the British National Grid because we have already transformed them, so we do not need to do any transformation here.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>burglary_risk <span class="ot">&lt;-</span> <span class="fu">hotspot_dual_kde</span>(</span>
<span id="cb13-2"><a href="#cb13-2"></a>  burglaries, </span>
<span id="cb13-3"><a href="#cb13-3"></a>  nottingham_building_centroids, </span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, </span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="at">grid =</span> <span class="fu">hotspot_grid</span>(wards, <span class="at">cell_size =</span> <span class="dv">100</span>),</span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="fu">st_intersection</span>(wards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">head</span>(burglary_risk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 455826.6 ymin: 338782.9 xmax: 456354.2 ymax: 338909
Projected CRS: OSGB36 / British National Grid
# A tibble: 6 × 5
      n    kde ward_code ward_name                                      geometry
  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;                                     &lt;POLYGON [m]&gt;
1     0 0.0175 E05012277 Castle    ((456061.5 338809, 456061.5 338799.8, 456006…
2     0 0.0172 E05012277 Castle    ((456061.5 338809, 456161.5 338809, 456161.5…
3     0 0.0222 E05012277 Castle    ((456161.5 338809, 456261.5 338809, 456261.5…
4     0 0.0271 E05012277 Castle    ((456261.5 338809, 456354.2 338809, 456261.5…
5     0 0.0204 E05012277 Castle    ((455861.5 338909, 455861.5 338888.8, 455826…
6     0 0.0264 E05012277 Castle    ((455861.5 338909, 455961.5 338909, 455961.5…</code></pre>
</div>
</div>
<p>You might recall from earlier in this tutorial that the value of the <code>kde</code> column in the object produced by <code>hotspot_dual_kde()</code> is calculated by dividing the density of burglary in each grid cell by the density of buildings in the same grid cell. There are two cases where this will produce a result that is not a finite number:</p>
<ul>
<li>If, for a particular cell, the density of burglaries and density of buildings are both zero, dividing one by the other will produce the result <code>NaN</code>, for ‘not a number’.</li>
<li>If the density of burglaries is greater than zero but the density of buildings is exactly zero, the result will be <code>Inf</code>, for ‘infinite’.</li>
</ul>
<p>Since it is not possible to calculate burglary risk in either of those cases, we can exclude these cases from the <code>burglary_risk</code> object by using <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> together with the <code><a href="https://rdrr.io/r/base/is.finite.html">is.finite()</a></code> function (R does not count <code>NaN</code> as a finite number):</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>burglary_risk <span class="ot">&lt;-</span> <span class="fu">hotspot_dual_kde</span>(</span>
<span id="cb17-2"><a href="#cb17-2"></a>  burglaries, </span>
<span id="cb17-3"><a href="#cb17-3"></a>  nottingham_building_centroids, </span>
<span id="cb17-4"><a href="#cb17-4"></a>  <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, </span>
<span id="cb17-5"><a href="#cb17-5"></a>  <span class="at">grid =</span> <span class="fu">hotspot_grid</span>(wards, <span class="at">cell_size =</span> <span class="dv">100</span>)</span>
<span id="cb17-6"><a href="#cb17-6"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="fu">st_intersection</span>(wards)</span>
<span id="cb17-8"><a href="#cb17-8"></a></span>
<span id="cb17-9"><a href="#cb17-9"></a>burglary_risk_filtered <span class="ot">&lt;-</span> <span class="fu">filter</span>(burglary_risk, <span class="fu">is.finite</span>(kde))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You might wonder why we didn’t simply add <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to the existing pipeline that creates the <code>burglary_risk</code> object. It is because we will need the unfiltered object in the next section. But for now …</p>
<p>We can plot the estimate of the density of burglary risk. By controlling for the density of buildings, this map shows us where building owners <em>on average</em> face the highest risk of being burgled. This might be useful in working out, for example, which building owners should be offered visits from a crime-prevention advisor or funding to install crime-prevention measures.</p>
<div class="cell" data-layout-align="center" data-exercise="true" data-exercise.lines="36">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="co"># Add burglary risk layer</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb18-5"><a href="#cb18-5"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb18-6"><a href="#cb18-6"></a>    <span class="at">data =</span> burglary_risk_filtered, </span>
<span id="cb18-7"><a href="#cb18-7"></a>    <span class="at">alpha =</span> <span class="fl">0.8</span>, </span>
<span id="cb18-8"><a href="#cb18-8"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb18-9"><a href="#cb18-9"></a>  ) <span class="sc">+</span></span>
<span id="cb18-10"><a href="#cb18-10"></a>  <span class="co"># Add ward boundaries</span></span>
<span id="cb18-11"><a href="#cb18-11"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wards, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span> </span>
<span id="cb18-12"><a href="#cb18-12"></a>  <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb18-13"><a href="#cb18-13"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(burglary_risk_filtered, <span class="st">"kde"</span>)),</span>
<span id="cb18-14"><a href="#cb18-14"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>),</span>
<span id="cb18-15"><a href="#cb18-15"></a>    <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb18-16"><a href="#cb18-16"></a>  ) <span class="sc">+</span></span>
<span id="cb18-17"><a href="#cb18-17"></a>  <span class="fu">labs</span>(</span>
<span id="cb18-18"><a href="#cb18-18"></a>      <span class="at">title =</span> <span class="st">"Burglary risk in south-west Nottingham"</span>,</span>
<span id="cb18-19"><a href="#cb18-19"></a>      <span class="at">subtitle =</span> <span class="fu">str_glue</span>(</span>
<span id="cb18-20"><a href="#cb18-20"></a>        <span class="st">"dual kernel density of burglary risk in Castle, Lenton &amp; Wollaton "</span>,</span>
<span id="cb18-21"><a href="#cb18-21"></a>        <span class="st">"East and Meadows wards"</span></span>
<span id="cb18-22"><a href="#cb18-22"></a>      ),</span>
<span id="cb18-23"><a href="#cb18-23"></a>      <span class="at">caption =</span> <span class="fu">str_glue</span>(</span>
<span id="cb18-24"><a href="#cb18-24"></a>        <span class="st">"Contains public sector information licensed under the Open "</span>,</span>
<span id="cb18-25"><a href="#cb18-25"></a>        <span class="st">"Government Licence v3.0"</span></span>
<span id="cb18-26"><a href="#cb18-26"></a>      ),</span>
<span id="cb18-27"><a href="#cb18-27"></a>      <span class="at">fill =</span> <span class="st">"density of burglary risk, 2020"</span></span>
<span id="cb18-28"><a href="#cb18-28"></a>  ) <span class="sc">+</span></span>
<span id="cb18-29"><a href="#cb18-29"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb18-30"><a href="#cb18-30"></a>  <span class="fu">theme</span>(</span>
<span id="cb18-31"><a href="#cb18-31"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb18-32"><a href="#cb18-32"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey40"</span>),</span>
<span id="cb18-33"><a href="#cb18-33"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">6</span>, <span class="at">b =</span> <span class="dv">6</span>)),</span>
<span id="cb18-34"><a href="#cb18-34"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey50"</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>)</span>
<span id="cb18-35"><a href="#cb18-35"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/risk-exercise6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="check-your-understanding-1" class="level3 tutorial" data-number="11.2.3"><h3 class="tutorial anchored" data-number="11.2.3" data-anchor-id="check-your-understanding-1">
<span class="header-section-number">11.2.3</span> Check your understanding</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">quiz</span>(</span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="at">caption =</span> <span class="st">""</span>,</span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="fu">question</span>(<span class="st">"Which *one* of these statements is true?"</span>,</span>
<span id="cb19-5"><a href="#cb19-5"></a>    <span class="fu">answer</span>(<span class="st">"`hotspot_dual_kde()` requires co-ordinates to use a projected co-ordinate system (i.e. not longitude and latitude)."</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-6"><a href="#cb19-6"></a>    <span class="fu">answer</span>(<span class="st">"`hotspot_dual_kde()` can work on any co-ordinates, whether they use a geographic co-ordinate system (i.e. longitude and latitude) or a projected system."</span>),</span>
<span id="cb19-7"><a href="#cb19-7"></a>    <span class="fu">answer</span>(<span class="st">"`hotspot_dual_kde()` requires co-ordinates to use a geographic co-ordinate system (i.e. longitude and latitude)."</span>),</span>
<span id="cb19-8"><a href="#cb19-8"></a>    <span class="fu">answer</span>(<span class="st">"`hotspot_dual_kde()` does not work with co-ordinates, so it does not matter which type of co-ordinate system a dataset uses."</span>),</span>
<span id="cb19-9"><a href="#cb19-9"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-10"><a href="#cb19-10"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb19-11"><a href="#cb19-11"></a>  ),</span>
<span id="cb19-12"><a href="#cb19-12"></a>  </span>
<span id="cb19-13"><a href="#cb19-13"></a>  <span class="fu">question</span>(</span>
<span id="cb19-14"><a href="#cb19-14"></a>    <span class="st">"Why do we usually clip the result of `hotspot_dual_kde()` using `st_intersection()`?"</span>,</span>
<span id="cb19-15"><a href="#cb19-15"></a>    <span class="fu">answer</span>(<span class="st">"To eliminate any areas that we do not have data for, since displaying KDE values for such areas on a map might be misleading."</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-16"><a href="#cb19-16"></a>    <span class="fu">answer</span>(<span class="st">"To make our maps look nicer."</span>),</span>
<span id="cb19-17"><a href="#cb19-17"></a>    <span class="fu">answer</span>(<span class="st">"To transform the co-ordinate system our data uses from the system `hotspot_dual_kde()` uses to the one we need to produce a map."</span>),</span>
<span id="cb19-18"><a href="#cb19-18"></a>    <span class="fu">answer</span>(<span class="st">"To make it easier to see the other layers on our map."</span>),</span>
<span id="cb19-19"><a href="#cb19-19"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-20"><a href="#cb19-20"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb19-21"><a href="#cb19-21"></a>  )</span>
<span id="cb19-22"><a href="#cb19-22"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="finding-hotspots" class="level2" data-number="11.3"><h2 data-number="11.3" class="anchored" data-anchor-id="finding-hotspots">
<span class="header-section-number">11.3</span> Finding hotspots</h2>
<p>We now know how to produce a better map of the density of crime in different areas. But how do we know which areas count as hotspots and which don’t?</p>
<p>There are several ways to answer this question. If we were planning a particular activity to respond to a crime problem, we might know what resources we had available to respond. For example, we might know that we have enough funding to provide crime-prevention visits to 100 locations. In that case, we can order the cells in a KDE object according to which have the highest estimates of risk, then count all the premises in each cell until we have reached our limit.</p>
<p>To do this, we need to know how many buildings are in each grid cell. We have already learned how to count crimes in areas when we learned about mapping area data. When we want to count crimes in each cell in a grid, we can use the <code>hotspot_count()</code> function from the <code>sfhotspot</code> package to count the number of buildings in each grid cell. We will then be able to combine those building counts to the estimates of burglary risk we have already calculated.</p>
<div class="box notewell">
<p>So that we can join the building counts to the burglary risk estimates, it is important that both layers are based on the same grid. In the code above we created a grid with the code <code>hotspot_grid(wards, cell_size = 100)</code>, so to make sure we use the same grid to count buildings we can either use that same code again, or we could have saved the result of that code as an object (maybe called <code>nottingham_wards_grid</code>) and then provided that object to the <code>grid</code> argument of both <code>hotspot_dual_kde()</code> and <code>hotspot_count()</code>.</p>
<p>Note that the results of <code>hotspot_dual_kde()</code> and <code>hotspot_count()</code> will only have the same structure before we wrangle then any further, for example by using <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> as in the previous section. This is why we saved an unfiltered version of the dataset in the <code>burglary_risk</code> object.</p>
</div>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>building_counts <span class="ot">&lt;-</span> <span class="fu">hotspot_count</span>(</span>
<span id="cb20-2"><a href="#cb20-2"></a>  nottingham_building_centroids, </span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="at">grid =</span> <span class="fu">hotspot_grid</span>(wards, <span class="at">cell_size =</span> <span class="dv">100</span>)</span>
<span id="cb20-4"><a href="#cb20-4"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="co"># Clip the result to the area for which we have data</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>  <span class="fu">st_intersection</span>(wards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">head</span>(building_counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 455826.6 ymin: 338782.9 xmax: 456354.2 ymax: 338909
Projected CRS: OSGB36 / British National Grid
# A tibble: 6 × 4
      n ward_code ward_name                                             geometry
  &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;                                            &lt;POLYGON [m]&gt;
1     0 E05012277 Castle    ((456061.5 338809, 456061.5 338799.8, 456006.6 3388…
2     0 E05012277 Castle    ((456061.5 338809, 456161.5 338809, 456161.5 338790…
3     1 E05012277 Castle    ((456161.5 338809, 456261.5 338809, 456261.5 338786…
4     1 E05012277 Castle    ((456261.5 338809, 456354.2 338809, 456261.5 338786…
5     2 E05012277 Castle    ((455861.5 338909, 455861.5 338888.8, 455826.6 3389…
6     4 E05012277 Castle    ((455861.5 338909, 455961.5 338909, 455961.5 338830…</code></pre>
</div>
</div>
<p>The <code>building_counts</code> and <code>burglary_risk</code> objects have the same structure: each row represents a cell in the same grid, and the rows are in the same order (because both grids were created by identical calls to <code>hotspot_grid()</code>). This means we can combine the two objects using the <code>bind_cols()</code> function from the <code>dplyr</code> package (part of the tidyverse).</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>burglary_risk_bldg <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(burglary_risk, building_counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `n` -&gt; `n...1`
• `ward_code` -&gt; `ward_code...3`
• `ward_name` -&gt; `ward_name...4`
• `geometry` -&gt; `geometry...5`
• `n` -&gt; `n...6`
• `ward_code` -&gt; `ward_code...7`
• `ward_name` -&gt; `ward_name...8`
• `geometry` -&gt; `geometry...9`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">head</span>(burglary_risk_bldg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  n...1    kde ward_code...3 ward_name...4                    geometry...5 n...6
  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;                           &lt;POLYGON [m]&gt; &lt;dbl&gt;
1     0 0.0175 E05012277     Castle        ((456061.5 338809, 456061.5 33…     0
2     0 0.0172 E05012277     Castle        ((456061.5 338809, 456161.5 33…     0
3     0 0.0222 E05012277     Castle        ((456161.5 338809, 456261.5 33…     1
4     0 0.0271 E05012277     Castle        ((456261.5 338809, 456354.2 33…     1
5     0 0.0204 E05012277     Castle        ((455861.5 338909, 455861.5 33…     2
6     0 0.0264 E05012277     Castle        ((455861.5 338909, 455961.5 33…     4
# ℹ 3 more variables: ward_code...7 &lt;chr&gt;, ward_name...8 &lt;chr&gt;,
#   geometry...9 &lt;POLYGON [m]&gt;</code></pre>
</div>
</div>
<p>Looking at this object, we can see that <code>bind_cols()</code> has changed the column names. This is because some of the column names were duplicated across the two datasets. Some of these new column names, such as <code>ward_code...3</code> would be difficult to work with, so lets go back and remove duplicate columns before we combine the two datasets together.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>burglary_risk_bldg <span class="ot">&lt;-</span> burglary_risk <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2"></a>  <span class="co"># Keep only the `n` and `kde` columns, renaming `n` to `burglary_count`</span></span>
<span id="cb28-3"><a href="#cb28-3"></a>  <span class="co"># because there is also a column called `n` in the `building_counts` object</span></span>
<span id="cb28-4"><a href="#cb28-4"></a>  <span class="fu">select</span>(<span class="at">burglary_count =</span> n, kde) <span class="sc">|&gt;</span> </span>
<span id="cb28-5"><a href="#cb28-5"></a>  <span class="co"># Remove the geometry column (since an identical one exists in </span></span>
<span id="cb28-6"><a href="#cb28-6"></a>  <span class="co"># `building_counts`). Note that we do this separately because we can't use</span></span>
<span id="cb28-7"><a href="#cb28-7"></a>  <span class="co"># `select()` to remove the `geometry` column.</span></span>
<span id="cb28-8"><a href="#cb28-8"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-9"><a href="#cb28-9"></a>  <span class="fu">bind_cols</span>(building_counts) <span class="sc">|&gt;</span> </span>
<span id="cb28-10"><a href="#cb28-10"></a>  <span class="co"># After calling `bind_cols()` it is safe to use `filter()` to wrangle the</span></span>
<span id="cb28-11"><a href="#cb28-11"></a>  <span class="co"># data</span></span>
<span id="cb28-12"><a href="#cb28-12"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(kde))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now order the dataset with the cells with highest burglary risk at the top and calculate the <em>cumulative total</em> (also called a running total) of buildings using the <code><a href="https://rdrr.io/r/base/cumsum.html">cumsum()</a></code> function. We can use this running total to find the 100 buildings in the cells with highest burglary risk.</p>
<p>We could now plot the <code>cells_for_prevention</code> object on a map to show the grid cells containing the buildings that would receive the crime-prevention visits. We could also use <code>st_join()</code> to join those cells to the dataset of buildings in the <code>nottingham_building_centroids</code> object, which would give us a list of buildings to visit.</p>
<section id="distinguishing-hotspots-from-random-variation" class="level3" data-number="11.3.1"><h3 data-number="11.3.1" class="anchored" data-anchor-id="distinguishing-hotspots-from-random-variation">
<span class="header-section-number">11.3.1</span> Distinguishing hotspots from random variation</h3>
<p>The density maps below show density estimates based on 1,000 points placed completely at random on 16 different maps. There are no real patterns in the data except for statistical noise. Nevertheless, the KDE process makes it appear that there are patterns in the data (if you reload this tutorial, these maps will change appearance completely, since the random numbers used for the x and y co-ordinates of the points will be regenerated).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">tibble</span>(</span>
<span id="cb29-2"><a href="#cb29-2"></a>  <span class="at">x =</span> <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1000</span> <span class="sc">*</span> <span class="dv">16</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">100</span>), </span>
<span id="cb29-3"><a href="#cb29-3"></a>  <span class="at">y =</span> <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1000</span> <span class="sc">*</span> <span class="dv">16</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">100</span>),</span>
<span id="cb29-4"><a href="#cb29-4"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>, <span class="at">each =</span> <span class="dv">1000</span>)</span>
<span id="cb29-5"><a href="#cb29-5"></a>)  <span class="sc">|&gt;</span>  </span>
<span id="cb29-6"><a href="#cb29-6"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb29-7"><a href="#cb29-7"></a>  <span class="fu">geom_density_2d_filled</span>(<span class="fu">aes</span>(x, y), <span class="at">bins =</span> <span class="dv">9</span>) <span class="sc">+</span> </span>
<span id="cb29-8"><a href="#cb29-8"></a>  <span class="fu">scale_fill_brewer</span>(</span>
<span id="cb29-9"><a href="#cb29-9"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="fu">rep</span>(<span class="st">""</span>, <span class="dv">7</span>), <span class="st">"higher"</span>),</span>
<span id="cb29-10"><a href="#cb29-10"></a>    <span class="at">palette =</span> <span class="st">"Oranges"</span>, </span>
<span id="cb29-11"><a href="#cb29-11"></a>    <span class="at">direction =</span> <span class="dv">1</span>,</span>
<span id="cb29-12"><a href="#cb29-12"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-13"><a href="#cb29-13"></a>  ) <span class="sc">+</span></span>
<span id="cb29-14"><a href="#cb29-14"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(group), <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb29-15"><a href="#cb29-15"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb29-16"><a href="#cb29-16"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"density"</span>) <span class="sc">+</span></span>
<span id="cb29-17"><a href="#cb29-17"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb29-18"><a href="#cb29-18"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/random-map-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is a problem because we might end up responding to an apparent problem that is nothing but an artefact of the random variation that we expect to see in many processes, including crime.</p>
<p>If the police and other agencies looked at these patterns and did nothing in response to them, it is likely that over time some of the areas with high density would become areas of low density, and <em>vice versa</em>. However, the harm caused by crime means it is very hard for agencies to justify sitting back and do nothing to respond to it – many people would consider it immoral to do so. So police and other agencies are very likely to try to respond to crime patterns, even if those patterns might have occurred by chance. This is very frustrating, because if we were to go back and look at the same data in a few months time it is very likely that the apparent hotspots would have shifted to somewhere different, making all the effort spent in responding to crime seem worthless (which, if the apparent patterns were actually artefacts of the KDE process, it may have been).</p>
<p>You might be thinking it’s better safe than sorry, and that police should respond to the apparent patterns just in case they represent real concentrations in crime. But police resources are always scarce, so responding to one problem in one place means not responding to another problem in another place. This is known as the <em>opportunity cost</em> of acting: if police focus their limited resources in one area, that comes at the cost of not being able to deploy those resources in other areas that might need it more.</p>
<p>We can try to avoid this problem of wasting resources responding to random variation in crime by determining whether the number of crimes in an area is more than the greatest number we would reasonably expect if there were no actual patterns in the data (if you have studied statistics before, you might recognise this as a description of a <em>null hypothesis</em>, but you don’t need to have studied statistics to apply the techniques in this course).</p>
<p>To determine if the number of crimes in each area is greater than we would expect by chance, we can use the <em>Getis-Ord Gi* statistic</em> (also called the <em>local G</em> statistic, spoken out-loud as the <em>G-I star statistic</em>). If the Gi* statistic for an area is greater than a certain value, we can say that the number of crimes in that area is higher than we would expect if there were no patterns in the data. We will call areas with more crimes than we would expect by chance as <em>hotspots</em>.</p>
<p>To see how this is done, watch this video that walks through the code needed to make a hotspot map using the Gi* statistic.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/VhVBfvfp8OY" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>We can calculate the Gi* statistic using the <code>hotspot_gistar()</code> function from the <code>sfhotspot</code> package. This works in a similar way to the <code>hotspot_kde()</code> function, in that it takes an SF object of the locations of crimes and returns an SF object with a grid of cells, along with the Gi* value for each grid cell. Like <code>hotspot_kde()</code>, <code>hotspot_gistar()</code> will choose default values for several ways in which we could fine-tune the calculation of the Gi* statistic, but we could over-ride these defaults if we wanted to.</p>
<p>In this example, we will find the hotspots of robbery in Nottingham in 2020, based on a grid of 100-metre cells. We will store this in an object called <code>robbery</code>, transform it to use the British National Grid co-ordinate system (so we can specify the cell size in metres) and then use the resulting object to calculate the Gi* values.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>robbery <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb30-3"><a href="#cb30-3"></a>  <span class="fu">st_transform</span>(<span class="dv">27700</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 555 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): location, lsoa_code
dbl  (2): longitude, latitude
date (1): month

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>robbery_gistar <span class="ot">&lt;-</span> <span class="fu">hotspot_gistar</span>(robbery, <span class="at">cell_size =</span> <span class="dv">100</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-2"><a href="#cb32-2"></a></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="co"># Use the `sample_n()` function from the `dplyr` package to return a random</span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="co"># sample of 10 rows from the result</span></span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="fu">sample_n</span>(robbery_gistar, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 10 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 451967.5 ymin: 337474.1 xmax: 456167.5 ymax: 346874.1
Projected CRS: OSGB36 / British National Grid
# A tibble: 10 × 5
       n    kde gistar pvalue                                           geometry
 * &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;                                      &lt;POLYGON [m]&gt;
 1     0 20.0   -0.498  0.618 ((453467.5 343674.1, 453467.5 343774.1, 453567.5 …
 2     0 14.0   -0.498  0.618 ((452067.5 340974.1, 452067.5 341074.1, 452167.5 …
 3     0  7.06  -0.498  0.618 ((455967.5 337574.1, 455967.5 337674.1, 456067.5 …
 4     1 14.9    0.331  0.741 ((456067.5 344074.1, 456067.5 344174.1, 456167.5 …
 5     0  8.66  -0.498  0.618 ((453367.5 341074.1, 453367.5 341174.1, 453467.5 …
 6     0  0.747 -0.439  0.661 ((451967.5 337474.1, 451967.5 337574.1, 452067.5 …
 7     0 21.6   -0.498  0.618 ((455667.5 338874.1, 455667.5 338974.1, 455767.5 …
 8     0  6.34   0.410  0.682 ((454167.5 346774.1, 454167.5 346874.1, 454267.5 …
 9     0  4.64  -0.498  0.618 ((453067.5 340374.1, 453067.5 340474.1, 453167.5 …
10     0 11.4   -0.498  0.618 ((455067.5 346274.1, 455067.5 346374.1, 455167.5 …</code></pre>
</div>
</div>
<p>The <code>robbery_gistar</code> object contains one row for each cell in a grid of cells covering the area of the robbery data. Each row has four columns:</p>
<ul>
<li>
<code>n</code> shows the number of robberies that occurred in that grid cell,</li>
<li>
<code>kde</code> shows the density of robberies in that cell,</li>
<li>
<code>gistar</code> shows the Gi* value for that cell, and</li>
<li>
<code>pvalue</code> shows the <span class="math inline">\(p\)</span>-value for that cell.</li>
</ul>
<p>The Gi* statistic is an example of a more general group of statistics called <span class="math inline">\(Z\)</span> <em>scores</em>. Statisticians and data analysts compare the <span class="math inline">\(Z\)</span> scores produced by statistical procedures such as <code>hotspot_gistar()</code> to reference values to decide if a <span class="math inline">\(Z\)</span> score is large enough to be treated as statistically significant, i.e.&nbsp; if it is large enough to conclude that it is larger than we would expect if there were no actual patterns in the data. Deciding on the right reference value to compare a <span class="math inline">\(Z\)</span> score to can be difficult because of what’s known as the multiple comparison problem (which we don’t need to go into detail about). Fortunately, the values in the <code>pvalue</code> column have already been automatically adjusted to take account of the multiple comparison problem, so we can interpret the <span class="math inline">\(p\)</span>-values instead of interpreting the Gi* statistic directly.</p>
<div class="box notewell">
<p>Since Gi* is a relative measure, if you have data for a large area (e.g.&nbsp;a country) but only want to show data for a smaller area (e.g.&nbsp;a city), the Gi* values will be influenced by the large areas with no crime and all of the city is likely to be identified as a hotspot. To prevent this, it is important to clip the dataset before calculating the Gi* values, as well as then clipping afterwards where necessary.</p>
</div>
<p>By convention, <span class="math inline">\(p\)</span>-values are considered to be significant if they are <em>less than 0.05</em>. So if <span class="math inline">\(p&lt;0.05\)</span>, we can say that the number of robberies occurring in a given grid cell is significantly different from zero. Values of Gi* greater than zero indicate cells with more robberies than expected and values of Gi* less than zero indicate cells with fewer robberies than expected. We can combine these two values to find cells with significantly <em>more</em> robberies than expected by chance, which are those cells for which <span class="math inline">\(Z&gt;0\)</span> and <span class="math inline">\(p&lt;0.05\)</span>. To put that into R code, we would write <code>gistar &gt; 0</code> and <code>p &lt; 0.05</code>.</p>
<p>We could use this information in various ways. For example, if we wanted to give local police officers a printed map of which areas to patrol, we could simply show the significant hotspot cells over a base map.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="co"># Plot a map</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb34-5"><a href="#cb34-5"></a>    <span class="at">data =</span> <span class="fu">filter</span>(robbery_gistar, gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>), </span>
<span id="cb34-6"><a href="#cb34-6"></a>    <span class="at">fill =</span> <span class="st">"red"</span>, </span>
<span id="cb34-7"><a href="#cb34-7"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>,</span>
<span id="cb34-8"><a href="#cb34-8"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb34-9"><a href="#cb34-9"></a>  ) <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb34-11"><a href="#cb34-11"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/hotspot-exercise4-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Since <code>hotspot_gistar()</code> also estimates density for each grid cell, we could more usefully show the density of robberies in each cell, but only for cells that the Gi* values showed were significant hotspots.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb35-4"><a href="#cb35-4"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde),</span>
<span id="cb35-5"><a href="#cb35-5"></a>    <span class="at">data =</span> <span class="fu">filter</span>(robbery_gistar, gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>), </span>
<span id="cb35-6"><a href="#cb35-6"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>,</span>
<span id="cb35-7"><a href="#cb35-7"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb35-8"><a href="#cb35-8"></a>  ) <span class="sc">+</span></span>
<span id="cb35-9"><a href="#cb35-9"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb35-10"><a href="#cb35-10"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb35-11"><a href="#cb35-11"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/hotspot-exercise5-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>This map could be very useful for police officers deciding where to conduct anti-robbery patrols, because it not only shows the areas with the highest density of robberies but only shows those areas if there are more robberies than we would expect by chance. This makes it more likely that officers won’t waste time chasing apparent patterns that are actually the result of random variation.</p>
</section><section id="check-your-understanding-2" class="level3 tutorial" data-number="11.3.2"><h3 class="tutorial anchored" data-number="11.3.2" data-anchor-id="check-your-understanding-2">
<span class="header-section-number">11.3.2</span> Check your understanding</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">quiz</span>(</span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="at">caption =</span> <span class="st">""</span>,</span>
<span id="cb36-3"><a href="#cb36-3"></a></span>
<span id="cb36-4"><a href="#cb36-4"></a>  <span class="fu">question</span>(<span class="st">"`robbery_gi` is an object storing a result produced by the `hotspot_gistar()` function. Which of these pieces of code could be used to extract _only_ those rows in the data with significant p-values?"</span>,</span>
<span id="cb36-5"><a href="#cb36-5"></a>    <span class="fu">answer</span>(<span class="st">"`filter(robbery_gi, pvalue &lt; 0.05)`"</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb36-6"><a href="#cb36-6"></a>    <span class="fu">answer</span>(</span>
<span id="cb36-7"><a href="#cb36-7"></a>      <span class="st">"`filter(robbery_gi, pvalue &gt; 0.05)`"</span>,</span>
<span id="cb36-8"><a href="#cb36-8"></a>      <span class="at">message =</span> <span class="st">"That code would extract only _non-significant_ p-values. Try again!"</span></span>
<span id="cb36-9"><a href="#cb36-9"></a>    ),</span>
<span id="cb36-10"><a href="#cb36-10"></a>    <span class="fu">answer</span>(</span>
<span id="cb36-11"><a href="#cb36-11"></a>      <span class="st">"`filter(robbery_gi, pvalue &lt;= 0.05)`"</span>,</span>
<span id="cb36-12"><a href="#cb36-12"></a>      <span class="at">message =</span> <span class="st">"Almost right, but not quite. Try re-reading the section of the tutorial above."</span></span>
<span id="cb36-13"><a href="#cb36-13"></a>    ),</span>
<span id="cb36-14"><a href="#cb36-14"></a>    <span class="fu">answer</span>(</span>
<span id="cb36-15"><a href="#cb36-15"></a>      <span class="st">"`filter(robbery_gi, pvalue == 0.05)`"</span>,</span>
<span id="cb36-16"><a href="#cb36-16"></a>      <span class="at">message =</span> <span class="st">"That's not right. Try re-reading the section of the tutorial above."</span></span>
<span id="cb36-17"><a href="#cb36-17"></a>    ),</span>
<span id="cb36-18"><a href="#cb36-18"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb36-19"><a href="#cb36-19"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb36-20"><a href="#cb36-20"></a>  ),</span>
<span id="cb36-21"><a href="#cb36-21"></a>  </span>
<span id="cb36-22"><a href="#cb36-22"></a>  <span class="fu">question</span>(<span class="st">"Which *one* of these statements is true about an SF object called `robberies_in_nottingham`?"</span>,</span>
<span id="cb36-23"><a href="#cb36-23"></a>    <span class="fu">answer</span>(<span class="st">"We cannot remove the `geometry` column of an SF object with `select()`, so we must use `st_drop_geometry()` instead."</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb36-24"><a href="#cb36-24"></a>    <span class="fu">answer</span>(<span class="st">"We can remove the `geometry` column with the code `select(robberies_in_nottingham, -geometry)`."</span>),</span>
<span id="cb36-25"><a href="#cb36-25"></a>    <span class="fu">answer</span>(<span class="st">"We can remove the `geometry` column with the code `filter(robberies_in_nottingham, -geometry)`."</span>),</span>
<span id="cb36-26"><a href="#cb36-26"></a>    <span class="fu">answer</span>(<span class="st">"There is no way to remove the `geometry` column from an SF object."</span>),</span>
<span id="cb36-27"><a href="#cb36-27"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb36-28"><a href="#cb36-28"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb36-29"><a href="#cb36-29"></a>  )</span>
<span id="cb36-30"><a href="#cb36-30"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="putting-it-all-together" class="level2" data-number="11.4"><h2 data-number="11.4" class="anchored" data-anchor-id="putting-it-all-together">
<span class="header-section-number">11.4</span> Putting it all together</h2>
<div class="box welldone">
<p>In this tutorial we have learned about hotspots, how to create dual KDE maps and how to find significant hotspots using the Gi* statistic. We can put this all together to create a complete script for producing a map of robbery hotspots in Nottingham</p>
</div>
<p>The following code is all that is needed to produce this map. Read through the comments accompanying the code to see how what we have learned in this tutorial fits together, then run the code to produce the map.</p>
<div class="box notewell">
<p>It is possible that this code will not run in this tutorial window because of limits on how long code can run in an R tutorial. If that happens, paste the code below into a blank R script in RStudio and run it from there to see the map.</p>
</div>
<div class="cell" data-exercise="true" data-exercise.lines="66">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># Prepare ----------------------------------------------------------------------</span></span>
<span id="cb37-2"><a href="#cb37-2"></a></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="co"># Load packages</span></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="fu">library</span>(sf)</span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="fu">library</span>(sfhotspot)</span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb37-8"><a href="#cb37-8"></a></span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="co"># Load data and transform to British National Grid, which is easier to work with</span></span>
<span id="cb37-10"><a href="#cb37-10"></a><span class="co"># for functions that use spatial units such as metres</span></span>
<span id="cb37-11"><a href="#cb37-11"></a>robbery <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_robbery.csv.gz"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-12"><a href="#cb37-12"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-13"><a href="#cb37-13"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb37-14"><a href="#cb37-14"></a>nottingham_wards <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/nottingham_wards.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-15"><a href="#cb37-15"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:27700"</span>)</span>
<span id="cb37-16"><a href="#cb37-16"></a></span>
<span id="cb37-17"><a href="#cb37-17"></a></span>
<span id="cb37-18"><a href="#cb37-18"></a><span class="co"># Find significant grid cells --------------------------------------------------</span></span>
<span id="cb37-19"><a href="#cb37-19"></a></span>
<span id="cb37-20"><a href="#cb37-20"></a><span class="co"># Calculate Gi* statistic, filter for only significant hotspot cells and clip to</span></span>
<span id="cb37-21"><a href="#cb37-21"></a><span class="co"># the city boundary</span></span>
<span id="cb37-22"><a href="#cb37-22"></a>robbery_gi <span class="ot">&lt;-</span> robbery <span class="sc">|&gt;</span> </span>
<span id="cb37-23"><a href="#cb37-23"></a>  <span class="fu">hotspot_gistar</span>(<span class="at">cell_size =</span> <span class="dv">100</span>, <span class="at">bandwidth_adjust =</span> <span class="fl">0.25</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-24"><a href="#cb37-24"></a>  <span class="fu">filter</span>(gistar <span class="sc">&gt;</span> <span class="dv">0</span>, pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-25"><a href="#cb37-25"></a>  <span class="fu">st_intersection</span>(nottingham_wards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="co"># Plot map ---------------------------------------------------------------------</span></span>
<span id="cb39-2"><a href="#cb39-2"></a></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb39-4"><a href="#cb39-4"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>  <span class="co"># Add density for significant cells</span></span>
<span id="cb39-6"><a href="#cb39-6"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb39-7"><a href="#cb39-7"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb39-8"><a href="#cb39-8"></a>    <span class="at">data =</span> robbery_gi, </span>
<span id="cb39-9"><a href="#cb39-9"></a>    <span class="at">alpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb39-10"><a href="#cb39-10"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb39-11"><a href="#cb39-11"></a>  ) <span class="sc">+</span></span>
<span id="cb39-12"><a href="#cb39-12"></a>  <span class="co"># Add ward boundaries</span></span>
<span id="cb39-13"><a href="#cb39-13"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> nottingham_wards, <span class="at">colour =</span> <span class="st">"grey70"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb39-14"><a href="#cb39-14"></a>  <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb39-15"><a href="#cb39-15"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(robbery_gi, kde)),</span>
<span id="cb39-16"><a href="#cb39-16"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>),</span>
<span id="cb39-17"><a href="#cb39-17"></a>    <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb39-18"><a href="#cb39-18"></a>  ) <span class="sc">+</span></span>
<span id="cb39-19"><a href="#cb39-19"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb39-20"><a href="#cb39-20"></a>  <span class="fu">labs</span>(</span>
<span id="cb39-21"><a href="#cb39-21"></a>      <span class="at">title =</span> <span class="st">"Nottingham robbery hotspots"</span>,</span>
<span id="cb39-22"><a href="#cb39-22"></a>      <span class="at">subtitle =</span> <span class="fu">str_glue</span>(</span>
<span id="cb39-23"><a href="#cb39-23"></a>        <span class="st">"density of robbery in places with more violence than expected by "</span>,</span>
<span id="cb39-24"><a href="#cb39-24"></a>        <span class="st">"chance"</span></span>
<span id="cb39-25"><a href="#cb39-25"></a>      ),</span>
<span id="cb39-26"><a href="#cb39-26"></a>      <span class="co"># Don't forget to add the licence statement -- it's a legal requirement!</span></span>
<span id="cb39-27"><a href="#cb39-27"></a>      <span class="at">caption =</span> <span class="fu">str_glue</span>(</span>
<span id="cb39-28"><a href="#cb39-28"></a>        <span class="st">"Contains public sector information licensed under the Open "</span>,</span>
<span id="cb39-29"><a href="#cb39-29"></a>        <span class="st">"Government Licence v3.0. Map data from OpenStreetMap."</span></span>
<span id="cb39-30"><a href="#cb39-30"></a>      ),</span>
<span id="cb39-31"><a href="#cb39-31"></a>      <span class="at">fill =</span> <span class="fu">str_wrap</span>(<span class="st">"density of robbery at significant hotspots, 2022"</span>, <span class="dv">15</span>)</span>
<span id="cb39-32"><a href="#cb39-32"></a>  ) <span class="sc">+</span></span>
<span id="cb39-33"><a href="#cb39-33"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb39-34"><a href="#cb39-34"></a>  <span class="fu">theme</span>(</span>
<span id="cb39-35"><a href="#cb39-35"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey40"</span>, <span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb39-36"><a href="#cb39-36"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">6</span>, <span class="at">b =</span> <span class="dv">6</span>)),</span>
<span id="cb39-37"><a href="#cb39-37"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">colour =</span> <span class="st">"grey50"</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>)</span>
<span id="cb39-38"><a href="#cb39-38"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/final-exercise1-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../10_place_data/index.html" class="pagination-link" aria-label="Crime Mapping: Using data about places">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Crime Mapping: Using data about places</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../12_messy_data/index.html" class="pagination-link" aria-label="Handling messy data">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
<li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by/4.0/">
<p>This book is available under a Creative Commons Attribution 4.0 International licence</p>
</a>
  </li>  
</ul>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>