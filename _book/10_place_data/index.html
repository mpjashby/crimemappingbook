<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>10&nbsp; Using data about places – Learn Crime Mapping with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../11_mapping_hotspots/index.html" rel="next">
<link href="../09_mapping_areas/index.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<!-- START OF INCLUDED HEADER -->

<!--
This file contains code that will be included in the header of each page of the
quarto book
-->

<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>

<!-- END OF INCLUDED HEADER -->


<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../include/webex.css">
<meta name="twitter:title" content="10&nbsp; Using data about places – Learn Crime Mapping with R">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="../images/cover_image.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../10_place_data/index.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/cover_image.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Learn Crime Mapping with R</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/mpjashby/crimemappingbook/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../learn_crime_mapping_with_r.epub" title="Download ePub" class="quarto-navigation-tool px-1" aria-label="Download ePub"><i class="bi bi-journal"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install the software needed for this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_getting_started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_your_first_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Your first crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_data_wrangling/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_your_second_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Your second crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_code_with_style/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Code with style</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_mapping_crime_patterns/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping crime patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_map_context/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Giving a map context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_handling_bugs/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Handling bugs in your code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_mapping_areas/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Mapping area data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../10_place_data/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../11_mapping_hotspots/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../12_messy_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../13_crime_series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Mapping crime series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../14_writing_reports/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Writing reports in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../15_no_maps/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Presenting spatial data without maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../16_mapping_time/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Mapping crime over time</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/read_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Functions for reading data into R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/map_checklist.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Checklist: Making a good crime map</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/common_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Common R errors and how to fix them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/functions_to_avoid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Some R functions you should avoid</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/handling_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Checklist: handling code errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">In this chapter</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">10.1</span> Introduction</a></li>
  <li><a href="#loading-csv-data" id="toc-loading-csv-data" class="nav-link" data-scroll-target="#loading-csv-data"><span class="header-section-number">10.2</span> Loading CSV data</a>
  <ul class="collapse">
  <li><a href="#check-your-understanding" id="toc-check-your-understanding" class="nav-link" data-scroll-target="#check-your-understanding"><span class="header-section-number">10.2.1</span> Check your understanding</a></li>
  </ul></li>
  <li><a href="#finding-data" id="toc-finding-data" class="nav-link" data-scroll-target="#finding-data"><span class="header-section-number">10.3</span> Finding data</a>
  <ul class="collapse">
  <li><a href="#open-data" id="toc-open-data" class="nav-link" data-scroll-target="#open-data"><span class="header-section-number">10.3.1</span> Open data</a></li>
  <li><a href="#citing-data" id="toc-citing-data" class="nav-link" data-scroll-target="#citing-data"><span class="header-section-number">10.3.2</span> Citing data</a></li>
  <li><a href="#check-your-understanding-1" id="toc-check-your-understanding-1" class="nav-link" data-scroll-target="#check-your-understanding-1"><span class="header-section-number">10.3.3</span> Check your understanding</a></li>
  </ul></li>
  <li><a href="#shapefiles" id="toc-shapefiles" class="nav-link" data-scroll-target="#shapefiles"><span class="header-section-number">10.4</span> Shapefiles</a></li>
  <li><a href="#data-from-openstreetmap" id="toc-data-from-openstreetmap" class="nav-link" data-scroll-target="#data-from-openstreetmap"><span class="header-section-number">10.5</span> Data from OpenStreetMap</a></li>
  <li><a href="#in-summary" id="toc-in-summary" class="nav-link" data-scroll-target="#in-summary"><span class="header-section-number">10.6</span> In summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-place-data" class="quarto-section-identifier"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Learn how to find and use extra data about places to improve your maps, including open data and data from OpenStreetMap</strong></p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>This chapter has not yet been updated for 2025, so some material is out of date. Check back for an update in mid-February 2025.</p>
</div>
</div>
<section id="introduction" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">10.1</span> Introduction</h2>
<p>The purpose of most crime maps is to help people make decisions, be they professionals working out how best to respond to crime problems or citizens holding local leaders to account. We can make it easier for people to make decisions by putting crime data into a relevant context. We have already started to do this by adding base maps, titles, legends and so on to our maps.</p>
<p>Since crime is concentrated in a few places, readers of our crime maps will often be interested in understanding what features of the environment are related to specific concentrations of crime in particular places. Where patterns of crime are related to particular facilities – such as late-night violence being driven by the presence of bars selling alcohol – it can be useful to highlight specific features on our maps.</p>
<p>As an example, imagine you are the manager responsible for security on the metro network in Medellin, Colombia. There are several mountains within Medellin, so the city metro network consists of both railway lines in the valley and cable cars up the mountains. The security manager for the metro company will certainly analyse violence on the company’s stations and vehicles, but may also be interested in which stations are in neighbourhoods that themselves have high levels of violence.</p>
<p>To help with this, you might produce a map showing the density of homicides recorded by local police.</p>
<p class="full-width-image">
<img src="images/medellin_homicides_map1.jpg" alt="Map of homicides in Medellin from 2010 to 2019" style="max-height: 600px;">
</p>
<p>This is an acceptable crime map: it shows the data in a reasonable way, places the data layer at the top of the visual hierarchy and provides suitable context in the title, legend etc. But it is a much less useful map than it could be because it doesn’t show where the metro stations are and this information is not included in the base map. A much better map would add extra layers of data showing the metro stations and the line connecting them.</p>
<p class="full-width-image">
<img src="images/medellin_homicides_map2.jpg" alt="Map of homicides in Medellin from 2010 to 2019 with metro stations and lines highlighted" style="max-height: 600px;">
</p>
<p>From this second map, it is much easier to see that Parque Berrío and Prado stations are closest to an area with relatively high numbers of homicides.</p>
<p>In this tutorial we will learn how to find relevant data about places and add extra layers to our maps to help readers understand the context within which crimes occur.</p>
<p>To get started, watch this video that walks through the code needed to download data from OpenStreetMap for use on our maps.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/kcpiH6dDWLE" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
</section>
<section id="loading-csv-data" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="loading-csv-data"><span class="header-section-number">10.2</span> Loading CSV data</h2>
<p>Throughout this tutorial, we will use homicides in the Colombian city of Medellin as an example. Data on the locations of homicides in Medellin from 2010 to 2019 is available at <code>https://mpjashby.github.io/crimemappingdata/medellin_homicides.csv</code>.</p>
<p>In previous tutorials, we have used the <code>read_csv()</code> function from the <code>readr</code> package to load data from CSV files. The <code>read_csv()</code> function assumes that (as the name ‘comma-separated values’ suggests) the columns in a CSV file are separated by commas (<code>,</code>). But not all countries use commas as the column separator in CSV files: some countries use semi-colons (<code>;</code>) instead. This is usually because those countries also use commas instead of periods as the decimal separator inside numbers (so that the number three-point-one-four is written <code>3,14</code> instead of <code>3.14</code> as in English). If commas are used as decimal separators in numbers in a file, commas cannot also be used to separate columns from one another – otherwise there would be no way to know if a comma represented the decimal mark in a number or the boundary between two columns.</p>
<p>If we try to load a CSV file that uses semi-colon separators using the <code>read_csv()</code> function, all the data on each row will be loaded as a single column:</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a>medellin_homicides <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/medellin_homicides.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: One or more parsing issues, call `problems()` on your data frame for details,
e.g.:
  dat &lt;- vroom(...)
  problems(dat)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Rows: 9360 Columns: 1
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (1): fecha_hecho;longitud;latitud;sexo;edad;modalidad

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">head</span>(medellin_homicides)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 6 × 1
  `fecha_hecho;longitud;latitud;sexo;edad;modalidad`                            
  &lt;chr&gt;                                                                         
1 2019-04-23T12:30:00Z;-75,56985400000;6,25722555000;Mujer;50;Ahorcamiento o es…
2 2019-05-12T00:51:00Z;-75,61036800000;6,22280611000;Hombre;24;Arma de fuego    
3 2019-05-12T02:36:00Z;-75,62039100000;6,26238217000;Hombre;34;Arma de fuego    
4 2019-05-12T03:03:00Z;-75,56176640000;6,26958878000;Hombre;20;Arma de fuego    
5 2019-05-12T22:40:00Z;-75,53268500000;6,23627692000;Hombre;34;Arma de fuego    
6 2019-05-12T19:30:00Z;-75,64195830000;6,19619536500;Hombre;25;Arma de fuego    </code></pre>
</div>
</div>
<p>This is obviously not what we want, so we need to use a different function to load this data. Fortunately, the <code>readr</code> package has another function that can handle CSV files created using the conventions of countries that use semi colons to separate columns: <code>read_csv2()</code>.</p>
<p>How should you know when to use <code>read_csv2()</code> rather than <code>read_csv()</code>? If you don’t know whether a file uses commas or semi colons to separate columns, the easiest thing is probably to use <code>read_csv()</code> first. Now load the file and use <code>head()</code> to look at the first few rows: if you see all the data has appeared in a single column that contains several semi colons, then you’ll know to change your code to use <code>read_csv2()</code> instead.</p>
<p>For this dataset, if you load it with <code>read_csv2()</code> you should find that the structure of the data is more as you’d expect it to be.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb6" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>medellin_homicides <span class="ot">&lt;-</span> <span class="fu">read_csv2</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/medellin_homicides.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>ℹ Using "','" as decimal and "'.'" as grouping mark. Use `read_delim()` for more control.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Rows: 9360 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ";"
chr  (2): sexo, modalidad
dbl  (3): longitud, latitud, edad
dttm (1): fecha_hecho

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">head</span>(medellin_homicides)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 6 × 6
  fecha_hecho         longitud latitud sexo    edad modalidad                   
  &lt;dttm&gt;                 &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;                       
1 2019-04-23 12:30:00    -75.6    6.26 Mujer     50 Ahorcamiento o estrangulami…
2 2019-05-12 00:51:00    -75.6    6.22 Hombre    24 Arma de fuego               
3 2019-05-12 02:36:00    -75.6    6.26 Hombre    34 Arma de fuego               
4 2019-05-12 03:03:00    -75.6    6.27 Hombre    20 Arma de fuego               
5 2019-05-12 22:40:00    -75.5    6.24 Hombre    34 Arma de fuego               
6 2019-05-12 19:30:00    -75.6    6.20 Hombre    25 Arma de fuego               </code></pre>
</div>
</div>
<p>In the rest of this tutorial we will use data from different sources to better understand clusters of homicides in the La Candelaria neighbourhood of downtown Medellin.</p>
<!--

Use this map (created with the `leaflet` package) to look around the
La Candelaria neighbourhood -- the markers show the locations of the metro
stations inside the neighbourhood boundary.

-->
<section id="check-your-understanding" class="level3 tutorial" data-number="10.2.1">
<h3 class="tutorial anchored" data-number="10.2.1" data-anchor-id="check-your-understanding"><span class="header-section-number">10.2.1</span> Check your understanding</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">quiz</span>(</span>
<span id="cb11-2"><a href="#cb11-2"></a>  <span class="at">caption =</span> <span class="st">""</span>,</span>
<span id="cb11-3"><a href="#cb11-3"></a>  </span>
<span id="cb11-4"><a href="#cb11-4"></a>  <span class="fu">question</span>(</span>
<span id="cb11-5"><a href="#cb11-5"></a>    <span class="st">"Which function should you use to load a CSV file of crime locations that uses semi-colons to separate the columns?"</span>,</span>
<span id="cb11-6"><a href="#cb11-6"></a>    <span class="fu">answer</span>(<span class="st">"`read_csv2()` from the `readr` package"</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-7"><a href="#cb11-7"></a>    <span class="fu">answer</span>(</span>
<span id="cb11-8"><a href="#cb11-8"></a>      <span class="st">"`read_csv()` from the `readr` package"</span>,</span>
<span id="cb11-9"><a href="#cb11-9"></a>      <span class="at">message =</span> <span class="st">"`read_csv()` is used to load CSV files that use commas to separate columns."</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>    ),</span>
<span id="cb11-11"><a href="#cb11-11"></a>    <span class="fu">answer</span>(</span>
<span id="cb11-12"><a href="#cb11-12"></a>      <span class="st">"`read.csv2()` from the `base` package"</span>,</span>
<span id="cb11-13"><a href="#cb11-13"></a>      <span class="at">message =</span> <span class="st">"While the `read.csv2()` function from the `base` package will load CSV files that use semi-colons to separate columns, it is better to use a function from the `readr` package so that the loaded data will be in a tibble rather than a data frame, and so that text values will not be silently changed to categorical values."</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>    ),</span>
<span id="cb11-15"><a href="#cb11-15"></a>    <span class="fu">answer</span>(</span>
<span id="cb11-16"><a href="#cb11-16"></a>      <span class="st">"`read_sf()` or `st_read()` from the `sf` package"</span>,</span>
<span id="cb11-17"><a href="#cb11-17"></a>      <span class="at">message =</span> <span class="st">"CSV is not a spatial file format (even when it contains columns that represent co-ordinates), so it is best not to load them with functions from the `sf` package (which expect to handle spatial file formats). While `read_sf()` and `st_read()` can open CSV files, both functions assume all the columns contain text values, meaning you then have to use another function to convert column values to numbers, dates, etc."</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>    ),</span>
<span id="cb11-19"><a href="#cb11-19"></a>    <span class="at">correct =</span> <span class="fu">random_praise</span>(),</span>
<span id="cb11-20"><a href="#cb11-20"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-21"><a href="#cb11-21"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb11-22"><a href="#cb11-22"></a>  )</span>
<span id="cb11-23"><a href="#cb11-23"></a>  </span>
<span id="cb11-24"><a href="#cb11-24"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="finding-data" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="finding-data"><span class="header-section-number">10.3</span> Finding data</h2>
<p>If you are producing crime maps on behalf of a particular organisation such as a police agency or a body responsible for managing a place, it is likely that they will hold spatial data that is relevant to the local area. For example, many city governments will hold records of local businesses. It will sometimes be necessary to track down which department or individual holds this data, and it may also be necessary to convert data into formats that are useful for spatial analysis.</p>
<p>Some organisations may also have agreements to share data with others. For example, both universities and public agencies such as police forces in the United Kingdom have agreements with the national mapping agency Ordnance Survey to share a wide variety of spatial data. If you are producing maps on behalf of an organisation, it will often be useful to ask what data they hold that might be relevant, or ask for a specific dataset you think would help improve a map.</p>
<section id="open-data" class="level3" data-number="10.3.1">
<h3 data-number="10.3.1" class="anchored" data-anchor-id="open-data"><span class="header-section-number">10.3.1</span> Open data</h3>
<p><em>Open data</em> is data that is released by organisations or individuals that can be freely used by others. Organisations such as local governments increasingly release data about their areas as open data – almost all of the data we have used so far in this course is open data released by different local and national governments.</p>
<p>Open data is extremely useful because you can skip the often lengthy and painful process of getting access to data and wrangling it into a format you can use. This means you can move on much more quickly to analysing data, reaching conclusions and making decisions. Watch this video to find out more about the value of open data.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/bwX5MAZ6zKI" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>Open data is published in a wide variety of formats and distributed in different ways. Some data might only be distributed by an organisation sending you a DVD or memory stick. Most of the time, however, data will be released online.</p>
<p>Many cities (especially but not only in developed countries) now maintain open-data websites that act as a repository for all their open data. For example, the City of Bristol in England publishes the <a href="https://opendata.bristol.gov.uk/pages/homepage/">Open Data Bristol website</a>. Anyone can use this website to download data on everything from population estimates to politicians’ expenses. Many of these datasets can be useful for crime mapping. For example, you can download the locations of <a href="https://opendata.bristol.gov.uk/explore/dataset/council-cctv-cameras/information/">CCTV cameras</a> (useful in criminal investigations), <a href="https://opendata.bristol.gov.uk/explore/dataset/streetlights-and-street-furniture/information/">street lights</a> (relevant to designing out crime) and the <a href="https://opendata.bristol.gov.uk/explore/dataset/secondary-school-areas-of-first-priority/information/">catchment areas of secondary schools</a> (helpful if a crime-prevention strategy includes visits to schools).</p>
<p>Different local governments may use different terms for the same types of information, so it sometimes takes some trial and error to find if a particular dataset is available. Some data might also be held by organisations other than the main local government agency for a particular place. For example, data on the locations of electricity substations (useful if you are trying to prevent metal thefts from infrastructure networks) might be held by a power company. All this means that tracking down a particular dataset might require some detective work.</p>
<p>To try to make this process easier, some countries have established national open-data portals such as <a href="https://open.canada.ca/en/open-data/">Open Data in Canada</a>, <a href="https://data.gov.in/">Open Government India</a>, <a href="https://data.gov.uk/">data.gov.uk in the United Kingdom</a> and <a href="https://www.data.gov/">data.gov in the United States</a>. There are also international repositories such as the <a href="https://dataportal.opendataforafrica.org/">African Development Bank Data Portal</a>, <a href="https://africaopendata.org/">openAfrica</a>, the <a href="http://www.opendatanetwork.com/">Open Data Network</a> and <a href="https://dataportals.org/">Data Portals</a>, which seeks to list all the open data portals run by different governments and other organisations.</p>
</section>
<section id="citing-data" class="level3" data-number="10.3.2">
<h3 data-number="10.3.2" class="anchored" data-anchor-id="citing-data"><span class="header-section-number">10.3.2</span> Citing data</h3>
<p>Organisations that provide data often do so on condition that users of the data follow certain rules. For example, you can use data on the Open Data Bristol website as long as you follow the conditions of the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/">Open Government Licence</a>. The most-common requirement of an open-data licence is that anyone using the data acknowledges the data source in any maps, reports or other outputs they produce. In the case of the Open Government Licence, users of the data are required to add a declaration to any outputs declaring:</p>
<blockquote class="blockquote">
<p>Contains public sector information licensed under the Open Government Licence v3.0.</p>
</blockquote>
<p>Complying with open-data licences is a legal requirement, so it is important to make sure you understand what obligations you are accepting when you use a particular dataset. You can typically find the conditions for using a dataset on the website that you download the data from. If you are required to add an attribution statement to your maps, a good place to do this is by adding it to any other information you place in the <code>caption</code> argument of the <code>labs()</code> function in a <code>ggplot()</code> stack.</p>
</section>
<section id="check-your-understanding-1" class="level3 tutorial" data-number="10.3.3">
<h3 class="tutorial anchored" data-number="10.3.3" data-anchor-id="check-your-understanding-1"><span class="header-section-number">10.3.3</span> Check your understanding</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">quiz</span>(</span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="at">caption =</span> <span class="st">""</span>,</span>
<span id="cb12-3"><a href="#cb12-3"></a>  </span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="fu">question</span>(</span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="st">"Which one of these statements about open data is true?"</span>,</span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="fu">answer</span>(<span class="st">"We can use open data for any purpose as long as we comply with the requirements of the licence the data is released under."</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-7"><a href="#cb12-7"></a>    <span class="fu">answer</span>(</span>
<span id="cb12-8"><a href="#cb12-8"></a>      <span class="st">"We can use open data for any purpose -- there is no need to acknowledge the source of the data."</span>,</span>
<span id="cb12-9"><a href="#cb12-9"></a>      <span class="at">message =</span> <span class="st">"While we can often use open data for almost any purpose, it is important to comply with the requirements of the licence the data was released under. Most open-data licences include a requriement to acknowledge the source of the data."</span></span>
<span id="cb12-10"><a href="#cb12-10"></a>    ),</span>
<span id="cb12-11"><a href="#cb12-11"></a>    <span class="fu">answer</span>(</span>
<span id="cb12-12"><a href="#cb12-12"></a>      <span class="st">"We can use open data, but only for non-commercial purposes."</span>,</span>
<span id="cb12-13"><a href="#cb12-13"></a>      <span class="at">message =</span> <span class="st">"Most open data licences allow us to use data for both commercial and non-commercial purposes, as long as we comply with the other requirements of the licence -- most often this includes a requriement to acknowledge the source of the data."</span></span>
<span id="cb12-14"><a href="#cb12-14"></a>    ),</span>
<span id="cb12-15"><a href="#cb12-15"></a>    <span class="fu">answer</span>(</span>
<span id="cb12-16"><a href="#cb12-16"></a>      <span class="st">"We can download open data but we cannot use it for any project that will be published online."</span>,</span>
<span id="cb12-17"><a href="#cb12-17"></a>      <span class="at">message =</span> <span class="st">"Organisations usually publish open data to make it easier for other organisations and individuals to use that data to make products and analyse local issues. It would be extremely unusual for an open-data licence to stop people from using the data in a project that was going to be published online."</span></span>
<span id="cb12-18"><a href="#cb12-18"></a>    ),</span>
<span id="cb12-19"><a href="#cb12-19"></a>    <span class="at">correct =</span> <span class="fu">random_praise</span>(),</span>
<span id="cb12-20"><a href="#cb12-20"></a>    <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-21"><a href="#cb12-21"></a>    <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb12-22"><a href="#cb12-22"></a>  )</span>
<span id="cb12-23"><a href="#cb12-23"></a>  </span>
<span id="cb12-24"><a href="#cb12-24"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="shapefiles" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="shapefiles"><span class="header-section-number">10.4</span> Shapefiles</h2>
<p>In this course we have used spatial data provided in different formats including geopackages (<code>.gpkg</code>) and geoJSON (<code>.geojson</code>) files, as well as creating spatial objects from tabular data in formats like CSV and Excel files. But there is one spatial-data format that we haven’t yet learned to use: the <em>shapefile</em>.</p>
<p>The shapefile format was created by Esri, the company that makes the ArcGIS suite of mapping software. It was perhaps the first spatial format that could be read by a wide variety of mapping software, which meant that lots of providers of spatial data began to provide data in shapefile format. Shapefiles are limited in various ways that mean they are unlikely to be a good choice for storing your own data, but it is important to know how to use them because many spatial datasets are still provided as shapefiles for historical reasons.</p>
<p>One of the complications of using shapefiles (and why they’re not a good choice for storing your own data) is that different parts of the data are stored in separate files. So while the co-ordinates of the points, line or polygons are stored in a file with a <code>.shp</code> extension, the non-spatial attributes of each spatial feature (such as the date on which a crime occurred or the name of a neighbourhood) are stored in a separate file with a <code>.dbf</code> extension and details of the co-ordinate reference system are stored in a <code>.prj</code> file – a single dataset might be held in up to 16 separate files on a computer. All the files that make up a shapefile have the same file name, differing only in the file extension (e.g.&nbsp;<code>.shp</code>, <code>.dbf</code>, etc.). For example, if a <code>.shp</code> file is called <code>robberies.shp</code> then it will be accompanied by a file called <code>robberies.dbf</code> and one called <code>robberies.prj</code>, as well as a <code>robberies.shx</code> index file and possibly several others. All these separate files make it more-complicated to manage shapefiles than other spatial file formats such as the geopackage.</p>
<p>Because storing spatial data in a shapefile requires multiple different files, shapefile data is usually distributed in a <code>.zip</code> file that contains all the component files. This means that to access a shapefile will have to add a step to our usual routine for downloading and opening a data file. To minimise the hassle associated with using shapefiles, in general we will:</p>
<ol type="1">
<li>download the <code>.zip</code> file if we don’t have a local copy already,</li>
<li>create a temporary directory where we can store the unzipped shapefile, so we can save space on our computers by only permanently keeping the (often much smaller) <code>.zip</code> file,</li>
<li>unzip the <code>.zip</code> file into the temporary directory,</li>
<li>load the shapefile data from the temporary directory.</li>
</ol>
<p>For example, the routes of metro lines in Medellin are available in shapefile format at:</p>
<pre data-code-line-numbers=""><code>https://mpjashby.github.io/crimemappingdata/medellin_metro_lines.zip</code></pre>
<p>To load the data from this file, we can use the process shown above.</p>
<div class="tutorial">
<p>Unfortunately it isn’t possible to run this code within this interactive tutorial because of security restrictions on saving files on your computer from within a tutorial. You can test this code by copying it into a new R Script in RStudio and running the code from there. Note that this code assumes you have already loaded the <code>sf</code> and <code>tidyverse</code> packages.</p>
</div>
<div class="sourceCode" id="cb14" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># Step 1: download the .zip file to a temporary file</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>metro_lines_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".zip"</span>)</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="fu">download.file</span>(</span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="at">url =</span> <span class="st">"https://mpjashby.github.io/crimemappingdata/medellin_metro_lines.zip"</span>, </span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="at">destfile =</span> metro_lines_file</span>
<span id="cb14-6"><a href="#cb14-6"></a>)</span>
<span id="cb14-7"><a href="#cb14-7"></a></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="co"># Step 2: create a temporary directory</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="co"># The `tempdir()` function returns a location on your computer that is used for</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="co"># storing temporary files. *Any files stored in this temporary directory will be</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="co"># deleted when you restart your computer*, so it's a useful place to put files</span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="co"># that you will only need for a short time so they won't clutter up your</span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="co"># computer. Since we want to store the shapefile in a sub-directory of the</span></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="co"># temporary directory, we will use `str_glue()` to add a relevant sub-directory</span></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="co"># name to the end of the temporary directory name -- `unzip()` will then</span></span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="co"># create this directory in the background at Step 3.</span></span>
<span id="cb14-17"><a href="#cb14-17"></a>metro_lines_dir <span class="ot">&lt;-</span> <span class="fu">str_glue</span>(<span class="st">"{tempdir()}/metro_lines"</span>)</span>
<span id="cb14-18"><a href="#cb14-18"></a></span>
<span id="cb14-19"><a href="#cb14-19"></a><span class="co"># Step 3: unzip file</span></span>
<span id="cb14-20"><a href="#cb14-20"></a><span class="fu">unzip</span>(metro_lines_file, <span class="at">exdir =</span> metro_lines_dir)</span>
<span id="cb14-21"><a href="#cb14-21"></a></span>
<span id="cb14-22"><a href="#cb14-22"></a><span class="co"># Step 5: load the data</span></span>
<span id="cb14-23"><a href="#cb14-23"></a>medellin_metro_lines <span class="ot">&lt;-</span> metro_lines_dir <span class="sc">|&gt;</span> </span>
<span id="cb14-24"><a href="#cb14-24"></a>  <span class="fu">str_glue</span>(<span class="st">"/medellin_metro_lines.shp"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-25"><a href="#cb14-25"></a>  <span class="fu">read_sf</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="box notewell">
<p>Note that although a shapefile consists of several different files, we only need to load the file with the extension <code>.shp</code> – the <code>read_sf()</code> function will find all the data it needs from the other files.</p>
<p>Once we have loaded a shapefile into R using <code>read_sf()</code>, we can treat it in the same way as any other spatial dataset – it is only loading shapefiles that is different from other spatial data formats.</p>
</div>
<div class="box extra-detail">
<h5 id="shapefile-box1-title" class="box-title anchored">
How did you know the name of the <code>medellin_metro_lines.shp</code> file?
</h5>
<div id="shapefile-box1" class="box-content">
<p>If you need to find out the name of the shapefile within the zip file, you can use the <code>list = TRUE</code> argument to the <code>unzip()</code> function to produce a list of files that are inside the zip file rather than unzip any files. For example, the code <code>unzip(metro_lines_file, list = TRUE)</code> would produce a data frame of file names:</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Name</th>
<th style="text-align: right;">Length</th>
<th style="text-align: left;">Date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">medellin_metro_lines.dbf</td>
<td style="text-align: right;">2299</td>
<td style="text-align: left;">2023-02-06 22:46:00</td>
</tr>
<tr class="even">
<td style="text-align: left;">medellin_metro_lines.prj</td>
<td style="text-align: right;">145</td>
<td style="text-align: left;">2023-02-06 22:46:00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">medellin_metro_lines.shp</td>
<td style="text-align: right;">16076</td>
<td style="text-align: left;">2023-02-06 22:46:00</td>
</tr>
<tr class="even">
<td style="text-align: left;">medellin_metro_lines.shx</td>
<td style="text-align: right;">172</td>
<td style="text-align: left;">2023-02-06 22:46:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><strong>Make sure you run <code>unzip(metro_lines_file, list = TRUE)</code> in the R console rather than in your script file, to minimise the amount of unnecessary output that your script produces.</strong></p>
</div>
</div>
<script>
$("#shapefile-box1-title").click(function () { $("#shapefile-box1").toggle("slow") })
</script>
<!-- ### Check your understanding -->
<!-- ```{r open-data-quiz} -->
<!-- quiz( -->
<!--   caption = "", -->
<!--   question( -->
<!--     "", -->
<!--     answer("", correct = TRUE), -->
<!--     answer( -->
<!--       "", -->
<!--       message = "" -->
<!--     ), -->
<!--     answer( -->
<!--       "", -->
<!--       message = "" -->
<!--     ), -->
<!--     answer( -->
<!--       "", -->
<!--       message = "" -->
<!--     ), -->
<!--     correct = random_praise(), -->
<!--     allow_retry = TRUE, -->
<!--     random_answer_order = TRUE -->
<!--   ) -->
<!-- ) -->
<!-- ``` -->
</section>
<section id="data-from-openstreetmap" class="level2" data-number="10.5">
<h2 data-number="10.5" class="anchored" data-anchor-id="data-from-openstreetmap"><span class="header-section-number">10.5</span> Data from OpenStreetMap</h2>
<p><a href="https://www.openstreetmap.org/"><img src="images/osm_logo.jpg" alt="OpenStreetMap logo" class="right-side-image"></a></p>
<p>Often we can get map data from the organisation we are working for, or from open-data portals run by governments or international organisations. But sometimes they won’t hold the information we need.</p>
<p>Fortunately, there is another source of data: OpenStreetMap (OSM). This is a global resource of map data created by volunteers (and started at UCL), using a mixture of open data from governments, data contributed by charities and data collected by the volunteers themselves. Watch this video to learn a bit more about OpenStreetMap.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/d6n29CU2-Sg" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>We have already used OSM data in this course: all of the base maps we have used when we create maps with <code>ggplot()</code> are based on data from OpenStreetMap. But we have very little control over which information is and is not included in base maps. Sometimes we need more control over the data, and that means downloading data direct from OSM.</p>
<p>We can download OSM data into R using the <code>osmdata</code> package. This package allows us to choose particular features from the billions of features worldwide that are included in the OSM database. To choose features, we must:</p>
<ol type="1">
<li>specify the <em>bounding box</em> of the area we want to download data for using the <code>opq()</code> function,</li>
<li>specify what type of features we want to download using the <code>add_osm_feature()</code> function,</li>
<li>download the data using the <code>osmdata_sf()</code> function, and</li>
<li>extract the type of spatial object (points, lines or polygons) that we are interested in.</li>
</ol>
<p>Imagine that in your analysis of homicides in Medellin, you have been asked to consider the question of whether homicides are clustered near to bus stops. To answer this question, we need to know the locations of bus stops in the area we are interested in. This information is not published as open data by the Medellin city authorities. Fortunately we can extract bus-stop locations from OpenStreetMap using the <code>osmdata</code> package.</p>
<p>To do this, we first need to calculate the bounding box of the La Candelaria neighbourhood that we are interested in. A bounding box is the smallest rectangle that a particular spatial shape will fit inside. For example, the red rectangle on this map shows the bounding box of the city of Medellin (shown in blue).</p>
<p class="full-width-image">
<img src="images/medellin_bbox_map.jpg" alt="Map of the boundary of Medellin and the corresponding bounding box">
</p>
<p>You can calculate the bounding box of an SF object using the <code>st_bbox()</code> function.</p>
<div class="tutorial">
<p>Assuming we have already loaded the neighbourhood boundaries into an object called <code>medellin_comunas</code>, write the code needed to filter that object so that only the boundary for the La Candelaria neighbourhood is included, then calculate the bounding box for that layer and store it in an object called <code>la_candelaria_bbox</code>.</p>
<p>Note that the <code>medellin_comunas</code> object uses the Colombia MANGA West Zone co-ordinate system (EPSG code 3115), but the <code>osmdata</code> package only works with bounding boxes specified as longitudes and latitudes. This means you will also need to transform the dataset to use the WGS84 co-ordinate system (EPSG code 4326) before you calculate the bounding box.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># You can use the `filter()` function to filter only the rows of data that you </span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="co"># want to keep in the data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># Remember to use `st_transform()` to make sure the data uses the correct</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="co"># co-ordinate system. You can use the `st_bbox()` function to calculate the </span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="co"># bounding box of the 52nd division boundary.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># If you need to find out the name of the relevant variable in the </span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="co"># `medellin_comunas` object, you can use `head(medellin_comunas)` to see the </span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="co"># first few rows.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>la_candelaria_bbox <span class="ot">&lt;-</span> medellin_comunas <span class="sc">|&gt;</span> </span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">filter</span>(nombre <span class="sc">==</span> <span class="st">"LA CANDELARIA"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="fu">st_bbox</span>()</span>
<span id="cb18-5"><a href="#cb18-5"></a></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="fu">head</span>(la_candelaria_bbox)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>      xmin       ymin       xmax       ymax 
-75.580293   6.224509 -75.553850   6.265124 </code></pre>
</div>
</div>
<p>The second thing we need to know is what search terms to use in the <code>add_osm_feature()</code> function to return the locations of bus stops. OpenStreetMap has hundreds of feature categories, all in the format <code>key=value</code>. Sometimes we will only need to search for a particular key (category of feature), such as the <a href="https://wiki.openstreetmap.org/wiki/Key:highway"><code>highway</code> key</a> that contains all the features that show roads (from motorways to winding lanes leading to farms in the countryside), tracks and paths. In other cases, we will want to search for a particular value (type of feature within a category), such as searching for the value <a href="https://wiki.openstreetmap.org/wiki/Tag:natural%3Dwater"><code>natural=water</code></a> to search for lakes, rivers, etc.</p>
<p>The best place to find out how a feature you are interested in is recorded in the OSM database is to look at the <a href="https://wiki.openstreetmap.org/wiki/Map_features">OpenStreetMap Wiki</a>. Bus stops are recorded in OSM using the tag <code>highway=bus_stop</code>.</p>
<p>Now that we know the bounding box of the area we are interested in and the tag for the type of feature we want, we can download the data from OpenStreetMap.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb20" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># Define the bounding box of the area we want to search</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>bus_stops <span class="ot">&lt;-</span> <span class="fu">opq</span>(la_candelaria_bbox) <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="co"># Define the features we want</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"highway"</span>, <span class="at">value =</span> <span class="st">"bus_stop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="co"># Download those features for that area</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>  <span class="fu">osmdata_sf</span>()</span>
<span id="cb20-7"><a href="#cb20-7"></a></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="co"># Print the result (note the result is not a data frame, so we cannot use the</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="co"># `head()` function)</span></span>
<span id="cb20-10"><a href="#cb20-10"></a>bus_stops</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Object of class 'osmdata' with:
                 $bbox : 6.22450932830104,-75.5802925457919,6.26512401936258,-75.5538503495463
        $overpass_call : The call submitted to the overpass API
                 $meta : metadata including timestamp and version numbers
           $osm_points : 'sf' Simple Features Collection with 55 points
            $osm_lines : NULL
         $osm_polygons : 'sf' Simple Features Collection with 0 polygons
       $osm_multilines : NULL
    $osm_multipolygons : NULL</code></pre>
</div>
</div>
<p>You’ll see that the object <code>bus_stops</code> has quite complicated structure, but that nested within it is an object called <code>osm_points</code> that is an SF object with 55 rows and another SF object called <code>osm_polygons</code>. Even within a particular type of feature, some places might be represented as points (e.g.&nbsp;a point placed at a bus stop) while others are represented as polygons (e.g.&nbsp;the outline of a bus station).</p>
<p>We can use the <code>pluck()</code> function from the <code>purrr</code> package (part of the tidyverse) to extract the parts of the <code>bus_stops</code> object that we want. If we extract the SF object called <code>osm_points</code> and look at the first few rows using <code>bus_stops |&gt; pluck("osm_points") |&gt; head(n = 5)</code>, we can see:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>bus_stops <span class="sc">|&gt;</span> <span class="fu">pluck</span>(<span class="st">"osm_points"</span>) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 5 features and 19 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -75.57696 ymin: 6.228165 xmax: -75.56289 ymax: 6.260205
Geodetic CRS:  WGS 84
               osm_id                 name access bench  bin  bus
847830985   847830985                 &lt;NA&gt;   &lt;NA&gt;    no &lt;NA&gt;  yes
1561073855 1561073855         La Alpujarra   &lt;NA&gt;  &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;
2418112357 2418112357                 &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;
3135948756 3135948756      Barrio Colombia   &lt;NA&gt;  &lt;NA&gt; &lt;NA&gt;  yes
3346088239 3346088239 Carrera 33 Calle 29C   &lt;NA&gt;    no &lt;NA&gt; &lt;NA&gt;
           check_date:shelter covered  highway  lit    local_ref name:en
847830985                &lt;NA&gt;    &lt;NA&gt; bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
1561073855               &lt;NA&gt;    &lt;NA&gt; bus_stop &lt;NA&gt; La Alpujarra    &lt;NA&gt;
2418112357               &lt;NA&gt;    &lt;NA&gt; bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
3135948756               &lt;NA&gt;    &lt;NA&gt; bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
3346088239               &lt;NA&gt;      no bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
             network              note          operator public_transport
847830985       &lt;NA&gt;              &lt;NA&gt;              &lt;NA&gt;         platform
1561073855      &lt;NA&gt;              &lt;NA&gt;              &lt;NA&gt;             &lt;NA&gt;
2418112357      &lt;NA&gt;              &lt;NA&gt;              &lt;NA&gt;             &lt;NA&gt;
3135948756 Metroplus Sentido Norte Sur Metro de Medellín         platform
3346088239      &lt;NA&gt;              &lt;NA&gt; Metro de Medellín             &lt;NA&gt;
           shelter source wheelchair                   geometry
847830985      yes   &lt;NA&gt;       &lt;NA&gt; POINT (-75.57696 6.260205)
1561073855    &lt;NA&gt;   &lt;NA&gt;       &lt;NA&gt; POINT (-75.57342 6.245391)
2418112357    &lt;NA&gt;   &lt;NA&gt;       &lt;NA&gt;  POINT (-75.56893 6.24997)
3135948756     yes   &lt;NA&gt;        yes POINT (-75.56982 6.228716)
3346088239      no   &lt;NA&gt;       &lt;NA&gt; POINT (-75.56289 6.228165)</code></pre>
</div>
</div>
<p>We can see from this that most of the fields are blank, but there is a <code>name</code> column and a <code>geometry</code> column that we can use to plot the locations of the bus stops.</p>
<p>We also need to check the contents of the <code>osm_polygons</code> layer inside the <code>bus_stops</code> object, to see if it contains details of a any more bus stops that are not included in the <code>osm_points</code> layer.</p>
<div class="tutorial">
<p>Type the code needed to extract the <code>osm_polygons</code> layer and view the first few rows.</p>
</div>
<div class="book">
<p>To check this, we can again use the <code>pluck()</code> function:</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>bus_stops <span class="sc">|&gt;</span> <span class="fu">pluck</span>(<span class="st">"osm_polygons"</span>) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 0 features and 1 field
Bounding box:  xmin: NA ymin: NA xmax: NA ymax: NA
Geodetic CRS:  WGS 84
[1] osm_id   geometry
&lt;0 rows&gt; (or 0-length row.names)</code></pre>
</div>
</div>
<p>In this case, we can see that there are 0 rows in the <code>osm_polygons</code> object. In cases where we have data contained in both the <code>osm_points</code> and <code>osm_polygons</code> layers, we need to merge the two layers by converting the polygon layer to a point layer using the <code>st_centroid()</code> function and then merging the two layers using the <code>bind_rows()</code> function from the <code>dplyr</code> package. We can put all this together into one piece of code.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb26" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb26-2"><a href="#cb26-2"></a>  <span class="fu">pluck</span>(bus_stops, <span class="st">"osm_points"</span>), </span>
<span id="cb26-3"><a href="#cb26-3"></a>  <span class="fu">st_centroid</span>(<span class="fu">pluck</span>(bus_stops, <span class="st">"osm_polygons"</span>))</span>
<span id="cb26-4"><a href="#cb26-4"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 55 features and 19 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -75.57967 ymin: 6.226014 xmax: -75.55641 ymax: 6.264754
Geodetic CRS:  WGS 84
First 10 features:
               osm_id                          name access bench  bin  bus
847830985   847830985                          &lt;NA&gt;   &lt;NA&gt;    no &lt;NA&gt;  yes
1561073855 1561073855                  La Alpujarra   &lt;NA&gt;  &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;
2418112357 2418112357                          &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;
3135948756 3135948756               Barrio Colombia   &lt;NA&gt;  &lt;NA&gt; &lt;NA&gt;  yes
3346088239 3346088239          Carrera 33 Calle 29C   &lt;NA&gt;    no &lt;NA&gt; &lt;NA&gt;
3346088240 3346088240          Carrera 34 Calle 29C   &lt;NA&gt;    no &lt;NA&gt; &lt;NA&gt;
3346088241 3346088241                    Carrera 34   &lt;NA&gt;    no &lt;NA&gt; &lt;NA&gt;
3346088242 3346088242       Calle 29 Av. Las Palmas   &lt;NA&gt;    no &lt;NA&gt; &lt;NA&gt;
3346088245 3346088245     Carrera 38 Av. Las Palmas   &lt;NA&gt;   yes   no &lt;NA&gt;
3346088246 3346088246 Carrera 38 Avenida Las Palmas   &lt;NA&gt;    no &lt;NA&gt; &lt;NA&gt;
           check_date:shelter covered  highway  lit    local_ref name:en
847830985                &lt;NA&gt;    &lt;NA&gt; bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
1561073855               &lt;NA&gt;    &lt;NA&gt; bus_stop &lt;NA&gt; La Alpujarra    &lt;NA&gt;
2418112357               &lt;NA&gt;    &lt;NA&gt; bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
3135948756               &lt;NA&gt;    &lt;NA&gt; bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
3346088239               &lt;NA&gt;      no bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
3346088240               &lt;NA&gt;      no bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
3346088241               &lt;NA&gt;      no bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
3346088242               &lt;NA&gt;      no bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
3346088245               &lt;NA&gt;      no bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
3346088246               &lt;NA&gt;      no bus_stop &lt;NA&gt;         &lt;NA&gt;    &lt;NA&gt;
             network              note          operator public_transport
847830985       &lt;NA&gt;              &lt;NA&gt;              &lt;NA&gt;         platform
1561073855      &lt;NA&gt;              &lt;NA&gt;              &lt;NA&gt;             &lt;NA&gt;
2418112357      &lt;NA&gt;              &lt;NA&gt;              &lt;NA&gt;             &lt;NA&gt;
3135948756 Metroplus Sentido Norte Sur Metro de Medellín         platform
3346088239      &lt;NA&gt;              &lt;NA&gt; Metro de Medellín             &lt;NA&gt;
3346088240      &lt;NA&gt;              &lt;NA&gt; Metro de Medellín             &lt;NA&gt;
3346088241      &lt;NA&gt;              &lt;NA&gt; Metro de Medellín             &lt;NA&gt;
3346088242      &lt;NA&gt;              &lt;NA&gt; Metro de Medellín             &lt;NA&gt;
3346088245      &lt;NA&gt;              &lt;NA&gt; Metro de Medellín             &lt;NA&gt;
3346088246      &lt;NA&gt;              &lt;NA&gt; Metro de Medellín             &lt;NA&gt;
           shelter source wheelchair                   geometry
847830985      yes   &lt;NA&gt;       &lt;NA&gt; POINT (-75.57696 6.260205)
1561073855    &lt;NA&gt;   &lt;NA&gt;       &lt;NA&gt; POINT (-75.57342 6.245391)
2418112357    &lt;NA&gt;   &lt;NA&gt;       &lt;NA&gt;  POINT (-75.56893 6.24997)
3135948756     yes   &lt;NA&gt;        yes POINT (-75.56982 6.228716)
3346088239      no   &lt;NA&gt;       &lt;NA&gt; POINT (-75.56289 6.228165)
3346088240      no   &lt;NA&gt;       &lt;NA&gt; POINT (-75.56364 6.229471)
3346088241      no   &lt;NA&gt;       &lt;NA&gt;  POINT (-75.5649 6.227743)
3346088242      no   &lt;NA&gt;       &lt;NA&gt; POINT (-75.56406 6.226646)
3346088245      no   &lt;NA&gt;       &lt;NA&gt; POINT (-75.56695 6.233343)
3346088246      no   &lt;NA&gt;       &lt;NA&gt; POINT (-75.56712 6.233176)</code></pre>
</div>
</div>
<div class="box extra-detail">
<h5 id="osm-box1-title" class="box-title anchored">
What does the warning <code>st_centroid assumes …</code> mean?
</h5>
<div id="osm-box1" class="box-content">
<p>You might have seen a warning saying <code>st_centroid assumes attributes are constant over geometries of x</code>. You will see this warning when you use the <code>st_centroid()</code> function. It is there to remind you that columns in the original data (which the SF package refers to as the <em>attributes</em> associated with each spatial feature) refer to the polygon as a whole, but in the object produced by <code>st_centroid()</code> it will appear that the columns relate to the centroid point. In many cases this will not be a problem, but it could expose you to the ecological fallacy so it is sometimes useful to be reminded.</p>
</div>
</div>
<script>
$("#osm-box1-title").click(function () { $("#osm-box1").toggle("slow") })
</script>
<p>This code references the <code>bus_stops</code> object twice, which means we cannot use this code within a pipeline in the usual way. This means it will be necessary to save the result produced by <code>osmdata_sf()</code> in an object and then combine the points and polygon centroids in a separate piece of code.</p>
<div class="tutorial">
<p>We now have everything we need to map homicides in La Candelaria in relation to bus stops. Create a map showing a suitable base map, the density of homicides in the La Candelaria neighbourhood, the locations of bus stop as individual points and the boundary of the neighbourhood.</p>
<p>You will need to:</p>
<ol type="1">
<li>Create an object holding the boundary of the La Candelaria neighbourhood. Remember the boundaries of Medellin neighbourhoods are contained in the <code>medellin_comunas</code> object.</li>
<li>Estimate the density of homicides in the La Candelaria neighbourhood. The homicide locations are stored in the <code>medellin_homicides</code> object, although you will probably want to extract only those in La Candelaria before estimating the density.</li>
<li>Extract the bounding box of the neighbourhood boundary and use that to get the locations of bus stops, taking into account that some bus stops might be stored in the OSM database as points and others as polygons.</li>
<li>Create a map showing the density of homicides, the locations of bus stops and the boundary of the neighbourhood.</li>
</ol>
</div>
<div class="book">
<p>Now that we have everything we need, we can create a map of homicides in La Candelaria.</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># There are lots of design decisions you could make in producing a map -- the</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="co"># following code is a minimal map, which you could improve on in several ways</span></span>
<span id="cb28-3"><a href="#cb28-3"></a></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="co"># Load data</span></span>
<span id="cb28-5"><a href="#cb28-5"></a>medellin_comunas <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/medellin_comunas.gpkg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-6"><a href="#cb28-6"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-7"><a href="#cb28-7"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:3115"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-8"><a href="#cb28-8"></a>  <span class="fu">select</span>(nombre, geom)</span>
<span id="cb28-9"><a href="#cb28-9"></a>medellin_homicides <span class="ot">&lt;-</span> <span class="fu">read_csv2</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/medellin_homicides.csv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-10"><a href="#cb28-10"></a>  <span class="fu">remove_missing</span>(<span class="at">vars =</span> <span class="fu">c</span>(<span class="st">"longitud"</span>, <span class="st">"latitud"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb28-11"><a href="#cb28-11"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitud"</span>, <span class="st">"latitud"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>ℹ Using "','" as decimal and "'.'" as grouping mark. Use `read_delim()` for more control.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Rows: 9360 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ";"
chr  (2): sexo, modalidad
dbl  (3): longitud, latitud, edad
dttm (1): fecha_hecho

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: Removed 81 rows containing missing values or values outside the scale
range.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># Create neighbourhood boundary</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>la_candelaria <span class="ot">&lt;-</span> medellin_comunas <span class="sc">|&gt;</span> </span>
<span id="cb32-3"><a href="#cb32-3"></a>  <span class="fu">filter</span>(nombre <span class="sc">==</span> <span class="st">"LA CANDELARIA"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb32-4"><a href="#cb32-4"></a>  <span class="co"># This object needs to use the same co-ordinate system as `medellin_homicides`</span></span>
<span id="cb32-5"><a href="#cb32-5"></a>  <span class="co"># so we can use `st_intersection()`, so transform it first</span></span>
<span id="cb32-6"><a href="#cb32-6"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:3115"</span>)</span>
<span id="cb32-7"><a href="#cb32-7"></a></span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="co"># Estimate homicide density</span></span>
<span id="cb32-9"><a href="#cb32-9"></a>la_candelaria_homicide_density <span class="ot">&lt;-</span> medellin_homicides <span class="sc">|&gt;</span> </span>
<span id="cb32-10"><a href="#cb32-10"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:3115"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb32-11"><a href="#cb32-11"></a>  <span class="co"># Extract only those homicides occurring within the La Candelaria </span></span>
<span id="cb32-12"><a href="#cb32-12"></a>  <span class="co"># neighbourhood boundary (otherwise `hotspot_kde()` will be very slow)</span></span>
<span id="cb32-13"><a href="#cb32-13"></a>  <span class="fu">st_intersection</span>(la_candelaria) <span class="sc">|&gt;</span> </span>
<span id="cb32-14"><a href="#cb32-14"></a>  <span class="fu">hotspot_kde</span>(</span>
<span id="cb32-15"><a href="#cb32-15"></a>    <span class="at">grid =</span> <span class="fu">hotspot_grid</span>(la_candelaria, <span class="at">cell_size =</span> <span class="dv">100</span>), </span>
<span id="cb32-16"><a href="#cb32-16"></a>    <span class="at">bandwidth_adjust =</span> <span class="fl">0.33</span>,</span>
<span id="cb32-17"><a href="#cb32-17"></a>    <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb32-18"><a href="#cb32-18"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb32-19"><a href="#cb32-19"></a>  <span class="fu">st_intersection</span>(la_candelaria)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="co"># Get bus stop locations</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>bus_stops <span class="ot">&lt;-</span> la_candelaria <span class="sc">|&gt;</span> </span>
<span id="cb35-3"><a href="#cb35-3"></a>  <span class="co"># `opq()` needs longitude/latitude co-ordinates, so transform before </span></span>
<span id="cb35-4"><a href="#cb35-4"></a>  <span class="co"># calculating the bounding box</span></span>
<span id="cb35-5"><a href="#cb35-5"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-6"><a href="#cb35-6"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb35-7"><a href="#cb35-7"></a>  <span class="fu">opq</span>() <span class="sc">|&gt;</span> </span>
<span id="cb35-8"><a href="#cb35-8"></a>  <span class="co"># Define the features we want</span></span>
<span id="cb35-9"><a href="#cb35-9"></a>  <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"highway"</span>, <span class="at">value =</span> <span class="st">"bus_stop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-10"><a href="#cb35-10"></a>  <span class="co"># Download those features for that area</span></span>
<span id="cb35-11"><a href="#cb35-11"></a>  <span class="fu">osmdata_sf</span>()</span>
<span id="cb35-12"><a href="#cb35-12"></a></span>
<span id="cb35-13"><a href="#cb35-13"></a><span class="co"># Extract bus stop locations as points</span></span>
<span id="cb35-14"><a href="#cb35-14"></a>bus_stop_points <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb35-15"><a href="#cb35-15"></a>  <span class="fu">pluck</span>(bus_stops, <span class="st">"osm_points"</span>), </span>
<span id="cb35-16"><a href="#cb35-16"></a>  <span class="fu">st_centroid</span>(<span class="fu">pluck</span>(bus_stops, <span class="st">"osm_polygons"</span>))</span>
<span id="cb35-17"><a href="#cb35-17"></a>)</span>
<span id="cb35-18"><a href="#cb35-18"></a></span>
<span id="cb35-19"><a href="#cb35-19"></a><span class="co"># Plot map</span></span>
<span id="cb35-20"><a href="#cb35-20"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb35-21"><a href="#cb35-21"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb35-22"><a href="#cb35-22"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb35-23"><a href="#cb35-23"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb35-24"><a href="#cb35-24"></a>    <span class="at">data =</span> la_candelaria_homicide_density, </span>
<span id="cb35-25"><a href="#cb35-25"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span>, </span>
<span id="cb35-26"><a href="#cb35-26"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb35-27"><a href="#cb35-27"></a>  ) <span class="sc">+</span></span>
<span id="cb35-28"><a href="#cb35-28"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> la_candelaria, <span class="at">colour =</span> <span class="st">"grey40"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb35-29"><a href="#cb35-29"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bus_stop_points, <span class="at">colour =</span> <span class="st">"darkred"</span>) <span class="sc">+</span></span>
<span id="cb35-30"><a href="#cb35-30"></a>  <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb35-31"><a href="#cb35-31"></a>    <span class="at">direction =</span> <span class="dv">1</span>, </span>
<span id="cb35-32"><a href="#cb35-32"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(la_candelaria_homicide_density, <span class="st">"kde"</span>)),</span>
<span id="cb35-33"><a href="#cb35-33"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>)</span>
<span id="cb35-34"><a href="#cb35-34"></a>  ) <span class="sc">+</span></span>
<span id="cb35-35"><a href="#cb35-35"></a>  <span class="fu">labs</span>(</span>
<span id="cb35-36"><a href="#cb35-36"></a>    <span class="at">caption =</span> <span class="fu">str_glue</span>(</span>
<span id="cb35-37"><a href="#cb35-37"></a>      <span class="st">"Contains data from OpenStreetMap</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb35-38"><a href="#cb35-38"></a>      <span class="st">"Homicide data: Alcaldía de Medellín (CC-BY-SA)"</span></span>
<span id="cb35-39"><a href="#cb35-39"></a>    ),</span>
<span id="cb35-40"><a href="#cb35-40"></a>    <span class="at">fill =</span> <span class="st">"homicide</span><span class="sc">\n</span><span class="st">density"</span></span>
<span id="cb35-41"><a href="#cb35-41"></a>  ) <span class="sc">+</span></span>
<span id="cb35-42"><a href="#cb35-42"></a>  <span class="co"># We can add the `fixed_plot_aspect()` function to the `ggplot()` stack to</span></span>
<span id="cb35-43"><a href="#cb35-43"></a>  <span class="co"># force the map to be square, rather than a rectangle</span></span>
<span id="cb35-44"><a href="#cb35-44"></a>  <span class="fu">fixed_plot_aspect</span>() <span class="sc">+</span></span>
<span id="cb35-45"><a href="#cb35-45"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/osm-exercise5-solution-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From this map, it looks like homicides do not cluster particularly around bus stops. This would probably be welcome information for the city’s public transport managers.</p>
<div class="box notewell">
<p>Just as with other sources of map data, you are legally required to <a href="https://wiki.openstreetmap.org/wiki/Draft_Attribution_Guideline">cite data from OpenStreetMap</a> if you use it. The code in the exercise above, for example, cites data from two sources:</p>
<ul>
<li>“Contains data from OpenStreetMap” acknowledges that both the base map and the bus-stop locations were obtained from OpenStreetMap.</li>
<li>“Homicide data: Alcaldía de Medellín (CC-BY-SA)” acknowledges that the Medellin homicide data were released by the Mayor of Medellin under the <a href="https://opendefinition.org/licenses/cc-by-sa/">Creative Commons Attribution Share-alike</a> (CC-BY-SA) licence.</li>
</ul>
</div>
<p class="credits">
The OpenStreetMap logo is a trademark of the OpenStreetMap Foundation, and is used with their permission. This tutorial not endorsed by or affiliated with the OpenStreetMap Foundation.
</p>
</section>
<section id="in-summary" class="level2" data-number="10.6">
<h2 data-number="10.6" class="anchored" data-anchor-id="in-summary"><span class="header-section-number">10.6</span> In summary</h2>
<div class="box welldone">
<p>In this tutorial we have learned how to find open data, including data from OpenStreetMap, and add it to our maps to help readers better understand crime patterns. We will be able to use these skills to add data to future maps that we make so that readers can gain more insight into crime patterns or other phenomena that we might be analysing.</p>
</div>
<div class="box reading">
<p>To find out more about the skills we have worked on in this tutorial, you may want to read:</p>
<ul>
<li><a href="https://doi.org/10.1080/15230406.2014.972456">a paper exploring how open crime data can be used in researching crime</a>, and</li>
<li><a href="https://docs.ropensci.org/osmdata/articles/osmdata.html">a more-detailed introduction to the <code>osmdata</code> package written by Mark Padgham and Robin Lovelace</a>.</li>
</ul>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";
  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    btn.onclick = check_func;
    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../09_mapping_areas/index.html" class="pagination-link" aria-label="Mapping area data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Mapping area data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../11_mapping_hotspots/index.html" class="pagination-link" aria-label="Mapping hotspots">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb36" data-shortcodes="false" data-code-line-numbers=""><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb36-1"><a href="#cb36-1"></a><span class="co">---</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="co">  freeze: auto</span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="co">---</span></span>
<span id="cb36-5"><a href="#cb36-5"></a></span>
<span id="cb36-6"><a href="#cb36-6"></a></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="fu"># Using data about places {#sec-place-data}</span></span>
<span id="cb36-8"><a href="#cb36-8"></a></span>
<span id="cb36-9"><a href="#cb36-9"></a>**Learn how to find and use extra data about places to improve your maps, including open data and data from OpenStreetMap**</span>
<span id="cb36-10"><a href="#cb36-10"></a></span>
<span id="cb36-11"><a href="#cb36-11"></a>::: {.callout-important}</span>
<span id="cb36-12"><a href="#cb36-12"></a>This chapter has not yet been updated for 2025, so some material is out of date. Check back for an update in mid-February 2025.</span>
<span id="cb36-13"><a href="#cb36-13"></a>:::</span>
<span id="cb36-14"><a href="#cb36-14"></a></span>
<span id="cb36-15"><a href="#cb36-15"></a><span class="in">```{r setup, include=FALSE, cache=FALSE}</span></span>
<span id="cb36-16"><a href="#cb36-16"></a><span class="in">#| echo: false</span></span>
<span id="cb36-17"><a href="#cb36-17"></a><span class="in">#| include: false</span></span>
<span id="cb36-18"><a href="#cb36-18"></a></span>
<span id="cb36-19"><a href="#cb36-19"></a><span class="in">source(here::here("mask_learnr_functions.R"))</span></span>
<span id="cb36-20"><a href="#cb36-20"></a></span>
<span id="cb36-21"><a href="#cb36-21"></a><span class="in"># Load packages</span></span>
<span id="cb36-22"><a href="#cb36-22"></a><span class="in">library(ggspatial)</span></span>
<span id="cb36-23"><a href="#cb36-23"></a><span class="in">library(leaflet)</span></span>
<span id="cb36-24"><a href="#cb36-24"></a><span class="in">library(osmdata)</span></span>
<span id="cb36-25"><a href="#cb36-25"></a><span class="in">library(sf)</span></span>
<span id="cb36-26"><a href="#cb36-26"></a><span class="in">library(sfhotspot)</span></span>
<span id="cb36-27"><a href="#cb36-27"></a><span class="in">library(tidyverse)</span></span>
<span id="cb36-28"><a href="#cb36-28"></a></span>
<span id="cb36-29"><a href="#cb36-29"></a></span>
<span id="cb36-30"><a href="#cb36-30"></a><span class="in"># Load data --------------------------------------------------------------------</span></span>
<span id="cb36-31"><a href="#cb36-31"></a></span>
<span id="cb36-32"><a href="#cb36-32"></a><span class="in"># Neighbourhoods</span></span>
<span id="cb36-33"><a href="#cb36-33"></a><span class="in">medellin_comunas &lt;- read_sf("https://mpjashby.github.io/crimemappingdata/medellin_comunas.gpkg") |&gt; </span></span>
<span id="cb36-34"><a href="#cb36-34"></a><span class="in">  janitor::clean_names() |&gt; </span></span>
<span id="cb36-35"><a href="#cb36-35"></a><span class="in">  st_transform("EPSG:3115") |&gt; </span></span>
<span id="cb36-36"><a href="#cb36-36"></a><span class="in">  select(nombre, geom)</span></span>
<span id="cb36-37"><a href="#cb36-37"></a></span>
<span id="cb36-38"><a href="#cb36-38"></a><span class="in"># Homicides</span></span>
<span id="cb36-39"><a href="#cb36-39"></a><span class="in">medellin_homicides &lt;- read_csv2("https://mpjashby.github.io/crimemappingdata/medellin_homicides.csv") |&gt; </span></span>
<span id="cb36-40"><a href="#cb36-40"></a><span class="in">  remove_missing(vars = c("longitud", "latitud")) |&gt; </span></span>
<span id="cb36-41"><a href="#cb36-41"></a><span class="in">  st_as_sf(coords = c("longitud", "latitud"), crs = "EPSG:4326")</span></span>
<span id="cb36-42"><a href="#cb36-42"></a></span>
<span id="cb36-43"><a href="#cb36-43"></a><span class="in"># Metro lines</span></span>
<span id="cb36-44"><a href="#cb36-44"></a><span class="in">metro_lines_file &lt;- tempfile(fileext = ".zip")</span></span>
<span id="cb36-45"><a href="#cb36-45"></a><span class="in">download.file(</span></span>
<span id="cb36-46"><a href="#cb36-46"></a><span class="in">  url = "https://mpjashby.github.io/crimemappingdata/medellin_metro_lines.zip",</span></span>
<span id="cb36-47"><a href="#cb36-47"></a><span class="in">  destfile = metro_lines_file</span></span>
<span id="cb36-48"><a href="#cb36-48"></a><span class="in">)</span></span>
<span id="cb36-49"><a href="#cb36-49"></a><span class="in">unzip(metro_lines_file, exdir = tempdir())</span></span>
<span id="cb36-50"><a href="#cb36-50"></a><span class="in">medellin_metro_lines &lt;- tempdir() |&gt; </span></span>
<span id="cb36-51"><a href="#cb36-51"></a><span class="in">  str_glue("/medellin_metro_lines.shp") |&gt; </span></span>
<span id="cb36-52"><a href="#cb36-52"></a><span class="in">  read_sf()</span></span>
<span id="cb36-53"><a href="#cb36-53"></a></span>
<span id="cb36-54"><a href="#cb36-54"></a><span class="in"># Metro stations</span></span>
<span id="cb36-55"><a href="#cb36-55"></a><span class="in">medellin_metro_stns &lt;- read_csv("https://mpjashby.github.io/crimemappingdata/medellin_metro_stns.csv") |&gt; </span></span>
<span id="cb36-56"><a href="#cb36-56"></a><span class="in">  mutate(</span></span>
<span id="cb36-57"><a href="#cb36-57"></a><span class="in">    nombre = str_remove(str_remove(nombre, "Estación "), " \\(Línea \\w\\)")</span></span>
<span id="cb36-58"><a href="#cb36-58"></a><span class="in">  ) |&gt; </span></span>
<span id="cb36-59"><a href="#cb36-59"></a><span class="in">  group_by(nombre) |&gt; </span></span>
<span id="cb36-60"><a href="#cb36-60"></a><span class="in">  summarise(across(everything(), first)) |&gt; </span></span>
<span id="cb36-61"><a href="#cb36-61"></a><span class="in">  st_as_sf(coords = c("x", "y"), crs = "EPSG:4326", remove = FALSE)</span></span>
<span id="cb36-62"><a href="#cb36-62"></a></span>
<span id="cb36-63"><a href="#cb36-63"></a><span class="in"># Bus stops</span></span>
<span id="cb36-64"><a href="#cb36-64"></a><span class="in"># We are downloading this data direct from source for two reasons:</span></span>
<span id="cb36-65"><a href="#cb36-65"></a><span class="in">#   1. OSM is a live database and the results are likely to change over time.</span></span>
<span id="cb36-66"><a href="#cb36-66"></a><span class="in">#   2. The structure of the result object might change slightly, in which case</span></span>
<span id="cb36-67"><a href="#cb36-67"></a><span class="in">#      the tutorial should reflect what students will actually see.</span></span>
<span id="cb36-68"><a href="#cb36-68"></a><span class="in"># This obviously carries the risk that the data will stop being available or the</span></span>
<span id="cb36-69"><a href="#cb36-69"></a><span class="in"># API will be down when a student tries to use the tutorial.</span></span>
<span id="cb36-70"><a href="#cb36-70"></a><span class="in">la_candelaria_bbox &lt;- medellin_comunas |&gt; </span></span>
<span id="cb36-71"><a href="#cb36-71"></a><span class="in">  filter(nombre == "LA CANDELARIA") |&gt; </span></span>
<span id="cb36-72"><a href="#cb36-72"></a><span class="in">  st_transform("EPSG:4326") |&gt; </span></span>
<span id="cb36-73"><a href="#cb36-73"></a><span class="in">  st_bbox()</span></span>
<span id="cb36-74"><a href="#cb36-74"></a><span class="in">bus_stops &lt;- la_candelaria_bbox |&gt; </span></span>
<span id="cb36-75"><a href="#cb36-75"></a><span class="in">  opq() |&gt; </span></span>
<span id="cb36-76"><a href="#cb36-76"></a><span class="in">  add_osm_feature(key = "highway", value = "bus_stop") |&gt; </span></span>
<span id="cb36-77"><a href="#cb36-77"></a><span class="in">  osmdata_sf()</span></span>
<span id="cb36-78"><a href="#cb36-78"></a><span class="in">```</span></span>
<span id="cb36-79"><a href="#cb36-79"></a></span>
<span id="cb36-80"><a href="#cb36-80"></a></span>
<span id="cb36-81"><a href="#cb36-81"></a><span class="fu">## Introduction</span></span>
<span id="cb36-82"><a href="#cb36-82"></a></span>
<span id="cb36-83"><a href="#cb36-83"></a>The purpose of most crime maps is to help people make decisions, be they </span>
<span id="cb36-84"><a href="#cb36-84"></a>professionals working out how best to respond to crime problems or citizens</span>
<span id="cb36-85"><a href="#cb36-85"></a>holding local leaders to account. We can make it easier for people to make </span>
<span id="cb36-86"><a href="#cb36-86"></a>decisions by putting crime data into a relevant context. We have already started </span>
<span id="cb36-87"><a href="#cb36-87"></a>to do this by adding base maps, titles, legends and so on to our maps.</span>
<span id="cb36-88"><a href="#cb36-88"></a></span>
<span id="cb36-89"><a href="#cb36-89"></a>Since crime is concentrated in a few places, readers of our crime maps will </span>
<span id="cb36-90"><a href="#cb36-90"></a>often be interested in understanding what features of the environment are </span>
<span id="cb36-91"><a href="#cb36-91"></a>related to specific concentrations of crime in particular places. Where patterns </span>
<span id="cb36-92"><a href="#cb36-92"></a>of crime are related to particular facilities -- such as late-night violence </span>
<span id="cb36-93"><a href="#cb36-93"></a>being driven by the presence of bars selling alcohol -- it can be useful to </span>
<span id="cb36-94"><a href="#cb36-94"></a>highlight specific features on our maps.</span>
<span id="cb36-95"><a href="#cb36-95"></a></span>
<span id="cb36-96"><a href="#cb36-96"></a>As an example, imagine you are the manager responsible for security on the metro</span>
<span id="cb36-97"><a href="#cb36-97"></a>network in Medellin, Colombia. There are several mountains within Medellin, so </span>
<span id="cb36-98"><a href="#cb36-98"></a>the city metro network consists of both railway lines in the valley and cable </span>
<span id="cb36-99"><a href="#cb36-99"></a>cars up the mountains. The security manager for the metro company will certainly </span>
<span id="cb36-100"><a href="#cb36-100"></a>analyse violence on the company's stations and vehicles, but may also be </span>
<span id="cb36-101"><a href="#cb36-101"></a>interested in which stations are in neighbourhoods that themselves have high </span>
<span id="cb36-102"><a href="#cb36-102"></a>levels of violence.</span>
<span id="cb36-103"><a href="#cb36-103"></a></span>
<span id="cb36-104"><a href="#cb36-104"></a>To help with this, you might produce a map showing the density of homicides </span>
<span id="cb36-105"><a href="#cb36-105"></a>recorded by local police.</span>
<span id="cb36-106"><a href="#cb36-106"></a></span>
<span id="cb36-107"><a href="#cb36-107"></a><span class="in">```{r metro-homicides-map, eval=FALSE, echo=FALSE}</span></span>
<span id="cb36-108"><a href="#cb36-108"></a><span class="in">library(ggrepel)</span></span>
<span id="cb36-109"><a href="#cb36-109"></a></span>
<span id="cb36-110"><a href="#cb36-110"></a><span class="in">medellin_homicides_density &lt;- medellin_homicides |&gt; </span></span>
<span id="cb36-111"><a href="#cb36-111"></a><span class="in">  st_transform("EPSG:3115") |&gt; </span></span>
<span id="cb36-112"><a href="#cb36-112"></a><span class="in">  hotspot_kde(</span></span>
<span id="cb36-113"><a href="#cb36-113"></a><span class="in">    grid = hotspot_grid(medellin_comunas, cell_size = 150), </span></span>
<span id="cb36-114"><a href="#cb36-114"></a><span class="in">    bandwidth_adjust = 0.25</span></span>
<span id="cb36-115"><a href="#cb36-115"></a><span class="in">  ) |&gt; </span></span>
<span id="cb36-116"><a href="#cb36-116"></a><span class="in">  st_intersection(medellin_comunas)</span></span>
<span id="cb36-117"><a href="#cb36-117"></a></span>
<span id="cb36-118"><a href="#cb36-118"></a><span class="in">medellin_homicides_map1 &lt;- ggplot() +</span></span>
<span id="cb36-119"><a href="#cb36-119"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb36-120"><a href="#cb36-120"></a><span class="in">  geom_sf(</span></span>
<span id="cb36-121"><a href="#cb36-121"></a><span class="in">    data = medellin_comunas, </span></span>
<span id="cb36-122"><a href="#cb36-122"></a><span class="in">    colour = "grey70", </span></span>
<span id="cb36-123"><a href="#cb36-123"></a><span class="in">    fill = NA, </span></span>
<span id="cb36-124"><a href="#cb36-124"></a><span class="in">    linewidth = 0.5</span></span>
<span id="cb36-125"><a href="#cb36-125"></a><span class="in">  ) +</span></span>
<span id="cb36-126"><a href="#cb36-126"></a><span class="in">  geom_sf(</span></span>
<span id="cb36-127"><a href="#cb36-127"></a><span class="in">    aes(fill = kde), </span></span>
<span id="cb36-128"><a href="#cb36-128"></a><span class="in">    data = medellin_homicides_density, </span></span>
<span id="cb36-129"><a href="#cb36-129"></a><span class="in">    alpha = 0.75, </span></span>
<span id="cb36-130"><a href="#cb36-130"></a><span class="in">    colour = NA</span></span>
<span id="cb36-131"><a href="#cb36-131"></a><span class="in">  ) +</span></span>
<span id="cb36-132"><a href="#cb36-132"></a><span class="in">  annotation_scale(style = "ticks") +</span></span>
<span id="cb36-133"><a href="#cb36-133"></a><span class="in">  scale_fill_gradient(</span></span>
<span id="cb36-134"><a href="#cb36-134"></a><span class="in">    low = "white", </span></span>
<span id="cb36-135"><a href="#cb36-135"></a><span class="in">    high = "darkred",</span></span>
<span id="cb36-136"><a href="#cb36-136"></a><span class="in">    breaks = range(pull(medellin_homicides_density, "kde")),</span></span>
<span id="cb36-137"><a href="#cb36-137"></a><span class="in">    labels = c("lower", "higher")</span></span>
<span id="cb36-138"><a href="#cb36-138"></a><span class="in">  ) +</span></span>
<span id="cb36-139"><a href="#cb36-139"></a><span class="in">  scale_linetype_manual(values = c("Metro" = "solid", "Cable" = "12")) +</span></span>
<span id="cb36-140"><a href="#cb36-140"></a><span class="in">  lims(x = c(-75.65, -75.525), y = c(6.19, 6.325)) +</span></span>
<span id="cb36-141"><a href="#cb36-141"></a><span class="in">  coord_sf(crs = "EPSG:4326") +</span></span>
<span id="cb36-142"><a href="#cb36-142"></a><span class="in">  labs(</span></span>
<span id="cb36-143"><a href="#cb36-143"></a><span class="in">    title = "Parque Berrío and Prado stations are in homicide areas",</span></span>
<span id="cb36-144"><a href="#cb36-144"></a><span class="in">    subtitle = "number of homicides, 2010 to 2019",</span></span>
<span id="cb36-145"><a href="#cb36-145"></a><span class="in">    caption = "Map data from OpenStreetMap",</span></span>
<span id="cb36-146"><a href="#cb36-146"></a><span class="in">    fill = "density of\nhomicides",</span></span>
<span id="cb36-147"><a href="#cb36-147"></a><span class="in">    linetype = NULL</span></span>
<span id="cb36-148"><a href="#cb36-148"></a><span class="in">  ) +</span></span>
<span id="cb36-149"><a href="#cb36-149"></a><span class="in">  theme_void() +</span></span>
<span id="cb36-150"><a href="#cb36-150"></a><span class="in">  theme(</span></span>
<span id="cb36-151"><a href="#cb36-151"></a><span class="in">    legend.key.height = unit(0.4, "lines"),</span></span>
<span id="cb36-152"><a href="#cb36-152"></a><span class="in">    legend.key.width = unit(0.8, "lines"),</span></span>
<span id="cb36-153"><a href="#cb36-153"></a><span class="in">    legend.text = element_text(size = rel(0.7)),</span></span>
<span id="cb36-154"><a href="#cb36-154"></a><span class="in">    legend.title = element_text(size = rel(0.8)),</span></span>
<span id="cb36-155"><a href="#cb36-155"></a><span class="in">    plot.title = element_text(size = rel(0.9)),</span></span>
<span id="cb36-156"><a href="#cb36-156"></a><span class="in">    plot.subtitle = element_text(size = rel(0.8), margin = margin(3, 0, 6, 0)),</span></span>
<span id="cb36-157"><a href="#cb36-157"></a><span class="in">    plot.caption = element_text(colour = "grey67", size = rel(0.7), hjust = 0)</span></span>
<span id="cb36-158"><a href="#cb36-158"></a><span class="in">  )</span></span>
<span id="cb36-159"><a href="#cb36-159"></a></span>
<span id="cb36-160"><a href="#cb36-160"></a><span class="in">medellin_homicides_map2 &lt;- medellin_homicides_map1 +</span></span>
<span id="cb36-161"><a href="#cb36-161"></a><span class="in">  geom_sf(</span></span>
<span id="cb36-162"><a href="#cb36-162"></a><span class="in">    aes(linetype = sistema), </span></span>
<span id="cb36-163"><a href="#cb36-163"></a><span class="in">    data = medellin_metro_lines, </span></span>
<span id="cb36-164"><a href="#cb36-164"></a><span class="in">    colour = "grey40"</span></span>
<span id="cb36-165"><a href="#cb36-165"></a><span class="in">  ) +</span></span>
<span id="cb36-166"><a href="#cb36-166"></a><span class="in">  geom_sf(data = medellin_metro_stns, size = 1, colour = "grey40") +</span></span>
<span id="cb36-167"><a href="#cb36-167"></a><span class="in">  geom_label_repel(</span></span>
<span id="cb36-168"><a href="#cb36-168"></a><span class="in">    aes(x = x, y = y, label = nombre),</span></span>
<span id="cb36-169"><a href="#cb36-169"></a><span class="in">    data = filter(medellin_metro_stns, linea %in% c("A", "B")),</span></span>
<span id="cb36-170"><a href="#cb36-170"></a><span class="in">    alpha = 0.75,</span></span>
<span id="cb36-171"><a href="#cb36-171"></a><span class="in">    colour = "grey25",</span></span>
<span id="cb36-172"><a href="#cb36-172"></a><span class="in">    fill = "white",</span></span>
<span id="cb36-173"><a href="#cb36-173"></a><span class="in">    label.padding = unit(0.1, "lines"),</span></span>
<span id="cb36-174"><a href="#cb36-174"></a><span class="in">    label.size = NA,</span></span>
<span id="cb36-175"><a href="#cb36-175"></a><span class="in">    min.segment.length = 0,</span></span>
<span id="cb36-176"><a href="#cb36-176"></a><span class="in">    size = 2.2</span></span>
<span id="cb36-177"><a href="#cb36-177"></a><span class="in">  ) +</span></span>
<span id="cb36-178"><a href="#cb36-178"></a><span class="in">  coord_sf(crs = "EPSG:4326")</span></span>
<span id="cb36-179"><a href="#cb36-179"></a></span>
<span id="cb36-180"><a href="#cb36-180"></a><span class="in">ggsave(</span></span>
<span id="cb36-181"><a href="#cb36-181"></a><span class="in">  "inst/tutorials/10_place_data/images/medellin_homicides_map1.jpg",</span></span>
<span id="cb36-182"><a href="#cb36-182"></a><span class="in">  medellin_homicides_map1,</span></span>
<span id="cb36-183"><a href="#cb36-183"></a><span class="in">  units = "px",</span></span>
<span id="cb36-184"><a href="#cb36-184"></a><span class="in">  width = 1600,</span></span>
<span id="cb36-185"><a href="#cb36-185"></a><span class="in">  height = 1600</span></span>
<span id="cb36-186"><a href="#cb36-186"></a><span class="in">)</span></span>
<span id="cb36-187"><a href="#cb36-187"></a></span>
<span id="cb36-188"><a href="#cb36-188"></a><span class="in">ggsave(</span></span>
<span id="cb36-189"><a href="#cb36-189"></a><span class="in">  "inst/tutorials/10_place_data/images/medellin_homicides_map2.jpg",</span></span>
<span id="cb36-190"><a href="#cb36-190"></a><span class="in">  medellin_homicides_map2,</span></span>
<span id="cb36-191"><a href="#cb36-191"></a><span class="in">  units = "px",</span></span>
<span id="cb36-192"><a href="#cb36-192"></a><span class="in">  width = 1600,</span></span>
<span id="cb36-193"><a href="#cb36-193"></a><span class="in">  height = 1600</span></span>
<span id="cb36-194"><a href="#cb36-194"></a><span class="in">)</span></span>
<span id="cb36-195"><a href="#cb36-195"></a><span class="in">```</span></span>
<span id="cb36-196"><a href="#cb36-196"></a></span>
<span id="cb36-197"><a href="#cb36-197"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/medellin_homicides_map1.jpg" alt="Map of homicides in Medellin from 2010 to 2019" style="max-height: 600px;"&gt;&lt;/p&gt;</span>
<span id="cb36-198"><a href="#cb36-198"></a></span>
<span id="cb36-199"><a href="#cb36-199"></a>This is an acceptable crime map: it shows the data in a reasonable way, places </span>
<span id="cb36-200"><a href="#cb36-200"></a>the data layer at the top of the visual hierarchy and provides suitable context </span>
<span id="cb36-201"><a href="#cb36-201"></a>in the title, legend etc. But it is a much less useful map than it could be </span>
<span id="cb36-202"><a href="#cb36-202"></a>because it doesn't show where the metro stations are and this information is not</span>
<span id="cb36-203"><a href="#cb36-203"></a>included in the base map. A much better map would add extra layers of data </span>
<span id="cb36-204"><a href="#cb36-204"></a>showing the metro stations and the line connecting them.</span>
<span id="cb36-205"><a href="#cb36-205"></a></span>
<span id="cb36-206"><a href="#cb36-206"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/medellin_homicides_map2.jpg" alt="Map of homicides in Medellin from 2010 to 2019 with metro stations and lines highlighted" style="max-height: 600px;"&gt;&lt;/p&gt;</span>
<span id="cb36-207"><a href="#cb36-207"></a></span>
<span id="cb36-208"><a href="#cb36-208"></a>From this second map, it is much easier to see that Parque Berrío and Prado </span>
<span id="cb36-209"><a href="#cb36-209"></a>stations are closest to an area with relatively high numbers of homicides.</span>
<span id="cb36-210"><a href="#cb36-210"></a></span>
<span id="cb36-211"><a href="#cb36-211"></a>In this tutorial we will learn how to find relevant data about places and add</span>
<span id="cb36-212"><a href="#cb36-212"></a>extra layers to our maps to help readers understand the context within which</span>
<span id="cb36-213"><a href="#cb36-213"></a>crimes occur. </span>
<span id="cb36-214"><a href="#cb36-214"></a></span>
<span id="cb36-215"><a href="#cb36-215"></a>To get started, watch this video that walks through the code needed to download </span>
<span id="cb36-216"><a href="#cb36-216"></a>data from OpenStreetMap for use on our maps.</span>
<span id="cb36-217"><a href="#cb36-217"></a></span>
<span id="cb36-218"><a href="#cb36-218"></a>{{&lt; video https://youtu.be/kcpiH6dDWLE &gt;}}</span>
<span id="cb36-219"><a href="#cb36-219"></a></span>
<span id="cb36-220"><a href="#cb36-220"></a></span>
<span id="cb36-221"><a href="#cb36-221"></a></span>
<span id="cb36-222"><a href="#cb36-222"></a><span class="fu">## Loading CSV data</span></span>
<span id="cb36-223"><a href="#cb36-223"></a></span>
<span id="cb36-224"><a href="#cb36-224"></a>Throughout this tutorial, we will use homicides in the Colombian city of </span>
<span id="cb36-225"><a href="#cb36-225"></a>Medellin as an example. Data on the locations of homicides in Medellin from 2010 </span>
<span id="cb36-226"><a href="#cb36-226"></a>to 2019 is available at </span>
<span id="cb36-227"><a href="#cb36-227"></a><span class="in">`https://mpjashby.github.io/crimemappingdata/medellin_homicides.csv`</span>. </span>
<span id="cb36-228"><a href="#cb36-228"></a></span>
<span id="cb36-229"><a href="#cb36-229"></a>In previous tutorials, we have used the <span class="in">`read_csv()`</span> function from the <span class="in">`readr`</span></span>
<span id="cb36-230"><a href="#cb36-230"></a>package to load data from CSV files. The <span class="in">`read_csv()`</span> function assumes that (as</span>
<span id="cb36-231"><a href="#cb36-231"></a>the name 'comma-separated values' suggests) the columns in a CSV file are</span>
<span id="cb36-232"><a href="#cb36-232"></a>separated by commas (<span class="in">`,`</span>). But not all countries use commas as the column </span>
<span id="cb36-233"><a href="#cb36-233"></a>separator in CSV files: some countries use semi-colons (<span class="in">`;`</span>) instead. This is</span>
<span id="cb36-234"><a href="#cb36-234"></a>usually because those countries also use commas instead of periods as the </span>
<span id="cb36-235"><a href="#cb36-235"></a>decimal separator inside numbers (so that the number three-point-one-four is</span>
<span id="cb36-236"><a href="#cb36-236"></a>written <span class="in">`3,14`</span> instead of <span class="in">`3.14`</span> as in English). If commas are used as decimal </span>
<span id="cb36-237"><a href="#cb36-237"></a>separators in numbers in a file, commas cannot also be used to separate columns </span>
<span id="cb36-238"><a href="#cb36-238"></a>from one another -- otherwise there would be no way to know if a comma </span>
<span id="cb36-239"><a href="#cb36-239"></a>represented the decimal mark in a number or the boundary between two columns.</span>
<span id="cb36-240"><a href="#cb36-240"></a></span>
<span id="cb36-241"><a href="#cb36-241"></a>If we try to load a CSV file that uses semi-colon separators using the </span>
<span id="cb36-242"><a href="#cb36-242"></a><span class="in">`read_csv()`</span> function, all the data on each row will be loaded as a single</span>
<span id="cb36-243"><a href="#cb36-243"></a>column:</span>
<span id="cb36-244"><a href="#cb36-244"></a></span>
<span id="cb36-245"><a href="#cb36-245"></a><span class="in">```{r intro-exercise1, exercise=TRUE}</span></span>
<span id="cb36-246"><a href="#cb36-246"></a><span class="in">library(tidyverse)</span></span>
<span id="cb36-247"><a href="#cb36-247"></a></span>
<span id="cb36-248"><a href="#cb36-248"></a><span class="in">medellin_homicides &lt;- read_csv("https://mpjashby.github.io/crimemappingdata/medellin_homicides.csv")</span></span>
<span id="cb36-249"><a href="#cb36-249"></a></span>
<span id="cb36-250"><a href="#cb36-250"></a><span class="in">head(medellin_homicides)</span></span>
<span id="cb36-251"><a href="#cb36-251"></a><span class="in">```</span></span>
<span id="cb36-252"><a href="#cb36-252"></a></span>
<span id="cb36-253"><a href="#cb36-253"></a>This is obviously not what we want, so we need to use a different function to</span>
<span id="cb36-254"><a href="#cb36-254"></a>load this data. Fortunately, the <span class="in">`readr`</span> package has another function that can</span>
<span id="cb36-255"><a href="#cb36-255"></a>handle CSV files created using the conventions of countries that use semi colons</span>
<span id="cb36-256"><a href="#cb36-256"></a>to separate columns: <span class="in">`read_csv2()`</span>.</span>
<span id="cb36-257"><a href="#cb36-257"></a></span>
<span id="cb36-258"><a href="#cb36-258"></a>How should you know when to use <span class="in">`read_csv2()`</span> rather than <span class="in">`read_csv()`</span>? If you</span>
<span id="cb36-259"><a href="#cb36-259"></a>don't know whether a file uses commas or semi colons to separate columns, the </span>
<span id="cb36-260"><a href="#cb36-260"></a>easiest thing is probably to use <span class="in">`read_csv()`</span> first. Now load the file and</span>
<span id="cb36-261"><a href="#cb36-261"></a>use <span class="in">`head()`</span> to look at the first few rows: if you see all the data has</span>
<span id="cb36-262"><a href="#cb36-262"></a>appeared in a single column that contains several semi colons, then you'll know</span>
<span id="cb36-263"><a href="#cb36-263"></a>to change your code to use <span class="in">`read_csv2()`</span> instead.</span>
<span id="cb36-264"><a href="#cb36-264"></a></span>
<span id="cb36-265"><a href="#cb36-265"></a>For this dataset, if you load it with <span class="in">`read_csv2()`</span> you should find that the</span>
<span id="cb36-266"><a href="#cb36-266"></a>structure of the data is more as you'd expect it to be.</span>
<span id="cb36-267"><a href="#cb36-267"></a></span>
<span id="cb36-268"><a href="#cb36-268"></a><span class="in">```{r intro-exercise2, exercise=TRUE}</span></span>
<span id="cb36-269"><a href="#cb36-269"></a><span class="in">medellin_homicides &lt;- read_csv2("https://mpjashby.github.io/crimemappingdata/medellin_homicides.csv")</span></span>
<span id="cb36-270"><a href="#cb36-270"></a></span>
<span id="cb36-271"><a href="#cb36-271"></a><span class="in">head(medellin_homicides)</span></span>
<span id="cb36-272"><a href="#cb36-272"></a><span class="in">```</span></span>
<span id="cb36-273"><a href="#cb36-273"></a></span>
<span id="cb36-274"><a href="#cb36-274"></a>In the rest of this tutorial we will use data from different sources to better</span>
<span id="cb36-275"><a href="#cb36-275"></a>understand clusters of homicides in the La Candelaria neighbourhood of downtown </span>
<span id="cb36-276"><a href="#cb36-276"></a>Medellin. </span>
<span id="cb36-277"><a href="#cb36-277"></a></span>
<span id="cb36-278"><a href="#cb36-278"></a><span class="co">&lt;!--</span></span>
<span id="cb36-279"><a href="#cb36-279"></a></span>
<span id="cb36-280"><a href="#cb36-280"></a><span class="co">Use this map (created with the `leaflet` package) to look around the</span></span>
<span id="cb36-281"><a href="#cb36-281"></a><span class="co">La Candelaria neighbourhood -- the markers show the locations of the metro</span></span>
<span id="cb36-282"><a href="#cb36-282"></a><span class="co">stations inside the neighbourhood boundary.</span></span>
<span id="cb36-283"><a href="#cb36-283"></a></span>
<span id="cb36-284"><a href="#cb36-284"></a><span class="co">--&gt;</span></span>
<span id="cb36-285"><a href="#cb36-285"></a></span>
<span id="cb36-286"><a href="#cb36-286"></a></span>
<span id="cb36-287"><a href="#cb36-287"></a><span class="in">```{r lacandelaria-map, message=FALSE, warning=FALSE, fig.asp=1, out.width="100%", eval=FALSE, echo=FALSE}</span></span>
<span id="cb36-288"><a href="#cb36-288"></a><span class="in">la_candelaria &lt;- medellin_comunas |&gt; </span></span>
<span id="cb36-289"><a href="#cb36-289"></a><span class="in">  filter(nombre == "LA CANDELARIA") |&gt; </span></span>
<span id="cb36-290"><a href="#cb36-290"></a><span class="in">  st_transform("EPSG:4326") |&gt; </span></span>
<span id="cb36-291"><a href="#cb36-291"></a><span class="in">  mutate(nombre = str_to_title(nombre))</span></span>
<span id="cb36-292"><a href="#cb36-292"></a></span>
<span id="cb36-293"><a href="#cb36-293"></a><span class="in">la_candelaria_bbox &lt;- st_bbox(la_candelaria)</span></span>
<span id="cb36-294"><a href="#cb36-294"></a></span>
<span id="cb36-295"><a href="#cb36-295"></a><span class="in">centro_metro_stns &lt;- medellin_metro_stns |&gt; </span></span>
<span id="cb36-296"><a href="#cb36-296"></a><span class="in">  st_intersection(la_candelaria) |&gt; </span></span>
<span id="cb36-297"><a href="#cb36-297"></a><span class="in">  mutate(nombre = str_glue("{nombre} {str_to_lower(sistema)} station"))</span></span>
<span id="cb36-298"><a href="#cb36-298"></a></span>
<span id="cb36-299"><a href="#cb36-299"></a><span class="in">leaflet() |&gt; </span></span>
<span id="cb36-300"><a href="#cb36-300"></a><span class="in">  fitBounds(</span></span>
<span id="cb36-301"><a href="#cb36-301"></a><span class="in">    lng1 = pluck(la_candelaria_bbox, "xmin"), </span></span>
<span id="cb36-302"><a href="#cb36-302"></a><span class="in">    lat1 = pluck(la_candelaria_bbox, "ymin"), </span></span>
<span id="cb36-303"><a href="#cb36-303"></a><span class="in">    lng2 = pluck(la_candelaria_bbox, "xmax"), </span></span>
<span id="cb36-304"><a href="#cb36-304"></a><span class="in">    lat2 = pluck(la_candelaria_bbox, "ymax")</span></span>
<span id="cb36-305"><a href="#cb36-305"></a><span class="in">  ) |&gt; </span></span>
<span id="cb36-306"><a href="#cb36-306"></a><span class="in">  addProviderTiles(provider = "Esri.WorldStreetMap") |&gt;</span></span>
<span id="cb36-307"><a href="#cb36-307"></a><span class="in">  addPolygons(</span></span>
<span id="cb36-308"><a href="#cb36-308"></a><span class="in">    data = la_candelaria,</span></span>
<span id="cb36-309"><a href="#cb36-309"></a><span class="in">    color = "darkblue",</span></span>
<span id="cb36-310"><a href="#cb36-310"></a><span class="in">    fill = NA</span></span>
<span id="cb36-311"><a href="#cb36-311"></a><span class="in">  ) |&gt; </span></span>
<span id="cb36-312"><a href="#cb36-312"></a><span class="in">  addPolylines(</span></span>
<span id="cb36-313"><a href="#cb36-313"></a><span class="in">    data = medellin_metro_lines, </span></span>
<span id="cb36-314"><a href="#cb36-314"></a><span class="in">    color = "black", </span></span>
<span id="cb36-315"><a href="#cb36-315"></a><span class="in">    opacity = 1, </span></span>
<span id="cb36-316"><a href="#cb36-316"></a><span class="in">    weight = 2</span></span>
<span id="cb36-317"><a href="#cb36-317"></a><span class="in">  ) |&gt; </span></span>
<span id="cb36-318"><a href="#cb36-318"></a><span class="in">  addCircleMarkers(</span></span>
<span id="cb36-319"><a href="#cb36-319"></a><span class="in">    data = medellin_metro_stns, </span></span>
<span id="cb36-320"><a href="#cb36-320"></a><span class="in">    color = NA, </span></span>
<span id="cb36-321"><a href="#cb36-321"></a><span class="in">    fill = "black", </span></span>
<span id="cb36-322"><a href="#cb36-322"></a><span class="in">    fillOpacity = 1, </span></span>
<span id="cb36-323"><a href="#cb36-323"></a><span class="in">    radius = 3</span></span>
<span id="cb36-324"><a href="#cb36-324"></a><span class="in">  ) |&gt; </span></span>
<span id="cb36-325"><a href="#cb36-325"></a><span class="in">  addMarkers(</span></span>
<span id="cb36-326"><a href="#cb36-326"></a><span class="in">    data = centro_metro_stns, </span></span>
<span id="cb36-327"><a href="#cb36-327"></a><span class="in">    label = ~ htmltools::htmlEscape(nombre),</span></span>
<span id="cb36-328"><a href="#cb36-328"></a><span class="in">    labelOptions = labelOptions(textsize = "16px")</span></span>
<span id="cb36-329"><a href="#cb36-329"></a><span class="in">  ) |&gt; </span></span>
<span id="cb36-330"><a href="#cb36-330"></a><span class="in">  addMiniMap(zoomLevelOffset = -3, toggleDisplay = TRUE)</span></span>
<span id="cb36-331"><a href="#cb36-331"></a><span class="in">```</span></span>
<span id="cb36-332"><a href="#cb36-332"></a></span>
<span id="cb36-333"><a href="#cb36-333"></a></span>
<span id="cb36-334"><a href="#cb36-334"></a></span>
<span id="cb36-335"><a href="#cb36-335"></a><span class="fu">### Check your understanding {.tutorial}</span></span>
<span id="cb36-336"><a href="#cb36-336"></a></span>
<span id="cb36-337"><a href="#cb36-337"></a><span class="in">```{r intro-quiz}</span></span>
<span id="cb36-338"><a href="#cb36-338"></a><span class="in">quiz(</span></span>
<span id="cb36-339"><a href="#cb36-339"></a><span class="in">  caption = "",</span></span>
<span id="cb36-340"><a href="#cb36-340"></a><span class="in">  </span></span>
<span id="cb36-341"><a href="#cb36-341"></a><span class="in">  question(</span></span>
<span id="cb36-342"><a href="#cb36-342"></a><span class="in">    "Which function should you use to load a CSV file of crime locations that uses semi-colons to separate the columns?",</span></span>
<span id="cb36-343"><a href="#cb36-343"></a><span class="in">    answer("`read_csv2()` from the `readr` package", correct = TRUE),</span></span>
<span id="cb36-344"><a href="#cb36-344"></a><span class="in">    answer(</span></span>
<span id="cb36-345"><a href="#cb36-345"></a><span class="in">      "`read_csv()` from the `readr` package",</span></span>
<span id="cb36-346"><a href="#cb36-346"></a><span class="in">      message = "`read_csv()` is used to load CSV files that use commas to separate columns."</span></span>
<span id="cb36-347"><a href="#cb36-347"></a><span class="in">    ),</span></span>
<span id="cb36-348"><a href="#cb36-348"></a><span class="in">    answer(</span></span>
<span id="cb36-349"><a href="#cb36-349"></a><span class="in">      "`read.csv2()` from the `base` package",</span></span>
<span id="cb36-350"><a href="#cb36-350"></a><span class="in">      message = "While the `read.csv2()` function from the `base` package will load CSV files that use semi-colons to separate columns, it is better to use a function from the `readr` package so that the loaded data will be in a tibble rather than a data frame, and so that text values will not be silently changed to categorical values."</span></span>
<span id="cb36-351"><a href="#cb36-351"></a><span class="in">    ),</span></span>
<span id="cb36-352"><a href="#cb36-352"></a><span class="in">    answer(</span></span>
<span id="cb36-353"><a href="#cb36-353"></a><span class="in">      "`read_sf()` or `st_read()` from the `sf` package",</span></span>
<span id="cb36-354"><a href="#cb36-354"></a><span class="in">      message = "CSV is not a spatial file format (even when it contains columns that represent co-ordinates), so it is best not to load them with functions from the `sf` package (which expect to handle spatial file formats). While `read_sf()` and `st_read()` can open CSV files, both functions assume all the columns contain text values, meaning you then have to use another function to convert column values to numbers, dates, etc."</span></span>
<span id="cb36-355"><a href="#cb36-355"></a><span class="in">    ),</span></span>
<span id="cb36-356"><a href="#cb36-356"></a><span class="in">    correct = random_praise(),</span></span>
<span id="cb36-357"><a href="#cb36-357"></a><span class="in">    allow_retry = TRUE,</span></span>
<span id="cb36-358"><a href="#cb36-358"></a><span class="in">    random_answer_order = TRUE</span></span>
<span id="cb36-359"><a href="#cb36-359"></a><span class="in">  )</span></span>
<span id="cb36-360"><a href="#cb36-360"></a><span class="in">  </span></span>
<span id="cb36-361"><a href="#cb36-361"></a><span class="in">)</span></span>
<span id="cb36-362"><a href="#cb36-362"></a><span class="in">```</span></span>
<span id="cb36-363"><a href="#cb36-363"></a></span>
<span id="cb36-364"><a href="#cb36-364"></a></span>
<span id="cb36-365"><a href="#cb36-365"></a><span class="fu">## Finding data</span></span>
<span id="cb36-366"><a href="#cb36-366"></a></span>
<span id="cb36-367"><a href="#cb36-367"></a>If you are producing crime maps on behalf of a particular organisation such as</span>
<span id="cb36-368"><a href="#cb36-368"></a>a police agency or a body responsible for managing a place, it is likely that</span>
<span id="cb36-369"><a href="#cb36-369"></a>they will hold spatial data that is relevant to the local area. For example, </span>
<span id="cb36-370"><a href="#cb36-370"></a>many city governments will hold records of local businesses. It will sometimes</span>
<span id="cb36-371"><a href="#cb36-371"></a>be necessary to track down which department or individual holds this data, and</span>
<span id="cb36-372"><a href="#cb36-372"></a>it may also be necessary to convert data into formats that are useful for </span>
<span id="cb36-373"><a href="#cb36-373"></a>spatial analysis.</span>
<span id="cb36-374"><a href="#cb36-374"></a></span>
<span id="cb36-375"><a href="#cb36-375"></a>Some organisations may also have agreements to share data with others. For </span>
<span id="cb36-376"><a href="#cb36-376"></a>example, both universities and public agencies such as police forces in the</span>
<span id="cb36-377"><a href="#cb36-377"></a>United Kingdom have agreements with the national mapping agency Ordnance Survey</span>
<span id="cb36-378"><a href="#cb36-378"></a>to share a wide variety of spatial data. If you are producing maps on behalf of</span>
<span id="cb36-379"><a href="#cb36-379"></a>an organisation, it will often be useful to ask what data they hold that might</span>
<span id="cb36-380"><a href="#cb36-380"></a>be relevant, or ask for a specific dataset you think would help improve a map.</span>
<span id="cb36-381"><a href="#cb36-381"></a></span>
<span id="cb36-382"><a href="#cb36-382"></a></span>
<span id="cb36-383"><a href="#cb36-383"></a><span class="fu">### Open data</span></span>
<span id="cb36-384"><a href="#cb36-384"></a></span>
<span id="cb36-385"><a href="#cb36-385"></a>*Open data* is data that is released by organisations or individuals that can be</span>
<span id="cb36-386"><a href="#cb36-386"></a>freely used by others. Organisations such as local governments increasingly</span>
<span id="cb36-387"><a href="#cb36-387"></a>release data about their areas as open data -- almost all of the data we have</span>
<span id="cb36-388"><a href="#cb36-388"></a>used so far in this course is open data released by different local and national</span>
<span id="cb36-389"><a href="#cb36-389"></a>governments.</span>
<span id="cb36-390"><a href="#cb36-390"></a></span>
<span id="cb36-391"><a href="#cb36-391"></a>Open data is extremely useful because you can skip the often lengthy and painful</span>
<span id="cb36-392"><a href="#cb36-392"></a>process of getting access to data and wrangling it into a format you can use. </span>
<span id="cb36-393"><a href="#cb36-393"></a>This means you can move on much more quickly to analysing data, reaching</span>
<span id="cb36-394"><a href="#cb36-394"></a>conclusions and making decisions. Watch this video to find out more about the</span>
<span id="cb36-395"><a href="#cb36-395"></a>value of open data.</span>
<span id="cb36-396"><a href="#cb36-396"></a></span>
<span id="cb36-397"><a href="#cb36-397"></a>{{&lt; video https://youtu.be/bwX5MAZ6zKI &gt;}}</span>
<span id="cb36-398"><a href="#cb36-398"></a></span>
<span id="cb36-399"><a href="#cb36-399"></a>Open data is published in a wide variety of formats and distributed in different</span>
<span id="cb36-400"><a href="#cb36-400"></a>ways. Some data might only be distributed by an organisation sending you a DVD</span>
<span id="cb36-401"><a href="#cb36-401"></a>or memory stick. Most of the time, however, data will be released online.</span>
<span id="cb36-402"><a href="#cb36-402"></a></span>
<span id="cb36-403"><a href="#cb36-403"></a>Many cities (especially but not only in developed countries) now maintain </span>
<span id="cb36-404"><a href="#cb36-404"></a>open-data websites that act as a repository for all their open data. For </span>
<span id="cb36-405"><a href="#cb36-405"></a>example, the City of Bristol in England publishes the </span>
<span id="cb36-406"><a href="#cb36-406"></a><span class="co">[</span><span class="ot">Open Data Bristol website</span><span class="co">](https://opendata.bristol.gov.uk/pages/homepage/)</span>.</span>
<span id="cb36-407"><a href="#cb36-407"></a>Anyone can use this website to download data on everything from population</span>
<span id="cb36-408"><a href="#cb36-408"></a>estimates to politicians' expenses. Many of these datasets can be useful for</span>
<span id="cb36-409"><a href="#cb36-409"></a>crime mapping. For example, you can download the locations of</span>
<span id="cb36-410"><a href="#cb36-410"></a><span class="co">[</span><span class="ot">CCTV cameras</span><span class="co">](https://opendata.bristol.gov.uk/explore/dataset/council-cctv-cameras/information/)</span></span>
<span id="cb36-411"><a href="#cb36-411"></a>(useful in criminal investigations),</span>
<span id="cb36-412"><a href="#cb36-412"></a><span class="co">[</span><span class="ot">street lights</span><span class="co">](https://opendata.bristol.gov.uk/explore/dataset/streetlights-and-street-furniture/information/)</span></span>
<span id="cb36-413"><a href="#cb36-413"></a>(relevant to designing out crime) and the <span class="co">[</span><span class="ot">catchment areas of secondary schools</span><span class="co">](https://opendata.bristol.gov.uk/explore/dataset/secondary-school-areas-of-first-priority/information/)</span></span>
<span id="cb36-414"><a href="#cb36-414"></a>(helpful if a crime-prevention strategy includes visits to schools).</span>
<span id="cb36-415"><a href="#cb36-415"></a></span>
<span id="cb36-416"><a href="#cb36-416"></a>Different local governments may use different terms for the same types of </span>
<span id="cb36-417"><a href="#cb36-417"></a>information, so it sometimes takes some trial and error to find if a particular</span>
<span id="cb36-418"><a href="#cb36-418"></a>dataset is available. Some data might also be held by organisations other than</span>
<span id="cb36-419"><a href="#cb36-419"></a>the main local government agency for a particular place. For example, data on</span>
<span id="cb36-420"><a href="#cb36-420"></a>the locations of electricity substations (useful if you are trying to prevent</span>
<span id="cb36-421"><a href="#cb36-421"></a>metal thefts from infrastructure networks) might be held by a power company. All</span>
<span id="cb36-422"><a href="#cb36-422"></a>this means that tracking down a particular dataset might require some detective</span>
<span id="cb36-423"><a href="#cb36-423"></a>work.</span>
<span id="cb36-424"><a href="#cb36-424"></a></span>
<span id="cb36-425"><a href="#cb36-425"></a>To try to make this process easier, some countries have established national</span>
<span id="cb36-426"><a href="#cb36-426"></a>open-data portals such as </span>
<span id="cb36-427"><a href="#cb36-427"></a><span class="co">[</span><span class="ot">Open Data in Canada</span><span class="co">](https://open.canada.ca/en/open-data/)</span>, </span>
<span id="cb36-428"><a href="#cb36-428"></a><span class="co">[</span><span class="ot">Open Government India</span><span class="co">](https://data.gov.in/)</span>,</span>
<span id="cb36-429"><a href="#cb36-429"></a><span class="co">[</span><span class="ot">data.gov.uk in the United Kingdom</span><span class="co">](https://data.gov.uk/)</span> </span>
<span id="cb36-430"><a href="#cb36-430"></a>and <span class="co">[</span><span class="ot">data.gov in the United States</span><span class="co">](https://www.data.gov/)</span>. There are also</span>
<span id="cb36-431"><a href="#cb36-431"></a>international repositories such as the </span>
<span id="cb36-432"><a href="#cb36-432"></a><span class="co">[</span><span class="ot">African Development Bank Data Portal</span><span class="co">](https://dataportal.opendataforafrica.org/)</span>,</span>
<span id="cb36-433"><a href="#cb36-433"></a><span class="co">[</span><span class="ot">openAfrica</span><span class="co">](https://africaopendata.org/)</span>, the </span>
<span id="cb36-434"><a href="#cb36-434"></a><span class="co">[</span><span class="ot">Open Data Network</span><span class="co">](http://www.opendatanetwork.com/)</span> and </span>
<span id="cb36-435"><a href="#cb36-435"></a><span class="co">[</span><span class="ot">Data Portals</span><span class="co">](https://dataportals.org/)</span>, which seeks to list all the open data</span>
<span id="cb36-436"><a href="#cb36-436"></a>portals run by different governments and other organisations.</span>
<span id="cb36-437"><a href="#cb36-437"></a></span>
<span id="cb36-438"><a href="#cb36-438"></a></span>
<span id="cb36-439"><a href="#cb36-439"></a><span class="fu">### Citing data</span></span>
<span id="cb36-440"><a href="#cb36-440"></a></span>
<span id="cb36-441"><a href="#cb36-441"></a>Organisations that provide data often do so on condition that users of the data</span>
<span id="cb36-442"><a href="#cb36-442"></a>follow certain rules. For example, you can use data on the Open Data Bristol </span>
<span id="cb36-443"><a href="#cb36-443"></a>website as long as you follow the conditions of the </span>
<span id="cb36-444"><a href="#cb36-444"></a><span class="co">[</span><span class="ot">Open Government Licence</span><span class="co">](http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/)</span>.</span>
<span id="cb36-445"><a href="#cb36-445"></a>The most-common requirement of an open-data licence is that anyone using the </span>
<span id="cb36-446"><a href="#cb36-446"></a>data acknowledges the data source in any maps, reports or other outputs they </span>
<span id="cb36-447"><a href="#cb36-447"></a>produce. In the case of the Open Government Licence, users of the data are </span>
<span id="cb36-448"><a href="#cb36-448"></a>required to add a declaration to any outputs declaring:</span>
<span id="cb36-449"><a href="#cb36-449"></a></span>
<span id="cb36-450"><a href="#cb36-450"></a><span class="at">&gt; Contains public sector information licensed under the Open Government Licence</span></span>
<span id="cb36-451"><a href="#cb36-451"></a><span class="at">&gt; v3.0.</span></span>
<span id="cb36-452"><a href="#cb36-452"></a></span>
<span id="cb36-453"><a href="#cb36-453"></a>Complying with open-data licences is a legal requirement, so it is important to</span>
<span id="cb36-454"><a href="#cb36-454"></a>make sure you understand what obligations you are accepting when you use a </span>
<span id="cb36-455"><a href="#cb36-455"></a>particular dataset. You can typically find the conditions for using a dataset on</span>
<span id="cb36-456"><a href="#cb36-456"></a>the website that you download the data from. If you are required to add an</span>
<span id="cb36-457"><a href="#cb36-457"></a>attribution statement to your maps, a good place to do this is by adding it to</span>
<span id="cb36-458"><a href="#cb36-458"></a>any other information you place in the <span class="in">`caption`</span> argument of the <span class="in">`labs()`</span> </span>
<span id="cb36-459"><a href="#cb36-459"></a>function in a <span class="in">`ggplot()`</span> stack.</span>
<span id="cb36-460"><a href="#cb36-460"></a></span>
<span id="cb36-461"><a href="#cb36-461"></a></span>
<span id="cb36-462"><a href="#cb36-462"></a><span class="fu">### Check your understanding {.tutorial}</span></span>
<span id="cb36-463"><a href="#cb36-463"></a></span>
<span id="cb36-464"><a href="#cb36-464"></a><span class="in">```{r open-data-quiz}</span></span>
<span id="cb36-465"><a href="#cb36-465"></a><span class="in">quiz(</span></span>
<span id="cb36-466"><a href="#cb36-466"></a><span class="in">  caption = "",</span></span>
<span id="cb36-467"><a href="#cb36-467"></a><span class="in">  </span></span>
<span id="cb36-468"><a href="#cb36-468"></a><span class="in">  question(</span></span>
<span id="cb36-469"><a href="#cb36-469"></a><span class="in">    "Which one of these statements about open data is true?",</span></span>
<span id="cb36-470"><a href="#cb36-470"></a><span class="in">    answer("We can use open data for any purpose as long as we comply with the requirements of the licence the data is released under.", correct = TRUE),</span></span>
<span id="cb36-471"><a href="#cb36-471"></a><span class="in">    answer(</span></span>
<span id="cb36-472"><a href="#cb36-472"></a><span class="in">      "We can use open data for any purpose -- there is no need to acknowledge the source of the data.",</span></span>
<span id="cb36-473"><a href="#cb36-473"></a><span class="in">      message = "While we can often use open data for almost any purpose, it is important to comply with the requirements of the licence the data was released under. Most open-data licences include a requriement to acknowledge the source of the data."</span></span>
<span id="cb36-474"><a href="#cb36-474"></a><span class="in">    ),</span></span>
<span id="cb36-475"><a href="#cb36-475"></a><span class="in">    answer(</span></span>
<span id="cb36-476"><a href="#cb36-476"></a><span class="in">      "We can use open data, but only for non-commercial purposes.",</span></span>
<span id="cb36-477"><a href="#cb36-477"></a><span class="in">      message = "Most open data licences allow us to use data for both commercial and non-commercial purposes, as long as we comply with the other requirements of the licence -- most often this includes a requriement to acknowledge the source of the data."</span></span>
<span id="cb36-478"><a href="#cb36-478"></a><span class="in">    ),</span></span>
<span id="cb36-479"><a href="#cb36-479"></a><span class="in">    answer(</span></span>
<span id="cb36-480"><a href="#cb36-480"></a><span class="in">      "We can download open data but we cannot use it for any project that will be published online.",</span></span>
<span id="cb36-481"><a href="#cb36-481"></a><span class="in">      message = "Organisations usually publish open data to make it easier for other organisations and individuals to use that data to make products and analyse local issues. It would be extremely unusual for an open-data licence to stop people from using the data in a project that was going to be published online."</span></span>
<span id="cb36-482"><a href="#cb36-482"></a><span class="in">    ),</span></span>
<span id="cb36-483"><a href="#cb36-483"></a><span class="in">    correct = random_praise(),</span></span>
<span id="cb36-484"><a href="#cb36-484"></a><span class="in">    allow_retry = TRUE,</span></span>
<span id="cb36-485"><a href="#cb36-485"></a><span class="in">    random_answer_order = TRUE</span></span>
<span id="cb36-486"><a href="#cb36-486"></a><span class="in">  )</span></span>
<span id="cb36-487"><a href="#cb36-487"></a><span class="in">  </span></span>
<span id="cb36-488"><a href="#cb36-488"></a><span class="in">)</span></span>
<span id="cb36-489"><a href="#cb36-489"></a><span class="in">```</span></span>
<span id="cb36-490"><a href="#cb36-490"></a></span>
<span id="cb36-491"><a href="#cb36-491"></a></span>
<span id="cb36-492"><a href="#cb36-492"></a></span>
<span id="cb36-493"><a href="#cb36-493"></a><span class="fu">## Shapefiles</span></span>
<span id="cb36-494"><a href="#cb36-494"></a></span>
<span id="cb36-495"><a href="#cb36-495"></a>In this course we have used spatial data provided in different formats including</span>
<span id="cb36-496"><a href="#cb36-496"></a>geopackages (<span class="in">`.gpkg`</span>) and geoJSON (<span class="in">`.geojson`</span>) files, as well as creating </span>
<span id="cb36-497"><a href="#cb36-497"></a>spatial objects from tabular data in formats like CSV and Excel files. But there </span>
<span id="cb36-498"><a href="#cb36-498"></a>is one spatial-data format that we haven't yet learned to use: the *shapefile*.</span>
<span id="cb36-499"><a href="#cb36-499"></a></span>
<span id="cb36-500"><a href="#cb36-500"></a>The shapefile format was created by Esri, the company that makes the ArcGIS </span>
<span id="cb36-501"><a href="#cb36-501"></a>suite of mapping software. It was perhaps the first spatial format that could be</span>
<span id="cb36-502"><a href="#cb36-502"></a>read by a wide variety of mapping software, which meant that lots of providers</span>
<span id="cb36-503"><a href="#cb36-503"></a>of spatial data began to provide data in shapefile format. Shapefiles are </span>
<span id="cb36-504"><a href="#cb36-504"></a>limited in various ways that mean they are unlikely to be a good choice for </span>
<span id="cb36-505"><a href="#cb36-505"></a>storing your own data, but it is important to know how to use them because many</span>
<span id="cb36-506"><a href="#cb36-506"></a>spatial datasets are still provided as shapefiles for historical reasons.</span>
<span id="cb36-507"><a href="#cb36-507"></a></span>
<span id="cb36-508"><a href="#cb36-508"></a>One of the complications of using shapefiles (and why they're not a good choice</span>
<span id="cb36-509"><a href="#cb36-509"></a>for storing your own data) is that different parts of the data are stored in </span>
<span id="cb36-510"><a href="#cb36-510"></a>separate files. So while the co-ordinates of the points, line or polygons are</span>
<span id="cb36-511"><a href="#cb36-511"></a>stored in a file with a <span class="in">`.shp`</span> extension, the non-spatial attributes of each</span>
<span id="cb36-512"><a href="#cb36-512"></a>spatial feature (such as the date on which a crime occurred or the name of a</span>
<span id="cb36-513"><a href="#cb36-513"></a>neighbourhood) are stored in a separate file with a <span class="in">`.dbf`</span> extension and details</span>
<span id="cb36-514"><a href="#cb36-514"></a>of the co-ordinate reference system are stored in a <span class="in">`.prj`</span> file -- a single </span>
<span id="cb36-515"><a href="#cb36-515"></a>dataset might be held in up to 16 separate files on a computer. All the files </span>
<span id="cb36-516"><a href="#cb36-516"></a>that make up a shapefile have the same file name, differing only in the file </span>
<span id="cb36-517"><a href="#cb36-517"></a>extension (e.g. <span class="in">`.shp`</span>, <span class="in">`.dbf`</span>, etc.). For example, if a <span class="in">`.shp`</span> file is called</span>
<span id="cb36-518"><a href="#cb36-518"></a><span class="in">`robberies.shp`</span> then it will be accompanied by a file called <span class="in">`robberies.dbf`</span> and</span>
<span id="cb36-519"><a href="#cb36-519"></a>one called <span class="in">`robberies.prj`</span>, as well as a <span class="in">`robberies.shx`</span> index file and possibly</span>
<span id="cb36-520"><a href="#cb36-520"></a>several others. All these separate files make it more-complicated to manage </span>
<span id="cb36-521"><a href="#cb36-521"></a>shapefiles than other spatial file formats such as the geopackage.</span>
<span id="cb36-522"><a href="#cb36-522"></a></span>
<span id="cb36-523"><a href="#cb36-523"></a>Because storing spatial data in a shapefile requires multiple different files,</span>
<span id="cb36-524"><a href="#cb36-524"></a>shapefile data is usually distributed in a <span class="in">`.zip`</span> file that contains all the</span>
<span id="cb36-525"><a href="#cb36-525"></a>component files. This means that to access a shapefile will have to add a step </span>
<span id="cb36-526"><a href="#cb36-526"></a>to our usual routine for downloading and opening a data file. To minimise the</span>
<span id="cb36-527"><a href="#cb36-527"></a>hassle associated with using shapefiles, in general we will:</span>
<span id="cb36-528"><a href="#cb36-528"></a></span>
<span id="cb36-529"><a href="#cb36-529"></a><span class="ss">  1. </span>download the <span class="in">`.zip`</span> file if we don't have a local copy already,</span>
<span id="cb36-530"><a href="#cb36-530"></a><span class="ss">  2. </span>create a temporary directory where we can store the unzipped shapefile, so</span>
<span id="cb36-531"><a href="#cb36-531"></a>     we can save space on our computers by only permanently keeping the (often</span>
<span id="cb36-532"><a href="#cb36-532"></a>     much smaller) <span class="in">`.zip`</span> file,</span>
<span id="cb36-533"><a href="#cb36-533"></a><span class="ss">  3. </span>unzip the <span class="in">`.zip`</span> file into the temporary directory,</span>
<span id="cb36-534"><a href="#cb36-534"></a><span class="ss">  4. </span>load the shapefile data from the temporary directory.</span>
<span id="cb36-535"><a href="#cb36-535"></a></span>
<span id="cb36-536"><a href="#cb36-536"></a>For example, the routes of metro lines in Medellin are available in shapefile</span>
<span id="cb36-537"><a href="#cb36-537"></a>format at: </span>
<span id="cb36-538"><a href="#cb36-538"></a></span>
<span id="cb36-539"><a href="#cb36-539"></a><span class="in">```</span></span>
<span id="cb36-540"><a href="#cb36-540"></a><span class="in">https://mpjashby.github.io/crimemappingdata/medellin_metro_lines.zip</span></span>
<span id="cb36-541"><a href="#cb36-541"></a><span class="in">```</span></span>
<span id="cb36-542"><a href="#cb36-542"></a></span>
<span id="cb36-543"><a href="#cb36-543"></a></span>
<span id="cb36-544"><a href="#cb36-544"></a>To load the data from this file, we can use the process shown above.</span>
<span id="cb36-545"><a href="#cb36-545"></a></span>
<span id="cb36-546"><a href="#cb36-546"></a>::: {.tutorial}</span>
<span id="cb36-547"><a href="#cb36-547"></a></span>
<span id="cb36-548"><a href="#cb36-548"></a>Unfortunately it isn't possible to run this code within this interactive </span>
<span id="cb36-549"><a href="#cb36-549"></a>tutorial because of security restrictions on saving files on your computer from </span>
<span id="cb36-550"><a href="#cb36-550"></a>within a tutorial. You can test this code by copying it into a new R Script in </span>
<span id="cb36-551"><a href="#cb36-551"></a>RStudio and running the code from there. Note that this code assumes you have</span>
<span id="cb36-552"><a href="#cb36-552"></a>already loaded the <span class="in">`sf`</span> and <span class="in">`tidyverse`</span> packages.</span>
<span id="cb36-553"><a href="#cb36-553"></a></span>
<span id="cb36-554"><a href="#cb36-554"></a>:::</span>
<span id="cb36-555"><a href="#cb36-555"></a></span>
<span id="cb36-556"><a href="#cb36-556"></a></span>
<span id="cb36-557"><a href="#cb36-557"></a><span class="in">```r</span></span>
<span id="cb36-558"><a href="#cb36-558"></a><span class="co"># Step 1: download the .zip file to a temporary file</span></span>
<span id="cb36-559"><a href="#cb36-559"></a>metro_lines_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".zip"</span>)</span>
<span id="cb36-560"><a href="#cb36-560"></a><span class="fu">download.file</span>(</span>
<span id="cb36-561"><a href="#cb36-561"></a>  <span class="at">url =</span> <span class="st">"https://mpjashby.github.io/crimemappingdata/medellin_metro_lines.zip"</span>, </span>
<span id="cb36-562"><a href="#cb36-562"></a>  <span class="at">destfile =</span> metro_lines_file</span>
<span id="cb36-563"><a href="#cb36-563"></a>)</span>
<span id="cb36-564"><a href="#cb36-564"></a></span>
<span id="cb36-565"><a href="#cb36-565"></a><span class="co"># Step 2: create a temporary directory</span></span>
<span id="cb36-566"><a href="#cb36-566"></a><span class="co"># The `tempdir()` function returns a location on your computer that is used for</span></span>
<span id="cb36-567"><a href="#cb36-567"></a><span class="co"># storing temporary files. *Any files stored in this temporary directory will be</span></span>
<span id="cb36-568"><a href="#cb36-568"></a><span class="co"># deleted when you restart your computer*, so it's a useful place to put files</span></span>
<span id="cb36-569"><a href="#cb36-569"></a><span class="co"># that you will only need for a short time so they won't clutter up your</span></span>
<span id="cb36-570"><a href="#cb36-570"></a><span class="co"># computer. Since we want to store the shapefile in a sub-directory of the</span></span>
<span id="cb36-571"><a href="#cb36-571"></a><span class="co"># temporary directory, we will use `str_glue()` to add a relevant sub-directory</span></span>
<span id="cb36-572"><a href="#cb36-572"></a><span class="co"># name to the end of the temporary directory name -- `unzip()` will then</span></span>
<span id="cb36-573"><a href="#cb36-573"></a><span class="co"># create this directory in the background at Step 3.</span></span>
<span id="cb36-574"><a href="#cb36-574"></a>metro_lines_dir <span class="ot">&lt;-</span> <span class="fu">str_glue</span>(<span class="st">"{tempdir()}/metro_lines"</span>)</span>
<span id="cb36-575"><a href="#cb36-575"></a></span>
<span id="cb36-576"><a href="#cb36-576"></a><span class="co"># Step 3: unzip file</span></span>
<span id="cb36-577"><a href="#cb36-577"></a><span class="fu">unzip</span>(metro_lines_file, <span class="at">exdir =</span> metro_lines_dir)</span>
<span id="cb36-578"><a href="#cb36-578"></a></span>
<span id="cb36-579"><a href="#cb36-579"></a><span class="co"># Step 5: load the data</span></span>
<span id="cb36-580"><a href="#cb36-580"></a>medellin_metro_lines <span class="ot">&lt;-</span> metro_lines_dir <span class="sc">|&gt;</span> </span>
<span id="cb36-581"><a href="#cb36-581"></a>  <span class="fu">str_glue</span>(<span class="st">"/medellin_metro_lines.shp"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb36-582"><a href="#cb36-582"></a>  <span class="fu">read_sf</span>()</span>
<span id="cb36-583"><a href="#cb36-583"></a><span class="in">```</span></span>
<span id="cb36-584"><a href="#cb36-584"></a></span>
<span id="cb36-585"><a href="#cb36-585"></a></span>
<span id="cb36-586"><a href="#cb36-586"></a>::: {.box .notewell}</span>
<span id="cb36-587"><a href="#cb36-587"></a></span>
<span id="cb36-588"><a href="#cb36-588"></a>Note that although a shapefile consists of several different files, we only need</span>
<span id="cb36-589"><a href="#cb36-589"></a>to load the file with the extension <span class="in">`.shp`</span> -- the <span class="in">`read_sf()`</span> function will find</span>
<span id="cb36-590"><a href="#cb36-590"></a>all the data it needs from the other files.</span>
<span id="cb36-591"><a href="#cb36-591"></a></span>
<span id="cb36-592"><a href="#cb36-592"></a>Once we have loaded a shapefile into R using <span class="in">`read_sf()`</span>, we can treat it in the</span>
<span id="cb36-593"><a href="#cb36-593"></a>same way as any other spatial dataset -- it is only loading shapefiles that is</span>
<span id="cb36-594"><a href="#cb36-594"></a>different from other spatial data formats.</span>
<span id="cb36-595"><a href="#cb36-595"></a></span>
<span id="cb36-596"><a href="#cb36-596"></a>:::</span>
<span id="cb36-597"><a href="#cb36-597"></a></span>
<span id="cb36-598"><a href="#cb36-598"></a></span>
<span id="cb36-599"><a href="#cb36-599"></a>&lt;div class="box extra-detail"&gt;</span>
<span id="cb36-600"><a href="#cb36-600"></a></span>
<span id="cb36-601"><a href="#cb36-601"></a>&lt;h5 id="shapefile-box1-title" class="box-title"&gt;How did you know the name of the <span class="in">`medellin_metro_lines.shp`</span> file?&lt;/h5&gt;</span>
<span id="cb36-602"><a href="#cb36-602"></a></span>
<span id="cb36-603"><a href="#cb36-603"></a>&lt;div id="shapefile-box1" class="box-content"&gt;</span>
<span id="cb36-604"><a href="#cb36-604"></a></span>
<span id="cb36-605"><a href="#cb36-605"></a>If you need to find out the name of the shapefile within the zip file, you can</span>
<span id="cb36-606"><a href="#cb36-606"></a>use the <span class="in">`list = TRUE`</span> argument to the <span class="in">`unzip()`</span> function to produce a list of</span>
<span id="cb36-607"><a href="#cb36-607"></a>files that are inside the zip file rather than unzip any files. For example, the</span>
<span id="cb36-608"><a href="#cb36-608"></a>code <span class="in">`unzip(metro_lines_file, list = TRUE)`</span> would produce a data frame of file</span>
<span id="cb36-609"><a href="#cb36-609"></a>names:</span>
<span id="cb36-610"><a href="#cb36-610"></a></span>
<span id="cb36-611"><a href="#cb36-611"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb36-612"><a href="#cb36-612"></a><span class="in">metro_lines_file |&gt; unzip(list = TRUE) |&gt; knitr::kable()</span></span>
<span id="cb36-613"><a href="#cb36-613"></a><span class="in">```</span></span>
<span id="cb36-614"><a href="#cb36-614"></a></span>
<span id="cb36-615"><a href="#cb36-615"></a>**Make sure you run <span class="in">`unzip(metro_lines_file, list = TRUE)`</span> in the R console</span>
<span id="cb36-616"><a href="#cb36-616"></a>rather than in your script file, to minimise the amount of unnecessary output</span>
<span id="cb36-617"><a href="#cb36-617"></a>that your script produces.**</span>
<span id="cb36-618"><a href="#cb36-618"></a></span>
<span id="cb36-619"><a href="#cb36-619"></a>&lt;/div&gt;</span>
<span id="cb36-620"><a href="#cb36-620"></a></span>
<span id="cb36-621"><a href="#cb36-621"></a>&lt;/div&gt;</span>
<span id="cb36-622"><a href="#cb36-622"></a></span>
<span id="cb36-623"><a href="#cb36-623"></a>&lt;script&gt;</span>
<span id="cb36-624"><a href="#cb36-624"></a><span class="fu">$</span>(<span class="st">"#shapefile-box1-title"</span>)<span class="op">.</span><span class="fu">click</span>(<span class="kw">function</span> () { <span class="fu">$</span>(<span class="st">"#shapefile-box1"</span>)<span class="op">.</span><span class="fu">toggle</span>(<span class="st">"slow"</span>) })</span>
<span id="cb36-625"><a href="#cb36-625"></a>&lt;/script&gt;</span>
<span id="cb36-626"><a href="#cb36-626"></a></span>
<span id="cb36-627"><a href="#cb36-627"></a></span>
<span id="cb36-628"><a href="#cb36-628"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Check your understanding --&gt;</span></span>
<span id="cb36-629"><a href="#cb36-629"></a></span>
<span id="cb36-630"><a href="#cb36-630"></a><span class="co">&lt;!-- ```{r open-data-quiz} --&gt;</span></span>
<span id="cb36-631"><a href="#cb36-631"></a><span class="co">&lt;!-- quiz( --&gt;</span></span>
<span id="cb36-632"><a href="#cb36-632"></a><span class="co">&lt;!--   caption = "", --&gt;</span></span>
<span id="cb36-633"><a href="#cb36-633"></a></span>
<span id="cb36-634"><a href="#cb36-634"></a><span class="co">&lt;!--   question( --&gt;</span></span>
<span id="cb36-635"><a href="#cb36-635"></a><span class="co">&lt;!--     "", --&gt;</span></span>
<span id="cb36-636"><a href="#cb36-636"></a><span class="co">&lt;!--     answer("", correct = TRUE), --&gt;</span></span>
<span id="cb36-637"><a href="#cb36-637"></a><span class="co">&lt;!--     answer( --&gt;</span></span>
<span id="cb36-638"><a href="#cb36-638"></a><span class="co">&lt;!--       "", --&gt;</span></span>
<span id="cb36-639"><a href="#cb36-639"></a><span class="co">&lt;!--       message = "" --&gt;</span></span>
<span id="cb36-640"><a href="#cb36-640"></a><span class="co">&lt;!--     ), --&gt;</span></span>
<span id="cb36-641"><a href="#cb36-641"></a><span class="co">&lt;!--     answer( --&gt;</span></span>
<span id="cb36-642"><a href="#cb36-642"></a><span class="co">&lt;!--       "", --&gt;</span></span>
<span id="cb36-643"><a href="#cb36-643"></a><span class="co">&lt;!--       message = "" --&gt;</span></span>
<span id="cb36-644"><a href="#cb36-644"></a><span class="co">&lt;!--     ), --&gt;</span></span>
<span id="cb36-645"><a href="#cb36-645"></a><span class="co">&lt;!--     answer( --&gt;</span></span>
<span id="cb36-646"><a href="#cb36-646"></a><span class="co">&lt;!--       "", --&gt;</span></span>
<span id="cb36-647"><a href="#cb36-647"></a><span class="co">&lt;!--       message = "" --&gt;</span></span>
<span id="cb36-648"><a href="#cb36-648"></a><span class="co">&lt;!--     ), --&gt;</span></span>
<span id="cb36-649"><a href="#cb36-649"></a><span class="co">&lt;!--     correct = random_praise(), --&gt;</span></span>
<span id="cb36-650"><a href="#cb36-650"></a><span class="co">&lt;!--     allow_retry = TRUE, --&gt;</span></span>
<span id="cb36-651"><a href="#cb36-651"></a><span class="co">&lt;!--     random_answer_order = TRUE --&gt;</span></span>
<span id="cb36-652"><a href="#cb36-652"></a><span class="co">&lt;!--   ) --&gt;</span></span>
<span id="cb36-653"><a href="#cb36-653"></a></span>
<span id="cb36-654"><a href="#cb36-654"></a><span class="co">&lt;!-- ) --&gt;</span></span>
<span id="cb36-655"><a href="#cb36-655"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb36-656"><a href="#cb36-656"></a></span>
<span id="cb36-657"><a href="#cb36-657"></a></span>
<span id="cb36-658"><a href="#cb36-658"></a></span>
<span id="cb36-659"><a href="#cb36-659"></a><span class="fu">## Data from OpenStreetMap</span></span>
<span id="cb36-660"><a href="#cb36-660"></a></span>
<span id="cb36-661"><a href="#cb36-661"></a>&lt;a href="https://www.openstreetmap.org/"&gt;&lt;img src="images/osm_logo.jpg" alt="OpenStreetMap logo" class="right-side-image"&gt;&lt;/a&gt;</span>
<span id="cb36-662"><a href="#cb36-662"></a></span>
<span id="cb36-663"><a href="#cb36-663"></a>Often we can get map data from the organisation we are working for, or from </span>
<span id="cb36-664"><a href="#cb36-664"></a>open-data portals run by governments or international organisations. But </span>
<span id="cb36-665"><a href="#cb36-665"></a>sometimes they won't hold the information we need.</span>
<span id="cb36-666"><a href="#cb36-666"></a></span>
<span id="cb36-667"><a href="#cb36-667"></a>Fortunately, there is another source of data: OpenStreetMap (OSM). This is a</span>
<span id="cb36-668"><a href="#cb36-668"></a>global resource of map data created by volunteers (and started at UCL), using a</span>
<span id="cb36-669"><a href="#cb36-669"></a>mixture of open data from governments, data contributed by charities and data </span>
<span id="cb36-670"><a href="#cb36-670"></a>collected by the volunteers themselves. Watch this video to learn a bit more </span>
<span id="cb36-671"><a href="#cb36-671"></a>about OpenStreetMap.</span>
<span id="cb36-672"><a href="#cb36-672"></a></span>
<span id="cb36-673"><a href="#cb36-673"></a>{{&lt; video https://youtu.be/d6n29CU2-Sg &gt;}}</span>
<span id="cb36-674"><a href="#cb36-674"></a></span>
<span id="cb36-675"><a href="#cb36-675"></a>We have already used OSM data in this course: all of the base maps we have used</span>
<span id="cb36-676"><a href="#cb36-676"></a>when we create maps with <span class="in">`ggplot()`</span> are based on data from OpenStreetMap. But</span>
<span id="cb36-677"><a href="#cb36-677"></a>we have very little control over which information is and is not included in</span>
<span id="cb36-678"><a href="#cb36-678"></a>base maps. Sometimes we need more control over the data, and that means </span>
<span id="cb36-679"><a href="#cb36-679"></a>downloading data direct from OSM.</span>
<span id="cb36-680"><a href="#cb36-680"></a></span>
<span id="cb36-681"><a href="#cb36-681"></a>We can download OSM data into R using the <span class="in">`osmdata`</span> package. This package allows </span>
<span id="cb36-682"><a href="#cb36-682"></a>us to choose particular features from the billions of features worldwide that </span>
<span id="cb36-683"><a href="#cb36-683"></a>are included in the OSM database. To choose features, we must:</span>
<span id="cb36-684"><a href="#cb36-684"></a></span>
<span id="cb36-685"><a href="#cb36-685"></a><span class="ss">  1. </span>specify the _bounding box_ of the area we want to download data for using </span>
<span id="cb36-686"><a href="#cb36-686"></a>     the <span class="in">`opq()`</span> function,</span>
<span id="cb36-687"><a href="#cb36-687"></a><span class="ss">  2. </span>specify what type of features we want to download using the</span>
<span id="cb36-688"><a href="#cb36-688"></a>     <span class="in">`add_osm_feature()`</span> function,</span>
<span id="cb36-689"><a href="#cb36-689"></a><span class="ss">  3. </span>download the data using the <span class="in">`osmdata_sf()`</span> function, and</span>
<span id="cb36-690"><a href="#cb36-690"></a><span class="ss">  4. </span>extract the type of spatial object (points, lines or polygons) that we are</span>
<span id="cb36-691"><a href="#cb36-691"></a>     interested in.</span>
<span id="cb36-692"><a href="#cb36-692"></a></span>
<span id="cb36-693"><a href="#cb36-693"></a>Imagine that in your analysis of homicides in Medellin, you have been asked</span>
<span id="cb36-694"><a href="#cb36-694"></a>to consider the question of whether homicides are clustered near to bus stops.</span>
<span id="cb36-695"><a href="#cb36-695"></a>To answer this question, we need to know the locations of bus stops in the area</span>
<span id="cb36-696"><a href="#cb36-696"></a>we are interested in. This information is not published as open data by the</span>
<span id="cb36-697"><a href="#cb36-697"></a>Medellin city authorities. Fortunately we can extract bus-stop locations from </span>
<span id="cb36-698"><a href="#cb36-698"></a>OpenStreetMap using the <span class="in">`osmdata`</span> package.</span>
<span id="cb36-699"><a href="#cb36-699"></a></span>
<span id="cb36-700"><a href="#cb36-700"></a>To do this, we first need to calculate the bounding box of the La Candelaria </span>
<span id="cb36-701"><a href="#cb36-701"></a>neighbourhood that we are interested in. A bounding box is the smallest </span>
<span id="cb36-702"><a href="#cb36-702"></a>rectangle that a particular spatial shape will fit inside. For example, the</span>
<span id="cb36-703"><a href="#cb36-703"></a>red rectangle on this map shows the bounding box of the city of Medellin (shown</span>
<span id="cb36-704"><a href="#cb36-704"></a>in blue).</span>
<span id="cb36-705"><a href="#cb36-705"></a></span>
<span id="cb36-706"><a href="#cb36-706"></a><span class="in">```{r bbox-map, eval=FALSE, echo=FALSE}</span></span>
<span id="cb36-707"><a href="#cb36-707"></a><span class="in">medellin_boundary &lt;- medellin_comunas |&gt; </span></span>
<span id="cb36-708"><a href="#cb36-708"></a><span class="in">  st_transform("EPSG:4326") |&gt; </span></span>
<span id="cb36-709"><a href="#cb36-709"></a><span class="in">  st_buffer(10) |&gt; </span></span>
<span id="cb36-710"><a href="#cb36-710"></a><span class="in">  st_union() |&gt; </span></span>
<span id="cb36-711"><a href="#cb36-711"></a><span class="in">  st_as_sf()</span></span>
<span id="cb36-712"><a href="#cb36-712"></a></span>
<span id="cb36-713"><a href="#cb36-713"></a><span class="in">medellin_bbox &lt;- medellin_boundary |&gt; </span></span>
<span id="cb36-714"><a href="#cb36-714"></a><span class="in">  st_bbox() |&gt; </span></span>
<span id="cb36-715"><a href="#cb36-715"></a><span class="in">  st_as_sfc() |&gt; </span></span>
<span id="cb36-716"><a href="#cb36-716"></a><span class="in">  st_as_sf()</span></span>
<span id="cb36-717"><a href="#cb36-717"></a></span>
<span id="cb36-718"><a href="#cb36-718"></a><span class="in">medellin_bbox_map &lt;- ggplot() +</span></span>
<span id="cb36-719"><a href="#cb36-719"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 1, progress = "none") +</span></span>
<span id="cb36-720"><a href="#cb36-720"></a><span class="in">  geom_sf(</span></span>
<span id="cb36-721"><a href="#cb36-721"></a><span class="in">    data = medellin_boundary, </span></span>
<span id="cb36-722"><a href="#cb36-722"></a><span class="in">    colour = "darkblue", </span></span>
<span id="cb36-723"><a href="#cb36-723"></a><span class="in">    fill = NA, </span></span>
<span id="cb36-724"><a href="#cb36-724"></a><span class="in">    linewidth = 0.75</span></span>
<span id="cb36-725"><a href="#cb36-725"></a><span class="in">  ) +</span></span>
<span id="cb36-726"><a href="#cb36-726"></a><span class="in">  geom_sf(data = medellin_bbox, colour = "darkred", fill = NA, linewidth = 1) +</span></span>
<span id="cb36-727"><a href="#cb36-727"></a><span class="in">  annotation_scale(style = "ticks", location = "bl") +</span></span>
<span id="cb36-728"><a href="#cb36-728"></a><span class="in">  labs(caption = "Map data from OpenStreetMap") +</span></span>
<span id="cb36-729"><a href="#cb36-729"></a><span class="in">  theme_void()</span></span>
<span id="cb36-730"><a href="#cb36-730"></a></span>
<span id="cb36-731"><a href="#cb36-731"></a><span class="in">ggsave(</span></span>
<span id="cb36-732"><a href="#cb36-732"></a><span class="in">  "inst/tutorials/10_place_data/images/medellin_bbox_map.jpg",</span></span>
<span id="cb36-733"><a href="#cb36-733"></a><span class="in">  medellin_bbox_map,</span></span>
<span id="cb36-734"><a href="#cb36-734"></a><span class="in">  units = "px",</span></span>
<span id="cb36-735"><a href="#cb36-735"></a><span class="in">  width = 1600,</span></span>
<span id="cb36-736"><a href="#cb36-736"></a><span class="in">  height = 1500</span></span>
<span id="cb36-737"><a href="#cb36-737"></a><span class="in">)</span></span>
<span id="cb36-738"><a href="#cb36-738"></a><span class="in">```</span></span>
<span id="cb36-739"><a href="#cb36-739"></a></span>
<span id="cb36-740"><a href="#cb36-740"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/medellin_bbox_map.jpg" alt="Map of the boundary of Medellin and the corresponding bounding box"&gt;&lt;/p&gt;</span>
<span id="cb36-741"><a href="#cb36-741"></a></span>
<span id="cb36-742"><a href="#cb36-742"></a></span>
<span id="cb36-743"><a href="#cb36-743"></a>You can calculate the bounding box of an SF object using the <span class="in">`st_bbox()`</span> </span>
<span id="cb36-744"><a href="#cb36-744"></a>function.</span>
<span id="cb36-745"><a href="#cb36-745"></a></span>
<span id="cb36-746"><a href="#cb36-746"></a>::: {.tutorial}</span>
<span id="cb36-747"><a href="#cb36-747"></a></span>
<span id="cb36-748"><a href="#cb36-748"></a>Assuming we have already loaded the neighbourhood boundaries into an object </span>
<span id="cb36-749"><a href="#cb36-749"></a>called <span class="in">`medellin_comunas`</span>, write the code needed to filter that object so that </span>
<span id="cb36-750"><a href="#cb36-750"></a>only the boundary for the La Candelaria neighbourhood is included, then</span>
<span id="cb36-751"><a href="#cb36-751"></a>calculate the bounding box for that layer and store it in an object called</span>
<span id="cb36-752"><a href="#cb36-752"></a><span class="in">`la_candelaria_bbox`</span>. </span>
<span id="cb36-753"><a href="#cb36-753"></a></span>
<span id="cb36-754"><a href="#cb36-754"></a>Note that the <span class="in">`medellin_comunas`</span> object uses the Colombia MANGA West Zone</span>
<span id="cb36-755"><a href="#cb36-755"></a>co-ordinate system (EPSG code 3115), but the <span class="in">`osmdata`</span> package only works with</span>
<span id="cb36-756"><a href="#cb36-756"></a>bounding boxes specified as longitudes and latitudes. This means you will also</span>
<span id="cb36-757"><a href="#cb36-757"></a>need to transform the dataset to use the WGS84 co-ordinate system (EPSG code</span>
<span id="cb36-758"><a href="#cb36-758"></a>4326) before you calculate the bounding box.</span>
<span id="cb36-759"><a href="#cb36-759"></a></span>
<span id="cb36-760"><a href="#cb36-760"></a></span>
<span id="cb36-761"><a href="#cb36-761"></a><span class="in">```{r osm-exercise1, exercise=TRUE}</span></span>
<span id="cb36-762"><a href="#cb36-762"></a></span>
<span id="cb36-763"><a href="#cb36-763"></a><span class="in">```</span></span>
<span id="cb36-764"><a href="#cb36-764"></a></span>
<span id="cb36-765"><a href="#cb36-765"></a><span class="in">```{r osm-exercise1-hint-1}</span></span>
<span id="cb36-766"><a href="#cb36-766"></a><span class="in"># You can use the `filter()` function to filter only the rows of data that you </span></span>
<span id="cb36-767"><a href="#cb36-767"></a><span class="in"># want to keep in the data</span></span>
<span id="cb36-768"><a href="#cb36-768"></a><span class="in">```</span></span>
<span id="cb36-769"><a href="#cb36-769"></a></span>
<span id="cb36-770"><a href="#cb36-770"></a><span class="in">```{r osm-exercise1-hint-2}</span></span>
<span id="cb36-771"><a href="#cb36-771"></a><span class="in"># Remember to use `st_transform()` to make sure the data uses the correct</span></span>
<span id="cb36-772"><a href="#cb36-772"></a><span class="in"># co-ordinate system. You can use the `st_bbox()` function to calculate the </span></span>
<span id="cb36-773"><a href="#cb36-773"></a><span class="in"># bounding box of the 52nd division boundary.</span></span>
<span id="cb36-774"><a href="#cb36-774"></a><span class="in">```</span></span>
<span id="cb36-775"><a href="#cb36-775"></a></span>
<span id="cb36-776"><a href="#cb36-776"></a><span class="in">```{r osm-exercise1-hint-3}</span></span>
<span id="cb36-777"><a href="#cb36-777"></a><span class="in"># If you need to find out the name of the relevant variable in the </span></span>
<span id="cb36-778"><a href="#cb36-778"></a><span class="in"># `medellin_comunas` object, you can use `head(medellin_comunas)` to see the </span></span>
<span id="cb36-779"><a href="#cb36-779"></a><span class="in"># first few rows.</span></span>
<span id="cb36-780"><a href="#cb36-780"></a><span class="in">```</span></span>
<span id="cb36-781"><a href="#cb36-781"></a></span>
<span id="cb36-782"><a href="#cb36-782"></a>:::</span>
<span id="cb36-783"><a href="#cb36-783"></a></span>
<span id="cb36-784"><a href="#cb36-784"></a></span>
<span id="cb36-785"><a href="#cb36-785"></a><span class="in">```{r osm-exercise1-hint-4}</span></span>
<span id="cb36-786"><a href="#cb36-786"></a><span class="in">la_candelaria_bbox &lt;- medellin_comunas |&gt; </span></span>
<span id="cb36-787"><a href="#cb36-787"></a><span class="in">  filter(nombre == "LA CANDELARIA") |&gt; </span></span>
<span id="cb36-788"><a href="#cb36-788"></a><span class="in">  st_transform("EPSG:4326") |&gt; </span></span>
<span id="cb36-789"><a href="#cb36-789"></a><span class="in">  st_bbox()</span></span>
<span id="cb36-790"><a href="#cb36-790"></a></span>
<span id="cb36-791"><a href="#cb36-791"></a><span class="in">head(la_candelaria_bbox)</span></span>
<span id="cb36-792"><a href="#cb36-792"></a><span class="in">```</span></span>
<span id="cb36-793"><a href="#cb36-793"></a></span>
<span id="cb36-794"><a href="#cb36-794"></a>The second thing we need to know is what search terms to use in the </span>
<span id="cb36-795"><a href="#cb36-795"></a><span class="in">`add_osm_feature()`</span> function to return the locations of bus stops. </span>
<span id="cb36-796"><a href="#cb36-796"></a>OpenStreetMap has hundreds of feature categories, all in the format </span>
<span id="cb36-797"><a href="#cb36-797"></a><span class="in">`key=value`</span>. Sometimes we will only need to search for a particular </span>
<span id="cb36-798"><a href="#cb36-798"></a>key (category of feature), such as the </span>
<span id="cb36-799"><a href="#cb36-799"></a><span class="co">[</span><span class="ot">`highway` key</span><span class="co">](https://wiki.openstreetmap.org/wiki/Key:highway)</span> that </span>
<span id="cb36-800"><a href="#cb36-800"></a>contains all the features that show roads (from motorways to winding lanes</span>
<span id="cb36-801"><a href="#cb36-801"></a>leading to farms in the countryside), tracks and paths. In other cases, we will </span>
<span id="cb36-802"><a href="#cb36-802"></a>want to search for a particular value (type of feature within a category), such </span>
<span id="cb36-803"><a href="#cb36-803"></a>as searching for the value </span>
<span id="cb36-804"><a href="#cb36-804"></a><span class="co">[</span><span class="ot">`natural=water`</span><span class="co">](https://wiki.openstreetmap.org/wiki/Tag:natural%3Dwater)</span> to</span>
<span id="cb36-805"><a href="#cb36-805"></a>search for lakes, rivers, etc. </span>
<span id="cb36-806"><a href="#cb36-806"></a></span>
<span id="cb36-807"><a href="#cb36-807"></a>The best place to find out how a feature you are interested in is recorded in </span>
<span id="cb36-808"><a href="#cb36-808"></a>the OSM database is to look at the</span>
<span id="cb36-809"><a href="#cb36-809"></a><span class="co">[</span><span class="ot">OpenStreetMap Wiki</span><span class="co">](https://wiki.openstreetmap.org/wiki/Map_features)</span>. </span>
<span id="cb36-810"><a href="#cb36-810"></a>Bus stops are recorded in OSM using the tag <span class="in">`highway=bus_stop`</span>.</span>
<span id="cb36-811"><a href="#cb36-811"></a></span>
<span id="cb36-812"><a href="#cb36-812"></a>Now that we know the bounding box of the area we are interested in and the tag</span>
<span id="cb36-813"><a href="#cb36-813"></a>for the type of feature we want, we can download the data from OpenStreetMap.</span>
<span id="cb36-814"><a href="#cb36-814"></a></span>
<span id="cb36-815"><a href="#cb36-815"></a><span class="in">```{r osm-exercise2, exercise=TRUE}</span></span>
<span id="cb36-816"><a href="#cb36-816"></a><span class="in"># Define the bounding box of the area we want to search</span></span>
<span id="cb36-817"><a href="#cb36-817"></a><span class="in">bus_stops &lt;- opq(la_candelaria_bbox) |&gt; </span></span>
<span id="cb36-818"><a href="#cb36-818"></a><span class="in">  # Define the features we want</span></span>
<span id="cb36-819"><a href="#cb36-819"></a><span class="in">  add_osm_feature(key = "highway", value = "bus_stop") |&gt; </span></span>
<span id="cb36-820"><a href="#cb36-820"></a><span class="in">  # Download those features for that area</span></span>
<span id="cb36-821"><a href="#cb36-821"></a><span class="in">  osmdata_sf()</span></span>
<span id="cb36-822"><a href="#cb36-822"></a></span>
<span id="cb36-823"><a href="#cb36-823"></a><span class="in"># Print the result (note the result is not a data frame, so we cannot use the</span></span>
<span id="cb36-824"><a href="#cb36-824"></a><span class="in"># `head()` function)</span></span>
<span id="cb36-825"><a href="#cb36-825"></a><span class="in">bus_stops</span></span>
<span id="cb36-826"><a href="#cb36-826"></a><span class="in">```</span></span>
<span id="cb36-827"><a href="#cb36-827"></a></span>
<span id="cb36-828"><a href="#cb36-828"></a>You'll see that the object <span class="in">`bus_stops`</span> has quite complicated structure, but </span>
<span id="cb36-829"><a href="#cb36-829"></a>that nested within it is an object called <span class="in">`osm_points`</span> that is an SF object with</span>
<span id="cb36-830"><a href="#cb36-830"></a><span class="in">`r scales::comma(nrow(bus_stops$osm_points))`</span> rows and another SF object called </span>
<span id="cb36-831"><a href="#cb36-831"></a><span class="in">`osm_polygons`</span>. Even within a particular type of feature, some places might be</span>
<span id="cb36-832"><a href="#cb36-832"></a>represented as points (e.g. a point placed at a bus stop) while others are </span>
<span id="cb36-833"><a href="#cb36-833"></a>represented as polygons (e.g. the outline of a bus station).</span>
<span id="cb36-834"><a href="#cb36-834"></a></span>
<span id="cb36-835"><a href="#cb36-835"></a>We can use the <span class="in">`pluck()`</span> function from the <span class="in">`purrr`</span> package (part of the </span>
<span id="cb36-836"><a href="#cb36-836"></a>tidyverse) to extract the parts of the <span class="in">`bus_stops`</span> object that we want. If we </span>
<span id="cb36-837"><a href="#cb36-837"></a>extract the SF object called <span class="in">`osm_points`</span> and look at the first few rows using </span>
<span id="cb36-838"><a href="#cb36-838"></a><span class="in">`bus_stops |&gt; pluck("osm_points") |&gt; head(n = 5)`</span>, we can see:</span>
<span id="cb36-839"><a href="#cb36-839"></a></span>
<span id="cb36-842"><a href="#cb36-842"></a><span class="in">```{r}</span></span>
<span id="cb36-843"><a href="#cb36-843"></a>bus_stops <span class="sc">|&gt;</span> <span class="fu">pluck</span>(<span class="st">"osm_points"</span>) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">5</span>)</span>
<span id="cb36-844"><a href="#cb36-844"></a><span class="in">```</span></span>
<span id="cb36-845"><a href="#cb36-845"></a></span>
<span id="cb36-846"><a href="#cb36-846"></a>We can see from this that most of the fields are blank, but there is a <span class="in">`name`</span></span>
<span id="cb36-847"><a href="#cb36-847"></a>column and a <span class="in">`geometry`</span> column that we can use to plot the locations of the</span>
<span id="cb36-848"><a href="#cb36-848"></a>bus stops.</span>
<span id="cb36-849"><a href="#cb36-849"></a></span>
<span id="cb36-850"><a href="#cb36-850"></a>We also need to check the contents of the <span class="in">`osm_polygons`</span> layer inside the </span>
<span id="cb36-851"><a href="#cb36-851"></a><span class="in">`bus_stops`</span> object, to see if it contains details of a any more bus stops that</span>
<span id="cb36-852"><a href="#cb36-852"></a>are not included in the <span class="in">`osm_points`</span> layer. </span>
<span id="cb36-853"><a href="#cb36-853"></a></span>
<span id="cb36-854"><a href="#cb36-854"></a></span>
<span id="cb36-855"><a href="#cb36-855"></a>::: {.tutorial}</span>
<span id="cb36-856"><a href="#cb36-856"></a></span>
<span id="cb36-857"><a href="#cb36-857"></a>Type the code needed to extract the <span class="in">`osm_polygons`</span> layer and view the first few </span>
<span id="cb36-858"><a href="#cb36-858"></a>rows.</span>
<span id="cb36-859"><a href="#cb36-859"></a></span>
<span id="cb36-860"><a href="#cb36-860"></a><span class="in">```{r osm-exercise3, exercise=TRUE}</span></span>
<span id="cb36-861"><a href="#cb36-861"></a></span>
<span id="cb36-862"><a href="#cb36-862"></a><span class="in">```</span></span>
<span id="cb36-863"><a href="#cb36-863"></a></span>
<span id="cb36-864"><a href="#cb36-864"></a>:::</span>
<span id="cb36-865"><a href="#cb36-865"></a></span>
<span id="cb36-866"><a href="#cb36-866"></a></span>
<span id="cb36-867"><a href="#cb36-867"></a>::: {.book}</span>
<span id="cb36-868"><a href="#cb36-868"></a></span>
<span id="cb36-869"><a href="#cb36-869"></a>To check this, we can again use the <span class="in">`pluck()`</span> function:</span>
<span id="cb36-870"><a href="#cb36-870"></a></span>
<span id="cb36-871"><a href="#cb36-871"></a>:::</span>
<span id="cb36-872"><a href="#cb36-872"></a></span>
<span id="cb36-873"><a href="#cb36-873"></a></span>
<span id="cb36-874"><a href="#cb36-874"></a><span class="in">```{r osm-exercise3-solution}</span></span>
<span id="cb36-875"><a href="#cb36-875"></a><span class="in">bus_stops |&gt; pluck("osm_polygons") |&gt; head(5)</span></span>
<span id="cb36-876"><a href="#cb36-876"></a><span class="in">```</span></span>
<span id="cb36-877"><a href="#cb36-877"></a></span>
<span id="cb36-878"><a href="#cb36-878"></a>In this case, we can see that there are </span>
<span id="cb36-879"><a href="#cb36-879"></a><span class="in">`r scales::comma(nrow(bus_stops$osm_polygons))`</span> rows in the <span class="in">`osm_polygons`</span></span>
<span id="cb36-880"><a href="#cb36-880"></a>object. In cases where we have data contained in both the <span class="in">`osm_points`</span> and </span>
<span id="cb36-881"><a href="#cb36-881"></a><span class="in">`osm_polygons`</span> layers, we need to merge the two layers by converting the polygon </span>
<span id="cb36-882"><a href="#cb36-882"></a>layer to a point layer using the <span class="in">`st_centroid()`</span> function and then  merging the </span>
<span id="cb36-883"><a href="#cb36-883"></a>two layers using the <span class="in">`bind_rows()`</span> function from the <span class="in">`dplyr`</span> package. We can put </span>
<span id="cb36-884"><a href="#cb36-884"></a>all this together into one piece of code.</span>
<span id="cb36-885"><a href="#cb36-885"></a></span>
<span id="cb36-886"><a href="#cb36-886"></a><span class="in">```{r osm-exercise4, exercise=TRUE}</span></span>
<span id="cb36-887"><a href="#cb36-887"></a><span class="in">bind_rows(</span></span>
<span id="cb36-888"><a href="#cb36-888"></a><span class="in">  pluck(bus_stops, "osm_points"), </span></span>
<span id="cb36-889"><a href="#cb36-889"></a><span class="in">  st_centroid(pluck(bus_stops, "osm_polygons"))</span></span>
<span id="cb36-890"><a href="#cb36-890"></a><span class="in">)</span></span>
<span id="cb36-891"><a href="#cb36-891"></a><span class="in">```</span></span>
<span id="cb36-892"><a href="#cb36-892"></a></span>
<span id="cb36-893"><a href="#cb36-893"></a></span>
<span id="cb36-894"><a href="#cb36-894"></a>&lt;div class="box extra-detail"&gt;</span>
<span id="cb36-895"><a href="#cb36-895"></a></span>
<span id="cb36-896"><a href="#cb36-896"></a>&lt;h5 id="osm-box1-title" class="box-title"&gt;What does the warning <span class="in">`st_centroid assumes …`</span> mean?&lt;/h5&gt;</span>
<span id="cb36-897"><a href="#cb36-897"></a></span>
<span id="cb36-898"><a href="#cb36-898"></a>&lt;div id="osm-box1" class="box-content"&gt;</span>
<span id="cb36-899"><a href="#cb36-899"></a></span>
<span id="cb36-900"><a href="#cb36-900"></a>You might have seen a warning saying </span>
<span id="cb36-901"><a href="#cb36-901"></a><span class="in">`st_centroid assumes attributes are constant over geometries of x`</span>. You will see</span>
<span id="cb36-902"><a href="#cb36-902"></a>this warning when you use the <span class="in">`st_centroid()`</span> function. It is there to remind</span>
<span id="cb36-903"><a href="#cb36-903"></a>you that columns in the original data (which the SF package refers to as the</span>
<span id="cb36-904"><a href="#cb36-904"></a>_attributes_ associated with each spatial feature) refer to the polygon as a </span>
<span id="cb36-905"><a href="#cb36-905"></a>whole, but in the object produced by <span class="in">`st_centroid()`</span> it will appear that the</span>
<span id="cb36-906"><a href="#cb36-906"></a>columns relate to the centroid point. In many cases this will not be a problem,</span>
<span id="cb36-907"><a href="#cb36-907"></a>but it could expose you to the ecological fallacy so it is sometimes useful to </span>
<span id="cb36-908"><a href="#cb36-908"></a>be reminded.</span>
<span id="cb36-909"><a href="#cb36-909"></a></span>
<span id="cb36-910"><a href="#cb36-910"></a>&lt;/div&gt;</span>
<span id="cb36-911"><a href="#cb36-911"></a></span>
<span id="cb36-912"><a href="#cb36-912"></a>&lt;/div&gt;</span>
<span id="cb36-913"><a href="#cb36-913"></a></span>
<span id="cb36-914"><a href="#cb36-914"></a>&lt;script&gt;</span>
<span id="cb36-915"><a href="#cb36-915"></a><span class="fu">$</span>(<span class="st">"#osm-box1-title"</span>)<span class="op">.</span><span class="fu">click</span>(<span class="kw">function</span> () { <span class="fu">$</span>(<span class="st">"#osm-box1"</span>)<span class="op">.</span><span class="fu">toggle</span>(<span class="st">"slow"</span>) })</span>
<span id="cb36-916"><a href="#cb36-916"></a>&lt;/script&gt;</span>
<span id="cb36-917"><a href="#cb36-917"></a></span>
<span id="cb36-918"><a href="#cb36-918"></a></span>
<span id="cb36-919"><a href="#cb36-919"></a>This code references the <span class="in">`bus_stops`</span> object twice, which means we cannot use</span>
<span id="cb36-920"><a href="#cb36-920"></a>this code within a pipeline in the usual way. This means it will be necessary to</span>
<span id="cb36-921"><a href="#cb36-921"></a>save the result produced by <span class="in">`osmdata_sf()`</span> in an object and then combine the</span>
<span id="cb36-922"><a href="#cb36-922"></a>points and polygon centroids in a separate piece of code.</span>
<span id="cb36-923"><a href="#cb36-923"></a></span>
<span id="cb36-924"><a href="#cb36-924"></a></span>
<span id="cb36-925"><a href="#cb36-925"></a>::: {.tutorial}</span>
<span id="cb36-926"><a href="#cb36-926"></a></span>
<span id="cb36-927"><a href="#cb36-927"></a>We now have everything we need to map homicides in La Candelaria in relation to </span>
<span id="cb36-928"><a href="#cb36-928"></a>bus stops. Create a map showing a suitable base map, the density of </span>
<span id="cb36-929"><a href="#cb36-929"></a>homicides in the La Candelaria neighbourhood, the locations of bus stop as </span>
<span id="cb36-930"><a href="#cb36-930"></a>individual points and the boundary of the neighbourhood.</span>
<span id="cb36-931"><a href="#cb36-931"></a></span>
<span id="cb36-932"><a href="#cb36-932"></a>You will need to:</span>
<span id="cb36-933"><a href="#cb36-933"></a></span>
<span id="cb36-934"><a href="#cb36-934"></a><span class="ss">  1. </span>Create an object holding the boundary of the La Candelaria neighbourhood.</span>
<span id="cb36-935"><a href="#cb36-935"></a>     Remember the boundaries of Medellin neighbourhoods are contained in the</span>
<span id="cb36-936"><a href="#cb36-936"></a>     <span class="in">`medellin_comunas`</span> object.</span>
<span id="cb36-937"><a href="#cb36-937"></a><span class="ss">  2. </span>Estimate the density of homicides in the La Candelaria neighbourhood. The</span>
<span id="cb36-938"><a href="#cb36-938"></a>     homicide locations are stored in the <span class="in">`medellin_homicides`</span> object, although</span>
<span id="cb36-939"><a href="#cb36-939"></a>     you will probably want to extract only those in La Candelaria before</span>
<span id="cb36-940"><a href="#cb36-940"></a>     estimating the density.</span>
<span id="cb36-941"><a href="#cb36-941"></a><span class="ss">  3. </span>Extract the bounding box of the neighbourhood boundary and use that to get</span>
<span id="cb36-942"><a href="#cb36-942"></a>     the locations of bus stops, taking into account that some bus stops might </span>
<span id="cb36-943"><a href="#cb36-943"></a>     be stored in the OSM database as points and others as polygons.</span>
<span id="cb36-944"><a href="#cb36-944"></a><span class="ss">  4. </span>Create a map showing the density of homicides, the locations of bus stops</span>
<span id="cb36-945"><a href="#cb36-945"></a>     and the boundary of the neighbourhood.</span>
<span id="cb36-946"><a href="#cb36-946"></a></span>
<span id="cb36-947"><a href="#cb36-947"></a></span>
<span id="cb36-948"><a href="#cb36-948"></a><span class="in">```{r osm-exercise5, exercise=TRUE, message=FALSE, warning=FALSE, exercise.lines=68, fig.asp=1, out.width="100%"}</span></span>
<span id="cb36-949"><a href="#cb36-949"></a></span>
<span id="cb36-950"><a href="#cb36-950"></a><span class="in">```</span></span>
<span id="cb36-951"><a href="#cb36-951"></a></span>
<span id="cb36-952"><a href="#cb36-952"></a>:::</span>
<span id="cb36-953"><a href="#cb36-953"></a></span>
<span id="cb36-954"><a href="#cb36-954"></a></span>
<span id="cb36-955"><a href="#cb36-955"></a>::: {.book}</span>
<span id="cb36-956"><a href="#cb36-956"></a></span>
<span id="cb36-957"><a href="#cb36-957"></a>Now that we have everything we need, we can create a map of homicides in La</span>
<span id="cb36-958"><a href="#cb36-958"></a>Candelaria.</span>
<span id="cb36-959"><a href="#cb36-959"></a></span>
<span id="cb36-960"><a href="#cb36-960"></a>:::</span>
<span id="cb36-961"><a href="#cb36-961"></a></span>
<span id="cb36-962"><a href="#cb36-962"></a></span>
<span id="cb36-963"><a href="#cb36-963"></a><span class="in">```{r osm-exercise5-solution}</span></span>
<span id="cb36-964"><a href="#cb36-964"></a><span class="in"># There are lots of design decisions you could make in producing a map -- the</span></span>
<span id="cb36-965"><a href="#cb36-965"></a><span class="in"># following code is a minimal map, which you could improve on in several ways</span></span>
<span id="cb36-966"><a href="#cb36-966"></a></span>
<span id="cb36-967"><a href="#cb36-967"></a><span class="in"># Load data</span></span>
<span id="cb36-968"><a href="#cb36-968"></a><span class="in">medellin_comunas &lt;- read_sf("https://mpjashby.github.io/crimemappingdata/medellin_comunas.gpkg") |&gt; </span></span>
<span id="cb36-969"><a href="#cb36-969"></a><span class="in">  janitor::clean_names() |&gt; </span></span>
<span id="cb36-970"><a href="#cb36-970"></a><span class="in">  st_transform("EPSG:3115") |&gt; </span></span>
<span id="cb36-971"><a href="#cb36-971"></a><span class="in">  select(nombre, geom)</span></span>
<span id="cb36-972"><a href="#cb36-972"></a><span class="in">medellin_homicides &lt;- read_csv2("https://mpjashby.github.io/crimemappingdata/medellin_homicides.csv") |&gt; </span></span>
<span id="cb36-973"><a href="#cb36-973"></a><span class="in">  remove_missing(vars = c("longitud", "latitud")) |&gt; </span></span>
<span id="cb36-974"><a href="#cb36-974"></a><span class="in">  st_as_sf(coords = c("longitud", "latitud"), crs = "EPSG:4326")</span></span>
<span id="cb36-975"><a href="#cb36-975"></a></span>
<span id="cb36-976"><a href="#cb36-976"></a><span class="in"># Create neighbourhood boundary</span></span>
<span id="cb36-977"><a href="#cb36-977"></a><span class="in">la_candelaria &lt;- medellin_comunas |&gt; </span></span>
<span id="cb36-978"><a href="#cb36-978"></a><span class="in">  filter(nombre == "LA CANDELARIA") |&gt; </span></span>
<span id="cb36-979"><a href="#cb36-979"></a><span class="in">  # This object needs to use the same co-ordinate system as `medellin_homicides`</span></span>
<span id="cb36-980"><a href="#cb36-980"></a><span class="in">  # so we can use `st_intersection()`, so transform it first</span></span>
<span id="cb36-981"><a href="#cb36-981"></a><span class="in">  st_transform("EPSG:3115")</span></span>
<span id="cb36-982"><a href="#cb36-982"></a></span>
<span id="cb36-983"><a href="#cb36-983"></a><span class="in"># Estimate homicide density</span></span>
<span id="cb36-984"><a href="#cb36-984"></a><span class="in">la_candelaria_homicide_density &lt;- medellin_homicides |&gt; </span></span>
<span id="cb36-985"><a href="#cb36-985"></a><span class="in">  st_transform("EPSG:3115") |&gt; </span></span>
<span id="cb36-986"><a href="#cb36-986"></a><span class="in">  # Extract only those homicides occurring within the La Candelaria </span></span>
<span id="cb36-987"><a href="#cb36-987"></a><span class="in">  # neighbourhood boundary (otherwise `hotspot_kde()` will be very slow)</span></span>
<span id="cb36-988"><a href="#cb36-988"></a><span class="in">  st_intersection(la_candelaria) |&gt; </span></span>
<span id="cb36-989"><a href="#cb36-989"></a><span class="in">  hotspot_kde(</span></span>
<span id="cb36-990"><a href="#cb36-990"></a><span class="in">    grid = hotspot_grid(la_candelaria, cell_size = 100), </span></span>
<span id="cb36-991"><a href="#cb36-991"></a><span class="in">    bandwidth_adjust = 0.33,</span></span>
<span id="cb36-992"><a href="#cb36-992"></a><span class="in">    quiet = TRUE</span></span>
<span id="cb36-993"><a href="#cb36-993"></a><span class="in">  ) |&gt; </span></span>
<span id="cb36-994"><a href="#cb36-994"></a><span class="in">  st_intersection(la_candelaria)</span></span>
<span id="cb36-995"><a href="#cb36-995"></a></span>
<span id="cb36-996"><a href="#cb36-996"></a><span class="in"># Get bus stop locations</span></span>
<span id="cb36-997"><a href="#cb36-997"></a><span class="in">bus_stops &lt;- la_candelaria |&gt; </span></span>
<span id="cb36-998"><a href="#cb36-998"></a><span class="in">  # `opq()` needs longitude/latitude co-ordinates, so transform before </span></span>
<span id="cb36-999"><a href="#cb36-999"></a><span class="in">  # calculating the bounding box</span></span>
<span id="cb36-1000"><a href="#cb36-1000"></a><span class="in">  st_transform("EPSG:4326") |&gt; </span></span>
<span id="cb36-1001"><a href="#cb36-1001"></a><span class="in">  st_bbox() |&gt; </span></span>
<span id="cb36-1002"><a href="#cb36-1002"></a><span class="in">  opq() |&gt; </span></span>
<span id="cb36-1003"><a href="#cb36-1003"></a><span class="in">  # Define the features we want</span></span>
<span id="cb36-1004"><a href="#cb36-1004"></a><span class="in">  add_osm_feature(key = "highway", value = "bus_stop") |&gt; </span></span>
<span id="cb36-1005"><a href="#cb36-1005"></a><span class="in">  # Download those features for that area</span></span>
<span id="cb36-1006"><a href="#cb36-1006"></a><span class="in">  osmdata_sf()</span></span>
<span id="cb36-1007"><a href="#cb36-1007"></a></span>
<span id="cb36-1008"><a href="#cb36-1008"></a><span class="in"># Extract bus stop locations as points</span></span>
<span id="cb36-1009"><a href="#cb36-1009"></a><span class="in">bus_stop_points &lt;- bind_rows(</span></span>
<span id="cb36-1010"><a href="#cb36-1010"></a><span class="in">  pluck(bus_stops, "osm_points"), </span></span>
<span id="cb36-1011"><a href="#cb36-1011"></a><span class="in">  st_centroid(pluck(bus_stops, "osm_polygons"))</span></span>
<span id="cb36-1012"><a href="#cb36-1012"></a><span class="in">)</span></span>
<span id="cb36-1013"><a href="#cb36-1013"></a></span>
<span id="cb36-1014"><a href="#cb36-1014"></a><span class="in"># Plot map</span></span>
<span id="cb36-1015"><a href="#cb36-1015"></a><span class="in">ggplot() +</span></span>
<span id="cb36-1016"><a href="#cb36-1016"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb36-1017"><a href="#cb36-1017"></a><span class="in">  geom_sf(</span></span>
<span id="cb36-1018"><a href="#cb36-1018"></a><span class="in">    aes(fill = kde), </span></span>
<span id="cb36-1019"><a href="#cb36-1019"></a><span class="in">    data = la_candelaria_homicide_density, </span></span>
<span id="cb36-1020"><a href="#cb36-1020"></a><span class="in">    alpha = 0.7, </span></span>
<span id="cb36-1021"><a href="#cb36-1021"></a><span class="in">    colour = NA</span></span>
<span id="cb36-1022"><a href="#cb36-1022"></a><span class="in">  ) +</span></span>
<span id="cb36-1023"><a href="#cb36-1023"></a><span class="in">  geom_sf(data = la_candelaria, colour = "grey40", fill = NA, linewidth = 1.5) +</span></span>
<span id="cb36-1024"><a href="#cb36-1024"></a><span class="in">  geom_sf(data = bus_stop_points, colour = "darkred") +</span></span>
<span id="cb36-1025"><a href="#cb36-1025"></a><span class="in">  scale_fill_distiller(</span></span>
<span id="cb36-1026"><a href="#cb36-1026"></a><span class="in">    direction = 1, </span></span>
<span id="cb36-1027"><a href="#cb36-1027"></a><span class="in">    breaks = range(pull(la_candelaria_homicide_density, "kde")),</span></span>
<span id="cb36-1028"><a href="#cb36-1028"></a><span class="in">    labels = c("lower", "higher")</span></span>
<span id="cb36-1029"><a href="#cb36-1029"></a><span class="in">  ) +</span></span>
<span id="cb36-1030"><a href="#cb36-1030"></a><span class="in">  labs(</span></span>
<span id="cb36-1031"><a href="#cb36-1031"></a><span class="in">    caption = str_glue(</span></span>
<span id="cb36-1032"><a href="#cb36-1032"></a><span class="in">      "Contains data from OpenStreetMap\n",</span></span>
<span id="cb36-1033"><a href="#cb36-1033"></a><span class="in">      "Homicide data: Alcaldía de Medellín (CC-BY-SA)"</span></span>
<span id="cb36-1034"><a href="#cb36-1034"></a><span class="in">    ),</span></span>
<span id="cb36-1035"><a href="#cb36-1035"></a><span class="in">    fill = "homicide\ndensity"</span></span>
<span id="cb36-1036"><a href="#cb36-1036"></a><span class="in">  ) +</span></span>
<span id="cb36-1037"><a href="#cb36-1037"></a><span class="in">  # We can add the `fixed_plot_aspect()` function to the `ggplot()` stack to</span></span>
<span id="cb36-1038"><a href="#cb36-1038"></a><span class="in">  # force the map to be square, rather than a rectangle</span></span>
<span id="cb36-1039"><a href="#cb36-1039"></a><span class="in">  fixed_plot_aspect() +</span></span>
<span id="cb36-1040"><a href="#cb36-1040"></a><span class="in">  theme_void()</span></span>
<span id="cb36-1041"><a href="#cb36-1041"></a><span class="in">```</span></span>
<span id="cb36-1042"><a href="#cb36-1042"></a></span>
<span id="cb36-1043"><a href="#cb36-1043"></a>From this map, it looks like homicides do not cluster particularly around bus</span>
<span id="cb36-1044"><a href="#cb36-1044"></a>stops. This would probably be welcome information for the city's public </span>
<span id="cb36-1045"><a href="#cb36-1045"></a>transport managers.</span>
<span id="cb36-1046"><a href="#cb36-1046"></a></span>
<span id="cb36-1047"><a href="#cb36-1047"></a></span>
<span id="cb36-1048"><a href="#cb36-1048"></a>::: {.box .notewell}</span>
<span id="cb36-1049"><a href="#cb36-1049"></a></span>
<span id="cb36-1050"><a href="#cb36-1050"></a>Just as with other sources of map data, you are legally required to </span>
<span id="cb36-1051"><a href="#cb36-1051"></a><span class="co">[</span><span class="ot">cite data from OpenStreetMap</span><span class="co">](https://wiki.openstreetmap.org/wiki/Draft_Attribution_Guideline)</span></span>
<span id="cb36-1052"><a href="#cb36-1052"></a>if you use it. The code in the exercise above, for example, cites data from two</span>
<span id="cb36-1053"><a href="#cb36-1053"></a>sources:</span>
<span id="cb36-1054"><a href="#cb36-1054"></a></span>
<span id="cb36-1055"><a href="#cb36-1055"></a><span class="ss">  * </span>"Contains data from OpenStreetMap" acknowledges that both the base map and</span>
<span id="cb36-1056"><a href="#cb36-1056"></a>    the bus-stop locations were obtained from OpenStreetMap.</span>
<span id="cb36-1057"><a href="#cb36-1057"></a><span class="ss">  * </span>"Homicide data: Alcaldía de Medellín (CC-BY-SA)" acknowledges that the</span>
<span id="cb36-1058"><a href="#cb36-1058"></a>    Medellin homicide data were released by the Mayor of Medellin under the</span>
<span id="cb36-1059"><a href="#cb36-1059"></a>    <span class="co">[</span><span class="ot">Creative Commons Attribution Share-alike</span><span class="co">](https://opendefinition.org/licenses/cc-by-sa/)</span> </span>
<span id="cb36-1060"><a href="#cb36-1060"></a>    (CC-BY-SA) licence.</span>
<span id="cb36-1061"><a href="#cb36-1061"></a></span>
<span id="cb36-1062"><a href="#cb36-1062"></a>:::</span>
<span id="cb36-1063"><a href="#cb36-1063"></a></span>
<span id="cb36-1064"><a href="#cb36-1064"></a></span>
<span id="cb36-1065"><a href="#cb36-1065"></a>&lt;p class="credits"&gt;The OpenStreetMap logo is a trademark of the OpenStreetMap Foundation, and is used with their permission. This tutorial not endorsed by or affiliated with the OpenStreetMap Foundation.&lt;/p&gt;</span>
<span id="cb36-1066"><a href="#cb36-1066"></a></span>
<span id="cb36-1067"><a href="#cb36-1067"></a></span>
<span id="cb36-1068"><a href="#cb36-1068"></a></span>
<span id="cb36-1069"><a href="#cb36-1069"></a><span class="fu">## In summary</span></span>
<span id="cb36-1070"><a href="#cb36-1070"></a></span>
<span id="cb36-1071"><a href="#cb36-1071"></a></span>
<span id="cb36-1072"><a href="#cb36-1072"></a>::: {.box .welldone}</span>
<span id="cb36-1073"><a href="#cb36-1073"></a></span>
<span id="cb36-1074"><a href="#cb36-1074"></a>In this tutorial we have learned how to find open data, including data from</span>
<span id="cb36-1075"><a href="#cb36-1075"></a>OpenStreetMap, and add it to our maps to help readers better understand crime </span>
<span id="cb36-1076"><a href="#cb36-1076"></a>patterns. We will be able to use these skills to add data to future maps that</span>
<span id="cb36-1077"><a href="#cb36-1077"></a>we make so that readers can gain more insight into crime patterns or other</span>
<span id="cb36-1078"><a href="#cb36-1078"></a>phenomena that we might be analysing.</span>
<span id="cb36-1079"><a href="#cb36-1079"></a></span>
<span id="cb36-1080"><a href="#cb36-1080"></a>:::</span>
<span id="cb36-1081"><a href="#cb36-1081"></a></span>
<span id="cb36-1082"><a href="#cb36-1082"></a></span>
<span id="cb36-1083"><a href="#cb36-1083"></a>::: {.box .reading}</span>
<span id="cb36-1084"><a href="#cb36-1084"></a></span>
<span id="cb36-1085"><a href="#cb36-1085"></a>To find out more about the skills we have worked on in this tutorial, you may</span>
<span id="cb36-1086"><a href="#cb36-1086"></a>want to read:</span>
<span id="cb36-1087"><a href="#cb36-1087"></a></span>
<span id="cb36-1088"><a href="#cb36-1088"></a><span class="ss">  * </span><span class="co">[</span><span class="ot">a paper exploring how open crime data can be used in researching crime</span><span class="co">](https://doi.org/10.1080/15230406.2014.972456)</span>, and</span>
<span id="cb36-1089"><a href="#cb36-1089"></a><span class="ss">  * </span><span class="co">[</span><span class="ot">a more-detailed introduction to the `osmdata` package written by Mark Padgham and Robin Lovelace</span><span class="co">](https://docs.ropensci.org/osmdata/articles/osmdata.html)</span>.</span>
<span id="cb36-1090"><a href="#cb36-1090"></a></span>
<span id="cb36-1091"><a href="#cb36-1091"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by/4.0/">
<p>This book is available under a Creative Commons Attribution 4.0 International licence</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>