<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>12&nbsp; Handling messy data – Learn Crime Mapping with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../13_crime_series/index.html" rel="next">
<link href="../11_mapping_hotspots/index.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<!-- START OF INCLUDED HEADER -->

<!--
This file contains code that will be included in the header of each page of the
quarto book
-->

<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>

<!-- END OF INCLUDED HEADER -->
<script src="../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../include/webex.css">
<meta name="twitter:title" content="12&nbsp; Handling messy data – Learn Crime Mapping with R">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="../images/cover_image.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../12_messy_data/index.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/cover_image.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Learn Crime Mapping with R</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/mpjashby/crimemappingbook/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../learn_crime_mapping_with_r.epub" title="Download ePub" class="quarto-navigation-tool px-1" aria-label="Download ePub"><i class="bi bi-journal"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install the software needed for this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_getting_started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_your_first_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Your first crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_data_wrangling/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_your_second_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Your second crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_code_with_style/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Code with style</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_mapping_crime_patterns/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping crime patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_map_context/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Giving a map context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_handling_bugs/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Handling bugs in your code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_mapping_areas/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Mapping area data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../10_place_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../11_mapping_hotspots/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../12_messy_data/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../13_crime_series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Mapping crime series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../14_writing_reports/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Writing reports in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../15_no_maps/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Presenting spatial data without maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../16_mapping_time/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Mapping crime over time</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/read_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Functions for reading data into R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/map_checklist.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Checklist: Making a good crime map</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/common_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Common R errors and how to fix them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/functions_to_avoid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Some R functions you should avoid</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/handling_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Checklist: handling code errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">In this chapter</h2>
   
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">12.1</span> Introduction</a></li>
  <li><a href="#tidying-the-structure-of-data" id="toc-tidying-the-structure-of-data" class="nav-link" data-scroll-target="#tidying-the-structure-of-data"><span class="header-section-number">12.2</span> Tidying the structure of data</a></li>
  <li><a href="#tidying-the-content-of-cells" id="toc-tidying-the-content-of-cells" class="nav-link" data-scroll-target="#tidying-the-content-of-cells"><span class="header-section-number">12.3</span> Tidying the content of cells</a></li>
  <li><a href="#geocoding-locations" id="toc-geocoding-locations" class="nav-link" data-scroll-target="#geocoding-locations"><span class="header-section-number">12.4</span> Geocoding locations</a></li>
  <li><a href="#conflicts-between-function-names" id="toc-conflicts-between-function-names" class="nav-link" data-scroll-target="#conflicts-between-function-names"><span class="header-section-number">12.5</span> Conflicts between function names</a></li>
  <li><a href="#in-summary" id="toc-in-summary" class="nav-link" data-scroll-target="#in-summary"><span class="header-section-number">12.6</span> In summary</a></li>
  </ul>
<div class="toc-actions"><ul class="collapse"><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Learn how to tidy messy data so that it is easier to use for data analysis.</strong></p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>This chapter has not yet been updated for 2025, so some material is out of date. Check back for an update in mid-February 2025.</p>
</div>
</div>
<section id="introduction" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">12.1</span> Introduction</h2>
<p>Data is the foundation of everything we do in crime mapping. To make a crime map needs data on the locations and types of crimes; data on roads, buildings and natural features to make up a base map, and data on other features (such as particular types of facility) that might be relevant to why crime happens in particular place.</p>
<p class="full-width-image">
<img src="images/tidydata_1.jpg" alt="Cartoon explaining that tidy data is a standard way of mapping the meaning of a dataset to its structure. In tidy data each variable forms a column, each observation forms a row and each cell is a single measurement.">
</p>
<p>Until now, all the data we have used has been <em>tidy data</em>. Data is tidy if it comes in a particular format where every <em>variable</em> (e.g.&nbsp;the date on which a crime occurred) is stored in a separate <em>column</em> and data for every <em>observation</em> (e.g.&nbsp;all the data about a particular crime, a particular offender etc.) is stored in a separate <em>row</em>. For typical crime data, that means each crime is represented by one row in the data and each thing that we know about that crime is stored in a separate column.</p>
<p>Unfortunately, not all the data we might like to use in crime mapping is available in a tidy format. The people, organisations and systems and produce data store it in many formats, which are often not tidy and not easy to analyse. Messy data is more difficult to work with because every messy dataset has a unique structure, which we have to remember every time we want to work with it.</p>
<p>Tidy data, on the other hand, is easier to work with because its format is familiar and consistent. Many R functions are also designed to work with tidy data, so tidying our datasets often makes analysis quicker, too.</p>
<p>The first step to analysing messy data is therefore to wrangle it into a tidy format. We have already seen this principle at work when we use the <code>clean_names()</code> function from the <code>janitor</code> package to convert column names into a consistent format so that we don’t have to keep remembering which unique format the column names are in.</p>
<p>In this tutorial we will learn how to tidy messy data to make it easier to work with.</p>
<p class="credits">
<a href="https://github.com/allisonhorst/stats-illustrations">Stats Illustrations by Allison Horst</a> licensed under the <a href="https://github.com/allisonhorst/stats-illustrations/blob/master/license">Creative Commons Attribution licence</a>.
</p>
</section>
<section id="tidying-the-structure-of-data" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="tidying-the-structure-of-data"><span class="header-section-number">12.2</span> Tidying the structure of data</h2>
<p class="full-width-image">
<img src="images/tidydata_2.jpg" alt="Cartoon explaining that the standard structure of tidy data means that all tidy datasets are alike but every messy dataset is messy in its own way.">
</p>
<p>Every messy dataset is messy in its own unique way, but often messiness comes from the structure of data not being tidy. Tabular data can come in two general formats: <em>long</em> and <em>wide</em>. For example, imagine a dataset showing counts of several different types of crime in several different areas. We could store this data in wide format, where there is a column for the name of the area and then a column for each type of crime.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">area</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">assault</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">robbery</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">burglary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Northville</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">Middletown</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Southam</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">10</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Wide-format data are often useful for presentation – you might often see a table like this in a report or article. But wide data are less useful for analysis because one of the variables – ‘type of crime’ – is being stored not as a variable but in the various column names. One sign that your data has this problem is if several of the columns form a group of columns, separate from the others. In this case, there is a group of columns that show crime counts that is different from the other column that shows the area name.</p>
<p>Fortunately, we can easily convert this data (which is stored in the object <code>crime_counts</code>) into long format using the <code>pivot_longer()</code> function from the <code>tidyr</code> package. To use <code>pivot_longer()</code>, we have to specify in the <code>cols</code> argument which columns we want to ‘gather’ together into one column to store the category names and one column to store the values. We can specify the columns we want to gather as a vector, i.e.&nbsp;<code>c(assault, burglary, robbery)</code>.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">pivot_longer</span>(crime_counts, <span class="at">cols =</span> <span class="fu">c</span>(assault, burglary, robbery))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 9 × 3
  area       name     value
  &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt;
1 Northville assault      4
2 Northville burglary    10
3 Northville robbery      2
4 Middletown assault      6
5 Middletown burglary    20
6 Middletown robbery      5
7 Southam    assault     10
8 Southam    burglary    10
9 Southam    robbery      0</code></pre>
</div>
</div>
<p>By default, <code>pivot_longer()</code> calls the new column of category names <code>name</code> and the new column of values <code>value</code>. We can specify more-descriptive names using the <code>names_to</code> and <code>values_to</code> arguments.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">pivot_longer</span>(</span>
<span id="cb3-2"><a href="#cb3-2"></a>  crime_counts, </span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="at">cols =</span> <span class="fu">c</span>(assault, burglary, robbery), </span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="at">names_to =</span> <span class="st">"type"</span>, </span>
<span id="cb3-5"><a href="#cb3-5"></a>  <span class="at">values_to =</span> <span class="st">"count"</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 9 × 3
  area       type     count
  &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt;
1 Northville assault      4
2 Northville burglary    10
3 Northville robbery      2
4 Middletown assault      6
5 Middletown burglary    20
6 Middletown robbery      5
7 Southam    assault     10
8 Southam    burglary    10
9 Southam    robbery      0</code></pre>
</div>
</div>
<p>It is better to have the names of different categories stored as a single variable rather than as the names of several variables because they are easier to work with that way. For example, if the data are in long format you could sort the categories alphabetically using <code>arrange(crime_counts, type)</code>, or you could transform the names to title case using <code>mutate(crime_counts, type = str_to_title(type))</code>. Both these operations would be harder to do if the data were in wide format.</p>
<p>A common reason for data to be stored in wide format is where repeated observations are made of some value over time. For example, we might have monthly counts of crimes for different areas.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">area</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">jan_2020</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">feb_2020</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mar_2020</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">apr_2020</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">may_2020</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Northville</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">Middletown</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Southam</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">14</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Storing data in this way is particularly awkward because variable names can only contain text, so R does not know that the column names represent dates. This means, for example, that we could not filter the dataset to only include data from after a certain date.</p>
<p>When we want to gather a large number of columns together, it can get tedious to type all the column names for the <code>cols</code> argument to <code>pivot_longer()</code>. Instead, since we want to gather all the columns except one, we can just specify that we should <em>not</em> gather the <code>area</code> column, which implicitly tells <code>pivot_longer()</code> to gather all the other columns. We tell <code>pivot_longer()</code> not to gather the area column by specifying <code>cols = -area</code> (note the minus sign in front of the column name).</p>
<div class="tutorial">
<p>Run the code needed to gather a dataset called <code>monthly_counts</code> so that the names of the monthly counts are stored in a variable called <code>month</code> and the monthly counts themselves are stored in a variable called <code>count</code>.</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">pivot_longer</span>(</span>
<span id="cb5-2"><a href="#cb5-2"></a>  monthly_counts, </span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="at">cols =</span> <span class="sc">-</span>area, </span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="at">names_to =</span> <span class="st">"month"</span>, </span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="at">values_to =</span> <span class="st">"count"</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 15 × 3
   area       month    count
   &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt;
 1 Northville jan_2020    13
 2 Northville feb_2020    10
 3 Northville mar_2020    12
 4 Northville apr_2020     9
 5 Northville may_2020    10
 6 Middletown jan_2020    21
 7 Middletown feb_2020    19
 8 Middletown mar_2020    22
 9 Middletown apr_2020    19
10 Middletown may_2020    20
11 Southam    jan_2020    15
12 Southam    feb_2020    13
13 Southam    mar_2020    16
14 Southam    apr_2020    15
15 Southam    may_2020    14</code></pre>
</div>
</div>
<p>There is still a problem with this data, which is that the <code>month</code> variable contains not date values but instead the month and year stored as text. We will learn how to deal with this issue in a future tutorial.</p>
<section id="skipping-unwanted-rows-in-imported-data" class="level3" data-number="12.2.1">
<h3 data-number="12.2.1" class="anchored" data-anchor-id="skipping-unwanted-rows-in-imported-data"><span class="header-section-number">12.2.1</span> Skipping unwanted rows in imported data</h3>
<p>Data released by government organisations are often designed to be viewed by humans rather than processed by statistical software. We can see this in this screen shot of a <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/crimeandjustice/datasets/crimeinenglandandwalesexperimentaltables">dataset produced by the UK Office for National Statistics on cybercrime in the UK</a> based on responses to the Crime Survey for England and Wales.</p>
<p class="full-width-image">
<img src="images/ons_data1.png" alt="Screen shot of an Excel sheet of data from the UK Office for National Statistics, showing that there are multiple header rows above the data and blank rows within the data.">
</p>
<p>Looking at the row numbers on the left-hand side, we can see that the that the first row is taken up not with the column names (as in a tidy dataset) but with the title of the dataset. The next row is blank, and the third row then contains some metadata to say that the data relates to England and Wales and to adults aged 16 and over. Only on row four do we see the column names. There are also blank rows within the data that are used to separate out different categories of data.</p>
<p>If we try to import this data using, for example, the <code>read_excel()</code> function from the <code>readxl</code> package, we will find various problems.</p>
<div class="sourceCode" id="cb7" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co"># Since `.xlsx` files are binary files, we need to add `mode = "wb"` on Windows.</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co"># On other platforms it makes no difference, but adding `mode = "wb" does not</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co"># cause any problems.</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="fu">download.file</span>(</span>
<span id="cb7-7"><a href="#cb7-7"></a>  <span class="at">url =</span> <span class="st">"https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/crimeandjustice/datasets/crimeinenglandandwalesexperimentaltables/yearendingdecember2018/additionalfraudandcybercrimetablesyearendingdecember2018correction.xlsx"</span>,</span>
<span id="cb7-8"><a href="#cb7-8"></a>  <span class="at">destfile =</span> <span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>),</span>
<span id="cb7-9"><a href="#cb7-9"></a>  <span class="at">mode =</span> <span class="st">"wb"</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>)</span>
<span id="cb7-11"><a href="#cb7-11"></a></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="fu">read_excel</span>(<span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>), <span class="at">sheet =</span> <span class="st">"Table E1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>New names:
• `` -&gt; `...2`
• `` -&gt; `...3`
• `` -&gt; `...4`
• `` -&gt; `...5`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 46 × 5
   Table E1:  Fraud and computer misuse by loss (of mo…¹ ...2  ...3  ...4  ...5 
   &lt;chr&gt;                                                 &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
 1 &lt;NA&gt;                                                  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 2 England and Wales                                     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  Adul…
 3 Offence group3                                        Numb… Rate… Numb… Perc…
 4 &lt;NA&gt;                                                  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 5 FRAUD5                                                3648  78.0… 3078  6.58…
 6 &lt;NA&gt;                                                  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 7 With loss, no or only partial reimbursement           660   14.1… 613   1.31…
 8 With loss, fully reimbursed                           2066  44.2… 1765  3.77…
 9 Without loss                                          922   19.7… 804   1.72…
10 &lt;NA&gt;                                                  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
# ℹ 36 more rows
# ℹ abbreviated name:
#   ¹​`Table E1:  Fraud and computer misuse by loss (of money or property) - number and rate of incidents and number and percentage of victims, year ending December 2018 CSEW1,2`</code></pre>
</div>
</div>
<p>It’s clear that this dataset has not loaded in the way that we want, because the first row doesn’t contain the column names. Fortunately, we can deal with this problem using the <code>skip</code> argument to the <code>read_excel()</code> function. This allows us to specify a number of rows to ignore at the start of the dataset. In this case, we want to ignore the first three rows of the data (the table title, a blank line and the the metadata line), so we can specify <code>skip = 3</code>. The same <code>skip</code> argument also exists in the <code>read_csv()</code> function for reading CSV data and the <code>read_tsv()</code> function for reading tab-separated data.</p>
<div class="sourceCode" id="cb10" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">read_excel</span>(</span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>), </span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="at">sheet =</span> <span class="st">"Table E1"</span>, </span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="at">skip =</span> <span class="dv">3</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 43 × 5
   `Offence group3`                Number of incidents …¹ Rate per 1,000 adult…²
   &lt;chr&gt;                                            &lt;dbl&gt;                  &lt;dbl&gt;
 1 &lt;NA&gt;                                                NA                  NA   
 2 FRAUD5                                            3648                  78.0 
 3 &lt;NA&gt;                                                NA                  NA   
 4 With loss, no or only partial …                    660                  14.1 
 5 With loss, fully reimbursed                       2066                  44.2 
 6 Without loss                                       922                  19.7 
 7 &lt;NA&gt;                                                NA                  NA   
 8 Bank and credit account fraud                     2433                  52.0 
 9 With loss, no or only partial …                    235                   5.03
10 With loss, fully reimbursed                       1727                  36.9 
# ℹ 33 more rows
# ℹ abbreviated names: ¹​`Number of incidents (thousands)`,
#   ²​`Rate per 1,000 adults`
# ℹ 2 more variables: `Number of victims (thousands)4` &lt;dbl&gt;,
#   `Percentage victims once or more4` &lt;dbl&gt;</code></pre>
</div>
</div>
<p>This has dealt with the problem caused by the extra rows at the top of the data. But if we look at the bottom of the dataset, we will see that there are also several rows of footnotes. These footnotes are important for us to have read so that we understand the data, but they aren’t part of the data itself.</p>
<p class="full-width-image">
<img src="images/ons_data2.png" alt="Screen shot of an Excel sheet of data from the UK Office for National Statistics, showing that there are multiple footer rows below the data.">
</p>
<p>We can remove these extra rows at the end of our data using the <code>slice()</code> function from the <code>dplyr</code> package. <code>slice()</code> allows us to choose certain rows from our data by row number. Looking at the screen shot above, our data finishes on row 34 (row 36 looks like part of our data but the value there actually shows the number of people involved in the survey, not a number of incidents). But:</p>
<ul>
<li>we have already removed the first three rows using the <code>skip</code> argument to <code>read_excel()</code>, and</li>
<li>row four of the original spreadsheet has become our column names,</li>
</ul>
<p>so row 34 on the spreadsheet is actually row 30 in our loaded dataset. Knowing this, we can remove all the rows below row 30 using <code>slice()</code>:</p>
<div class="sourceCode" id="cb12" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="fu">read_excel</span>(<span class="at">sheet =</span> <span class="st">"Table E1"</span>, <span class="at">skip =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 30 × 5
   `Offence group3`                Number of incidents …¹ Rate per 1,000 adult…²
   &lt;chr&gt;                                            &lt;dbl&gt;                  &lt;dbl&gt;
 1 &lt;NA&gt;                                                NA                  NA   
 2 FRAUD5                                            3648                  78.0 
 3 &lt;NA&gt;                                                NA                  NA   
 4 With loss, no or only partial …                    660                  14.1 
 5 With loss, fully reimbursed                       2066                  44.2 
 6 Without loss                                       922                  19.7 
 7 &lt;NA&gt;                                                NA                  NA   
 8 Bank and credit account fraud                     2433                  52.0 
 9 With loss, no or only partial …                    235                   5.03
10 With loss, fully reimbursed                       1727                  36.9 
# ℹ 20 more rows
# ℹ abbreviated names: ¹​`Number of incidents (thousands)`,
#   ²​`Rate per 1,000 adults`
# ℹ 2 more variables: `Number of victims (thousands)4` &lt;dbl&gt;,
#   `Percentage victims once or more4` &lt;dbl&gt;</code></pre>
</div>
</div>
<p>The final problem with the structure of this dataset is the blank rows that are used to separate different crime categories in the original table. We can deal with this using the <code>remove_empty()</code> function from the <code>janitor</code> package, which removes all rows and/or columns that contain only <code>NA</code> values. We will also clean the column names at the same time and then rename the columns to be shorter, which will make it easier to refer to them in our code.</p>
<div class="sourceCode" id="cb14" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="fu">read_excel</span>(<span class="at">sheet =</span> <span class="st">"Table E1"</span>, <span class="at">skip =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-6"><a href="#cb14-6"></a>  <span class="fu">remove_empty</span>(<span class="at">which =</span> <span class="st">"rows"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-7"><a href="#cb14-7"></a>  <span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb14-8"><a href="#cb14-8"></a>  <span class="fu">rename</span>(</span>
<span id="cb14-9"><a href="#cb14-9"></a>    <span class="at">offence =</span> offence_group3, </span>
<span id="cb14-10"><a href="#cb14-10"></a>    <span class="at">crimes =</span> number_of_incidents_thousands, </span>
<span id="cb14-11"><a href="#cb14-11"></a>    <span class="at">incidence =</span> rate_per_1_000_adults, </span>
<span id="cb14-12"><a href="#cb14-12"></a>    <span class="at">victims =</span> number_of_victims_thousands_4, </span>
<span id="cb14-13"><a href="#cb14-13"></a>    <span class="at">prevalence =</span> percentage_victims_once_or_more4</span>
<span id="cb14-14"><a href="#cb14-14"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 22 × 5
   offence                                   crimes incidence victims prevalence
   &lt;chr&gt;                                      &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;
 1 FRAUD5                                      3648     78.0     3078      6.58 
 2 With loss, no or only partial reimbursem…    660     14.1      613      1.31 
 3 With loss, fully reimbursed                 2066     44.2     1765      3.78 
 4 Without loss                                 922     19.7      804      1.72 
 5 Bank and credit account fraud               2433     52.0     2056      4.40 
 6 With loss, no or only partial reimbursem…    235      5.03     211      0.451
 7 With loss, fully reimbursed                 1727     36.9     1458      3.12 
 8 Without loss                                 470     10.1      419      0.896
 9 Consumer and retail fraud6                  1031     22.1      954      2.04 
10 With loss, no or only partial reimbursem…    380      8.13     361      0.771
# ℹ 12 more rows</code></pre>
</div>
</div>
<p>This dataset now has a tidy structure: each row represents an observation (in this case, data about a particular type of crime), each column represents a piece of information about the observation and each cell represents a single value. We still need to clean up the footnote numbers that appear in some of the values, but we will deal with that later in this tutorial.</p>
</section>
<section id="separating-multiple-variables-stored-in-a-single-column" class="level3" data-number="12.2.2">
<h3 data-number="12.2.2" class="anchored" data-anchor-id="separating-multiple-variables-stored-in-a-single-column"><span class="header-section-number">12.2.2</span> Separating multiple variables stored in a single column</h3>
<p>Sometimes datasets include multiple variables in a single column. For example, data about crime victims stored in an object called <code>victims</code> might include a single column representing both age and sex.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">first_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">last_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">age_sex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Lyda</td>
<td style="text-align: left;">Gartrell</td>
<td style="text-align: left;">40/F</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kareem</td>
<td style="text-align: left;">David</td>
<td style="text-align: left;">26</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Lisa</td>
<td style="text-align: left;">Dean</td>
<td style="text-align: left;">21/F</td>
</tr>
<tr class="even">
<td style="text-align: left;">Melina</td>
<td style="text-align: left;">Shehan</td>
<td style="text-align: left;">25/F</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Alfredo</td>
<td style="text-align: left;">Matamoros</td>
<td style="text-align: left;">18/M</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>It would be easier to wrangle this data (e.g.&nbsp;to filter by age) if the data in the <code>age_sex</code> column was stored in two separate columns. Making this change would also make sure our data meets the definition of being tidy: every variable should be stored in a separate column.</p>
<p>We can split the <code>age_sex</code> column into two using the <code>separate()</code> function from the <code>tidyr</code> package. We specify the existing column we want to split using the <code>col</code> argument, the names of the new columns we want to create using the <code>into</code> argument and the character(s) that represent the boundary between the two pieces of data in each column (in this case, <code>/</code>).</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb16" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">separate</span>(victims, <span class="at">col =</span> age_sex, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>), <span class="at">sep =</span> <span class="st">"/"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: Expected 2 pieces. Missing pieces filled with `NA` in 1 rows [2].</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 5 × 4
  first_name last_name age   sex  
  &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;
1 Lyda       Gartrell  40    F    
2 Kareem     David     26    &lt;NA&gt; 
3 Lisa       Dean      21    F    
4 Melina     Shehan    25    F    
5 Alfredo    Matamoros 18    M    </code></pre>
</div>
</div>
<p>You might have noticed that this function produced a warning message saying <code>Expected 2 pieces. Missing pieces filled with NA in 1 rows [2]</code>. This is because the second row of data in the <code>victims</code> object only contains one of the two pieces of data. When this happens, <code>separate()</code> fills in the values that are present from the left, filling any remaining columns to the right with <code>NA</code>. If this is what we want (as it is here), we can silence this warning by specifying <code>fill = "right"</code>. If instead we wanted <code>separate()</code> to fill in columns with <code>NA</code> values from the left, we could specify <code>fill = "left"</code>.</p>
<p>Another issue with the separated data is that because the column <code>age_sex</code> was a character column, both <code>age</code> and <code>sex</code> are character columns, too. Since <code>age</code> is actually numeric, we can get <code>separate()</code> to convert this new column to the correct type automatically by specifying <code>convert = TRUE</code>.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb19" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">separate</span>(</span>
<span id="cb19-2"><a href="#cb19-2"></a>  victims, </span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="at">col =</span> age_sex, </span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>), </span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="at">sep =</span> <span class="st">"/"</span>,</span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="at">convert =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-7"><a href="#cb19-7"></a>  <span class="at">fill =</span> <span class="st">"right"</span></span>
<span id="cb19-8"><a href="#cb19-8"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 5 × 4
  first_name last_name   age sex  
  &lt;chr&gt;      &lt;chr&gt;     &lt;int&gt; &lt;chr&gt;
1 Lyda       Gartrell     40 F    
2 Kareem     David        26 &lt;NA&gt; 
3 Lisa       Dean         21 F    
4 Melina     Shehan       25 F    
5 Alfredo    Matamoros    18 M    </code></pre>
</div>
</div>
<p>We now know how to convert a data into a tidy format using <code>pivot_longer()</code> to convert data to long format, remove non-data rows using <code>slice()</code>, <code>remove_empty()</code> and the <code>skip</code> argument to many functions like <code>read_csv()</code>, and split columns with <code>separate()</code>. In the next section, we’ll learn how to tidy the content of individual cells.</p>
<p class="credits">
<a href="https://github.com/allisonhorst/stats-illustrations">Stats Illustrations by Allison Horst</a> licensed under the <a href="https://github.com/allisonhorst/stats-illustrations/blob/master/license">Creative Commons Attribution licence</a>.
</p>
</section>
</section>
<section id="tidying-the-content-of-cells" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="tidying-the-content-of-cells"><span class="header-section-number">12.3</span> Tidying the content of cells</h2>
<p>As well as data with a messy structure, you might be provided with data with messy content inside some of the cells. In this section we will clean messy content, mostly using functions from the <code>stringr</code> package that is loaded automatically when we load <code>tidyverse</code>. All the functions in the <code>stringr</code> package start with <code>str_</code> so that they are easy to remember.</p>
<p>We can change the case of text using one of four <code>str_to_</code> functions:</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">input</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">function</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A stRinG oF TeXT</td>
<td style="text-align: left;">`st_to_lower()`</td>
<td style="text-align: left;">a string of text</td>
</tr>
<tr class="even">
<td style="text-align: left;">A stRinG oF TeXT</td>
<td style="text-align: left;">`st_to_upper()`</td>
<td style="text-align: left;">A STRING OF TEXT</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A stRinG oF TeXT</td>
<td style="text-align: left;">`st_to_sentence()`</td>
<td style="text-align: left;">A string of text</td>
</tr>
<tr class="even">
<td style="text-align: left;">A stRinG oF TeXT</td>
<td style="text-align: left;">`st_to_title()`</td>
<td style="text-align: left;">A String Of Text</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can also remove unwanted text from within values. For example, if there is unwanted white-space (spaces, tabs, etc.) at the beginning or end of a string of characters, we can remove it with <code>str_trim()</code>. <code>str_squish()</code> does the same thing, but also reduces any repeated white-space characters in a string of text down to a single space. For example, <code>str_squish("  A string   of text")</code> produces the result <code>A string of text</code>.</p>
<p class="full-width-image">
<img src="images/str_squish.jpg" alt="Cartoon explaining that the str_squish() function removes leading, trailing and repeated interior whitespace from strings.">
</p>
<p>Data from the UK police open data website includes the words ‘on or near’ at the start of every value in the <code>location</code> column of the data. This is to remind users that the locations of crimes are deliberately obscured by being ‘snapped’ to the centre of the street on which they occur to protect victims’ privacy.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">month</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">longitude</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">latitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">location</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">lsoa_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-01</td>
<td style="text-align: right;">-1.120</td>
<td style="text-align: right;">53.3</td>
<td style="text-align: left;">On or near Supermarket</td>
<td style="text-align: left;">Bassetlaw 013C</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-02</td>
<td style="text-align: right;">-0.993</td>
<td style="text-align: right;">53.2</td>
<td style="text-align: left;">On or near Turner Lane</td>
<td style="text-align: left;">Newark and Sherwood 001A</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-05</td>
<td style="text-align: right;">-1.250</td>
<td style="text-align: right;">53.1</td>
<td style="text-align: left;">On or near Brookdale Road</td>
<td style="text-align: left;">Ashfield 004C</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-08</td>
<td style="text-align: right;">-1.160</td>
<td style="text-align: right;">53.0</td>
<td style="text-align: left;">On or near Raithby Close</td>
<td style="text-align: left;">Nottingham 006B</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-10</td>
<td style="text-align: right;">-1.180</td>
<td style="text-align: right;">53.0</td>
<td style="text-align: left;">On or near Bowden Avenue</td>
<td style="text-align: left;">Ashfield 013A</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We don’t need this constant value for analysis, and for large datasets it can unnecessarily increase the size of the data when we save it to a file. For this reason we might want to remove this constant value using the <code>str_remove()</code> function.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb21" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="fu">mutate</span>(uk_data, <span class="at">location =</span> <span class="fu">str_remove</span>(location, <span class="st">"On or near "</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 5 × 5
  month   longitude latitude location       lsoa_name               
  &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt;                   
1 2020-01    -1.12      53.3 Supermarket    Bassetlaw 013C          
2 2020-02    -0.993     53.2 Turner Lane    Newark and Sherwood 001A
3 2020-05    -1.25      53.1 Brookdale Road Ashfield 004C           
4 2020-08    -1.16      53   Raithby Close  Nottingham 006B         
5 2020-10    -1.18      53   Bowden Avenue  Ashfield 013A           </code></pre>
</div>
</div>
<p>The <code>lsoa_name</code> code of this dataset includes the name of the small statistical area in which each crime occurred. Each name is made up of the name of the local government district covering the area followed by a unique code. If we wanted to extract just the district name (for example so we could count the number of crimes in each district) we can do that by removing the code that follows the district name. To do this we need to use a <em>regular expression</em>, which is a way of describing a pattern in a string of characters. Regular expressions can be used to find, extract or remove characters that match a specified pattern.</p>
<p>Regular expressions can be complicated, so we will only scratch the surface of what’s possible here. You can find out much more about about them in the <a href="https://stringr.tidyverse.org/articles/regular-expressions.html">article on regular expressions included in the <code>stringr</code> package</a>. The coded description of the pattern of characters we need to match the code at the end of the <code>lsoa_name</code> column is <code>\\s\\w{4}$</code>. This is made up three parts:</p>
<ul>
<li><code>\\s</code> means match exactly one white-space character (e.g.&nbsp;a space or a tab),</li>
<li><code>\\w{4}</code> means match exactly four word characters (i.e.&nbsp;any letter, any number or some punctuation marks), and</li>
<li><code>$</code> means match the end of the string.</li>
</ul>
<p>So <code>\\s\\w{4}$</code> means match exactly one white-space character followed by exactly four word characters at the end of the string. We can use this pattern as the second argument to the <code>str_remove()</code> function to remove the characters matched by the pattern.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb23" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu">mutate</span>(uk_data, <span class="at">district =</span> <span class="fu">str_remove</span>(lsoa_name, <span class="st">"</span><span class="sc">\\</span><span class="st">s</span><span class="sc">\\</span><span class="st">w{4}$"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 5 × 6
  month   longitude latitude location                  lsoa_name        district
  &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;                     &lt;chr&gt;            &lt;chr&gt;   
1 2020-01    -1.12      53.3 On or near Supermarket    Bassetlaw 013C   Bassetl…
2 2020-02    -0.993     53.2 On or near Turner Lane    Newark and Sher… Newark …
3 2020-05    -1.25      53.1 On or near Brookdale Road Ashfield 004C    Ashfield
4 2020-08    -1.16      53   On or near Raithby Close  Nottingham 006B  Notting…
5 2020-10    -1.18      53   On or near Bowden Avenue  Ashfield 013A    Ashfield</code></pre>
</div>
</div>
<p>We could also use regular expressions together with <code>str_extract()</code> to keep only the characters matched by the pattern, <code>str_replace()</code> to replace the first group of characters matched by the pattern and <code>str_replace_all()</code> to replace all the groups of characters matched by the pattern. For more tips on using regular expressions together with functions from the <code>stringr</code> package, see the <a href="https://github.com/rstudio/cheatsheets/blob/main/strings.pdf"><code>stringr</code> package cheat sheet</a> or visit <a href="https://regexr.com/">regexr.com</a>.</p>
<section id="converting-between-types-of-variable" class="level3" data-number="12.3.1">
<h3 data-number="12.3.1" class="anchored" data-anchor-id="converting-between-types-of-variable"><span class="header-section-number">12.3.1</span> Converting between types of variable</h3>
<p>Sometimes columns in your data will be stored as the wrong type of variable. <code>read_csv()</code> and other functions from the <code>readr</code> package try to guess what type of variable is contained in each column based on what is contained in the first few rows, but this does not always work. For example, a variable containing numbers might be stored as characters, meaning functions like <code>mean()</code> will not work. In cases like this, we can use the <code>as.numeric()</code> function to convert the character variable into a numeric variable.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb25" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># Some numbers stored as text (note the quote marks around each number)</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>numbers_as_text <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"14"</span>, <span class="st">"6"</span>, <span class="st">"17"</span>)</span>
<span id="cb25-3"><a href="#cb25-3"></a></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="co"># Trying to find the mean of these numbers stored as characters will produce </span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="co"># `NA` and a warning</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="fu">mean</span>(numbers_as_text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning in mean.default(numbers_as_text): argument is not numeric or logical:
returning NA</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># If we use `as.numeric()` then `mean()` now works</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="fu">mean</span>(<span class="fu">as.numeric</span>(numbers_as_text))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] 12.33333</code></pre>
</div>
</div>
<p><img src="images/parse_number.jpg" alt="Cartoon showing that the parse_number() function extracts numeric values from text, stripping out all non-numeric characters." class="right-side-image" style="width: 400px; max-width: 50%;"></p>
<p>We can use equivalent functions to convert columns to different types, e.g. <code>as.character()</code> to convert a variable to characters and <code>as.logical()</code> to convert a variable to only <code>TRUE</code> and <code>FALSE</code> values. Be careful, though: if you try to convert a variable to a data type that makes no sense, you are likely to find all of your values replaced with <code>NA</code>.</p>
<p>Sometimes numbers will be stored alongside other values, such as when currency values are stored together with a currency symbol. We can deal with values like these by using the <code>parse_number()</code> function from the <code>readr</code> package, which strips all the non-numeric characters from a value and then converts the numeric characters to a number. For example, <code>parse_number("Room 14A")</code> produces the numeric value <code>14</code>.</p>
</section>
<section id="recoding-categorical-variables" class="level3" data-number="12.3.2">
<h3 data-number="12.3.2" class="anchored" data-anchor-id="recoding-categorical-variables"><span class="header-section-number">12.3.2</span> Recoding categorical variables</h3>
<p>Crime data often includes categorical variables, such as crime types or location categories. It can be useful to change these categories, for example so that we can join two datasets or abbreviate category names for use in the axis labels of a chart.</p>
<p>We can use the <code>if_else()</code> function from the <code>dplyr</code> package to change particular values, but this only allows us to change a single value and can produce slightly untidy code. Instead we can use the <code>recode()</code> function from the <code>dplyr</code> package to change one or more values at the same time. For example, if we wanted to change the value <code>Supermarket</code> to <code>Shop</code> in the UK police data.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb30" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="co"># Once again we will remove the unnecessary 'On or near ' using `str_remove()`</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="fu">mutate</span>(</span>
<span id="cb30-3"><a href="#cb30-3"></a>  uk_data, </span>
<span id="cb30-4"><a href="#cb30-4"></a>  <span class="at">location =</span> <span class="fu">recode</span>(</span>
<span id="cb30-5"><a href="#cb30-5"></a>    <span class="fu">str_remove</span>(location, <span class="st">"On or near "</span>),</span>
<span id="cb30-6"><a href="#cb30-6"></a>    <span class="st">"Supermarket"</span> <span class="ot">=</span> <span class="st">"Shop"</span></span>
<span id="cb30-7"><a href="#cb30-7"></a>  )</span>
<span id="cb30-8"><a href="#cb30-8"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 5 × 5
  month   longitude latitude location       lsoa_name               
  &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt;                   
1 2020-01    -1.12      53.3 Shop           Bassetlaw 013C          
2 2020-02    -0.993     53.2 Turner Lane    Newark and Sherwood 001A
3 2020-05    -1.25      53.1 Brookdale Road Ashfield 004C           
4 2020-08    -1.16      53   Raithby Close  Nottingham 006B         
5 2020-10    -1.18      53   Bowden Avenue  Ashfield 013A           </code></pre>
</div>
</div>
<div class="tutorial">
<p>Run the code needed to change the value <code>Nottingham</code> to <code>City of Nottingham</code> in the <code>district</code> column in the <code>uk_data</code> object (you will need to create the <code>district</code> column from the <code>lsoa_name</code> first).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>uk_data <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-3"><a href="#cb32-3"></a>    <span class="at">district =</span> <span class="fu">str_remove</span>(lsoa_name, <span class="st">"</span><span class="sc">\\</span><span class="st">s</span><span class="sc">\\</span><span class="st">w{4}$"</span>),</span>
<span id="cb32-4"><a href="#cb32-4"></a>    <span class="at">district =</span> <span class="fu">recode</span>(district, <span class="st">"Nottingham"</span> <span class="ot">=</span> <span class="st">"City of Nottingham"</span>)</span>
<span id="cb32-5"><a href="#cb32-5"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb32-6"><a href="#cb32-6"></a>  <span class="co"># Select only some columns to make the result easier to see below</span></span>
<span id="cb32-7"><a href="#cb32-7"></a>  <span class="fu">select</span>(lsoa_name, district)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 5 × 2
  lsoa_name                district           
  &lt;chr&gt;                    &lt;chr&gt;              
1 Bassetlaw 013C           Bassetlaw          
2 Newark and Sherwood 001A Newark and Sherwood
3 Ashfield 004C            Ashfield           
4 Nottingham 006B          City of Nottingham 
5 Ashfield 013A            Ashfield           </code></pre>
</div>
</div>
</div>
</section>
<section id="missing-values" class="level3" data-number="12.3.3">
<h3 data-number="12.3.3" class="anchored" data-anchor-id="missing-values"><span class="header-section-number">12.3.3</span> Missing values</h3>
<p>We have already encountered the <code>NA</code> value, which R uses to represent a value that is missing from a dataset. While R uses <code>NA</code> to represent missing values, some data providers use other codes. For example, a data provider might use a dash (<code>-</code>) or two periods (<code>..</code>) to represent missing values. Fortunately, we can convert any value to <code>NA</code> so that we know that it represents a missing value.</p>
<p>Imagine that you have been provided with a dataset of burglaries that includes an estimate of the value of the goods that were stolen in British pounds. You have been told that when the value of the stolen goods wasn’t known, this is recorded as the value <code>-1</code> in the data. If we use <code>mean()</code> to estimate the average value of property stolen, the value <code>-1</code> will give us an incorrect result. If we instead convert that value to <code>NA</code> first, <code>mean()</code> will know to ignore that value as long as we specify the argument <code>na.rm = TRUE</code>.</p>
<div class="cell" data-exercise="true" data-exercise.lines="16">
<div class="sourceCode cell-code" id="cb34" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="co"># Print some rows of burglary values</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="fu">head</span>(burglary_values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 5 × 2
  date                value
  &lt;dttm&gt;              &lt;dbl&gt;
1 2020-01-02 08:34:23  1320
2 2020-01-08 02:59:50   653
3 2020-01-18 22:35:15  2068
4 2020-01-09 11:10:05    -1
5 2020-01-12 08:16:58   580</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="co"># Try to calculate the mean value -- no error, but the answer is wrong</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="co"># `pull()` is used to extract the `value` column from `burglary_values`</span></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="fu">mean</span>(<span class="fu">pull</span>(burglary_values, <span class="st">"value"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] 924</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="co"># Convert `-1` to `NA` first, now you get the correct mean value</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>burglary_values <span class="ot">&lt;-</span> <span class="fu">mutate</span>(</span>
<span id="cb38-3"><a href="#cb38-3"></a>  burglary_values,</span>
<span id="cb38-4"><a href="#cb38-4"></a>  <span class="at">value =</span> <span class="fu">if_else</span>(value <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>, <span class="cn">NA_real_</span>, value)</span>
<span id="cb38-5"><a href="#cb38-5"></a>)</span>
<span id="cb38-6"><a href="#cb38-6"></a></span>
<span id="cb38-7"><a href="#cb38-7"></a><span class="co"># Calculate the mean value again, now excluding the missing value</span></span>
<span id="cb38-8"><a href="#cb38-8"></a><span class="fu">mean</span>(<span class="fu">pull</span>(burglary_values, <span class="st">"value"</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] 1155.25</code></pre>
</div>
</div>
<p>Excluding the value <code>-1</code> makes a substantial difference to the mean, increasing it by over £100.</p>
</section>
<section id="null-island" class="level3" data-number="12.3.4">
<h3 data-number="12.3.4" class="anchored" data-anchor-id="null-island"><span class="header-section-number">12.3.4</span> Null Island</h3>
<p>The problem of missing values being stored as numbers manifests itself in a particularly frustrating way when it comes to spatial data. People and organisations that produce spatial datasets sometimes recording missing co-ordinates as being <em>zero</em>, instead of being <em>missing</em>. This is a problem because the longitude/latitude co-ordinates “0, 0” correspond to a real location on the surface of the earth, in the Gulf of Guinea off the coast of Ghana. This location is incorrectly recorded in spatial datasets so often that it’s become known as <em>Null Island</em>. Watch this video to find out more about Null Island and the problems it causes.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/bjvIpI-1w84" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>So if you see any co-ordinates on your map located in the Atlantic off the south coast of West Africa, you know that there are almost certainly rows in your data that have co-ordinates located at Null Island.</p>
<p class="full-width-image">
<img src="images/null_island.jpg" alt="A globe map showing Null Island at co-ordinates of 0 longitude and latitude" style="max-height: 700px;">
</p>
<p>When we make crime maps we are generally dealing with small areas such as cities and counties. So if you plot a dataset on a map and instead of seeing a map of the area you are interested in, you see a large area of the world with the place you are interested in in one corner and Null Island in the opposite corner, that almost certainly means some co-ordinates are located at Null Island.</p>
<p>As an example, imagine we were trying to create a map of the home addresses of several (fictional) suspects for bank fraud in and around Cairo, Egypt. The data contain 10 rows stored in an object called <code>cairo_suspects</code> that looks like this:</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 16%">
<col style="width: 65%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">address</th>
<th style="text-align: left;">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Ahmed Hussein Ayman</td>
<td style="text-align: left;">94, El Sheikh Abd El Jalil Issa Street, Al Banafseg 8, Banafseg Districts, New Cairo City, Cairo</td>
<td style="text-align: left;">POINT (31.46236 30.04954)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mohamed Ali Mohamed</td>
<td style="text-align: left;">22, Noran Street, Al Salam First, Al Qalyubiya</td>
<td style="text-align: left;">POINT (31.4032 30.16475)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mahmoud Mostafa Ali</td>
<td style="text-align: left;">43, Tarek Gamal Street, Cairo</td>
<td style="text-align: left;">POINT (31.29651 30.11844)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Omar El-Badawi</td>
<td style="text-align: left;">7, Abou Bakr Al Sediq Street, Al-Obour, Al Qalyubiya</td>
<td style="text-align: left;">POINT (31.37844 30.17814)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tarek Hazim Abdel-Rahman</td>
<td style="text-align: left;">16, Al Madina Al Mnoura Street, Ma‘ di, Cairo</td>
<td style="text-align: left;">POINT (31.26321 29.97942)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Youssef Sayyid</td>
<td style="text-align: left;">18, Fathy Abou Wedn Street, Shubra al Khayma, Al Qalyubiya</td>
<td style="text-align: left;">POINT (31.34177 30.15624)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Hussein El-Masri</td>
<td style="text-align: left;">61, Al Ashgar Street, South West, El Shorouk City, May Fair, Cairo</td>
<td style="text-align: left;">POINT (31.61096 30.12838)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mariam Abdel Mubarak</td>
<td style="text-align: left;">15R, Mohamed Farid Street, EL Sheikh Mubarak, Cairo</td>
<td style="text-align: left;">POINT (31.24903 29.99366)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Farah Youssef Anwar</td>
<td style="text-align: left;">35, Al Sadat Road, Neighborhood 9, El Shorouk City, Sunrise, Cairo</td>
<td style="text-align: left;">POINT (31.6281 30.1478)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Nour El-Seifi</td>
<td style="text-align: left;">23, Moustafa Kamel Street, Area 2, Badr, Cairo</td>
<td style="text-align: left;">POINT (0 0)</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>If we plotted these locations on a map, we might expect to see something like this:</p>
<p class="full-width-image">
<img src="images/null_island_cairo1.jpg" alt="A map showing several points in the city of Cairo, Egypt">
</p>
<p>But look again at the final row of data in the table above – the co-ordinates for the final row are both zero. There are several reasons why this might be. Perhaps the address was recorded incorrectly in a police database and that meant that when the addresses were run through geocoding software (which we will learn more about in the next section), no co-ordinates for that row could be found. What this means is that when we plot the data on a map, that map will actually look like this:</p>
<p class="full-width-image">
<img src="images/null_island_cairo2.jpg" alt="A map showing a large proportion of Africa, with several points clustered around the city of Cairo, Egypt in the top-right corner and a single point located in the Atlantic Ocean off the coast of Ghana.">
</p>
<p>What we can see here is most of the points on this map are correctly located in and around Cairo, but a single point is incorrectly located at Null Island.</p>
<p>We can deal with the problem of our data including points located at Null Island using the <code>st_intersection()</code> function that we have previously used to clip datasets to the boundaries of other datasets. In this case, we can use <code>st_intersection()</code> to remove any rows from the data that are not within the area that the data is supposed to cover.</p>
<p>For example, we know that all the addresses of bank fraud suspects are supposed to be in Egypt, so we can safely clip the suspect data to the boundary of Egypt before mapping the data. There are lots of sources of data on the outlines of countries, but perhaps the most convenient to use in R is the data provided by the <code>rnaturalearth</code> package. We can use the <code>ne_countries()</code> function to retrieve the outline of Egypt as an SF object, which we can then use to clip the suspect dataset.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb40" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># By default, `ne_countries()` does not return an SF object, so we have to</span></span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="co"># specify that is what we want using the `returnclass = "sf"` argument</span></span>
<span id="cb40-3"><a href="#cb40-3"></a>egypt_outline <span class="ot">&lt;-</span> rnaturalearth<span class="sc">::</span><span class="fu">ne_countries</span>(</span>
<span id="cb40-4"><a href="#cb40-4"></a>  <span class="at">country =</span> <span class="st">"Egypt"</span>, </span>
<span id="cb40-5"><a href="#cb40-5"></a>  <span class="at">returnclass =</span> <span class="st">"sf"</span></span>
<span id="cb40-6"><a href="#cb40-6"></a>)</span>
<span id="cb40-7"><a href="#cb40-7"></a></span>
<span id="cb40-8"><a href="#cb40-8"></a>cairo_suspects_valid <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(cairo_suspects, egypt_outline)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
</div>
<p>Now if we were to plot a map using the <code>cairo_suspects_valid</code> object, we would see the map covered only the Cairo area, as we originally wanted.</p>
</section>
</section>
<section id="geocoding-locations" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="geocoding-locations"><span class="header-section-number">12.4</span> Geocoding locations</h2>
<p>Throughout this course we have used geographic data that includes locations stored as pairs of co-ordinates, e.g.&nbsp;latitude and longitude or easting and northing. Sometimes geographic data will not contain co-ordinates but instead store the locations of places or events as free-text addresses.</p>
<p><a href="http://www.kelleysgrilleandbar.com/" title="Kelley's Grill 
&amp; Bar website"><img src="images/kelleys.jpg" class="right-side-image" style="border: 1px solid #333;"></a></p>
<p>Address fields can be very messy indeed. This is because addresses can often be stored in different formats, include different abbreviations or use different spellings (including typos). For example, the official postal address ‘<a href="http://www.kelleysgrilleandbar.com/">Kelley’s Grill &amp; Bar</a>, 15540 State Avenue, Basehor, Kansas 66007, United States’ could be stored in a local police report as:</p>
<ul>
<li>Kelly’s Bar, 15540 US Highway 40, Basehor</li>
<li>Kelley’s Grille, 15540 State</li>
<li>Kelley’s, 15540 State Av</li>
<li>Kelley’s Bar and Grill, 15540 State Ave</li>
<li>Kelley’s Bar, State Av and 155th St</li>
<li>Kelly’s Grill, State Ave btwn 155 and 158</li>
</ul>
<p>All of these address descriptions would probably be good enough for local police officers to know which building the author intended to reference. But since all these different addresses relate to the same physical location, they would make it very hard to (for example) work out how many incidents had occurred at Kelley’s Grill &amp; Bar using <code>count()</code> or a similar function.</p>
<p>To make use of data containing addresses, it is typically necessary to <em>geocode</em> the locations, i.e.&nbsp;to convert the addresses into co-ordinates. The many ways to describe an address mean that geocoding is often quite hard.</p>
<p><a href="https://jessecambon.github.io/tidygeocoder/" title="tidygeocoder website"><img src="images/tidygeocoder.png" class="right-side-image"></a></p>
<p>We can geocode addresses in R using the <a href="https://jessecambon.github.io/tidygeocoder/"><code>tidygeocoder</code> package</a>, which provides an interface to several online geocoding services.</p>
<p>To run a geocoding service an organisation has to maintain a database of many millions of addresses (which must be constantly updated) and handle addresses in many different formats, so organisations typically charge for these services or limit how many addresses you can geocode for free. Most services also require you to register, even if you are only making few-enough queries that you will not be charged. <code>tidygeocoder</code> supports several geocoding services:</p>
<div class="cell">
<div class="cell-output-display">
<div id="rkcwmnnwgy" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#rkcwmnnwgy table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#rkcwmnnwgy thead, #rkcwmnnwgy tbody, #rkcwmnnwgy tfoot, #rkcwmnnwgy tr, #rkcwmnnwgy td, #rkcwmnnwgy th {
  border-style: none;
}

#rkcwmnnwgy p {
  margin: 0;
  padding: 0;
}

#rkcwmnnwgy .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#rkcwmnnwgy .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#rkcwmnnwgy .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#rkcwmnnwgy .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#rkcwmnnwgy .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#rkcwmnnwgy .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#rkcwmnnwgy .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#rkcwmnnwgy .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#rkcwmnnwgy .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#rkcwmnnwgy .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#rkcwmnnwgy .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#rkcwmnnwgy .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#rkcwmnnwgy .gt_spanner_row {
  border-bottom-style: hidden;
}

#rkcwmnnwgy .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#rkcwmnnwgy .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#rkcwmnnwgy .gt_from_md > :first-child {
  margin-top: 0;
}

#rkcwmnnwgy .gt_from_md > :last-child {
  margin-bottom: 0;
}

#rkcwmnnwgy .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#rkcwmnnwgy .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#rkcwmnnwgy .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#rkcwmnnwgy .gt_row_group_first td {
  border-top-width: 2px;
}

#rkcwmnnwgy .gt_row_group_first th {
  border-top-width: 2px;
}

#rkcwmnnwgy .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#rkcwmnnwgy .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#rkcwmnnwgy .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#rkcwmnnwgy .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#rkcwmnnwgy .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#rkcwmnnwgy .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#rkcwmnnwgy .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#rkcwmnnwgy .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#rkcwmnnwgy .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#rkcwmnnwgy .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#rkcwmnnwgy .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#rkcwmnnwgy .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#rkcwmnnwgy .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#rkcwmnnwgy .gt_left {
  text-align: left;
}

#rkcwmnnwgy .gt_center {
  text-align: center;
}

#rkcwmnnwgy .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#rkcwmnnwgy .gt_font_normal {
  font-weight: normal;
}

#rkcwmnnwgy .gt_font_bold {
  font-weight: bold;
}

#rkcwmnnwgy .gt_font_italic {
  font-style: italic;
}

#rkcwmnnwgy .gt_super {
  font-size: 65%;
}

#rkcwmnnwgy .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#rkcwmnnwgy .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#rkcwmnnwgy .gt_indent_1 {
  text-indent: 5px;
}

#rkcwmnnwgy .gt_indent_2 {
  text-indent: 10px;
}

#rkcwmnnwgy .gt_indent_3 {
  text-indent: 15px;
}

#rkcwmnnwgy .gt_indent_4 {
  text-indent: 20px;
}

#rkcwmnnwgy .gt_indent_5 {
  text-indent: 25px;
}

#rkcwmnnwgy .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#rkcwmnnwgy div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="service" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">service</th>
<th id="coverage" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">coverage</th>
<th id="free-limits" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">free limits</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="service"><a href="https://nominatim.org/">Nominatim</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">1 address per second</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="service"><a href="https://locationiq.com/">Location IQ</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">5,000 addresses per day</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="service"><a href="https://geoapify.com/">Geoapify</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">3,000 addresses per day</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="service"><a href="https://opencagedata.com/">OpenCage</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">2,500 addresses per day</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="service"><a href="https://developer.tomtom.com/">TomTom</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">2,500 addresses per day</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="service"><a href="https://developers.google.com/maps/documentation/geocoding/overview/">Google</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">40,000 addresses per month</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="service"><a href="https://www.geocod.io/">Geocodio</a></td>
<td class="gt_row gt_left" headers="coverage">United States and Canada</td>
<td class="gt_row gt_left" headers="free limits">2,500 addresses per day</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="service"><a href="https://geocoding.geo.census.gov/">US Census</a></td>
<td class="gt_row gt_left" headers="coverage">United States</td>
<td class="gt_row gt_left" headers="free limits">none</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The <code>tidygeocoder</code> package also supports some other services that do not offer any free option – you can find out more about these options on the <a href="https://jessecambon.github.io/tidygeocoder/articles/geocoder_services.html">package website</a>.</p>
<p>To illustrate the geocoding process, we will find co-ordinates for the addresses in the object <code>addresses</code>, which holds data for 10 sexual assaults in Chicago.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">offense_date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">location_type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">address</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2019-01-01 00:00:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">2400 W Carmen Ave</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-01 00:00:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">2700 S TRIPP AVE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-01-01 11:44:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">3700 S PAULINA ST</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-01 11:44:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">3700 S Paulina St</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-01-01 16:37:00</td>
<td style="text-align: left;">government</td>
<td style="text-align: left;">1100 S HAMILTON AVE</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-02 17:09:00</td>
<td style="text-align: left;">gas station</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-01-02 17:09:00</td>
<td style="text-align: left;">gas station</td>
<td style="text-align: left;">8200 S HALSTED ST</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-05 00:01:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">1300 N HUDSON AVE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-01-05 14:00:00</td>
<td style="text-align: left;">other</td>
<td style="text-align: left;">6200 N Claremont Ave</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-07 06:50:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">9500 S BELL AVE</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Since most geocoding services limit the number of addresses you can look up at a time, the first step in geocoding is removing duplicate addresses and rows with missing address values. This avoids us geocoding identical addresses several times, which would otherwise unnecessarily increase our chance of hitting the limit on geocoding queries each day.</p>
<p>We will also add the city and state to the end of each address, since at the moment (as with much data produced by local organisations) it includes only the building number and street.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb42" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>addresses_for_geocoding <span class="ot">&lt;-</span> addresses <span class="sc">|&gt;</span> </span>
<span id="cb42-2"><a href="#cb42-2"></a>  <span class="co"># Drop rows that have NA values in the `address` column</span></span>
<span id="cb42-3"><a href="#cb42-3"></a>  <span class="fu">drop_na</span>(address) <span class="sc">|&gt;</span> </span>
<span id="cb42-4"><a href="#cb42-4"></a>  <span class="co"># Add city and state then convert to upper case so that `count()` will not </span></span>
<span id="cb42-5"><a href="#cb42-5"></a>  <span class="co"># treat identical addresses as different because of different cases, e.g. </span></span>
<span id="cb42-6"><a href="#cb42-6"></a>  <span class="co"># 'ST' vs 'St' as abbreviations for 'Street'</span></span>
<span id="cb42-7"><a href="#cb42-7"></a>  <span class="fu">mutate</span>(<span class="at">address =</span> <span class="fu">str_to_upper</span>(<span class="fu">str_glue</span>(<span class="st">"{address}, CHICAGO, IL"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb42-8"><a href="#cb42-8"></a>  <span class="co"># Select only the address column, since we won't send the other columns to the</span></span>
<span id="cb42-9"><a href="#cb42-9"></a>  <span class="co"># geocoding function</span></span>
<span id="cb42-10"><a href="#cb42-10"></a>  <span class="fu">select</span>(address) <span class="sc">|&gt;</span> </span>
<span id="cb42-11"><a href="#cb42-11"></a>  <span class="co"># Find all the unique rows in the data</span></span>
<span id="cb42-12"><a href="#cb42-12"></a>  <span class="fu">distinct</span>(address)</span>
<span id="cb42-13"><a href="#cb42-13"></a></span>
<span id="cb42-14"><a href="#cb42-14"></a><span class="fu">head</span>(addresses_for_geocoding)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 6 × 1
  address                         
  &lt;chr&gt;                           
1 2400 W CARMEN AVE, CHICAGO, IL  
2 2700 S TRIPP AVE, CHICAGO, IL   
3 3700 S PAULINA ST, CHICAGO, IL  
4 1100 S HAMILTON AVE, CHICAGO, IL
5 8200 S HALSTED ST, CHICAGO, IL  
6 1300 N HUDSON AVE, CHICAGO, IL  </code></pre>
</div>
</div>
<p>Since two addresses in the data were duplicates and one address was missing, we now have eight unique addresses, stored in a tibble with a single column. We can use this as the input to the <code>geocode()</code> function from the <code>tidygeocoder</code> package. The <code>address</code> argument specifies which column in the data contains the addresses and the <code>method</code> column specifies which geocoding service to use. In this case we use the Nominatim service (because it does not require registration and works worldwide). Nominatim is based on OpenStreetMap data, so can be chosen by specifying <code>method = "osm"</code>.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb44" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="fu">library</span>(tidygeocoder)</span>
<span id="cb44-2"><a href="#cb44-2"></a></span>
<span id="cb44-3"><a href="#cb44-3"></a>addresses_geocoded <span class="ot">&lt;-</span> <span class="fu">geocode</span>(</span>
<span id="cb44-4"><a href="#cb44-4"></a>  addresses_for_geocoding, </span>
<span id="cb44-5"><a href="#cb44-5"></a>  <span class="at">address =</span> <span class="st">"address"</span>, </span>
<span id="cb44-6"><a href="#cb44-6"></a>  <span class="at">method =</span> <span class="st">"osm"</span></span>
<span id="cb44-7"><a href="#cb44-7"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Passing 8 addresses to the Nominatim single address geocoder</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Query completed in: 8.1 seconds</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>addresses_geocoded</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 8 × 3
  address                             lat  long
  &lt;chr&gt;                             &lt;dbl&gt; &lt;dbl&gt;
1 2400 W CARMEN AVE, CHICAGO, IL     42.0 -87.7
2 2700 S TRIPP AVE, CHICAGO, IL      41.8 -87.7
3 3700 S PAULINA ST, CHICAGO, IL     41.8 -87.7
4 1100 S HAMILTON AVE, CHICAGO, IL   41.9 -87.7
5 8200 S HALSTED ST, CHICAGO, IL     41.7 -87.6
6 1300 N HUDSON AVE, CHICAGO, IL     41.9 -87.6
7 6200 N CLAREMONT AVE, CHICAGO, IL  42.0 -87.7
8 9500 S BELL AVE, CHICAGO, IL       41.7 -87.7</code></pre>
</div>
</div>
<p>Now that we have the latitude and longitude for each address, we can join that back to the original data using the address column to match the two datasets together. To do this we will create a temporary column in the original <code>addresses</code> object that matches the formatting changes we made to the original address.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb49" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a>addresses <span class="sc">|&gt;</span> </span>
<span id="cb49-2"><a href="#cb49-2"></a>  <span class="co"># Create a temporary address column to use in matching the geocoded addresses</span></span>
<span id="cb49-3"><a href="#cb49-3"></a>  <span class="fu">mutate</span>(<span class="at">temp_address =</span> <span class="fu">str_to_upper</span>(<span class="fu">str_glue</span>(<span class="st">"{address}, CHICAGO, IL"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb49-4"><a href="#cb49-4"></a>  <span class="co"># `left_join()` keeps all the rows in the left-hand dataset (the original</span></span>
<span id="cb49-5"><a href="#cb49-5"></a>  <span class="co"># `addresses` object) and matching rows in the right-hand dataset (the </span></span>
<span id="cb49-6"><a href="#cb49-6"></a>  <span class="co"># geocoding results)</span></span>
<span id="cb49-7"><a href="#cb49-7"></a>  <span class="fu">left_join</span>(addresses_geocoded, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"temp_address"</span> <span class="ot">=</span> <span class="st">"address"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb49-8"><a href="#cb49-8"></a>  <span class="co"># Remove the temporary address column</span></span>
<span id="cb49-9"><a href="#cb49-9"></a>  <span class="fu">select</span>(<span class="sc">-</span>temp_address)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 10 × 5
   offense_date        location_type address                lat  long
   &lt;dttm&gt;              &lt;chr&gt;         &lt;chr&gt;                &lt;dbl&gt; &lt;dbl&gt;
 1 2019-01-01 00:00:00 residence     2400 W Carmen Ave     42.0 -87.7
 2 2019-01-01 00:00:00 residence     2700 S TRIPP AVE      41.8 -87.7
 3 2019-01-01 11:44:00 residence     3700 S PAULINA ST     41.8 -87.7
 4 2019-01-01 11:44:00 residence     3700 S Paulina St     41.8 -87.7
 5 2019-01-01 16:37:00 government    1100 S HAMILTON AVE   41.9 -87.7
 6 2019-01-02 17:09:00 gas station   &lt;NA&gt;                  NA    NA  
 7 2019-01-02 17:09:00 gas station   8200 S HALSTED ST     41.7 -87.6
 8 2019-01-05 00:01:00 residence     1300 N HUDSON AVE     41.9 -87.6
 9 2019-01-05 14:00:00 other         6200 N Claremont Ave  42.0 -87.7
10 2019-01-07 06:50:00 residence     9500 S BELL AVE       41.7 -87.7</code></pre>
</div>
</div>
<p>We can now use this data as we would any other spatial data. We would often start by converting our new object to an SF object using <code>st_as_sf()</code>. In that case, remember that all the geocoding services return co-ordinates as latitude and longitude using the WGS84 co-ordinate reference system, so you should use the EPSG code 4326.</p>
</section>
<section id="conflicts-between-function-names" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="conflicts-between-function-names"><span class="header-section-number">12.5</span> Conflicts between function names</h2>
<p>R packages are written by experts in different types of data analysis. This means we can use R to conduct all sorts of analysis, including cutting-edge techniques. But because R packages are not all written by people working for a single organisation, it means there can sometimes be functions from different packages that have the same name – often because they do similar (but not necessarily identical) things.</p>
<p>This can be a problem because R might be running a function from one package when you think you have written code that uses a function from another package. If the two functions have different arguments or produce different types of result, your code is unlikely to run properly. For example, if two functions have the same name but one produces an SF object while the other produces a tibble, that might cause problems later in your code if you are using other functions that expect to receive a particular type of input.</p>
<p>One example of functions from two different packages with the same name is the <code>geocode()</code> function. We have already learned that the <code>tidygeocoder</code> package contains a function called <code>geocode()</code>, but the <code>ggmap</code> package also has a function called <code>geocode()</code>.</p>
<p>If both the <code>tidygeocoder</code> and <code>ggmap</code> packages are loaded, R will use the <code>geocode()</code> function <em>from the package that has been loaded most recently</em>. So if your script includes the code:</p>
<div class="sourceCode" id="cb51" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a><span class="fu">library</span>(ggmap)</span>
<span id="cb51-2"><a href="#cb51-2"></a><span class="fu">library</span>(tidygeocoder)</span>
<span id="cb51-3"><a href="#cb51-3"></a></span>
<span id="cb51-4"><a href="#cb51-4"></a><span class="co"># [Code to load data, etc.]</span></span>
<span id="cb51-5"><a href="#cb51-5"></a></span>
<span id="cb51-6"><a href="#cb51-6"></a><span class="co"># Geocode some data</span></span>
<span id="cb51-7"><a href="#cb51-7"></a>geocoded_data <span class="ot">&lt;-</span> <span class="fu">geocode</span>(ungeocoded_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then R will use the <code>geocode()</code> function from <code>tidygeocoder</code>, since that was loaded <em>after</em> <code>ggmap</code>. But if you reverse the order in which these packages are loaded:</p>
<div class="sourceCode" id="cb52" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="fu">library</span>(tidygeocoder)</span>
<span id="cb52-2"><a href="#cb52-2"></a><span class="fu">library</span>(ggmap)</span>
<span id="cb52-3"><a href="#cb52-3"></a></span>
<span id="cb52-4"><a href="#cb52-4"></a><span class="co"># [Code to load data, etc.]</span></span>
<span id="cb52-5"><a href="#cb52-5"></a></span>
<span id="cb52-6"><a href="#cb52-6"></a><span class="co"># Geocode some data</span></span>
<span id="cb52-7"><a href="#cb52-7"></a>geocoded_data <span class="ot">&lt;-</span> <span class="fu">geocode</span>(ungeocoded_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then R will use the <code>geocode()</code> function from <code>ggmap</code> because that package was loaded after <code>tidygeocoder</code>.</p>
<p>Knowing which of the two functions R uses when you type <code>geocode()</code> is important because they accept different inputs. The <code>geocode()</code> function from <code>ggmap</code> expects the first argument to contain a vector of addresses, while the <code>geocode()</code> function from <code>tidygeocoder</code> expects a data frame or tibble. If you provide the wrong type of input, either function will produce an error.</p>
<p>When you load a package that includes a function with the same name as a function in a package that is already loaded, R will print a message in the console. For example, if you run <code>library(ggmap)</code> and then <code>library(tidygeocoder)</code>, you will see a message saying the function from the already loaded package has been <em>masked</em> and so will be replaced by the function from the newly loaded package:</p>
<pre data-code-line-numbers=""><code>Attaching package: ‘tidygeocoder’

The following object is masked from ‘package:ggmap’:

    geocode</code></pre>
<p>When you see a message like this, it means you need to check which version of that function you want to use. If you want to use the function from the most-recently loaded package then you don’t need to do anything. If you want to use the function that has been masked, you need to take one of the steps explained below.</p>
<p>Our R scripts very often load the <code>tidyverse</code> package, which loads eight packages (<code>dplyr</code>, <code>forcats</code>, <code>ggplot2</code>, <code>purrr</code>, <code>readr</code>, <code>tibble</code>, <code>tidyr</code> and <code>stringr</code>) that we often need to use. Because <code>tidyverse</code> itself loads several packages, it produces a separate message to let you know which existing functions have been masked when you load <code>tidyverse</code>. If <code>library(tidyverse)</code> is the first code you run after starting R, that message will look something like this:</p>
<pre data-code-line-numbers=""><code>── Conflicts ──────────────────────────────────────── tidyverse_conflicts() ──
x dplyr::filter() masks stats::filter()
x dplyr::lag()    masks stats::lag()</code></pre>
<p>Since we more commonly want the tidyverse functions than the functions they mask (for example, we frequently use the <code>filter()</code> function from <code>dplyr</code> but rarely use the function with the same name in the <code>stats</code> package), it is common to load <code>tidyverse</code> after loading all the other packages needed for our code.</p>
<p>There are several ways you can resolve conflicts between functions from different packages:</p>
<ul>
<li>Make sure you load packages in the order that gives you access to the functions you need. This can be simple if there are few conflicts, but can fall apart if you later change your code to load different packages. This is the option that almost everyone uses most of the time (and most people use all of the time).</li>
<li>Specify which function you want to use using the <code>::</code> notation that we have already used in previous tutorials, e.g.&nbsp;by using the code <code>ggmap::geocode()</code> or <code>tidygeocoder::geocode()</code>.</li>
<li>Load the <code>conflicted</code> package, which produces an error whenever you try to use a function that is included in more than one loaded package. This makes it easy to know when there is a potential conflict, which you can then resolve using the <code>conflict_prefer()</code> function.</li>
</ul>
<p>In this final option, the authors of the <code>conflicted</code> package recommend that you specify which conflict-prone functions to use by calling <code>conflict_prefer()</code> just after you’ve loaded all the packages you need for your script. For example:</p>
<div class="sourceCode" id="cb55" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a><span class="co"># This code produces several conflicts:</span></span>
<span id="cb55-2"><a href="#cb55-2"></a><span class="co"># *  the `stats` package, which is loaded automatically in the background when </span></span>
<span id="cb55-3"><a href="#cb55-3"></a><span class="co">#    you start R, contains a function called `filter()`</span></span>
<span id="cb55-4"><a href="#cb55-4"></a><span class="co"># *  `MASS` contains a function called `select()`</span></span>
<span id="cb55-5"><a href="#cb55-5"></a><span class="co"># *  `dplyr` contains functions called `filter()` and `select()`</span></span>
<span id="cb55-6"><a href="#cb55-6"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb55-7"><a href="#cb55-7"></a><span class="fu">library</span>(MASS)</span>
<span id="cb55-8"><a href="#cb55-8"></a><span class="fu">library</span>(conflicted)</span>
<span id="cb55-9"><a href="#cb55-9"></a></span>
<span id="cb55-10"><a href="#cb55-10"></a><span class="co"># This code specifies that in the case of both conflicts, we want to use the</span></span>
<span id="cb55-11"><a href="#cb55-11"></a><span class="co"># functions from `dplyr`</span></span>
<span id="cb55-12"><a href="#cb55-12"></a><span class="fu">conflict_prefer</span>(<span class="st">"select"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb55-13"><a href="#cb55-13"></a><span class="fu">conflict_prefer</span>(<span class="st">"filter"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb55-14"><a href="#cb55-14"></a></span>
<span id="cb55-15"><a href="#cb55-15"></a><span class="co"># In the rest of this script, any reference to `filter()` or `select()` will</span></span>
<span id="cb55-16"><a href="#cb55-16"></a><span class="co"># use the functions with those names in the `dplyr` package, not those from</span></span>
<span id="cb55-17"><a href="#cb55-17"></a><span class="co"># `stats` or `MASS`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Understanding function-name conflicts is important because they can be the cause of errors that are (for reasons we needn’t explain in detail) extremely hard to track down the cause of. So make sure that when you load packages, you take note of any messages in the console that warn you that functions have been masked. As with other messages in R, they will not always need you to take any action, but you always need to read the message and make a decision about whether to take any action.</p>
<section id="check-your-understanding" class="level4 tutorial" data-number="12.5.0.1">
<h4 class="tutorial anchored" data-number="12.5.0.1" data-anchor-id="check-your-understanding"><span class="header-section-number">12.5.0.1</span> Check your understanding</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb56" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="fu">question</span>(</span>
<span id="cb56-2"><a href="#cb56-2"></a>  <span class="st">"If you load two packages in R that both contain a function with the same name, which function will R use by default?"</span>,</span>
<span id="cb56-3"><a href="#cb56-3"></a>  <span class="fu">answer</span>(<span class="st">"The function from the package that was loaded *last*"</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>),</span>
<span id="cb56-4"><a href="#cb56-4"></a>  <span class="fu">answer</span>(<span class="st">"The function from the package that was loaded *first*"</span>),</span>
<span id="cb56-5"><a href="#cb56-5"></a>  <span class="fu">answer</span>(<span class="st">"Neither function will run because R will produce an error."</span>),</span>
<span id="cb56-6"><a href="#cb56-6"></a>  <span class="fu">answer</span>(<span class="st">"The function that is from the `tidyverse` suite of packages."</span>),</span>
<span id="cb56-7"><a href="#cb56-7"></a>  <span class="at">correct =</span> <span class="fu">random_praise</span>(),</span>
<span id="cb56-8"><a href="#cb56-8"></a>  <span class="at">incorrect =</span> <span class="fu">random_encouragement</span>(),</span>
<span id="cb56-9"><a href="#cb56-9"></a>  <span class="at">allow_retry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb56-10"><a href="#cb56-10"></a>  <span class="at">random_answer_order =</span> <span class="cn">TRUE</span></span>
<span id="cb56-11"><a href="#cb56-11"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="in-summary" class="level2" data-number="12.6">
<h2 data-number="12.6" class="anchored" data-anchor-id="in-summary"><span class="header-section-number">12.6</span> In summary</h2>
<div class="box welldone">
<p>In this tutorial we have learned to tidy messy data to make it easier to work with. In real-world data analysis (not just crime mapping), you will often have to deal with data that is messy in different ways. Fortunately, you can use R to fix all of these problems in a way that minimises the risk that you might introduce mistakes when you clean the data.</p>
</div>
<div class="box reading">
<p>You can find out more about data cleaning and tidying with these resources:</p>
<ul>
<li>A <a href="https://tidyr.tidyverse.org/articles/pivot.html">tutorial on using the <code>pivot_longer()</code> and <code>pivot_wider()</code> functions to convert data between long and wide format</a>.</li>
<li>A more-detailed <a href="https://jessecambon.github.io/tidygeocoder/articles/tidygeocoder.html">Introduction to <code>tidygeocoder</code></a>.</li>
<li>An <a href="https://rfortherestofus.com/2019/12/how-to-clean-messy-data-in-r/">introduction to some other packages than can help you clean and tidy data</a>.</li>
<li>A more-detailed <a href="https://conflicted.r-lib.org/">description of how to use the <code>conflicted</code> package</a>.</li>
</ul>
</div>
<p class="full-width-image">
<img src="images/tidydata_7.jpg" alt="Cartoon saying make friends with tidy data!">
</p>
<p class="credits">
<a href="https://twitter.com/allison_horst">Artwork by <span class="citation" data-cites="allison_horst">@allison_horst</span></a>
</p>


<!-- -->

</section>

</main> <!-- /main -->
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";
  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    btn.onclick = check_func;
    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../11_mapping_hotspots/index.html" class="pagination-link" aria-label="Mapping hotspots">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../13_crime_series/index.html" class="pagination-link" aria-label="Mapping crime series">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Mapping crime series</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb57" data-shortcodes="false" data-code-line-numbers=""><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb57-1"><a href="#cb57-1"></a><span class="fu"># Handling messy data</span></span>
<span id="cb57-2"><a href="#cb57-2"></a></span>
<span id="cb57-3"><a href="#cb57-3"></a></span>
<span id="cb57-4"><a href="#cb57-4"></a>**Learn how to tidy messy data so that it is easier to use for data analysis.**</span>
<span id="cb57-5"><a href="#cb57-5"></a></span>
<span id="cb57-6"><a href="#cb57-6"></a>::: {.callout-important}</span>
<span id="cb57-7"><a href="#cb57-7"></a>This chapter has not yet been updated for 2025, so some material is out of date. Check back for an update in mid-February 2025.</span>
<span id="cb57-8"><a href="#cb57-8"></a>:::</span>
<span id="cb57-9"><a href="#cb57-9"></a></span>
<span id="cb57-10"><a href="#cb57-10"></a><span class="in">```{r setup}</span></span>
<span id="cb57-11"><a href="#cb57-11"></a><span class="in">#| echo: false</span></span>
<span id="cb57-12"><a href="#cb57-12"></a><span class="in">#| include: false</span></span>
<span id="cb57-13"><a href="#cb57-13"></a></span>
<span id="cb57-14"><a href="#cb57-14"></a><span class="in">source(here::here("mask_learnr_functions.R"))</span></span>
<span id="cb57-15"><a href="#cb57-15"></a></span>
<span id="cb57-16"><a href="#cb57-16"></a><span class="in"># Load packages</span></span>
<span id="cb57-17"><a href="#cb57-17"></a><span class="in">library(gt)</span></span>
<span id="cb57-18"><a href="#cb57-18"></a><span class="in">library(janitor)</span></span>
<span id="cb57-19"><a href="#cb57-19"></a><span class="in">library(readxl)</span></span>
<span id="cb57-20"><a href="#cb57-20"></a><span class="in">library(rnaturalearth)</span></span>
<span id="cb57-21"><a href="#cb57-21"></a><span class="in">library(sf)</span></span>
<span id="cb57-22"><a href="#cb57-22"></a><span class="in">library(tidygeocoder)</span></span>
<span id="cb57-23"><a href="#cb57-23"></a><span class="in">library(tidyverse)</span></span>
<span id="cb57-24"><a href="#cb57-24"></a></span>
<span id="cb57-25"><a href="#cb57-25"></a><span class="in"># Load data</span></span>
<span id="cb57-26"><a href="#cb57-26"></a><span class="in">crime_counts &lt;- tribble(</span></span>
<span id="cb57-27"><a href="#cb57-27"></a><span class="in">  ~area, ~assault, ~robbery, ~burglary,</span></span>
<span id="cb57-28"><a href="#cb57-28"></a><span class="in">  "Northville", 4, 2, 10,</span></span>
<span id="cb57-29"><a href="#cb57-29"></a><span class="in">  "Middletown", 6, 5, 20,</span></span>
<span id="cb57-30"><a href="#cb57-30"></a><span class="in">  "Southam", 10, 0, 10</span></span>
<span id="cb57-31"><a href="#cb57-31"></a><span class="in">)</span></span>
<span id="cb57-32"><a href="#cb57-32"></a></span>
<span id="cb57-33"><a href="#cb57-33"></a><span class="in">victims &lt;- tribble(</span></span>
<span id="cb57-34"><a href="#cb57-34"></a><span class="in">  ~first_name, ~last_name, ~age_sex,</span></span>
<span id="cb57-35"><a href="#cb57-35"></a><span class="in">  "Lyda", "Gartrell", "40/F",</span></span>
<span id="cb57-36"><a href="#cb57-36"></a><span class="in">  "Kareem", "David", "26",</span></span>
<span id="cb57-37"><a href="#cb57-37"></a><span class="in">  "Lisa", "Dean", "21/F",</span></span>
<span id="cb57-38"><a href="#cb57-38"></a><span class="in">  "Melina", "Shehan", "25/F",</span></span>
<span id="cb57-39"><a href="#cb57-39"></a><span class="in">  "Alfredo", "Matamoros", "18/M"</span></span>
<span id="cb57-40"><a href="#cb57-40"></a><span class="in">)</span></span>
<span id="cb57-41"><a href="#cb57-41"></a></span>
<span id="cb57-42"><a href="#cb57-42"></a><span class="in">addresses &lt;- tribble(</span></span>
<span id="cb57-43"><a href="#cb57-43"></a><span class="in">  ~"offense_date", ~"location_type", ~"address",</span></span>
<span id="cb57-44"><a href="#cb57-44"></a><span class="in">  "2019-01-01T00:00:00Z", "residence",  "2400 W Carmen Ave",</span></span>
<span id="cb57-45"><a href="#cb57-45"></a><span class="in">  "2019-01-01T00:00:00Z",   "residence",    "2700 S TRIPP AVE",</span></span>
<span id="cb57-46"><a href="#cb57-46"></a><span class="in">  "2019-01-01T11:44:00Z",   "residence",    "3700 S PAULINA ST",</span></span>
<span id="cb57-47"><a href="#cb57-47"></a><span class="in">  "2019-01-01T11:44:00Z",   "residence",    "3700 S Paulina St",</span></span>
<span id="cb57-48"><a href="#cb57-48"></a><span class="in">  "2019-01-01T16:37:00Z",   "government",   "1100 S HAMILTON AVE",</span></span>
<span id="cb57-49"><a href="#cb57-49"></a><span class="in">  "2019-01-02T17:09:00Z",   "gas station",  NA,</span></span>
<span id="cb57-50"><a href="#cb57-50"></a><span class="in">  "2019-01-02T17:09:00Z",   "gas station",  "8200 S HALSTED ST",</span></span>
<span id="cb57-51"><a href="#cb57-51"></a><span class="in">  "2019-01-05T00:01:00Z",   "residence",    "1300 N HUDSON AVE",</span></span>
<span id="cb57-52"><a href="#cb57-52"></a><span class="in">  "2019-01-05T14:00:00Z",   "other", "6200 N Claremont Ave",</span></span>
<span id="cb57-53"><a href="#cb57-53"></a><span class="in">  "2019-01-07T06:50:00Z",   "residence",    "9500 S BELL AVE",</span></span>
<span id="cb57-54"><a href="#cb57-54"></a><span class="in">) |&gt; </span></span>
<span id="cb57-55"><a href="#cb57-55"></a><span class="in">  readr::type_convert()</span></span>
<span id="cb57-56"><a href="#cb57-56"></a></span>
<span id="cb57-57"><a href="#cb57-57"></a><span class="in">addresses_for_geocoding &lt;- addresses |&gt; </span></span>
<span id="cb57-58"><a href="#cb57-58"></a><span class="in">  drop_na(address) |&gt; </span></span>
<span id="cb57-59"><a href="#cb57-59"></a><span class="in">  mutate(address = str_to_upper(str_glue("{address}, CHICAGO, IL"))) |&gt; </span></span>
<span id="cb57-60"><a href="#cb57-60"></a><span class="in">  select(address) |&gt; </span></span>
<span id="cb57-61"><a href="#cb57-61"></a><span class="in">  distinct(address)</span></span>
<span id="cb57-62"><a href="#cb57-62"></a></span>
<span id="cb57-63"><a href="#cb57-63"></a><span class="in">if (file.exists("www/chicago_addresses_geocoded.Rds")) {</span></span>
<span id="cb57-64"><a href="#cb57-64"></a><span class="in">  addresses_geocoded &lt;- read_rds("www/chicago_addresses_geocoded.Rds")</span></span>
<span id="cb57-65"><a href="#cb57-65"></a><span class="in">} else {</span></span>
<span id="cb57-66"><a href="#cb57-66"></a><span class="in">  addresses_geocoded &lt;- geocode(</span></span>
<span id="cb57-67"><a href="#cb57-67"></a><span class="in">    addresses_for_geocoding, </span></span>
<span id="cb57-68"><a href="#cb57-68"></a><span class="in">    address = "address", </span></span>
<span id="cb57-69"><a href="#cb57-69"></a><span class="in">    method = "osm"</span></span>
<span id="cb57-70"><a href="#cb57-70"></a><span class="in">  )</span></span>
<span id="cb57-71"><a href="#cb57-71"></a><span class="in">  write_rds(addresses_geocoded, "www/chicago_addresses_geocoded.Rds")</span></span>
<span id="cb57-72"><a href="#cb57-72"></a><span class="in">}</span></span>
<span id="cb57-73"><a href="#cb57-73"></a></span>
<span id="cb57-74"><a href="#cb57-74"></a><span class="in"># Random addresses in Cairo</span></span>
<span id="cb57-75"><a href="#cb57-75"></a><span class="in">cairo_suspects &lt;- crimemapping:::cairo_suspects |&gt; </span></span>
<span id="cb57-76"><a href="#cb57-76"></a><span class="in">  st_as_sf(coords = c("lon", "lat"), crs = "EPSG:4326")</span></span>
<span id="cb57-77"><a href="#cb57-77"></a></span>
<span id="cb57-78"><a href="#cb57-78"></a><span class="in">monthly_counts &lt;- tribble(</span></span>
<span id="cb57-79"><a href="#cb57-79"></a><span class="in">  ~area, ~jan_2020, ~feb_2020, ~mar_2020, ~apr_2020, ~may_2020,</span></span>
<span id="cb57-80"><a href="#cb57-80"></a><span class="in">  "Northville", 13, 10, 12, 9, 10,</span></span>
<span id="cb57-81"><a href="#cb57-81"></a><span class="in">  "Middletown", 21, 19, 22, 19, 20,</span></span>
<span id="cb57-82"><a href="#cb57-82"></a><span class="in">  "Southam", 15, 13, 16, 15, 14</span></span>
<span id="cb57-83"><a href="#cb57-83"></a><span class="in">)</span></span>
<span id="cb57-84"><a href="#cb57-84"></a></span>
<span id="cb57-85"><a href="#cb57-85"></a><span class="in">burglary_values &lt;-  tibble(</span></span>
<span id="cb57-86"><a href="#cb57-86"></a><span class="in">  date = lubridate::as_datetime(runif(</span></span>
<span id="cb57-87"><a href="#cb57-87"></a><span class="in">    n = 5, </span></span>
<span id="cb57-88"><a href="#cb57-88"></a><span class="in">    min = as.numeric(lubridate::ymd_hm("2020-01-01 00:00")), </span></span>
<span id="cb57-89"><a href="#cb57-89"></a><span class="in">    max = as.numeric(lubridate::ymd_hm("2020-01-31 23:59"))</span></span>
<span id="cb57-90"><a href="#cb57-90"></a><span class="in">  )),</span></span>
<span id="cb57-91"><a href="#cb57-91"></a><span class="in">  value = c(1320, 653, 2068, -1, 580)</span></span>
<span id="cb57-92"><a href="#cb57-92"></a><span class="in">)</span></span>
<span id="cb57-93"><a href="#cb57-93"></a></span>
<span id="cb57-94"><a href="#cb57-94"></a><span class="in">uk_data &lt;- tribble(</span></span>
<span id="cb57-95"><a href="#cb57-95"></a><span class="in">  ~month, ~longitude, ~latitude, ~location, ~lsoa_name,</span></span>
<span id="cb57-96"><a href="#cb57-96"></a><span class="in">  "2020-01", -1.12, 53.3, "On or near Supermarket", "Bassetlaw 013C",</span></span>
<span id="cb57-97"><a href="#cb57-97"></a><span class="in">  "2020-02", -0.993, 53.2, "On or near Turner Lane", "Newark and Sherwood 001A",</span></span>
<span id="cb57-98"><a href="#cb57-98"></a><span class="in">  "2020-05", -1.25, 53.1, "On or near Brookdale Road", "Ashfield 004C",</span></span>
<span id="cb57-99"><a href="#cb57-99"></a><span class="in">  "2020-08", -1.16, 53.0, "On or near Raithby Close", "Nottingham 006B",</span></span>
<span id="cb57-100"><a href="#cb57-100"></a><span class="in">  "2020-10", -1.18, 53.0, "On or near Bowden Avenue", "Ashfield 013A"</span></span>
<span id="cb57-101"><a href="#cb57-101"></a><span class="in">)</span></span>
<span id="cb57-102"><a href="#cb57-102"></a><span class="in">```</span></span>
<span id="cb57-103"><a href="#cb57-103"></a></span>
<span id="cb57-104"><a href="#cb57-104"></a></span>
<span id="cb57-105"><a href="#cb57-105"></a></span>
<span id="cb57-106"><a href="#cb57-106"></a><span class="fu">## Introduction</span></span>
<span id="cb57-107"><a href="#cb57-107"></a></span>
<span id="cb57-108"><a href="#cb57-108"></a>Data is the foundation of everything we do in crime mapping. To make a crime map </span>
<span id="cb57-109"><a href="#cb57-109"></a>needs data on the locations and types of crimes; data on roads, buildings and</span>
<span id="cb57-110"><a href="#cb57-110"></a>natural features to make up a base map, and data on other features (such as</span>
<span id="cb57-111"><a href="#cb57-111"></a>particular types of facility) that might be relevant to why crime happens in</span>
<span id="cb57-112"><a href="#cb57-112"></a>particular place.</span>
<span id="cb57-113"><a href="#cb57-113"></a></span>
<span id="cb57-114"><a href="#cb57-114"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/tidydata_1.jpg" alt="Cartoon explaining that tidy data is a standard way of mapping the meaning of a dataset to its structure. In tidy data each variable forms a column, each observation forms a row and each cell is a single measurement."&gt;&lt;/p&gt;</span>
<span id="cb57-115"><a href="#cb57-115"></a></span>
<span id="cb57-116"><a href="#cb57-116"></a>Until now, all the data we have used has been *tidy data*. Data is tidy if it</span>
<span id="cb57-117"><a href="#cb57-117"></a>comes in a particular format where every *variable* (e.g. the date on which a </span>
<span id="cb57-118"><a href="#cb57-118"></a>crime occurred) is stored in a separate *column* and data for every </span>
<span id="cb57-119"><a href="#cb57-119"></a>*observation* (e.g. all the data about a particular crime, a particular offender</span>
<span id="cb57-120"><a href="#cb57-120"></a>etc.) is stored in a separate *row*. For typical crime data, that means each</span>
<span id="cb57-121"><a href="#cb57-121"></a>crime is represented by one row in the data and each thing that we know about</span>
<span id="cb57-122"><a href="#cb57-122"></a>that crime is stored in a separate column.</span>
<span id="cb57-123"><a href="#cb57-123"></a></span>
<span id="cb57-124"><a href="#cb57-124"></a>Unfortunately, not all the data we might like to use in crime mapping is </span>
<span id="cb57-125"><a href="#cb57-125"></a>available in a tidy format. The people, organisations and systems and produce</span>
<span id="cb57-126"><a href="#cb57-126"></a>data store it in many formats, which are often not tidy and not easy to analyse.</span>
<span id="cb57-127"><a href="#cb57-127"></a>Messy data is more difficult to work with because every messy dataset has a</span>
<span id="cb57-128"><a href="#cb57-128"></a>unique structure, which we have to remember every time we want to work with it.</span>
<span id="cb57-129"><a href="#cb57-129"></a></span>
<span id="cb57-130"><a href="#cb57-130"></a>Tidy data, on the other hand, is easier to work with because its format is</span>
<span id="cb57-131"><a href="#cb57-131"></a>familiar and consistent. Many R functions are also designed to work with tidy</span>
<span id="cb57-132"><a href="#cb57-132"></a>data, so tidying our datasets often makes analysis quicker, too.</span>
<span id="cb57-133"><a href="#cb57-133"></a></span>
<span id="cb57-134"><a href="#cb57-134"></a>The first step to analysing messy data is therefore to wrangle it into a tidy </span>
<span id="cb57-135"><a href="#cb57-135"></a>format. We have already seen this principle at work when we use the </span>
<span id="cb57-136"><a href="#cb57-136"></a><span class="in">`clean_names()`</span> function from the <span class="in">`janitor`</span> package to convert column names into </span>
<span id="cb57-137"><a href="#cb57-137"></a>a consistent format so that we don't have to keep remembering which unique </span>
<span id="cb57-138"><a href="#cb57-138"></a>format the column names are in.</span>
<span id="cb57-139"><a href="#cb57-139"></a></span>
<span id="cb57-140"><a href="#cb57-140"></a>In this tutorial we will learn how to tidy messy data to make it easier to work</span>
<span id="cb57-141"><a href="#cb57-141"></a>with.</span>
<span id="cb57-142"><a href="#cb57-142"></a></span>
<span id="cb57-143"><a href="#cb57-143"></a>&lt;p class="credits"&gt;<span class="co">[</span><span class="ot">Stats Illustrations by Allison Horst</span><span class="co">](https://github.com/allisonhorst/stats-illustrations)</span> licensed under the <span class="co">[</span><span class="ot">Creative Commons Attribution licence</span><span class="co">](https://github.com/allisonhorst/stats-illustrations/blob/master/license)</span>.&lt;/p&gt;</span>
<span id="cb57-144"><a href="#cb57-144"></a></span>
<span id="cb57-145"><a href="#cb57-145"></a></span>
<span id="cb57-146"><a href="#cb57-146"></a></span>
<span id="cb57-147"><a href="#cb57-147"></a><span class="fu">## Tidying the structure of data</span></span>
<span id="cb57-148"><a href="#cb57-148"></a></span>
<span id="cb57-149"><a href="#cb57-149"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/tidydata_2.jpg" alt="Cartoon explaining that the standard structure of tidy data means that all tidy datasets are alike but every messy dataset is messy in its own way."&gt;&lt;/p&gt;</span>
<span id="cb57-150"><a href="#cb57-150"></a></span>
<span id="cb57-151"><a href="#cb57-151"></a>Every messy dataset is messy in its own unique way, but often messiness comes </span>
<span id="cb57-152"><a href="#cb57-152"></a>from the structure of data not being tidy.</span>
<span id="cb57-153"><a href="#cb57-153"></a>Tabular data can come in two general formats: *long* and *wide*. For example,</span>
<span id="cb57-154"><a href="#cb57-154"></a>imagine a dataset showing counts of several different types of crime in several</span>
<span id="cb57-155"><a href="#cb57-155"></a>different areas. We could store this data in wide format, where there is a </span>
<span id="cb57-156"><a href="#cb57-156"></a>column for the name of the area and then a column for each type of crime.</span>
<span id="cb57-157"><a href="#cb57-157"></a></span>
<span id="cb57-158"><a href="#cb57-158"></a><span class="in">```{r wide-table, echo=FALSE}</span></span>
<span id="cb57-159"><a href="#cb57-159"></a><span class="in">crime_counts |&gt;  </span></span>
<span id="cb57-160"><a href="#cb57-160"></a><span class="in">  knitr::kable() |&gt; </span></span>
<span id="cb57-161"><a href="#cb57-161"></a><span class="in">  kableExtra::kable_styling(full_width = FALSE)</span></span>
<span id="cb57-162"><a href="#cb57-162"></a><span class="in">```</span></span>
<span id="cb57-163"><a href="#cb57-163"></a></span>
<span id="cb57-164"><a href="#cb57-164"></a>Wide-format data are often useful for presentation -- you might often see a</span>
<span id="cb57-165"><a href="#cb57-165"></a>table like this in a report or article. But wide data are less useful for </span>
<span id="cb57-166"><a href="#cb57-166"></a>analysis because one of the variables -- 'type of crime' -- is being stored not</span>
<span id="cb57-167"><a href="#cb57-167"></a>as a variable but in the various column names. One sign that your data has this</span>
<span id="cb57-168"><a href="#cb57-168"></a>problem is if several of the columns form a group of columns, separate from the </span>
<span id="cb57-169"><a href="#cb57-169"></a>others. In this case, there is a group of columns that show crime counts that is </span>
<span id="cb57-170"><a href="#cb57-170"></a>different from the other column that shows the area name.</span>
<span id="cb57-171"><a href="#cb57-171"></a></span>
<span id="cb57-172"><a href="#cb57-172"></a>Fortunately, we can easily convert this data (which is stored in the object</span>
<span id="cb57-173"><a href="#cb57-173"></a><span class="in">`crime_counts`</span>) into long format using the <span class="in">`pivot_longer()`</span> function from the</span>
<span id="cb57-174"><a href="#cb57-174"></a><span class="in">`tidyr`</span> package. To use <span class="in">`pivot_longer()`</span>, we have to specify in the <span class="in">`cols`</span></span>
<span id="cb57-175"><a href="#cb57-175"></a>argument which columns we want to 'gather' together into one column to store the </span>
<span id="cb57-176"><a href="#cb57-176"></a>category names and one column to store the values. We can specify the columns</span>
<span id="cb57-177"><a href="#cb57-177"></a>we want to gather as a vector, i.e. <span class="in">`c(assault, burglary, robbery)`</span>.</span>
<span id="cb57-178"><a href="#cb57-178"></a></span>
<span id="cb57-179"><a href="#cb57-179"></a><span class="in">```{r structure-exercise1, exercise=TRUE}</span></span>
<span id="cb57-180"><a href="#cb57-180"></a><span class="in">library(tidyverse)</span></span>
<span id="cb57-181"><a href="#cb57-181"></a></span>
<span id="cb57-182"><a href="#cb57-182"></a><span class="in">pivot_longer(crime_counts, cols = c(assault, burglary, robbery))</span></span>
<span id="cb57-183"><a href="#cb57-183"></a><span class="in">```</span></span>
<span id="cb57-184"><a href="#cb57-184"></a></span>
<span id="cb57-185"><a href="#cb57-185"></a>By default, <span class="in">`pivot_longer()`</span> calls the new column of category names <span class="in">`name`</span> and</span>
<span id="cb57-186"><a href="#cb57-186"></a>the new column of values <span class="in">`value`</span>. We can specify more-descriptive names using </span>
<span id="cb57-187"><a href="#cb57-187"></a>the <span class="in">`names_to`</span> and <span class="in">`values_to`</span> arguments.</span>
<span id="cb57-188"><a href="#cb57-188"></a></span>
<span id="cb57-189"><a href="#cb57-189"></a><span class="in">```{r structure-exercise2, exercise=TRUE}</span></span>
<span id="cb57-190"><a href="#cb57-190"></a><span class="in">pivot_longer(</span></span>
<span id="cb57-191"><a href="#cb57-191"></a><span class="in">  crime_counts, </span></span>
<span id="cb57-192"><a href="#cb57-192"></a><span class="in">  cols = c(assault, burglary, robbery), </span></span>
<span id="cb57-193"><a href="#cb57-193"></a><span class="in">  names_to = "type", </span></span>
<span id="cb57-194"><a href="#cb57-194"></a><span class="in">  values_to = "count"</span></span>
<span id="cb57-195"><a href="#cb57-195"></a><span class="in">)</span></span>
<span id="cb57-196"><a href="#cb57-196"></a><span class="in">```</span></span>
<span id="cb57-197"><a href="#cb57-197"></a></span>
<span id="cb57-198"><a href="#cb57-198"></a>It is better to have the names of different categories stored as a single </span>
<span id="cb57-199"><a href="#cb57-199"></a>variable rather than as the names of several variables because they are easier</span>
<span id="cb57-200"><a href="#cb57-200"></a>to work with that way. For example, if the data are in long format you could </span>
<span id="cb57-201"><a href="#cb57-201"></a>sort the categories alphabetically using <span class="in">`arrange(crime_counts, type)`</span>, or you </span>
<span id="cb57-202"><a href="#cb57-202"></a>could transform the names to title case using </span>
<span id="cb57-203"><a href="#cb57-203"></a><span class="in">`mutate(crime_counts, type = str_to_title(type))`</span>. Both these operations would </span>
<span id="cb57-204"><a href="#cb57-204"></a>be harder to do if the data were in wide format.</span>
<span id="cb57-205"><a href="#cb57-205"></a></span>
<span id="cb57-206"><a href="#cb57-206"></a>A common reason for data to be stored in wide format is where repeated </span>
<span id="cb57-207"><a href="#cb57-207"></a>observations are made of some value over time. For example, we might have </span>
<span id="cb57-208"><a href="#cb57-208"></a>monthly counts of crimes for different areas.</span>
<span id="cb57-209"><a href="#cb57-209"></a></span>
<span id="cb57-210"><a href="#cb57-210"></a><span class="in">```{r monthly-table, echo=FALSE}</span></span>
<span id="cb57-211"><a href="#cb57-211"></a><span class="in">monthly_counts |&gt;  </span></span>
<span id="cb57-212"><a href="#cb57-212"></a><span class="in">  knitr::kable() |&gt; </span></span>
<span id="cb57-213"><a href="#cb57-213"></a><span class="in">  kableExtra::kable_styling(full_width = FALSE)</span></span>
<span id="cb57-214"><a href="#cb57-214"></a><span class="in">```</span></span>
<span id="cb57-215"><a href="#cb57-215"></a></span>
<span id="cb57-216"><a href="#cb57-216"></a>Storing data in this way is particularly awkward because variable names can only</span>
<span id="cb57-217"><a href="#cb57-217"></a>contain text, so R does not know that the column names represent dates. This</span>
<span id="cb57-218"><a href="#cb57-218"></a>means, for example, that we could not filter the dataset to only include data</span>
<span id="cb57-219"><a href="#cb57-219"></a>from after a certain date.</span>
<span id="cb57-220"><a href="#cb57-220"></a></span>
<span id="cb57-221"><a href="#cb57-221"></a>When we want to gather a large number of columns together, it can get tedious to </span>
<span id="cb57-222"><a href="#cb57-222"></a>type all the column names for the <span class="in">`cols`</span> argument to <span class="in">`pivot_longer()`</span>. Instead, </span>
<span id="cb57-223"><a href="#cb57-223"></a>since we want to gather all the columns except one, we can just specify that we </span>
<span id="cb57-224"><a href="#cb57-224"></a>should *not* gather the <span class="in">`area`</span> column, which implicitly tells <span class="in">`pivot_longer()`</span> </span>
<span id="cb57-225"><a href="#cb57-225"></a>to gather all the other columns. We tell <span class="in">`pivot_longer()`</span> not to gather the area</span>
<span id="cb57-226"><a href="#cb57-226"></a>column by specifying <span class="in">`cols = -area`</span> (note the minus sign in front of the column</span>
<span id="cb57-227"><a href="#cb57-227"></a>name). </span>
<span id="cb57-228"><a href="#cb57-228"></a></span>
<span id="cb57-229"><a href="#cb57-229"></a></span>
<span id="cb57-230"><a href="#cb57-230"></a>::: {.tutorial}</span>
<span id="cb57-231"><a href="#cb57-231"></a></span>
<span id="cb57-232"><a href="#cb57-232"></a>Run the code needed to gather a dataset called <span class="in">`monthly_counts`</span> so that</span>
<span id="cb57-233"><a href="#cb57-233"></a>the names of the monthly counts are stored in a variable called <span class="in">`month`</span> and the</span>
<span id="cb57-234"><a href="#cb57-234"></a>monthly counts themselves are stored in a variable called <span class="in">`count`</span>.</span>
<span id="cb57-235"><a href="#cb57-235"></a></span>
<span id="cb57-236"><a href="#cb57-236"></a><span class="in">```{r structure-exercise3, exercise=TRUE, exercise.lines=7}</span></span>
<span id="cb57-237"><a href="#cb57-237"></a></span>
<span id="cb57-238"><a href="#cb57-238"></a><span class="in">```</span></span>
<span id="cb57-239"><a href="#cb57-239"></a></span>
<span id="cb57-240"><a href="#cb57-240"></a>:::</span>
<span id="cb57-241"><a href="#cb57-241"></a></span>
<span id="cb57-242"><a href="#cb57-242"></a></span>
<span id="cb57-243"><a href="#cb57-243"></a><span class="in">```{r structure-exercise3-solution}</span></span>
<span id="cb57-244"><a href="#cb57-244"></a><span class="in">pivot_longer(</span></span>
<span id="cb57-245"><a href="#cb57-245"></a><span class="in">  monthly_counts, </span></span>
<span id="cb57-246"><a href="#cb57-246"></a><span class="in">  cols = -area, </span></span>
<span id="cb57-247"><a href="#cb57-247"></a><span class="in">  names_to = "month", </span></span>
<span id="cb57-248"><a href="#cb57-248"></a><span class="in">  values_to = "count"</span></span>
<span id="cb57-249"><a href="#cb57-249"></a><span class="in">)</span></span>
<span id="cb57-250"><a href="#cb57-250"></a><span class="in">```</span></span>
<span id="cb57-251"><a href="#cb57-251"></a></span>
<span id="cb57-252"><a href="#cb57-252"></a>There is still a problem with this data, which is that the <span class="in">`month`</span> variable</span>
<span id="cb57-253"><a href="#cb57-253"></a>contains not date values but instead the month and year stored as text. We will</span>
<span id="cb57-254"><a href="#cb57-254"></a>learn how to deal with this issue in a future tutorial.</span>
<span id="cb57-255"><a href="#cb57-255"></a></span>
<span id="cb57-256"><a href="#cb57-256"></a></span>
<span id="cb57-257"><a href="#cb57-257"></a><span class="fu">### Skipping unwanted rows in imported data</span></span>
<span id="cb57-258"><a href="#cb57-258"></a></span>
<span id="cb57-259"><a href="#cb57-259"></a>Data released by government organisations are often designed to be viewed by</span>
<span id="cb57-260"><a href="#cb57-260"></a>humans rather than processed by statistical software. We can see this in this</span>
<span id="cb57-261"><a href="#cb57-261"></a>screen shot of a [dataset produced by the UK Office for National Statistics on</span>
<span id="cb57-262"><a href="#cb57-262"></a>cybercrime in the UK](https://www.ons.gov.uk/peoplepopulationandcommunity/crimeandjustice/datasets/crimeinenglandandwalesexperimentaltables) based on responses to the Crime Survey for England and</span>
<span id="cb57-263"><a href="#cb57-263"></a>Wales.</span>
<span id="cb57-264"><a href="#cb57-264"></a></span>
<span id="cb57-265"><a href="#cb57-265"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/ons_data1.png" alt="Screen shot of an Excel sheet of data from the UK Office for National Statistics, showing that there are multiple header rows above the data and blank rows within the data."&gt;&lt;/p&gt;</span>
<span id="cb57-266"><a href="#cb57-266"></a></span>
<span id="cb57-267"><a href="#cb57-267"></a>Looking at the row numbers on the left-hand side, we can see that the that the</span>
<span id="cb57-268"><a href="#cb57-268"></a>first row is taken up not with the column names (as in a tidy dataset) but with</span>
<span id="cb57-269"><a href="#cb57-269"></a>the title of the dataset. The next row is blank, and the third row then contains</span>
<span id="cb57-270"><a href="#cb57-270"></a>some metadata to say that the data relates to England and Wales and to adults</span>
<span id="cb57-271"><a href="#cb57-271"></a>aged 16 and over. Only on row four do we see the column names. There are also</span>
<span id="cb57-272"><a href="#cb57-272"></a>blank rows within the data that are used to separate out different categories of</span>
<span id="cb57-273"><a href="#cb57-273"></a>data.</span>
<span id="cb57-274"><a href="#cb57-274"></a></span>
<span id="cb57-275"><a href="#cb57-275"></a>If we try to import this data using, for example, the <span class="in">`read_excel()`</span> function</span>
<span id="cb57-276"><a href="#cb57-276"></a>from the <span class="in">`readxl`</span> package, we will find various problems.</span>
<span id="cb57-277"><a href="#cb57-277"></a></span>
<span id="cb57-278"><a href="#cb57-278"></a><span class="in">```r</span></span>
<span id="cb57-279"><a href="#cb57-279"></a><span class="fu">library</span>(readxl)</span>
<span id="cb57-280"><a href="#cb57-280"></a></span>
<span id="cb57-281"><a href="#cb57-281"></a><span class="co"># Since `.xlsx` files are binary files, we need to add `mode = "wb"` on Windows.</span></span>
<span id="cb57-282"><a href="#cb57-282"></a><span class="co"># On other platforms it makes no difference, but adding `mode = "wb" does not</span></span>
<span id="cb57-283"><a href="#cb57-283"></a><span class="co"># cause any problems.</span></span>
<span id="cb57-284"><a href="#cb57-284"></a><span class="fu">download.file</span>(</span>
<span id="cb57-285"><a href="#cb57-285"></a>  <span class="at">url =</span> <span class="st">"https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/crimeandjustice/datasets/crimeinenglandandwalesexperimentaltables/yearendingdecember2018/additionalfraudandcybercrimetablesyearendingdecember2018correction.xlsx"</span>,</span>
<span id="cb57-286"><a href="#cb57-286"></a>  <span class="at">destfile =</span> <span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>),</span>
<span id="cb57-287"><a href="#cb57-287"></a>  <span class="at">mode =</span> <span class="st">"wb"</span></span>
<span id="cb57-288"><a href="#cb57-288"></a>)</span>
<span id="cb57-289"><a href="#cb57-289"></a></span>
<span id="cb57-290"><a href="#cb57-290"></a><span class="fu">read_excel</span>(<span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>), <span class="at">sheet =</span> <span class="st">"Table E1"</span>)</span>
<span id="cb57-291"><a href="#cb57-291"></a><span class="in">```</span></span>
<span id="cb57-292"><a href="#cb57-292"></a></span>
<span id="cb57-293"><a href="#cb57-293"></a><span class="in">```{r, structure-output4, echo=FALSE}</span></span>
<span id="cb57-294"><a href="#cb57-294"></a><span class="in">read_excel("www/cybercrime.xlsx", sheet = "Table E1")</span></span>
<span id="cb57-295"><a href="#cb57-295"></a><span class="in">```</span></span>
<span id="cb57-296"><a href="#cb57-296"></a></span>
<span id="cb57-297"><a href="#cb57-297"></a>It's clear that this dataset has not loaded in the way that we want, because</span>
<span id="cb57-298"><a href="#cb57-298"></a>the first row doesn't contain the column names. Fortunately, we can deal with this</span>
<span id="cb57-299"><a href="#cb57-299"></a>problem using the <span class="in">`skip`</span> argument to the <span class="in">`read_excel()`</span> function. This allows us</span>
<span id="cb57-300"><a href="#cb57-300"></a>to specify a number of rows to ignore at the start of the dataset. In this case,</span>
<span id="cb57-301"><a href="#cb57-301"></a>we want to ignore the first three rows of the data (the table title, a blank</span>
<span id="cb57-302"><a href="#cb57-302"></a>line and the the metadata line), so we can specify <span class="in">`skip = 3`</span>. The same <span class="in">`skip`</span></span>
<span id="cb57-303"><a href="#cb57-303"></a>argument also exists in the <span class="in">`read_csv()`</span> function for reading CSV data and the</span>
<span id="cb57-304"><a href="#cb57-304"></a><span class="in">`read_tsv()`</span> function for reading tab-separated data.</span>
<span id="cb57-305"><a href="#cb57-305"></a></span>
<span id="cb57-306"><a href="#cb57-306"></a><span class="in">```r</span></span>
<span id="cb57-307"><a href="#cb57-307"></a><span class="fu">read_excel</span>(</span>
<span id="cb57-308"><a href="#cb57-308"></a>  <span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>), </span>
<span id="cb57-309"><a href="#cb57-309"></a>  <span class="at">sheet =</span> <span class="st">"Table E1"</span>, </span>
<span id="cb57-310"><a href="#cb57-310"></a>  <span class="at">skip =</span> <span class="dv">3</span></span>
<span id="cb57-311"><a href="#cb57-311"></a>)</span>
<span id="cb57-312"><a href="#cb57-312"></a><span class="in">```</span></span>
<span id="cb57-313"><a href="#cb57-313"></a></span>
<span id="cb57-314"><a href="#cb57-314"></a><span class="in">```{r, structure-output5, echo=FALSE}</span></span>
<span id="cb57-315"><a href="#cb57-315"></a><span class="in">read_excel("www/cybercrime.xlsx", sheet = "Table E1", skip = 3)</span></span>
<span id="cb57-316"><a href="#cb57-316"></a><span class="in">```</span></span>
<span id="cb57-317"><a href="#cb57-317"></a></span>
<span id="cb57-318"><a href="#cb57-318"></a>This has dealt with the problem caused by the extra rows at the top of the data.</span>
<span id="cb57-319"><a href="#cb57-319"></a>But if we look at the bottom of the dataset, we will see that there are also</span>
<span id="cb57-320"><a href="#cb57-320"></a>several rows of footnotes. These footnotes are important for us to have read so</span>
<span id="cb57-321"><a href="#cb57-321"></a>that we understand the data, but they aren't part of the data itself. </span>
<span id="cb57-322"><a href="#cb57-322"></a></span>
<span id="cb57-323"><a href="#cb57-323"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/ons_data2.png" alt="Screen shot of an Excel sheet of data from the UK Office for National Statistics, showing that there are multiple footer rows below the data."&gt;&lt;/p&gt;</span>
<span id="cb57-324"><a href="#cb57-324"></a></span>
<span id="cb57-325"><a href="#cb57-325"></a>We can remove these extra rows at the end of our data using the <span class="in">`slice()`</span></span>
<span id="cb57-326"><a href="#cb57-326"></a>function from the <span class="in">`dplyr`</span> package. <span class="in">`slice()`</span> allows us to choose certain rows</span>
<span id="cb57-327"><a href="#cb57-327"></a>from our data by row number. Looking at the screen shot above, our data finishes</span>
<span id="cb57-328"><a href="#cb57-328"></a>on row 34 (row 36 looks like part of our data but the value there actually shows</span>
<span id="cb57-329"><a href="#cb57-329"></a>the number of people involved in the survey, not a number of incidents). But:</span>
<span id="cb57-330"><a href="#cb57-330"></a></span>
<span id="cb57-331"><a href="#cb57-331"></a><span class="ss">  * </span>we have already removed the first three rows using the <span class="in">`skip`</span> argument to </span>
<span id="cb57-332"><a href="#cb57-332"></a>    <span class="in">`read_excel()`</span>, and</span>
<span id="cb57-333"><a href="#cb57-333"></a><span class="ss">  * </span>row four of the original spreadsheet has become our column names,</span>
<span id="cb57-334"><a href="#cb57-334"></a>  </span>
<span id="cb57-335"><a href="#cb57-335"></a>so row 34 on the spreadsheet is actually row 30 in our loaded dataset. Knowing </span>
<span id="cb57-336"><a href="#cb57-336"></a>this, we can remove all the rows below row 30 using <span class="in">`slice()`</span>:</span>
<span id="cb57-337"><a href="#cb57-337"></a></span>
<span id="cb57-338"><a href="#cb57-338"></a><span class="in">```r</span></span>
<span id="cb57-339"><a href="#cb57-339"></a><span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-340"><a href="#cb57-340"></a>  <span class="fu">read_excel</span>(<span class="at">sheet =</span> <span class="st">"Table E1"</span>, <span class="at">skip =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-341"><a href="#cb57-341"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span>
<span id="cb57-342"><a href="#cb57-342"></a><span class="in">```</span></span>
<span id="cb57-343"><a href="#cb57-343"></a></span>
<span id="cb57-344"><a href="#cb57-344"></a><span class="in">```{r, structure-output6, echo=FALSE}</span></span>
<span id="cb57-345"><a href="#cb57-345"></a><span class="in">read_excel("www/cybercrime.xlsx", sheet = "Table E1", skip = 3) |&gt; </span></span>
<span id="cb57-346"><a href="#cb57-346"></a><span class="in">  slice(1:30)</span></span>
<span id="cb57-347"><a href="#cb57-347"></a><span class="in">```</span></span>
<span id="cb57-348"><a href="#cb57-348"></a></span>
<span id="cb57-349"><a href="#cb57-349"></a>The final problem with the structure of this dataset is the blank rows that are</span>
<span id="cb57-350"><a href="#cb57-350"></a>used to separate different crime categories in the original table. We can deal</span>
<span id="cb57-351"><a href="#cb57-351"></a>with this using the <span class="in">`remove_empty()`</span> function from the <span class="in">`janitor`</span> package, which</span>
<span id="cb57-352"><a href="#cb57-352"></a>removes all rows and/or columns that contain only <span class="in">`NA`</span> values. We will also </span>
<span id="cb57-353"><a href="#cb57-353"></a>clean the column names at the same time and then rename the columns to be </span>
<span id="cb57-354"><a href="#cb57-354"></a>shorter, which will make it easier to refer to them in our code.</span>
<span id="cb57-355"><a href="#cb57-355"></a></span>
<span id="cb57-356"><a href="#cb57-356"></a><span class="in">```r</span></span>
<span id="cb57-357"><a href="#cb57-357"></a><span class="fu">library</span>(janitor)</span>
<span id="cb57-358"><a href="#cb57-358"></a></span>
<span id="cb57-359"><a href="#cb57-359"></a><span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-360"><a href="#cb57-360"></a>  <span class="fu">read_excel</span>(<span class="at">sheet =</span> <span class="st">"Table E1"</span>, <span class="at">skip =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-361"><a href="#cb57-361"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-362"><a href="#cb57-362"></a>  <span class="fu">remove_empty</span>(<span class="at">which =</span> <span class="st">"rows"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-363"><a href="#cb57-363"></a>  <span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb57-364"><a href="#cb57-364"></a>  <span class="fu">rename</span>(</span>
<span id="cb57-365"><a href="#cb57-365"></a>    <span class="at">offence =</span> offence_group3, </span>
<span id="cb57-366"><a href="#cb57-366"></a>    <span class="at">crimes =</span> number_of_incidents_thousands, </span>
<span id="cb57-367"><a href="#cb57-367"></a>    <span class="at">incidence =</span> rate_per_1_000_adults, </span>
<span id="cb57-368"><a href="#cb57-368"></a>    <span class="at">victims =</span> number_of_victims_thousands_4, </span>
<span id="cb57-369"><a href="#cb57-369"></a>    <span class="at">prevalence =</span> percentage_victims_once_or_more4</span>
<span id="cb57-370"><a href="#cb57-370"></a>  )</span>
<span id="cb57-371"><a href="#cb57-371"></a><span class="in">```</span></span>
<span id="cb57-372"><a href="#cb57-372"></a></span>
<span id="cb57-373"><a href="#cb57-373"></a><span class="in">```{r, structure-output7, echo=FALSE}</span></span>
<span id="cb57-374"><a href="#cb57-374"></a><span class="in">read_excel("www/cybercrime.xlsx", sheet = "Table E1", skip = 3) |&gt; </span></span>
<span id="cb57-375"><a href="#cb57-375"></a><span class="in">  slice(1:30) |&gt; </span></span>
<span id="cb57-376"><a href="#cb57-376"></a><span class="in">  remove_empty(which = "rows") |&gt; </span></span>
<span id="cb57-377"><a href="#cb57-377"></a><span class="in">  clean_names() |&gt; </span></span>
<span id="cb57-378"><a href="#cb57-378"></a><span class="in">  rename(</span></span>
<span id="cb57-379"><a href="#cb57-379"></a><span class="in">    offence = offence_group3, </span></span>
<span id="cb57-380"><a href="#cb57-380"></a><span class="in">    crimes = number_of_incidents_thousands, </span></span>
<span id="cb57-381"><a href="#cb57-381"></a><span class="in">    incidence = rate_per_1_000_adults, </span></span>
<span id="cb57-382"><a href="#cb57-382"></a><span class="in">    victims = number_of_victims_thousands_4, </span></span>
<span id="cb57-383"><a href="#cb57-383"></a><span class="in">    prevalence = percentage_victims_once_or_more4</span></span>
<span id="cb57-384"><a href="#cb57-384"></a><span class="in">  )</span></span>
<span id="cb57-385"><a href="#cb57-385"></a><span class="in">```</span></span>
<span id="cb57-386"><a href="#cb57-386"></a></span>
<span id="cb57-387"><a href="#cb57-387"></a>This dataset now has a tidy structure: each row represents an observation (in</span>
<span id="cb57-388"><a href="#cb57-388"></a>this case, data about a particular type of crime), each column represents a </span>
<span id="cb57-389"><a href="#cb57-389"></a>piece of information about the observation and each cell represents a single</span>
<span id="cb57-390"><a href="#cb57-390"></a>value. We still need to clean up the footnote numbers that appear in some of the</span>
<span id="cb57-391"><a href="#cb57-391"></a>values, but we will deal with that later in this tutorial.</span>
<span id="cb57-392"><a href="#cb57-392"></a></span>
<span id="cb57-393"><a href="#cb57-393"></a></span>
<span id="cb57-394"><a href="#cb57-394"></a><span class="fu">### Separating multiple variables stored in a single column</span></span>
<span id="cb57-395"><a href="#cb57-395"></a></span>
<span id="cb57-396"><a href="#cb57-396"></a>Sometimes datasets include multiple variables in a single column. For example,</span>
<span id="cb57-397"><a href="#cb57-397"></a>data about crime victims stored in an object called <span class="in">`victims`</span> might include a </span>
<span id="cb57-398"><a href="#cb57-398"></a>single column representing both age and sex.</span>
<span id="cb57-399"><a href="#cb57-399"></a></span>
<span id="cb57-400"><a href="#cb57-400"></a><span class="in">```{r victims-table, echo=FALSE}</span></span>
<span id="cb57-401"><a href="#cb57-401"></a><span class="in">victims |&gt; </span></span>
<span id="cb57-402"><a href="#cb57-402"></a><span class="in">  knitr::kable() |&gt; </span></span>
<span id="cb57-403"><a href="#cb57-403"></a><span class="in">  kableExtra::kable_styling(full_width = FALSE)</span></span>
<span id="cb57-404"><a href="#cb57-404"></a><span class="in">```</span></span>
<span id="cb57-405"><a href="#cb57-405"></a></span>
<span id="cb57-406"><a href="#cb57-406"></a>It would be easier to wrangle this data (e.g. to filter by age) if the data in</span>
<span id="cb57-407"><a href="#cb57-407"></a>the <span class="in">`age_sex`</span> column was stored in two separate columns. Making this change </span>
<span id="cb57-408"><a href="#cb57-408"></a>would also make sure our data meets the definition of being tidy: every variable</span>
<span id="cb57-409"><a href="#cb57-409"></a>should be stored in a separate column.</span>
<span id="cb57-410"><a href="#cb57-410"></a></span>
<span id="cb57-411"><a href="#cb57-411"></a>We can split the <span class="in">`age_sex`</span> column into two using the <span class="in">`separate()`</span> function from</span>
<span id="cb57-412"><a href="#cb57-412"></a>the <span class="in">`tidyr`</span> package. We specify the existing column we want to split using the</span>
<span id="cb57-413"><a href="#cb57-413"></a><span class="in">`col`</span> argument, the names of the new columns we want to create using the <span class="in">`into`</span></span>
<span id="cb57-414"><a href="#cb57-414"></a>argument and the character(s) that represent the boundary between the two pieces</span>
<span id="cb57-415"><a href="#cb57-415"></a>of data in each column (in this case, <span class="in">`/`</span>).</span>
<span id="cb57-416"><a href="#cb57-416"></a></span>
<span id="cb57-417"><a href="#cb57-417"></a><span class="in">```{r structure-exercise8, exercise=TRUE}</span></span>
<span id="cb57-418"><a href="#cb57-418"></a><span class="in">separate(victims, col = age_sex, into = c("age", "sex"), sep = "/")</span></span>
<span id="cb57-419"><a href="#cb57-419"></a><span class="in">```</span></span>
<span id="cb57-420"><a href="#cb57-420"></a></span>
<span id="cb57-421"><a href="#cb57-421"></a>You might have noticed that this function produced a warning message saying </span>
<span id="cb57-422"><a href="#cb57-422"></a><span class="in">`Expected 2 pieces. Missing pieces filled with NA in 1 rows [2]`</span>. This is</span>
<span id="cb57-423"><a href="#cb57-423"></a>because the second row of data in the <span class="in">`victims`</span> object only contains one of the</span>
<span id="cb57-424"><a href="#cb57-424"></a>two pieces of data. When this happens, <span class="in">`separate()`</span> fills in the values that are</span>
<span id="cb57-425"><a href="#cb57-425"></a>present from the left, filling any remaining columns to the right with <span class="in">`NA`</span>. If </span>
<span id="cb57-426"><a href="#cb57-426"></a>this is what we want (as it is here), we can silence this warning by specifying </span>
<span id="cb57-427"><a href="#cb57-427"></a><span class="in">`fill = "right"`</span>. If instead we wanted <span class="in">`separate()`</span> to fill in columns with <span class="in">`NA`</span></span>
<span id="cb57-428"><a href="#cb57-428"></a>values from the left, we could specify <span class="in">`fill = "left"`</span>.</span>
<span id="cb57-429"><a href="#cb57-429"></a></span>
<span id="cb57-430"><a href="#cb57-430"></a>Another issue with the separated data is that because the column <span class="in">`age_sex`</span> was</span>
<span id="cb57-431"><a href="#cb57-431"></a>a character column, both <span class="in">`age`</span> and <span class="in">`sex`</span> are character columns, too. Since <span class="in">`age`</span></span>
<span id="cb57-432"><a href="#cb57-432"></a>is actually numeric, we can get <span class="in">`separate()`</span> to convert this new column to the</span>
<span id="cb57-433"><a href="#cb57-433"></a>correct type automatically by specifying <span class="in">`convert = TRUE`</span>.</span>
<span id="cb57-434"><a href="#cb57-434"></a></span>
<span id="cb57-435"><a href="#cb57-435"></a><span class="in">```{r structure-exercise9, exercise=TRUE}</span></span>
<span id="cb57-436"><a href="#cb57-436"></a><span class="in">separate(</span></span>
<span id="cb57-437"><a href="#cb57-437"></a><span class="in">  victims, </span></span>
<span id="cb57-438"><a href="#cb57-438"></a><span class="in">  col = age_sex, </span></span>
<span id="cb57-439"><a href="#cb57-439"></a><span class="in">  into = c("age", "sex"), </span></span>
<span id="cb57-440"><a href="#cb57-440"></a><span class="in">  sep = "/",</span></span>
<span id="cb57-441"><a href="#cb57-441"></a><span class="in">  convert = TRUE,</span></span>
<span id="cb57-442"><a href="#cb57-442"></a><span class="in">  fill = "right"</span></span>
<span id="cb57-443"><a href="#cb57-443"></a><span class="in">)</span></span>
<span id="cb57-444"><a href="#cb57-444"></a><span class="in">```</span></span>
<span id="cb57-445"><a href="#cb57-445"></a></span>
<span id="cb57-446"><a href="#cb57-446"></a>We now know how to convert a data into a tidy format using <span class="in">`pivot_longer()`</span> to</span>
<span id="cb57-447"><a href="#cb57-447"></a>convert data to long format, remove non-data rows using <span class="in">`slice()`</span>, </span>
<span id="cb57-448"><a href="#cb57-448"></a><span class="in">`remove_empty()`</span> and the <span class="in">`skip`</span> argument to many functions like <span class="in">`read_csv()`</span>, </span>
<span id="cb57-449"><a href="#cb57-449"></a>and split columns with <span class="in">`separate()`</span>. In the next section, we'll learn how to</span>
<span id="cb57-450"><a href="#cb57-450"></a>tidy the content of individual cells.</span>
<span id="cb57-451"><a href="#cb57-451"></a></span>
<span id="cb57-452"><a href="#cb57-452"></a>&lt;p class="credits"&gt;<span class="co">[</span><span class="ot">Stats Illustrations by Allison Horst</span><span class="co">](https://github.com/allisonhorst/stats-illustrations)</span> licensed under the <span class="co">[</span><span class="ot">Creative Commons Attribution licence</span><span class="co">](https://github.com/allisonhorst/stats-illustrations/blob/master/license)</span>.&lt;/p&gt;</span>
<span id="cb57-453"><a href="#cb57-453"></a></span>
<span id="cb57-454"><a href="#cb57-454"></a></span>
<span id="cb57-455"><a href="#cb57-455"></a></span>
<span id="cb57-456"><a href="#cb57-456"></a><span class="fu">## Tidying the content of cells</span></span>
<span id="cb57-457"><a href="#cb57-457"></a></span>
<span id="cb57-458"><a href="#cb57-458"></a>As well as data with a messy structure, you might be provided with data with </span>
<span id="cb57-459"><a href="#cb57-459"></a>messy content inside some of the cells. In this section we will clean messy </span>
<span id="cb57-460"><a href="#cb57-460"></a>content, mostly using functions from the <span class="in">`stringr`</span> package that is loaded </span>
<span id="cb57-461"><a href="#cb57-461"></a>automatically when we load <span class="in">`tidyverse`</span>. All the functions in the <span class="in">`stringr`</span></span>
<span id="cb57-462"><a href="#cb57-462"></a>package start with <span class="in">`str_`</span> so that they are easy to remember.</span>
<span id="cb57-463"><a href="#cb57-463"></a></span>
<span id="cb57-464"><a href="#cb57-464"></a>We can change the case of text using one of four <span class="in">`str_to_`</span> functions:</span>
<span id="cb57-465"><a href="#cb57-465"></a></span>
<span id="cb57-466"><a href="#cb57-466"></a><span class="in">```{r case-table, echo=FALSE}</span></span>
<span id="cb57-467"><a href="#cb57-467"></a><span class="in">tribble(</span></span>
<span id="cb57-468"><a href="#cb57-468"></a><span class="in">  ~input, ~`function`, ~output,</span></span>
<span id="cb57-469"><a href="#cb57-469"></a><span class="in">  "A stRinG oF TeXT", "`st_to_lower()`", str_to_lower("A stRinG oF TeXT"),</span></span>
<span id="cb57-470"><a href="#cb57-470"></a><span class="in">  "A stRinG oF TeXT", "`st_to_upper()`", str_to_upper("A stRinG oF TeXT"),</span></span>
<span id="cb57-471"><a href="#cb57-471"></a><span class="in">  "A stRinG oF TeXT", "`st_to_sentence()`", str_to_sentence("A stRinG oF TeXT"),</span></span>
<span id="cb57-472"><a href="#cb57-472"></a><span class="in">  "A stRinG oF TeXT", "`st_to_title()`", str_to_title("A stRinG oF TeXT")</span></span>
<span id="cb57-473"><a href="#cb57-473"></a><span class="in">) |&gt; </span></span>
<span id="cb57-474"><a href="#cb57-474"></a><span class="in">  knitr::kable() |&gt; </span></span>
<span id="cb57-475"><a href="#cb57-475"></a><span class="in">  kableExtra::kable_styling(full_width = FALSE)</span></span>
<span id="cb57-476"><a href="#cb57-476"></a><span class="in">```</span></span>
<span id="cb57-477"><a href="#cb57-477"></a></span>
<span id="cb57-478"><a href="#cb57-478"></a>We can also remove unwanted text from within values. For example, if there is</span>
<span id="cb57-479"><a href="#cb57-479"></a>unwanted white-space (spaces, tabs, etc.) at the beginning or end of a string of</span>
<span id="cb57-480"><a href="#cb57-480"></a>characters, we can remove it with <span class="in">`str_trim()`</span>. <span class="in">`str_squish()`</span> does the same </span>
<span id="cb57-481"><a href="#cb57-481"></a>thing, but also reduces any repeated white-space characters in a string of text</span>
<span id="cb57-482"><a href="#cb57-482"></a>down to a single space. For example, <span class="in">`str_squish("  A string   of text")`</span></span>
<span id="cb57-483"><a href="#cb57-483"></a>produces the result ``r str_squish("  A string   of text")``.</span>
<span id="cb57-484"><a href="#cb57-484"></a></span>
<span id="cb57-485"><a href="#cb57-485"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/str_squish.jpg" alt="Cartoon explaining that the str_squish() function removes leading, trailing and repeated interior whitespace from strings."&gt;&lt;/p&gt;</span>
<span id="cb57-486"><a href="#cb57-486"></a></span>
<span id="cb57-487"><a href="#cb57-487"></a>Data from the UK police open data website includes the words 'on or near' at the </span>
<span id="cb57-488"><a href="#cb57-488"></a>start of every value in the <span class="in">`location`</span> column of the data. This is to remind </span>
<span id="cb57-489"><a href="#cb57-489"></a>users that the locations of crimes are deliberately obscured by being 'snapped' </span>
<span id="cb57-490"><a href="#cb57-490"></a>to the centre of the street on which they occur to protect victims' privacy. </span>
<span id="cb57-491"><a href="#cb57-491"></a></span>
<span id="cb57-492"><a href="#cb57-492"></a><span class="in">```{r uk-data-table, include=TRUE, echo=FALSE}</span></span>
<span id="cb57-493"><a href="#cb57-493"></a><span class="in">uk_data |&gt; </span></span>
<span id="cb57-494"><a href="#cb57-494"></a><span class="in">  knitr::kable() |&gt; </span></span>
<span id="cb57-495"><a href="#cb57-495"></a><span class="in">  kableExtra::kable_styling(full_width = FALSE)</span></span>
<span id="cb57-496"><a href="#cb57-496"></a><span class="in">```</span></span>
<span id="cb57-497"><a href="#cb57-497"></a></span>
<span id="cb57-498"><a href="#cb57-498"></a>We don't need this constant value for analysis, and for large datasets it can </span>
<span id="cb57-499"><a href="#cb57-499"></a>unnecessarily increase the size of the data when we save it to a file. For this </span>
<span id="cb57-500"><a href="#cb57-500"></a>reason we might want to remove this constant value using the <span class="in">`str_remove()`</span> </span>
<span id="cb57-501"><a href="#cb57-501"></a>function.</span>
<span id="cb57-502"><a href="#cb57-502"></a></span>
<span id="cb57-503"><a href="#cb57-503"></a><span class="in">```{r content-exercise1, exercise=TRUE}</span></span>
<span id="cb57-504"><a href="#cb57-504"></a><span class="in">mutate(uk_data, location = str_remove(location, "On or near "))</span></span>
<span id="cb57-505"><a href="#cb57-505"></a><span class="in">```</span></span>
<span id="cb57-506"><a href="#cb57-506"></a></span>
<span id="cb57-507"><a href="#cb57-507"></a>The <span class="in">`lsoa_name`</span> code of this dataset includes the name of the small statistical</span>
<span id="cb57-508"><a href="#cb57-508"></a>area in which each crime occurred. Each name is made up of the name of the</span>
<span id="cb57-509"><a href="#cb57-509"></a>local government district covering the area followed by a unique code. If we</span>
<span id="cb57-510"><a href="#cb57-510"></a>wanted to extract just the district name (for example so we could count the</span>
<span id="cb57-511"><a href="#cb57-511"></a>number of crimes in each district) we can do that by removing the code that</span>
<span id="cb57-512"><a href="#cb57-512"></a>follows the district name. To do this we need to use a *regular expression*, </span>
<span id="cb57-513"><a href="#cb57-513"></a>which is a way of describing a pattern in a string of characters. Regular </span>
<span id="cb57-514"><a href="#cb57-514"></a>expressions can be used to find, extract or remove characters that match a</span>
<span id="cb57-515"><a href="#cb57-515"></a>specified pattern. </span>
<span id="cb57-516"><a href="#cb57-516"></a></span>
<span id="cb57-517"><a href="#cb57-517"></a>Regular expressions can be complicated, so we will only scratch the surface of </span>
<span id="cb57-518"><a href="#cb57-518"></a>what's possible here. You can find out much more about about them in the </span>
<span id="cb57-519"><a href="#cb57-519"></a><span class="co">[</span><span class="ot">article on regular expressions included in the `stringr` package</span><span class="co">](https://stringr.tidyverse.org/articles/regular-expressions.html)</span>.</span>
<span id="cb57-520"><a href="#cb57-520"></a>The coded description of the pattern of characters we need to match the code at</span>
<span id="cb57-521"><a href="#cb57-521"></a>the end of the <span class="in">`lsoa_name`</span> column is <span class="in">`\\s\\w{4}$`</span>. This is made up three parts:</span>
<span id="cb57-522"><a href="#cb57-522"></a></span>
<span id="cb57-523"><a href="#cb57-523"></a><span class="ss">  * </span><span class="in">`\\s`</span> means match exactly one white-space character (e.g. a space or a tab),</span>
<span id="cb57-524"><a href="#cb57-524"></a><span class="ss">  * </span><span class="in">`\\w{4}`</span> means match exactly four word characters (i.e. any letter, any </span>
<span id="cb57-525"><a href="#cb57-525"></a>    number or some punctuation marks), and</span>
<span id="cb57-526"><a href="#cb57-526"></a><span class="ss">  * </span><span class="in">`$`</span> means match the end of the string.</span>
<span id="cb57-527"><a href="#cb57-527"></a>  </span>
<span id="cb57-528"><a href="#cb57-528"></a>So <span class="in">`\\s\\w{4}$`</span> means match exactly one white-space character followed by </span>
<span id="cb57-529"><a href="#cb57-529"></a>exactly four word characters at the end of the string. We can use this pattern</span>
<span id="cb57-530"><a href="#cb57-530"></a>as the second argument to the <span class="in">`str_remove()`</span> function to remove the characters</span>
<span id="cb57-531"><a href="#cb57-531"></a>matched by the pattern.</span>
<span id="cb57-532"><a href="#cb57-532"></a></span>
<span id="cb57-533"><a href="#cb57-533"></a><span class="in">```{r content-exercise2, exercise=TRUE}</span></span>
<span id="cb57-534"><a href="#cb57-534"></a><span class="in">mutate(uk_data, district = str_remove(lsoa_name, "\\s\\w{4}$"))</span></span>
<span id="cb57-535"><a href="#cb57-535"></a><span class="in">```</span></span>
<span id="cb57-536"><a href="#cb57-536"></a></span>
<span id="cb57-537"><a href="#cb57-537"></a>We could also use regular expressions together with <span class="in">`str_extract()`</span> to keep only </span>
<span id="cb57-538"><a href="#cb57-538"></a>the characters matched by the pattern, <span class="in">`str_replace()`</span> to replace the first </span>
<span id="cb57-539"><a href="#cb57-539"></a>group of characters matched by the pattern and <span class="in">`str_replace_all()`</span> to replace</span>
<span id="cb57-540"><a href="#cb57-540"></a>all the groups of characters matched by the pattern. For more tips on using </span>
<span id="cb57-541"><a href="#cb57-541"></a>regular expressions together with functions from the <span class="in">`stringr`</span> package, see the </span>
<span id="cb57-542"><a href="#cb57-542"></a><span class="co">[</span><span class="ot">`stringr` package cheat sheet</span><span class="co">](https://github.com/rstudio/cheatsheets/blob/main/strings.pdf)</span></span>
<span id="cb57-543"><a href="#cb57-543"></a>or visit <span class="co">[</span><span class="ot">regexr.com</span><span class="co">](https://regexr.com/)</span>.</span>
<span id="cb57-544"><a href="#cb57-544"></a></span>
<span id="cb57-545"><a href="#cb57-545"></a></span>
<span id="cb57-546"><a href="#cb57-546"></a><span class="fu">### Converting between types of variable</span></span>
<span id="cb57-547"><a href="#cb57-547"></a></span>
<span id="cb57-548"><a href="#cb57-548"></a>Sometimes columns in your data will be stored as the wrong type of variable.</span>
<span id="cb57-549"><a href="#cb57-549"></a><span class="in">`read_csv()`</span> and other functions from the <span class="in">`readr`</span> package try to guess what type</span>
<span id="cb57-550"><a href="#cb57-550"></a>of variable is contained in each column based on what is contained in the first</span>
<span id="cb57-551"><a href="#cb57-551"></a>few rows, but this does not always work. For example, a variable containing </span>
<span id="cb57-552"><a href="#cb57-552"></a>numbers might be stored as characters, meaning functions like <span class="in">`mean()`</span> will not</span>
<span id="cb57-553"><a href="#cb57-553"></a>work. In cases like this, we can use the <span class="in">`as.numeric()`</span> function to convert the</span>
<span id="cb57-554"><a href="#cb57-554"></a>character variable into a numeric variable.</span>
<span id="cb57-555"><a href="#cb57-555"></a></span>
<span id="cb57-556"><a href="#cb57-556"></a><span class="in">```{r content-exercise3, exercise=TRUE}</span></span>
<span id="cb57-557"><a href="#cb57-557"></a><span class="in"># Some numbers stored as text (note the quote marks around each number)</span></span>
<span id="cb57-558"><a href="#cb57-558"></a><span class="in">numbers_as_text &lt;- c("14", "6", "17")</span></span>
<span id="cb57-559"><a href="#cb57-559"></a></span>
<span id="cb57-560"><a href="#cb57-560"></a><span class="in"># Trying to find the mean of these numbers stored as characters will produce </span></span>
<span id="cb57-561"><a href="#cb57-561"></a><span class="in"># `NA` and a warning</span></span>
<span id="cb57-562"><a href="#cb57-562"></a><span class="in">mean(numbers_as_text)</span></span>
<span id="cb57-563"><a href="#cb57-563"></a></span>
<span id="cb57-564"><a href="#cb57-564"></a><span class="in"># If we use `as.numeric()` then `mean()` now works</span></span>
<span id="cb57-565"><a href="#cb57-565"></a><span class="in">mean(as.numeric(numbers_as_text))</span></span>
<span id="cb57-566"><a href="#cb57-566"></a><span class="in">```</span></span>
<span id="cb57-567"><a href="#cb57-567"></a></span>
<span id="cb57-568"><a href="#cb57-568"></a>&lt;img src="images/parse_number.jpg" alt="Cartoon showing that the parse_number() function extracts numeric values from text, stripping out all non-numeric characters." class="right-side-image" style="width: 400px; max-width: 50%;"&gt;</span>
<span id="cb57-569"><a href="#cb57-569"></a></span>
<span id="cb57-570"><a href="#cb57-570"></a>We can use equivalent functions to convert columns to different types, e.g.</span>
<span id="cb57-571"><a href="#cb57-571"></a><span class="in">`as.character()`</span> to convert a variable to characters and <span class="in">`as.logical()`</span> to</span>
<span id="cb57-572"><a href="#cb57-572"></a>convert a variable to only <span class="in">`TRUE`</span> and <span class="in">`FALSE`</span> values. Be careful, though: if you</span>
<span id="cb57-573"><a href="#cb57-573"></a>try to convert a variable to a data type that makes no sense, you are likely to</span>
<span id="cb57-574"><a href="#cb57-574"></a>find all of your values replaced with <span class="in">`NA`</span>.</span>
<span id="cb57-575"><a href="#cb57-575"></a></span>
<span id="cb57-576"><a href="#cb57-576"></a>Sometimes numbers will be stored alongside other values, such as when currency</span>
<span id="cb57-577"><a href="#cb57-577"></a>values are stored together with a currency symbol. We can deal with values like</span>
<span id="cb57-578"><a href="#cb57-578"></a>these by using the <span class="in">`parse_number()`</span> function from the <span class="in">`readr`</span> package, which </span>
<span id="cb57-579"><a href="#cb57-579"></a>strips all the non-numeric characters from a value and then converts the numeric</span>
<span id="cb57-580"><a href="#cb57-580"></a>characters to a number. For example, <span class="in">`parse_number("Room 14A")`</span> produces the</span>
<span id="cb57-581"><a href="#cb57-581"></a>numeric value <span class="in">` `</span>r parse_number("Room 14A")<span class="in">` `</span>.</span>
<span id="cb57-582"><a href="#cb57-582"></a></span>
<span id="cb57-583"><a href="#cb57-583"></a></span>
<span id="cb57-584"><a href="#cb57-584"></a><span class="fu">### Recoding categorical variables</span></span>
<span id="cb57-585"><a href="#cb57-585"></a></span>
<span id="cb57-586"><a href="#cb57-586"></a>Crime data often includes categorical variables, such as crime types or location</span>
<span id="cb57-587"><a href="#cb57-587"></a>categories. It can be useful to change these categories, for example so that we</span>
<span id="cb57-588"><a href="#cb57-588"></a>can join two datasets or abbreviate category names for use in the axis labels of</span>
<span id="cb57-589"><a href="#cb57-589"></a>a chart.</span>
<span id="cb57-590"><a href="#cb57-590"></a></span>
<span id="cb57-591"><a href="#cb57-591"></a>We can use the <span class="in">`if_else()`</span> function from the <span class="in">`dplyr`</span> package to change </span>
<span id="cb57-592"><a href="#cb57-592"></a>particular values, but this only allows us to change a single value and can </span>
<span id="cb57-593"><a href="#cb57-593"></a>produce slightly untidy code. Instead we can use  the <span class="in">`recode()`</span> function from </span>
<span id="cb57-594"><a href="#cb57-594"></a>the <span class="in">`dplyr`</span> package to change one or more values at the same time. For example, </span>
<span id="cb57-595"><a href="#cb57-595"></a>if we wanted to change the value <span class="in">`Supermarket`</span> to <span class="in">`Shop`</span> in the UK police data.</span>
<span id="cb57-596"><a href="#cb57-596"></a></span>
<span id="cb57-597"><a href="#cb57-597"></a><span class="in">```{r recoding-exercise1, exercise=TRUE}</span></span>
<span id="cb57-598"><a href="#cb57-598"></a><span class="in"># Once again we will remove the unnecessary 'On or near ' using `str_remove()`</span></span>
<span id="cb57-599"><a href="#cb57-599"></a><span class="in">mutate(</span></span>
<span id="cb57-600"><a href="#cb57-600"></a><span class="in">  uk_data, </span></span>
<span id="cb57-601"><a href="#cb57-601"></a><span class="in">  location = recode(</span></span>
<span id="cb57-602"><a href="#cb57-602"></a><span class="in">    str_remove(location, "On or near "),</span></span>
<span id="cb57-603"><a href="#cb57-603"></a><span class="in">    "Supermarket" = "Shop"</span></span>
<span id="cb57-604"><a href="#cb57-604"></a><span class="in">  )</span></span>
<span id="cb57-605"><a href="#cb57-605"></a><span class="in">)</span></span>
<span id="cb57-606"><a href="#cb57-606"></a><span class="in">```</span></span>
<span id="cb57-607"><a href="#cb57-607"></a></span>
<span id="cb57-608"><a href="#cb57-608"></a></span>
<span id="cb57-609"><a href="#cb57-609"></a>::: {.tutorial}</span>
<span id="cb57-610"><a href="#cb57-610"></a></span>
<span id="cb57-611"><a href="#cb57-611"></a>Run the code needed to change the value <span class="in">`Nottingham`</span> to <span class="in">`City of Nottingham`</span> in</span>
<span id="cb57-612"><a href="#cb57-612"></a>the <span class="in">`district`</span> column in the <span class="in">`uk_data`</span> object (you will need to create the </span>
<span id="cb57-613"><a href="#cb57-613"></a><span class="in">`district`</span> column from the <span class="in">`lsoa_name`</span> first).</span>
<span id="cb57-614"><a href="#cb57-614"></a></span>
<span id="cb57-615"><a href="#cb57-615"></a><span class="in">```{r recoding-exercise2, exercise=TRUE, exercise.lines=8}</span></span>
<span id="cb57-616"><a href="#cb57-616"></a></span>
<span id="cb57-617"><a href="#cb57-617"></a><span class="in">```</span></span>
<span id="cb57-618"><a href="#cb57-618"></a></span>
<span id="cb57-619"><a href="#cb57-619"></a><span class="in">```{r recoding-exercise2-solution}</span></span>
<span id="cb57-620"><a href="#cb57-620"></a><span class="in">uk_data |&gt; </span></span>
<span id="cb57-621"><a href="#cb57-621"></a><span class="in">  mutate(</span></span>
<span id="cb57-622"><a href="#cb57-622"></a><span class="in">    district = str_remove(lsoa_name, "\\s\\w{4}$"),</span></span>
<span id="cb57-623"><a href="#cb57-623"></a><span class="in">    district = recode(district, "Nottingham" = "City of Nottingham")</span></span>
<span id="cb57-624"><a href="#cb57-624"></a><span class="in">  ) |&gt; </span></span>
<span id="cb57-625"><a href="#cb57-625"></a><span class="in">  # Select only some columns to make the result easier to see below</span></span>
<span id="cb57-626"><a href="#cb57-626"></a><span class="in">  select(lsoa_name, district)</span></span>
<span id="cb57-627"><a href="#cb57-627"></a></span>
<span id="cb57-628"><a href="#cb57-628"></a><span class="in">```</span></span>
<span id="cb57-629"><a href="#cb57-629"></a></span>
<span id="cb57-630"><a href="#cb57-630"></a>:::</span>
<span id="cb57-631"><a href="#cb57-631"></a></span>
<span id="cb57-632"><a href="#cb57-632"></a></span>
<span id="cb57-633"><a href="#cb57-633"></a><span class="fu">### Missing values</span></span>
<span id="cb57-634"><a href="#cb57-634"></a></span>
<span id="cb57-635"><a href="#cb57-635"></a>We have already encountered the <span class="in">`NA`</span> value, which R uses to represent a value </span>
<span id="cb57-636"><a href="#cb57-636"></a>that is missing from a dataset. While R uses <span class="in">`NA`</span> to represent missing values,</span>
<span id="cb57-637"><a href="#cb57-637"></a>some data providers use other codes. For example, a data provider might use a </span>
<span id="cb57-638"><a href="#cb57-638"></a>dash (<span class="in">`-`</span>) or two periods (<span class="in">`..`</span>) to represent missing values. Fortunately, we </span>
<span id="cb57-639"><a href="#cb57-639"></a>can convert any value to <span class="in">`NA`</span> so that we know that it represents a missing </span>
<span id="cb57-640"><a href="#cb57-640"></a>value.</span>
<span id="cb57-641"><a href="#cb57-641"></a></span>
<span id="cb57-642"><a href="#cb57-642"></a>Imagine that you have been provided with a dataset of burglaries that includes </span>
<span id="cb57-643"><a href="#cb57-643"></a>an estimate of the value of the goods that were stolen in British pounds. You </span>
<span id="cb57-644"><a href="#cb57-644"></a>have been told that when the value of the stolen goods wasn't known, this is </span>
<span id="cb57-645"><a href="#cb57-645"></a>recorded as the value <span class="in">`-1`</span> in the data. If we use <span class="in">`mean()`</span> to estimate the </span>
<span id="cb57-646"><a href="#cb57-646"></a>average value of property stolen, the value <span class="in">`-1`</span> will give us an incorrect </span>
<span id="cb57-647"><a href="#cb57-647"></a>result. If we instead convert that value to <span class="in">`NA`</span> first, <span class="in">`mean()`</span> will know to </span>
<span id="cb57-648"><a href="#cb57-648"></a>ignore that value as long as we specify the argument <span class="in">`na.rm = TRUE`</span>.</span>
<span id="cb57-649"><a href="#cb57-649"></a></span>
<span id="cb57-650"><a href="#cb57-650"></a><span class="in">```{r missing-exercise1, exercise=TRUE, exercise.lines=16}</span></span>
<span id="cb57-651"><a href="#cb57-651"></a><span class="in"># Print some rows of burglary values</span></span>
<span id="cb57-652"><a href="#cb57-652"></a><span class="in">head(burglary_values)</span></span>
<span id="cb57-653"><a href="#cb57-653"></a></span>
<span id="cb57-654"><a href="#cb57-654"></a><span class="in"># Try to calculate the mean value -- no error, but the answer is wrong</span></span>
<span id="cb57-655"><a href="#cb57-655"></a><span class="in"># `pull()` is used to extract the `value` column from `burglary_values`</span></span>
<span id="cb57-656"><a href="#cb57-656"></a><span class="in">mean(pull(burglary_values, "value"))</span></span>
<span id="cb57-657"><a href="#cb57-657"></a></span>
<span id="cb57-658"><a href="#cb57-658"></a><span class="in"># Convert `-1` to `NA` first, now you get the correct mean value</span></span>
<span id="cb57-659"><a href="#cb57-659"></a><span class="in">burglary_values &lt;- mutate(</span></span>
<span id="cb57-660"><a href="#cb57-660"></a><span class="in">  burglary_values,</span></span>
<span id="cb57-661"><a href="#cb57-661"></a><span class="in">  value = if_else(value == -1, NA_real_, value)</span></span>
<span id="cb57-662"><a href="#cb57-662"></a><span class="in">)</span></span>
<span id="cb57-663"><a href="#cb57-663"></a></span>
<span id="cb57-664"><a href="#cb57-664"></a><span class="in"># Calculate the mean value again, now excluding the missing value</span></span>
<span id="cb57-665"><a href="#cb57-665"></a><span class="in">mean(pull(burglary_values, "value"), na.rm = TRUE)</span></span>
<span id="cb57-666"><a href="#cb57-666"></a><span class="in">```</span></span>
<span id="cb57-667"><a href="#cb57-667"></a></span>
<span id="cb57-668"><a href="#cb57-668"></a>Excluding the value <span class="in">`-1`</span> makes a substantial difference to the mean, increasing</span>
<span id="cb57-669"><a href="#cb57-669"></a>it by over £100.</span>
<span id="cb57-670"><a href="#cb57-670"></a></span>
<span id="cb57-671"><a href="#cb57-671"></a></span>
<span id="cb57-672"><a href="#cb57-672"></a><span class="fu">### Null Island</span></span>
<span id="cb57-673"><a href="#cb57-673"></a></span>
<span id="cb57-674"><a href="#cb57-674"></a>The problem of missing values being stored as numbers manifests itself in a </span>
<span id="cb57-675"><a href="#cb57-675"></a>particularly frustrating way when it comes to spatial data. People and </span>
<span id="cb57-676"><a href="#cb57-676"></a>organisations that produce spatial datasets sometimes recording missing </span>
<span id="cb57-677"><a href="#cb57-677"></a>co-ordinates as being _zero_, instead of being _missing_. This is a problem </span>
<span id="cb57-678"><a href="#cb57-678"></a>because the longitude/latitude co-ordinates "0, 0" correspond to a real location </span>
<span id="cb57-679"><a href="#cb57-679"></a>on the surface of the earth, in the Gulf of Guinea off the coast of Ghana. This </span>
<span id="cb57-680"><a href="#cb57-680"></a>location is incorrectly recorded in spatial datasets so often that it's become </span>
<span id="cb57-681"><a href="#cb57-681"></a>known as _Null Island_. Watch this video to find out more about Null Island and</span>
<span id="cb57-682"><a href="#cb57-682"></a>the problems it causes.</span>
<span id="cb57-683"><a href="#cb57-683"></a></span>
<span id="cb57-684"><a href="#cb57-684"></a>{{&lt; video https://youtu.be/bjvIpI-1w84 &gt;}}</span>
<span id="cb57-685"><a href="#cb57-685"></a></span>
<span id="cb57-686"><a href="#cb57-686"></a><span class="in">```{r null-island-map, echo=FALSE, eval=FALSE}</span></span>
<span id="cb57-687"><a href="#cb57-687"></a><span class="in">ortho &lt;- "+proj=ortho +lon_0=0 +lat_0=15"</span></span>
<span id="cb57-688"><a href="#cb57-688"></a></span>
<span id="cb57-689"><a href="#cb57-689"></a><span class="in">countries &lt;- rnaturalearth::countries110 |&gt; </span></span>
<span id="cb57-690"><a href="#cb57-690"></a><span class="in">  st_as_sf() |&gt; </span></span>
<span id="cb57-691"><a href="#cb57-691"></a><span class="in">  filter(NAME != "Antarctica") |&gt; </span></span>
<span id="cb57-692"><a href="#cb57-692"></a><span class="in">  st_cast("MULTILINESTRING") |&gt;</span></span>
<span id="cb57-693"><a href="#cb57-693"></a><span class="in">  st_cast("LINESTRING", do_split = TRUE) |&gt;</span></span>
<span id="cb57-694"><a href="#cb57-694"></a><span class="in">  st_cast("POLYGON")</span></span>
<span id="cb57-695"><a href="#cb57-695"></a></span>
<span id="cb57-696"><a href="#cb57-696"></a><span class="in">null_island &lt;- st_point(c(0, 0)) |&gt; </span></span>
<span id="cb57-697"><a href="#cb57-697"></a><span class="in">  st_sfc(crs = "EPSG:4326") |&gt; </span></span>
<span id="cb57-698"><a href="#cb57-698"></a><span class="in">  st_sf() |&gt; </span></span>
<span id="cb57-699"><a href="#cb57-699"></a><span class="in">  st_set_geometry("geometry") |&gt; </span></span>
<span id="cb57-700"><a href="#cb57-700"></a><span class="in">  st_transform(ortho) |&gt; </span></span>
<span id="cb57-701"><a href="#cb57-701"></a><span class="in">  mutate(label = "Null\nIsland")</span></span>
<span id="cb57-702"><a href="#cb57-702"></a></span>
<span id="cb57-703"><a href="#cb57-703"></a><span class="in">limits &lt;- null_island |&gt; </span></span>
<span id="cb57-704"><a href="#cb57-704"></a><span class="in">  st_buffer(10^6.5) |&gt; </span></span>
<span id="cb57-705"><a href="#cb57-705"></a><span class="in">  st_bbox()</span></span>
<span id="cb57-706"><a href="#cb57-706"></a></span>
<span id="cb57-707"><a href="#cb57-707"></a><span class="in">graticule &lt;- st_graticule(</span></span>
<span id="cb57-708"><a href="#cb57-708"></a><span class="in">  x = c(-180, -80, 180, 80), </span></span>
<span id="cb57-709"><a href="#cb57-709"></a><span class="in">  crs = "EPSG:4326",</span></span>
<span id="cb57-710"><a href="#cb57-710"></a><span class="in">  lon = seq(-180, 180, by = 20),</span></span>
<span id="cb57-711"><a href="#cb57-711"></a><span class="in">  lat = seq(-80, 80, by = 20)</span></span>
<span id="cb57-712"><a href="#cb57-712"></a><span class="in">) |&gt; </span></span>
<span id="cb57-713"><a href="#cb57-713"></a><span class="in">  mutate(highlight = degree == 0)</span></span>
<span id="cb57-714"><a href="#cb57-714"></a></span>
<span id="cb57-715"><a href="#cb57-715"></a><span class="in">graticule_labels &lt;- tribble(</span></span>
<span id="cb57-716"><a href="#cb57-716"></a><span class="in">  ~label, ~geometry,</span></span>
<span id="cb57-717"><a href="#cb57-717"></a><span class="in">  "0º", st_point(c(-30, 0)),</span></span>
<span id="cb57-718"><a href="#cb57-718"></a><span class="in">  "40ºS", st_point(c(-30, -40)),</span></span>
<span id="cb57-719"><a href="#cb57-719"></a><span class="in">  "20ºS", st_point(c(-30, -20)),</span></span>
<span id="cb57-720"><a href="#cb57-720"></a><span class="in">  "20ºN", st_point(c(-30, 20)),</span></span>
<span id="cb57-721"><a href="#cb57-721"></a><span class="in">  "40ºN", st_point(c(-30, 40)),</span></span>
<span id="cb57-722"><a href="#cb57-722"></a><span class="in">  "60ºN", st_point(c(-30, 60)),</span></span>
<span id="cb57-723"><a href="#cb57-723"></a><span class="in">  "0º", st_point(c(0, -50)),</span></span>
<span id="cb57-724"><a href="#cb57-724"></a><span class="in">  "20ºE", st_point(c(-20, -50)),</span></span>
<span id="cb57-725"><a href="#cb57-725"></a><span class="in">  "20ºW", st_point(c(20, -50))</span></span>
<span id="cb57-726"><a href="#cb57-726"></a><span class="in">) |&gt; </span></span>
<span id="cb57-727"><a href="#cb57-727"></a><span class="in">  st_as_sf(crs = "EPSG:4326")</span></span>
<span id="cb57-728"><a href="#cb57-728"></a></span>
<span id="cb57-729"><a href="#cb57-729"></a><span class="in">world_bg &lt;- st_graticule() |&gt; </span></span>
<span id="cb57-730"><a href="#cb57-730"></a><span class="in">  st_transform(ortho) |&gt; </span></span>
<span id="cb57-731"><a href="#cb57-731"></a><span class="in">  st_convex_hull() |&gt; </span></span>
<span id="cb57-732"><a href="#cb57-732"></a><span class="in">  summarise(geometry = st_union(geometry)) |&gt; </span></span>
<span id="cb57-733"><a href="#cb57-733"></a><span class="in">  st_convex_hull()</span></span>
<span id="cb57-734"><a href="#cb57-734"></a></span>
<span id="cb57-735"><a href="#cb57-735"></a><span class="in"># null_island_map &lt;- </span></span>
<span id="cb57-736"><a href="#cb57-736"></a><span class="in">ggplot() + </span></span>
<span id="cb57-737"><a href="#cb57-737"></a><span class="in">  geom_sf(data = world_bg, colour = NA, fill = "#C6ECFF") +</span></span>
<span id="cb57-738"><a href="#cb57-738"></a><span class="in">  geom_sf(</span></span>
<span id="cb57-739"><a href="#cb57-739"></a><span class="in">    aes(colour = highlight, linetype = highlight), </span></span>
<span id="cb57-740"><a href="#cb57-740"></a><span class="in">    data = graticule, </span></span>
<span id="cb57-741"><a href="#cb57-741"></a><span class="in">    linewidth = 0.33</span></span>
<span id="cb57-742"><a href="#cb57-742"></a><span class="in">  ) +</span></span>
<span id="cb57-743"><a href="#cb57-743"></a><span class="in">  geom_sf(</span></span>
<span id="cb57-744"><a href="#cb57-744"></a><span class="in">    data = countries, </span></span>
<span id="cb57-745"><a href="#cb57-745"></a><span class="in">    colour = "grey60", </span></span>
<span id="cb57-746"><a href="#cb57-746"></a><span class="in">    fill = "#FEFEE9",</span></span>
<span id="cb57-747"><a href="#cb57-747"></a><span class="in">    linewidth = 0.2</span></span>
<span id="cb57-748"><a href="#cb57-748"></a><span class="in">  ) +</span></span>
<span id="cb57-749"><a href="#cb57-749"></a><span class="in">  geom_sf_text(</span></span>
<span id="cb57-750"><a href="#cb57-750"></a><span class="in">    aes(label = label), </span></span>
<span id="cb57-751"><a href="#cb57-751"></a><span class="in">    data = null_island, </span></span>
<span id="cb57-752"><a href="#cb57-752"></a><span class="in">    hjust = 1, </span></span>
<span id="cb57-753"><a href="#cb57-753"></a><span class="in">    lineheight = 0.9, </span></span>
<span id="cb57-754"><a href="#cb57-754"></a><span class="in">    nudge_x = -8^6,</span></span>
<span id="cb57-755"><a href="#cb57-755"></a><span class="in">    nudge_y = -8^6,</span></span>
<span id="cb57-756"><a href="#cb57-756"></a><span class="in">    vjust = 1</span></span>
<span id="cb57-757"><a href="#cb57-757"></a><span class="in">  ) +</span></span>
<span id="cb57-758"><a href="#cb57-758"></a><span class="in">  geom_sf(data = null_island, colour = "#CC0000", shape = 21, size = 5) + </span></span>
<span id="cb57-759"><a href="#cb57-759"></a><span class="in">  geom_sf(data = null_island, colour = "#CC0000", size = 2) + </span></span>
<span id="cb57-760"><a href="#cb57-760"></a><span class="in">  geom_sf_text(</span></span>
<span id="cb57-761"><a href="#cb57-761"></a><span class="in">    aes(label = label), </span></span>
<span id="cb57-762"><a href="#cb57-762"></a><span class="in">    data = graticule_labels, </span></span>
<span id="cb57-763"><a href="#cb57-763"></a><span class="in">    colour = "grey30", </span></span>
<span id="cb57-764"><a href="#cb57-764"></a><span class="in">    size = 2.75</span></span>
<span id="cb57-765"><a href="#cb57-765"></a><span class="in">  ) +</span></span>
<span id="cb57-766"><a href="#cb57-766"></a><span class="in">  scale_colour_manual(values = c(`TRUE` = "#CC0000", `FALSE` = "grey70")) +</span></span>
<span id="cb57-767"><a href="#cb57-767"></a><span class="in">  scale_linetype_manual(values = c(`TRUE` = "solid", `FALSE` = "62")) +</span></span>
<span id="cb57-768"><a href="#cb57-768"></a><span class="in">  labs(x = NULL, y = NULL) +</span></span>
<span id="cb57-769"><a href="#cb57-769"></a><span class="in">  coord_sf(crs = ortho) +</span></span>
<span id="cb57-770"><a href="#cb57-770"></a><span class="in">  theme_void() +</span></span>
<span id="cb57-771"><a href="#cb57-771"></a><span class="in">  theme(legend.position = "none")</span></span>
<span id="cb57-772"><a href="#cb57-772"></a></span>
<span id="cb57-773"><a href="#cb57-773"></a><span class="in">ggsave(</span></span>
<span id="cb57-774"><a href="#cb57-774"></a><span class="in">  here::here("inst/tutorials/12_messy_data/images/null_island.jpg"), </span></span>
<span id="cb57-775"><a href="#cb57-775"></a><span class="in">  null_island_map,</span></span>
<span id="cb57-776"><a href="#cb57-776"></a><span class="in">  width = 900 / 150,</span></span>
<span id="cb57-777"><a href="#cb57-777"></a><span class="in">  height = 900 / 150,</span></span>
<span id="cb57-778"><a href="#cb57-778"></a><span class="in">  dpi = 150</span></span>
<span id="cb57-779"><a href="#cb57-779"></a><span class="in">)</span></span>
<span id="cb57-780"><a href="#cb57-780"></a><span class="in">```</span></span>
<span id="cb57-781"><a href="#cb57-781"></a></span>
<span id="cb57-782"><a href="#cb57-782"></a>So if you see any co-ordinates on your map located in the Atlantic off the south</span>
<span id="cb57-783"><a href="#cb57-783"></a>coast of West Africa, you know that there are almost certainly rows in your data</span>
<span id="cb57-784"><a href="#cb57-784"></a>that have co-ordinates located at Null Island.</span>
<span id="cb57-785"><a href="#cb57-785"></a></span>
<span id="cb57-786"><a href="#cb57-786"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/null_island.jpg" alt="A globe map showing Null Island at co-ordinates of 0 longitude and latitude" style="max-height: 700px;"&gt;&lt;/p&gt;</span>
<span id="cb57-787"><a href="#cb57-787"></a></span>
<span id="cb57-788"><a href="#cb57-788"></a>When we make crime maps we are generally dealing with small areas such as cities</span>
<span id="cb57-789"><a href="#cb57-789"></a>and counties. So if you plot a dataset on a map and instead of seeing a map of</span>
<span id="cb57-790"><a href="#cb57-790"></a>the area you are interested in, you see a large area of the world with the place</span>
<span id="cb57-791"><a href="#cb57-791"></a>you are interested in in one corner and Null Island in the opposite corner, that</span>
<span id="cb57-792"><a href="#cb57-792"></a>almost certainly means some co-ordinates are located at Null Island. </span>
<span id="cb57-793"><a href="#cb57-793"></a></span>
<span id="cb57-794"><a href="#cb57-794"></a>As an example, imagine we were trying to create a map of the home addresses of</span>
<span id="cb57-795"><a href="#cb57-795"></a>several (fictional) suspects for bank fraud in and around Cairo, Egypt. The data</span>
<span id="cb57-796"><a href="#cb57-796"></a>contain 10 rows stored in an object called <span class="in">`cairo_suspects`</span> that looks like </span>
<span id="cb57-797"><a href="#cb57-797"></a>this:</span>
<span id="cb57-798"><a href="#cb57-798"></a></span>
<span id="cb57-799"><a href="#cb57-799"></a><span class="in">```{r cairo-suspects-table, echo=FALSE}</span></span>
<span id="cb57-800"><a href="#cb57-800"></a><span class="in">cairo_suspects |&gt; </span></span>
<span id="cb57-801"><a href="#cb57-801"></a><span class="in">  knitr::kable()</span></span>
<span id="cb57-802"><a href="#cb57-802"></a><span class="in">```</span></span>
<span id="cb57-803"><a href="#cb57-803"></a></span>
<span id="cb57-804"><a href="#cb57-804"></a></span>
<span id="cb57-805"><a href="#cb57-805"></a><span class="in">```{r cairo-suspects-maps, echo=FALSE, eval=FALSE}</span></span>
<span id="cb57-806"><a href="#cb57-806"></a><span class="in">library(ggspatial)</span></span>
<span id="cb57-807"><a href="#cb57-807"></a></span>
<span id="cb57-808"><a href="#cb57-808"></a><span class="in">cairo_null_island_map1 &lt;- cairo_suspects |&gt; </span></span>
<span id="cb57-809"><a href="#cb57-809"></a><span class="in">  filter(lon != 0) |&gt; </span></span>
<span id="cb57-810"><a href="#cb57-810"></a><span class="in">  ggplot() +</span></span>
<span id="cb57-811"><a href="#cb57-811"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 1, progress = "none") +</span></span>
<span id="cb57-812"><a href="#cb57-812"></a><span class="in">  geom_sf() +</span></span>
<span id="cb57-813"><a href="#cb57-813"></a><span class="in">  scale_x_continuous(expand = expansion(mult = 0.2)) +</span></span>
<span id="cb57-814"><a href="#cb57-814"></a><span class="in">  fixed_plot_aspect(16/9) +</span></span>
<span id="cb57-815"><a href="#cb57-815"></a><span class="in">  theme_void()</span></span>
<span id="cb57-816"><a href="#cb57-816"></a></span>
<span id="cb57-817"><a href="#cb57-817"></a><span class="in">ggsave(</span></span>
<span id="cb57-818"><a href="#cb57-818"></a><span class="in">  here::here("inst/tutorials/12_messy_data/images/null_island_cairo1.jpg"), </span></span>
<span id="cb57-819"><a href="#cb57-819"></a><span class="in">  cairo_null_island_map1,</span></span>
<span id="cb57-820"><a href="#cb57-820"></a><span class="in">  width = 900 / 150,</span></span>
<span id="cb57-821"><a href="#cb57-821"></a><span class="in">  height = 500 / 150,</span></span>
<span id="cb57-822"><a href="#cb57-822"></a><span class="in">  dpi = 150</span></span>
<span id="cb57-823"><a href="#cb57-823"></a><span class="in">)</span></span>
<span id="cb57-824"><a href="#cb57-824"></a></span>
<span id="cb57-825"><a href="#cb57-825"></a><span class="in">cairo_null_island_map2 &lt;- cairo_suspects |&gt; </span></span>
<span id="cb57-826"><a href="#cb57-826"></a><span class="in">  ggplot() +</span></span>
<span id="cb57-827"><a href="#cb57-827"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 1, progress = "none") +</span></span>
<span id="cb57-828"><a href="#cb57-828"></a><span class="in">  geom_sf() +</span></span>
<span id="cb57-829"><a href="#cb57-829"></a><span class="in">  fixed_plot_aspect(16/9) +</span></span>
<span id="cb57-830"><a href="#cb57-830"></a><span class="in">  theme_void()</span></span>
<span id="cb57-831"><a href="#cb57-831"></a></span>
<span id="cb57-832"><a href="#cb57-832"></a><span class="in">ggsave(</span></span>
<span id="cb57-833"><a href="#cb57-833"></a><span class="in">  here::here("inst/tutorials/12_messy_data/images/null_island_cairo2.jpg"), </span></span>
<span id="cb57-834"><a href="#cb57-834"></a><span class="in">  cairo_null_island_map2,</span></span>
<span id="cb57-835"><a href="#cb57-835"></a><span class="in">  width = 900 / 150,</span></span>
<span id="cb57-836"><a href="#cb57-836"></a><span class="in">  height = 500 / 150,</span></span>
<span id="cb57-837"><a href="#cb57-837"></a><span class="in">  dpi = 150</span></span>
<span id="cb57-838"><a href="#cb57-838"></a><span class="in">)</span></span>
<span id="cb57-839"><a href="#cb57-839"></a><span class="in">```</span></span>
<span id="cb57-840"><a href="#cb57-840"></a></span>
<span id="cb57-841"><a href="#cb57-841"></a>If we plotted these locations on a map, we might expect to see something like</span>
<span id="cb57-842"><a href="#cb57-842"></a>this:</span>
<span id="cb57-843"><a href="#cb57-843"></a></span>
<span id="cb57-844"><a href="#cb57-844"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/null_island_cairo1.jpg" alt="A map showing several points in the city of Cairo, Egypt"&gt;&lt;/p&gt;</span>
<span id="cb57-845"><a href="#cb57-845"></a></span>
<span id="cb57-846"><a href="#cb57-846"></a>But look again at the final row of data in the table above -- the co-ordinates </span>
<span id="cb57-847"><a href="#cb57-847"></a>for the final row are both zero. There are several reasons why this might be.</span>
<span id="cb57-848"><a href="#cb57-848"></a>Perhaps the address was recorded incorrectly in a police database and that meant</span>
<span id="cb57-849"><a href="#cb57-849"></a>that when the addresses were run through geocoding software (which we will learn</span>
<span id="cb57-850"><a href="#cb57-850"></a>more about in the next section), no co-ordinates for that row could be found.</span>
<span id="cb57-851"><a href="#cb57-851"></a>What this means is that when we plot the data on a map, that map will actually</span>
<span id="cb57-852"><a href="#cb57-852"></a>look like this:</span>
<span id="cb57-853"><a href="#cb57-853"></a></span>
<span id="cb57-854"><a href="#cb57-854"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/null_island_cairo2.jpg" alt="A map showing a large proportion of Africa, with several points clustered around the city of Cairo, Egypt in the top-right corner and a single point located in the Atlantic Ocean off the coast of Ghana."&gt;&lt;/p&gt;</span>
<span id="cb57-855"><a href="#cb57-855"></a></span>
<span id="cb57-856"><a href="#cb57-856"></a>What we can see here is most of the points on this map are correctly located in</span>
<span id="cb57-857"><a href="#cb57-857"></a>and around Cairo, but a single point is incorrectly located at Null Island.</span>
<span id="cb57-858"><a href="#cb57-858"></a></span>
<span id="cb57-859"><a href="#cb57-859"></a>We can deal with the problem of our data including points located at Null Island </span>
<span id="cb57-860"><a href="#cb57-860"></a>using the <span class="in">`st_intersection()`</span> function that we have previously used to clip</span>
<span id="cb57-861"><a href="#cb57-861"></a>datasets to the boundaries of other datasets. In this case, we can use</span>
<span id="cb57-862"><a href="#cb57-862"></a><span class="in">`st_intersection()`</span> to remove any rows from the data that are not within the</span>
<span id="cb57-863"><a href="#cb57-863"></a>area that the data is supposed to cover.</span>
<span id="cb57-864"><a href="#cb57-864"></a></span>
<span id="cb57-865"><a href="#cb57-865"></a>For example, we know that all the addresses of bank fraud suspects are supposed</span>
<span id="cb57-866"><a href="#cb57-866"></a>to be in Egypt, so we can safely clip the suspect data to the boundary of Egypt</span>
<span id="cb57-867"><a href="#cb57-867"></a>before mapping the data. There are lots of sources of data on the outlines of</span>
<span id="cb57-868"><a href="#cb57-868"></a>countries, but perhaps the most convenient to use in R is the data provided by</span>
<span id="cb57-869"><a href="#cb57-869"></a>the <span class="in">`rnaturalearth`</span> package. We can use the <span class="in">`ne_countries()`</span> function to</span>
<span id="cb57-870"><a href="#cb57-870"></a>retrieve the outline of Egypt as an SF object, which we can then use to clip the</span>
<span id="cb57-871"><a href="#cb57-871"></a>suspect dataset.</span>
<span id="cb57-872"><a href="#cb57-872"></a></span>
<span id="cb57-873"><a href="#cb57-873"></a><span class="in">```{r null-island-exercise1, exercise=TRUE}</span></span>
<span id="cb57-874"><a href="#cb57-874"></a><span class="in"># By default, `ne_countries()` does not return an SF object, so we have to</span></span>
<span id="cb57-875"><a href="#cb57-875"></a><span class="in"># specify that is what we want using the `returnclass = "sf"` argument</span></span>
<span id="cb57-876"><a href="#cb57-876"></a><span class="in">egypt_outline &lt;- rnaturalearth::ne_countries(</span></span>
<span id="cb57-877"><a href="#cb57-877"></a><span class="in">  country = "Egypt", </span></span>
<span id="cb57-878"><a href="#cb57-878"></a><span class="in">  returnclass = "sf"</span></span>
<span id="cb57-879"><a href="#cb57-879"></a><span class="in">)</span></span>
<span id="cb57-880"><a href="#cb57-880"></a></span>
<span id="cb57-881"><a href="#cb57-881"></a><span class="in">cairo_suspects_valid &lt;- st_intersection(cairo_suspects, egypt_outline)</span></span>
<span id="cb57-882"><a href="#cb57-882"></a><span class="in">```</span></span>
<span id="cb57-883"><a href="#cb57-883"></a></span>
<span id="cb57-884"><a href="#cb57-884"></a>Now if we were to plot a map using the <span class="in">`cairo_suspects_valid`</span> object, we would</span>
<span id="cb57-885"><a href="#cb57-885"></a>see the map covered only the Cairo area, as we originally wanted.</span>
<span id="cb57-886"><a href="#cb57-886"></a></span>
<span id="cb57-887"><a href="#cb57-887"></a></span>
<span id="cb57-888"><a href="#cb57-888"></a></span>
<span id="cb57-889"><a href="#cb57-889"></a><span class="fu">## Geocoding locations</span></span>
<span id="cb57-890"><a href="#cb57-890"></a></span>
<span id="cb57-891"><a href="#cb57-891"></a>Throughout this course we have used geographic data that includes locations </span>
<span id="cb57-892"><a href="#cb57-892"></a>stored as pairs of co-ordinates, e.g. latitude and longitude or easting and </span>
<span id="cb57-893"><a href="#cb57-893"></a>northing. Sometimes geographic data will not contain co-ordinates but instead</span>
<span id="cb57-894"><a href="#cb57-894"></a>store the locations of places or events as free-text addresses.</span>
<span id="cb57-895"><a href="#cb57-895"></a></span>
<span id="cb57-896"><a href="#cb57-896"></a>&lt;a href="http://www.kelleysgrilleandbar.com/" title="Kelley's Grill </span>
<span id="cb57-897"><a href="#cb57-897"></a>&amp; Bar website"&gt;&lt;img src="images/kelleys.jpg" class="right-side-image" style="border: 1px solid #333;"&gt;&lt;/a&gt;</span>
<span id="cb57-898"><a href="#cb57-898"></a></span>
<span id="cb57-899"><a href="#cb57-899"></a>Address fields can be very messy indeed. This is  because addresses can often be </span>
<span id="cb57-900"><a href="#cb57-900"></a>stored in different formats, include different abbreviations or use different </span>
<span id="cb57-901"><a href="#cb57-901"></a>spellings (including typos). For example, the official postal address </span>
<span id="cb57-902"><a href="#cb57-902"></a>'<span class="co">[</span><span class="ot">Kelley's Grill &amp; Bar</span><span class="co">](http://www.kelleysgrilleandbar.com/)</span>, 15540 State </span>
<span id="cb57-903"><a href="#cb57-903"></a>Avenue, Basehor, Kansas 66007, United States' could be stored in a local police </span>
<span id="cb57-904"><a href="#cb57-904"></a>report as:</span>
<span id="cb57-905"><a href="#cb57-905"></a></span>
<span id="cb57-906"><a href="#cb57-906"></a><span class="ss">  * </span>Kelly's Bar, 15540 US Highway 40, Basehor</span>
<span id="cb57-907"><a href="#cb57-907"></a><span class="ss">  * </span>Kelley's Grille, 15540 State</span>
<span id="cb57-908"><a href="#cb57-908"></a><span class="ss">  * </span>Kelley's, 15540 State Av</span>
<span id="cb57-909"><a href="#cb57-909"></a><span class="ss">  * </span>Kelley's Bar and Grill, 15540 State Ave</span>
<span id="cb57-910"><a href="#cb57-910"></a><span class="ss">  * </span>Kelley's Bar, State Av and 155th St</span>
<span id="cb57-911"><a href="#cb57-911"></a><span class="ss">  * </span>Kelly's Grill, State Ave btwn 155 and 158</span>
<span id="cb57-912"><a href="#cb57-912"></a></span>
<span id="cb57-913"><a href="#cb57-913"></a>All of these address descriptions would probably be good enough for local police</span>
<span id="cb57-914"><a href="#cb57-914"></a>officers to know which building the author intended to reference. But since all</span>
<span id="cb57-915"><a href="#cb57-915"></a>these different addresses relate to the same physical location, they would make</span>
<span id="cb57-916"><a href="#cb57-916"></a>it very hard to (for example) work out how many incidents had occurred at </span>
<span id="cb57-917"><a href="#cb57-917"></a>Kelley's Grill &amp; Bar using <span class="in">`count()`</span> or a similar function.</span>
<span id="cb57-918"><a href="#cb57-918"></a></span>
<span id="cb57-919"><a href="#cb57-919"></a>To make use of data containing addresses, it is typically necessary to *geocode*</span>
<span id="cb57-920"><a href="#cb57-920"></a>the locations, i.e. to convert the addresses into co-ordinates. The many ways to</span>
<span id="cb57-921"><a href="#cb57-921"></a>describe an address mean that geocoding is often quite hard.</span>
<span id="cb57-922"><a href="#cb57-922"></a></span>
<span id="cb57-923"><a href="#cb57-923"></a>&lt;a href="https://jessecambon.github.io/tidygeocoder/" title="tidygeocoder website"&gt;&lt;img src="images/tidygeocoder.png" class="right-side-image"&gt;&lt;/a&gt;</span>
<span id="cb57-924"><a href="#cb57-924"></a></span>
<span id="cb57-925"><a href="#cb57-925"></a>We can geocode addresses in R using the </span>
<span id="cb57-926"><a href="#cb57-926"></a><span class="co">[</span><span class="ot">`tidygeocoder` package</span><span class="co">](https://jessecambon.github.io/tidygeocoder/)</span>, which</span>
<span id="cb57-927"><a href="#cb57-927"></a>provides an interface to several online geocoding services. </span>
<span id="cb57-928"><a href="#cb57-928"></a></span>
<span id="cb57-929"><a href="#cb57-929"></a>To run a geocoding service an organisation has to maintain a database of many </span>
<span id="cb57-930"><a href="#cb57-930"></a>millions of addresses (which must be constantly updated) and handle addresses in</span>
<span id="cb57-931"><a href="#cb57-931"></a>many different formats, so organisations typically charge for these services or </span>
<span id="cb57-932"><a href="#cb57-932"></a>limit how many addresses you can geocode for free. Most services also require </span>
<span id="cb57-933"><a href="#cb57-933"></a>you to register, even if you are only making few-enough queries that you will </span>
<span id="cb57-934"><a href="#cb57-934"></a>not be charged. <span class="in">`tidygeocoder`</span> supports several geocoding services:</span>
<span id="cb57-935"><a href="#cb57-935"></a></span>
<span id="cb57-936"><a href="#cb57-936"></a><span class="in">```{r geocoding-services, echo=FALSE}</span></span>
<span id="cb57-937"><a href="#cb57-937"></a><span class="in">tribble(</span></span>
<span id="cb57-938"><a href="#cb57-938"></a><span class="in">  ~service, ~coverage, ~`free limits`,</span></span>
<span id="cb57-939"><a href="#cb57-939"></a><span class="in">  "[Nominatim](https://nominatim.org/)", "Worldwide", "1 address per second",</span></span>
<span id="cb57-940"><a href="#cb57-940"></a><span class="in">  "[Location IQ](https://locationiq.com/)", "Worldwide", "5,000 addresses per day",</span></span>
<span id="cb57-941"><a href="#cb57-941"></a><span class="in">  "[Geoapify](https://geoapify.com/)", "Worldwide", "3,000 addresses per day",</span></span>
<span id="cb57-942"><a href="#cb57-942"></a><span class="in">  "[OpenCage](https://opencagedata.com/)", "Worldwide", "2,500 addresses per day",</span></span>
<span id="cb57-943"><a href="#cb57-943"></a><span class="in">  "[TomTom](https://developer.tomtom.com/)", "Worldwide", "2,500 addresses per day",</span></span>
<span id="cb57-944"><a href="#cb57-944"></a><span class="in">  "[Google](https://developers.google.com/maps/documentation/geocoding/overview/)", "Worldwide", "40,000 addresses per month",</span></span>
<span id="cb57-945"><a href="#cb57-945"></a><span class="in">  "[Geocodio](https://www.geocod.io/)", "United States and Canada", "2,500 addresses per day",</span></span>
<span id="cb57-946"><a href="#cb57-946"></a><span class="in">  "[US Census](https://geocoding.geo.census.gov/)", "United States", "none"</span></span>
<span id="cb57-947"><a href="#cb57-947"></a><span class="in">) |&gt;</span></span>
<span id="cb57-948"><a href="#cb57-948"></a><span class="in">  gt() |&gt;</span></span>
<span id="cb57-949"><a href="#cb57-949"></a><span class="in">  fmt_markdown()</span></span>
<span id="cb57-950"><a href="#cb57-950"></a><span class="in">```</span></span>
<span id="cb57-951"><a href="#cb57-951"></a></span>
<span id="cb57-952"><a href="#cb57-952"></a>The <span class="in">`tidygeocoder`</span> package also supports some other services that do not offer</span>
<span id="cb57-953"><a href="#cb57-953"></a>any free option -- you can find out more about these options on the </span>
<span id="cb57-954"><a href="#cb57-954"></a><span class="co">[</span><span class="ot">package website</span><span class="co">](https://jessecambon.github.io/tidygeocoder/articles/geocoder_services.html)</span>.</span>
<span id="cb57-955"><a href="#cb57-955"></a></span>
<span id="cb57-956"><a href="#cb57-956"></a>To illustrate the geocoding process, we will find co-ordinates for the addresses</span>
<span id="cb57-957"><a href="#cb57-957"></a>in the object <span class="in">`addresses`</span>, which holds data for 10 sexual assaults in Chicago.</span>
<span id="cb57-958"><a href="#cb57-958"></a></span>
<span id="cb57-959"><a href="#cb57-959"></a><span class="in">```{r, echo=FALSE}</span></span>
<span id="cb57-960"><a href="#cb57-960"></a><span class="in">addresses |&gt; knitr::kable() |&gt; kableExtra::kable_styling(full_width = FALSE)</span></span>
<span id="cb57-961"><a href="#cb57-961"></a><span class="in">```</span></span>
<span id="cb57-962"><a href="#cb57-962"></a></span>
<span id="cb57-963"><a href="#cb57-963"></a>Since most geocoding services limit the number of addresses you can look up at</span>
<span id="cb57-964"><a href="#cb57-964"></a>a time, the first step in geocoding is removing duplicate addresses and rows </span>
<span id="cb57-965"><a href="#cb57-965"></a>with missing address values. This avoids us geocoding identical addresses </span>
<span id="cb57-966"><a href="#cb57-966"></a>several times, which would otherwise unnecessarily increase our chance of </span>
<span id="cb57-967"><a href="#cb57-967"></a>hitting the limit on geocoding queries each day.</span>
<span id="cb57-968"><a href="#cb57-968"></a></span>
<span id="cb57-969"><a href="#cb57-969"></a>We will also add the city and state to the end of each address, since at the </span>
<span id="cb57-970"><a href="#cb57-970"></a>moment (as with much data produced by local organisations) it includes only the </span>
<span id="cb57-971"><a href="#cb57-971"></a>building number and street.</span>
<span id="cb57-972"><a href="#cb57-972"></a></span>
<span id="cb57-973"><a href="#cb57-973"></a><span class="in">```{r geocoding-exercise1, exercise=TRUE}</span></span>
<span id="cb57-974"><a href="#cb57-974"></a><span class="in">addresses_for_geocoding &lt;- addresses |&gt; </span></span>
<span id="cb57-975"><a href="#cb57-975"></a><span class="in">  # Drop rows that have NA values in the `address` column</span></span>
<span id="cb57-976"><a href="#cb57-976"></a><span class="in">  drop_na(address) |&gt; </span></span>
<span id="cb57-977"><a href="#cb57-977"></a><span class="in">  # Add city and state then convert to upper case so that `count()` will not </span></span>
<span id="cb57-978"><a href="#cb57-978"></a><span class="in">  # treat identical addresses as different because of different cases, e.g. </span></span>
<span id="cb57-979"><a href="#cb57-979"></a><span class="in">  # 'ST' vs 'St' as abbreviations for 'Street'</span></span>
<span id="cb57-980"><a href="#cb57-980"></a><span class="in">  mutate(address = str_to_upper(str_glue("{address}, CHICAGO, IL"))) |&gt; </span></span>
<span id="cb57-981"><a href="#cb57-981"></a><span class="in">  # Select only the address column, since we won't send the other columns to the</span></span>
<span id="cb57-982"><a href="#cb57-982"></a><span class="in">  # geocoding function</span></span>
<span id="cb57-983"><a href="#cb57-983"></a><span class="in">  select(address) |&gt; </span></span>
<span id="cb57-984"><a href="#cb57-984"></a><span class="in">  # Find all the unique rows in the data</span></span>
<span id="cb57-985"><a href="#cb57-985"></a><span class="in">  distinct(address)</span></span>
<span id="cb57-986"><a href="#cb57-986"></a></span>
<span id="cb57-987"><a href="#cb57-987"></a><span class="in">head(addresses_for_geocoding)</span></span>
<span id="cb57-988"><a href="#cb57-988"></a><span class="in">```</span></span>
<span id="cb57-989"><a href="#cb57-989"></a></span>
<span id="cb57-990"><a href="#cb57-990"></a>Since two addresses in the data were duplicates and one address was missing, we</span>
<span id="cb57-991"><a href="#cb57-991"></a>now have eight unique addresses, stored in a tibble with a single column. We can</span>
<span id="cb57-992"><a href="#cb57-992"></a>use this as the input to the <span class="in">`geocode()`</span> function from the <span class="in">`tidygeocoder`</span></span>
<span id="cb57-993"><a href="#cb57-993"></a>package. The <span class="in">`address`</span> argument specifies which column in the data contains the</span>
<span id="cb57-994"><a href="#cb57-994"></a>addresses and the <span class="in">`method`</span> column specifies which geocoding service to use. In</span>
<span id="cb57-995"><a href="#cb57-995"></a>this case we use the Nominatim service (because it does not require registration </span>
<span id="cb57-996"><a href="#cb57-996"></a>and works worldwide). Nominatim is based on OpenStreetMap data, so can be chosen </span>
<span id="cb57-997"><a href="#cb57-997"></a>by specifying <span class="in">`method = "osm"`</span>.</span>
<span id="cb57-998"><a href="#cb57-998"></a></span>
<span id="cb57-999"><a href="#cb57-999"></a><span class="in">```{r geocoding-exercise2, exercise=TRUE}</span></span>
<span id="cb57-1000"><a href="#cb57-1000"></a><span class="in">library(tidygeocoder)</span></span>
<span id="cb57-1001"><a href="#cb57-1001"></a></span>
<span id="cb57-1002"><a href="#cb57-1002"></a><span class="in">addresses_geocoded &lt;- geocode(</span></span>
<span id="cb57-1003"><a href="#cb57-1003"></a><span class="in">  addresses_for_geocoding, </span></span>
<span id="cb57-1004"><a href="#cb57-1004"></a><span class="in">  address = "address", </span></span>
<span id="cb57-1005"><a href="#cb57-1005"></a><span class="in">  method = "osm"</span></span>
<span id="cb57-1006"><a href="#cb57-1006"></a><span class="in">)</span></span>
<span id="cb57-1007"><a href="#cb57-1007"></a></span>
<span id="cb57-1008"><a href="#cb57-1008"></a><span class="in">addresses_geocoded</span></span>
<span id="cb57-1009"><a href="#cb57-1009"></a><span class="in">```</span></span>
<span id="cb57-1010"><a href="#cb57-1010"></a></span>
<span id="cb57-1011"><a href="#cb57-1011"></a>Now that we have the latitude and longitude for each address, we can join that</span>
<span id="cb57-1012"><a href="#cb57-1012"></a>back to the original data using the address column to match the two datasets </span>
<span id="cb57-1013"><a href="#cb57-1013"></a>together. To do this we will create a temporary column in the original </span>
<span id="cb57-1014"><a href="#cb57-1014"></a><span class="in">`addresses`</span> object that matches the formatting changes we made to the original</span>
<span id="cb57-1015"><a href="#cb57-1015"></a>address.</span>
<span id="cb57-1016"><a href="#cb57-1016"></a></span>
<span id="cb57-1017"><a href="#cb57-1017"></a><span class="in">```{r geocoding-exercise3, exercise=TRUE}</span></span>
<span id="cb57-1018"><a href="#cb57-1018"></a><span class="in">addresses |&gt; </span></span>
<span id="cb57-1019"><a href="#cb57-1019"></a><span class="in">  # Create a temporary address column to use in matching the geocoded addresses</span></span>
<span id="cb57-1020"><a href="#cb57-1020"></a><span class="in">  mutate(temp_address = str_to_upper(str_glue("{address}, CHICAGO, IL"))) |&gt; </span></span>
<span id="cb57-1021"><a href="#cb57-1021"></a><span class="in">  # `left_join()` keeps all the rows in the left-hand dataset (the original</span></span>
<span id="cb57-1022"><a href="#cb57-1022"></a><span class="in">  # `addresses` object) and matching rows in the right-hand dataset (the </span></span>
<span id="cb57-1023"><a href="#cb57-1023"></a><span class="in">  # geocoding results)</span></span>
<span id="cb57-1024"><a href="#cb57-1024"></a><span class="in">  left_join(addresses_geocoded, by = c("temp_address" = "address")) |&gt; </span></span>
<span id="cb57-1025"><a href="#cb57-1025"></a><span class="in">  # Remove the temporary address column</span></span>
<span id="cb57-1026"><a href="#cb57-1026"></a><span class="in">  select(-temp_address)</span></span>
<span id="cb57-1027"><a href="#cb57-1027"></a><span class="in">```</span></span>
<span id="cb57-1028"><a href="#cb57-1028"></a></span>
<span id="cb57-1029"><a href="#cb57-1029"></a>We can now use this data as we would any other spatial data. We would often</span>
<span id="cb57-1030"><a href="#cb57-1030"></a>start by converting our new object to an SF object using <span class="in">`st_as_sf()`</span>. In that</span>
<span id="cb57-1031"><a href="#cb57-1031"></a>case, remember that all the geocoding services return co-ordinates as latitude</span>
<span id="cb57-1032"><a href="#cb57-1032"></a>and longitude using the WGS84 co-ordinate reference system, so you should use </span>
<span id="cb57-1033"><a href="#cb57-1033"></a>the EPSG code 4326.</span>
<span id="cb57-1034"><a href="#cb57-1034"></a></span>
<span id="cb57-1035"><a href="#cb57-1035"></a></span>
<span id="cb57-1036"><a href="#cb57-1036"></a><span class="fu">## Conflicts between function names</span></span>
<span id="cb57-1037"><a href="#cb57-1037"></a></span>
<span id="cb57-1038"><a href="#cb57-1038"></a>R packages are written by experts in different types of data analysis. This </span>
<span id="cb57-1039"><a href="#cb57-1039"></a>means we can use R to conduct all sorts of analysis, including cutting-edge</span>
<span id="cb57-1040"><a href="#cb57-1040"></a>techniques. But because R packages are not all written by people working for a</span>
<span id="cb57-1041"><a href="#cb57-1041"></a>single organisation, it means there can sometimes be functions from different</span>
<span id="cb57-1042"><a href="#cb57-1042"></a>packages that have the same name -- often because they do similar (but not</span>
<span id="cb57-1043"><a href="#cb57-1043"></a>necessarily identical) things. </span>
<span id="cb57-1044"><a href="#cb57-1044"></a></span>
<span id="cb57-1045"><a href="#cb57-1045"></a>This can be a problem because R might be running a function from one package</span>
<span id="cb57-1046"><a href="#cb57-1046"></a>when you think you have written code that uses a function from another package.</span>
<span id="cb57-1047"><a href="#cb57-1047"></a>If the two functions have different arguments or produce different types of </span>
<span id="cb57-1048"><a href="#cb57-1048"></a>result, your code is unlikely to run properly. For example, if two functions </span>
<span id="cb57-1049"><a href="#cb57-1049"></a>have the same name but one produces an SF object while the other produces a</span>
<span id="cb57-1050"><a href="#cb57-1050"></a>tibble, that might cause problems later in your code if you are using other </span>
<span id="cb57-1051"><a href="#cb57-1051"></a>functions that expect to receive a particular type of input.</span>
<span id="cb57-1052"><a href="#cb57-1052"></a></span>
<span id="cb57-1053"><a href="#cb57-1053"></a>One example of functions from two different packages with the same name is the</span>
<span id="cb57-1054"><a href="#cb57-1054"></a><span class="in">`geocode()`</span> function. We have already learned that the <span class="in">`tidygeocoder`</span> package</span>
<span id="cb57-1055"><a href="#cb57-1055"></a>contains a function called <span class="in">`geocode()`</span>, but the <span class="in">`ggmap`</span> package also has a </span>
<span id="cb57-1056"><a href="#cb57-1056"></a>function called <span class="in">`geocode()`</span>.</span>
<span id="cb57-1057"><a href="#cb57-1057"></a></span>
<span id="cb57-1058"><a href="#cb57-1058"></a>If both the <span class="in">`tidygeocoder`</span> and <span class="in">`ggmap`</span> packages are loaded, R will use the</span>
<span id="cb57-1059"><a href="#cb57-1059"></a><span class="in">`geocode()`</span> function _from the package that has been loaded most recently_. So </span>
<span id="cb57-1060"><a href="#cb57-1060"></a>if your script includes the code:</span>
<span id="cb57-1061"><a href="#cb57-1061"></a></span>
<span id="cb57-1062"><a href="#cb57-1062"></a><span class="in">```r</span></span>
<span id="cb57-1063"><a href="#cb57-1063"></a><span class="fu">library</span>(ggmap)</span>
<span id="cb57-1064"><a href="#cb57-1064"></a><span class="fu">library</span>(tidygeocoder)</span>
<span id="cb57-1065"><a href="#cb57-1065"></a></span>
<span id="cb57-1066"><a href="#cb57-1066"></a><span class="co"># [Code to load data, etc.]</span></span>
<span id="cb57-1067"><a href="#cb57-1067"></a></span>
<span id="cb57-1068"><a href="#cb57-1068"></a><span class="co"># Geocode some data</span></span>
<span id="cb57-1069"><a href="#cb57-1069"></a>geocoded_data <span class="ot">&lt;-</span> <span class="fu">geocode</span>(ungeocoded_data)</span>
<span id="cb57-1070"><a href="#cb57-1070"></a><span class="in">```</span></span>
<span id="cb57-1071"><a href="#cb57-1071"></a></span>
<span id="cb57-1072"><a href="#cb57-1072"></a>Then R will use the <span class="in">`geocode()`</span> function from <span class="in">`tidygeocoder`</span>, since that was</span>
<span id="cb57-1073"><a href="#cb57-1073"></a>loaded *after* <span class="in">`ggmap`</span>. But if you reverse the order in which these packages</span>
<span id="cb57-1074"><a href="#cb57-1074"></a>are loaded:</span>
<span id="cb57-1075"><a href="#cb57-1075"></a></span>
<span id="cb57-1076"><a href="#cb57-1076"></a><span class="in">```r</span></span>
<span id="cb57-1077"><a href="#cb57-1077"></a><span class="fu">library</span>(tidygeocoder)</span>
<span id="cb57-1078"><a href="#cb57-1078"></a><span class="fu">library</span>(ggmap)</span>
<span id="cb57-1079"><a href="#cb57-1079"></a></span>
<span id="cb57-1080"><a href="#cb57-1080"></a><span class="co"># [Code to load data, etc.]</span></span>
<span id="cb57-1081"><a href="#cb57-1081"></a></span>
<span id="cb57-1082"><a href="#cb57-1082"></a><span class="co"># Geocode some data</span></span>
<span id="cb57-1083"><a href="#cb57-1083"></a>geocoded_data <span class="ot">&lt;-</span> <span class="fu">geocode</span>(ungeocoded_data)</span>
<span id="cb57-1084"><a href="#cb57-1084"></a><span class="in">```</span></span>
<span id="cb57-1085"><a href="#cb57-1085"></a></span>
<span id="cb57-1086"><a href="#cb57-1086"></a>Then R will use the <span class="in">`geocode()`</span> function from <span class="in">`ggmap`</span> because that package was</span>
<span id="cb57-1087"><a href="#cb57-1087"></a>loaded after <span class="in">`tidygeocoder`</span>.</span>
<span id="cb57-1088"><a href="#cb57-1088"></a></span>
<span id="cb57-1089"><a href="#cb57-1089"></a>Knowing which of the two functions R uses when you type <span class="in">`geocode()`</span> is important</span>
<span id="cb57-1090"><a href="#cb57-1090"></a>because they accept different inputs. The <span class="in">`geocode()`</span> function from <span class="in">`ggmap`</span></span>
<span id="cb57-1091"><a href="#cb57-1091"></a>expects the first argument to contain a vector of addresses, while the </span>
<span id="cb57-1092"><a href="#cb57-1092"></a><span class="in">`geocode()`</span> function from <span class="in">`tidygeocoder`</span> expects a data frame or tibble. If</span>
<span id="cb57-1093"><a href="#cb57-1093"></a>you provide the wrong type of input, either function will produce an error.</span>
<span id="cb57-1094"><a href="#cb57-1094"></a></span>
<span id="cb57-1095"><a href="#cb57-1095"></a>When you load a package that includes a function with the same name as a </span>
<span id="cb57-1096"><a href="#cb57-1096"></a>function in a package that is already loaded, R will print a message in the</span>
<span id="cb57-1097"><a href="#cb57-1097"></a>console. For example, if you run <span class="in">`library(ggmap)`</span> and then</span>
<span id="cb57-1098"><a href="#cb57-1098"></a><span class="in">`library(tidygeocoder)`</span>, you will see a message saying the function from the</span>
<span id="cb57-1099"><a href="#cb57-1099"></a>already loaded package has been *masked* and so will be replaced by the function</span>
<span id="cb57-1100"><a href="#cb57-1100"></a>from the newly loaded package:</span>
<span id="cb57-1101"><a href="#cb57-1101"></a></span>
<span id="cb57-1102"><a href="#cb57-1102"></a><span class="in">```</span></span>
<span id="cb57-1103"><a href="#cb57-1103"></a><span class="in">Attaching package: ‘tidygeocoder’</span></span>
<span id="cb57-1104"><a href="#cb57-1104"></a></span>
<span id="cb57-1105"><a href="#cb57-1105"></a><span class="in">The following object is masked from ‘package:ggmap’:</span></span>
<span id="cb57-1106"><a href="#cb57-1106"></a></span>
<span id="cb57-1107"><a href="#cb57-1107"></a><span class="in">    geocode</span></span>
<span id="cb57-1108"><a href="#cb57-1108"></a><span class="in">```</span></span>
<span id="cb57-1109"><a href="#cb57-1109"></a></span>
<span id="cb57-1110"><a href="#cb57-1110"></a>When you see a message like this, it means you need to check which version of </span>
<span id="cb57-1111"><a href="#cb57-1111"></a>that function you want to use. If you want to use the function from the</span>
<span id="cb57-1112"><a href="#cb57-1112"></a>most-recently loaded package then you don't need to do anything. If you want to</span>
<span id="cb57-1113"><a href="#cb57-1113"></a>use the function that has been masked, you need to take one of the steps </span>
<span id="cb57-1114"><a href="#cb57-1114"></a>explained below.</span>
<span id="cb57-1115"><a href="#cb57-1115"></a></span>
<span id="cb57-1116"><a href="#cb57-1116"></a>Our R scripts very often load the <span class="in">`tidyverse`</span> package, which loads eight</span>
<span id="cb57-1117"><a href="#cb57-1117"></a>packages (<span class="in">`dplyr`</span>, <span class="in">`forcats`</span>, <span class="in">`ggplot2`</span>, <span class="in">`purrr`</span>, <span class="in">`readr`</span>, <span class="in">`tibble`</span>, <span class="in">`tidyr`</span> and</span>
<span id="cb57-1118"><a href="#cb57-1118"></a><span class="in">`stringr`</span>) that we often need to use. Because <span class="in">`tidyverse`</span> itself loads several</span>
<span id="cb57-1119"><a href="#cb57-1119"></a>packages, it produces a separate message to let you know which existing </span>
<span id="cb57-1120"><a href="#cb57-1120"></a>functions have been masked when you load <span class="in">`tidyverse`</span>. If <span class="in">`library(tidyverse)`</span> is</span>
<span id="cb57-1121"><a href="#cb57-1121"></a>the first code you run after starting R, that message will look something like </span>
<span id="cb57-1122"><a href="#cb57-1122"></a>this:</span>
<span id="cb57-1123"><a href="#cb57-1123"></a></span>
<span id="cb57-1124"><a href="#cb57-1124"></a><span class="in">```</span></span>
<span id="cb57-1125"><a href="#cb57-1125"></a><span class="in">── Conflicts ──────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span id="cb57-1126"><a href="#cb57-1126"></a><span class="in">x dplyr::filter() masks stats::filter()</span></span>
<span id="cb57-1127"><a href="#cb57-1127"></a><span class="in">x dplyr::lag()    masks stats::lag()</span></span>
<span id="cb57-1128"><a href="#cb57-1128"></a><span class="in">```</span></span>
<span id="cb57-1129"><a href="#cb57-1129"></a></span>
<span id="cb57-1130"><a href="#cb57-1130"></a>Since we more commonly want the tidyverse functions than the functions they mask</span>
<span id="cb57-1131"><a href="#cb57-1131"></a>(for example, we frequently use the <span class="in">`filter()`</span> function from <span class="in">`dplyr`</span> but rarely</span>
<span id="cb57-1132"><a href="#cb57-1132"></a>use the function with the same name in the <span class="in">`stats`</span> package), it is common to</span>
<span id="cb57-1133"><a href="#cb57-1133"></a>load <span class="in">`tidyverse`</span> after loading all the other packages needed for our code.</span>
<span id="cb57-1134"><a href="#cb57-1134"></a></span>
<span id="cb57-1135"><a href="#cb57-1135"></a>There are several ways you can resolve conflicts between functions from</span>
<span id="cb57-1136"><a href="#cb57-1136"></a>different packages:</span>
<span id="cb57-1137"><a href="#cb57-1137"></a></span>
<span id="cb57-1138"><a href="#cb57-1138"></a><span class="ss">  * </span>Make sure you load packages in the order that gives you access to the</span>
<span id="cb57-1139"><a href="#cb57-1139"></a>    functions you need. This can be simple if there are few conflicts, but can</span>
<span id="cb57-1140"><a href="#cb57-1140"></a>    fall apart if you later change your code to load different packages. This is</span>
<span id="cb57-1141"><a href="#cb57-1141"></a>    the option that almost everyone uses most of the time (and most people use</span>
<span id="cb57-1142"><a href="#cb57-1142"></a>    all of the time).</span>
<span id="cb57-1143"><a href="#cb57-1143"></a><span class="ss">  * </span>Specify which function you want to use using the <span class="in">`::`</span> notation that we have</span>
<span id="cb57-1144"><a href="#cb57-1144"></a>    already used in previous tutorials, e.g. by using the code</span>
<span id="cb57-1145"><a href="#cb57-1145"></a>    <span class="in">`ggmap::geocode()`</span> or <span class="in">`tidygeocoder::geocode()`</span>.</span>
<span id="cb57-1146"><a href="#cb57-1146"></a><span class="ss">  * </span>Load the <span class="in">`conflicted`</span> package, which produces an error whenever you try to</span>
<span id="cb57-1147"><a href="#cb57-1147"></a>    use a function that is included in more than one loaded package. This makes</span>
<span id="cb57-1148"><a href="#cb57-1148"></a>    it easy to know when there is a potential conflict, which you can then </span>
<span id="cb57-1149"><a href="#cb57-1149"></a>    resolve using the <span class="in">`conflict_prefer()`</span> function.</span>
<span id="cb57-1150"><a href="#cb57-1150"></a>    </span>
<span id="cb57-1151"><a href="#cb57-1151"></a>In this final option, the authors of the <span class="in">`conflicted`</span> package recommend that you</span>
<span id="cb57-1152"><a href="#cb57-1152"></a>specify which conflict-prone functions to use by calling <span class="in">`conflict_prefer()`</span></span>
<span id="cb57-1153"><a href="#cb57-1153"></a>just after you've loaded all the packages you need for your script. For example:</span>
<span id="cb57-1154"><a href="#cb57-1154"></a></span>
<span id="cb57-1155"><a href="#cb57-1155"></a><span class="in">```r</span></span>
<span id="cb57-1156"><a href="#cb57-1156"></a><span class="co"># This code produces several conflicts:</span></span>
<span id="cb57-1157"><a href="#cb57-1157"></a><span class="co"># *  the `stats` package, which is loaded automatically in the background when </span></span>
<span id="cb57-1158"><a href="#cb57-1158"></a><span class="co">#    you start R, contains a function called `filter()`</span></span>
<span id="cb57-1159"><a href="#cb57-1159"></a><span class="co"># *  `MASS` contains a function called `select()`</span></span>
<span id="cb57-1160"><a href="#cb57-1160"></a><span class="co"># *  `dplyr` contains functions called `filter()` and `select()`</span></span>
<span id="cb57-1161"><a href="#cb57-1161"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb57-1162"><a href="#cb57-1162"></a><span class="fu">library</span>(MASS)</span>
<span id="cb57-1163"><a href="#cb57-1163"></a><span class="fu">library</span>(conflicted)</span>
<span id="cb57-1164"><a href="#cb57-1164"></a></span>
<span id="cb57-1165"><a href="#cb57-1165"></a><span class="co"># This code specifies that in the case of both conflicts, we want to use the</span></span>
<span id="cb57-1166"><a href="#cb57-1166"></a><span class="co"># functions from `dplyr`</span></span>
<span id="cb57-1167"><a href="#cb57-1167"></a><span class="fu">conflict_prefer</span>(<span class="st">"select"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb57-1168"><a href="#cb57-1168"></a><span class="fu">conflict_prefer</span>(<span class="st">"filter"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb57-1169"><a href="#cb57-1169"></a></span>
<span id="cb57-1170"><a href="#cb57-1170"></a><span class="co"># In the rest of this script, any reference to `filter()` or `select()` will</span></span>
<span id="cb57-1171"><a href="#cb57-1171"></a><span class="co"># use the functions with those names in the `dplyr` package, not those from</span></span>
<span id="cb57-1172"><a href="#cb57-1172"></a><span class="co"># `stats` or `MASS`</span></span>
<span id="cb57-1173"><a href="#cb57-1173"></a><span class="in">```</span></span>
<span id="cb57-1174"><a href="#cb57-1174"></a></span>
<span id="cb57-1175"><a href="#cb57-1175"></a>Understanding function-name conflicts is important because they can be the cause</span>
<span id="cb57-1176"><a href="#cb57-1176"></a>of errors that are (for reasons we needn't explain in detail) extremely hard to </span>
<span id="cb57-1177"><a href="#cb57-1177"></a>track down the cause of. So make sure that when you load packages, you take note</span>
<span id="cb57-1178"><a href="#cb57-1178"></a>of any messages in the console that warn you that functions have been masked. As</span>
<span id="cb57-1179"><a href="#cb57-1179"></a>with other messages in R, they will not always need you to take any action, but</span>
<span id="cb57-1180"><a href="#cb57-1180"></a>you always need to read the message and make a decision about whether to take </span>
<span id="cb57-1181"><a href="#cb57-1181"></a>any action.</span>
<span id="cb57-1182"><a href="#cb57-1182"></a></span>
<span id="cb57-1183"><a href="#cb57-1183"></a></span>
<span id="cb57-1184"><a href="#cb57-1184"></a></span>
<span id="cb57-1185"><a href="#cb57-1185"></a><span class="fu">#### Check your understanding {.tutorial}</span></span>
<span id="cb57-1186"><a href="#cb57-1186"></a></span>
<span id="cb57-1187"><a href="#cb57-1187"></a><span class="in">```{r conflict-quiz}</span></span>
<span id="cb57-1188"><a href="#cb57-1188"></a><span class="in">question(</span></span>
<span id="cb57-1189"><a href="#cb57-1189"></a><span class="in">  "If you load two packages in R that both contain a function with the same name, which function will R use by default?",</span></span>
<span id="cb57-1190"><a href="#cb57-1190"></a><span class="in">  answer("The function from the package that was loaded *last*", correct = TRUE),</span></span>
<span id="cb57-1191"><a href="#cb57-1191"></a><span class="in">  answer("The function from the package that was loaded *first*"),</span></span>
<span id="cb57-1192"><a href="#cb57-1192"></a><span class="in">  answer("Neither function will run because R will produce an error."),</span></span>
<span id="cb57-1193"><a href="#cb57-1193"></a><span class="in">  answer("The function that is from the `tidyverse` suite of packages."),</span></span>
<span id="cb57-1194"><a href="#cb57-1194"></a><span class="in">  correct = random_praise(),</span></span>
<span id="cb57-1195"><a href="#cb57-1195"></a><span class="in">  incorrect = random_encouragement(),</span></span>
<span id="cb57-1196"><a href="#cb57-1196"></a><span class="in">  allow_retry = TRUE,</span></span>
<span id="cb57-1197"><a href="#cb57-1197"></a><span class="in">  random_answer_order = TRUE</span></span>
<span id="cb57-1198"><a href="#cb57-1198"></a><span class="in">)</span></span>
<span id="cb57-1199"><a href="#cb57-1199"></a><span class="in">```</span></span>
<span id="cb57-1200"><a href="#cb57-1200"></a></span>
<span id="cb57-1201"><a href="#cb57-1201"></a></span>
<span id="cb57-1202"><a href="#cb57-1202"></a></span>
<span id="cb57-1203"><a href="#cb57-1203"></a></span>
<span id="cb57-1204"><a href="#cb57-1204"></a><span class="fu">## In summary</span></span>
<span id="cb57-1205"><a href="#cb57-1205"></a></span>
<span id="cb57-1206"><a href="#cb57-1206"></a>::: {.box .welldone}</span>
<span id="cb57-1207"><a href="#cb57-1207"></a></span>
<span id="cb57-1208"><a href="#cb57-1208"></a>In this tutorial we have learned to tidy messy data to make it easier to work</span>
<span id="cb57-1209"><a href="#cb57-1209"></a>with. In real-world data analysis (not just crime mapping), you will often have</span>
<span id="cb57-1210"><a href="#cb57-1210"></a>to deal with data that is messy in different ways. Fortunately, you can use R to</span>
<span id="cb57-1211"><a href="#cb57-1211"></a>fix all of these problems in a way that minimises the risk that you might </span>
<span id="cb57-1212"><a href="#cb57-1212"></a>introduce mistakes when you clean the data.</span>
<span id="cb57-1213"><a href="#cb57-1213"></a></span>
<span id="cb57-1214"><a href="#cb57-1214"></a>:::</span>
<span id="cb57-1215"><a href="#cb57-1215"></a></span>
<span id="cb57-1216"><a href="#cb57-1216"></a></span>
<span id="cb57-1217"><a href="#cb57-1217"></a>::: {.box .reading}</span>
<span id="cb57-1218"><a href="#cb57-1218"></a></span>
<span id="cb57-1219"><a href="#cb57-1219"></a>You can find out more about data cleaning and tidying with these </span>
<span id="cb57-1220"><a href="#cb57-1220"></a>resources:</span>
<span id="cb57-1221"><a href="#cb57-1221"></a></span>
<span id="cb57-1222"><a href="#cb57-1222"></a><span class="ss">  * </span>A [tutorial on using the <span class="in">`pivot_longer()`</span> and <span class="in">`pivot_wider()`</span> functions to </span>
<span id="cb57-1223"><a href="#cb57-1223"></a>    convert data between long and wide format](https://tidyr.tidyverse.org/articles/pivot.html).</span>
<span id="cb57-1224"><a href="#cb57-1224"></a><span class="ss">  * </span>A more-detailed <span class="co">[</span><span class="ot">Introduction to `tidygeocoder`</span><span class="co">](https://jessecambon.github.io/tidygeocoder/articles/tidygeocoder.html)</span>.</span>
<span id="cb57-1225"><a href="#cb57-1225"></a><span class="ss">  * </span>An <span class="co">[</span><span class="ot">introduction to some other packages than can help you clean and tidy data</span><span class="co">](https://rfortherestofus.com/2019/12/how-to-clean-messy-data-in-r/)</span>.</span>
<span id="cb57-1226"><a href="#cb57-1226"></a><span class="ss">  * </span>A more-detailed <span class="co">[</span><span class="ot">description of how to use the `conflicted` package</span><span class="co">](https://conflicted.r-lib.org/)</span>.</span>
<span id="cb57-1227"><a href="#cb57-1227"></a></span>
<span id="cb57-1228"><a href="#cb57-1228"></a>:::</span>
<span id="cb57-1229"><a href="#cb57-1229"></a></span>
<span id="cb57-1230"><a href="#cb57-1230"></a><span class="in">    </span></span>
<span id="cb57-1231"><a href="#cb57-1231"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/tidydata_7.jpg" alt="Cartoon saying make friends with tidy data!"&gt;&lt;/p&gt;</span>
<span id="cb57-1232"><a href="#cb57-1232"></a></span>
<span id="cb57-1233"><a href="#cb57-1233"></a>&lt;p class="credits"&gt;&lt;a href="https://twitter.com/allison_horst"&gt;Artwork by @allison_horst&lt;/a&gt;&lt;/p&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by/4.0/">
<p>This book is available under a Creative Commons Attribution 4.0 International licence</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>