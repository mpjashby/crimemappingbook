<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>12&nbsp; Handling messy data – Learn Crime Mapping with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../13_crime_series/index.html" rel="next">
<link href="../11_mapping_hotspots/index.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-854d42f42d0f6b455b86ad16a464e311.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<!-- START OF INCLUDED HEADER -->

<!--
This file contains code that will be included in the header of each page of the
quarto book
-->

<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>

<!-- END OF INCLUDED HEADER -->
<script src="../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../include/webex.css">
<meta name="twitter:title" content="12&nbsp; Handling messy data – Learn Crime Mapping with R">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="../images/cover_image.png">
<meta name="twitter:image:alt" content="">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../12_messy_data/index.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/cover_image.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Learn Crime Mapping with R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mpjashby/crimemappingbook/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install the software needed for this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_getting_started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_your_first_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Your first crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_data_wrangling/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_your_second_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Your second crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_code_with_style/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Code with style</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_mapping_crime_patterns/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping crime patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_map_context/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Giving a map context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_handling_bugs/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Handling bugs in your code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_mapping_areas/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Mapping area data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../10_place_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../11_mapping_hotspots/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../12_messy_data/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../13_crime_series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Mapping crime series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../14_writing_reports/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Writing reports in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../15_no_maps/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Presenting spatial data without maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../16_mapping_time/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Mapping crime over time</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/read_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Functions for reading data into R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/map_checklist.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Checklist: Making a good crime map</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/common_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Common R errors and how to fix them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/functions_to_avoid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Some R functions you should avoid</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/handling_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Checklist: handling code errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">In this chapter</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">12.1</span> Introduction</a></li>
  <li><a href="#tidying-the-structure-of-data" id="toc-tidying-the-structure-of-data" class="nav-link" data-scroll-target="#tidying-the-structure-of-data"><span class="header-section-number">12.2</span> Tidying the structure of data</a>
  <ul class="collapse">
  <li><a href="#skipping-unwanted-rows-in-imported-data" id="toc-skipping-unwanted-rows-in-imported-data" class="nav-link" data-scroll-target="#skipping-unwanted-rows-in-imported-data"><span class="header-section-number">12.2.1</span> Skipping unwanted rows in imported data</a></li>
  <li><a href="#separating-multiple-variables-stored-in-a-single-column" id="toc-separating-multiple-variables-stored-in-a-single-column" class="nav-link" data-scroll-target="#separating-multiple-variables-stored-in-a-single-column"><span class="header-section-number">12.2.2</span> Separating multiple variables stored in a single column</a></li>
  </ul></li>
  <li><a href="#tidying-the-content-of-cells" id="toc-tidying-the-content-of-cells" class="nav-link" data-scroll-target="#tidying-the-content-of-cells"><span class="header-section-number">12.3</span> Tidying the content of cells</a>
  <ul class="collapse">
  <li><a href="#converting-between-types-of-variable" id="toc-converting-between-types-of-variable" class="nav-link" data-scroll-target="#converting-between-types-of-variable"><span class="header-section-number">12.3.1</span> Converting between types of variable</a></li>
  <li><a href="#recoding-categorical-variables" id="toc-recoding-categorical-variables" class="nav-link" data-scroll-target="#recoding-categorical-variables"><span class="header-section-number">12.3.2</span> Recoding categorical variables</a></li>
  <li><a href="#missing-values" id="toc-missing-values" class="nav-link" data-scroll-target="#missing-values"><span class="header-section-number">12.3.3</span> Missing values</a></li>
  <li><a href="#sec-null-island" id="toc-sec-null-island" class="nav-link" data-scroll-target="#sec-null-island"><span class="header-section-number">12.3.4</span> Null Island</a></li>
  </ul></li>
  <li><a href="#geocoding-locations" id="toc-geocoding-locations" class="nav-link" data-scroll-target="#geocoding-locations"><span class="header-section-number">12.4</span> Geocoding locations</a></li>
  <li><a href="#conflicts-between-function-names" id="toc-conflicts-between-function-names" class="nav-link" data-scroll-target="#conflicts-between-function-names"><span class="header-section-number">12.5</span> Conflicts between function names</a></li>
  <li><a href="#in-summary" id="toc-in-summary" class="nav-link" data-scroll-target="#in-summary"><span class="header-section-number">12.6</span> In summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-messy-data" class="quarto-section-identifier"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="abstract">
<p>Data is at the core of crime mapping, but it is not always provided in a clean and structured format. This chapter introduces the challenges of working with messy data and provides practical techniques to tidy and prepare datasets for analysis in R. Topics covered include restructuring data, dealing with missing values, separating and merging variables, and resolving inconsistencies. By learning these skills, you will be able to transform raw crime data into a format suitable for mapping and other analysis.</p>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Before you start
</div>
</div>
<div class="callout-body-container callout-body">
<p>Open RStudio or – if you already have RStudio open – click <code>Session</code> then <code>Restart R</code>. Make sure you’re working inside the Crime Mapping RStudio project you created in <a href="../01_getting_started/index.html#sec-create-project" class="quarto-xref"><span>Section 1.4.2</span></a>, then you’re ready to start mapping.</p>
</div>
</div>
<section id="introduction" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">12.1</span> Introduction</h2>
<p>Data is the foundation of everything we do in crime mapping. To make a crime map needs data on the locations and types of crimes; data on roads, buildings and natural features to make up a base map, and data on other features (such as particular types of facility) that might be relevant to why crime happens in particular place.</p>
<p class="full-width-image">
<img src="../images/tidydata_1.jpg" alt="Cartoon explaining that tidy data is a standard way of mapping the meaning of a dataset to its structure. In tidy data each variable forms a column, each observation forms a row and each cell is a single measurement.">
</p>
<p>Until now, all the data we have used has been <em>tidy data</em>. Data is tidy if it comes in a particular format where every <em>variable</em> (e.g.&nbsp;the date on which a crime occurred) is stored in a separate <em>column</em> and data for every <em>observation</em> (e.g.&nbsp;all the data about a particular crime, a particular offender etc.) is stored in a separate <em>row</em>. For typical crime data, that means each crime is represented by one row in the data and each thing that we know about that crime is stored in a separate column.</p>
<p>Unfortunately, not all the data we might like to use in crime mapping is available in a tidy format. The people, organisations and systems and produce data store it in many formats, which are often not tidy and not easy to analyse. Messy data is more difficult to work with because every messy dataset has a unique structure, which we have to remember every time we want to work with it.</p>
<p>Tidy data, on the other hand, is easier to work with because its format is familiar and consistent. Many R functions are also designed to work with tidy data, so tidying our datasets often makes analysis quicker, too.</p>
<p>The first step to analysing messy data is therefore to wrangle it into a tidy format. We have already seen this principle at work when we use the <code>clean_names()</code> function from the janitor package to convert column names into a consistent format so that we don’t have to keep remembering which unique format the column names are in.</p>
<p>In this chapter we will learn how to tidy messy data to make it easier to work with. To do that, we will create a series of ‘toy’ datasets we can work with. To do this we will use the <code>tibble()</code> and <code>tribble()</code> functions from the tibble package, which is part of the tidyverse.</p>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tidy data
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Why is tidy data preferred for analysis in R?</strong></p>
<div id="radio_HNOTEVQFOC" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_HNOTEVQFOC" value=""> <span>It minimizes the number of columns in a dataset</span></label><label><input type="radio" autocomplete="off" name="radio_HNOTEVQFOC" value=""> <span>It ensures all data is stored as character strings</span></label><label><input type="radio" autocomplete="off" name="radio_HNOTEVQFOC" value="answer"> <span>It follows a consistent structure that makes analysis easier</span></label><label><input type="radio" autocomplete="off" name="radio_HNOTEVQFOC" value=""> <span>It eliminates the need for data wrangling</span></label>
</div>
<p><strong>What is a characteristic of tidy data?</strong></p>
<div id="radio_HYVXOGAZIP" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_HYVXOGAZIP" value=""> <span>Each column contains multiple variables</span></label><label><input type="radio" autocomplete="off" name="radio_HYVXOGAZIP" value="answer"> <span>Each row represents a single observation</span></label><label><input type="radio" autocomplete="off" name="radio_HYVXOGAZIP" value=""> <span>Column names are always numeric</span></label><label><input type="radio" autocomplete="off" name="radio_HYVXOGAZIP" value=""> <span>The data must be stored in alphabetical order</span></label>
</div>
<p><strong>Why might a dataset be messy when obtained from an external source?</strong></p>
<div id="radio_TYMGOHDVWP" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_TYMGOHDVWP" value="answer"> <span>Data producers often structure it for human readability rather than analysis</span></label><label><input type="radio" autocomplete="off" name="radio_TYMGOHDVWP" value=""> <span>All government datasets are always tidy by default</span></label><label><input type="radio" autocomplete="off" name="radio_TYMGOHDVWP" value=""> <span>R requires data to be stored in JSON format</span></label><label><input type="radio" autocomplete="off" name="radio_TYMGOHDVWP" value=""> <span>Messy data is a requirement for proper statistical analysis</span></label>
</div>
</div>
</div>
</section>
<section id="tidying-the-structure-of-data" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="tidying-the-structure-of-data"><span class="header-section-number">12.2</span> Tidying the structure of data</h2>
<p class="full-width-image">
<img src="../images/tidydata_2.jpg" alt="Cartoon explaining that the standard structure of tidy data means that all tidy datasets are alike but every messy dataset is messy in its own way.">
</p>
<p>Every messy dataset is messy in its own unique way, but often messiness comes from the structure of data not being tidy. Tabular data can come in two general formats: <em>long</em> and <em>wide</em>. For example, imagine a dataset showing counts of several different types of crime in several different areas. We could store this data in wide format, where there is a column for the name of the area and then a column for each type of crime.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">area</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">assault</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">robbery</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">burglary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Northville</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">Middletown</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Southam</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">10</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Wide-format data are often useful for presentation – you might often see a table like this in a report or article. But wide data are less useful for analysis because one of the variables – ‘type of crime’ – is being stored not as a variable but in the various column names. One sign that your data has this problem is if several of the columns form a group of columns, separate from the others. In this case, there is a group of columns that show crime counts that is different from the other column that shows the area name.</p>
<p>Fortunately, we can easily convert this data (which is stored in the object <code>crime_counts</code>) into long format using the <code>pivot_longer()</code> function from the <code>tidyr</code> package. To use <code>pivot_longer()</code>, we have to specify in the <code>cols</code> argument which columns we want to ‘gather’ together into one column to store the category names and one column to store the values. We can specify the columns we want to gather as a vector, i.e.&nbsp;<code>c(assault, burglary, robbery)</code>.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Load packages</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(janitor, readxl, sf, tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># Create a dataset of crime counts in 'wide' format</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>crime_counts <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="sc">~</span>area, <span class="sc">~</span>assault, <span class="sc">~</span>robbery, <span class="sc">~</span>burglary,</span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="st">"Northville"</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">10</span>,</span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="st">"Middletown"</span>, <span class="dv">6</span>, <span class="dv">5</span>, <span class="dv">20</span>,</span>
<span id="cb1-9"><a href="#cb1-9"></a>  <span class="st">"Southam"</span>, <span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">10</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>)</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co"># Convert the dataset to 'long' format</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="fu">pivot_longer</span>(crime_counts, <span class="at">cols =</span> <span class="fu">c</span>(assault, burglary, robbery))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 9 × 3
  area       name     value
  &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt;
1 Northville assault      4
2 Northville burglary    10
3 Northville robbery      2
4 Middletown assault      6
5 Middletown burglary    20
6 Middletown robbery      5
7 Southam    assault     10
8 Southam    burglary    10
9 Southam    robbery      0</code></pre>
</div>
</div>
<p>By default, <code>pivot_longer()</code> calls the new column of category names <code>name</code> and the new column of values <code>value</code>. We can specify more-descriptive names using the <code>names_to</code> and <code>values_to</code> arguments.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Convert dataset to 'long' format with custom column names</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">pivot_longer</span>(</span>
<span id="cb3-3"><a href="#cb3-3"></a>  crime_counts, </span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="at">cols =</span> <span class="fu">c</span>(assault, burglary, robbery), </span>
<span id="cb3-5"><a href="#cb3-5"></a>  <span class="at">names_to =</span> <span class="st">"type"</span>, </span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="at">values_to =</span> <span class="st">"count"</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 9 × 3
  area       type     count
  &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt;
1 Northville assault      4
2 Northville burglary    10
3 Northville robbery      2
4 Middletown assault      6
5 Middletown burglary    20
6 Middletown robbery      5
7 Southam    assault     10
8 Southam    burglary    10
9 Southam    robbery      0</code></pre>
</div>
</div>
<p>It is better to have the names of different categories stored as a single variable rather than as the names of several variables because they are easier to work with that way. For example, if the data are in long format you could sort the categories alphabetically using <code>arrange(crime_counts, type)</code>, or you could transform the names to title case using <code>mutate(crime_counts, type = str_to_title(type))</code>. Both these operations would be harder to do if the data were in wide format.</p>
<p>A common reason for data to be stored in wide format is where repeated observations are made of some value over time. For example, we might have monthly counts of crimes for different areas.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">area</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">jan_2020</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">feb_2020</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mar_2020</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">apr_2020</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">may_2020</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Northville</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">Middletown</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Southam</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">14</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Storing data in this way is particularly awkward because variable names can only contain text, so R does not know that the column names represent dates. This means, for example, that we could not filter the dataset to only include data from after a certain date.</p>
<p>When we want to gather a large number of columns together, it can get tedious to type all the column names for the <code>cols</code> argument to <code>pivot_longer()</code>. Instead, since we want to gather all the columns except one, we can just specify that we should <em>not</em> gather the <code>area</code> column, which implicitly tells <code>pivot_longer()</code> to gather all the other columns. We tell <code>pivot_longer()</code> not to gather the area column by specifying <code>cols = -area</code> (note the minus sign in front of the column name).</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb5" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Create a dataset of monthly crime counts in wide format</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>monthly_counts <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="sc">~</span>area, <span class="sc">~</span>jan_2020, <span class="sc">~</span>feb_2020, <span class="sc">~</span>mar_2020, <span class="sc">~</span>apr_2020, <span class="sc">~</span>may_2020,</span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="st">"Northville"</span>, <span class="dv">13</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">9</span>, <span class="dv">10</span>,</span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="st">"Middletown"</span>, <span class="dv">21</span>, <span class="dv">19</span>, <span class="dv">22</span>, <span class="dv">19</span>, <span class="dv">20</span>,</span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="st">"Southam"</span>, <span class="dv">15</span>, <span class="dv">13</span>, <span class="dv">16</span>, <span class="dv">15</span>, <span class="dv">14</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>)</span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co"># Convert dataset to 'long' format with custom column names</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="fu">pivot_longer</span>(</span>
<span id="cb5-11"><a href="#cb5-11"></a>  monthly_counts, </span>
<span id="cb5-12"><a href="#cb5-12"></a>  <span class="at">cols =</span> <span class="sc">-</span>area, </span>
<span id="cb5-13"><a href="#cb5-13"></a>  <span class="at">names_to =</span> <span class="st">"month"</span>, </span>
<span id="cb5-14"><a href="#cb5-14"></a>  <span class="at">values_to =</span> <span class="st">"count"</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 15 × 3
   area       month    count
   &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt;
 1 Northville jan_2020    13
 2 Northville feb_2020    10
 3 Northville mar_2020    12
 4 Northville apr_2020     9
 5 Northville may_2020    10
 6 Middletown jan_2020    21
 7 Middletown feb_2020    19
 8 Middletown mar_2020    22
 9 Middletown apr_2020    19
10 Middletown may_2020    20
11 Southam    jan_2020    15
12 Southam    feb_2020    13
13 Southam    mar_2020    16
14 Southam    apr_2020    15
15 Southam    may_2020    14</code></pre>
</div>
</div>
<p>There is still a problem with this data, which is that the <code>month</code> variable contains not date values but instead the month and year stored as text. We will learn how to deal with that issue in <a href="../16_mapping_time/index.html" class="quarto-xref"><span>Chapter 16</span></a>.</p>
<section id="skipping-unwanted-rows-in-imported-data" class="level3" data-number="12.2.1">
<h3 data-number="12.2.1" class="anchored" data-anchor-id="skipping-unwanted-rows-in-imported-data"><span class="header-section-number">12.2.1</span> Skipping unwanted rows in imported data</h3>
<p>Data released by government organisations are often designed to be viewed by humans rather than processed by statistical software. We can see this in this screen shot of a <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/crimeandjustice/datasets/crimeinenglandandwalesexperimentaltables">dataset produced by the UK Office for National Statistics on cybercrime in the UK</a> based on responses to the Crime Survey for England and Wales.</p>
<p class="full-width-image">
<img src="../images/ons_data1.png" alt="Screen shot of an Excel sheet of data from the UK Office for National Statistics, showing that there are multiple header rows above the data and blank rows within the data.">
</p>
<p>Looking at the row numbers on the left-hand side, we can see that the that the first row is taken up not with the column names (as in a tidy dataset) but with the title of the dataset. The next row is blank, and the third row then contains some metadata to say that the data relates to England and Wales and to adults aged 16 and over. Only on row four do we see the column names. There are also blank rows within the data that are used to separate out different categories of data.</p>
<p>If we try to import this data using, for example, the <code>read_excel()</code> function from the <code>readxl</code> package, we will find various problems.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># Since `.xlsx` files are binary files, we need to add `mode = "wb"` on Windows.</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co"># On other platforms it makes no difference, but adding `mode = "wb" does not</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co"># cause any problems.</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="fu">download.file</span>(</span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="at">url =</span> <span class="st">"https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/crimeandjustice/datasets/crimeinenglandandwalesexperimentaltables/yearendingdecember2018/additionalfraudandcybercrimetablesyearendingdecember2018correction.xlsx"</span>,</span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="at">destfile =</span> <span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>),</span>
<span id="cb7-7"><a href="#cb7-7"></a>  <span class="at">mode =</span> <span class="st">"wb"</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>)</span>
<span id="cb7-9"><a href="#cb7-9"></a></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="fu">read_excel</span>(<span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>), <span class="at">sheet =</span> <span class="st">"Table E1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>New names:
• `` -&gt; `...2`
• `` -&gt; `...3`
• `` -&gt; `...4`
• `` -&gt; `...5`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 46 × 5
   Table E1:  Fraud and computer misuse by loss (of mo…¹ ...2  ...3  ...4  ...5 
   &lt;chr&gt;                                                 &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
 1 &lt;NA&gt;                                                  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 2 England and Wales                                     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  Adul…
 3 Offence group3                                        Numb… Rate… Numb… Perc…
 4 &lt;NA&gt;                                                  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 5 FRAUD5                                                3648  78.0… 3078  6.58…
 6 &lt;NA&gt;                                                  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 7 With loss, no or only partial reimbursement           660   14.1… 613   1.31…
 8 With loss, fully reimbursed                           2066  44.2… 1765  3.77…
 9 Without loss                                          922   19.7… 804   1.72…
10 &lt;NA&gt;                                                  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
# ℹ 36 more rows
# ℹ abbreviated name:
#   ¹​`Table E1:  Fraud and computer misuse by loss (of money or property) - number and rate of incidents and number and percentage of victims, year ending December 2018 CSEW1,2`</code></pre>
</div>
</div>
<p>It’s clear that this dataset has not loaded in the way that we want, because the first row doesn’t contain the column names. Fortunately, we can deal with this problem using the <code>skip</code> argument to the <code>read_excel()</code> function. This allows us to specify a number of rows to ignore at the start of the dataset. In this case, we want to ignore the first three rows of the data (the table title, a blank line and the the metadata line), so we can specify <code>skip = 3</code>. The same <code>skip</code> argument also exists in the <code>read_csv()</code> function for reading CSV data and the <code>read_tsv()</code> function for reading tab-separated data.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb10" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">read_excel</span>(</span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>), </span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="at">sheet =</span> <span class="st">"Table E1"</span>, </span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="at">skip =</span> <span class="dv">3</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 43 × 5
   `Offence group3`                Number of incidents …¹ Rate per 1,000 adult…²
   &lt;chr&gt;                                            &lt;dbl&gt;                  &lt;dbl&gt;
 1 &lt;NA&gt;                                                NA                  NA   
 2 FRAUD5                                            3648                  78.0 
 3 &lt;NA&gt;                                                NA                  NA   
 4 With loss, no or only partial …                    660                  14.1 
 5 With loss, fully reimbursed                       2066                  44.2 
 6 Without loss                                       922                  19.7 
 7 &lt;NA&gt;                                                NA                  NA   
 8 Bank and credit account fraud                     2433                  52.0 
 9 With loss, no or only partial …                    235                   5.03
10 With loss, fully reimbursed                       1727                  36.9 
# ℹ 33 more rows
# ℹ abbreviated names: ¹​`Number of incidents (thousands)`,
#   ²​`Rate per 1,000 adults`
# ℹ 2 more variables: `Number of victims (thousands)4` &lt;dbl&gt;,
#   `Percentage victims once or more4` &lt;dbl&gt;</code></pre>
</div>
</div>
<p>This has dealt with the problem caused by the extra rows at the top of the data. But if we look at the bottom of the dataset, we will see that there are also several rows of footnotes. These footnotes are important for us to have read so that we understand the data, but they aren’t part of the data itself.</p>
<p class="full-width-image">
<img src="../images/ons_data2.png" alt="Screen shot of an Excel sheet of data from the UK Office for National Statistics, showing that there are multiple footer rows below the data.">
</p>
<p>We can remove these extra rows at the end of our data using the <code>slice()</code> function from the <code>dplyr</code> package. <code>slice()</code> allows us to choose certain rows from our data by row number. Looking at the screen shot above, our data finishes on row 34 (row 36 looks like part of our data but the value there actually shows the number of people involved in the survey, not a number of incidents). But:</p>
<ul>
<li>we have already removed the first three rows using the <code>skip</code> argument to <code>read_excel()</code>, and</li>
<li>row four of the original spreadsheet has become our column names,</li>
</ul>
<p>so row 34 on the spreadsheet is actually row 30 in our loaded dataset. Knowing this, we can remove all the rows below row 30 using the <code>slice()</code> function from the dplyr package:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb12" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="fu">read_excel</span>(<span class="at">sheet =</span> <span class="st">"Table E1"</span>, <span class="at">skip =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 30 × 5
   `Offence group3`                Number of incidents …¹ Rate per 1,000 adult…²
   &lt;chr&gt;                                            &lt;dbl&gt;                  &lt;dbl&gt;
 1 &lt;NA&gt;                                                NA                  NA   
 2 FRAUD5                                            3648                  78.0 
 3 &lt;NA&gt;                                                NA                  NA   
 4 With loss, no or only partial …                    660                  14.1 
 5 With loss, fully reimbursed                       2066                  44.2 
 6 Without loss                                       922                  19.7 
 7 &lt;NA&gt;                                                NA                  NA   
 8 Bank and credit account fraud                     2433                  52.0 
 9 With loss, no or only partial …                    235                   5.03
10 With loss, fully reimbursed                       1727                  36.9 
# ℹ 20 more rows
# ℹ abbreviated names: ¹​`Number of incidents (thousands)`,
#   ²​`Rate per 1,000 adults`
# ℹ 2 more variables: `Number of victims (thousands)4` &lt;dbl&gt;,
#   `Percentage victims once or more4` &lt;dbl&gt;</code></pre>
</div>
</div>
<p>The final problem with the structure of this dataset is the blank rows that are used to separate different crime categories in the original table. We can deal with this using the <code>remove_empty()</code> function from the janitor package, which removes all rows and/or columns that contain only <code>NA</code> values. We will also clean the column names at the same time and then rename the columns to be shorter, which will make it easier to refer to them in our code.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb14" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="fu">read_excel</span>(<span class="at">sheet =</span> <span class="st">"Table E1"</span>, <span class="at">skip =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="fu">remove_empty</span>(<span class="at">which =</span> <span class="st">"rows"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb14-6"><a href="#cb14-6"></a>  <span class="fu">rename</span>(</span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="at">offence =</span> offence_group3, </span>
<span id="cb14-8"><a href="#cb14-8"></a>    <span class="at">crimes =</span> number_of_incidents_thousands, </span>
<span id="cb14-9"><a href="#cb14-9"></a>    <span class="at">incidence =</span> rate_per_1_000_adults, </span>
<span id="cb14-10"><a href="#cb14-10"></a>    <span class="at">victims =</span> number_of_victims_thousands_4, </span>
<span id="cb14-11"><a href="#cb14-11"></a>    <span class="at">prevalence =</span> percentage_victims_once_or_more4</span>
<span id="cb14-12"><a href="#cb14-12"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 22 × 5
   offence                                   crimes incidence victims prevalence
   &lt;chr&gt;                                      &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;
 1 FRAUD5                                      3648     78.0     3078      6.58 
 2 With loss, no or only partial reimbursem…    660     14.1      613      1.31 
 3 With loss, fully reimbursed                 2066     44.2     1765      3.78 
 4 Without loss                                 922     19.7      804      1.72 
 5 Bank and credit account fraud               2433     52.0     2056      4.40 
 6 With loss, no or only partial reimbursem…    235      5.03     211      0.451
 7 With loss, fully reimbursed                 1727     36.9     1458      3.12 
 8 Without loss                                 470     10.1      419      0.896
 9 Consumer and retail fraud6                  1031     22.1      954      2.04 
10 With loss, no or only partial reimbursem…    380      8.13     361      0.771
# ℹ 12 more rows</code></pre>
</div>
</div>
<p>This dataset now has a tidy structure: each row represents an observation (in this case, data about a particular type of crime), each column represents a piece of information about the observation and each cell represents a single value. We still need to clean up the footnote numbers that appear in some of the values, but we will deal with that later in this chapter.</p>
</section>
<section id="separating-multiple-variables-stored-in-a-single-column" class="level3" data-number="12.2.2">
<h3 data-number="12.2.2" class="anchored" data-anchor-id="separating-multiple-variables-stored-in-a-single-column"><span class="header-section-number">12.2.2</span> Separating multiple variables stored in a single column</h3>
<p>Sometimes datasets include multiple variables in a single column. For example, data about crime victims stored in an object called <code>victims</code> might include a single column representing both age and sex.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">first_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">last_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">age_sex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Lyda</td>
<td style="text-align: left;">Gartrell</td>
<td style="text-align: left;">40/F</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kareem</td>
<td style="text-align: left;">David</td>
<td style="text-align: left;">26</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Lisa</td>
<td style="text-align: left;">Dean</td>
<td style="text-align: left;">21/F</td>
</tr>
<tr class="even">
<td style="text-align: left;">Melina</td>
<td style="text-align: left;">Shehan</td>
<td style="text-align: left;">25/F</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Alfredo</td>
<td style="text-align: left;">Matamoros</td>
<td style="text-align: left;">18/M</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>It would be easier to wrangle this data (e.g.&nbsp;to filter by age) if the data in the <code>age_sex</code> column was stored in two separate columns. Making this change would also make sure our data meets the definition of being tidy: every variable should be stored in a separate column.</p>
<p>We can split the <code>age_sex</code> column into two using the <code>separate()</code> function from the tidyr package. We specify the existing column we want to split using the <code>col</code> argument, the names of the new columns we want to create using the <code>into</code> argument and the character(s) that represent the boundary between the two pieces of data in each column (in this case, <code>/</code>).</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb16" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># Create an example dataset of fictional crime victims</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>victims <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb16-3"><a href="#cb16-3"></a>  <span class="sc">~</span>first_name, <span class="sc">~</span>last_name, <span class="sc">~</span>age_sex,</span>
<span id="cb16-4"><a href="#cb16-4"></a>  <span class="st">"Lyda"</span>, <span class="st">"Gartrell"</span>, <span class="st">"40/F"</span>,</span>
<span id="cb16-5"><a href="#cb16-5"></a>  <span class="st">"Kareem"</span>, <span class="st">"David"</span>, <span class="st">"26"</span>,</span>
<span id="cb16-6"><a href="#cb16-6"></a>  <span class="st">"Lisa"</span>, <span class="st">"Dean"</span>, <span class="st">"21/F"</span>,</span>
<span id="cb16-7"><a href="#cb16-7"></a>  <span class="st">"Melina"</span>, <span class="st">"Shehan"</span>, <span class="st">"25/F"</span>,</span>
<span id="cb16-8"><a href="#cb16-8"></a>  <span class="st">"Alfredo"</span>, <span class="st">"Matamoros"</span>, <span class="st">"18/M"</span></span>
<span id="cb16-9"><a href="#cb16-9"></a>)</span>
<span id="cb16-10"><a href="#cb16-10"></a></span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="co"># Separate `age_sex` column into separate columns for age and sex</span></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="fu">separate</span>(victims, <span class="at">col =</span> age_sex, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>), <span class="at">sep =</span> <span class="st">"/"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: Expected 2 pieces. Missing pieces filled with `NA` in 1 rows [2].</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 5 × 4
  first_name last_name age   sex  
  &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;
1 Lyda       Gartrell  40    F    
2 Kareem     David     26    &lt;NA&gt; 
3 Lisa       Dean      21    F    
4 Melina     Shehan    25    F    
5 Alfredo    Matamoros 18    M    </code></pre>
</div>
</div>
<p>You might have noticed that this function produced a warning message saying <code>Expected 2 pieces. Missing pieces filled with NA in 1 rows [2]</code>. This is because the second row of data in the <code>victims</code> object only contains one of the two pieces of data. When this happens, <code>separate()</code> fills in the values that are present from the left, filling any remaining columns to the right with <code>NA</code>. If this is what we want (as it is here), we can silence this warning by specifying <code>fill = "right"</code>. If instead we wanted <code>separate()</code> to fill in columns with <code>NA</code> values from the left, we could specify <code>fill = "left"</code>.</p>
<p>Another issue with the separated data is that because the column <code>age_sex</code> was a character column, both <code>age</code> and <code>sex</code> are character columns, too. Since <code>age</code> is actually numeric, we can get <code>separate()</code> to convert this new column to the correct type automatically by specifying <code>convert = TRUE</code>.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb19" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">separate</span>(</span>
<span id="cb19-2"><a href="#cb19-2"></a>  victims, </span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="at">col =</span> age_sex, </span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>), </span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="at">sep =</span> <span class="st">"/"</span>,</span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="at">convert =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-7"><a href="#cb19-7"></a>  <span class="at">fill =</span> <span class="st">"right"</span></span>
<span id="cb19-8"><a href="#cb19-8"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 5 × 4
  first_name last_name   age sex  
  &lt;chr&gt;      &lt;chr&gt;     &lt;int&gt; &lt;chr&gt;
1 Lyda       Gartrell     40 F    
2 Kareem     David        26 &lt;NA&gt; 
3 Lisa       Dean         21 F    
4 Melina     Shehan       25 F    
5 Alfredo    Matamoros    18 M    </code></pre>
</div>
</div>
<p>We now know how to convert a data into a tidy format using <code>pivot_longer()</code> to convert data to long format, remove non-data rows using <code>slice()</code>, <code>remove_empty()</code> and the <code>skip</code> argument to many functions like <code>read_csv()</code>, and split columns with <code>separate()</code>. In the next section, we’ll learn how to tidy the content of individual cells.</p>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tidying the structure of data
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>What issue might arise when working with wide-format data?</strong></p>
<div id="radio_OJWIAILUUD" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_OJWIAILUUD" value=""> <span>It requires a greater number of observations</span></label><label><input type="radio" autocomplete="off" name="radio_OJWIAILUUD" value=""> <span>It cannot store numeric values</span></label><label><input type="radio" autocomplete="off" name="radio_OJWIAILUUD" value="answer"> <span>It makes it harder to filter, sort, or summarize data</span></label><label><input type="radio" autocomplete="off" name="radio_OJWIAILUUD" value=""> <span>It eliminates missing values</span></label>
</div>
<p><strong>Which of the following best describes a tidy dataset?</strong></p>
<div id="radio_ZPRVMSZXVK" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_ZPRVMSZXVK" value=""> <span>All data is stored in a single column</span></label><label><input type="radio" autocomplete="off" name="radio_ZPRVMSZXVK" value=""> <span>Each column represents a different data type (numeric, character, etc.)</span></label><label><input type="radio" autocomplete="off" name="radio_ZPRVMSZXVK" value=""> <span>Each row represents a variable and each column represents an observation</span></label><label><input type="radio" autocomplete="off" name="radio_ZPRVMSZXVK" value="answer"> <span>Each row represents an observation and each column represents a variable</span></label>
</div>
<p><strong>Which function is used to convert wide data to long format in R?</strong></p>
<div id="radio_SAMNDMKEGA" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_SAMNDMKEGA" value=""> <span><code>spread()</code></span></label><label><input type="radio" autocomplete="off" name="radio_SAMNDMKEGA" value="answer"> <span><code>pivot_longer()</code></span></label><label><input type="radio" autocomplete="off" name="radio_SAMNDMKEGA" value=""> <span><code>gather_rows()</code></span></label><label><input type="radio" autocomplete="off" name="radio_SAMNDMKEGA" value=""> <span><code>transpose()</code></span></label>
</div>
</div>
</div>
</section>
</section>
<section id="tidying-the-content-of-cells" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="tidying-the-content-of-cells"><span class="header-section-number">12.3</span> Tidying the content of cells</h2>
<p>As well as data with a messy structure, you might be provided with data with messy content inside some of the cells. In this section we will clean messy content, mostly using functions from the stringr package that is loaded automatically when we load tidyverse. All the functions in the stringr package start with <code>str_</code> so that they are easy to remember.</p>
<p>We can change the case of text using one of four <code>str_to_</code> functions:</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">input</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">function</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A stRinG oF TeXT</td>
<td style="text-align: left;">`str_to_lower()`</td>
<td style="text-align: left;">a string of text</td>
</tr>
<tr class="even">
<td style="text-align: left;">A stRinG oF TeXT</td>
<td style="text-align: left;">`str_to_upper()`</td>
<td style="text-align: left;">A STRING OF TEXT</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A stRinG oF TeXT</td>
<td style="text-align: left;">`str_to_sentence()`</td>
<td style="text-align: left;">A string of text</td>
</tr>
<tr class="even">
<td style="text-align: left;">A stRinG oF TeXT</td>
<td style="text-align: left;">`str_to_title()`</td>
<td style="text-align: left;">A String Of Text</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can also remove unwanted text from within values. For example, if there is unwanted white-space (spaces, tabs, etc.) at the beginning or end of a string of characters, we can remove it with <code>str_trim()</code>. <code>str_squish()</code> does the same thing, but also reduces any repeated white-space characters in a string of text down to a single space. For example, <code>str_squish("  A string   of text")</code> produces the result <code>A string of text</code>.</p>
<p class="full-width-image">
<img src="../images/str_squish.jpg" alt="Cartoon explaining that the str_squish() function removes leading, trailing and repeated interior white space from strings.">
</p>
<p>Data from the UK police open data website includes the words ‘on or near’ at the start of every value in the <code>location</code> column of the data. This is to remind users that the locations of crimes are deliberately obscured by being ‘snapped’ to the centre of the street on which they occur to protect victims’ privacy.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">month</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">longitude</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">latitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">location</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">lsoa_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-01</td>
<td style="text-align: right;">-1.120</td>
<td style="text-align: right;">53.3</td>
<td style="text-align: left;">On or near Supermarket</td>
<td style="text-align: left;">Bassetlaw 013C</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-02</td>
<td style="text-align: right;">-0.993</td>
<td style="text-align: right;">53.2</td>
<td style="text-align: left;">On or near Turner Lane</td>
<td style="text-align: left;">Newark and Sherwood 001A</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-05</td>
<td style="text-align: right;">-1.250</td>
<td style="text-align: right;">53.1</td>
<td style="text-align: left;">On or near Brookdale Road</td>
<td style="text-align: left;">Ashfield 004C</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-08</td>
<td style="text-align: right;">-1.160</td>
<td style="text-align: right;">53.0</td>
<td style="text-align: left;">On or near Raithby Close</td>
<td style="text-align: left;">Nottingham 006B</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-10</td>
<td style="text-align: right;">-1.180</td>
<td style="text-align: right;">53.0</td>
<td style="text-align: left;">On or near Bowden Avenue</td>
<td style="text-align: left;">Ashfield 013A</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-10</td>
<td style="text-align: right;">-1.180</td>
<td style="text-align: right;">53.0</td>
<td style="text-align: left;">On or near Langley Close</td>
<td style="text-align: left;">Ashfield 013A</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We don’t need this constant value for analysis, and for large datasets it can unnecessarily increase the size of the data when we save it to a file. For this reason we might want to remove this constant value using the <code>str_remove()</code> function.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb21" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># Create example dataset similar to UK police open data</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>uk_data <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="sc">~</span>month, <span class="sc">~</span>longitude, <span class="sc">~</span>latitude, <span class="sc">~</span>location, <span class="sc">~</span>lsoa_name,</span>
<span id="cb21-4"><a href="#cb21-4"></a>  <span class="st">"2020-01"</span>, <span class="sc">-</span><span class="fl">1.12</span>, <span class="fl">53.3</span>, <span class="st">"On or near Supermarket"</span>, <span class="st">"Bassetlaw 013C"</span>,</span>
<span id="cb21-5"><a href="#cb21-5"></a>  <span class="st">"2020-02"</span>, <span class="sc">-</span><span class="fl">0.993</span>, <span class="fl">53.2</span>, <span class="st">"On or near Turner Lane"</span>, <span class="st">"Newark and Sherwood 001A"</span>,</span>
<span id="cb21-6"><a href="#cb21-6"></a>  <span class="st">"2020-05"</span>, <span class="sc">-</span><span class="fl">1.25</span>, <span class="fl">53.1</span>, <span class="st">"On or near Brookdale Road"</span>, <span class="st">"Ashfield 004C"</span>,</span>
<span id="cb21-7"><a href="#cb21-7"></a>  <span class="st">"2020-08"</span>, <span class="sc">-</span><span class="fl">1.16</span>, <span class="fl">53.0</span>, <span class="st">"On or near Raithby Close"</span>, <span class="st">"Nottingham 006B"</span>,</span>
<span id="cb21-8"><a href="#cb21-8"></a>  <span class="st">"2020-10"</span>, <span class="sc">-</span><span class="fl">1.18</span>, <span class="fl">53.0</span>, <span class="st">"On or near Bowden Avenue"</span>, <span class="st">"Ashfield 013A"</span>,</span>
<span id="cb21-9"><a href="#cb21-9"></a>  <span class="st">"2020-10"</span>, <span class="sc">-</span><span class="fl">1.18</span>, <span class="fl">53.0</span>, <span class="st">"On or near Langley Close"</span>, <span class="st">"Ashfield 013A"</span></span>
<span id="cb21-10"><a href="#cb21-10"></a>)</span>
<span id="cb21-11"><a href="#cb21-11"></a></span>
<span id="cb21-12"><a href="#cb21-12"></a><span class="co"># Remove constant text from the location column</span></span>
<span id="cb21-13"><a href="#cb21-13"></a><span class="fu">mutate</span>(uk_data, <span class="at">location =</span> <span class="fu">str_remove</span>(location, <span class="st">"On or near "</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 6 × 5
  month   longitude latitude location       lsoa_name               
  &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt;                   
1 2020-01    -1.12      53.3 Supermarket    Bassetlaw 013C          
2 2020-02    -0.993     53.2 Turner Lane    Newark and Sherwood 001A
3 2020-05    -1.25      53.1 Brookdale Road Ashfield 004C           
4 2020-08    -1.16      53   Raithby Close  Nottingham 006B         
5 2020-10    -1.18      53   Bowden Avenue  Ashfield 013A           
6 2020-10    -1.18      53   Langley Close  Ashfield 013A           </code></pre>
</div>
</div>
<p>The <code>lsoa_name</code> code of this dataset includes the name of the small statistical area in which each crime occurred. Each name is made up of the name of the local government district covering the area followed by a unique code. If we wanted to extract just the district name (for example so we could count the number of crimes in each district) we can do that by removing the code that follows the district name. To do this we need to use a <em>regular expression</em>, which is a way of describing a pattern in a string of characters. Regular expressions can be used to find, extract or remove characters that match a specified pattern.</p>
<p>Regular expressions can be complicated, so we will only scratch the surface of what’s possible here. You can find out much more about about them in the <a href="https://stringr.tidyverse.org/articles/regular-expressions.html">article on regular expressions included in the stringr package</a>. The coded description of the pattern of characters we need to match the code at the end of the <code>lsoa_name</code> column is <code>\\s\\w{4}$</code>. This is made up three parts:</p>
<ul>
<li><code>\\s</code> means match exactly one white-space character (e.g.&nbsp;a space or a tab),</li>
<li><code>\\w{4}</code> means match exactly four word characters (i.e.&nbsp;any letter, any number or some punctuation marks), and</li>
<li><code>$</code> means match the end of the string.</li>
</ul>
<p>So <code>\\s\\w{4}$</code> means match exactly one white-space character followed by exactly four word characters at the end of the string. We can use this pattern as the second argument to the <code>str_remove()</code> function to remove the characters matched by the pattern.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb23" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>uk_data <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2"></a>  <span class="fu">mutate</span>(<span class="at">district =</span> <span class="fu">str_remove</span>(lsoa_name, <span class="st">"</span><span class="sc">\\</span><span class="st">s</span><span class="sc">\\</span><span class="st">w{4}$"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="co"># Extract two columns to make them easier to compare</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>  <span class="fu">select</span>(lsoa_name, district)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 6 × 2
  lsoa_name                district           
  &lt;chr&gt;                    &lt;chr&gt;              
1 Bassetlaw 013C           Bassetlaw          
2 Newark and Sherwood 001A Newark and Sherwood
3 Ashfield 004C            Ashfield           
4 Nottingham 006B          Nottingham         
5 Ashfield 013A            Ashfield           
6 Ashfield 013A            Ashfield           </code></pre>
</div>
</div>
<p>Instead of using a regular expression to remove characters, we could instead use regular expressions together with <code>str_extract()</code> to keep only the characters matched by the pattern, <code>str_replace()</code> to replace the first group of characters matched by the pattern and <code>str_replace_all()</code> to replace all the groups of characters matched by the pattern. For more tips on using regular expressions together with functions from the stringr package, see the <a href="https://github.com/rstudio/cheatsheets/blob/main/strings.pdf">stringr package cheat sheet</a> or visit <a href="https://regexr.com/">regexr.com</a>.</p>
<section id="converting-between-types-of-variable" class="level3" data-number="12.3.1">
<h3 data-number="12.3.1" class="anchored" data-anchor-id="converting-between-types-of-variable"><span class="header-section-number">12.3.1</span> Converting between types of variable</h3>
<p>Sometimes columns in your data will be stored as the wrong type of variable. <code>read_csv()</code> and other functions from the readr package try to guess what type of variable is contained in each column based on what is contained in the first few rows, but this does not always work. For example, a variable containing numbers might be stored as characters, meaning functions like <code>mean()</code> will not work.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb25" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># Some numbers stored as text (note the quote marks around each number)</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>numbers_as_text <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"14"</span>, <span class="st">"6"</span>, <span class="st">"17"</span>)</span>
<span id="cb25-3"><a href="#cb25-3"></a></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="co"># Trying to find the mean of these numbers stored as characters will produce </span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="co"># `NA` and a warning</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="fu">mean</span>(numbers_as_text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning in mean.default(numbers_as_text): argument is not numeric or logical:
returning NA</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] NA</code></pre>
</div>
</div>
<p>In cases like this, we can use the <code>parse_number()</code> function from the readr package (part of tidyverse) to convert the character variable into a numeric variable.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb28" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># If we use `parse_number()` then `mean()` now works</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="fu">mean</span>(<span class="fu">parse_number</span>(numbers_as_text))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] 12.33333</code></pre>
</div>
</div>
<p><img src="../images/parse_number.jpg" alt="Cartoon showing that the parse_number() function extracts numeric values from text, stripping out all non-numeric characters." class="right-side-image" style="width: 400px; max-width: 50%;"></p>
<p>We can use other functions in the <code>parse_*()</code> family to convert character values to other data types. For example, we can use <code>parse_logical()</code> to convert true/false values stored as text to <code>TRUE</code> and <code>FALSE</code> values. Be careful, though: if you try to convert a variable to a data type that makes no sense, you are likely to find all of your values replaced with <code>NA</code>.</p>
<p>Sometimes numbers will be stored alongside other values, such as when currency values are stored together with a currency symbol. We can also deal with values like these by using <code>parse_number()</code>, which strips all the non-numeric characters from a value and then converts the numeric characters to a number. For example, <code>parse_number("Room 14A")</code> produces the numeric value <code>14</code>.</p>
<p>If there are multiple columns in a dataset that store non-text data as character values, we can also use the <code>type_convert()</code> function from the readr package to automatically convert them all.</p>
</section>
<section id="recoding-categorical-variables" class="level3" data-number="12.3.2">
<h3 data-number="12.3.2" class="anchored" data-anchor-id="recoding-categorical-variables"><span class="header-section-number">12.3.2</span> Recoding categorical variables</h3>
<p>Crime data often includes categorical variables, such as crime types or location categories. It can be useful to change these categories, for example so that we can join two datasets or abbreviate category names for use in the axis labels of a chart.</p>
<p>We can use the <code>if_else()</code> function from the dplyr package to change particular values, but this only allows us to change a single value and can produce slightly untidy code. Instead we can use the <code>case_match()</code> function from the dplyr package to change one or more values at the same time. For example, if we wanted to change the value <code>Supermarket</code> to <code>Shop</code> in the UK police data.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb30" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>uk_data <span class="sc">|&gt;</span> </span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-3"><a href="#cb30-3"></a>    <span class="co"># Once again we will first remove the unnecessary 'On or near ' using </span></span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="co"># `str_remove()`</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>    <span class="at">location =</span> <span class="fu">str_remove</span>(location, <span class="st">"On or near "</span>),</span>
<span id="cb30-6"><a href="#cb30-6"></a>    <span class="at">location =</span> <span class="fu">case_match</span>(location, <span class="st">"Supermarket"</span> <span class="sc">~</span> <span class="st">"Shop"</span>, <span class="at">.default =</span> location)</span>
<span id="cb30-7"><a href="#cb30-7"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 6 × 5
  month   longitude latitude location       lsoa_name               
  &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt;                   
1 2020-01    -1.12      53.3 Shop           Bassetlaw 013C          
2 2020-02    -0.993     53.2 Turner Lane    Newark and Sherwood 001A
3 2020-05    -1.25      53.1 Brookdale Road Ashfield 004C           
4 2020-08    -1.16      53   Raithby Close  Nottingham 006B         
5 2020-10    -1.18      53   Bowden Avenue  Ashfield 013A           
6 2020-10    -1.18      53   Langley Close  Ashfield 013A           </code></pre>
</div>
</div>
<p>The first argument to <code>case_match()</code> is the name of the variable to be recoded. That is followed by one or more arguments showing which values should be changed, and what they should be changed to. The old and new values are separated by a tilde (<code>~</code>) character, with the old value on the left. The final argument (<code>.default</code>) specifies what value the variable should have if it does not currently have any of the values specified in the pairs of values already provided. In this case, we use <code>.default = location</code> to specify that unmatched values should keep their existing values.</p>
<p>We can use <code>case_match()</code> to make more-complicated changes. For example we can change multiple values at the same time, including merging different values into the same new value:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb32" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>uk_data <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-3"><a href="#cb32-3"></a>    <span class="co"># Once again we will first remove the unnecessary 'On or near ' using </span></span>
<span id="cb32-4"><a href="#cb32-4"></a>    <span class="co"># `str_remove()`</span></span>
<span id="cb32-5"><a href="#cb32-5"></a>    <span class="at">location =</span> <span class="fu">str_remove</span>(location, <span class="st">"On or near "</span>),</span>
<span id="cb32-6"><a href="#cb32-6"></a>    <span class="at">location =</span> <span class="fu">case_match</span>(</span>
<span id="cb32-7"><a href="#cb32-7"></a>      location, </span>
<span id="cb32-8"><a href="#cb32-8"></a>      <span class="st">"Supermarket"</span> <span class="sc">~</span> <span class="st">"Shop"</span>,</span>
<span id="cb32-9"><a href="#cb32-9"></a>      <span class="fu">c</span>(<span class="st">"Bowden Avenue"</span>, <span class="st">"Langley Close"</span>) <span class="sc">~</span> <span class="st">"Bestwood Village"</span>,</span>
<span id="cb32-10"><a href="#cb32-10"></a>      <span class="at">.default =</span> location</span>
<span id="cb32-11"><a href="#cb32-11"></a>    )</span>
<span id="cb32-12"><a href="#cb32-12"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 6 × 5
  month   longitude latitude location         lsoa_name               
  &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;            &lt;chr&gt;                   
1 2020-01    -1.12      53.3 Shop             Bassetlaw 013C          
2 2020-02    -0.993     53.2 Turner Lane      Newark and Sherwood 001A
3 2020-05    -1.25      53.1 Brookdale Road   Ashfield 004C           
4 2020-08    -1.16      53   Raithby Close    Nottingham 006B         
5 2020-10    -1.18      53   Bestwood Village Ashfield 013A           
6 2020-10    -1.18      53   Bestwood Village Ashfield 013A           </code></pre>
</div>
</div>
</section>
<section id="missing-values" class="level3" data-number="12.3.3">
<h3 data-number="12.3.3" class="anchored" data-anchor-id="missing-values"><span class="header-section-number">12.3.3</span> Missing values</h3>
<p>We have already encountered the <code>NA</code> value, which R uses to represent a value that is missing from a dataset. While R uses <code>NA</code> to represent missing values, some data providers use other codes. For example, a data provider might use a dash (<code>-</code>) or two periods (<code>..</code>) to represent missing values. Fortunately, we can convert any value to <code>NA</code> so that we know that it represents a missing value.</p>
<p>Imagine that you have been provided with a dataset of burglaries that includes an estimate of the value of the goods that were stolen in British pounds. You have been told that when the value of the stolen goods wasn’t known, this is recorded as the value <code>-1</code> in the data. If we use <code>mean()</code> to estimate the average value of property stolen, the value <code>-1</code> will give us an incorrect result.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb34" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="co"># Create a dataset of burglary dates/times with the value of goods stolen</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>burglary_values <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb34-3"><a href="#cb34-3"></a>  <span class="at">crime_number =</span> <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">5</span>, <span class="at">min =</span> <span class="dv">100000</span>, <span class="at">max =</span> <span class="dv">999999</span>),</span>
<span id="cb34-4"><a href="#cb34-4"></a>  <span class="at">value =</span> <span class="fu">c</span>(<span class="dv">1320</span>, <span class="dv">653</span>, <span class="dv">2068</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">580</span>)</span>
<span id="cb34-5"><a href="#cb34-5"></a>)</span>
<span id="cb34-6"><a href="#cb34-6"></a></span>
<span id="cb34-7"><a href="#cb34-7"></a><span class="co"># Try to calculate the mean value -- no error, but the answer is wrong</span></span>
<span id="cb34-8"><a href="#cb34-8"></a><span class="co"># `pull()` is used to extract the `value` column from `burglary_values`</span></span>
<span id="cb34-9"><a href="#cb34-9"></a><span class="fu">mean</span>(<span class="fu">pull</span>(burglary_values, <span class="st">"value"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] 924</code></pre>
</div>
</div>
<p>If we instead convert the value <code>-1</code> to <code>NA</code> first, <code>mean()</code> will know to ignore that value as long as we specify the argument <code>na.rm = TRUE</code>.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb36" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="co"># Convert `-1` to `NA` first, now you get the correct mean value</span></span>
<span id="cb36-2"><a href="#cb36-2"></a>burglary_values <span class="ot">&lt;-</span> <span class="fu">mutate</span>(</span>
<span id="cb36-3"><a href="#cb36-3"></a>  burglary_values,</span>
<span id="cb36-4"><a href="#cb36-4"></a>  <span class="at">value =</span> <span class="fu">if_else</span>(value <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>, <span class="cn">NA</span>, value)</span>
<span id="cb36-5"><a href="#cb36-5"></a>)</span>
<span id="cb36-6"><a href="#cb36-6"></a></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="co"># Calculate the mean value again, now excluding the missing value</span></span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="fu">mean</span>(<span class="fu">pull</span>(burglary_values, <span class="st">"value"</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] 1155.25</code></pre>
</div>
</div>
<p>Excluding the value <code>-1</code> makes a substantial difference to the mean, increasing it by over £100.</p>
</section>
<section id="sec-null-island" class="level3" data-number="12.3.4">
<h3 data-number="12.3.4" class="anchored" data-anchor-id="sec-null-island"><span class="header-section-number">12.3.4</span> Null Island</h3>
<p>The problem of missing values being stored as numbers manifests itself in a particularly frustrating way when it comes to spatial data. People and organisations that produce spatial datasets sometimes recording missing co-ordinates as being <em>zero</em>, instead of being <em>missing</em>. This is a problem because the longitude/latitude co-ordinates “0, 0” correspond to a real location on the surface of the earth, in the Gulf of Guinea off the coast of Ghana. This location is incorrectly recorded in spatial datasets so often that it’s become known as <em>Null Island</em>. Watch this video to find out more about Null Island and the problems it causes.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/bjvIpI-1w84" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<p>So if you see any co-ordinates on your map located in the Atlantic off the south coast of West Africa, you know that there are almost certainly rows in your data that have co-ordinates located at Null Island.</p>
<p class="full-width-image">
<img src="../images/null_island.jpg" alt="A globe map showing Null Island at co-ordinates of 0 longitude and latitude">
</p>
<p>When we make crime maps we are generally dealing with small areas such as cities and counties. So if you plot a dataset on a map and instead of seeing a map of the area you are interested in, you see a large area of the world with the place you are interested in in one corner and Null Island in the opposite corner, that almost certainly means some co-ordinates are located at Null Island.</p>
<p>As an example, imagine we were trying to create a map of the home addresses of several (fictional) suspects for bank fraud in and around Cairo, Egypt. The data contain 10 rows stored in an object called <code>cairo_suspects</code> that looks like this:</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 17%">
<col style="width: 69%">
<col style="width: 6%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">address</th>
<th style="text-align: right;">lon</th>
<th style="text-align: right;">lat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Ahmed Hussein Ayman</td>
<td style="text-align: left;">94, El Sheikh Abd El Jalil Issa Street, Al Banafseg 8, Banafseg Districts, New Cairo City, Cairo</td>
<td style="text-align: right;">31.46236</td>
<td style="text-align: right;">30.04954</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mohamed Ali Mohamed</td>
<td style="text-align: left;">22, Noran Street, Al Salam First, Al Qalyubiya</td>
<td style="text-align: right;">31.40320</td>
<td style="text-align: right;">30.16475</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mahmoud Mostafa Ali</td>
<td style="text-align: left;">43, Tarek Gamal Street, Cairo</td>
<td style="text-align: right;">31.29651</td>
<td style="text-align: right;">30.11844</td>
</tr>
<tr class="even">
<td style="text-align: left;">Omar El-Badawi</td>
<td style="text-align: left;">7, Abou Bakr Al Sediq Street, Al-Obour, Al Qalyubiya</td>
<td style="text-align: right;">31.37844</td>
<td style="text-align: right;">30.17814</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tarek Hazim Abdel-Rahman</td>
<td style="text-align: left;">16, Al Madina Al Mnoura Street, Ma‘ di, Cairo</td>
<td style="text-align: right;">31.26321</td>
<td style="text-align: right;">29.97942</td>
</tr>
<tr class="even">
<td style="text-align: left;">Youssef Sayyid</td>
<td style="text-align: left;">18, Fathy Abou Wedn Street, Shubra al Khayma, Al Qalyubiya</td>
<td style="text-align: right;">31.34177</td>
<td style="text-align: right;">30.15624</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Hussein El-Masri</td>
<td style="text-align: left;">61, Al Ashgar Street, South West, El Shorouk City, May Fair, Cairo</td>
<td style="text-align: right;">31.61096</td>
<td style="text-align: right;">30.12838</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mariam Abdel Mubarak</td>
<td style="text-align: left;">15R, Mohamed Farid Street, EL Sheikh Mubarak, Cairo</td>
<td style="text-align: right;">31.24903</td>
<td style="text-align: right;">29.99366</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Farah Youssef Anwar</td>
<td style="text-align: left;">35, Al Sadat Road, Neighborhood 9, El Shorouk City, Sunrise, Cairo</td>
<td style="text-align: right;">31.62810</td>
<td style="text-align: right;">30.14780</td>
</tr>
<tr class="even">
<td style="text-align: left;">Nour El-Seifi</td>
<td style="text-align: left;">23, Moustafa Kamel Street, Area 2, Badr, Cairo</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">0.00000</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>If we plotted these locations on a map, we might expect to see something like this:</p>
<p class="full-width-image">
<img src="../images/null_island_cairo1.jpg" alt="A map showing several points in the city of Cairo, Egypt">
</p>
<p>But look again at the final row of data in the table above – the co-ordinates for the final row are both zero. There are several reasons why this might be. Perhaps the address was recorded incorrectly in a police database and that meant that when the addresses were run through geocoding software (which we will learn more about in the next section), no co-ordinates for that row could be found. What this means is that when we plot the data on a map, that map will actually look like this:</p>
<p class="full-width-image">
<img src="../images/null_island_cairo2.jpg" alt="A map showing a large proportion of Africa, with several points clustered around the city of Cairo, Egypt in the top-right corner and a single point located in the Atlantic Ocean off the coast of Ghana.">
</p>
<p>What we can see here is most of the points on this map are correctly located in and around Cairo, but a single point is incorrectly located at Null Island.</p>
<p>We can deal with the problem of our data including points located at Null Island using the <code>st_intersection()</code> function that we have previously used to clip datasets to the boundaries of other datasets. In this case, we can use <code>st_intersection()</code> to remove any rows from the data that are not within the area that the data is supposed to cover.</p>
<p>For example, we know that all the addresses of bank fraud suspects are supposed to be in Egypt, so we can safely clip the suspect data to the boundary of Egypt before mapping the data. There are lots of sources of data on the outlines of countries, but perhaps the most convenient to use in R is the data provided by the rnaturalearth package. We can use the <code>ne_countries()</code> function to retrieve the outline of Egypt as an SF object, which we can then use to clip the suspect dataset.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb38" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="co"># Create dataset of fictional fraud suspects in Cairo</span></span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="co"># Note these lines are more than 80 characters long, since if we don't keep each</span></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="co"># row in the dataset on a single line of code, it becomes very difficult to work</span></span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="co"># out which fields will end up in which rows</span></span>
<span id="cb38-5"><a href="#cb38-5"></a>cairo_suspects <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(</span>
<span id="cb38-6"><a href="#cb38-6"></a>  <span class="sc">~</span>name, <span class="sc">~</span>address, <span class="sc">~</span>lon, <span class="sc">~</span>lat,</span>
<span id="cb38-7"><a href="#cb38-7"></a>  <span class="st">"Ahmed Hussein Ayman"</span>, <span class="st">"94, El Sheikh Abd El Jalil Issa Street, Al Banafseg 8, Banafseg Districts, New Cairo City, Cairo"</span>, <span class="fl">31.4623637</span>, <span class="fl">30.049543</span>,</span>
<span id="cb38-8"><a href="#cb38-8"></a>  <span class="st">"Mohamed Ali Mohamed"</span>, <span class="st">"22, Noran Street, Al Salam First, Al Qalyubiya"</span>, <span class="fl">31.4032012</span>, <span class="fl">30.1647536</span>,</span>
<span id="cb38-9"><a href="#cb38-9"></a>  <span class="st">"Mahmoud Mostafa Ali"</span>, <span class="st">"43, Tarek Gamal Street, Cairo"</span>, <span class="fl">31.296507</span>, <span class="fl">30.1184382</span>,</span>
<span id="cb38-10"><a href="#cb38-10"></a>  <span class="st">"Omar El-Badawi"</span>, <span class="st">"7, Abou Bakr Al Sediq Street, Al-Obour, Al Qalyubiya"</span>, <span class="fl">31.3784444</span>, <span class="fl">30.1781414</span>,</span>
<span id="cb38-11"><a href="#cb38-11"></a>  <span class="st">"Tarek Hazim Abdel-Rahman"</span>, <span class="st">"16, Al Madina Al Mnoura Street, Ma‘ di, Cairo"</span>, <span class="fl">31.2632149</span>, <span class="fl">29.9794155</span>,</span>
<span id="cb38-12"><a href="#cb38-12"></a>  <span class="st">"Youssef Sayyid"</span>, <span class="st">"18, Fathy Abou Wedn Street, Shubra al Khayma, Al Qalyubiya"</span>, <span class="fl">31.3417734</span>, <span class="fl">30.1562442</span>,</span>
<span id="cb38-13"><a href="#cb38-13"></a>  <span class="st">"Hussein El-Masri"</span>, <span class="st">"61, Al Ashgar Street, South West, El Shorouk City, May Fair, Cairo"</span>, <span class="fl">31.6109636</span>, <span class="fl">30.1283769</span>,</span>
<span id="cb38-14"><a href="#cb38-14"></a>  <span class="st">"Mariam Abdel Mubarak"</span>, <span class="st">"15R, Mohamed Farid Street, EL Sheikh Mubarak, Cairo"</span>, <span class="fl">31.2490346</span>, <span class="fl">29.9936643</span>,</span>
<span id="cb38-15"><a href="#cb38-15"></a>  <span class="st">"Farah Youssef Anwar"</span>, <span class="st">"35, Al Sadat Road, Neighborhood 9, El Shorouk City, Sunrise, Cairo"</span>, <span class="fl">31.6280994</span>, <span class="fl">30.1478049</span>,</span>
<span id="cb38-16"><a href="#cb38-16"></a>  <span class="st">"Nour El-Seifi"</span>, <span class="st">"23, Moustafa Kamel Street, Area 2, Badr, Cairo"</span>, <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb38-17"><a href="#cb38-17"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb38-18"><a href="#cb38-18"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>)</span>
<span id="cb38-19"><a href="#cb38-19"></a></span>
<span id="cb38-20"><a href="#cb38-20"></a><span class="co"># By default, `ne_countries()` does not return an SF object, so we have to</span></span>
<span id="cb38-21"><a href="#cb38-21"></a><span class="co"># specify that is what we want using the `returnclass = "sf"` argument</span></span>
<span id="cb38-22"><a href="#cb38-22"></a>egypt_outline <span class="ot">&lt;-</span> rnaturalearth<span class="sc">::</span><span class="fu">ne_countries</span>(</span>
<span id="cb38-23"><a href="#cb38-23"></a>  <span class="at">country =</span> <span class="st">"Egypt"</span>, </span>
<span id="cb38-24"><a href="#cb38-24"></a>  <span class="at">returnclass =</span> <span class="st">"sf"</span></span>
<span id="cb38-25"><a href="#cb38-25"></a>)</span>
<span id="cb38-26"><a href="#cb38-26"></a></span>
<span id="cb38-27"><a href="#cb38-27"></a><span class="co"># Clip dataset to the boundary of Egypt</span></span>
<span id="cb38-28"><a href="#cb38-28"></a>cairo_suspects_valid <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(cairo_suspects, egypt_outline)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
</div>
<p>Now if we were to plot a map using the <code>cairo_suspects_valid</code> object, we would see the map covered only the Cairo area, as we originally wanted.</p>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tidy content
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Which of the following is an example of messy data in a single column?</strong></p>
<div id="radio_WFZTJWXISY" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_WFZTJWXISY" value=""> <span>A column that stores only numeric values</span></label><label><input type="radio" autocomplete="off" name="radio_WFZTJWXISY" value="answer"> <span>A column that contains both height and weight in the same field</span></label><label><input type="radio" autocomplete="off" name="radio_WFZTJWXISY" value=""> <span>A column that contains a single constant value for all rows</span></label><label><input type="radio" autocomplete="off" name="radio_WFZTJWXISY" value=""> <span>A column that only contains unique IDs</span></label>
</div>
<p><strong>What is the purpose of the <code>separate()</code> function in R?</strong></p>
<div id="radio_QBCTVFPGRR" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_QBCTVFPGRR" value=""> <span>To merge two columns into one</span></label><label><input type="radio" autocomplete="off" name="radio_QBCTVFPGRR" value=""> <span>To remove missing values from a dataset</span></label><label><input type="radio" autocomplete="off" name="radio_QBCTVFPGRR" value="answer"> <span>To split a column into multiple columns based on a delimiter</span></label><label><input type="radio" autocomplete="off" name="radio_QBCTVFPGRR" value=""> <span>To convert categorical data into numeric values</span></label>
</div>
</div>
</div>
</section>
</section>
<section id="geocoding-locations" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="geocoding-locations"><span class="header-section-number">12.4</span> Geocoding locations</h2>
<p>Throughout this course we have used geographic data that includes locations stored as pairs of co-ordinates, e.g.&nbsp;latitude and longitude or easting and northing. Sometimes geographic data will not contain co-ordinates but instead store the locations of places or events as free-text addresses.</p>
<p><a href="http://www.kelleysgrilleandbar.com/" title="Kelley's Grill 
&amp; Bar website"><img src="../images/kelleys.jpg" class="right-side-image" style="border: 1px solid #333;"></a></p>
<p>Address fields can be very messy indeed. This is because addresses can often be stored in different formats, include different abbreviations or use different spellings (including typos). For example, the official postal address ‘<a href="http://www.kelleysgrilleandbar.com/">Kelley’s Grill &amp; Bar</a>, 15540 State Avenue, Basehor, Kansas 66007, United States’ could be stored in a local police report as:</p>
<ul>
<li>Kelly’s Bar, 15540 US Highway 40, Basehor</li>
<li>Kelley’s Grille, 15540 State</li>
<li>Kelley’s, 15540 State Av</li>
<li>Kelley’s Bar and Grill, 15540 State Ave</li>
<li>Kelley’s Bar, State Av and 155th St</li>
<li>Kelly’s Grill, State Ave btwn 155 and 158</li>
</ul>
<p>All of these address descriptions would probably be good enough for local police officers to know which building the author intended to reference. But since all these different addresses relate to the same physical location, they would make it very hard to (for example) work out how many incidents had occurred at Kelley’s Grill &amp; Bar using <code>count()</code> or a similar function.</p>
<p>To make use of data containing addresses, it is typically necessary to <em>geocode</em> the locations, i.e.&nbsp;to convert the addresses into co-ordinates. The many ways to describe an address mean that geocoding is often quite hard.</p>
<p><a href="https://jessecambon.github.io/tidygeocoder/" title="tidygeocoder website"><img src="../images/tidygeocoder.png" class="right-side-image"></a></p>
<p>We can geocode addresses in R using the <a href="https://jessecambon.github.io/tidygeocoder/">tidygeocoder package</a>, which provides an interface to several online geocoding services.</p>
<p>To run a geocoding service an organisation has to maintain a database of many millions of addresses (which must be constantly updated) and handle addresses in many different formats, so organisations typically charge for these services or limit how many addresses you can geocode for free. Most services also require you to register, even if you are only making few-enough queries that you will not be charged. tidygeocoder supports several geocoding services:</p>
<div class="cell">
<div class="cell-output-display">
<div id="xnfrktypfw" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#xnfrktypfw table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#xnfrktypfw thead, #xnfrktypfw tbody, #xnfrktypfw tfoot, #xnfrktypfw tr, #xnfrktypfw td, #xnfrktypfw th {
  border-style: none;
}

#xnfrktypfw p {
  margin: 0;
  padding: 0;
}

#xnfrktypfw .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#xnfrktypfw .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#xnfrktypfw .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#xnfrktypfw .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#xnfrktypfw .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#xnfrktypfw .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#xnfrktypfw .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#xnfrktypfw .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#xnfrktypfw .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#xnfrktypfw .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#xnfrktypfw .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#xnfrktypfw .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#xnfrktypfw .gt_spanner_row {
  border-bottom-style: hidden;
}

#xnfrktypfw .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#xnfrktypfw .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#xnfrktypfw .gt_from_md > :first-child {
  margin-top: 0;
}

#xnfrktypfw .gt_from_md > :last-child {
  margin-bottom: 0;
}

#xnfrktypfw .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#xnfrktypfw .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#xnfrktypfw .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#xnfrktypfw .gt_row_group_first td {
  border-top-width: 2px;
}

#xnfrktypfw .gt_row_group_first th {
  border-top-width: 2px;
}

#xnfrktypfw .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#xnfrktypfw .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#xnfrktypfw .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#xnfrktypfw .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#xnfrktypfw .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#xnfrktypfw .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#xnfrktypfw .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#xnfrktypfw .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#xnfrktypfw .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#xnfrktypfw .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#xnfrktypfw .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#xnfrktypfw .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#xnfrktypfw .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#xnfrktypfw .gt_left {
  text-align: left;
}

#xnfrktypfw .gt_center {
  text-align: center;
}

#xnfrktypfw .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#xnfrktypfw .gt_font_normal {
  font-weight: normal;
}

#xnfrktypfw .gt_font_bold {
  font-weight: bold;
}

#xnfrktypfw .gt_font_italic {
  font-style: italic;
}

#xnfrktypfw .gt_super {
  font-size: 65%;
}

#xnfrktypfw .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#xnfrktypfw .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#xnfrktypfw .gt_indent_1 {
  text-indent: 5px;
}

#xnfrktypfw .gt_indent_2 {
  text-indent: 10px;
}

#xnfrktypfw .gt_indent_3 {
  text-indent: 15px;
}

#xnfrktypfw .gt_indent_4 {
  text-indent: 20px;
}

#xnfrktypfw .gt_indent_5 {
  text-indent: 25px;
}

#xnfrktypfw .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#xnfrktypfw div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="service" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">service</th>
<th id="coverage" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">coverage</th>
<th id="free-limits" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">free limits</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="service"><a href="https://nominatim.org/">Nominatim</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">1 address per second</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="service"><a href="https://locationiq.com/">Location IQ</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">5,000 addresses per day</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="service"><a href="https://geoapify.com/">Geoapify</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">3,000 addresses per day</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="service"><a href="https://opencagedata.com/">OpenCage</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">2,500 addresses per day</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="service"><a href="https://developer.tomtom.com/">TomTom</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">2,500 addresses per day</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="service"><a href="https://developers.google.com/maps/documentation/geocoding/overview/">Google</a></td>
<td class="gt_row gt_left" headers="coverage">Worldwide</td>
<td class="gt_row gt_left" headers="free limits">40,000 addresses per month</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="service"><a href="https://www.geocod.io/">Geocodio</a></td>
<td class="gt_row gt_left" headers="coverage">United States and Canada</td>
<td class="gt_row gt_left" headers="free limits">2,500 addresses per day</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="service"><a href="https://geocoding.geo.census.gov/">US Census</a></td>
<td class="gt_row gt_left" headers="coverage">United States</td>
<td class="gt_row gt_left" headers="free limits">none</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The tidygeocoder package also supports some other services that do not offer any free option – you can find out more about these options on the <a href="https://jessecambon.github.io/tidygeocoder/articles/geocoder_services.html">package website</a>.</p>
<p>To illustrate the geocoding process, we will find co-ordinates for the addresses in the object <code>addresses</code>, which holds data for 10 sexual assaults in Chicago.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">offense_date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">location_type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">address</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2019-01-01 00:00:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">2400 W Carmen Ave</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-01 00:00:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">2700 S TRIPP AVE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-01-01 11:44:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">3700 S PAULINA ST</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-01 11:44:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">3700 S Paulina St</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-01-01 16:37:00</td>
<td style="text-align: left;">government</td>
<td style="text-align: left;">1100 S HAMILTON AVE</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-02 17:09:00</td>
<td style="text-align: left;">gas station</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-01-02 17:09:00</td>
<td style="text-align: left;">gas station</td>
<td style="text-align: left;">8200 S HALSTED ST</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-05 00:01:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">1300 N HUDSON AVE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019-01-05 14:00:00</td>
<td style="text-align: left;">other</td>
<td style="text-align: left;">6200 N Claremont Ave</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-07 06:50:00</td>
<td style="text-align: left;">residence</td>
<td style="text-align: left;">9500 S BELL AVE</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Since most geocoding services limit the number of addresses you can look up at a time, the first step in geocoding is removing duplicate addresses and rows with missing address values. This avoids us geocoding identical addresses several times, which would otherwise unnecessarily increase our chance of hitting the limit on geocoding queries each day.</p>
<p>We will also add the city and state to the end of each address, since at the moment (as with much data produced by local organisations) it includes only the building number and street.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb40" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># Create example dataset of addresses to be geocoded</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>addresses <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb40-3"><a href="#cb40-3"></a>  <span class="sc">~</span><span class="st">"offense_date"</span>, <span class="sc">~</span><span class="st">"location_type"</span>, <span class="sc">~</span><span class="st">"address"</span>,</span>
<span id="cb40-4"><a href="#cb40-4"></a>  <span class="st">"2019-01-01T00:00:00Z"</span>, <span class="st">"residence"</span>,  <span class="st">"2400 W Carmen Ave"</span>,</span>
<span id="cb40-5"><a href="#cb40-5"></a>  <span class="st">"2019-01-01T00:00:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"2700 S TRIPP AVE"</span>,</span>
<span id="cb40-6"><a href="#cb40-6"></a>  <span class="st">"2019-01-01T11:44:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"3700 S PAULINA ST"</span>,</span>
<span id="cb40-7"><a href="#cb40-7"></a>  <span class="st">"2019-01-01T11:44:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"3700 S Paulina St"</span>,</span>
<span id="cb40-8"><a href="#cb40-8"></a>  <span class="st">"2019-01-01T16:37:00Z"</span>,   <span class="st">"government"</span>,   <span class="st">"1100 S HAMILTON AVE"</span>,</span>
<span id="cb40-9"><a href="#cb40-9"></a>  <span class="st">"2019-01-02T17:09:00Z"</span>,   <span class="st">"gas station"</span>,  <span class="cn">NA</span>,</span>
<span id="cb40-10"><a href="#cb40-10"></a>  <span class="st">"2019-01-02T17:09:00Z"</span>,   <span class="st">"gas station"</span>,  <span class="st">"8200 S HALSTED ST"</span>,</span>
<span id="cb40-11"><a href="#cb40-11"></a>  <span class="st">"2019-01-05T00:01:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"1300 N HUDSON AVE"</span>,</span>
<span id="cb40-12"><a href="#cb40-12"></a>  <span class="st">"2019-01-05T14:00:00Z"</span>,   <span class="st">"other"</span>, <span class="st">"6200 N Claremont Ave"</span>,</span>
<span id="cb40-13"><a href="#cb40-13"></a>  <span class="st">"2019-01-07T06:50:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"9500 S BELL AVE"</span>,</span>
<span id="cb40-14"><a href="#cb40-14"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb40-15"><a href="#cb40-15"></a>  <span class="fu">type_convert</span>()</span>
<span id="cb40-16"><a href="#cb40-16"></a></span>
<span id="cb40-17"><a href="#cb40-17"></a>addresses_for_geocoding <span class="ot">&lt;-</span> addresses <span class="sc">|&gt;</span> </span>
<span id="cb40-18"><a href="#cb40-18"></a>  <span class="co"># Drop rows that have NA values in the `address` column</span></span>
<span id="cb40-19"><a href="#cb40-19"></a>  <span class="fu">drop_na</span>(address) <span class="sc">|&gt;</span> </span>
<span id="cb40-20"><a href="#cb40-20"></a>  <span class="co"># Add city and state then convert to upper case so that `count()` will not </span></span>
<span id="cb40-21"><a href="#cb40-21"></a>  <span class="co"># treat identical addresses as different because of different cases, e.g. </span></span>
<span id="cb40-22"><a href="#cb40-22"></a>  <span class="co"># 'ST' vs 'St' as abbreviations for 'Street'</span></span>
<span id="cb40-23"><a href="#cb40-23"></a>  <span class="fu">mutate</span>(<span class="at">address =</span> <span class="fu">str_to_upper</span>(<span class="fu">str_glue</span>(<span class="st">"{address}, CHICAGO, IL"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb40-24"><a href="#cb40-24"></a>  <span class="co"># Select only the address column, since we won't send the other columns to the</span></span>
<span id="cb40-25"><a href="#cb40-25"></a>  <span class="co"># geocoding function</span></span>
<span id="cb40-26"><a href="#cb40-26"></a>  <span class="fu">select</span>(address) <span class="sc">|&gt;</span> </span>
<span id="cb40-27"><a href="#cb40-27"></a>  <span class="co"># Find all the unique rows in the data</span></span>
<span id="cb40-28"><a href="#cb40-28"></a>  <span class="fu">distinct</span>(address)</span>
<span id="cb40-29"><a href="#cb40-29"></a></span>
<span id="cb40-30"><a href="#cb40-30"></a><span class="fu">head</span>(addresses_for_geocoding)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>
── Column specification ────────────────────────────────────────────────────────
cols(
  offense_date = col_datetime(format = ""),
  location_type = col_character(),
  address = col_character()
)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 6 × 1
  address                         
  &lt;chr&gt;                           
1 2400 W CARMEN AVE, CHICAGO, IL  
2 2700 S TRIPP AVE, CHICAGO, IL   
3 3700 S PAULINA ST, CHICAGO, IL  
4 1100 S HAMILTON AVE, CHICAGO, IL
5 8200 S HALSTED ST, CHICAGO, IL  
6 1300 N HUDSON AVE, CHICAGO, IL  </code></pre>
</div>
</div>
<p>Since two addresses in the data were duplicates and one address was missing, we now have eight unique addresses, stored in a tibble with a single column. We can use this as the input to the <code>geocode()</code> function from the tidygeocoder package. The <code>address</code> argument specifies which column in the data contains the addresses and the <code>method</code> column specifies which geocoding service to use. In this case we use the Nominatim service (because it does not require registration and works worldwide). Nominatim is based on OpenStreetMap data, so can be chosen by specifying <code>method = "osm"</code>.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb43" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>addresses_geocoded <span class="ot">&lt;-</span> tidygeocoder<span class="sc">::</span><span class="fu">geocode</span>(</span>
<span id="cb43-2"><a href="#cb43-2"></a>  addresses_for_geocoding, </span>
<span id="cb43-3"><a href="#cb43-3"></a>  <span class="at">address =</span> <span class="st">"address"</span>, </span>
<span id="cb43-4"><a href="#cb43-4"></a>  <span class="at">method =</span> <span class="st">"osm"</span></span>
<span id="cb43-5"><a href="#cb43-5"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Passing 8 addresses to the Nominatim single address geocoder</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Query completed in: 8.4 seconds</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb46" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>addresses_geocoded</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 8 × 3
  address                             lat  long
  &lt;chr&gt;                             &lt;dbl&gt; &lt;dbl&gt;
1 2400 W CARMEN AVE, CHICAGO, IL     42.0 -87.7
2 2700 S TRIPP AVE, CHICAGO, IL      41.8 -87.7
3 3700 S PAULINA ST, CHICAGO, IL     41.8 -87.7
4 1100 S HAMILTON AVE, CHICAGO, IL   41.9 -87.7
5 8200 S HALSTED ST, CHICAGO, IL     41.7 -87.6
6 1300 N HUDSON AVE, CHICAGO, IL     41.9 -87.6
7 6200 N CLAREMONT AVE, CHICAGO, IL  42.0 -87.7
8 9500 S BELL AVE, CHICAGO, IL       41.7 -87.7</code></pre>
</div>
</div>
<p>Now that we have the latitude and longitude for each address, we can join that back to the original data using the address column to match the two datasets together. To do this we will create a temporary column in the original <code>addresses</code> object that matches the formatting changes we made to the original address.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb48" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>addresses_final <span class="ot">&lt;-</span> addresses <span class="sc">|&gt;</span> </span>
<span id="cb48-2"><a href="#cb48-2"></a>  <span class="co"># Create a temporary address column to use in matching the geocoded addresses</span></span>
<span id="cb48-3"><a href="#cb48-3"></a>  <span class="fu">mutate</span>(<span class="at">temp_address =</span> <span class="fu">str_to_upper</span>(<span class="fu">str_glue</span>(<span class="st">"{address}, CHICAGO, IL"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb48-4"><a href="#cb48-4"></a>  <span class="co"># `left_join()` keeps all the rows in the left-hand dataset (the original</span></span>
<span id="cb48-5"><a href="#cb48-5"></a>  <span class="co"># `addresses` object) and matching rows in the right-hand dataset (the </span></span>
<span id="cb48-6"><a href="#cb48-6"></a>  <span class="co"># geocoding results)</span></span>
<span id="cb48-7"><a href="#cb48-7"></a>  <span class="fu">left_join</span>(addresses_geocoded, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"temp_address"</span> <span class="ot">=</span> <span class="st">"address"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb48-8"><a href="#cb48-8"></a>  <span class="co"># Remove the temporary address column</span></span>
<span id="cb48-9"><a href="#cb48-9"></a>  <span class="fu">select</span>(<span class="sc">-</span>temp_address)</span>
<span id="cb48-10"><a href="#cb48-10"></a></span>
<span id="cb48-11"><a href="#cb48-11"></a>addresses_final</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 10 × 5
   offense_date        location_type address                lat  long
   &lt;dttm&gt;              &lt;chr&gt;         &lt;chr&gt;                &lt;dbl&gt; &lt;dbl&gt;
 1 2019-01-01 00:00:00 residence     2400 W Carmen Ave     42.0 -87.7
 2 2019-01-01 00:00:00 residence     2700 S TRIPP AVE      41.8 -87.7
 3 2019-01-01 11:44:00 residence     3700 S PAULINA ST     41.8 -87.7
 4 2019-01-01 11:44:00 residence     3700 S Paulina St     41.8 -87.7
 5 2019-01-01 16:37:00 government    1100 S HAMILTON AVE   41.9 -87.7
 6 2019-01-02 17:09:00 gas station   &lt;NA&gt;                  NA    NA  
 7 2019-01-02 17:09:00 gas station   8200 S HALSTED ST     41.7 -87.6
 8 2019-01-05 00:01:00 residence     1300 N HUDSON AVE     41.9 -87.6
 9 2019-01-05 14:00:00 other         6200 N Claremont Ave  42.0 -87.7
10 2019-01-07 06:50:00 residence     9500 S BELL AVE       41.7 -87.7</code></pre>
</div>
</div>
<p>We can now use this data as we would any other spatial data. We would often start by converting our new object to an SF object using <code>st_as_sf()</code>. In that case, remember that all the geocoding services return co-ordinates as latitude and longitude using the WGS84 co-ordinate reference system, so you should use EPSG:4326.</p>
</section>
<section id="conflicts-between-function-names" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="conflicts-between-function-names"><span class="header-section-number">12.5</span> Conflicts between function names</h2>
<p>R packages are written by experts in different types of data analysis. This means we can use R to conduct all sorts of analysis, including cutting-edge techniques. But because R packages are not all written by people working for a single organisation, it means there can sometimes be functions from different packages that have the same name – often because they do similar (but not necessarily identical) things.</p>
<p>This can be a problem because R might be running a function from one package when you think you have written code that uses a function from another package. If the two functions have different arguments or produce different types of result, your code is unlikely to run properly. For example, if two functions have the same name but one produces an SF object while the other produces a tibble, that might cause problems later in your code if you are using other functions that expect to receive a particular type of input.</p>
<p>One example of functions from two different packages with the same name is the <code>geocode()</code> function. We have already learned that the tidygeocoder package contains a function called <code>geocode()</code>, but the ggmap package (for example) also has a function called <code>geocode()</code>.</p>
<p>If both the tidygeocoder and ggmap packages are loaded, R will use the <code>geocode()</code> function <em>from the package that has been loaded most recently</em>. So if your script includes the code:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb50" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggmap, tidygeocoder)</span>
<span id="cb50-2"><a href="#cb50-2"></a></span>
<span id="cb50-3"><a href="#cb50-3"></a><span class="co"># [Code to load data, etc.]</span></span>
<span id="cb50-4"><a href="#cb50-4"></a></span>
<span id="cb50-5"><a href="#cb50-5"></a><span class="co"># Geocode some data</span></span>
<span id="cb50-6"><a href="#cb50-6"></a>geocoded_data <span class="ot">&lt;-</span> <span class="fu">geocode</span>(ungeocoded_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Then R will use the <code>geocode()</code> function from tidygeocoder, since that was loaded <em>after</em> ggmap. But if you reverse the order in which these packages are loaded:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb51" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidygeocoder, ggmap)</span>
<span id="cb51-2"><a href="#cb51-2"></a></span>
<span id="cb51-3"><a href="#cb51-3"></a><span class="co"># [Code to load data, etc.]</span></span>
<span id="cb51-4"><a href="#cb51-4"></a></span>
<span id="cb51-5"><a href="#cb51-5"></a><span class="co"># Geocode some data</span></span>
<span id="cb51-6"><a href="#cb51-6"></a>geocoded_data <span class="ot">&lt;-</span> <span class="fu">geocode</span>(ungeocoded_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Then R will use the <code>geocode()</code> function from ggmap because that package was loaded after tidygeocoder.</p>
<p>Knowing which of the two functions R uses when you type <code>geocode()</code> is important because they accept different inputs. The <code>geocode()</code> function from ggmap expects the first argument to contain a vector of addresses, while the <code>geocode()</code> function from tidygeocoder expects a data frame or tibble. If you provide the wrong type of input, either function will produce an error.</p>
<p>Our R scripts very often load the tidyverse package, which loads nine packages (dplyr, forcats, ggplot2, lubridate, purrr, readr, tibble, tidyr and stringr) that we often need to use. Since we more commonly want the tidyverse functions than the functions they mask (for example, we frequently use the <code>filter()</code> function from dplyr but rarely use the function with the same name in the stats package), it is common to load tidyverse after loading all the other packages needed for our code.</p>
<p>There are several ways you can resolve conflicts between functions from different packages:</p>
<ul>
<li>Make sure you load packages in the order that gives you access to the functions you need. This can be simple if there are few conflicts, but can fall apart if you later change your code to load different packages. This is the option that almost everyone uses most of the time (and most people use all of the time).</li>
<li>Specify which function you want to use using the <code>::</code> notation that we have already used in previous chapters, e.g.&nbsp;by using the code <code>ggmap::geocode()</code> or <code>tidygeocoder::geocode()</code>.</li>
<li>Load the <code>conflicted</code> package, which produces an error whenever you try to use a function that is included in more than one loaded package. This makes it easy to know when there is a potential conflict, which you can then resolve using the <code>conflict_prefer()</code> function. Note, however, that you have to load the conflicted package by adding <code>library(conflicted)</code> to your script file <em>before</em> you call <code>pacman::p_load()</code>.</li>
</ul>
<p>In this final option, the authors of the <code>conflicted</code> package recommend that you specify which conflict-prone functions to use by calling <code>conflict_prefer()</code> just after you’ve loaded all the packages you need for your script. For example:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R Console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb52" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># This code produces several conflicts:</span></span>
<span id="cb52-2"><a href="#cb52-2"></a><span class="co"># *  the `stats` package, which is loaded automatically in the background when </span></span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="co">#    you start R, contains a function called `filter()`</span></span>
<span id="cb52-4"><a href="#cb52-4"></a><span class="co"># *  `MASS` contains a function called `select()`</span></span>
<span id="cb52-5"><a href="#cb52-5"></a><span class="co"># *  `dplyr` contains functions called `filter()` and `select()`</span></span>
<span id="cb52-6"><a href="#cb52-6"></a><span class="fu">library</span>(conflicted)</span>
<span id="cb52-7"><a href="#cb52-7"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(dplyr, MASS)</span>
<span id="cb52-8"><a href="#cb52-8"></a></span>
<span id="cb52-9"><a href="#cb52-9"></a><span class="co"># This code specifies that in the case of both conflicts, we want to use the</span></span>
<span id="cb52-10"><a href="#cb52-10"></a><span class="co"># functions from `dplyr`</span></span>
<span id="cb52-11"><a href="#cb52-11"></a><span class="fu">conflict_prefer</span>(<span class="st">"select"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb52-12"><a href="#cb52-12"></a><span class="fu">conflict_prefer</span>(<span class="st">"filter"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb52-13"><a href="#cb52-13"></a></span>
<span id="cb52-14"><a href="#cb52-14"></a><span class="co"># In the rest of this script, any reference to `filter()` or `select()` will</span></span>
<span id="cb52-15"><a href="#cb52-15"></a><span class="co"># use the functions with those names in the `dplyr` package, not those from</span></span>
<span id="cb52-16"><a href="#cb52-16"></a><span class="co"># `stats` or `MASS`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Understanding function-name conflicts is important because they can be the cause of errors that are (for reasons we needn’t explain in detail) extremely hard to track down the cause of. So make sure that when you load packages, you take note of any messages in the console that warn you that functions have been masked. As with other messages in R, they will not always need you to take any action, but you always need to read the message and make a decision about whether to take any action.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Load tidyverse last
</div>
</div>
<div class="callout-body-container callout-body">
<p>One way to minimise how confusing package conflicts can be is to always load packages in a consistent order. I strongly recommend loading packages in alphabetical order, <em>then</em> loading the tidyverse package <em>last</em>.</p>
</div>
</div>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Package conflicts
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>If you load two packages in R that both contain a function with the same name, which function will R use by default?</strong></p>
<div id="radio_DXLBKZFDUX" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_DXLBKZFDUX" value=""> <span>The function that is from the <code>tidyverse</code> suite of packages.</span></label><label><input type="radio" autocomplete="off" name="radio_DXLBKZFDUX" value=""> <span>The function from the package that was loaded <em>first</em></span></label><label><input type="radio" autocomplete="off" name="radio_DXLBKZFDUX" value="answer"> <span>The function from the package that was loaded <em>last</em></span></label><label><input type="radio" autocomplete="off" name="radio_DXLBKZFDUX" value=""> <span>Neither function will run because R will produce an error.</span></label>
</div>
</div>
</div>
</section>
<section id="in-summary" class="level2" data-number="12.6">
<h2 data-number="12.6" class="anchored" data-anchor-id="in-summary"><span class="header-section-number">12.6</span> In summary</h2>
<p>In this chapter we have learned to tidy messy data to make it easier to work with. In real-world data analysis (not just crime mapping), you will often have to deal with data that is messy in different ways. Fortunately, you can use R to fix all of these problems in a way that minimises the risk that you might introduce mistakes when you clean the data.</p>
<div class="box reading">
<p>You can find out more about data cleaning and tidying with these resources:</p>
<ul>
<li>A <a href="https://tidyr.tidyverse.org/articles/pivot.html">tutorial on using the <code>pivot_longer()</code> and <code>pivot_wider()</code> functions to convert data between long and wide format</a>.</li>
<li>A more-detailed <a href="https://jessecambon.github.io/tidygeocoder/articles/tidygeocoder.html">Introduction to <code>tidygeocoder</code></a>.</li>
<li>An <a href="https://rfortherestofus.com/2019/12/how-to-clean-messy-data-in-r/">introduction to some other packages than can help you clean and tidy data</a>.</li>
<li>A more-detailed <a href="https://conflicted.r-lib.org/">description of how to use the <code>conflicted</code> package</a>.</li>
</ul>
</div>
<div class="callout callout-style-default callout-quiz callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Check your knowledge: Revision questions
</div>
</div>
<div class="callout-body-container callout-body">
<p>Answer these questions to check you have understood the main points covered in this chapter. Write between 50 and 100 words to answer each question.</p>
<ol type="1">
<li>Why is tidy data important in crime mapping and data analysis? Explain the key principles of tidy data and discuss how its structure makes data analysis more efficient.</li>
<li>What are the differences between long and wide data formats?</li>
<li>Describe how multiple variables stored in a single column can be separated into distinct columns, and what issues might arise in doing this.</li>
<li>Why do missing values in a dataset cause problems, and how can they be handled in R?</li>
<li>What are function name conflicts in R, and how can they be resolved?</li>
</ol>
</div>
</div>
<p class="full-width-image">
<img src="../images/tidydata_7.jpg" alt="Cartoon saying make friends with tidy data!">
</p>
<div class="credits">
<p><a href="https://twitter.com/allison_horst">Artwork by <span class="citation" data-cites="allison_horst">@allison_horst</span></a></p>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";
  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    btn.onclick = check_func;
    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../11_mapping_hotspots/index.html" class="pagination-link" aria-label="Mapping hotspots">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../13_crime_series/index.html" class="pagination-link" aria-label="Mapping crime series">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Mapping crime series</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb53" data-shortcodes="false" data-code-line-numbers=""><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb53-1"><a href="#cb53-1"></a><span class="fu"># Handling messy data {#sec-messy-data}</span></span>
<span id="cb53-2"><a href="#cb53-2"></a></span>
<span id="cb53-3"><a href="#cb53-3"></a></span>
<span id="cb53-4"><a href="#cb53-4"></a>::: {.abstract}</span>
<span id="cb53-5"><a href="#cb53-5"></a>Data is at the core of crime mapping, but it is not always provided in a clean and structured format. This chapter introduces the challenges of working with messy data and provides practical techniques to tidy and prepare datasets for analysis in R. Topics covered include restructuring data, dealing with missing values, separating and merging variables, and resolving inconsistencies. By learning these skills, you will be able to transform raw crime data into a format suitable for mapping and other analysis.</span>
<span id="cb53-6"><a href="#cb53-6"></a>:::</span>
<span id="cb53-7"><a href="#cb53-7"></a></span>
<span id="cb53-8"><a href="#cb53-8"></a></span>
<span id="cb53-9"><a href="#cb53-9"></a>::: {.callout-tip}</span>
<span id="cb53-10"><a href="#cb53-10"></a><span class="fu">#### Before you start</span></span>
<span id="cb53-11"><a href="#cb53-11"></a></span>
<span id="cb53-12"><a href="#cb53-12"></a>Open RStudio or -- if you already have RStudio open -- click <span class="in">`Session`</span> then <span class="in">`Restart R`</span>. Make sure you're working inside the Crime Mapping RStudio project you created in @sec-create-project, then you're ready to start mapping.</span>
<span id="cb53-13"><a href="#cb53-13"></a>:::</span>
<span id="cb53-14"><a href="#cb53-14"></a></span>
<span id="cb53-15"><a href="#cb53-15"></a></span>
<span id="cb53-16"><a href="#cb53-16"></a></span>
<span id="cb53-17"><a href="#cb53-17"></a><span class="fu">## Introduction</span></span>
<span id="cb53-18"><a href="#cb53-18"></a></span>
<span id="cb53-19"><a href="#cb53-19"></a>Data is the foundation of everything we do in crime mapping. To make a crime map needs data on the locations and types of crimes; data on roads, buildings and natural features to make up a base map, and data on other features (such as particular types of facility) that might be relevant to why crime happens in particular place.</span>
<span id="cb53-20"><a href="#cb53-20"></a></span>
<span id="cb53-21"><a href="#cb53-21"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/tidydata_1.jpg" alt="Cartoon explaining that tidy data is a standard way of mapping the meaning of a dataset to its structure. In tidy data each variable forms a column, each observation forms a row and each cell is a single measurement."&gt;&lt;/p&gt;</span>
<span id="cb53-22"><a href="#cb53-22"></a></span>
<span id="cb53-23"><a href="#cb53-23"></a>Until now, all the data we have used has been *tidy data*. Data is tidy if it comes in a particular format where every *variable* (e.g. the date on which a crime occurred) is stored in a separate *column* and data for every *observation* (e.g. all the data about a particular crime, a particular offender etc.) is stored in a separate *row*. For typical crime data, that means each crime is represented by one row in the data and each thing that we know about that crime is stored in a separate column.</span>
<span id="cb53-24"><a href="#cb53-24"></a></span>
<span id="cb53-25"><a href="#cb53-25"></a>Unfortunately, not all the data we might like to use in crime mapping is available in a tidy format. The people, organisations and systems and produce data store it in many formats, which are often not tidy and not easy to analyse. Messy data is more difficult to work with because every messy dataset has a unique structure, which we have to remember every time we want to work with it.</span>
<span id="cb53-26"><a href="#cb53-26"></a></span>
<span id="cb53-27"><a href="#cb53-27"></a>Tidy data, on the other hand, is easier to work with because its format is familiar and consistent. Many R functions are also designed to work with tidy data, so tidying our datasets often makes analysis quicker, too.</span>
<span id="cb53-28"><a href="#cb53-28"></a></span>
<span id="cb53-29"><a href="#cb53-29"></a>The first step to analysing messy data is therefore to wrangle it into a tidy format. We have already seen this principle at work when we use the <span class="in">`clean_names()`</span> function from the janitor package to convert column names into a consistent format so that we don't have to keep remembering which unique format the column names are in.</span>
<span id="cb53-30"><a href="#cb53-30"></a></span>
<span id="cb53-31"><a href="#cb53-31"></a>In this chapter we will learn how to tidy messy data to make it easier to work with. To do that, we will create a series of 'toy' datasets we can work with. To do this we will use the <span class="in">`tibble()`</span> and <span class="in">`tribble()`</span> functions from the tibble package, which is part of the tidyverse.</span>
<span id="cb53-32"><a href="#cb53-32"></a></span>
<span id="cb53-33"><a href="#cb53-33"></a></span>
<span id="cb53-34"><a href="#cb53-34"></a>::: {.callout-quiz .callout}</span>
<span id="cb53-35"><a href="#cb53-35"></a><span class="fu">#### Tidy data</span></span>
<span id="cb53-36"><a href="#cb53-36"></a></span>
<span id="cb53-37"><a href="#cb53-37"></a><span class="in">```{r tidy-data-quiz}</span></span>
<span id="cb53-38"><a href="#cb53-38"></a><span class="in">#| echo: false</span></span>
<span id="cb53-39"><a href="#cb53-39"></a></span>
<span id="cb53-40"><a href="#cb53-40"></a><span class="in">tidy_data_quiz1 &lt;- c(</span></span>
<span id="cb53-41"><a href="#cb53-41"></a><span class="in">  "It minimizes the number of columns in a dataset",</span></span>
<span id="cb53-42"><a href="#cb53-42"></a><span class="in">  "It ensures all data is stored as character strings",</span></span>
<span id="cb53-43"><a href="#cb53-43"></a><span class="in">  answer = "It follows a consistent structure that makes analysis easier",</span></span>
<span id="cb53-44"><a href="#cb53-44"></a><span class="in">  "It eliminates the need for data wrangling"</span></span>
<span id="cb53-45"><a href="#cb53-45"></a><span class="in">)</span></span>
<span id="cb53-46"><a href="#cb53-46"></a></span>
<span id="cb53-47"><a href="#cb53-47"></a><span class="in">tidy_data_quiz2 &lt;- c(</span></span>
<span id="cb53-48"><a href="#cb53-48"></a><span class="in">  "Each column contains multiple variables",</span></span>
<span id="cb53-49"><a href="#cb53-49"></a><span class="in">  answer = "Each row represents a single observation",</span></span>
<span id="cb53-50"><a href="#cb53-50"></a><span class="in">  "Column names are always numeric",</span></span>
<span id="cb53-51"><a href="#cb53-51"></a><span class="in">  "The data must be stored in alphabetical order"</span></span>
<span id="cb53-52"><a href="#cb53-52"></a><span class="in">)</span></span>
<span id="cb53-53"><a href="#cb53-53"></a></span>
<span id="cb53-54"><a href="#cb53-54"></a><span class="in">tidy_data_quiz3 &lt;- c(</span></span>
<span id="cb53-55"><a href="#cb53-55"></a><span class="in">  answer = "Data producers often structure it for human readability rather than analysis",</span></span>
<span id="cb53-56"><a href="#cb53-56"></a><span class="in">  "All government datasets are always tidy by default",</span></span>
<span id="cb53-57"><a href="#cb53-57"></a><span class="in">  "R requires data to be stored in JSON format",</span></span>
<span id="cb53-58"><a href="#cb53-58"></a><span class="in">  "Messy data is a requirement for proper statistical analysis"</span></span>
<span id="cb53-59"><a href="#cb53-59"></a><span class="in">)</span></span>
<span id="cb53-60"><a href="#cb53-60"></a><span class="in">```</span></span>
<span id="cb53-61"><a href="#cb53-61"></a></span>
<span id="cb53-62"><a href="#cb53-62"></a></span>
<span id="cb53-63"><a href="#cb53-63"></a>**Why is tidy data preferred for analysis in R?**</span>
<span id="cb53-64"><a href="#cb53-64"></a></span>
<span id="cb53-65"><a href="#cb53-65"></a><span class="in">`r webexercises::longmcq(tidy_data_quiz1)`</span></span>
<span id="cb53-66"><a href="#cb53-66"></a></span>
<span id="cb53-67"><a href="#cb53-67"></a></span>
<span id="cb53-68"><a href="#cb53-68"></a>**What is a characteristic of tidy data?**</span>
<span id="cb53-69"><a href="#cb53-69"></a></span>
<span id="cb53-70"><a href="#cb53-70"></a><span class="in">`r webexercises::longmcq(tidy_data_quiz2)`</span></span>
<span id="cb53-71"><a href="#cb53-71"></a></span>
<span id="cb53-72"><a href="#cb53-72"></a></span>
<span id="cb53-73"><a href="#cb53-73"></a>**Why might a dataset be messy when obtained from an external source?**</span>
<span id="cb53-74"><a href="#cb53-74"></a></span>
<span id="cb53-75"><a href="#cb53-75"></a><span class="in">`r webexercises::longmcq(tidy_data_quiz3)`</span></span>
<span id="cb53-76"><a href="#cb53-76"></a></span>
<span id="cb53-77"><a href="#cb53-77"></a>:::</span>
<span id="cb53-78"><a href="#cb53-78"></a></span>
<span id="cb53-79"><a href="#cb53-79"></a></span>
<span id="cb53-80"><a href="#cb53-80"></a><span class="fu">## Tidying the structure of data</span></span>
<span id="cb53-81"><a href="#cb53-81"></a></span>
<span id="cb53-82"><a href="#cb53-82"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/tidydata_2.jpg" alt="Cartoon explaining that the standard structure of tidy data means that all tidy datasets are alike but every messy dataset is messy in its own way."&gt;&lt;/p&gt;</span>
<span id="cb53-83"><a href="#cb53-83"></a></span>
<span id="cb53-84"><a href="#cb53-84"></a>Every messy dataset is messy in its own unique way, but often messiness comes from the structure of data not being tidy. Tabular data can come in two general formats: *long* and *wide*. For example, imagine a dataset showing counts of several different types of crime in several different areas. We could store this data in wide format, where there is a column for the name of the area and then a column for each type of crime.</span>
<span id="cb53-85"><a href="#cb53-85"></a></span>
<span id="cb53-86"><a href="#cb53-86"></a><span class="in">```{r wide-table}</span></span>
<span id="cb53-87"><a href="#cb53-87"></a><span class="in">#| echo: false</span></span>
<span id="cb53-88"><a href="#cb53-88"></a></span>
<span id="cb53-89"><a href="#cb53-89"></a><span class="in">tibble::tribble(</span></span>
<span id="cb53-90"><a href="#cb53-90"></a><span class="in">  ~area, ~assault, ~robbery, ~burglary,</span></span>
<span id="cb53-91"><a href="#cb53-91"></a><span class="in">  "Northville", 4, 2, 10,</span></span>
<span id="cb53-92"><a href="#cb53-92"></a><span class="in">  "Middletown", 6, 5, 20,</span></span>
<span id="cb53-93"><a href="#cb53-93"></a><span class="in">  "Southam", 10, 0, 10</span></span>
<span id="cb53-94"><a href="#cb53-94"></a><span class="in">) |&gt;  </span></span>
<span id="cb53-95"><a href="#cb53-95"></a><span class="in">  knitr::kable() |&gt; </span></span>
<span id="cb53-96"><a href="#cb53-96"></a><span class="in">  kableExtra::kable_styling(full_width = FALSE)</span></span>
<span id="cb53-97"><a href="#cb53-97"></a><span class="in">```</span></span>
<span id="cb53-98"><a href="#cb53-98"></a></span>
<span id="cb53-99"><a href="#cb53-99"></a>Wide-format data are often useful for presentation -- you might often see a table like this in a report or article. But wide data are less useful for analysis because one of the variables -- 'type of crime' -- is being stored not as a variable but in the various column names. One sign that your data has this problem is if several of the columns form a group of columns, separate from the others. In this case, there is a group of columns that show crime counts that is different from the other column that shows the area name.</span>
<span id="cb53-100"><a href="#cb53-100"></a></span>
<span id="cb53-101"><a href="#cb53-101"></a>Fortunately, we can easily convert this data (which is stored in the object <span class="in">`crime_counts`</span>) into long format using the <span class="in">`pivot_longer()`</span> function from the <span class="in">`tidyr`</span> package. To use <span class="in">`pivot_longer()`</span>, we have to specify in the <span class="in">`cols`</span> argument which columns we want to 'gather' together into one column to store the category names and one column to store the values. We can specify the columns we want to gather as a vector, i.e. <span class="in">`c(assault, burglary, robbery)`</span>.</span>
<span id="cb53-102"><a href="#cb53-102"></a></span>
<span id="cb53-105"><a href="#cb53-105"></a><span class="in">```{r}</span></span>
<span id="cb53-106"><a href="#cb53-106"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-107"><a href="#cb53-107"></a></span>
<span id="cb53-108"><a href="#cb53-108"></a><span class="co"># Load packages</span></span>
<span id="cb53-109"><a href="#cb53-109"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(janitor, readxl, sf, tidyverse)</span>
<span id="cb53-110"><a href="#cb53-110"></a></span>
<span id="cb53-111"><a href="#cb53-111"></a><span class="co"># Create a dataset of crime counts in 'wide' format</span></span>
<span id="cb53-112"><a href="#cb53-112"></a>crime_counts <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb53-113"><a href="#cb53-113"></a>  <span class="sc">~</span>area, <span class="sc">~</span>assault, <span class="sc">~</span>robbery, <span class="sc">~</span>burglary,</span>
<span id="cb53-114"><a href="#cb53-114"></a>  <span class="st">"Northville"</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">10</span>,</span>
<span id="cb53-115"><a href="#cb53-115"></a>  <span class="st">"Middletown"</span>, <span class="dv">6</span>, <span class="dv">5</span>, <span class="dv">20</span>,</span>
<span id="cb53-116"><a href="#cb53-116"></a>  <span class="st">"Southam"</span>, <span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">10</span></span>
<span id="cb53-117"><a href="#cb53-117"></a>)</span>
<span id="cb53-118"><a href="#cb53-118"></a></span>
<span id="cb53-119"><a href="#cb53-119"></a><span class="co"># Convert the dataset to 'long' format</span></span>
<span id="cb53-120"><a href="#cb53-120"></a><span class="fu">pivot_longer</span>(crime_counts, <span class="at">cols =</span> <span class="fu">c</span>(assault, burglary, robbery))</span>
<span id="cb53-121"><a href="#cb53-121"></a><span class="in">```</span></span>
<span id="cb53-122"><a href="#cb53-122"></a></span>
<span id="cb53-123"><a href="#cb53-123"></a>By default, <span class="in">`pivot_longer()`</span> calls the new column of category names <span class="in">`name`</span> and the new column of values <span class="in">`value`</span>. We can specify more-descriptive names using the <span class="in">`names_to`</span> and <span class="in">`values_to`</span> arguments.</span>
<span id="cb53-124"><a href="#cb53-124"></a></span>
<span id="cb53-127"><a href="#cb53-127"></a><span class="in">```{r}</span></span>
<span id="cb53-128"><a href="#cb53-128"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-129"><a href="#cb53-129"></a></span>
<span id="cb53-130"><a href="#cb53-130"></a><span class="co"># Convert dataset to 'long' format with custom column names</span></span>
<span id="cb53-131"><a href="#cb53-131"></a><span class="fu">pivot_longer</span>(</span>
<span id="cb53-132"><a href="#cb53-132"></a>  crime_counts, </span>
<span id="cb53-133"><a href="#cb53-133"></a>  <span class="at">cols =</span> <span class="fu">c</span>(assault, burglary, robbery), </span>
<span id="cb53-134"><a href="#cb53-134"></a>  <span class="at">names_to =</span> <span class="st">"type"</span>, </span>
<span id="cb53-135"><a href="#cb53-135"></a>  <span class="at">values_to =</span> <span class="st">"count"</span></span>
<span id="cb53-136"><a href="#cb53-136"></a>)</span>
<span id="cb53-137"><a href="#cb53-137"></a><span class="in">```</span></span>
<span id="cb53-138"><a href="#cb53-138"></a></span>
<span id="cb53-139"><a href="#cb53-139"></a>It is better to have the names of different categories stored as a single variable rather than as the names of several variables because they are easier to work with that way. For example, if the data are in long format you could sort the categories alphabetically using <span class="in">`arrange(crime_counts, type)`</span>, or you could transform the names to title case using <span class="in">`mutate(crime_counts, type = str_to_title(type))`</span>. Both these operations would be harder to do if the data were in wide format.</span>
<span id="cb53-140"><a href="#cb53-140"></a></span>
<span id="cb53-141"><a href="#cb53-141"></a>A common reason for data to be stored in wide format is where repeated observations are made of some value over time. For example, we might have monthly counts of crimes for different areas.</span>
<span id="cb53-142"><a href="#cb53-142"></a></span>
<span id="cb53-143"><a href="#cb53-143"></a></span>
<span id="cb53-144"><a href="#cb53-144"></a><span class="in">```{r monthly-table}</span></span>
<span id="cb53-145"><a href="#cb53-145"></a><span class="in">#| echo: false</span></span>
<span id="cb53-146"><a href="#cb53-146"></a></span>
<span id="cb53-147"><a href="#cb53-147"></a><span class="in">tribble(</span></span>
<span id="cb53-148"><a href="#cb53-148"></a><span class="in">  ~area, ~jan_2020, ~feb_2020, ~mar_2020, ~apr_2020, ~may_2020,</span></span>
<span id="cb53-149"><a href="#cb53-149"></a><span class="in">  "Northville", 13, 10, 12, 9, 10,</span></span>
<span id="cb53-150"><a href="#cb53-150"></a><span class="in">  "Middletown", 21, 19, 22, 19, 20,</span></span>
<span id="cb53-151"><a href="#cb53-151"></a><span class="in">  "Southam", 15, 13, 16, 15, 14</span></span>
<span id="cb53-152"><a href="#cb53-152"></a><span class="in">) |&gt;  </span></span>
<span id="cb53-153"><a href="#cb53-153"></a><span class="in">  knitr::kable() |&gt; </span></span>
<span id="cb53-154"><a href="#cb53-154"></a><span class="in">  kableExtra::kable_styling(full_width = FALSE)</span></span>
<span id="cb53-155"><a href="#cb53-155"></a><span class="in">```</span></span>
<span id="cb53-156"><a href="#cb53-156"></a></span>
<span id="cb53-157"><a href="#cb53-157"></a>Storing data in this way is particularly awkward because variable names can only contain text, so R does not know that the column names represent dates. This means, for example, that we could not filter the dataset to only include data from after a certain date.</span>
<span id="cb53-158"><a href="#cb53-158"></a></span>
<span id="cb53-159"><a href="#cb53-159"></a>When we want to gather a large number of columns together, it can get tedious to type all the column names for the <span class="in">`cols`</span> argument to <span class="in">`pivot_longer()`</span>. Instead, since we want to gather all the columns except one, we can just specify that we should *not* gather the <span class="in">`area`</span> column, which implicitly tells <span class="in">`pivot_longer()`</span> to gather all the other columns. We tell <span class="in">`pivot_longer()`</span> not to gather the area column by specifying <span class="in">`cols = -area`</span> (note the minus sign in front of the column name). </span>
<span id="cb53-160"><a href="#cb53-160"></a></span>
<span id="cb53-161"><a href="#cb53-161"></a></span>
<span id="cb53-164"><a href="#cb53-164"></a><span class="in">```{r}</span></span>
<span id="cb53-165"><a href="#cb53-165"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-166"><a href="#cb53-166"></a></span>
<span id="cb53-167"><a href="#cb53-167"></a><span class="co"># Create a dataset of monthly crime counts in wide format</span></span>
<span id="cb53-168"><a href="#cb53-168"></a>monthly_counts <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb53-169"><a href="#cb53-169"></a>  <span class="sc">~</span>area, <span class="sc">~</span>jan_2020, <span class="sc">~</span>feb_2020, <span class="sc">~</span>mar_2020, <span class="sc">~</span>apr_2020, <span class="sc">~</span>may_2020,</span>
<span id="cb53-170"><a href="#cb53-170"></a>  <span class="st">"Northville"</span>, <span class="dv">13</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">9</span>, <span class="dv">10</span>,</span>
<span id="cb53-171"><a href="#cb53-171"></a>  <span class="st">"Middletown"</span>, <span class="dv">21</span>, <span class="dv">19</span>, <span class="dv">22</span>, <span class="dv">19</span>, <span class="dv">20</span>,</span>
<span id="cb53-172"><a href="#cb53-172"></a>  <span class="st">"Southam"</span>, <span class="dv">15</span>, <span class="dv">13</span>, <span class="dv">16</span>, <span class="dv">15</span>, <span class="dv">14</span></span>
<span id="cb53-173"><a href="#cb53-173"></a>)</span>
<span id="cb53-174"><a href="#cb53-174"></a></span>
<span id="cb53-175"><a href="#cb53-175"></a><span class="co"># Convert dataset to 'long' format with custom column names</span></span>
<span id="cb53-176"><a href="#cb53-176"></a><span class="fu">pivot_longer</span>(</span>
<span id="cb53-177"><a href="#cb53-177"></a>  monthly_counts, </span>
<span id="cb53-178"><a href="#cb53-178"></a>  <span class="at">cols =</span> <span class="sc">-</span>area, </span>
<span id="cb53-179"><a href="#cb53-179"></a>  <span class="at">names_to =</span> <span class="st">"month"</span>, </span>
<span id="cb53-180"><a href="#cb53-180"></a>  <span class="at">values_to =</span> <span class="st">"count"</span></span>
<span id="cb53-181"><a href="#cb53-181"></a>)</span>
<span id="cb53-182"><a href="#cb53-182"></a><span class="in">```</span></span>
<span id="cb53-183"><a href="#cb53-183"></a></span>
<span id="cb53-184"><a href="#cb53-184"></a></span>
<span id="cb53-185"><a href="#cb53-185"></a>There is still a problem with this data, which is that the <span class="in">`month`</span> variable contains not date values but instead the month and year stored as text. We will learn how to deal with that issue in @sec-mapping-time.</span>
<span id="cb53-186"><a href="#cb53-186"></a></span>
<span id="cb53-187"><a href="#cb53-187"></a></span>
<span id="cb53-188"><a href="#cb53-188"></a><span class="fu">### Skipping unwanted rows in imported data</span></span>
<span id="cb53-189"><a href="#cb53-189"></a></span>
<span id="cb53-190"><a href="#cb53-190"></a>Data released by government organisations are often designed to be viewed by humans rather than processed by statistical software. We can see this in this screen shot of a <span class="co">[</span><span class="ot">dataset produced by the UK Office for National Statistics on cybercrime in the UK</span><span class="co">](https://www.ons.gov.uk/peoplepopulationandcommunity/crimeandjustice/datasets/crimeinenglandandwalesexperimentaltables)</span> based on responses to the Crime Survey for England and Wales.</span>
<span id="cb53-191"><a href="#cb53-191"></a></span>
<span id="cb53-192"><a href="#cb53-192"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/ons_data1.png" alt="Screen shot of an Excel sheet of data from the UK Office for National Statistics, showing that there are multiple header rows above the data and blank rows within the data."&gt;&lt;/p&gt;</span>
<span id="cb53-193"><a href="#cb53-193"></a></span>
<span id="cb53-194"><a href="#cb53-194"></a>Looking at the row numbers on the left-hand side, we can see that the that the first row is taken up not with the column names (as in a tidy dataset) but with the title of the dataset. The next row is blank, and the third row then contains some metadata to say that the data relates to England and Wales and to adults aged 16 and over. Only on row four do we see the column names. There are also blank rows within the data that are used to separate out different categories of data.</span>
<span id="cb53-195"><a href="#cb53-195"></a></span>
<span id="cb53-196"><a href="#cb53-196"></a>If we try to import this data using, for example, the <span class="in">`read_excel()`</span> function from the <span class="in">`readxl`</span> package, we will find various problems.</span>
<span id="cb53-197"><a href="#cb53-197"></a></span>
<span id="cb53-200"><a href="#cb53-200"></a><span class="in">```{r}</span></span>
<span id="cb53-201"><a href="#cb53-201"></a><span class="co">#| eval: false</span></span>
<span id="cb53-202"><a href="#cb53-202"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-203"><a href="#cb53-203"></a></span>
<span id="cb53-204"><a href="#cb53-204"></a><span class="co"># Since `.xlsx` files are binary files, we need to add `mode = "wb"` on Windows.</span></span>
<span id="cb53-205"><a href="#cb53-205"></a><span class="co"># On other platforms it makes no difference, but adding `mode = "wb" does not</span></span>
<span id="cb53-206"><a href="#cb53-206"></a><span class="co"># cause any problems.</span></span>
<span id="cb53-207"><a href="#cb53-207"></a><span class="fu">download.file</span>(</span>
<span id="cb53-208"><a href="#cb53-208"></a>  <span class="at">url =</span> <span class="st">"https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/crimeandjustice/datasets/crimeinenglandandwalesexperimentaltables/yearendingdecember2018/additionalfraudandcybercrimetablesyearendingdecember2018correction.xlsx"</span>,</span>
<span id="cb53-209"><a href="#cb53-209"></a>  <span class="at">destfile =</span> <span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>),</span>
<span id="cb53-210"><a href="#cb53-210"></a>  <span class="at">mode =</span> <span class="st">"wb"</span></span>
<span id="cb53-211"><a href="#cb53-211"></a>)</span>
<span id="cb53-212"><a href="#cb53-212"></a></span>
<span id="cb53-213"><a href="#cb53-213"></a><span class="fu">read_excel</span>(<span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>), <span class="at">sheet =</span> <span class="st">"Table E1"</span>)</span>
<span id="cb53-214"><a href="#cb53-214"></a><span class="in">```</span></span>
<span id="cb53-215"><a href="#cb53-215"></a></span>
<span id="cb53-216"><a href="#cb53-216"></a></span>
<span id="cb53-219"><a href="#cb53-219"></a><span class="in">```{r}</span></span>
<span id="cb53-220"><a href="#cb53-220"></a><span class="co">#| echo: false</span></span>
<span id="cb53-221"><a href="#cb53-221"></a></span>
<span id="cb53-222"><a href="#cb53-222"></a><span class="fu">read_excel</span>(<span class="st">"www/cybercrime.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Table E1"</span>)</span>
<span id="cb53-223"><a href="#cb53-223"></a><span class="in">```</span></span>
<span id="cb53-224"><a href="#cb53-224"></a></span>
<span id="cb53-225"><a href="#cb53-225"></a></span>
<span id="cb53-226"><a href="#cb53-226"></a>It's clear that this dataset has not loaded in the way that we want, because the first row doesn't contain the column names. Fortunately, we can deal with this problem using the <span class="in">`skip`</span> argument to the <span class="in">`read_excel()`</span> function. This allows us to specify a number of rows to ignore at the start of the dataset. In this case, we want to ignore the first three rows of the data (the table title, a blank line and the the metadata line), so we can specify <span class="in">`skip = 3`</span>. The same <span class="in">`skip`</span> argument also exists in the <span class="in">`read_csv()`</span> function for reading CSV data and the <span class="in">`read_tsv()`</span> function for reading tab-separated data.</span>
<span id="cb53-227"><a href="#cb53-227"></a></span>
<span id="cb53-228"><a href="#cb53-228"></a></span>
<span id="cb53-231"><a href="#cb53-231"></a><span class="in">```{r}</span></span>
<span id="cb53-232"><a href="#cb53-232"></a><span class="co">#| eval: false</span></span>
<span id="cb53-233"><a href="#cb53-233"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-234"><a href="#cb53-234"></a></span>
<span id="cb53-235"><a href="#cb53-235"></a><span class="fu">read_excel</span>(</span>
<span id="cb53-236"><a href="#cb53-236"></a>  <span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>), </span>
<span id="cb53-237"><a href="#cb53-237"></a>  <span class="at">sheet =</span> <span class="st">"Table E1"</span>, </span>
<span id="cb53-238"><a href="#cb53-238"></a>  <span class="at">skip =</span> <span class="dv">3</span></span>
<span id="cb53-239"><a href="#cb53-239"></a>)</span>
<span id="cb53-240"><a href="#cb53-240"></a><span class="in">```</span></span>
<span id="cb53-241"><a href="#cb53-241"></a></span>
<span id="cb53-242"><a href="#cb53-242"></a></span>
<span id="cb53-245"><a href="#cb53-245"></a><span class="in">```{r}</span></span>
<span id="cb53-246"><a href="#cb53-246"></a><span class="co">#| echo: false</span></span>
<span id="cb53-247"><a href="#cb53-247"></a></span>
<span id="cb53-248"><a href="#cb53-248"></a><span class="fu">read_excel</span>(<span class="st">"www/cybercrime.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Table E1"</span>, <span class="at">skip =</span> <span class="dv">3</span>)</span>
<span id="cb53-249"><a href="#cb53-249"></a><span class="in">```</span></span>
<span id="cb53-250"><a href="#cb53-250"></a></span>
<span id="cb53-251"><a href="#cb53-251"></a></span>
<span id="cb53-252"><a href="#cb53-252"></a>This has dealt with the problem caused by the extra rows at the top of the data. But if we look at the bottom of the dataset, we will see that there are also several rows of footnotes. These footnotes are important for us to have read so that we understand the data, but they aren't part of the data itself. </span>
<span id="cb53-253"><a href="#cb53-253"></a></span>
<span id="cb53-254"><a href="#cb53-254"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/ons_data2.png" alt="Screen shot of an Excel sheet of data from the UK Office for National Statistics, showing that there are multiple footer rows below the data."&gt;&lt;/p&gt;</span>
<span id="cb53-255"><a href="#cb53-255"></a></span>
<span id="cb53-256"><a href="#cb53-256"></a>We can remove these extra rows at the end of our data using the <span class="in">`slice()`</span> function from the <span class="in">`dplyr`</span> package. <span class="in">`slice()`</span> allows us to choose certain rows from our data by row number. Looking at the screen shot above, our data finishes on row 34 (row 36 looks like part of our data but the value there actually shows the number of people involved in the survey, not a number of incidents). But:</span>
<span id="cb53-257"><a href="#cb53-257"></a></span>
<span id="cb53-258"><a href="#cb53-258"></a><span class="ss">  * </span>we have already removed the first three rows using the <span class="in">`skip`</span> argument to <span class="in">`read_excel()`</span>, and</span>
<span id="cb53-259"><a href="#cb53-259"></a><span class="ss">  * </span>row four of the original spreadsheet has become our column names,</span>
<span id="cb53-260"><a href="#cb53-260"></a>  </span>
<span id="cb53-261"><a href="#cb53-261"></a>so row 34 on the spreadsheet is actually row 30 in our loaded dataset. Knowing this, we can remove all the rows below row 30 using the <span class="in">`slice()`</span> function from the dplyr package:</span>
<span id="cb53-262"><a href="#cb53-262"></a></span>
<span id="cb53-265"><a href="#cb53-265"></a><span class="in">```{r}</span></span>
<span id="cb53-266"><a href="#cb53-266"></a><span class="co">#| eval: false</span></span>
<span id="cb53-267"><a href="#cb53-267"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-268"><a href="#cb53-268"></a></span>
<span id="cb53-269"><a href="#cb53-269"></a><span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-270"><a href="#cb53-270"></a>  <span class="fu">read_excel</span>(<span class="at">sheet =</span> <span class="st">"Table E1"</span>, <span class="at">skip =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-271"><a href="#cb53-271"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span>
<span id="cb53-272"><a href="#cb53-272"></a><span class="in">```</span></span>
<span id="cb53-273"><a href="#cb53-273"></a></span>
<span id="cb53-276"><a href="#cb53-276"></a><span class="in">```{r}</span></span>
<span id="cb53-277"><a href="#cb53-277"></a><span class="co">#| echo: false</span></span>
<span id="cb53-278"><a href="#cb53-278"></a></span>
<span id="cb53-279"><a href="#cb53-279"></a><span class="fu">read_excel</span>(<span class="st">"www/cybercrime.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Table E1"</span>, <span class="at">skip =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-280"><a href="#cb53-280"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span>
<span id="cb53-281"><a href="#cb53-281"></a><span class="in">```</span></span>
<span id="cb53-282"><a href="#cb53-282"></a></span>
<span id="cb53-283"><a href="#cb53-283"></a>The final problem with the structure of this dataset is the blank rows that are used to separate different crime categories in the original table. We can deal with this using the <span class="in">`remove_empty()`</span> function from the janitor package, which removes all rows and/or columns that contain only <span class="in">`NA`</span> values. We will also clean the column names at the same time and then rename the columns to be shorter, which will make it easier to refer to them in our code.</span>
<span id="cb53-284"><a href="#cb53-284"></a></span>
<span id="cb53-287"><a href="#cb53-287"></a><span class="in">```{r}</span></span>
<span id="cb53-288"><a href="#cb53-288"></a><span class="co">#| eval: false</span></span>
<span id="cb53-289"><a href="#cb53-289"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-290"><a href="#cb53-290"></a></span>
<span id="cb53-291"><a href="#cb53-291"></a><span class="fu">str_glue</span>(<span class="st">"{tempdir()}/cybercrime.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-292"><a href="#cb53-292"></a>  <span class="fu">read_excel</span>(<span class="at">sheet =</span> <span class="st">"Table E1"</span>, <span class="at">skip =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-293"><a href="#cb53-293"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-294"><a href="#cb53-294"></a>  <span class="fu">remove_empty</span>(<span class="at">which =</span> <span class="st">"rows"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-295"><a href="#cb53-295"></a>  <span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb53-296"><a href="#cb53-296"></a>  <span class="fu">rename</span>(</span>
<span id="cb53-297"><a href="#cb53-297"></a>    <span class="at">offence =</span> offence_group3, </span>
<span id="cb53-298"><a href="#cb53-298"></a>    <span class="at">crimes =</span> number_of_incidents_thousands, </span>
<span id="cb53-299"><a href="#cb53-299"></a>    <span class="at">incidence =</span> rate_per_1_000_adults, </span>
<span id="cb53-300"><a href="#cb53-300"></a>    <span class="at">victims =</span> number_of_victims_thousands_4, </span>
<span id="cb53-301"><a href="#cb53-301"></a>    <span class="at">prevalence =</span> percentage_victims_once_or_more4</span>
<span id="cb53-302"><a href="#cb53-302"></a>  )</span>
<span id="cb53-303"><a href="#cb53-303"></a><span class="in">```</span></span>
<span id="cb53-304"><a href="#cb53-304"></a></span>
<span id="cb53-305"><a href="#cb53-305"></a></span>
<span id="cb53-308"><a href="#cb53-308"></a><span class="in">```{r}</span></span>
<span id="cb53-309"><a href="#cb53-309"></a><span class="co">#| echo: false</span></span>
<span id="cb53-310"><a href="#cb53-310"></a></span>
<span id="cb53-311"><a href="#cb53-311"></a><span class="fu">read_excel</span>(<span class="st">"www/cybercrime.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Table E1"</span>, <span class="at">skip =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-312"><a href="#cb53-312"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-313"><a href="#cb53-313"></a>  <span class="fu">remove_empty</span>(<span class="at">which =</span> <span class="st">"rows"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-314"><a href="#cb53-314"></a>  <span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb53-315"><a href="#cb53-315"></a>  <span class="fu">rename</span>(</span>
<span id="cb53-316"><a href="#cb53-316"></a>    <span class="at">offence =</span> offence_group3, </span>
<span id="cb53-317"><a href="#cb53-317"></a>    <span class="at">crimes =</span> number_of_incidents_thousands, </span>
<span id="cb53-318"><a href="#cb53-318"></a>    <span class="at">incidence =</span> rate_per_1_000_adults, </span>
<span id="cb53-319"><a href="#cb53-319"></a>    <span class="at">victims =</span> number_of_victims_thousands_4, </span>
<span id="cb53-320"><a href="#cb53-320"></a>    <span class="at">prevalence =</span> percentage_victims_once_or_more4</span>
<span id="cb53-321"><a href="#cb53-321"></a>  )</span>
<span id="cb53-322"><a href="#cb53-322"></a><span class="in">```</span></span>
<span id="cb53-323"><a href="#cb53-323"></a></span>
<span id="cb53-324"><a href="#cb53-324"></a>This dataset now has a tidy structure: each row represents an observation (in this case, data about a particular type of crime), each column represents a piece of information about the observation and each cell represents a single value. We still need to clean up the footnote numbers that appear in some of the values, but we will deal with that later in this chapter.</span>
<span id="cb53-325"><a href="#cb53-325"></a></span>
<span id="cb53-326"><a href="#cb53-326"></a></span>
<span id="cb53-327"><a href="#cb53-327"></a><span class="fu">### Separating multiple variables stored in a single column</span></span>
<span id="cb53-328"><a href="#cb53-328"></a></span>
<span id="cb53-329"><a href="#cb53-329"></a>Sometimes datasets include multiple variables in a single column. For example, data about crime victims stored in an object called <span class="in">`victims`</span> might include a single column representing both age and sex.</span>
<span id="cb53-330"><a href="#cb53-330"></a></span>
<span id="cb53-331"><a href="#cb53-331"></a></span>
<span id="cb53-332"><a href="#cb53-332"></a><span class="in">```{r victims-table}</span></span>
<span id="cb53-333"><a href="#cb53-333"></a><span class="in">#| echo: false</span></span>
<span id="cb53-334"><a href="#cb53-334"></a></span>
<span id="cb53-335"><a href="#cb53-335"></a><span class="in">tribble(</span></span>
<span id="cb53-336"><a href="#cb53-336"></a><span class="in">  ~first_name, ~last_name, ~age_sex,</span></span>
<span id="cb53-337"><a href="#cb53-337"></a><span class="in">  "Lyda", "Gartrell", "40/F",</span></span>
<span id="cb53-338"><a href="#cb53-338"></a><span class="in">  "Kareem", "David", "26",</span></span>
<span id="cb53-339"><a href="#cb53-339"></a><span class="in">  "Lisa", "Dean", "21/F",</span></span>
<span id="cb53-340"><a href="#cb53-340"></a><span class="in">  "Melina", "Shehan", "25/F",</span></span>
<span id="cb53-341"><a href="#cb53-341"></a><span class="in">  "Alfredo", "Matamoros", "18/M"</span></span>
<span id="cb53-342"><a href="#cb53-342"></a><span class="in">) |&gt; </span></span>
<span id="cb53-343"><a href="#cb53-343"></a><span class="in">  knitr::kable() |&gt; </span></span>
<span id="cb53-344"><a href="#cb53-344"></a><span class="in">  kableExtra::kable_styling(full_width = FALSE)</span></span>
<span id="cb53-345"><a href="#cb53-345"></a><span class="in">```</span></span>
<span id="cb53-346"><a href="#cb53-346"></a></span>
<span id="cb53-347"><a href="#cb53-347"></a></span>
<span id="cb53-348"><a href="#cb53-348"></a>It would be easier to wrangle this data (e.g. to filter by age) if the data in the <span class="in">`age_sex`</span> column was stored in two separate columns. Making this change would also make sure our data meets the definition of being tidy: every variable should be stored in a separate column.</span>
<span id="cb53-349"><a href="#cb53-349"></a></span>
<span id="cb53-350"><a href="#cb53-350"></a>We can split the <span class="in">`age_sex`</span> column into two using the <span class="in">`separate()`</span> function from the tidyr package. We specify the existing column we want to split using the <span class="in">`col`</span> argument, the names of the new columns we want to create using the <span class="in">`into`</span> argument and the character(s) that represent the boundary between the two pieces</span>
<span id="cb53-351"><a href="#cb53-351"></a>of data in each column (in this case, <span class="in">`/`</span>).</span>
<span id="cb53-352"><a href="#cb53-352"></a></span>
<span id="cb53-355"><a href="#cb53-355"></a><span class="in">```{r}</span></span>
<span id="cb53-356"><a href="#cb53-356"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-357"><a href="#cb53-357"></a></span>
<span id="cb53-358"><a href="#cb53-358"></a><span class="co"># Create an example dataset of fictional crime victims</span></span>
<span id="cb53-359"><a href="#cb53-359"></a>victims <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb53-360"><a href="#cb53-360"></a>  <span class="sc">~</span>first_name, <span class="sc">~</span>last_name, <span class="sc">~</span>age_sex,</span>
<span id="cb53-361"><a href="#cb53-361"></a>  <span class="st">"Lyda"</span>, <span class="st">"Gartrell"</span>, <span class="st">"40/F"</span>,</span>
<span id="cb53-362"><a href="#cb53-362"></a>  <span class="st">"Kareem"</span>, <span class="st">"David"</span>, <span class="st">"26"</span>,</span>
<span id="cb53-363"><a href="#cb53-363"></a>  <span class="st">"Lisa"</span>, <span class="st">"Dean"</span>, <span class="st">"21/F"</span>,</span>
<span id="cb53-364"><a href="#cb53-364"></a>  <span class="st">"Melina"</span>, <span class="st">"Shehan"</span>, <span class="st">"25/F"</span>,</span>
<span id="cb53-365"><a href="#cb53-365"></a>  <span class="st">"Alfredo"</span>, <span class="st">"Matamoros"</span>, <span class="st">"18/M"</span></span>
<span id="cb53-366"><a href="#cb53-366"></a>)</span>
<span id="cb53-367"><a href="#cb53-367"></a></span>
<span id="cb53-368"><a href="#cb53-368"></a><span class="co"># Separate `age_sex` column into separate columns for age and sex</span></span>
<span id="cb53-369"><a href="#cb53-369"></a><span class="fu">separate</span>(victims, <span class="at">col =</span> age_sex, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>), <span class="at">sep =</span> <span class="st">"/"</span>)</span>
<span id="cb53-370"><a href="#cb53-370"></a><span class="in">```</span></span>
<span id="cb53-371"><a href="#cb53-371"></a></span>
<span id="cb53-372"><a href="#cb53-372"></a>You might have noticed that this function produced a warning message saying <span class="in">`Expected 2 pieces. Missing pieces filled with NA in 1 rows [2]`</span>. This is because the second row of data in the <span class="in">`victims`</span> object only contains one of the two pieces of data. When this happens, <span class="in">`separate()`</span> fills in the values that are present from the left, filling any remaining columns to the right with <span class="in">`NA`</span>. If this is what we want (as it is here), we can silence this warning by specifying <span class="in">`fill = "right"`</span>. If instead we wanted <span class="in">`separate()`</span> to fill in columns with <span class="in">`NA`</span> values from the left, we could specify <span class="in">`fill = "left"`</span>.</span>
<span id="cb53-373"><a href="#cb53-373"></a></span>
<span id="cb53-374"><a href="#cb53-374"></a>Another issue with the separated data is that because the column <span class="in">`age_sex`</span> was a character column, both <span class="in">`age`</span> and <span class="in">`sex`</span> are character columns, too. Since <span class="in">`age`</span> is actually numeric, we can get <span class="in">`separate()`</span> to convert this new column to the correct type automatically by specifying <span class="in">`convert = TRUE`</span>.</span>
<span id="cb53-375"><a href="#cb53-375"></a></span>
<span id="cb53-378"><a href="#cb53-378"></a><span class="in">```{r}</span></span>
<span id="cb53-379"><a href="#cb53-379"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-380"><a href="#cb53-380"></a></span>
<span id="cb53-381"><a href="#cb53-381"></a><span class="fu">separate</span>(</span>
<span id="cb53-382"><a href="#cb53-382"></a>  victims, </span>
<span id="cb53-383"><a href="#cb53-383"></a>  <span class="at">col =</span> age_sex, </span>
<span id="cb53-384"><a href="#cb53-384"></a>  <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>), </span>
<span id="cb53-385"><a href="#cb53-385"></a>  <span class="at">sep =</span> <span class="st">"/"</span>,</span>
<span id="cb53-386"><a href="#cb53-386"></a>  <span class="at">convert =</span> <span class="cn">TRUE</span>,</span>
<span id="cb53-387"><a href="#cb53-387"></a>  <span class="at">fill =</span> <span class="st">"right"</span></span>
<span id="cb53-388"><a href="#cb53-388"></a>)</span>
<span id="cb53-389"><a href="#cb53-389"></a><span class="in">```</span></span>
<span id="cb53-390"><a href="#cb53-390"></a></span>
<span id="cb53-391"><a href="#cb53-391"></a>We now know how to convert a data into a tidy format using <span class="in">`pivot_longer()`</span> to convert data to long format, remove non-data rows using <span class="in">`slice()`</span>, <span class="in">`remove_empty()`</span> and the <span class="in">`skip`</span> argument to many functions like <span class="in">`read_csv()`</span>, and split columns with <span class="in">`separate()`</span>. In the next section, we'll learn how to tidy the content of individual cells.</span>
<span id="cb53-392"><a href="#cb53-392"></a></span>
<span id="cb53-393"><a href="#cb53-393"></a></span>
<span id="cb53-394"><a href="#cb53-394"></a>::: {.callout-quiz .callout}</span>
<span id="cb53-395"><a href="#cb53-395"></a><span class="fu">#### Tidying the structure of data</span></span>
<span id="cb53-396"><a href="#cb53-396"></a></span>
<span id="cb53-397"><a href="#cb53-397"></a><span class="in">```{r tidy-structure-quiz}</span></span>
<span id="cb53-398"><a href="#cb53-398"></a><span class="in">#| echo: false</span></span>
<span id="cb53-399"><a href="#cb53-399"></a></span>
<span id="cb53-400"><a href="#cb53-400"></a><span class="in">tidy_structure_quiz1 &lt;- c(</span></span>
<span id="cb53-401"><a href="#cb53-401"></a><span class="in">  "It requires a greater number of observations",</span></span>
<span id="cb53-402"><a href="#cb53-402"></a><span class="in">  "It cannot store numeric values",</span></span>
<span id="cb53-403"><a href="#cb53-403"></a><span class="in">  answer = "It makes it harder to filter, sort, or summarize data",</span></span>
<span id="cb53-404"><a href="#cb53-404"></a><span class="in">  "It eliminates missing values"</span></span>
<span id="cb53-405"><a href="#cb53-405"></a><span class="in">)</span></span>
<span id="cb53-406"><a href="#cb53-406"></a></span>
<span id="cb53-407"><a href="#cb53-407"></a><span class="in">tidy_structure_quiz2 &lt;- c(</span></span>
<span id="cb53-408"><a href="#cb53-408"></a><span class="in">  "All data is stored in a single column",</span></span>
<span id="cb53-409"><a href="#cb53-409"></a><span class="in">  "Each column represents a different data type (numeric, character, etc.)",</span></span>
<span id="cb53-410"><a href="#cb53-410"></a><span class="in">  "Each row represents a variable and each column represents an observation",</span></span>
<span id="cb53-411"><a href="#cb53-411"></a><span class="in">  answer = "Each row represents an observation and each column represents a variable"</span></span>
<span id="cb53-412"><a href="#cb53-412"></a><span class="in">)</span></span>
<span id="cb53-413"><a href="#cb53-413"></a></span>
<span id="cb53-414"><a href="#cb53-414"></a><span class="in">tidy_structure_quiz3 &lt;- c(</span></span>
<span id="cb53-415"><a href="#cb53-415"></a><span class="in">  "`spread()`",</span></span>
<span id="cb53-416"><a href="#cb53-416"></a><span class="in">  answer = "`pivot_longer()`",</span></span>
<span id="cb53-417"><a href="#cb53-417"></a><span class="in">  "`gather_rows()`",</span></span>
<span id="cb53-418"><a href="#cb53-418"></a><span class="in">  "`transpose()`"</span></span>
<span id="cb53-419"><a href="#cb53-419"></a><span class="in">)</span></span>
<span id="cb53-420"><a href="#cb53-420"></a><span class="in">```</span></span>
<span id="cb53-421"><a href="#cb53-421"></a></span>
<span id="cb53-422"><a href="#cb53-422"></a></span>
<span id="cb53-423"><a href="#cb53-423"></a>**What issue might arise when working with wide-format data?**</span>
<span id="cb53-424"><a href="#cb53-424"></a></span>
<span id="cb53-425"><a href="#cb53-425"></a><span class="in">`r webexercises::longmcq(tidy_structure_quiz1)`</span></span>
<span id="cb53-426"><a href="#cb53-426"></a></span>
<span id="cb53-427"><a href="#cb53-427"></a></span>
<span id="cb53-428"><a href="#cb53-428"></a>**Which of the following best describes a tidy dataset?**</span>
<span id="cb53-429"><a href="#cb53-429"></a></span>
<span id="cb53-430"><a href="#cb53-430"></a><span class="in">`r webexercises::longmcq(tidy_structure_quiz2)`</span></span>
<span id="cb53-431"><a href="#cb53-431"></a></span>
<span id="cb53-432"><a href="#cb53-432"></a></span>
<span id="cb53-433"><a href="#cb53-433"></a>**Which function is used to convert wide data to long format in R?**</span>
<span id="cb53-434"><a href="#cb53-434"></a></span>
<span id="cb53-435"><a href="#cb53-435"></a><span class="in">`r webexercises::longmcq(tidy_structure_quiz3)`</span></span>
<span id="cb53-436"><a href="#cb53-436"></a></span>
<span id="cb53-437"><a href="#cb53-437"></a></span>
<span id="cb53-438"><a href="#cb53-438"></a>:::</span>
<span id="cb53-439"><a href="#cb53-439"></a></span>
<span id="cb53-440"><a href="#cb53-440"></a></span>
<span id="cb53-441"><a href="#cb53-441"></a></span>
<span id="cb53-442"><a href="#cb53-442"></a><span class="fu">## Tidying the content of cells</span></span>
<span id="cb53-443"><a href="#cb53-443"></a></span>
<span id="cb53-444"><a href="#cb53-444"></a>As well as data with a messy structure, you might be provided with data with messy content inside some of the cells. In this section we will clean messy content, mostly using functions from the stringr package that is loaded automatically when we load tidyverse. All the functions in the stringr package start with <span class="in">`str_`</span> so that they are easy to remember.</span>
<span id="cb53-445"><a href="#cb53-445"></a></span>
<span id="cb53-446"><a href="#cb53-446"></a>We can change the case of text using one of four <span class="in">`str_to_`</span> functions:</span>
<span id="cb53-447"><a href="#cb53-447"></a></span>
<span id="cb53-448"><a href="#cb53-448"></a></span>
<span id="cb53-449"><a href="#cb53-449"></a><span class="in">```{r case-table}</span></span>
<span id="cb53-450"><a href="#cb53-450"></a><span class="in">#| echo: false</span></span>
<span id="cb53-451"><a href="#cb53-451"></a></span>
<span id="cb53-452"><a href="#cb53-452"></a><span class="in">tribble(</span></span>
<span id="cb53-453"><a href="#cb53-453"></a><span class="in">  ~input, ~`function`, ~output,</span></span>
<span id="cb53-454"><a href="#cb53-454"></a><span class="in">  "A stRinG oF TeXT", "`str_to_lower()`", str_to_lower("A stRinG oF TeXT"),</span></span>
<span id="cb53-455"><a href="#cb53-455"></a><span class="in">  "A stRinG oF TeXT", "`str_to_upper()`", str_to_upper("A stRinG oF TeXT"),</span></span>
<span id="cb53-456"><a href="#cb53-456"></a><span class="in">  "A stRinG oF TeXT", "`str_to_sentence()`", str_to_sentence("A stRinG oF TeXT"),</span></span>
<span id="cb53-457"><a href="#cb53-457"></a><span class="in">  "A stRinG oF TeXT", "`str_to_title()`", str_to_title("A stRinG oF TeXT")</span></span>
<span id="cb53-458"><a href="#cb53-458"></a><span class="in">) |&gt; </span></span>
<span id="cb53-459"><a href="#cb53-459"></a><span class="in">  knitr::kable() |&gt; </span></span>
<span id="cb53-460"><a href="#cb53-460"></a><span class="in">  kableExtra::kable_styling(full_width = FALSE)</span></span>
<span id="cb53-461"><a href="#cb53-461"></a><span class="in">```</span></span>
<span id="cb53-462"><a href="#cb53-462"></a></span>
<span id="cb53-463"><a href="#cb53-463"></a></span>
<span id="cb53-464"><a href="#cb53-464"></a>We can also remove unwanted text from within values. For example, if there is unwanted white-space (spaces, tabs, etc.) at the beginning or end of a string of characters, we can remove it with <span class="in">`str_trim()`</span>. <span class="in">`str_squish()`</span> does the same thing, but also reduces any repeated white-space characters in a string of text down to a single space. For example, <span class="in">`str_squish("  A string   of text")`</span> produces the result <span class="in">` `</span>r str_squish("  A string   of text")<span class="in">` `</span>.</span>
<span id="cb53-465"><a href="#cb53-465"></a></span>
<span id="cb53-466"><a href="#cb53-466"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/str_squish.jpg" alt="Cartoon explaining that the str_squish() function removes leading, trailing and repeated interior white space from strings."&gt;&lt;/p&gt;</span>
<span id="cb53-467"><a href="#cb53-467"></a></span>
<span id="cb53-468"><a href="#cb53-468"></a>Data from the UK police open data website includes the words 'on or near' at the start of every value in the <span class="in">`location`</span> column of the data. This is to remind users that the locations of crimes are deliberately obscured by being 'snapped' to the centre of the street on which they occur to protect victims' privacy. </span>
<span id="cb53-469"><a href="#cb53-469"></a></span>
<span id="cb53-470"><a href="#cb53-470"></a><span class="in">```{r uk-data-table}</span></span>
<span id="cb53-471"><a href="#cb53-471"></a><span class="in">#| echo: false</span></span>
<span id="cb53-472"><a href="#cb53-472"></a></span>
<span id="cb53-473"><a href="#cb53-473"></a><span class="in">tribble(</span></span>
<span id="cb53-474"><a href="#cb53-474"></a><span class="in">  ~month, ~longitude, ~latitude, ~location, ~lsoa_name,</span></span>
<span id="cb53-475"><a href="#cb53-475"></a><span class="in">  "2020-01", -1.12, 53.3, "On or near Supermarket", "Bassetlaw 013C",</span></span>
<span id="cb53-476"><a href="#cb53-476"></a><span class="in">  "2020-02", -0.993, 53.2, "On or near Turner Lane", "Newark and Sherwood 001A",</span></span>
<span id="cb53-477"><a href="#cb53-477"></a><span class="in">  "2020-05", -1.25, 53.1, "On or near Brookdale Road", "Ashfield 004C",</span></span>
<span id="cb53-478"><a href="#cb53-478"></a><span class="in">  "2020-08", -1.16, 53.0, "On or near Raithby Close", "Nottingham 006B",</span></span>
<span id="cb53-479"><a href="#cb53-479"></a><span class="in">  "2020-10", -1.18, 53.0, "On or near Bowden Avenue", "Ashfield 013A",</span></span>
<span id="cb53-480"><a href="#cb53-480"></a><span class="in">  "2020-10", -1.18, 53.0, "On or near Langley Close", "Ashfield 013A"</span></span>
<span id="cb53-481"><a href="#cb53-481"></a><span class="in">) |&gt; </span></span>
<span id="cb53-482"><a href="#cb53-482"></a><span class="in">  knitr::kable() |&gt; </span></span>
<span id="cb53-483"><a href="#cb53-483"></a><span class="in">  kableExtra::kable_styling(full_width = FALSE)</span></span>
<span id="cb53-484"><a href="#cb53-484"></a><span class="in">```</span></span>
<span id="cb53-485"><a href="#cb53-485"></a></span>
<span id="cb53-486"><a href="#cb53-486"></a></span>
<span id="cb53-487"><a href="#cb53-487"></a>We don't need this constant value for analysis, and for large datasets it can unnecessarily increase the size of the data when we save it to a file. For this reason we might want to remove this constant value using the <span class="in">`str_remove()`</span> function.</span>
<span id="cb53-488"><a href="#cb53-488"></a></span>
<span id="cb53-489"><a href="#cb53-489"></a></span>
<span id="cb53-492"><a href="#cb53-492"></a><span class="in">```{r}</span></span>
<span id="cb53-493"><a href="#cb53-493"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-494"><a href="#cb53-494"></a></span>
<span id="cb53-495"><a href="#cb53-495"></a><span class="co"># Create example dataset similar to UK police open data</span></span>
<span id="cb53-496"><a href="#cb53-496"></a>uk_data <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb53-497"><a href="#cb53-497"></a>  <span class="sc">~</span>month, <span class="sc">~</span>longitude, <span class="sc">~</span>latitude, <span class="sc">~</span>location, <span class="sc">~</span>lsoa_name,</span>
<span id="cb53-498"><a href="#cb53-498"></a>  <span class="st">"2020-01"</span>, <span class="sc">-</span><span class="fl">1.12</span>, <span class="fl">53.3</span>, <span class="st">"On or near Supermarket"</span>, <span class="st">"Bassetlaw 013C"</span>,</span>
<span id="cb53-499"><a href="#cb53-499"></a>  <span class="st">"2020-02"</span>, <span class="sc">-</span><span class="fl">0.993</span>, <span class="fl">53.2</span>, <span class="st">"On or near Turner Lane"</span>, <span class="st">"Newark and Sherwood 001A"</span>,</span>
<span id="cb53-500"><a href="#cb53-500"></a>  <span class="st">"2020-05"</span>, <span class="sc">-</span><span class="fl">1.25</span>, <span class="fl">53.1</span>, <span class="st">"On or near Brookdale Road"</span>, <span class="st">"Ashfield 004C"</span>,</span>
<span id="cb53-501"><a href="#cb53-501"></a>  <span class="st">"2020-08"</span>, <span class="sc">-</span><span class="fl">1.16</span>, <span class="fl">53.0</span>, <span class="st">"On or near Raithby Close"</span>, <span class="st">"Nottingham 006B"</span>,</span>
<span id="cb53-502"><a href="#cb53-502"></a>  <span class="st">"2020-10"</span>, <span class="sc">-</span><span class="fl">1.18</span>, <span class="fl">53.0</span>, <span class="st">"On or near Bowden Avenue"</span>, <span class="st">"Ashfield 013A"</span>,</span>
<span id="cb53-503"><a href="#cb53-503"></a>  <span class="st">"2020-10"</span>, <span class="sc">-</span><span class="fl">1.18</span>, <span class="fl">53.0</span>, <span class="st">"On or near Langley Close"</span>, <span class="st">"Ashfield 013A"</span></span>
<span id="cb53-504"><a href="#cb53-504"></a>)</span>
<span id="cb53-505"><a href="#cb53-505"></a></span>
<span id="cb53-506"><a href="#cb53-506"></a><span class="co"># Remove constant text from the location column</span></span>
<span id="cb53-507"><a href="#cb53-507"></a><span class="fu">mutate</span>(uk_data, <span class="at">location =</span> <span class="fu">str_remove</span>(location, <span class="st">"On or near "</span>))</span>
<span id="cb53-508"><a href="#cb53-508"></a><span class="in">```</span></span>
<span id="cb53-509"><a href="#cb53-509"></a></span>
<span id="cb53-510"><a href="#cb53-510"></a></span>
<span id="cb53-511"><a href="#cb53-511"></a>The <span class="in">`lsoa_name`</span> code of this dataset includes the name of the small statistical area in which each crime occurred. Each name is made up of the name of the local government district covering the area followed by a unique code. If we wanted to extract just the district name (for example so we could count the number of crimes in each district) we can do that by removing the code that follows the district name. To do this we need to use a *regular expression*, which is a way of describing a pattern in a string of characters. Regular expressions can be used to find, extract or remove characters that match a specified pattern. </span>
<span id="cb53-512"><a href="#cb53-512"></a></span>
<span id="cb53-513"><a href="#cb53-513"></a>Regular expressions can be complicated, so we will only scratch the surface of what's possible here. You can find out much more about about them in the <span class="co">[</span><span class="ot">article on regular expressions included in the stringr package</span><span class="co">](https://stringr.tidyverse.org/articles/regular-expressions.html)</span>. The coded description of the pattern of characters we need to match the code at the end of the <span class="in">`lsoa_name`</span> column is <span class="in">`\\s\\w{4}$`</span>. This is made up three parts:</span>
<span id="cb53-514"><a href="#cb53-514"></a></span>
<span id="cb53-515"><a href="#cb53-515"></a><span class="ss">  * </span><span class="in">`\\s`</span> means match exactly one white-space character (e.g. a space or a tab),</span>
<span id="cb53-516"><a href="#cb53-516"></a><span class="ss">  * </span><span class="in">`\\w{4}`</span> means match exactly four word characters (i.e. any letter, any number or some punctuation marks), and</span>
<span id="cb53-517"><a href="#cb53-517"></a><span class="ss">  * </span><span class="in">`$`</span> means match the end of the string.</span>
<span id="cb53-518"><a href="#cb53-518"></a>  </span>
<span id="cb53-519"><a href="#cb53-519"></a>So <span class="in">`\\s\\w{4}$`</span> means match exactly one white-space character followed by exactly four word characters at the end of the string. We can use this pattern as the second argument to the <span class="in">`str_remove()`</span> function to remove the characters matched by the pattern.</span>
<span id="cb53-520"><a href="#cb53-520"></a></span>
<span id="cb53-521"><a href="#cb53-521"></a></span>
<span id="cb53-524"><a href="#cb53-524"></a><span class="in">```{r}</span></span>
<span id="cb53-525"><a href="#cb53-525"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-526"><a href="#cb53-526"></a></span>
<span id="cb53-527"><a href="#cb53-527"></a>uk_data <span class="sc">|&gt;</span> </span>
<span id="cb53-528"><a href="#cb53-528"></a>  <span class="fu">mutate</span>(<span class="at">district =</span> <span class="fu">str_remove</span>(lsoa_name, <span class="st">"</span><span class="sc">\\</span><span class="st">s</span><span class="sc">\\</span><span class="st">w{4}$"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb53-529"><a href="#cb53-529"></a>  <span class="co"># Extract two columns to make them easier to compare</span></span>
<span id="cb53-530"><a href="#cb53-530"></a>  <span class="fu">select</span>(lsoa_name, district)</span>
<span id="cb53-531"><a href="#cb53-531"></a><span class="in">```</span></span>
<span id="cb53-532"><a href="#cb53-532"></a></span>
<span id="cb53-533"><a href="#cb53-533"></a></span>
<span id="cb53-534"><a href="#cb53-534"></a>Instead of using a regular expression to remove characters, we could instead use regular expressions together with <span class="in">`str_extract()`</span> to keep only the characters matched by the pattern, <span class="in">`str_replace()`</span> to replace the first group of characters matched by the pattern and <span class="in">`str_replace_all()`</span> to replace all the groups of characters matched by the pattern. For more tips on using regular expressions together with functions from the stringr package, see the <span class="co">[</span><span class="ot">stringr package cheat sheet</span><span class="co">](https://github.com/rstudio/cheatsheets/blob/main/strings.pdf)</span> or visit <span class="co">[</span><span class="ot">regexr.com</span><span class="co">](https://regexr.com/)</span>.</span>
<span id="cb53-535"><a href="#cb53-535"></a></span>
<span id="cb53-536"><a href="#cb53-536"></a></span>
<span id="cb53-537"><a href="#cb53-537"></a><span class="fu">### Converting between types of variable</span></span>
<span id="cb53-538"><a href="#cb53-538"></a></span>
<span id="cb53-539"><a href="#cb53-539"></a>Sometimes columns in your data will be stored as the wrong type of variable. <span class="in">`read_csv()`</span> and other functions from the readr package try to guess what type of variable is contained in each column based on what is contained in the first few rows, but this does not always work. For example, a variable containing numbers might be stored as characters, meaning functions like <span class="in">`mean()`</span> will not work. </span>
<span id="cb53-540"><a href="#cb53-540"></a></span>
<span id="cb53-541"><a href="#cb53-541"></a></span>
<span id="cb53-544"><a href="#cb53-544"></a><span class="in">```{r}</span></span>
<span id="cb53-545"><a href="#cb53-545"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-546"><a href="#cb53-546"></a></span>
<span id="cb53-547"><a href="#cb53-547"></a><span class="co"># Some numbers stored as text (note the quote marks around each number)</span></span>
<span id="cb53-548"><a href="#cb53-548"></a>numbers_as_text <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"14"</span>, <span class="st">"6"</span>, <span class="st">"17"</span>)</span>
<span id="cb53-549"><a href="#cb53-549"></a></span>
<span id="cb53-550"><a href="#cb53-550"></a><span class="co"># Trying to find the mean of these numbers stored as characters will produce </span></span>
<span id="cb53-551"><a href="#cb53-551"></a><span class="co"># `NA` and a warning</span></span>
<span id="cb53-552"><a href="#cb53-552"></a><span class="fu">mean</span>(numbers_as_text)</span>
<span id="cb53-553"><a href="#cb53-553"></a><span class="in">```</span></span>
<span id="cb53-554"><a href="#cb53-554"></a></span>
<span id="cb53-555"><a href="#cb53-555"></a></span>
<span id="cb53-556"><a href="#cb53-556"></a>In cases like this, we can use the <span class="in">`parse_number()`</span> function from the readr package (part of tidyverse) to convert the character variable into a numeric variable.</span>
<span id="cb53-557"><a href="#cb53-557"></a></span>
<span id="cb53-558"><a href="#cb53-558"></a></span>
<span id="cb53-561"><a href="#cb53-561"></a><span class="in">```{r}</span></span>
<span id="cb53-562"><a href="#cb53-562"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-563"><a href="#cb53-563"></a></span>
<span id="cb53-564"><a href="#cb53-564"></a><span class="co"># If we use `parse_number()` then `mean()` now works</span></span>
<span id="cb53-565"><a href="#cb53-565"></a><span class="fu">mean</span>(<span class="fu">parse_number</span>(numbers_as_text))</span>
<span id="cb53-566"><a href="#cb53-566"></a><span class="in">```</span></span>
<span id="cb53-567"><a href="#cb53-567"></a></span>
<span id="cb53-568"><a href="#cb53-568"></a></span>
<span id="cb53-569"><a href="#cb53-569"></a>&lt;img src="../images/parse_number.jpg" alt="Cartoon showing that the parse_number() function extracts numeric values from text, stripping out all non-numeric characters." class="right-side-image" style="width: 400px; max-width: 50%;"&gt;</span>
<span id="cb53-570"><a href="#cb53-570"></a></span>
<span id="cb53-571"><a href="#cb53-571"></a>We can use other functions in the <span class="in">`parse_*()`</span> family to convert character values to other data types. For example, we can use <span class="in">`parse_logical()`</span> to convert true/false values stored as text to <span class="in">`TRUE`</span> and <span class="in">`FALSE`</span> values. Be careful, though: if you try to convert a variable to a data type that makes no sense, you are likely to find all of your values replaced with <span class="in">`NA`</span>.</span>
<span id="cb53-572"><a href="#cb53-572"></a></span>
<span id="cb53-573"><a href="#cb53-573"></a>Sometimes numbers will be stored alongside other values, such as when currency values are stored together with a currency symbol. We can also deal with values like these by using <span class="in">`parse_number()`</span>, which strips all the non-numeric characters from a value and then converts the numeric characters to a number. For example, <span class="in">`parse_number("Room 14A")`</span> produces the numeric value <span class="in">` `</span>r parse_number("Room 14A")<span class="in">` `</span>.</span>
<span id="cb53-574"><a href="#cb53-574"></a></span>
<span id="cb53-575"><a href="#cb53-575"></a>If there are multiple columns in a dataset that store non-text data as character values, we can also use the <span class="in">`type_convert()`</span> function from the readr package to automatically convert them all.</span>
<span id="cb53-576"><a href="#cb53-576"></a></span>
<span id="cb53-577"><a href="#cb53-577"></a></span>
<span id="cb53-578"><a href="#cb53-578"></a><span class="fu">### Recoding categorical variables</span></span>
<span id="cb53-579"><a href="#cb53-579"></a></span>
<span id="cb53-580"><a href="#cb53-580"></a>Crime data often includes categorical variables, such as crime types or location categories. It can be useful to change these categories, for example so that we can join two datasets or abbreviate category names for use in the axis labels of a chart.</span>
<span id="cb53-581"><a href="#cb53-581"></a></span>
<span id="cb53-582"><a href="#cb53-582"></a>We can use the <span class="in">`if_else()`</span> function from the dplyr package to change particular values, but this only allows us to change a single value and can produce slightly untidy code. Instead we can use  the <span class="in">`case_match()`</span> function from the dplyr package to change one or more values at the same time. For example, if we wanted to change the value <span class="in">`Supermarket`</span> to <span class="in">`Shop`</span> in the UK police data.</span>
<span id="cb53-583"><a href="#cb53-583"></a></span>
<span id="cb53-584"><a href="#cb53-584"></a></span>
<span id="cb53-587"><a href="#cb53-587"></a><span class="in">```{r}</span></span>
<span id="cb53-588"><a href="#cb53-588"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-589"><a href="#cb53-589"></a></span>
<span id="cb53-590"><a href="#cb53-590"></a>uk_data <span class="sc">|&gt;</span> </span>
<span id="cb53-591"><a href="#cb53-591"></a>  <span class="fu">mutate</span>(</span>
<span id="cb53-592"><a href="#cb53-592"></a>    <span class="co"># Once again we will first remove the unnecessary 'On or near ' using </span></span>
<span id="cb53-593"><a href="#cb53-593"></a>    <span class="co"># `str_remove()`</span></span>
<span id="cb53-594"><a href="#cb53-594"></a>    <span class="at">location =</span> <span class="fu">str_remove</span>(location, <span class="st">"On or near "</span>),</span>
<span id="cb53-595"><a href="#cb53-595"></a>    <span class="at">location =</span> <span class="fu">case_match</span>(location, <span class="st">"Supermarket"</span> <span class="sc">~</span> <span class="st">"Shop"</span>, <span class="at">.default =</span> location)</span>
<span id="cb53-596"><a href="#cb53-596"></a>  )</span>
<span id="cb53-597"><a href="#cb53-597"></a><span class="in">```</span></span>
<span id="cb53-598"><a href="#cb53-598"></a></span>
<span id="cb53-599"><a href="#cb53-599"></a></span>
<span id="cb53-600"><a href="#cb53-600"></a>The first argument to <span class="in">`case_match()`</span> is the name of the variable to be recoded. That is followed by one or more arguments showing which values should be changed, and what they should be changed to. The old and new values are separated by a tilde (<span class="in">`~`</span>) character, with the old value on the left. The final argument (<span class="in">`.default`</span>) specifies what value the variable should have if it does not currently have any of the values specified in the pairs of values already provided. In this case, we use <span class="in">`.default = location`</span> to specify that unmatched values should keep their existing values.</span>
<span id="cb53-601"><a href="#cb53-601"></a></span>
<span id="cb53-602"><a href="#cb53-602"></a>We can use <span class="in">`case_match()`</span> to make more-complicated changes. For example we can change multiple values at the same time, including merging different values into the same new value:</span>
<span id="cb53-603"><a href="#cb53-603"></a></span>
<span id="cb53-606"><a href="#cb53-606"></a><span class="in">```{r}</span></span>
<span id="cb53-607"><a href="#cb53-607"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-608"><a href="#cb53-608"></a></span>
<span id="cb53-609"><a href="#cb53-609"></a>uk_data <span class="sc">|&gt;</span> </span>
<span id="cb53-610"><a href="#cb53-610"></a>  <span class="fu">mutate</span>(</span>
<span id="cb53-611"><a href="#cb53-611"></a>    <span class="co"># Once again we will first remove the unnecessary 'On or near ' using </span></span>
<span id="cb53-612"><a href="#cb53-612"></a>    <span class="co"># `str_remove()`</span></span>
<span id="cb53-613"><a href="#cb53-613"></a>    <span class="at">location =</span> <span class="fu">str_remove</span>(location, <span class="st">"On or near "</span>),</span>
<span id="cb53-614"><a href="#cb53-614"></a>    <span class="at">location =</span> <span class="fu">case_match</span>(</span>
<span id="cb53-615"><a href="#cb53-615"></a>      location, </span>
<span id="cb53-616"><a href="#cb53-616"></a>      <span class="st">"Supermarket"</span> <span class="sc">~</span> <span class="st">"Shop"</span>,</span>
<span id="cb53-617"><a href="#cb53-617"></a>      <span class="fu">c</span>(<span class="st">"Bowden Avenue"</span>, <span class="st">"Langley Close"</span>) <span class="sc">~</span> <span class="st">"Bestwood Village"</span>,</span>
<span id="cb53-618"><a href="#cb53-618"></a>      <span class="at">.default =</span> location</span>
<span id="cb53-619"><a href="#cb53-619"></a>    )</span>
<span id="cb53-620"><a href="#cb53-620"></a>  )</span>
<span id="cb53-621"><a href="#cb53-621"></a><span class="in">```</span></span>
<span id="cb53-622"><a href="#cb53-622"></a></span>
<span id="cb53-623"><a href="#cb53-623"></a></span>
<span id="cb53-624"><a href="#cb53-624"></a></span>
<span id="cb53-625"><a href="#cb53-625"></a><span class="fu">### Missing values</span></span>
<span id="cb53-626"><a href="#cb53-626"></a></span>
<span id="cb53-627"><a href="#cb53-627"></a>We have already encountered the <span class="in">`NA`</span> value, which R uses to represent a value that is missing from a dataset. While R uses <span class="in">`NA`</span> to represent missing values, some data providers use other codes. For example, a data provider might use a dash (<span class="in">`-`</span>) or two periods (<span class="in">`..`</span>) to represent missing values. Fortunately, we can convert any value to <span class="in">`NA`</span> so that we know that it represents a missing value.</span>
<span id="cb53-628"><a href="#cb53-628"></a></span>
<span id="cb53-629"><a href="#cb53-629"></a>Imagine that you have been provided with a dataset of burglaries that includes an estimate of the value of the goods that were stolen in British pounds. You have been told that when the value of the stolen goods wasn't known, this is recorded as the value <span class="in">`-1`</span> in the data. If we use <span class="in">`mean()`</span> to estimate the average value of property stolen, the value <span class="in">`-1`</span> will give us an incorrect result.</span>
<span id="cb53-630"><a href="#cb53-630"></a></span>
<span id="cb53-631"><a href="#cb53-631"></a></span>
<span id="cb53-634"><a href="#cb53-634"></a><span class="in">```{r}</span></span>
<span id="cb53-635"><a href="#cb53-635"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-636"><a href="#cb53-636"></a></span>
<span id="cb53-637"><a href="#cb53-637"></a><span class="co"># Create a dataset of burglary dates/times with the value of goods stolen</span></span>
<span id="cb53-638"><a href="#cb53-638"></a>burglary_values <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb53-639"><a href="#cb53-639"></a>  <span class="at">crime_number =</span> <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">5</span>, <span class="at">min =</span> <span class="dv">100000</span>, <span class="at">max =</span> <span class="dv">999999</span>),</span>
<span id="cb53-640"><a href="#cb53-640"></a>  <span class="at">value =</span> <span class="fu">c</span>(<span class="dv">1320</span>, <span class="dv">653</span>, <span class="dv">2068</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">580</span>)</span>
<span id="cb53-641"><a href="#cb53-641"></a>)</span>
<span id="cb53-642"><a href="#cb53-642"></a></span>
<span id="cb53-643"><a href="#cb53-643"></a><span class="co"># Try to calculate the mean value -- no error, but the answer is wrong</span></span>
<span id="cb53-644"><a href="#cb53-644"></a><span class="co"># `pull()` is used to extract the `value` column from `burglary_values`</span></span>
<span id="cb53-645"><a href="#cb53-645"></a><span class="fu">mean</span>(<span class="fu">pull</span>(burglary_values, <span class="st">"value"</span>))</span>
<span id="cb53-646"><a href="#cb53-646"></a><span class="in">```</span></span>
<span id="cb53-647"><a href="#cb53-647"></a></span>
<span id="cb53-648"><a href="#cb53-648"></a></span>
<span id="cb53-649"><a href="#cb53-649"></a>If we instead convert the value <span class="in">`-1`</span> to <span class="in">`NA`</span> first, <span class="in">`mean()`</span> will know to ignore that value as long as we specify the argument <span class="in">`na.rm = TRUE`</span>.</span>
<span id="cb53-650"><a href="#cb53-650"></a></span>
<span id="cb53-651"><a href="#cb53-651"></a></span>
<span id="cb53-654"><a href="#cb53-654"></a><span class="in">```{r}</span></span>
<span id="cb53-655"><a href="#cb53-655"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-656"><a href="#cb53-656"></a></span>
<span id="cb53-657"><a href="#cb53-657"></a><span class="co"># Convert `-1` to `NA` first, now you get the correct mean value</span></span>
<span id="cb53-658"><a href="#cb53-658"></a>burglary_values <span class="ot">&lt;-</span> <span class="fu">mutate</span>(</span>
<span id="cb53-659"><a href="#cb53-659"></a>  burglary_values,</span>
<span id="cb53-660"><a href="#cb53-660"></a>  <span class="at">value =</span> <span class="fu">if_else</span>(value <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>, <span class="cn">NA</span>, value)</span>
<span id="cb53-661"><a href="#cb53-661"></a>)</span>
<span id="cb53-662"><a href="#cb53-662"></a></span>
<span id="cb53-663"><a href="#cb53-663"></a><span class="co"># Calculate the mean value again, now excluding the missing value</span></span>
<span id="cb53-664"><a href="#cb53-664"></a><span class="fu">mean</span>(<span class="fu">pull</span>(burglary_values, <span class="st">"value"</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-665"><a href="#cb53-665"></a><span class="in">```</span></span>
<span id="cb53-666"><a href="#cb53-666"></a></span>
<span id="cb53-667"><a href="#cb53-667"></a></span>
<span id="cb53-668"><a href="#cb53-668"></a>Excluding the value <span class="in">`-1`</span> makes a substantial difference to the mean, increasing it by over £100.</span>
<span id="cb53-669"><a href="#cb53-669"></a></span>
<span id="cb53-670"><a href="#cb53-670"></a></span>
<span id="cb53-671"><a href="#cb53-671"></a><span class="fu">### Null Island {#sec-null-island}</span></span>
<span id="cb53-672"><a href="#cb53-672"></a></span>
<span id="cb53-673"><a href="#cb53-673"></a>The problem of missing values being stored as numbers manifests itself in a particularly frustrating way when it comes to spatial data. People and organisations that produce spatial datasets sometimes recording missing co-ordinates as being _zero_, instead of being _missing_. This is a problem because the longitude/latitude co-ordinates "0, 0" correspond to a real location on the surface of the earth, in the Gulf of Guinea off the coast of Ghana. This location is incorrectly recorded in spatial datasets so often that it's become known as _Null Island_. Watch this video to find out more about Null Island and the problems it causes.</span>
<span id="cb53-674"><a href="#cb53-674"></a></span>
<span id="cb53-675"><a href="#cb53-675"></a></span>
<span id="cb53-676"><a href="#cb53-676"></a>{{&lt; video https://youtu.be/bjvIpI-1w84 &gt;}}</span>
<span id="cb53-677"><a href="#cb53-677"></a></span>
<span id="cb53-678"><a href="#cb53-678"></a></span>
<span id="cb53-679"><a href="#cb53-679"></a><span class="in">```{r null-island-map, echo=FALSE, eval=FALSE}</span></span>
<span id="cb53-680"><a href="#cb53-680"></a><span class="in">ortho &lt;- "+proj=ortho +lon_0=0 +lat_0=15"</span></span>
<span id="cb53-681"><a href="#cb53-681"></a></span>
<span id="cb53-682"><a href="#cb53-682"></a><span class="in">countries &lt;- rnaturalearth::countries110 |&gt; </span></span>
<span id="cb53-683"><a href="#cb53-683"></a><span class="in">  st_as_sf() |&gt; </span></span>
<span id="cb53-684"><a href="#cb53-684"></a><span class="in">  filter(NAME != "Antarctica") |&gt; </span></span>
<span id="cb53-685"><a href="#cb53-685"></a><span class="in">  st_cast("MULTILINESTRING") |&gt;</span></span>
<span id="cb53-686"><a href="#cb53-686"></a><span class="in">  st_cast("LINESTRING", do_split = TRUE) |&gt;</span></span>
<span id="cb53-687"><a href="#cb53-687"></a><span class="in">  st_cast("POLYGON")</span></span>
<span id="cb53-688"><a href="#cb53-688"></a></span>
<span id="cb53-689"><a href="#cb53-689"></a><span class="in">null_island &lt;- st_point(c(0, 0)) |&gt; </span></span>
<span id="cb53-690"><a href="#cb53-690"></a><span class="in">  st_sfc(crs = "EPSG:4326") |&gt; </span></span>
<span id="cb53-691"><a href="#cb53-691"></a><span class="in">  st_sf() |&gt; </span></span>
<span id="cb53-692"><a href="#cb53-692"></a><span class="in">  st_set_geometry("geometry") |&gt; </span></span>
<span id="cb53-693"><a href="#cb53-693"></a><span class="in">  st_transform(ortho) |&gt; </span></span>
<span id="cb53-694"><a href="#cb53-694"></a><span class="in">  mutate(label = "Null\nIsland")</span></span>
<span id="cb53-695"><a href="#cb53-695"></a></span>
<span id="cb53-696"><a href="#cb53-696"></a><span class="in">limits &lt;- null_island |&gt; </span></span>
<span id="cb53-697"><a href="#cb53-697"></a><span class="in">  st_buffer(10^6.5) |&gt; </span></span>
<span id="cb53-698"><a href="#cb53-698"></a><span class="in">  st_bbox()</span></span>
<span id="cb53-699"><a href="#cb53-699"></a></span>
<span id="cb53-700"><a href="#cb53-700"></a><span class="in">graticule &lt;- st_graticule(</span></span>
<span id="cb53-701"><a href="#cb53-701"></a><span class="in">  x = c(-180, -80, 180, 80), </span></span>
<span id="cb53-702"><a href="#cb53-702"></a><span class="in">  crs = "EPSG:4326",</span></span>
<span id="cb53-703"><a href="#cb53-703"></a><span class="in">  lon = seq(-180, 180, by = 20),</span></span>
<span id="cb53-704"><a href="#cb53-704"></a><span class="in">  lat = seq(-80, 80, by = 20)</span></span>
<span id="cb53-705"><a href="#cb53-705"></a><span class="in">) |&gt; </span></span>
<span id="cb53-706"><a href="#cb53-706"></a><span class="in">  mutate(highlight = degree == 0)</span></span>
<span id="cb53-707"><a href="#cb53-707"></a></span>
<span id="cb53-708"><a href="#cb53-708"></a><span class="in">graticule_labels &lt;- tribble(</span></span>
<span id="cb53-709"><a href="#cb53-709"></a><span class="in">  ~label, ~geometry,</span></span>
<span id="cb53-710"><a href="#cb53-710"></a><span class="in">  "0º", st_point(c(-30, 0)),</span></span>
<span id="cb53-711"><a href="#cb53-711"></a><span class="in">  "40ºS", st_point(c(-30, -40)),</span></span>
<span id="cb53-712"><a href="#cb53-712"></a><span class="in">  "20ºS", st_point(c(-30, -20)),</span></span>
<span id="cb53-713"><a href="#cb53-713"></a><span class="in">  "20ºN", st_point(c(-30, 20)),</span></span>
<span id="cb53-714"><a href="#cb53-714"></a><span class="in">  "40ºN", st_point(c(-30, 40)),</span></span>
<span id="cb53-715"><a href="#cb53-715"></a><span class="in">  "60ºN", st_point(c(-30, 60)),</span></span>
<span id="cb53-716"><a href="#cb53-716"></a><span class="in">  "0º", st_point(c(0, -50)),</span></span>
<span id="cb53-717"><a href="#cb53-717"></a><span class="in">  "20ºE", st_point(c(-20, -50)),</span></span>
<span id="cb53-718"><a href="#cb53-718"></a><span class="in">  "20ºW", st_point(c(20, -50))</span></span>
<span id="cb53-719"><a href="#cb53-719"></a><span class="in">) |&gt; </span></span>
<span id="cb53-720"><a href="#cb53-720"></a><span class="in">  st_as_sf(crs = "EPSG:4326")</span></span>
<span id="cb53-721"><a href="#cb53-721"></a></span>
<span id="cb53-722"><a href="#cb53-722"></a><span class="in">world_bg &lt;- st_graticule() |&gt; </span></span>
<span id="cb53-723"><a href="#cb53-723"></a><span class="in">  st_transform(ortho) |&gt; </span></span>
<span id="cb53-724"><a href="#cb53-724"></a><span class="in">  st_convex_hull() |&gt; </span></span>
<span id="cb53-725"><a href="#cb53-725"></a><span class="in">  summarise(geometry = st_union(geometry)) |&gt; </span></span>
<span id="cb53-726"><a href="#cb53-726"></a><span class="in">  st_convex_hull()</span></span>
<span id="cb53-727"><a href="#cb53-727"></a></span>
<span id="cb53-728"><a href="#cb53-728"></a><span class="in"># null_island_map &lt;- </span></span>
<span id="cb53-729"><a href="#cb53-729"></a><span class="in">ggplot() + </span></span>
<span id="cb53-730"><a href="#cb53-730"></a><span class="in">  geom_sf(data = world_bg, colour = NA, fill = "#C6ECFF") +</span></span>
<span id="cb53-731"><a href="#cb53-731"></a><span class="in">  geom_sf(</span></span>
<span id="cb53-732"><a href="#cb53-732"></a><span class="in">    aes(colour = highlight, linetype = highlight), </span></span>
<span id="cb53-733"><a href="#cb53-733"></a><span class="in">    data = graticule, </span></span>
<span id="cb53-734"><a href="#cb53-734"></a><span class="in">    linewidth = 0.33</span></span>
<span id="cb53-735"><a href="#cb53-735"></a><span class="in">  ) +</span></span>
<span id="cb53-736"><a href="#cb53-736"></a><span class="in">  geom_sf(</span></span>
<span id="cb53-737"><a href="#cb53-737"></a><span class="in">    data = countries, </span></span>
<span id="cb53-738"><a href="#cb53-738"></a><span class="in">    colour = "grey60", </span></span>
<span id="cb53-739"><a href="#cb53-739"></a><span class="in">    fill = "#FEFEE9",</span></span>
<span id="cb53-740"><a href="#cb53-740"></a><span class="in">    linewidth = 0.2</span></span>
<span id="cb53-741"><a href="#cb53-741"></a><span class="in">  ) +</span></span>
<span id="cb53-742"><a href="#cb53-742"></a><span class="in">  geom_sf_text(</span></span>
<span id="cb53-743"><a href="#cb53-743"></a><span class="in">    aes(label = label), </span></span>
<span id="cb53-744"><a href="#cb53-744"></a><span class="in">    data = null_island, </span></span>
<span id="cb53-745"><a href="#cb53-745"></a><span class="in">    hjust = 1, </span></span>
<span id="cb53-746"><a href="#cb53-746"></a><span class="in">    lineheight = 0.9, </span></span>
<span id="cb53-747"><a href="#cb53-747"></a><span class="in">    nudge_x = -8^6,</span></span>
<span id="cb53-748"><a href="#cb53-748"></a><span class="in">    nudge_y = -8^6,</span></span>
<span id="cb53-749"><a href="#cb53-749"></a><span class="in">    vjust = 1</span></span>
<span id="cb53-750"><a href="#cb53-750"></a><span class="in">  ) +</span></span>
<span id="cb53-751"><a href="#cb53-751"></a><span class="in">  geom_sf(data = null_island, colour = "#CC0000", shape = 21, size = 5) + </span></span>
<span id="cb53-752"><a href="#cb53-752"></a><span class="in">  geom_sf(data = null_island, colour = "#CC0000", size = 2) + </span></span>
<span id="cb53-753"><a href="#cb53-753"></a><span class="in">  geom_sf_text(</span></span>
<span id="cb53-754"><a href="#cb53-754"></a><span class="in">    aes(label = label), </span></span>
<span id="cb53-755"><a href="#cb53-755"></a><span class="in">    data = graticule_labels, </span></span>
<span id="cb53-756"><a href="#cb53-756"></a><span class="in">    colour = "grey30", </span></span>
<span id="cb53-757"><a href="#cb53-757"></a><span class="in">    size = 2.75</span></span>
<span id="cb53-758"><a href="#cb53-758"></a><span class="in">  ) +</span></span>
<span id="cb53-759"><a href="#cb53-759"></a><span class="in">  scale_colour_manual(values = c(`TRUE` = "#CC0000", `FALSE` = "grey70")) +</span></span>
<span id="cb53-760"><a href="#cb53-760"></a><span class="in">  scale_linetype_manual(values = c(`TRUE` = "solid", `FALSE` = "62")) +</span></span>
<span id="cb53-761"><a href="#cb53-761"></a><span class="in">  labs(x = NULL, y = NULL) +</span></span>
<span id="cb53-762"><a href="#cb53-762"></a><span class="in">  coord_sf(crs = ortho) +</span></span>
<span id="cb53-763"><a href="#cb53-763"></a><span class="in">  theme_void() +</span></span>
<span id="cb53-764"><a href="#cb53-764"></a><span class="in">  theme(legend.position = "none")</span></span>
<span id="cb53-765"><a href="#cb53-765"></a></span>
<span id="cb53-766"><a href="#cb53-766"></a><span class="in">ggsave(</span></span>
<span id="cb53-767"><a href="#cb53-767"></a><span class="in">  here::here("../images/null_island.jpg"), </span></span>
<span id="cb53-768"><a href="#cb53-768"></a><span class="in">  null_island_map,</span></span>
<span id="cb53-769"><a href="#cb53-769"></a><span class="in">  width = 900 / 150,</span></span>
<span id="cb53-770"><a href="#cb53-770"></a><span class="in">  height = 900 / 150,</span></span>
<span id="cb53-771"><a href="#cb53-771"></a><span class="in">  dpi = 150</span></span>
<span id="cb53-772"><a href="#cb53-772"></a><span class="in">)</span></span>
<span id="cb53-773"><a href="#cb53-773"></a><span class="in">```</span></span>
<span id="cb53-774"><a href="#cb53-774"></a></span>
<span id="cb53-775"><a href="#cb53-775"></a>So if you see any co-ordinates on your map located in the Atlantic off the south coast of West Africa, you know that there are almost certainly rows in your data that have co-ordinates located at Null Island.</span>
<span id="cb53-776"><a href="#cb53-776"></a></span>
<span id="cb53-777"><a href="#cb53-777"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/null_island.jpg" alt="A globe map showing Null Island at co-ordinates of 0 longitude and latitude"&gt;&lt;/p&gt;</span>
<span id="cb53-778"><a href="#cb53-778"></a></span>
<span id="cb53-779"><a href="#cb53-779"></a>When we make crime maps we are generally dealing with small areas such as cities and counties. So if you plot a dataset on a map and instead of seeing a map of the area you are interested in, you see a large area of the world with the place you are interested in in one corner and Null Island in the opposite corner, that almost certainly means some co-ordinates are located at Null Island. </span>
<span id="cb53-780"><a href="#cb53-780"></a></span>
<span id="cb53-781"><a href="#cb53-781"></a>As an example, imagine we were trying to create a map of the home addresses of several (fictional) suspects for bank fraud in and around Cairo, Egypt. The data contain 10 rows stored in an object called <span class="in">`cairo_suspects`</span> that looks like this:</span>
<span id="cb53-782"><a href="#cb53-782"></a></span>
<span id="cb53-783"><a href="#cb53-783"></a><span class="in">```{r cairo-suspects-table}</span></span>
<span id="cb53-784"><a href="#cb53-784"></a><span class="in">#| echo: false</span></span>
<span id="cb53-785"><a href="#cb53-785"></a></span>
<span id="cb53-786"><a href="#cb53-786"></a><span class="in">tibble::tribble(</span></span>
<span id="cb53-787"><a href="#cb53-787"></a><span class="in">  ~name, ~address, ~lon, ~lat,</span></span>
<span id="cb53-788"><a href="#cb53-788"></a><span class="in">  "Ahmed Hussein Ayman", "94, El Sheikh Abd El Jalil Issa Street, Al Banafseg 8, Banafseg Districts, New Cairo City, Cairo", 31.4623637, 30.049543,</span></span>
<span id="cb53-789"><a href="#cb53-789"></a><span class="in">  "Mohamed Ali Mohamed", "22, Noran Street, Al Salam First, Al Qalyubiya", 31.4032012, 30.1647536,</span></span>
<span id="cb53-790"><a href="#cb53-790"></a><span class="in">  "Mahmoud Mostafa Ali", "43, Tarek Gamal Street, Cairo", 31.296507, 30.1184382,</span></span>
<span id="cb53-791"><a href="#cb53-791"></a><span class="in">  "Omar El-Badawi", "7, Abou Bakr Al Sediq Street, Al-Obour, Al Qalyubiya", 31.3784444, 30.1781414,</span></span>
<span id="cb53-792"><a href="#cb53-792"></a><span class="in">  "Tarek Hazim Abdel-Rahman", "16, Al Madina Al Mnoura Street, Ma‘ di, Cairo", 31.2632149, 29.9794155,</span></span>
<span id="cb53-793"><a href="#cb53-793"></a><span class="in">  "Youssef Sayyid", "18, Fathy Abou Wedn Street, Shubra al Khayma, Al Qalyubiya", 31.3417734, 30.1562442,</span></span>
<span id="cb53-794"><a href="#cb53-794"></a><span class="in">  "Hussein El-Masri", "61, Al Ashgar Street, South West, El Shorouk City, May Fair, Cairo", 31.6109636, 30.1283769,</span></span>
<span id="cb53-795"><a href="#cb53-795"></a><span class="in">  "Mariam Abdel Mubarak", "15R, Mohamed Farid Street, EL Sheikh Mubarak, Cairo", 31.2490346, 29.9936643,</span></span>
<span id="cb53-796"><a href="#cb53-796"></a><span class="in">  "Farah Youssef Anwar", "35, Al Sadat Road, Neighborhood 9, El Shorouk City, Sunrise, Cairo", 31.6280994, 30.1478049,</span></span>
<span id="cb53-797"><a href="#cb53-797"></a><span class="in">  "Nour El-Seifi", "23, Moustafa Kamel Street, Area 2, Badr, Cairo", 0, 0</span></span>
<span id="cb53-798"><a href="#cb53-798"></a><span class="in">  ) |&gt; </span></span>
<span id="cb53-799"><a href="#cb53-799"></a><span class="in">  knitr::kable()</span></span>
<span id="cb53-800"><a href="#cb53-800"></a><span class="in">```</span></span>
<span id="cb53-801"><a href="#cb53-801"></a></span>
<span id="cb53-802"><a href="#cb53-802"></a></span>
<span id="cb53-803"><a href="#cb53-803"></a><span class="in">```{r cairo-suspects-maps, echo=FALSE, eval=FALSE}</span></span>
<span id="cb53-804"><a href="#cb53-804"></a><span class="in">library(ggspatial)</span></span>
<span id="cb53-805"><a href="#cb53-805"></a></span>
<span id="cb53-806"><a href="#cb53-806"></a><span class="in">cairo_null_island_map1 &lt;- cairo_suspects |&gt; </span></span>
<span id="cb53-807"><a href="#cb53-807"></a><span class="in">  filter(lon != 0) |&gt; </span></span>
<span id="cb53-808"><a href="#cb53-808"></a><span class="in">  ggplot() +</span></span>
<span id="cb53-809"><a href="#cb53-809"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 1, progress = "none") +</span></span>
<span id="cb53-810"><a href="#cb53-810"></a><span class="in">  geom_sf() +</span></span>
<span id="cb53-811"><a href="#cb53-811"></a><span class="in">  scale_x_continuous(expand = expansion(mult = 0.2)) +</span></span>
<span id="cb53-812"><a href="#cb53-812"></a><span class="in">  fixed_plot_aspect(16/9) +</span></span>
<span id="cb53-813"><a href="#cb53-813"></a><span class="in">  theme_void()</span></span>
<span id="cb53-814"><a href="#cb53-814"></a></span>
<span id="cb53-815"><a href="#cb53-815"></a><span class="in">ggsave(</span></span>
<span id="cb53-816"><a href="#cb53-816"></a><span class="in">  here::here("../images/null_island_cairo1.jpg"), </span></span>
<span id="cb53-817"><a href="#cb53-817"></a><span class="in">  cairo_null_island_map1,</span></span>
<span id="cb53-818"><a href="#cb53-818"></a><span class="in">  width = 900 / 150,</span></span>
<span id="cb53-819"><a href="#cb53-819"></a><span class="in">  height = 500 / 150,</span></span>
<span id="cb53-820"><a href="#cb53-820"></a><span class="in">  dpi = 150</span></span>
<span id="cb53-821"><a href="#cb53-821"></a><span class="in">)</span></span>
<span id="cb53-822"><a href="#cb53-822"></a></span>
<span id="cb53-823"><a href="#cb53-823"></a><span class="in">cairo_null_island_map2 &lt;- cairo_suspects |&gt; </span></span>
<span id="cb53-824"><a href="#cb53-824"></a><span class="in">  ggplot() +</span></span>
<span id="cb53-825"><a href="#cb53-825"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 1, progress = "none") +</span></span>
<span id="cb53-826"><a href="#cb53-826"></a><span class="in">  geom_sf() +</span></span>
<span id="cb53-827"><a href="#cb53-827"></a><span class="in">  fixed_plot_aspect(16/9) +</span></span>
<span id="cb53-828"><a href="#cb53-828"></a><span class="in">  theme_void()</span></span>
<span id="cb53-829"><a href="#cb53-829"></a></span>
<span id="cb53-830"><a href="#cb53-830"></a><span class="in">ggsave(</span></span>
<span id="cb53-831"><a href="#cb53-831"></a><span class="in">  here::here("../images/null_island_cairo2.jpg"), </span></span>
<span id="cb53-832"><a href="#cb53-832"></a><span class="in">  cairo_null_island_map2,</span></span>
<span id="cb53-833"><a href="#cb53-833"></a><span class="in">  width = 900 / 150,</span></span>
<span id="cb53-834"><a href="#cb53-834"></a><span class="in">  height = 500 / 150,</span></span>
<span id="cb53-835"><a href="#cb53-835"></a><span class="in">  dpi = 150</span></span>
<span id="cb53-836"><a href="#cb53-836"></a><span class="in">)</span></span>
<span id="cb53-837"><a href="#cb53-837"></a><span class="in">```</span></span>
<span id="cb53-838"><a href="#cb53-838"></a></span>
<span id="cb53-839"><a href="#cb53-839"></a></span>
<span id="cb53-840"><a href="#cb53-840"></a>If we plotted these locations on a map, we might expect to see something like this:</span>
<span id="cb53-841"><a href="#cb53-841"></a></span>
<span id="cb53-842"><a href="#cb53-842"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/null_island_cairo1.jpg" alt="A map showing several points in the city of Cairo, Egypt"&gt;&lt;/p&gt;</span>
<span id="cb53-843"><a href="#cb53-843"></a></span>
<span id="cb53-844"><a href="#cb53-844"></a>But look again at the final row of data in the table above -- the co-ordinates for the final row are both zero. There are several reasons why this might be. Perhaps the address was recorded incorrectly in a police database and that meant that when the addresses were run through geocoding software (which we will learn more about in the next section), no co-ordinates for that row could be found. What this means is that when we plot the data on a map, that map will actually look like this:</span>
<span id="cb53-845"><a href="#cb53-845"></a></span>
<span id="cb53-846"><a href="#cb53-846"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/null_island_cairo2.jpg" alt="A map showing a large proportion of Africa, with several points clustered around the city of Cairo, Egypt in the top-right corner and a single point located in the Atlantic Ocean off the coast of Ghana."&gt;&lt;/p&gt;</span>
<span id="cb53-847"><a href="#cb53-847"></a></span>
<span id="cb53-848"><a href="#cb53-848"></a>What we can see here is most of the points on this map are correctly located in and around Cairo, but a single point is incorrectly located at Null Island.</span>
<span id="cb53-849"><a href="#cb53-849"></a></span>
<span id="cb53-850"><a href="#cb53-850"></a>We can deal with the problem of our data including points located at Null Island using the <span class="in">`st_intersection()`</span> function that we have previously used to clip datasets to the boundaries of other datasets. In this case, we can use <span class="in">`st_intersection()`</span> to remove any rows from the data that are not within the area that the data is supposed to cover.</span>
<span id="cb53-851"><a href="#cb53-851"></a></span>
<span id="cb53-852"><a href="#cb53-852"></a>For example, we know that all the addresses of bank fraud suspects are supposed to be in Egypt, so we can safely clip the suspect data to the boundary of Egypt before mapping the data. There are lots of sources of data on the outlines of countries, but perhaps the most convenient to use in R is the data provided by the rnaturalearth package. We can use the <span class="in">`ne_countries()`</span> function to retrieve the outline of Egypt as an SF object, which we can then use to clip the suspect dataset.</span>
<span id="cb53-853"><a href="#cb53-853"></a></span>
<span id="cb53-854"><a href="#cb53-854"></a></span>
<span id="cb53-855"><a href="#cb53-855"></a><span class="in">```{r null-island-exercise1}</span></span>
<span id="cb53-856"><a href="#cb53-856"></a><span class="in">#| filename: "R Console"</span></span>
<span id="cb53-857"><a href="#cb53-857"></a></span>
<span id="cb53-858"><a href="#cb53-858"></a><span class="in"># Create dataset of fictional fraud suspects in Cairo</span></span>
<span id="cb53-859"><a href="#cb53-859"></a><span class="in"># Note these lines are more than 80 characters long, since if we don't keep each</span></span>
<span id="cb53-860"><a href="#cb53-860"></a><span class="in"># row in the dataset on a single line of code, it becomes very difficult to work</span></span>
<span id="cb53-861"><a href="#cb53-861"></a><span class="in"># out which fields will end up in which rows</span></span>
<span id="cb53-862"><a href="#cb53-862"></a><span class="in">cairo_suspects &lt;- tibble::tribble(</span></span>
<span id="cb53-863"><a href="#cb53-863"></a><span class="in">  ~name, ~address, ~lon, ~lat,</span></span>
<span id="cb53-864"><a href="#cb53-864"></a><span class="in">  "Ahmed Hussein Ayman", "94, El Sheikh Abd El Jalil Issa Street, Al Banafseg 8, Banafseg Districts, New Cairo City, Cairo", 31.4623637, 30.049543,</span></span>
<span id="cb53-865"><a href="#cb53-865"></a><span class="in">  "Mohamed Ali Mohamed", "22, Noran Street, Al Salam First, Al Qalyubiya", 31.4032012, 30.1647536,</span></span>
<span id="cb53-866"><a href="#cb53-866"></a><span class="in">  "Mahmoud Mostafa Ali", "43, Tarek Gamal Street, Cairo", 31.296507, 30.1184382,</span></span>
<span id="cb53-867"><a href="#cb53-867"></a><span class="in">  "Omar El-Badawi", "7, Abou Bakr Al Sediq Street, Al-Obour, Al Qalyubiya", 31.3784444, 30.1781414,</span></span>
<span id="cb53-868"><a href="#cb53-868"></a><span class="in">  "Tarek Hazim Abdel-Rahman", "16, Al Madina Al Mnoura Street, Ma‘ di, Cairo", 31.2632149, 29.9794155,</span></span>
<span id="cb53-869"><a href="#cb53-869"></a><span class="in">  "Youssef Sayyid", "18, Fathy Abou Wedn Street, Shubra al Khayma, Al Qalyubiya", 31.3417734, 30.1562442,</span></span>
<span id="cb53-870"><a href="#cb53-870"></a><span class="in">  "Hussein El-Masri", "61, Al Ashgar Street, South West, El Shorouk City, May Fair, Cairo", 31.6109636, 30.1283769,</span></span>
<span id="cb53-871"><a href="#cb53-871"></a><span class="in">  "Mariam Abdel Mubarak", "15R, Mohamed Farid Street, EL Sheikh Mubarak, Cairo", 31.2490346, 29.9936643,</span></span>
<span id="cb53-872"><a href="#cb53-872"></a><span class="in">  "Farah Youssef Anwar", "35, Al Sadat Road, Neighborhood 9, El Shorouk City, Sunrise, Cairo", 31.6280994, 30.1478049,</span></span>
<span id="cb53-873"><a href="#cb53-873"></a><span class="in">  "Nour El-Seifi", "23, Moustafa Kamel Street, Area 2, Badr, Cairo", 0, 0</span></span>
<span id="cb53-874"><a href="#cb53-874"></a><span class="in">  ) |&gt; </span></span>
<span id="cb53-875"><a href="#cb53-875"></a><span class="in">  st_as_sf(coords = c("lon", "lat"), crs = "EPSG:4326")</span></span>
<span id="cb53-876"><a href="#cb53-876"></a></span>
<span id="cb53-877"><a href="#cb53-877"></a><span class="in"># By default, `ne_countries()` does not return an SF object, so we have to</span></span>
<span id="cb53-878"><a href="#cb53-878"></a><span class="in"># specify that is what we want using the `returnclass = "sf"` argument</span></span>
<span id="cb53-879"><a href="#cb53-879"></a><span class="in">egypt_outline &lt;- rnaturalearth::ne_countries(</span></span>
<span id="cb53-880"><a href="#cb53-880"></a><span class="in">  country = "Egypt", </span></span>
<span id="cb53-881"><a href="#cb53-881"></a><span class="in">  returnclass = "sf"</span></span>
<span id="cb53-882"><a href="#cb53-882"></a><span class="in">)</span></span>
<span id="cb53-883"><a href="#cb53-883"></a></span>
<span id="cb53-884"><a href="#cb53-884"></a><span class="in"># Clip dataset to the boundary of Egypt</span></span>
<span id="cb53-885"><a href="#cb53-885"></a><span class="in">cairo_suspects_valid &lt;- st_intersection(cairo_suspects, egypt_outline)</span></span>
<span id="cb53-886"><a href="#cb53-886"></a><span class="in">```</span></span>
<span id="cb53-887"><a href="#cb53-887"></a></span>
<span id="cb53-888"><a href="#cb53-888"></a>Now if we were to plot a map using the <span class="in">`cairo_suspects_valid`</span> object, we would see the map covered only the Cairo area, as we originally wanted.</span>
<span id="cb53-889"><a href="#cb53-889"></a></span>
<span id="cb53-890"><a href="#cb53-890"></a></span>
<span id="cb53-891"><a href="#cb53-891"></a>::: {.callout-quiz .callout}</span>
<span id="cb53-892"><a href="#cb53-892"></a><span class="fu">#### Tidy content</span></span>
<span id="cb53-893"><a href="#cb53-893"></a></span>
<span id="cb53-894"><a href="#cb53-894"></a><span class="in">```{r tidy-content-quiz}</span></span>
<span id="cb53-895"><a href="#cb53-895"></a><span class="in">#| echo: false</span></span>
<span id="cb53-896"><a href="#cb53-896"></a></span>
<span id="cb53-897"><a href="#cb53-897"></a><span class="in">tidy_content_quiz1 &lt;- c(</span></span>
<span id="cb53-898"><a href="#cb53-898"></a><span class="in">  "A column that stores only numeric values",</span></span>
<span id="cb53-899"><a href="#cb53-899"></a><span class="in">  answer = "A column that contains both height and weight in the same field",</span></span>
<span id="cb53-900"><a href="#cb53-900"></a><span class="in">  "A column that contains a single constant value for all rows",</span></span>
<span id="cb53-901"><a href="#cb53-901"></a><span class="in">  "A column that only contains unique IDs"</span></span>
<span id="cb53-902"><a href="#cb53-902"></a><span class="in">)</span></span>
<span id="cb53-903"><a href="#cb53-903"></a></span>
<span id="cb53-904"><a href="#cb53-904"></a><span class="in">tidy_content_quiz2 &lt;- c(</span></span>
<span id="cb53-905"><a href="#cb53-905"></a><span class="in">  "To merge two columns into one",</span></span>
<span id="cb53-906"><a href="#cb53-906"></a><span class="in">  "To remove missing values from a dataset",</span></span>
<span id="cb53-907"><a href="#cb53-907"></a><span class="in">  answer = "To split a column into multiple columns based on a delimiter",</span></span>
<span id="cb53-908"><a href="#cb53-908"></a><span class="in">  "To convert categorical data into numeric values"</span></span>
<span id="cb53-909"><a href="#cb53-909"></a><span class="in">)</span></span>
<span id="cb53-910"><a href="#cb53-910"></a><span class="in">```</span></span>
<span id="cb53-911"><a href="#cb53-911"></a></span>
<span id="cb53-912"><a href="#cb53-912"></a></span>
<span id="cb53-913"><a href="#cb53-913"></a>**Which of the following is an example of messy data in a single column?**</span>
<span id="cb53-914"><a href="#cb53-914"></a></span>
<span id="cb53-915"><a href="#cb53-915"></a><span class="in">`r webexercises::longmcq(tidy_content_quiz1)`</span></span>
<span id="cb53-916"><a href="#cb53-916"></a></span>
<span id="cb53-917"><a href="#cb53-917"></a></span>
<span id="cb53-918"><a href="#cb53-918"></a>**What is the purpose of the `separate()` function in R?**</span>
<span id="cb53-919"><a href="#cb53-919"></a></span>
<span id="cb53-920"><a href="#cb53-920"></a><span class="in">`r webexercises::longmcq(tidy_content_quiz2)`</span></span>
<span id="cb53-921"><a href="#cb53-921"></a></span>
<span id="cb53-922"><a href="#cb53-922"></a></span>
<span id="cb53-923"><a href="#cb53-923"></a>:::</span>
<span id="cb53-924"><a href="#cb53-924"></a></span>
<span id="cb53-925"><a href="#cb53-925"></a></span>
<span id="cb53-926"><a href="#cb53-926"></a></span>
<span id="cb53-927"><a href="#cb53-927"></a><span class="fu">## Geocoding locations</span></span>
<span id="cb53-928"><a href="#cb53-928"></a></span>
<span id="cb53-929"><a href="#cb53-929"></a>Throughout this course we have used geographic data that includes locations stored as pairs of co-ordinates, e.g. latitude and longitude or easting and northing. Sometimes geographic data will not contain co-ordinates but instead store the locations of places or events as free-text addresses.</span>
<span id="cb53-930"><a href="#cb53-930"></a></span>
<span id="cb53-931"><a href="#cb53-931"></a>&lt;a href="http://www.kelleysgrilleandbar.com/" title="Kelley's Grill </span>
<span id="cb53-932"><a href="#cb53-932"></a>&amp; Bar website"&gt;&lt;img src="../images/kelleys.jpg" class="right-side-image" style="border: 1px solid #333;"&gt;&lt;/a&gt;</span>
<span id="cb53-933"><a href="#cb53-933"></a></span>
<span id="cb53-934"><a href="#cb53-934"></a>Address fields can be very messy indeed. This is because addresses can often be stored in different formats, include different abbreviations or use different spellings (including typos). For example, the official postal address '<span class="co">[</span><span class="ot">Kelley's Grill &amp; Bar</span><span class="co">](http://www.kelleysgrilleandbar.com/)</span>, 15540 State Avenue, Basehor, Kansas 66007, United States' could be stored in a local police report as:</span>
<span id="cb53-935"><a href="#cb53-935"></a></span>
<span id="cb53-936"><a href="#cb53-936"></a><span class="ss">  * </span>Kelly's Bar, 15540 US Highway 40, Basehor</span>
<span id="cb53-937"><a href="#cb53-937"></a><span class="ss">  * </span>Kelley's Grille, 15540 State</span>
<span id="cb53-938"><a href="#cb53-938"></a><span class="ss">  * </span>Kelley's, 15540 State Av</span>
<span id="cb53-939"><a href="#cb53-939"></a><span class="ss">  * </span>Kelley's Bar and Grill, 15540 State Ave</span>
<span id="cb53-940"><a href="#cb53-940"></a><span class="ss">  * </span>Kelley's Bar, State Av and 155th St</span>
<span id="cb53-941"><a href="#cb53-941"></a><span class="ss">  * </span>Kelly's Grill, State Ave btwn 155 and 158</span>
<span id="cb53-942"><a href="#cb53-942"></a></span>
<span id="cb53-943"><a href="#cb53-943"></a>All of these address descriptions would probably be good enough for local police officers to know which building the author intended to reference. But since all these different addresses relate to the same physical location, they would make it very hard to (for example) work out how many incidents had occurred at Kelley's Grill &amp; Bar using <span class="in">`count()`</span> or a similar function.</span>
<span id="cb53-944"><a href="#cb53-944"></a></span>
<span id="cb53-945"><a href="#cb53-945"></a>To make use of data containing addresses, it is typically necessary to *geocode* the locations, i.e. to convert the addresses into co-ordinates. The many ways to describe an address mean that geocoding is often quite hard.</span>
<span id="cb53-946"><a href="#cb53-946"></a></span>
<span id="cb53-947"><a href="#cb53-947"></a>&lt;a href="https://jessecambon.github.io/tidygeocoder/" title="tidygeocoder website"&gt;&lt;img src="../images/tidygeocoder.png" class="right-side-image"&gt;&lt;/a&gt;</span>
<span id="cb53-948"><a href="#cb53-948"></a></span>
<span id="cb53-949"><a href="#cb53-949"></a>We can geocode addresses in R using the <span class="co">[</span><span class="ot">tidygeocoder package</span><span class="co">](https://jessecambon.github.io/tidygeocoder/)</span>, which provides an interface to several online geocoding services. </span>
<span id="cb53-950"><a href="#cb53-950"></a></span>
<span id="cb53-951"><a href="#cb53-951"></a>To run a geocoding service an organisation has to maintain a database of many millions of addresses (which must be constantly updated) and handle addresses in many different formats, so organisations typically charge for these services or limit how many addresses you can geocode for free. Most services also require you to register, even if you are only making few-enough queries that you will not be charged. tidygeocoder supports several geocoding services:</span>
<span id="cb53-952"><a href="#cb53-952"></a></span>
<span id="cb53-953"><a href="#cb53-953"></a><span class="in">```{r geocoding-services}</span></span>
<span id="cb53-954"><a href="#cb53-954"></a><span class="in">#| echo: false</span></span>
<span id="cb53-955"><a href="#cb53-955"></a></span>
<span id="cb53-956"><a href="#cb53-956"></a><span class="in">tribble(</span></span>
<span id="cb53-957"><a href="#cb53-957"></a><span class="in">  ~service, ~coverage, ~`free limits`,</span></span>
<span id="cb53-958"><a href="#cb53-958"></a><span class="in">  "[Nominatim](https://nominatim.org/)", "Worldwide", "1 address per second",</span></span>
<span id="cb53-959"><a href="#cb53-959"></a><span class="in">  "[Location IQ](https://locationiq.com/)", "Worldwide", "5,000 addresses per day",</span></span>
<span id="cb53-960"><a href="#cb53-960"></a><span class="in">  "[Geoapify](https://geoapify.com/)", "Worldwide", "3,000 addresses per day",</span></span>
<span id="cb53-961"><a href="#cb53-961"></a><span class="in">  "[OpenCage](https://opencagedata.com/)", "Worldwide", "2,500 addresses per day",</span></span>
<span id="cb53-962"><a href="#cb53-962"></a><span class="in">  "[TomTom](https://developer.tomtom.com/)", "Worldwide", "2,500 addresses per day",</span></span>
<span id="cb53-963"><a href="#cb53-963"></a><span class="in">  "[Google](https://developers.google.com/maps/documentation/geocoding/overview/)", "Worldwide", "40,000 addresses per month",</span></span>
<span id="cb53-964"><a href="#cb53-964"></a><span class="in">  "[Geocodio](https://www.geocod.io/)", "United States and Canada", "2,500 addresses per day",</span></span>
<span id="cb53-965"><a href="#cb53-965"></a><span class="in">  "[US Census](https://geocoding.geo.census.gov/)", "United States", "none"</span></span>
<span id="cb53-966"><a href="#cb53-966"></a><span class="in">) |&gt;</span></span>
<span id="cb53-967"><a href="#cb53-967"></a><span class="in">  gt::gt() |&gt;</span></span>
<span id="cb53-968"><a href="#cb53-968"></a><span class="in">  gt::fmt_markdown()</span></span>
<span id="cb53-969"><a href="#cb53-969"></a><span class="in">```</span></span>
<span id="cb53-970"><a href="#cb53-970"></a></span>
<span id="cb53-971"><a href="#cb53-971"></a>The tidygeocoder package also supports some other services that do not offer any free option -- you can find out more about these options on the <span class="co">[</span><span class="ot">package website</span><span class="co">](https://jessecambon.github.io/tidygeocoder/articles/geocoder_services.html)</span>.</span>
<span id="cb53-972"><a href="#cb53-972"></a></span>
<span id="cb53-973"><a href="#cb53-973"></a>To illustrate the geocoding process, we will find co-ordinates for the addresses in the object <span class="in">`addresses`</span>, which holds data for 10 sexual assaults in Chicago.</span>
<span id="cb53-974"><a href="#cb53-974"></a></span>
<span id="cb53-977"><a href="#cb53-977"></a><span class="in">```{r}</span></span>
<span id="cb53-978"><a href="#cb53-978"></a><span class="co">#| echo: false</span></span>
<span id="cb53-979"><a href="#cb53-979"></a><span class="co">#| message: false</span></span>
<span id="cb53-980"><a href="#cb53-980"></a></span>
<span id="cb53-981"><a href="#cb53-981"></a><span class="fu">tribble</span>(</span>
<span id="cb53-982"><a href="#cb53-982"></a>  <span class="sc">~</span><span class="st">"offense_date"</span>, <span class="sc">~</span><span class="st">"location_type"</span>, <span class="sc">~</span><span class="st">"address"</span>,</span>
<span id="cb53-983"><a href="#cb53-983"></a>  <span class="st">"2019-01-01T00:00:00Z"</span>, <span class="st">"residence"</span>,  <span class="st">"2400 W Carmen Ave"</span>,</span>
<span id="cb53-984"><a href="#cb53-984"></a>  <span class="st">"2019-01-01T00:00:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"2700 S TRIPP AVE"</span>,</span>
<span id="cb53-985"><a href="#cb53-985"></a>  <span class="st">"2019-01-01T11:44:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"3700 S PAULINA ST"</span>,</span>
<span id="cb53-986"><a href="#cb53-986"></a>  <span class="st">"2019-01-01T11:44:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"3700 S Paulina St"</span>,</span>
<span id="cb53-987"><a href="#cb53-987"></a>  <span class="st">"2019-01-01T16:37:00Z"</span>,   <span class="st">"government"</span>,   <span class="st">"1100 S HAMILTON AVE"</span>,</span>
<span id="cb53-988"><a href="#cb53-988"></a>  <span class="st">"2019-01-02T17:09:00Z"</span>,   <span class="st">"gas station"</span>,  <span class="cn">NA</span>,</span>
<span id="cb53-989"><a href="#cb53-989"></a>  <span class="st">"2019-01-02T17:09:00Z"</span>,   <span class="st">"gas station"</span>,  <span class="st">"8200 S HALSTED ST"</span>,</span>
<span id="cb53-990"><a href="#cb53-990"></a>  <span class="st">"2019-01-05T00:01:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"1300 N HUDSON AVE"</span>,</span>
<span id="cb53-991"><a href="#cb53-991"></a>  <span class="st">"2019-01-05T14:00:00Z"</span>,   <span class="st">"other"</span>, <span class="st">"6200 N Claremont Ave"</span>,</span>
<span id="cb53-992"><a href="#cb53-992"></a>  <span class="st">"2019-01-07T06:50:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"9500 S BELL AVE"</span>,</span>
<span id="cb53-993"><a href="#cb53-993"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb53-994"><a href="#cb53-994"></a>  <span class="fu">type_convert</span>() <span class="sc">|&gt;</span> </span>
<span id="cb53-995"><a href="#cb53-995"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>() <span class="sc">|&gt;</span> </span>
<span id="cb53-996"><a href="#cb53-996"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb53-997"><a href="#cb53-997"></a><span class="in">```</span></span>
<span id="cb53-998"><a href="#cb53-998"></a></span>
<span id="cb53-999"><a href="#cb53-999"></a>Since most geocoding services limit the number of addresses you can look up at a time, the first step in geocoding is removing duplicate addresses and rows with missing address values. This avoids us geocoding identical addresses several times, which would otherwise unnecessarily increase our chance of hitting the limit on geocoding queries each day.</span>
<span id="cb53-1000"><a href="#cb53-1000"></a></span>
<span id="cb53-1001"><a href="#cb53-1001"></a>We will also add the city and state to the end of each address, since at the moment (as with much data produced by local organisations) it includes only the building number and street.</span>
<span id="cb53-1002"><a href="#cb53-1002"></a></span>
<span id="cb53-1003"><a href="#cb53-1003"></a></span>
<span id="cb53-1006"><a href="#cb53-1006"></a><span class="in">```{r}</span></span>
<span id="cb53-1007"><a href="#cb53-1007"></a><span class="co">#| eval: false</span></span>
<span id="cb53-1008"><a href="#cb53-1008"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-1009"><a href="#cb53-1009"></a></span>
<span id="cb53-1010"><a href="#cb53-1010"></a><span class="co"># Create example dataset of addresses to be geocoded</span></span>
<span id="cb53-1011"><a href="#cb53-1011"></a>addresses <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb53-1012"><a href="#cb53-1012"></a>  <span class="sc">~</span><span class="st">"offense_date"</span>, <span class="sc">~</span><span class="st">"location_type"</span>, <span class="sc">~</span><span class="st">"address"</span>,</span>
<span id="cb53-1013"><a href="#cb53-1013"></a>  <span class="st">"2019-01-01T00:00:00Z"</span>, <span class="st">"residence"</span>,  <span class="st">"2400 W Carmen Ave"</span>,</span>
<span id="cb53-1014"><a href="#cb53-1014"></a>  <span class="st">"2019-01-01T00:00:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"2700 S TRIPP AVE"</span>,</span>
<span id="cb53-1015"><a href="#cb53-1015"></a>  <span class="st">"2019-01-01T11:44:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"3700 S PAULINA ST"</span>,</span>
<span id="cb53-1016"><a href="#cb53-1016"></a>  <span class="st">"2019-01-01T11:44:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"3700 S Paulina St"</span>,</span>
<span id="cb53-1017"><a href="#cb53-1017"></a>  <span class="st">"2019-01-01T16:37:00Z"</span>,   <span class="st">"government"</span>,   <span class="st">"1100 S HAMILTON AVE"</span>,</span>
<span id="cb53-1018"><a href="#cb53-1018"></a>  <span class="st">"2019-01-02T17:09:00Z"</span>,   <span class="st">"gas station"</span>,  <span class="cn">NA</span>,</span>
<span id="cb53-1019"><a href="#cb53-1019"></a>  <span class="st">"2019-01-02T17:09:00Z"</span>,   <span class="st">"gas station"</span>,  <span class="st">"8200 S HALSTED ST"</span>,</span>
<span id="cb53-1020"><a href="#cb53-1020"></a>  <span class="st">"2019-01-05T00:01:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"1300 N HUDSON AVE"</span>,</span>
<span id="cb53-1021"><a href="#cb53-1021"></a>  <span class="st">"2019-01-05T14:00:00Z"</span>,   <span class="st">"other"</span>, <span class="st">"6200 N Claremont Ave"</span>,</span>
<span id="cb53-1022"><a href="#cb53-1022"></a>  <span class="st">"2019-01-07T06:50:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"9500 S BELL AVE"</span>,</span>
<span id="cb53-1023"><a href="#cb53-1023"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb53-1024"><a href="#cb53-1024"></a>  <span class="fu">type_convert</span>()</span>
<span id="cb53-1025"><a href="#cb53-1025"></a></span>
<span id="cb53-1026"><a href="#cb53-1026"></a>addresses_for_geocoding <span class="ot">&lt;-</span> addresses <span class="sc">|&gt;</span> </span>
<span id="cb53-1027"><a href="#cb53-1027"></a>  <span class="co"># Drop rows that have NA values in the `address` column</span></span>
<span id="cb53-1028"><a href="#cb53-1028"></a>  <span class="fu">drop_na</span>(address) <span class="sc">|&gt;</span> </span>
<span id="cb53-1029"><a href="#cb53-1029"></a>  <span class="co"># Add city and state then convert to upper case so that `count()` will not </span></span>
<span id="cb53-1030"><a href="#cb53-1030"></a>  <span class="co"># treat identical addresses as different because of different cases, e.g. </span></span>
<span id="cb53-1031"><a href="#cb53-1031"></a>  <span class="co"># 'ST' vs 'St' as abbreviations for 'Street'</span></span>
<span id="cb53-1032"><a href="#cb53-1032"></a>  <span class="fu">mutate</span>(<span class="at">address =</span> <span class="fu">str_to_upper</span>(<span class="fu">str_glue</span>(<span class="st">"{address}, CHICAGO, IL"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb53-1033"><a href="#cb53-1033"></a>  <span class="co"># Select only the address column, since we won't send the other columns to the</span></span>
<span id="cb53-1034"><a href="#cb53-1034"></a>  <span class="co"># geocoding function</span></span>
<span id="cb53-1035"><a href="#cb53-1035"></a>  <span class="fu">select</span>(address) <span class="sc">|&gt;</span> </span>
<span id="cb53-1036"><a href="#cb53-1036"></a>  <span class="co"># Find all the unique rows in the data</span></span>
<span id="cb53-1037"><a href="#cb53-1037"></a>  <span class="fu">distinct</span>(address)</span>
<span id="cb53-1038"><a href="#cb53-1038"></a></span>
<span id="cb53-1039"><a href="#cb53-1039"></a><span class="fu">head</span>(addresses_for_geocoding)</span>
<span id="cb53-1040"><a href="#cb53-1040"></a><span class="in">```</span></span>
<span id="cb53-1041"><a href="#cb53-1041"></a></span>
<span id="cb53-1042"><a href="#cb53-1042"></a></span>
<span id="cb53-1045"><a href="#cb53-1045"></a><span class="in">```{r}</span></span>
<span id="cb53-1046"><a href="#cb53-1046"></a><span class="co">#| echo: false</span></span>
<span id="cb53-1047"><a href="#cb53-1047"></a></span>
<span id="cb53-1048"><a href="#cb53-1048"></a><span class="co"># Create example dataset of addresses to be geocoded</span></span>
<span id="cb53-1049"><a href="#cb53-1049"></a>addresses <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb53-1050"><a href="#cb53-1050"></a>  <span class="sc">~</span><span class="st">"offense_date"</span>, <span class="sc">~</span><span class="st">"location_type"</span>, <span class="sc">~</span><span class="st">"address"</span>,</span>
<span id="cb53-1051"><a href="#cb53-1051"></a>  <span class="st">"2019-01-01T00:00:00Z"</span>, <span class="st">"residence"</span>,  <span class="st">"2400 W Carmen Ave"</span>,</span>
<span id="cb53-1052"><a href="#cb53-1052"></a>  <span class="st">"2019-01-01T00:00:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"2700 S TRIPP AVE"</span>,</span>
<span id="cb53-1053"><a href="#cb53-1053"></a>  <span class="st">"2019-01-01T11:44:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"3700 S PAULINA ST"</span>,</span>
<span id="cb53-1054"><a href="#cb53-1054"></a>  <span class="st">"2019-01-01T11:44:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"3700 S Paulina St"</span>,</span>
<span id="cb53-1055"><a href="#cb53-1055"></a>  <span class="st">"2019-01-01T16:37:00Z"</span>,   <span class="st">"government"</span>,   <span class="st">"1100 S HAMILTON AVE"</span>,</span>
<span id="cb53-1056"><a href="#cb53-1056"></a>  <span class="st">"2019-01-02T17:09:00Z"</span>,   <span class="st">"gas station"</span>,  <span class="cn">NA</span>,</span>
<span id="cb53-1057"><a href="#cb53-1057"></a>  <span class="st">"2019-01-02T17:09:00Z"</span>,   <span class="st">"gas station"</span>,  <span class="st">"8200 S HALSTED ST"</span>,</span>
<span id="cb53-1058"><a href="#cb53-1058"></a>  <span class="st">"2019-01-05T00:01:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"1300 N HUDSON AVE"</span>,</span>
<span id="cb53-1059"><a href="#cb53-1059"></a>  <span class="st">"2019-01-05T14:00:00Z"</span>,   <span class="st">"other"</span>, <span class="st">"6200 N Claremont Ave"</span>,</span>
<span id="cb53-1060"><a href="#cb53-1060"></a>  <span class="st">"2019-01-07T06:50:00Z"</span>,   <span class="st">"residence"</span>,    <span class="st">"9500 S BELL AVE"</span>,</span>
<span id="cb53-1061"><a href="#cb53-1061"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb53-1062"><a href="#cb53-1062"></a>  <span class="fu">type_convert</span>()</span>
<span id="cb53-1063"><a href="#cb53-1063"></a></span>
<span id="cb53-1064"><a href="#cb53-1064"></a>addresses_for_geocoding <span class="ot">&lt;-</span> addresses <span class="sc">|&gt;</span> </span>
<span id="cb53-1065"><a href="#cb53-1065"></a>  <span class="co"># Drop rows that have NA values in the `address` column</span></span>
<span id="cb53-1066"><a href="#cb53-1066"></a>  <span class="fu">drop_na</span>(address) <span class="sc">|&gt;</span> </span>
<span id="cb53-1067"><a href="#cb53-1067"></a>  <span class="co"># Add city and state then convert to upper case so that `count()` will not </span></span>
<span id="cb53-1068"><a href="#cb53-1068"></a>  <span class="co"># treat identical addresses as different because of different cases, e.g. </span></span>
<span id="cb53-1069"><a href="#cb53-1069"></a>  <span class="co"># 'ST' vs 'St' as abbreviations for 'Street'</span></span>
<span id="cb53-1070"><a href="#cb53-1070"></a>  <span class="fu">mutate</span>(<span class="at">address =</span> <span class="fu">str_to_upper</span>(<span class="fu">str_glue</span>(<span class="st">"{address}, CHICAGO, IL"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb53-1071"><a href="#cb53-1071"></a>  <span class="co"># Select only the address column, since we won't send the other columns to the</span></span>
<span id="cb53-1072"><a href="#cb53-1072"></a>  <span class="co"># geocoding function</span></span>
<span id="cb53-1073"><a href="#cb53-1073"></a>  <span class="fu">select</span>(address) <span class="sc">|&gt;</span> </span>
<span id="cb53-1074"><a href="#cb53-1074"></a>  <span class="co"># Find all the unique rows in the data</span></span>
<span id="cb53-1075"><a href="#cb53-1075"></a>  <span class="fu">distinct</span>(address)</span>
<span id="cb53-1076"><a href="#cb53-1076"></a></span>
<span id="cb53-1077"><a href="#cb53-1077"></a><span class="fu">head</span>(addresses_for_geocoding)</span>
<span id="cb53-1078"><a href="#cb53-1078"></a><span class="in">```</span></span>
<span id="cb53-1079"><a href="#cb53-1079"></a></span>
<span id="cb53-1080"><a href="#cb53-1080"></a></span>
<span id="cb53-1081"><a href="#cb53-1081"></a>Since two addresses in the data were duplicates and one address was missing, we now have eight unique addresses, stored in a tibble with a single column. We can use this as the input to the <span class="in">`geocode()`</span> function from the tidygeocoder package. The <span class="in">`address`</span> argument specifies which column in the data contains the addresses and the <span class="in">`method`</span> column specifies which geocoding service to use. In this case we use the Nominatim service (because it does not require registration and works worldwide). Nominatim is based on OpenStreetMap data, so can be chosen by specifying <span class="in">`method = "osm"`</span>.</span>
<span id="cb53-1082"><a href="#cb53-1082"></a></span>
<span id="cb53-1085"><a href="#cb53-1085"></a><span class="in">```{r}</span></span>
<span id="cb53-1086"><a href="#cb53-1086"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-1087"><a href="#cb53-1087"></a></span>
<span id="cb53-1088"><a href="#cb53-1088"></a>addresses_geocoded <span class="ot">&lt;-</span> tidygeocoder<span class="sc">::</span><span class="fu">geocode</span>(</span>
<span id="cb53-1089"><a href="#cb53-1089"></a>  addresses_for_geocoding, </span>
<span id="cb53-1090"><a href="#cb53-1090"></a>  <span class="at">address =</span> <span class="st">"address"</span>, </span>
<span id="cb53-1091"><a href="#cb53-1091"></a>  <span class="at">method =</span> <span class="st">"osm"</span></span>
<span id="cb53-1092"><a href="#cb53-1092"></a>)</span>
<span id="cb53-1093"><a href="#cb53-1093"></a><span class="in">```</span></span>
<span id="cb53-1094"><a href="#cb53-1094"></a></span>
<span id="cb53-1097"><a href="#cb53-1097"></a><span class="in">```{r}</span></span>
<span id="cb53-1098"><a href="#cb53-1098"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-1099"><a href="#cb53-1099"></a></span>
<span id="cb53-1100"><a href="#cb53-1100"></a>addresses_geocoded</span>
<span id="cb53-1101"><a href="#cb53-1101"></a><span class="in">```</span></span>
<span id="cb53-1102"><a href="#cb53-1102"></a></span>
<span id="cb53-1103"><a href="#cb53-1103"></a>Now that we have the latitude and longitude for each address, we can join that back to the original data using the address column to match the two datasets together. To do this we will create a temporary column in the original <span class="in">`addresses`</span> object that matches the formatting changes we made to the original address.</span>
<span id="cb53-1104"><a href="#cb53-1104"></a></span>
<span id="cb53-1107"><a href="#cb53-1107"></a><span class="in">```{r}</span></span>
<span id="cb53-1108"><a href="#cb53-1108"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-1109"><a href="#cb53-1109"></a></span>
<span id="cb53-1110"><a href="#cb53-1110"></a>addresses_final <span class="ot">&lt;-</span> addresses <span class="sc">|&gt;</span> </span>
<span id="cb53-1111"><a href="#cb53-1111"></a>  <span class="co"># Create a temporary address column to use in matching the geocoded addresses</span></span>
<span id="cb53-1112"><a href="#cb53-1112"></a>  <span class="fu">mutate</span>(<span class="at">temp_address =</span> <span class="fu">str_to_upper</span>(<span class="fu">str_glue</span>(<span class="st">"{address}, CHICAGO, IL"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb53-1113"><a href="#cb53-1113"></a>  <span class="co"># `left_join()` keeps all the rows in the left-hand dataset (the original</span></span>
<span id="cb53-1114"><a href="#cb53-1114"></a>  <span class="co"># `addresses` object) and matching rows in the right-hand dataset (the </span></span>
<span id="cb53-1115"><a href="#cb53-1115"></a>  <span class="co"># geocoding results)</span></span>
<span id="cb53-1116"><a href="#cb53-1116"></a>  <span class="fu">left_join</span>(addresses_geocoded, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"temp_address"</span> <span class="ot">=</span> <span class="st">"address"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb53-1117"><a href="#cb53-1117"></a>  <span class="co"># Remove the temporary address column</span></span>
<span id="cb53-1118"><a href="#cb53-1118"></a>  <span class="fu">select</span>(<span class="sc">-</span>temp_address)</span>
<span id="cb53-1119"><a href="#cb53-1119"></a></span>
<span id="cb53-1120"><a href="#cb53-1120"></a>addresses_final</span>
<span id="cb53-1121"><a href="#cb53-1121"></a><span class="in">```</span></span>
<span id="cb53-1122"><a href="#cb53-1122"></a></span>
<span id="cb53-1123"><a href="#cb53-1123"></a>We can now use this data as we would any other spatial data. We would often start by converting our new object to an SF object using <span class="in">`st_as_sf()`</span>. In that case, remember that all the geocoding services return co-ordinates as latitude and longitude using the WGS84 co-ordinate reference system, so you should use EPSG:4326.</span>
<span id="cb53-1124"><a href="#cb53-1124"></a></span>
<span id="cb53-1125"><a href="#cb53-1125"></a></span>
<span id="cb53-1126"><a href="#cb53-1126"></a></span>
<span id="cb53-1127"><a href="#cb53-1127"></a><span class="fu">## Conflicts between function names</span></span>
<span id="cb53-1128"><a href="#cb53-1128"></a></span>
<span id="cb53-1129"><a href="#cb53-1129"></a>R packages are written by experts in different types of data analysis. This means we can use R to conduct all sorts of analysis, including cutting-edge techniques. But because R packages are not all written by people working for a single organisation, it means there can sometimes be functions from different packages that have the same name -- often because they do similar (but not necessarily identical) things. </span>
<span id="cb53-1130"><a href="#cb53-1130"></a></span>
<span id="cb53-1131"><a href="#cb53-1131"></a>This can be a problem because R might be running a function from one package when you think you have written code that uses a function from another package. If the two functions have different arguments or produce different types of result, your code is unlikely to run properly. For example, if two functions have the same name but one produces an SF object while the other produces a tibble, that might cause problems later in your code if you are using other functions that expect to receive a particular type of input.</span>
<span id="cb53-1132"><a href="#cb53-1132"></a></span>
<span id="cb53-1133"><a href="#cb53-1133"></a>One example of functions from two different packages with the same name is the <span class="in">`geocode()`</span> function. We have already learned that the tidygeocoder package contains a function called <span class="in">`geocode()`</span>, but the ggmap package (for example) also has a function called <span class="in">`geocode()`</span>.</span>
<span id="cb53-1134"><a href="#cb53-1134"></a></span>
<span id="cb53-1135"><a href="#cb53-1135"></a>If both the tidygeocoder and ggmap packages are loaded, R will use the <span class="in">`geocode()`</span> function _from the package that has been loaded most recently_. So if your script includes the code:</span>
<span id="cb53-1136"><a href="#cb53-1136"></a></span>
<span id="cb53-1139"><a href="#cb53-1139"></a><span class="in">```{r}</span></span>
<span id="cb53-1140"><a href="#cb53-1140"></a><span class="co">#| eval: false</span></span>
<span id="cb53-1141"><a href="#cb53-1141"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-1142"><a href="#cb53-1142"></a></span>
<span id="cb53-1143"><a href="#cb53-1143"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggmap, tidygeocoder)</span>
<span id="cb53-1144"><a href="#cb53-1144"></a></span>
<span id="cb53-1145"><a href="#cb53-1145"></a><span class="co"># [Code to load data, etc.]</span></span>
<span id="cb53-1146"><a href="#cb53-1146"></a></span>
<span id="cb53-1147"><a href="#cb53-1147"></a><span class="co"># Geocode some data</span></span>
<span id="cb53-1148"><a href="#cb53-1148"></a>geocoded_data <span class="ot">&lt;-</span> <span class="fu">geocode</span>(ungeocoded_data)</span>
<span id="cb53-1149"><a href="#cb53-1149"></a><span class="in">```</span></span>
<span id="cb53-1150"><a href="#cb53-1150"></a></span>
<span id="cb53-1151"><a href="#cb53-1151"></a>Then R will use the <span class="in">`geocode()`</span> function from tidygeocoder, since that was loaded *after* ggmap. But if you reverse the order in which these packages are loaded:</span>
<span id="cb53-1152"><a href="#cb53-1152"></a></span>
<span id="cb53-1155"><a href="#cb53-1155"></a><span class="in">```{r}</span></span>
<span id="cb53-1156"><a href="#cb53-1156"></a><span class="co">#| eval: false</span></span>
<span id="cb53-1157"><a href="#cb53-1157"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-1158"><a href="#cb53-1158"></a></span>
<span id="cb53-1159"><a href="#cb53-1159"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidygeocoder, ggmap)</span>
<span id="cb53-1160"><a href="#cb53-1160"></a></span>
<span id="cb53-1161"><a href="#cb53-1161"></a><span class="co"># [Code to load data, etc.]</span></span>
<span id="cb53-1162"><a href="#cb53-1162"></a></span>
<span id="cb53-1163"><a href="#cb53-1163"></a><span class="co"># Geocode some data</span></span>
<span id="cb53-1164"><a href="#cb53-1164"></a>geocoded_data <span class="ot">&lt;-</span> <span class="fu">geocode</span>(ungeocoded_data)</span>
<span id="cb53-1165"><a href="#cb53-1165"></a><span class="in">```</span></span>
<span id="cb53-1166"><a href="#cb53-1166"></a></span>
<span id="cb53-1167"><a href="#cb53-1167"></a>Then R will use the <span class="in">`geocode()`</span> function from ggmap because that package was loaded after tidygeocoder.</span>
<span id="cb53-1168"><a href="#cb53-1168"></a></span>
<span id="cb53-1169"><a href="#cb53-1169"></a>Knowing which of the two functions R uses when you type <span class="in">`geocode()`</span> is important because they accept different inputs. The <span class="in">`geocode()`</span> function from ggmap expects the first argument to contain a vector of addresses, while the <span class="in">`geocode()`</span> function from tidygeocoder expects a data frame or tibble. If you provide the wrong type of input, either function will produce an error.</span>
<span id="cb53-1170"><a href="#cb53-1170"></a></span>
<span id="cb53-1171"><a href="#cb53-1171"></a>Our R scripts very often load the tidyverse package, which loads nine packages (dplyr, forcats, ggplot2, lubridate, purrr, readr, tibble, tidyr and stringr) that we often need to use. Since we more commonly want the tidyverse functions than the functions they mask (for example, we frequently use the <span class="in">`filter()`</span> function from dplyr but rarely use the function with the same name in the stats package), it is common to load tidyverse after loading all the other packages needed for our code.</span>
<span id="cb53-1172"><a href="#cb53-1172"></a></span>
<span id="cb53-1173"><a href="#cb53-1173"></a>There are several ways you can resolve conflicts between functions from different packages:</span>
<span id="cb53-1174"><a href="#cb53-1174"></a></span>
<span id="cb53-1175"><a href="#cb53-1175"></a><span class="ss">  * </span>Make sure you load packages in the order that gives you access to the functions you need. This can be simple if there are few conflicts, but can fall apart if you later change your code to load different packages. This is the option that almost everyone uses most of the time (and most people use all of the time).</span>
<span id="cb53-1176"><a href="#cb53-1176"></a><span class="ss">  * </span>Specify which function you want to use using the <span class="in">`::`</span> notation that we have already used in previous chapters, e.g. by using the code <span class="in">`ggmap::geocode()`</span> or <span class="in">`tidygeocoder::geocode()`</span>.</span>
<span id="cb53-1177"><a href="#cb53-1177"></a><span class="ss">  * </span>Load the <span class="in">`conflicted`</span> package, which produces an error whenever you try to use a function that is included in more than one loaded package. This makes it easy to know when there is a potential conflict, which you can then resolve using the <span class="in">`conflict_prefer()`</span> function. Note, however, that you have to load the conflicted package by adding <span class="in">`library(conflicted)`</span> to your script file _before_ you call <span class="in">`pacman::p_load()`</span>.</span>
<span id="cb53-1178"><a href="#cb53-1178"></a>    </span>
<span id="cb53-1179"><a href="#cb53-1179"></a>In this final option, the authors of the <span class="in">`conflicted`</span> package recommend that you specify which conflict-prone functions to use by calling <span class="in">`conflict_prefer()`</span> just after you've loaded all the packages you need for your script. For example:</span>
<span id="cb53-1180"><a href="#cb53-1180"></a></span>
<span id="cb53-1183"><a href="#cb53-1183"></a><span class="in">```{r}</span></span>
<span id="cb53-1184"><a href="#cb53-1184"></a><span class="co">#| eval: false</span></span>
<span id="cb53-1185"><a href="#cb53-1185"></a><span class="co">#| filename: "R Console"</span></span>
<span id="cb53-1186"><a href="#cb53-1186"></a></span>
<span id="cb53-1187"><a href="#cb53-1187"></a><span class="co"># This code produces several conflicts:</span></span>
<span id="cb53-1188"><a href="#cb53-1188"></a><span class="co"># *  the `stats` package, which is loaded automatically in the background when </span></span>
<span id="cb53-1189"><a href="#cb53-1189"></a><span class="co">#    you start R, contains a function called `filter()`</span></span>
<span id="cb53-1190"><a href="#cb53-1190"></a><span class="co"># *  `MASS` contains a function called `select()`</span></span>
<span id="cb53-1191"><a href="#cb53-1191"></a><span class="co"># *  `dplyr` contains functions called `filter()` and `select()`</span></span>
<span id="cb53-1192"><a href="#cb53-1192"></a><span class="fu">library</span>(conflicted)</span>
<span id="cb53-1193"><a href="#cb53-1193"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(dplyr, MASS)</span>
<span id="cb53-1194"><a href="#cb53-1194"></a></span>
<span id="cb53-1195"><a href="#cb53-1195"></a><span class="co"># This code specifies that in the case of both conflicts, we want to use the</span></span>
<span id="cb53-1196"><a href="#cb53-1196"></a><span class="co"># functions from `dplyr`</span></span>
<span id="cb53-1197"><a href="#cb53-1197"></a><span class="fu">conflict_prefer</span>(<span class="st">"select"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb53-1198"><a href="#cb53-1198"></a><span class="fu">conflict_prefer</span>(<span class="st">"filter"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb53-1199"><a href="#cb53-1199"></a></span>
<span id="cb53-1200"><a href="#cb53-1200"></a><span class="co"># In the rest of this script, any reference to `filter()` or `select()` will</span></span>
<span id="cb53-1201"><a href="#cb53-1201"></a><span class="co"># use the functions with those names in the `dplyr` package, not those from</span></span>
<span id="cb53-1202"><a href="#cb53-1202"></a><span class="co"># `stats` or `MASS`</span></span>
<span id="cb53-1203"><a href="#cb53-1203"></a><span class="in">```</span></span>
<span id="cb53-1204"><a href="#cb53-1204"></a></span>
<span id="cb53-1205"><a href="#cb53-1205"></a>Understanding function-name conflicts is important because they can be the cause of errors that are (for reasons we needn't explain in detail) extremely hard to track down the cause of. So make sure that when you load packages, you take note of any messages in the console that warn you that functions have been masked. As with other messages in R, they will not always need you to take any action, but you always need to read the message and make a decision about whether to take any action.</span>
<span id="cb53-1206"><a href="#cb53-1206"></a></span>
<span id="cb53-1207"><a href="#cb53-1207"></a></span>
<span id="cb53-1208"><a href="#cb53-1208"></a>::: {.callout-important}</span>
<span id="cb53-1209"><a href="#cb53-1209"></a><span class="fu">#### Load tidyverse last</span></span>
<span id="cb53-1210"><a href="#cb53-1210"></a></span>
<span id="cb53-1211"><a href="#cb53-1211"></a>One way to minimise how confusing package conflicts can be is to always load packages in a consistent order. I strongly recommend loading packages in alphabetical order, _then_ loading the tidyverse package _last_.</span>
<span id="cb53-1212"><a href="#cb53-1212"></a>:::</span>
<span id="cb53-1213"><a href="#cb53-1213"></a></span>
<span id="cb53-1214"><a href="#cb53-1214"></a></span>
<span id="cb53-1215"><a href="#cb53-1215"></a>::: {.callout-quiz .callout}</span>
<span id="cb53-1216"><a href="#cb53-1216"></a><span class="fu">#### Package conflicts</span></span>
<span id="cb53-1217"><a href="#cb53-1217"></a></span>
<span id="cb53-1218"><a href="#cb53-1218"></a><span class="in">```{r conflict-quiz}</span></span>
<span id="cb53-1219"><a href="#cb53-1219"></a><span class="in">#| echo: false</span></span>
<span id="cb53-1220"><a href="#cb53-1220"></a></span>
<span id="cb53-1221"><a href="#cb53-1221"></a><span class="in">conflict_quiz1 &lt;- c(</span></span>
<span id="cb53-1222"><a href="#cb53-1222"></a><span class="in">  "The function that is from the `tidyverse` suite of packages.",</span></span>
<span id="cb53-1223"><a href="#cb53-1223"></a><span class="in">  "The function from the package that was loaded *first*",</span></span>
<span id="cb53-1224"><a href="#cb53-1224"></a><span class="in">  answer = "The function from the package that was loaded *last*",</span></span>
<span id="cb53-1225"><a href="#cb53-1225"></a><span class="in">  "Neither function will run because R will produce an error."</span></span>
<span id="cb53-1226"><a href="#cb53-1226"></a><span class="in">)</span></span>
<span id="cb53-1227"><a href="#cb53-1227"></a><span class="in">```</span></span>
<span id="cb53-1228"><a href="#cb53-1228"></a></span>
<span id="cb53-1229"><a href="#cb53-1229"></a>**If you load two packages in R that both contain a function with the same name, which function will R use by default?**</span>
<span id="cb53-1230"><a href="#cb53-1230"></a></span>
<span id="cb53-1231"><a href="#cb53-1231"></a><span class="in">`r webexercises::longmcq(conflict_quiz1)`</span></span>
<span id="cb53-1232"><a href="#cb53-1232"></a></span>
<span id="cb53-1233"><a href="#cb53-1233"></a></span>
<span id="cb53-1234"><a href="#cb53-1234"></a>:::</span>
<span id="cb53-1235"><a href="#cb53-1235"></a></span>
<span id="cb53-1236"><a href="#cb53-1236"></a></span>
<span id="cb53-1237"><a href="#cb53-1237"></a></span>
<span id="cb53-1238"><a href="#cb53-1238"></a><span class="fu">## In summary</span></span>
<span id="cb53-1239"><a href="#cb53-1239"></a></span>
<span id="cb53-1240"><a href="#cb53-1240"></a>In this chapter we have learned to tidy messy data to make it easier to work with. In real-world data analysis (not just crime mapping), you will often have to deal with data that is messy in different ways. Fortunately, you can use R to fix all of these problems in a way that minimises the risk that you might introduce mistakes when you clean the data.</span>
<span id="cb53-1241"><a href="#cb53-1241"></a></span>
<span id="cb53-1242"><a href="#cb53-1242"></a></span>
<span id="cb53-1243"><a href="#cb53-1243"></a>::: {.box .reading}</span>
<span id="cb53-1244"><a href="#cb53-1244"></a></span>
<span id="cb53-1245"><a href="#cb53-1245"></a>You can find out more about data cleaning and tidying with these </span>
<span id="cb53-1246"><a href="#cb53-1246"></a>resources:</span>
<span id="cb53-1247"><a href="#cb53-1247"></a></span>
<span id="cb53-1248"><a href="#cb53-1248"></a><span class="ss">  * </span>A [tutorial on using the <span class="in">`pivot_longer()`</span> and <span class="in">`pivot_wider()`</span> functions to </span>
<span id="cb53-1249"><a href="#cb53-1249"></a>    convert data between long and wide format](https://tidyr.tidyverse.org/articles/pivot.html).</span>
<span id="cb53-1250"><a href="#cb53-1250"></a><span class="ss">  * </span>A more-detailed <span class="co">[</span><span class="ot">Introduction to `tidygeocoder`</span><span class="co">](https://jessecambon.github.io/tidygeocoder/articles/tidygeocoder.html)</span>.</span>
<span id="cb53-1251"><a href="#cb53-1251"></a><span class="ss">  * </span>An <span class="co">[</span><span class="ot">introduction to some other packages than can help you clean and tidy data</span><span class="co">](https://rfortherestofus.com/2019/12/how-to-clean-messy-data-in-r/)</span>.</span>
<span id="cb53-1252"><a href="#cb53-1252"></a><span class="ss">  * </span>A more-detailed <span class="co">[</span><span class="ot">description of how to use the `conflicted` package</span><span class="co">](https://conflicted.r-lib.org/)</span>.</span>
<span id="cb53-1253"><a href="#cb53-1253"></a></span>
<span id="cb53-1254"><a href="#cb53-1254"></a>:::</span>
<span id="cb53-1255"><a href="#cb53-1255"></a></span>
<span id="cb53-1256"><a href="#cb53-1256"></a></span>
<span id="cb53-1257"><a href="#cb53-1257"></a>::: {.callout-quiz .callout}</span>
<span id="cb53-1258"><a href="#cb53-1258"></a><span class="fu">#### Check your knowledge: Revision questions</span></span>
<span id="cb53-1259"><a href="#cb53-1259"></a></span>
<span id="cb53-1260"><a href="#cb53-1260"></a>Answer these questions to check you have understood the main points covered in this chapter. Write between 50 and 100 words to answer each question.</span>
<span id="cb53-1261"><a href="#cb53-1261"></a></span>
<span id="cb53-1262"><a href="#cb53-1262"></a><span class="ss">1. </span>Why is tidy data important in crime mapping and data analysis? Explain the key principles of tidy data and discuss how its structure makes data analysis more efficient. </span>
<span id="cb53-1263"><a href="#cb53-1263"></a><span class="ss">2. </span>What are the differences between long and wide data formats?</span>
<span id="cb53-1264"><a href="#cb53-1264"></a><span class="ss">3. </span>Describe how multiple variables stored in a single column can be separated into distinct columns, and what issues might arise in doing this.</span>
<span id="cb53-1265"><a href="#cb53-1265"></a><span class="ss">4. </span>Why do missing values in a dataset cause problems, and how can they be handled in R?</span>
<span id="cb53-1266"><a href="#cb53-1266"></a><span class="ss">5. </span>What are function name conflicts in R, and how can they be resolved?</span>
<span id="cb53-1267"><a href="#cb53-1267"></a>:::</span>
<span id="cb53-1268"><a href="#cb53-1268"></a></span>
<span id="cb53-1269"><a href="#cb53-1269"></a>&lt;p class="full-width-image"&gt;&lt;img src="../images/tidydata_7.jpg" alt="Cartoon saying make friends with tidy data!"&gt;&lt;/p&gt;</span>
<span id="cb53-1270"><a href="#cb53-1270"></a></span>
<span id="cb53-1271"><a href="#cb53-1271"></a>::: {.credits}</span>
<span id="cb53-1272"><a href="#cb53-1272"></a>&lt;a href="https://twitter.com/allison_horst"&gt;Artwork by @allison_horst&lt;/a&gt;</span>
<span id="cb53-1273"><a href="#cb53-1273"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by/4.0/">
<p>This book is available under a Creative Commons Attribution 4.0 International licence</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>