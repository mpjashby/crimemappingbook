<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>16&nbsp; Mapping crime over time – Learn Crime Mapping with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../appendices/read_functions.html" rel="next">
<link href="../15_no_maps/index.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<!-- START OF INCLUDED HEADER -->

<!--
This file contains code that will be included in the header of each page of the
quarto book
-->

<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>

<!-- END OF INCLUDED HEADER -->


<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../include/webex.css">
<meta name="twitter:title" content="16&nbsp; Mapping crime over time – Learn Crime Mapping with R">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="../images/cover_image.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../16_mapping_time/index.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Mapping crime over time</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/cover_image.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Learn Crime Mapping with R</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/mpjashby/crimemappingbook/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../learn_crime_mapping_with_r.epub" title="Download ePub" class="quarto-navigation-tool px-1" aria-label="Download ePub"><i class="bi bi-journal"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../contents.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install the software needed for this book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_getting_started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_your_first_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Your first crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_data_wrangling/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_your_second_crime_map/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Your second crime map</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_code_with_style/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Code with style</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_mapping_crime_patterns/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Mapping crime patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_map_context/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Giving a map context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_handling_bugs/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Handling bugs in your code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_mapping_areas/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Mapping area data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../10_place_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Using data about places</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../11_mapping_hotspots/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Mapping hotspots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../12_messy_data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Handling messy data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../13_crime_series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Mapping crime series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../14_writing_reports/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Writing reports in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../15_no_maps/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Presenting spatial data without maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../16_mapping_time/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Mapping crime over time</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/read_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Functions for reading data into R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/map_checklist.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Checklist: Making a good crime map</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/common_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Common R errors and how to fix them</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/functions_to_avoid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Some R functions you should avoid</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendices/handling_errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Checklist: handling code errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">In this chapter</h2>
   
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">16.1</span> Introduction</a></li>
  <li><a href="#handling-dates-in-r" id="toc-handling-dates-in-r" class="nav-link" data-scroll-target="#handling-dates-in-r"><span class="header-section-number">16.2</span> Handling dates in R</a></li>
  <li><a href="#showing-change-over-time" id="toc-showing-change-over-time" class="nav-link" data-scroll-target="#showing-change-over-time"><span class="header-section-number">16.3</span> Showing change over time</a></li>
  <li><a href="#how-to-map-change-over-time" id="toc-how-to-map-change-over-time" class="nav-link" data-scroll-target="#how-to-map-change-over-time"><span class="header-section-number">16.4</span> How to map change over time</a></li>
  <li><a href="#making-animated-maps" id="toc-making-animated-maps" class="nav-link" data-scroll-target="#making-animated-maps"><span class="header-section-number">16.5</span> Making animated maps</a></li>
  <li><a href="#in-summary" id="toc-in-summary" class="nav-link" data-scroll-target="#in-summary"><span class="header-section-number">16.6</span> In summary</a></li>
  </ul>
<div class="toc-actions"><ul class="collapse"><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-mapping-time" class="quarto-section-identifier"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Mapping crime over time</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Learn to show change over time on crime maps and charts</strong></p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>This chapter has not yet been updated for 2025, so some material is out of date. Check back for an update in mid-February 2025.</p>
</div>
</div>
<section id="introduction" class="level2" data-number="16.1">
<h2 data-number="16.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">16.1</span> Introduction</h2>
<p>Understanding how crime varies over time is just as important as understanding how it varies between places. Very few places are hotspots of crime all the time – business districts might be hotspots of pickpocketing in the daytime but deserted at night, while a nearby entertainment district may be quiet in the daytime but a violence hotspot at night.</p>
<p>Crime varies over time in lots of ways. For example, there was a long-term drop in many types of crime in many countries starting in the mid 1990s, e.g. <a href="https://crimesciencejournal.biomedcentral.com/articles/10.1186/s40163-016-0051-z">residential burglary in England and Wales dropped by 67% between 1993 and 2008</a> while the number of <a href="https://www.brennancenter.org/our-work/analysis-opinion/takeaways-2019-crime-data-major-american-cities">homicides in New York City dropped almost 90% from 2,245 in 1990 to 289 in 2018</a>.</p>
<p>There are also short-term variations in crime. Many types of crime are more common at some types of year than others (known as <em>seasonal variation</em>). In Chicago, for example, assaults, residential burglaries and personal robberies all vary throughout the year, with assaults in particular being consistently higher in summer than winter.</p>
<p class="full-width-image">
<img src="images/chicago_seasonal_variation.png" alt="Chart showing that assaults, personal robberies and residential burglaries in Chicago all vary by seasonally throughout the year.">
</p>
<p>It is also important to understand short-term variation in crime. For example, both property damage and sexual violence in Chicago peaks at weekends, while there are fewer shoplifting offences on Sundays when some shops are closed or have shorter opening hours.</p>
<p class="full-width-image">
<img src="images/chicago_weekly_variation.png" alt="Chart showing that property damage, sexual violence and shoplifting in Chicago all vary by day of the week.">
</p>
<p>Understanding variation in crime over time is important because we can use the temporal concentration of crime to focus efforts to respond to crime most effectively. For example, imagine we wanted to deploy police patrols to a hotspot to respond to a particular crime problem. Such patrols could be very effective if they were targeted at the times when crimes were most likely to happen or completely useless if the officers were deployed at the wrong day or the wrong time.</p>
<p>In this tutorial we will learn how to incorporate variation over time into our analysis of where crime happens, including making animated maps like this one:</p>
<p class="centered-image">
<img src="https://github.com/mpjashby/crimemapping/raw/main/inst/tutorials/16_mapping_time/images/chicago_downtown_agg_assaults.gif" alt="Animated map showing how the density of aggravated assaults in Chicago varies throughout the hours of the day.">
</p>
</section>
<section id="handling-dates-in-r" class="level2" data-number="16.2">
<h2 data-number="16.2" class="anchored" data-anchor-id="handling-dates-in-r"><span class="header-section-number">16.2</span> Handling dates in R</h2>
<p class="full-width-image">
<img src="images/lubridate_cartoon.jpg" alt="Cartoon showing little monsters feeding lubridate functions into a Back-to-the-Future-style car with the licence plate LUBRDAT.">
</p>
<p>At a very basic level, computers can store data in two days: they can store numbers and they can store text. This makes storing dates slightly complicated, because dates aren’t completely like numbers and they aren’t completely like text either. Dates aren’t like numbers because you can’t do normal maths with dates (e.g.&nbsp;what date is the 29th of January plus one month?) and aren’t like text because you can do some maths with them (e.g.&nbsp;it is easy to calculate three days from today). Dates are especially complicated because they can be written as text in so many different ways. For example 17 January can be represented in all of these ways, all of them equally valid (although some are specific to particular countries):</p>
<ul>
<li>17/01/2025</li>
<li>17.01.25</li>
<li>1/17/2025</li>
<li>2025-01-17</li>
<li>17 Jan 25</li>
<li>17 January 2025</li>
<li>January 17th 2025</li>
</ul>
<p><a href="https://lubridate.tidyverse.org/" title="lubridate website"><img src="images/lubridate.png" class="right-side-image"></a></p>
<p>R deals with this problem by <em>storing</em> dates internally as if they were numbers and <em>displaying</em> them (e.g.&nbsp;in the console or in a Quarto document) as if they were text, by default in the format <code>2025-01-07</code>. Fortunately, we don’t have to worry about how dates and times are stored internally in R because we can use the <a href="https://lubridate.tidyverse.org/"><code>lubridate</code> package</a> to work with them. <code>lubridate</code> contains functions for working with dates, including extracting parts of a date with functions such as <code>month()</code> and converting text to date values with functions like <code>ymd()</code>.</p>
<p>Because of the special nature of dates, if we want to work with a date variable (for example to create a chart of crime over time) it is important that it is stored as a date, not as text or as a number. Many R functions for reading data, including <code>read_csv()</code>, <code>read_tsv()</code> and <code>read_excel()</code>, will try to recognise columns of data that contain dates and times stored in common formats. These will automatically be stored as date variables when the data is loaded.</p>
<p>If R does not recognise automatically that a value contains a date, we can convert it to a date by using the date-parsing functions from <code>lubridate</code>. Which function to use depends on the order in which the components of the date (e.g.&nbsp; day, month and year) appear in the variable. For example, to convert the text “Saturday 17 January 1981” to a date format we can use the <code>dmy()</code> function because the <strong>d</strong>ay of the month comes first, the <strong>m</strong>onth next and then the <strong>y</strong>ear. Similarly, converting the text “01/17/81” needs the function <code>mdy()</code>. Note that the <code>lubridate</code> date-parsing functions are able convert both numeric and text-based months, and to ignore elements that aren’t needed, such as weekday names.</p>
<p>If a date is stored in multiple columns in a dataset, e.g.&nbsp;one column for the year, one column for the month and one column for the day, we can create a single date column using the <code>make_date()</code> function to combine them. Similarly, we can create a date-time column using the <code>make_datetime()</code> function. For example, if we have a dataset of crimes called <code>thefts</code>:</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a>thefts <span class="sc">|&gt;</span>  </span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="at">date =</span> <span class="fu">make_date</span>(<span class="at">year =</span> year, <span class="at">month =</span> month_of_year, <span class="at">day =</span> day_of_month)</span>
<span id="cb1-6"><a href="#cb1-6"></a>  ) <span class="sc">|&gt;</span>  </span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="fu">select</span>(day_of_month, month_of_year, year, date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 1,840 × 4
   day_of_month month_of_year  year date      
          &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt; &lt;date&gt;    
 1            1             9  2020 2020-09-01
 2            1             9  2020 2020-09-01
 3            1             9  2020 2020-09-01
 4            1             9  2020 2020-09-01
 5            1             9  2020 2020-09-01
 6            1             9  2020 2020-09-01
 7            1             9  2020 2020-09-01
 8            1             9  2020 2020-09-01
 9            1             9  2020 2020-09-01
10            1             9  2020 2020-09-01
# ℹ 1,830 more rows</code></pre>
</div>
</div>
<p>Note that in this dataset, the <code>date</code> variable we have just created has the type <code>&lt;date&gt;</code>.</p>
<p>Once we have converted dates stored as text to dates stored as dates, R understands that they are dates and we can do things like compare them. So while running <code>"Sat 17 January 1981" == "01/17/81"</code> to test if two dates are the same would give the answer <code>FALSE</code> (because the two pieces of text are different), once we’ve converted the text to date values R can tell that the two dates are the same:</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># This code returns TRUE only because the two pieces of text are identical</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="st">"Sat 17 January 1981"</span> <span class="sc">==</span> <span class="st">"Sat 17 January 1981"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># This code returns FALSE because the two pieces of text are different, even</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"># though the dates they represent are the same</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="st">"Sat 17 January 1981"</span> <span class="sc">==</span> <span class="st">"01/17/81"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># This code returns TRUE because R knows they are dates and so compares them as</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co"># dates, finding that the two dates are the same</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="fu">dmy</span>(<span class="st">"Sat 17 January 1981"</span>) <span class="sc">==</span> <span class="fu">mdy</span>(<span class="st">"01/17/81"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>[1] TRUE</code></pre>
</div>
</div>
<section id="working-with-dates" class="level3" data-number="16.2.1">
<h3 data-number="16.2.1" class="anchored" data-anchor-id="working-with-dates"><span class="header-section-number">16.2.1</span> Working with dates</h3>
<p>When analysing dates and times, it is often useful to be able to extract date or time portions. We can do this with the <code>lubridate</code> functions <code>year()</code>, <code>month()</code>, <code>wday()</code> (for day of the week), <code>mday()</code> (for day of the month), <code>yday()</code> (for day of the year, counting from 1 January), <code>hour()</code>, <code>minute()</code> and <code>second()</code>, each of which extracts the relevant portion of a date or time as a number. The <code>month()</code> and <code>wday()</code> functions are slightly different, because they can also return the day or month name as text by specifying the argument <code>label = TRUE</code>. We can see this by extracting the different portions of the current date and time, which we can retrieve with the <code>now()</code> function from <code>lubridate</code>.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb9" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">message</span>(<span class="st">"Current year: "</span>, <span class="fu">year</span>(<span class="fu">now</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Current year: 2025</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">message</span>(<span class="st">"Current month (as a number): "</span>, <span class="fu">month</span>(<span class="fu">now</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Current month (as a number): 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">message</span>(<span class="st">"Current month (as text, abbreviated): "</span>, <span class="fu">month</span>(<span class="fu">now</span>(), <span class="at">label =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Current month (as text, abbreviated): Jan</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">message</span>(<span class="st">"Current month (as text): "</span>, <span class="fu">month</span>(<span class="fu">now</span>(), <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">abbr =</span> <span class="cn">FALSE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Current month (as text): January</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="fu">message</span>(<span class="st">"Current day of the year (days since 1 Jan): "</span>, <span class="fu">yday</span>(<span class="fu">now</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Current day of the year (days since 1 Jan): 7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">message</span>(<span class="st">"Current day of the month: "</span>, <span class="fu">mday</span>(<span class="fu">now</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Current day of the month: 7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="fu">message</span>(<span class="st">"Current day of the week (as a number): "</span>, <span class="fu">wday</span>(<span class="fu">now</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Current day of the week (as a number): 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu">message</span>(<span class="st">"Current day of the week (as text): "</span>, <span class="fu">wday</span>(<span class="fu">now</span>(), <span class="at">label =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Current day of the week (as text): Tue</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">message</span>(<span class="st">"Current hour of the day: "</span>, <span class="fu">hour</span>(<span class="fu">now</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Current hour of the day: 14</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="fu">message</span>(<span class="st">"Current minute: "</span>, <span class="fu">minute</span>(<span class="fu">now</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Current minute: 10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">message</span>(<span class="st">"Current second: "</span>, <span class="fu">second</span>(<span class="fu">now</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Current second: 40.7392361164093</code></pre>
</div>
</div>
<p>It is sometimes useful to be able to add to or subtract from dates. For example, if you wanted to filter a dataset so that only records from the past 28 days were included, you would need to work out the date 28 days ago. We can do this with a group of functions from <code>lubridate</code> that store a period of time that we can then add to or subtract from an existing date. These functions are <code>years()</code>, <code>months()</code>, <code>weeks()</code>, <code>days()</code>, <code>hours()</code>, <code>minutes()</code>, and <code>seconds()</code>.</p>
<div class="box notewell">
<p>In the <code>lubridate</code> package, functions that are used to <em>extract</em> parts of a date are <em>singular</em>, e.g.&nbsp;<code>day()</code>, <code>month()</code>, <code>year()</code>. Functions that are used to <em>manipulate</em> dates by adding or subtracting from them are <em>plural</em>, e.g.&nbsp; <code>days()</code>, <code>months()</code>, <code>years()</code>. So, for example, you would use the code <code>month(now())</code> to extract the month (as a number between 1 and 12) from the current date but the code <code>now() + months(1)</code> to find out what the date and time will be one month from now.</p>
</div>
<p>To subtract 28 days from today’s date (which we can retrieve with the <code>today()</code> function), we would use <code>today() - days(28)</code>.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb31" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">message</span>(<span class="fu">str_glue</span>(<span class="st">"Today is {today()} and 28 days ago was {today() - days(28)}"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Today is 2025-01-07 and 28 days ago was 2024-12-10</code></pre>
</div>
</div>
<p>Adding or subtracting periods from dates can be very useful when combined with the <code>filter()</code> function from the <code>dplyr()</code> package. For example, if we had a dataset of crimes stored in an object called <code>crimes</code> and wanted to extract only those that occurred in the most-recent seven days, we could do this:</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb33" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="fu">filter</span>(crimes, occur_date <span class="sc">&gt;=</span> <span class="fu">today</span>() <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 52 × 5
   incident_key occur_date murder longitude latitude
          &lt;dbl&gt; &lt;date&gt;     &lt;lgl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
 1    192545751 2025-01-04 FALSE      -73.9     40.8
 2    193418291 2025-01-02 FALSE      -73.9     40.8
 3    193694861 2024-12-31 FALSE      -73.9     40.9
 4    194817576 2025-01-04 FALSE      -73.8     40.9
 5    195013387 2025-01-02 FALSE      -73.9     40.8
 6    196000890 2025-01-01 FALSE      -73.9     40.9
 7    196315233 2025-01-06 FALSE      -73.9     40.8
 8    196414298 2025-01-03 FALSE      -73.9     40.8
 9    196525187 2025-01-04 TRUE       -73.9     40.8
10    196582020 2025-01-02 FALSE      -73.9     40.8
# ℹ 42 more rows</code></pre>
</div>
</div>
<p>If we wanted to extract crimes that occurred between two dates, we can use the <code>between()</code> function from <code>dplyr</code>, which returns either <code>TRUE</code> or <code>FALSE</code> depending on whether each item in the first argument is between the values given in the second and third arguments (inclusive).</p>
<div class="tutorial">
<p>For example, complete the following code by replacing the text <code>____</code> and <code>____</code> with <code>ymd()</code> functions to extract only crimes occurring between 3 and 31 December 2024 inclusive.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb35" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">filter</span>(crimes, <span class="fu">between</span>(occur_date, ____, ____))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre data-code-line-numbers=""><code>Error in parse(text = input): &lt;text&gt;:1:37: unexpected input
1: filter(crimes, between(occur_date, __
                                        ^</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># Add the dates to the following code in YYYY-MM-DD format (because you are </span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="co"># using the function `ymd()`)</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="fu">filter</span>(crimes, <span class="fu">between</span>(occur_date, <span class="fu">ymd</span>(<span class="st">""</span>), <span class="fu">ymd</span>(<span class="st">""</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 0 × 5
# ℹ 5 variables: incident_key &lt;dbl&gt;, occur_date &lt;date&gt;, murder &lt;lgl&gt;,
#   longitude &lt;dbl&gt;, latitude &lt;dbl&gt;</code></pre>
</div>
</div>
</div>
<p>When filtering based on dates or times, it is important to understand that R can store dates in two ways: as a <em>date</em> object or as a <em>date-time</em> object (shown as <code>&lt;dttm&gt;</code> when we print a tibble). Date variables store only a date with no time, while date-time variables always include a time component, even if the data doesn’t contain any information about time. If we store a variable that only has information about the date of an event as a date-time variable, R will silently add the time midnight to each date. This is important because if we compare a date variable to a date-time variable, R will silently convert the dates to date-times with the times set to midnight. If we are trying to filter crimes between two times, this might not be what we want. For example, if we used the code:</p>
<div class="sourceCode" id="cb39" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">between</span>(offence_date, <span class="fu">ymd</span>(<span class="st">"2021-01-01"</span>), <span class="fu">ymd</span>(<span class="st">"2021-01-31"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to extract all the crimes that occurred in January 2021, that would work as we expected only if <code>offence_date</code> was a date variable. If the <code>offence_date</code> column instead held dates <em>and</em> times, R would filter the data <em>as if</em> we had specified:</p>
<div class="sourceCode" id="cb40" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="fu">between</span>(offence_date, <span class="fu">ymd_hm</span>(<span class="st">"2021-01-01 00:00"</span>), <span class="fu">ymd_hm</span>(<span class="st">"2021-01-31 00:00"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which would exclude any crimes that occurred on 31 January (except those occurring at exactly midnight). To deal with this problem, we can either check to make sure the variables we are filtering on are date variables, convert them to date variables using the <code>as_date()</code> function, or assume that they might be date-time variables and specify the exact time that we want as the end of our range. For example, specifying:</p>
<div class="sourceCode" id="cb41" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="fu">between</span>(offence_date, <span class="fu">ymd_hm</span>(<span class="st">"2021-01-01 00:00"</span>), <span class="fu">ymd_hm</span>(<span class="st">"2021-01-31 23:59"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or</p>
<div class="sourceCode" id="cb42" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="fu">between</span>(<span class="fu">as_date</span>(offence_date), <span class="fu">ymd</span>(<span class="st">"2021-01-01"</span>), <span class="fu">ymd</span>(<span class="st">"2021-01-31"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>would allow us to select all the crimes occurring in January 2021.</p>
</section>
</section>
<section id="showing-change-over-time" class="level2" data-number="16.3">
<h2 data-number="16.3" class="anchored" data-anchor-id="showing-change-over-time"><span class="header-section-number">16.3</span> Showing change over time</h2>
<p>One common task in crime analysis is to show how crime changes over time. The simplest way to do this is to produce a <em>time-series chart</em>. For example, we can see how the frequency of aggravated assaults recorded by police in Chicago has changed over time:</p>
<p class="full-width-image">
<img src="images/chicago_assault_trend.png" alt="Chart showing that the weekly frequency of aggravated assaults in Chicago from 2010 to 2019, including seasonal increases each summer and lower frequency of assaults from 2013 to 2015.">
</p>
<p>In this section we will learn how to construct a time-series chart like this. To illustrate this process, we will use an object called <code>assaults</code> that contains records of aggravated assaults in Chicago from 2010 to 2019.</p>
<div class="cell">
<div class="cell-output-display">
<div id="vpbaamaknb" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#vpbaamaknb table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#vpbaamaknb thead, #vpbaamaknb tbody, #vpbaamaknb tfoot, #vpbaamaknb tr, #vpbaamaknb td, #vpbaamaknb th {
  border-style: none;
}

#vpbaamaknb p {
  margin: 0;
  padding: 0;
}

#vpbaamaknb .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#vpbaamaknb .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#vpbaamaknb .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#vpbaamaknb .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#vpbaamaknb .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vpbaamaknb .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vpbaamaknb .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vpbaamaknb .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#vpbaamaknb .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#vpbaamaknb .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#vpbaamaknb .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#vpbaamaknb .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#vpbaamaknb .gt_spanner_row {
  border-bottom-style: hidden;
}

#vpbaamaknb .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#vpbaamaknb .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#vpbaamaknb .gt_from_md > :first-child {
  margin-top: 0;
}

#vpbaamaknb .gt_from_md > :last-child {
  margin-bottom: 0;
}

#vpbaamaknb .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#vpbaamaknb .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#vpbaamaknb .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#vpbaamaknb .gt_row_group_first td {
  border-top-width: 2px;
}

#vpbaamaknb .gt_row_group_first th {
  border-top-width: 2px;
}

#vpbaamaknb .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vpbaamaknb .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#vpbaamaknb .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#vpbaamaknb .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vpbaamaknb .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vpbaamaknb .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#vpbaamaknb .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#vpbaamaknb .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#vpbaamaknb .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vpbaamaknb .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vpbaamaknb .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#vpbaamaknb .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vpbaamaknb .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#vpbaamaknb .gt_left {
  text-align: left;
}

#vpbaamaknb .gt_center {
  text-align: center;
}

#vpbaamaknb .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#vpbaamaknb .gt_font_normal {
  font-weight: normal;
}

#vpbaamaknb .gt_font_bold {
  font-weight: bold;
}

#vpbaamaknb .gt_font_italic {
  font-style: italic;
}

#vpbaamaknb .gt_super {
  font-size: 65%;
}

#vpbaamaknb .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#vpbaamaknb .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#vpbaamaknb .gt_indent_1 {
  text-indent: 5px;
}

#vpbaamaknb .gt_indent_2 {
  text-indent: 10px;
}

#vpbaamaknb .gt_indent_3 {
  text-indent: 15px;
}

#vpbaamaknb .gt_indent_4 {
  text-indent: 20px;
}

#vpbaamaknb .gt_indent_5 {
  text-indent: 25px;
}

#vpbaamaknb .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#vpbaamaknb div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="date" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">date</th>
<th id="loc_cat" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">loc_cat</th>
<th id="longitude" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">longitude</th>
<th id="latitude" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">latitude</th>
<th id="district" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">district</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_right" headers="date">2010-01-01 00:05:00</td>
<td class="gt_row gt_left" headers="loc_cat">residence</td>
<td class="gt_row gt_right" headers="longitude">-87.6277</td>
<td class="gt_row gt_right" headers="latitude">41.7922</td>
<td class="gt_row gt_right" headers="district">2</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="date">2010-01-01 00:12:00</td>
<td class="gt_row gt_left" headers="loc_cat">street</td>
<td class="gt_row gt_right" headers="longitude">-87.6683</td>
<td class="gt_row gt_right" headers="latitude">41.7513</td>
<td class="gt_row gt_right" headers="district">6</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="date">2010-01-01 00:30:00</td>
<td class="gt_row gt_left" headers="loc_cat">hotel</td>
<td class="gt_row gt_right" headers="longitude">-87.6242</td>
<td class="gt_row gt_right" headers="latitude">41.8727</td>
<td class="gt_row gt_right" headers="district">1</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="date">2010-01-01 00:30:00</td>
<td class="gt_row gt_left" headers="loc_cat">street</td>
<td class="gt_row gt_right" headers="longitude">-87.6478</td>
<td class="gt_row gt_right" headers="latitude">41.7536</td>
<td class="gt_row gt_right" headers="district">6</td>
</tr>
<tr class="odd">
<td class="gt_row gt_right" headers="date">2010-01-01 00:54:00</td>
<td class="gt_row gt_left" headers="loc_cat">street</td>
<td class="gt_row gt_right" headers="longitude">-87.6446</td>
<td class="gt_row gt_right" headers="latitude">41.7720</td>
<td class="gt_row gt_right" headers="district">7</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="date">2010-01-01 01:15:00</td>
<td class="gt_row gt_left" headers="loc_cat">street</td>
<td class="gt_row gt_right" headers="longitude">-87.7311</td>
<td class="gt_row gt_right" headers="latitude">41.8984</td>
<td class="gt_row gt_right" headers="district">11</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The first task in charting the frequency of crime is to choose a temporal <em>unit of analysis</em>. For example, the chart above counts the number of crimes each <em>week</em>. Weeks are often a good choice as units for counting crimes, since all weeks are the same length and because many human activities have a weekly cycle (e.g.&nbsp;people do different things at weekends than on weekdays, even though which days count as weekdays differs across cultures).</p>
<div class="box notewell">
<p>Months are much less useful than weeks as a temporal unit of analysis because months differ in length, so monthly counts of crime will look like they show some variation even if the amount of crime occurring each day remains constant. For example, if exactly 10 crimes occur every day throughout February and March, there will be 280 or 290 crimes in February (depending on whether it is a leap year) but 310 in March. In these circumstances, it will look like the volume of crime increased by 11% between February and March, not because the rate at which crimes occurred increased but because March is 11% longer than February.</p>
<p>Months are also less useful because they contain different numbers of each day of the week (e.g.&nbsp;one month might have four Fridays while the next has five) and crimes are typically concentrated on particular days of the week (more on that later). <strong>Avoid using monthly counts of crime</strong> unless you have no choice because the only data you have available is monthly counts.</p>
</div>
<p>To count the number of crimes occurring each week we can use the <code>count()</code> function from the <code>dplyr</code> package. But before doing that, we have to allocate each crime to a week so that we can then count those weeks rather than counting days. To do this we use the <code>floor_date()</code> function from the <code>lubridate</code> package. This function rounds dates down to the start of a specified unit of time, in this case a week. By default, <code>floor_date()</code> treats Sunday as the start of the week and so if the specified unit of time is a week, all dates will be rounded down to the date of the previous Sunday.</p>
<p><code>floor_date()</code> works on date variables, so if we want to use it on a date-time variable we should first convert it to a date variable using the <code>as_date()</code> function from <code>lubridate</code>. So to convert a date-time stored in a variable called <code>date</code> into the date of the first day of that week, we would use the code <code>floor_date(as_date(date), unit = "week")</code>.</p>
<p>One complication of counting incidents by week is that our data might not fit neatly into calendar weeks. For example, if we have data for a particular year and that year started on a Tuesday, the first weekly count will only have data for five days and it will look like there were fewer crimes that week in comparison to other weeks. This could be misleading, since this week only looks like it has less crime because we don’t have data for the whole week. The same problem can happen with the last week of data, too. To deal with this, after counting the crimes by week we will remove the first and last row of the data using the <code>slice()</code> function from the <code>dplyr</code> package.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb43" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>assault_weekly_counts <span class="ot">&lt;-</span> assaults <span class="sc">|&gt;</span> </span>
<span id="cb43-2"><a href="#cb43-2"></a>  <span class="fu">mutate</span>(<span class="at">week_date =</span> <span class="fu">floor_date</span>(<span class="fu">as_date</span>(date), <span class="at">unit =</span> <span class="st">"week"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb43-3"><a href="#cb43-3"></a>  <span class="fu">count</span>(week_date, <span class="at">name =</span> <span class="st">"count"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb43-4"><a href="#cb43-4"></a>  <span class="co"># The code `(n() - 1)` gives us the row number of the second-to-last row in </span></span>
<span id="cb43-5"><a href="#cb43-5"></a>  <span class="co"># the data because `n()` returns the number of rows in the data. Note the</span></span>
<span id="cb43-6"><a href="#cb43-6"></a>  <span class="co"># parentheses!</span></span>
<span id="cb43-7"><a href="#cb43-7"></a>  <span class="fu">slice</span>(<span class="dv">2</span><span class="sc">:</span>(<span class="fu">n</span>() <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb43-8"><a href="#cb43-8"></a></span>
<span id="cb43-9"><a href="#cb43-9"></a><span class="fu">head</span>(assault_weekly_counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># A tibble: 6 × 2
  week_date  count
  &lt;date&gt;     &lt;int&gt;
1 2010-01-03   234
2 2010-01-10   300
3 2010-01-17   303
4 2010-01-24   257
5 2010-01-31   276
6 2010-02-07   264</code></pre>
</div>
</div>
<p>Now we have weekly counts of aggravated assaults, we can plot them on a chart. The simplest way to do this would be to create a line chart using <code>ggplot()</code> with <code>geom_line()</code>.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb45" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="fu">ggplot</span>(assault_weekly_counts, <span class="fu">aes</span>(<span class="at">x =</span> week_date, <span class="at">y =</span> count)) <span class="sc">+</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/change-exercise2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This plot is fine, but there are several things that we can do to make it better. Most importantly, there seems to be lots of short-term fluctuation in the frequency of crime (e.g.&nbsp;from one week to another). While this variation is real, we often refer to it as <em>noise</em> because it can obscure the <em>signal</em> of longer-term trends (this terminology originally came to statistics – and therefore crime analysis – from radio engineering and has become common over time).</p>
<p>We can reduce the visual impact of this short-term variation on our plot by adding a line showing a <em>moving average</em> (also called a <em>rolling average</em> or <em>rolling mean</em>) of the count of crime over time. A moving average is the average (or mean) of the count of crimes in the current week and a given number of adjacent (in this case, previous), weeks.</p>
<p class="full-width-image">
<img src="images/moving_averages.png" alt="Chart showing that moving averages are calculated by averaging the current week's count with the counts from a given number of previous weeks.">
</p>
<p>Since moving averages show the average count of crime over several weeks, they are less influenced by week-to-week variation. To calculate a moving average we have to choose how many weeks to include (known as the <em>window</em> of the moving average). The more weeks we include in the window, the smoother the values will appear from week to week and the more short-term variation will be obscured. There is a balance to be struck between making longer-term trends clear and obscuring genuine short-term variation, so you should experiment with different window lengths to ensure you are not over-smoothing.</p>
<p>We can calculate moving averages in R with the <code>slide_dbl()</code> function from the <a href="https://davisvaughan.github.io/slider/"><code>slider</code> package</a> (so called because its functions slide along a series of values). <code>slide_dbl()</code> can calculate several types of moving averages, so we specify that it should use the <code>mean()</code> function to calculate the average by specifying <code>.f = mean</code> (note the lack of parentheses after <code>mean</code>). We use the <code>.before</code> argument (note the <code>.</code>) to specify how many weeks <em>before the current week</em> to include in our moving average. So if we wanted to calculate a four-week moving average (i.e.&nbsp;the current week and the previous three weeks), we would specify <code>.before = 3</code>. We also specify <code>.complete = TRUE</code> to stop <code>slide_dbl()</code> from trying to calculate averages for the first few weeks in our data, because we don’t have the necessary data from previous weeks (i.e.&nbsp;before the start of our data) that we would need to make these averages accurate. <code>slide_dbl()</code> will use <code>NA</code> as the moving average value for those weeks, so we later need to specify <code>na.rm = TRUE</code> to tell <code>ggplot()</code> to ignore these when we plot the data.</p>
<p>Once we’ve calculated a moving average, we can show this using the line on our chart and show the individual weekly counts as small light-grey dots to show how much short-term variation there is in the data.</p>
<div class="cell" data-exercise="true" data-exercise.lines="27">
<div class="sourceCode cell-code" id="cb46" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="fu">library</span>(slider)</span>
<span id="cb46-2"><a href="#cb46-2"></a></span>
<span id="cb46-3"><a href="#cb46-3"></a>assault_weekly_counts <span class="sc">|&gt;</span> </span>
<span id="cb46-4"><a href="#cb46-4"></a>  <span class="fu">mutate</span>(<span class="at">moving_avg =</span> <span class="fu">slide_dbl</span>(count, mean, <span class="at">.before =</span> <span class="dv">3</span>, <span class="at">.complete =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb46-5"><a href="#cb46-5"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> week_date, <span class="at">y =</span> count), <span class="at">colour =</span> <span class="st">"grey75"</span>, <span class="at">size =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb46-7"><a href="#cb46-7"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb46-8"><a href="#cb46-8"></a>    <span class="fu">aes</span>(<span class="at">x =</span> week_date, <span class="at">y =</span> moving_avg, <span class="at">colour =</span> <span class="st">"black"</span>), </span>
<span id="cb46-9"><a href="#cb46-9"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span>, </span>
<span id="cb46-10"><a href="#cb46-10"></a>    <span class="at">key_glyph =</span> <span class="st">"timeseries"</span></span>
<span id="cb46-11"><a href="#cb46-11"></a>  ) <span class="sc">+</span></span>
<span id="cb46-12"><a href="#cb46-12"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%b</span><span class="sc">\n</span><span class="st">%Y"</span>) <span class="sc">+</span></span>
<span id="cb46-13"><a href="#cb46-13"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb46-14"><a href="#cb46-14"></a>  <span class="fu">scale_colour_identity</span>(</span>
<span id="cb46-15"><a href="#cb46-15"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"black"</span> <span class="ot">=</span> <span class="st">"four-week moving average"</span>),</span>
<span id="cb46-16"><a href="#cb46-16"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>()</span>
<span id="cb46-17"><a href="#cb46-17"></a>  ) <span class="sc">+</span></span>
<span id="cb46-18"><a href="#cb46-18"></a>  <span class="fu">labs</span>(</span>
<span id="cb46-19"><a href="#cb46-19"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb46-20"><a href="#cb46-20"></a>    <span class="at">y =</span> <span class="st">"weekly count of aggravated assaults"</span>,</span>
<span id="cb46-21"><a href="#cb46-21"></a>    <span class="at">colour =</span> <span class="cn">NULL</span></span>
<span id="cb46-22"><a href="#cb46-22"></a>  ) <span class="sc">+</span></span>
<span id="cb46-23"><a href="#cb46-23"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb46-24"><a href="#cb46-24"></a>  <span class="fu">theme</span>(</span>
<span id="cb46-25"><a href="#cb46-25"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb46-26"><a href="#cb46-26"></a>    <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>()</span>
<span id="cb46-27"><a href="#cb46-27"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/change-exercise3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Experiment with the effect of setting a longer or shorter window for the moving average by specifying larger or smaller values of the <code>.before</code> argument to <code>slide_dbl()</code>. For example, create an eight-week moving average by specifying <code>.before = 7</code>. What happens to the apparent seasonal variation in the number of assaults if you create an <em>annual moving average</em> by specifying <code>.before = 52</code>?</p>
<p>You may have noticed that in this code we have also made some changes to the appearance of the plot to make it easier to read. Specifically, we have:</p>
<ul>
<li>Added a title for the <em>y</em> axis and removed the <em>x</em> axis and legend titles using the <code>labs()</code> function.</li>
<li>Changed the labels on the <em>x</em> axis using <code>scale_x_date()</code>. In this case, we have used the argument <code>date_breaks = "1 year"</code> to specify that we want a label at the start of each year and the argument <code>date_labels = "%b\n%Y"</code> to specify that we want each label to consist of an abbreviated month name (using the code <code>%b</code>), a new line (the code <code>\n</code> as in a previous tutorial) and a four-digit year (using the code <code>%Y</code>). You can find a full list of codes used that can be used to specify different parts of a date and time by typing <code>?strptime</code> in the R console.</li>
<li>Removed some of the vertical grid lines by setting the <code>panel.grid.minor.x</code> argument to <code>theme()</code> to equal <code>element_blank()</code>.</li>
<li>Forced the <em>y</em> axis to begin at zero by specifying <code>limits = c(0, NA)</code>, remembering that <code>NA</code> in this context means to use the default value.</li>
<li>Specified that we want the black line to be represented in the legend by a line that looks like a time series by specifying <code>key_glyph = "timeseries"</code>.</li>
</ul>
<p>We have also added a legend to explain what the black line shows. The code need to do this is slightly awkward, since <code>ggplot()</code> would not normally produce a legend for aesthetics (in this case, the colour of the line) that have only one value. To force <code>ggplot()</code> to add a legend, we:</p>
<ol type="1">
<li>Specify the colour of the line (i.e.&nbsp;<code>colour = "black"</code>) not as an argument to the function <code>geom_line()</code> as we normally would but as one of the aesthetics specified using <code>aes()</code>.</li>
<li>Specify that <code>ggplot()</code> should treat the value <code>colour = "black"</code> as a literal colour name rather than as a reference to a column in the data (which is how the arguments to <code>aes()</code> are normally interpreted). To do this we add <code>scale_colour_identity()</code> to the <code>ggplot()</code> stack, because <em>identity</em> is the jargon used in R to say ‘keep this value exactly as it is’.</li>
<li>Within <code>scale_colour_identity()</code>, specify a label to correspond to the black line by setting the <code>labels</code> argument.</li>
<li>Specify <code>guide = guide_legend()</code> to tell <code>ggplot()</code> to add a legend corresponding to the black line because aesthetics styled using functions in the <code>scale_*_identity()</code> family do not produce a legend entry by default.</li>
</ol>
<p>Doing all this is obviously tedious, but makes for a better chart.</p>
<section id="showing-repeating-patterns-over-time" class="level3" data-number="16.3.1">
<h3 data-number="16.3.1" class="anchored" data-anchor-id="showing-repeating-patterns-over-time"><span class="header-section-number">16.3.1</span> Showing repeating patterns over time</h3>
<p>We have already seen that there is seasonal variation in the number of aggravated assaults in Chicago. As is very common for assaults, there are more offences in the summer and fewer in the winter. We can see this in the time-series chart we have already produced, but it’s hard to see the detail. For example, we might want to know how consistent this seasonal variation is across different years. Is it, for example, consistent enough that the local police might want to restrict the number of officers who can take holidays in certain weeks of the year to maximise the number of officers available when crime is likely to be highest?</p>
<p>To do this we can create a <em>seasonal chart</em>. This can be used to show any type of repeating variation, but is often used to show patterns across a year (hence the name). To create a seasonal plot we need to add a variable to our data specifying which year each weekly count belongs to, which we can do by using the <code>year()</code> function to extract the year from the offence dates. We can do this at the same time as we calculate the moving averages. Once we’ve done that, we can specify that we want our chart to have a separate line for each year by setting <code>group = year</code> inside the <code>aes()</code> function that controls how the data are shown on the chart, making each year a different colour using <code>colour = year</code>.</p>
<div class="cell" data-exercise="true" data-exercise.lines="20">
<div class="sourceCode cell-code" id="cb47" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>assault_weekly_counts <span class="sc">|&gt;</span> </span>
<span id="cb47-2"><a href="#cb47-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb47-3"><a href="#cb47-3"></a>    <span class="at">moving_avg =</span> <span class="fu">slide_dbl</span>(count, mean, <span class="at">.before =</span> <span class="dv">3</span>, <span class="at">.complete =</span> <span class="cn">TRUE</span>),</span>
<span id="cb47-4"><a href="#cb47-4"></a>    <span class="at">year =</span> <span class="fu">year</span>(week_date)</span>
<span id="cb47-5"><a href="#cb47-5"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb47-6"><a href="#cb47-6"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> week_date, <span class="at">y =</span> moving_avg, <span class="at">colour =</span> year, <span class="at">group =</span> year)) <span class="sc">+</span></span>
<span id="cb47-7"><a href="#cb47-7"></a>  <span class="fu">geom_line</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">key_glyph =</span> <span class="st">"timeseries"</span>) <span class="sc">+</span></span>
<span id="cb47-8"><a href="#cb47-8"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%b</span><span class="sc">\n</span><span class="st">%Y"</span>) <span class="sc">+</span></span>
<span id="cb47-9"><a href="#cb47-9"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb47-10"><a href="#cb47-10"></a>  <span class="fu">scale_colour_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2019</span>)) <span class="sc">+</span></span>
<span id="cb47-11"><a href="#cb47-11"></a>  <span class="fu">labs</span>(</span>
<span id="cb47-12"><a href="#cb47-12"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb47-13"><a href="#cb47-13"></a>    <span class="at">y =</span> <span class="st">"weekly count of aggravated assaults"</span>,</span>
<span id="cb47-14"><a href="#cb47-14"></a>    <span class="at">colour =</span> <span class="cn">NULL</span></span>
<span id="cb47-15"><a href="#cb47-15"></a>  ) <span class="sc">+</span></span>
<span id="cb47-16"><a href="#cb47-16"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb47-17"><a href="#cb47-17"></a>  <span class="fu">theme</span>(</span>
<span id="cb47-18"><a href="#cb47-18"></a>    <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>()</span>
<span id="cb47-19"><a href="#cb47-19"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/change-exercise4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The result might not be what you expected. Although the grouping of the lines by year has worked (there is a break between the lines at the start of each year), it’s no easier to compare the seasonal patterns across years. Comparing years would be much easier if we superimpose the weekly counts for each year on top of one another.</p>
<p>To do this, we need to trick <code>ggplot()</code> into plotting all the weekly counts as if they occurred in a single year, so the counts appear in the same locations on the horizontal axis of the chart, whichever year they occurred in. We can do this by creating a pseudo-date value for each weekly count which has the same month and day of the month as the original date, but a single year across all the rows in the data. We will create this pseudo date by extracting the month and day of the month using <code>month()</code> and <code>mday()</code>, then creating a new date with <code>make_date()</code>. We will also change the labels on the horizontal axis using the date-formatting code <code>%e\n%b</code> – <code>%e</code> means the day of the month and <code>%b</code> means the abbreviated name of the month.</p>
<div class="cell" data-exercise="true" data-exercise.lines="24">
<div class="sourceCode cell-code" id="cb48" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>assault_weekly_counts <span class="sc">|&gt;</span> </span>
<span id="cb48-2"><a href="#cb48-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-3"><a href="#cb48-3"></a>    <span class="at">moving_avg =</span> <span class="fu">slide_dbl</span>(count, mean, <span class="at">.before =</span> <span class="dv">3</span>, <span class="at">.complete =</span> <span class="cn">TRUE</span>),</span>
<span id="cb48-4"><a href="#cb48-4"></a>    <span class="at">year =</span> <span class="fu">year</span>(week_date),</span>
<span id="cb48-5"><a href="#cb48-5"></a>    <span class="co"># By only specifying the `month` and `day` arguments to `make_date()` we</span></span>
<span id="cb48-6"><a href="#cb48-6"></a>    <span class="co"># will create a date in 1970 (the year that R uses by default), but that </span></span>
<span id="cb48-7"><a href="#cb48-7"></a>    <span class="co"># doesn't matter because we are not going to show the year on the chart</span></span>
<span id="cb48-8"><a href="#cb48-8"></a>    <span class="at">pseudo_date =</span> <span class="fu">make_date</span>(<span class="at">month =</span> <span class="fu">month</span>(week_date), <span class="at">day =</span> <span class="fu">mday</span>(week_date))</span>
<span id="cb48-9"><a href="#cb48-9"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb48-10"><a href="#cb48-10"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pseudo_date, <span class="at">y =</span> moving_avg, <span class="at">colour =</span> year, <span class="at">group =</span> year)) <span class="sc">+</span></span>
<span id="cb48-11"><a href="#cb48-11"></a>  <span class="fu">geom_line</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">key_glyph =</span> <span class="st">"timeseries"</span>) <span class="sc">+</span></span>
<span id="cb48-12"><a href="#cb48-12"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 month"</span>, <span class="at">date_labels =</span> <span class="st">"%e</span><span class="sc">\n</span><span class="st">%b"</span>) <span class="sc">+</span></span>
<span id="cb48-13"><a href="#cb48-13"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb48-14"><a href="#cb48-14"></a>  <span class="fu">scale_colour_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2019</span>)) <span class="sc">+</span></span>
<span id="cb48-15"><a href="#cb48-15"></a>  <span class="fu">labs</span>(</span>
<span id="cb48-16"><a href="#cb48-16"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb48-17"><a href="#cb48-17"></a>    <span class="at">y =</span> <span class="st">"weekly count of aggravated assaults"</span>,</span>
<span id="cb48-18"><a href="#cb48-18"></a>    <span class="at">colour =</span> <span class="cn">NULL</span></span>
<span id="cb48-19"><a href="#cb48-19"></a>  ) <span class="sc">+</span></span>
<span id="cb48-20"><a href="#cb48-20"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb48-21"><a href="#cb48-21"></a>  <span class="fu">theme</span>(</span>
<span id="cb48-22"><a href="#cb48-22"></a>    <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>()</span>
<span id="cb48-23"><a href="#cb48-23"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/change-exercise5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From this chart we can see that assaults consistently peak in July, although in one year they peaked slightly earlier in late June and in one year slightly later in August. At the other end of the year, weekly counts of assaults are almost always least frequent in late January and throughout February before starting to increase quite rapidly in March.</p>
<p>As well as showing seasonal variation, we can use the same technique to understand variation over other periods of time. For example, since we know a lot of human activities follow weekly patterns, we might want to produce a chart showing the number of crimes in each hour on each day of the week.</p>
<p>To do this, we:</p>
<ol type="1">
<li>Extract the weekday and hour components of each date using <code>wday()</code> and <code>hour()</code>.</li>
<li>Count the total number of crimes occurring in each hour of each day <em>across all ten years of the data</em> using <code>count()</code>.</li>
<li>Create a pseudo-date-time using <code>make_datetime()</code>.</li>
<li>Create a chart with appropriate labels on the horizontal axis and a suitable qualitative colour scheme to show the days of the week using <code>scale_colour_brewer()</code>.</li>
</ol>
<p>We can do this in a single piece of code.</p>
<div class="cell" data-exercise="true" data-exercise.lines="23">
<div class="sourceCode cell-code" id="cb49" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a>assault_hourly_counts <span class="ot">&lt;-</span> assaults <span class="sc">|&gt;</span> </span>
<span id="cb49-2"><a href="#cb49-2"></a>  <span class="fu">mutate</span>(<span class="at">wday =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>), <span class="at">hour =</span> <span class="fu">hour</span>(date)) <span class="sc">|&gt;</span> </span>
<span id="cb49-3"><a href="#cb49-3"></a>  <span class="fu">count</span>(wday, hour, <span class="at">name =</span> <span class="st">"count"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb49-4"><a href="#cb49-4"></a>  <span class="co"># By only setting the `hour` argument to `make_datetime()` we will create a</span></span>
<span id="cb49-5"><a href="#cb49-5"></a>  <span class="co"># date-time on 1 January 1970, but that doesn't matter because we will not </span></span>
<span id="cb49-6"><a href="#cb49-6"></a>  <span class="co"># show the date on the chart</span></span>
<span id="cb49-7"><a href="#cb49-7"></a>  <span class="fu">mutate</span>(<span class="at">pseudo_date =</span> <span class="fu">make_datetime</span>(<span class="at">hour =</span> hour))</span>
<span id="cb49-8"><a href="#cb49-8"></a></span>
<span id="cb49-9"><a href="#cb49-9"></a><span class="fu">ggplot</span>(</span>
<span id="cb49-10"><a href="#cb49-10"></a>  assault_hourly_counts, </span>
<span id="cb49-11"><a href="#cb49-11"></a>  <span class="fu">aes</span>(<span class="at">x =</span> pseudo_date, <span class="at">y =</span> count, <span class="at">colour =</span> wday, <span class="at">group =</span> wday)</span>
<span id="cb49-12"><a href="#cb49-12"></a>) <span class="sc">+</span></span>
<span id="cb49-13"><a href="#cb49-13"></a>  <span class="fu">geom_line</span>(<span class="at">key_glyph =</span> <span class="st">"timeseries"</span>) <span class="sc">+</span></span>
<span id="cb49-14"><a href="#cb49-14"></a>  <span class="fu">scale_x_datetime</span>(<span class="at">date_breaks =</span> <span class="st">"2 hours"</span>, <span class="at">date_labels =</span> <span class="st">"%H:%M"</span>) <span class="sc">+</span></span>
<span id="cb49-15"><a href="#cb49-15"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>), <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">comma_format</span>()) <span class="sc">+</span></span>
<span id="cb49-16"><a href="#cb49-16"></a>  <span class="fu">scale_colour_brewer</span>(<span class="at">type =</span> <span class="st">"qual"</span>) <span class="sc">+</span></span>
<span id="cb49-17"><a href="#cb49-17"></a>  <span class="fu">labs</span>(</span>
<span id="cb49-18"><a href="#cb49-18"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb49-19"><a href="#cb49-19"></a>    <span class="at">y =</span> <span class="st">"hourly total of aggravated assaults, 2010-2019"</span>,</span>
<span id="cb49-20"><a href="#cb49-20"></a>    <span class="at">colour =</span> <span class="cn">NULL</span></span>
<span id="cb49-21"><a href="#cb49-21"></a>  ) <span class="sc">+</span></span>
<span id="cb49-22"><a href="#cb49-22"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/change-exercise6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>On this chart you can see that there are two distinct temporal patterns of assaults on different days of the week. Between Mondays and Thursdays, assaults peak between about 14:00 and 21:00 before reducing to a very-low level at about 05:00. At the weekend, the picture is different: assaults peak between midnight and 02:00 on both Saturdays and Sundays (i.e.&nbsp;very late on Friday and Saturday evenings).</p>
<p>This chart probably uses the maximum number of different colours for days of the week that we could use before some of the colours became too similar to one another to be distinguishable. But even with this many colours, it might not be easy for a colour-blind person to translate between the colours of the lines and the colours in the legend. When you find that there are too many colours on a chart, this is a good sign that you should consider using small-multiple charts instead. Fortunately, we can do this by adding a column to the data specifying whether each day is a weekday or on a weekend, then adding <code>facet_grid()</code> to our <code>ggplot()</code> stack.</p>
<div class="cell" data-exercise="true" data-exercise.lines="19">
<div class="sourceCode cell-code" id="cb50" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>assault_hourly_counts <span class="sc">|&gt;</span> </span>
<span id="cb50-2"><a href="#cb50-2"></a>  <span class="fu">mutate</span>(<span class="at">weekend =</span> <span class="fu">if_else</span>(wday <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>), <span class="st">"Sat–Sun"</span>, <span class="st">"Mon–Fri"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb50-3"><a href="#cb50-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pseudo_date, <span class="at">y =</span> count, <span class="at">colour =</span> wday)) <span class="sc">+</span></span>
<span id="cb50-4"><a href="#cb50-4"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>  <span class="co"># Assign the facets to rows so that we can compare the same time on different</span></span>
<span id="cb50-6"><a href="#cb50-6"></a>  <span class="co"># days more easily (change `rows` to `cols` to see the alternative)</span></span>
<span id="cb50-7"><a href="#cb50-7"></a>  <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(weekend)) <span class="sc">+</span></span>
<span id="cb50-8"><a href="#cb50-8"></a>  <span class="fu">scale_x_datetime</span>(<span class="at">date_breaks =</span> <span class="st">"2 hours"</span>, <span class="at">date_labels =</span> <span class="st">"%H:%M"</span>) <span class="sc">+</span></span>
<span id="cb50-9"><a href="#cb50-9"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>), <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">comma_format</span>()) <span class="sc">+</span></span>
<span id="cb50-10"><a href="#cb50-10"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">type =</span> <span class="st">"qual"</span>) <span class="sc">+</span></span>
<span id="cb50-11"><a href="#cb50-11"></a>  <span class="fu">labs</span>(</span>
<span id="cb50-12"><a href="#cb50-12"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb50-13"><a href="#cb50-13"></a>    <span class="at">y =</span> <span class="st">"hourly total of aggravated assaults, 2010-2019"</span>,</span>
<span id="cb50-14"><a href="#cb50-14"></a>    <span class="at">fill =</span> <span class="cn">NULL</span></span>
<span id="cb50-15"><a href="#cb50-15"></a>  ) <span class="sc">+</span></span>
<span id="cb50-16"><a href="#cb50-16"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/change-exercise7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This shows the two distinct patterns (weekdays and weekends) more clearly, while also letting us see that Friday is not like other weekdays since the peak in assaults continues later in the evening. Now that we’ve created this chart using <code>facet_grid()</code>, we could also add columns to show the same patterns in different areas, such as police districts or local neighbourhoods, or during different seasons.</p>
</section>
</section>
<section id="how-to-map-change-over-time" class="level2" data-number="16.4">
<h2 data-number="16.4" class="anchored" data-anchor-id="how-to-map-change-over-time"><span class="header-section-number">16.4</span> How to map change over time</h2>
<p>Time-series or seasonal charts are often the best way to show change in the frequency of crime over time. But it can also be useful to show maps of the patterns of crimes at different points in time. We might, for example, want to show the density of crime in an area for different periods in time.</p>
<p>Choosing how to divide up time into periods is an important step in this process, because in doing so we are converting a continuous variable (time) into a number of categories (periods of time). Whenever we convert an continuous variable to a categorical one we inevitably lose information. For example, if we decided to categorise the maximum temperature every day as being either ‘hot’ or ‘cold’, we would lose a lot of information about whether a particular day was moderately hot, very hot, etc. The same is true of time, since by splitting time into periods (hours, days, weeks, etc.) we lose information about variations within each period. This is inevitable, since we can’t produce infinite maps showing all the infinite moments in time, but it’s the reason why choosing periods carefully is important.</p>
<p>When choosing a period over which to count crime, it is important not to just use default periods like the day from 00:00 to 23:59 just because that is the standard definition of a day. As we saw in the previous section, the peaks of many types of crime like assaults cross over the boundaries between days because the peak frequency is late in the evening. For this reason it may be better to, for example, define a day as a period from 05:00 to 04:59 and count the number of crimes within each day according to that definition. This takes advantage of the fact that very few crimes concentrate in the early hours of the morning.</p>
<p>Sometimes, it will be easy to choose periods because they will be dictated by the purpose for which you’re creating the map. In this section we will create separate maps showing the density of aggravated assaults in a part of Chicago for each of the standard Chicago Police shifts of 06:00 to 13:59, 14:00 to 21:59 and 22:00 to 05:59 (bearing in mind that the actual hours some officers work may differ slightly).</p>
<p>To do this, we will estimate the density of assaults separately for each shift period, the combine the three density layers and plot them on small-multiple maps. First, we create a new object containing data for the Chicago Police districts we are interested in with a column showing which police shift each assault occurred in.</p>
<p>We can construct this column using the <code>case_when()</code> function from <code>dplyr</code>. <code>case_when()</code> allows us to specify any number of tests that we can apply to our data – when a test is passed the function assigns the corresponding label to that row (the label is separated from the test by a tilde character <code>~</code>). <code>case_when()</code> is like <code>recode()</code>, but for when we need to test for more-complicated things than just whether a variable has a particular value.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb51" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>assaults_by_shift <span class="ot">&lt;-</span> assaults <span class="sc">|&gt;</span> </span>
<span id="cb51-2"><a href="#cb51-2"></a>  <span class="fu">filter</span>(district <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">18</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb51-3"><a href="#cb51-3"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-4"><a href="#cb51-4"></a>    <span class="at">shift =</span> <span class="fu">case_when</span>(</span>
<span id="cb51-5"><a href="#cb51-5"></a>      <span class="fu">between</span>(<span class="fu">hour</span>(date), <span class="dv">6</span>, <span class="dv">13</span>) <span class="sc">~</span> <span class="st">"06:00 to 13:59"</span>,</span>
<span id="cb51-6"><a href="#cb51-6"></a>      <span class="fu">between</span>(<span class="fu">hour</span>(date), <span class="dv">14</span>, <span class="dv">21</span>) <span class="sc">~</span> <span class="st">"14:00 to 21:59"</span>,</span>
<span id="cb51-7"><a href="#cb51-7"></a>      <span class="fu">hour</span>(date) <span class="sc">&gt;=</span> <span class="dv">22</span> <span class="sc">|</span> <span class="fu">hour</span>(date) <span class="sc">&lt;</span> <span class="dv">6</span> <span class="sc">~</span> <span class="st">"22:00 to 05:59"</span>,</span>
<span id="cb51-8"><a href="#cb51-8"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb51-9"><a href="#cb51-9"></a>    )</span>
<span id="cb51-10"><a href="#cb51-10"></a>  )<span class="sc">|&gt;</span> </span>
<span id="cb51-11"><a href="#cb51-11"></a>  <span class="co"># Convert the data to an SF object</span></span>
<span id="cb51-12"><a href="#cb51-12"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb51-13"><a href="#cb51-13"></a>  <span class="co"># Transform it to a co-ordinate reference system based on metres</span></span>
<span id="cb51-14"><a href="#cb51-14"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:26916"</span>)</span>
<span id="cb51-15"><a href="#cb51-15"></a></span>
<span id="cb51-16"><a href="#cb51-16"></a><span class="fu">head</span>(assaults_by_shift)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 6 features and 4 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 444951.9 ymin: 4635831 xmax: 449271.4 ymax: 4641406
Projected CRS: NAD83 / UTM zone 16N
# A tibble: 6 × 5
  date                loc_cat    district shift                  geometry
  &lt;dttm&gt;              &lt;chr&gt;         &lt;dbl&gt; &lt;chr&gt;               &lt;POINT [m]&gt;
1 2010-01-01 00:30:00 hotel             1 22:00 to 05… (448202.2 4635831)
2 2010-01-01 01:45:00 street           18 22:00 to 05…   (446518 4641406)
3 2010-01-01 01:48:00 hotel             1 22:00 to 05… (448202.2 4635831)
4 2010-01-01 02:00:00 government       18 22:00 to 05… (449271.4 4637966)
5 2010-01-01 02:59:00 leisure          12 22:00 to 05… (444951.9 4637265)
6 2010-01-01 05:00:00 residence        18 22:00 to 05… (447278.5 4639968)</code></pre>
</div>
</div>
<div class="box extra-detail">
<h5 id="map-box1-title" class="box-title anchored">
Why did we include <code>TRUE ~ NA_character_</code> in <code>case_when()</code>?
</h5>
<div id="map-box1" class="box-content">
<p><code>case_when()</code> uses a series of true/false tests to create a variable, usually based on the values of other columns in the data. To make sure that every row in the dataset is matched by at least one of the tests, it is common practice to include a final test that is always true. The easiest way to do this is to simply create a test with the fixed value <code>TRUE</code>, since <code>TRUE</code> is always true! This catch-all test must be the last test within the <code>case_when()</code> function, because <code>case_when()</code> runs the tests in the order in which they are given and stops testing a given row in the data as soon as a test produces a true value.</p>
<p>In this case, we will set the label for this last test to be <code>NA</code> (in fact, the special value <code>NA_character_</code> because <code>case_when()</code> only accepts labels that are characters) to catch any rows that have missing values of <code>date</code> or aren’t matched by any of our tests. Since our tests between them cover all the hours of the day, there shouldn’t be any rows that are not matched by at-least one test, but including a catch-all test makes it easier to catch any problems with our code.</p>
<p>There’s lot’s more to learn about the <code>case_when()</code> function: you can find out more by looking at the <a href="https://dplyr.tidyverse.org/reference/case_when.html"><code>case_when()</code> page on the package website</a>.</p>
</div>
</div>
<script>
$("#map-box1-title").click(function () { $("#map-box1").toggle("slow") })
</script>
<p>The next step is to produce a kernel density (KDE) layer for assaults occurring in each shift. In a previous tutorial we learned how to do this using the <code>sfhotspot</code> package. We could run the <code>hotspot_kde()</code> function from that package three times to create the KDE layers for each shift, but there is a simpler way to apply the same function to different parts of a dataset using the <code>group_modify()</code> function from <code>dplyr</code>.</p>
<p>Normally, when we use a function to modify a dataset, that function is applied to the dataset as a whole. With <code>group_modify()</code>, we can apply a function to different parts of a dataset separately but still get the result as a single tibble with a column showing which group each row relates to (which is what we need to produce a map).</p>
<p><code>group_modify()</code> needs two inputs. The first is a <em>grouped</em> dataset. We already know how to specify which column in a dataset represents which group each row is in using the <code>group_by()</code> function. The second input to <code>group_modify()</code> is the name of the function we want to use to modify each group in the data. The only complication is that we have to provide the details of the function that <code>group_modify()</code> should use in a slightly unusual format called an <em>anonymous function</em>. You can see this in the block of code below. You do not need to understand the details of how an anonymous function works, but you should note two things:</p>
<ol type="1">
<li>Anonymous functions start with the <code>~</code> character.</li>
<li>In an anonymous function used within <code>group_modify()</code>, you can use the special value <code>.x</code> (note the dot) to represent the data in each group.</li>
</ol>
<p>So this code:</p>
<div class="sourceCode" id="cb53" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>some_data <span class="sc">|&gt;</span> </span>
<span id="cb53-2"><a href="#cb53-2"></a>  <span class="fu">group_by</span>(some_variable) <span class="sc">|&gt;</span> </span>
<span id="cb53-3"><a href="#cb53-3"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">hotspot_kde</span>(.x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Means ‘take the dataset <code>some_data</code>, group it according to the values in the <code>some_variable</code> column and apply the <code>hotspot_kde()</code> function separately to each group’. The only thing left for us to do then is to use <code>ungroup()</code> to remove the grouping from the result produced by <code>group_modify()</code> and convert that result back to an SF object using <code>st_as_sf()</code>. Don’t worry about specifying any arguments to <code>st_as_sf()</code> – R will extract information such as the co-ordinate reference system from the <code>geometry</code> column of the data automatically.</p>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb54" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="fu">library</span>(sfhotspot)</span>
<span id="cb54-2"><a href="#cb54-2"></a></span>
<span id="cb54-3"><a href="#cb54-3"></a>kde_by_shift <span class="ot">&lt;-</span> assaults_by_shift <span class="sc">|&gt;</span> </span>
<span id="cb54-4"><a href="#cb54-4"></a>  <span class="fu">group_by</span>(shift) <span class="sc">|&gt;</span> </span>
<span id="cb54-5"><a href="#cb54-5"></a>  <span class="fu">group_modify</span>(</span>
<span id="cb54-6"><a href="#cb54-6"></a>    <span class="sc">~</span> <span class="fu">hotspot_kde</span>(.x, <span class="at">cell_size =</span> <span class="dv">200</span>, <span class="at">bandwidth_adjust =</span> <span class="fl">0.75</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-7"><a href="#cb54-7"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb54-8"><a href="#cb54-8"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb54-9"><a href="#cb54-9"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb54-10"><a href="#cb54-10"></a>  <span class="co"># Clip the result to the boundary of Chicago, which is already stored in the </span></span>
<span id="cb54-11"><a href="#cb54-11"></a>  <span class="co"># `cpd_central` object</span></span>
<span id="cb54-12"><a href="#cb54-12"></a>  <span class="fu">st_intersection</span>(cpd_central)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="fu">head</span>(kde_by_shift)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Simple feature collection with 6 features and 4 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 446980 ymin: 4637342 xmax: 447685.6 ymax: 4637558
Projected CRS: NAD83 / UTM zone 16N
# A tibble: 6 × 5
  shift              n   kde district_no                                geometry
  &lt;chr&gt;          &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;                           &lt;POLYGON [m]&gt;
1 06:00 to 13:59     0  161.          18 ((447085.6 4637358, 447085.6 4637355, …
2 06:00 to 13:59     4  204.          18 ((447085.6 4637358, 447112.6 4637358, …
3 06:00 to 13:59     0  147.          18 ((447085.6 4637558, 447085.6 4637358, …
4 06:00 to 13:59     0  186.          18 ((447085.6 4637558, 447285.6 4637558, …
5 06:00 to 13:59     2  225.          18 ((447285.6 4637558, 447485.6 4637558, …
6 06:00 to 13:59     4  257.          18 ((447485.6 4637558, 447685.6 4637558, …</code></pre>
</div>
</div>
<div class="box extra-detail">
<h5 id="map-box2-title" class="box-title anchored">
How to anonymous functions work?
</h5>
<div id="map-box2" class="box-content">
<p>Anonymous functions in R (and in many other programming languages) are a compact way of creating a new function that we can then immediately use to modify a dataset.</p>
<p>We can create our own functions in R by using the <code>function()</code> function. For example, if we wanted to create our own version of the <code>head()</code> function that printed the first 10 rows of a dataset – rather than the default six rows printed by <code>head()</code> – we could create a function called <code>head10()</code>:</p>
<div class="sourceCode" id="cb58" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a>head10 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb58-2"><a href="#cb58-2"></a>  <span class="fu">head</span>(x, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb58-3"><a href="#cb58-3"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When we call the new <code>head10()</code> function on a dataset, R will take whatever data we provide to that function and run all the code inside the braces <code>{}</code> above using that data. We can use this new function anywhere in our code <em>after</em> we’ve created it. For example, if we had a dataset called <code>some_data</code> we could view the first 10 rows of it by creating an then using our new function:</p>
<div class="sourceCode" id="cb59" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a>head10 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb59-2"><a href="#cb59-2"></a>  <span class="fu">head</span>(x, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb59-3"><a href="#cb59-3"></a>}</span>
<span id="cb59-4"><a href="#cb59-4"></a></span>
<span id="cb59-5"><a href="#cb59-5"></a><span class="fu">head10</span>(some_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that <em>inside</em> our new function, the dataset is referred to by the name that we gave it in the parentheses <code>()</code> after the word <code>function</code>, <em>not</em> by the name of the dataset itself. This is important because it means our custom function will work regardless of what a particular dataset is called.</p>
<p>We could include lots of lines of code inside our new function, but in this case there is just one – <code>head(x, n = 10)</code>. When we want to create a function that consists of a single line of code, we can dispense with the braces and put the whole function on one line:</p>
<div class="sourceCode" id="cb60" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>head10 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">head</span>(x, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb60-2"><a href="#cb60-2"></a></span>
<span id="cb60-3"><a href="#cb60-3"></a><span class="fu">head10</span>(some_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Creating a new function and giving it a name is useful if we want to use the function several times in our code. But in the case of the function we need to provide to <code>group_modify()</code> in our code, we only need to use the new function once. In this case, we can dispense with the need to give our new function a name, and instead create an anonymous function. To do this, we replace <code>function(x)</code> with the <code>~</code> character.</p>
<p>This makes the definition of our custom function even faster, but means we can only use it inside a function such as <code>group_modify()</code> or <code>map()</code> that needs a function definition to work. Using an anonymous function also means we need some way of referring to our dataset inside the new function, since we don’t have the opportunity to define it inside parentheses after the word <code>function</code>. Fortunately, <code>group_modify()</code> understands that if we refer to <code>.x</code> (note the dot) inside our anonymous function, that should be interpreted as referring to our dataset.</p>
<p>There is a lot more you could learn about creating your own functions in R. If you are interested, you might want to <a href="https://swcarpentry.github.io/r-novice-inflammation/02-func-R/">work through this lesson on Creating Functions</a>.</p>
</div>
</div>
<script>
$("#map-box2-title").click(function () { $("#map-box2").toggle("slow") })
</script>
<p>Now we have a KDE layer for each shift, we can create three maps for the three shifts by adding <code>facet_wrap()</code> to a <code>ggplot()</code> stack.</p>
<div class="cell" data-exercise="true" data-exercise.lines="30">
<div class="sourceCode cell-code" id="cb61" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb61-2"><a href="#cb61-2"></a></span>
<span id="cb61-3"><a href="#cb61-3"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb61-4"><a href="#cb61-4"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb61-5"><a href="#cb61-5"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb61-6"><a href="#cb61-6"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb61-7"><a href="#cb61-7"></a>    <span class="at">data =</span> kde_by_shift, </span>
<span id="cb61-8"><a href="#cb61-8"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>, </span>
<span id="cb61-9"><a href="#cb61-9"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb61-10"><a href="#cb61-10"></a>  ) <span class="sc">+</span></span>
<span id="cb61-11"><a href="#cb61-11"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb61-12"><a href="#cb61-12"></a>    <span class="at">data =</span> <span class="fu">filter</span>(cpd_districts, district_no <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">18</span>)), </span>
<span id="cb61-13"><a href="#cb61-13"></a>    <span class="at">colour =</span> <span class="st">"grey33"</span>, </span>
<span id="cb61-14"><a href="#cb61-14"></a>    <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb61-15"><a href="#cb61-15"></a>  ) <span class="sc">+</span></span>
<span id="cb61-16"><a href="#cb61-16"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(shift)) <span class="sc">+</span></span>
<span id="cb61-17"><a href="#cb61-17"></a>  <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb61-18"><a href="#cb61-18"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(kde_by_shift, kde)),</span>
<span id="cb61-19"><a href="#cb61-19"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>),</span>
<span id="cb61-20"><a href="#cb61-20"></a>    <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb61-21"><a href="#cb61-21"></a>  ) <span class="sc">+</span></span>
<span id="cb61-22"><a href="#cb61-22"></a>  <span class="fu">labs</span>(</span>
<span id="cb61-23"><a href="#cb61-23"></a>    <span class="at">fill =</span> <span class="st">"density of aggravated assaults"</span></span>
<span id="cb61-24"><a href="#cb61-24"></a>  ) <span class="sc">+</span></span>
<span id="cb61-25"><a href="#cb61-25"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb61-26"><a href="#cb61-26"></a>  <span class="fu">theme</span>(</span>
<span id="cb61-27"><a href="#cb61-27"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb61-28"><a href="#cb61-28"></a>    <span class="at">legend.title.align =</span> <span class="dv">1</span></span>
<span id="cb61-29"><a href="#cb61-29"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: The `legend.title.align` argument of `theme()` is deprecated as of ggplot2
3.5.0.
ℹ Please use theme(legend.title = element_text(hjust)) instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/map-exercise3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>On this map we can see that some places have a relatively high density of assaults throughout all three shifts, but others only have a high density at certain times. We can perhaps make this clearer by only showing the grid cells with the highest estimated density of assaults during each shift. We can do this using the <code>slice_max()</code> function from <code>dplyr</code>, which allows us to extract the rows in a dataset with the highest values of a particular variable. In this case we will use <code>slice_max()</code> together with <code>group_by()</code> to get the rows with the highest values <em>separately for each shift</em> rather than those with the highest values across all three shifts combined.</p>
<div class="cell" data-exercise="true" data-exercise.lines="21">
<div class="sourceCode cell-code" id="cb63" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>kde_shift_highest <span class="ot">&lt;-</span> kde_by_shift <span class="sc">|&gt;</span> </span>
<span id="cb63-2"><a href="#cb63-2"></a>  <span class="fu">group_by</span>(shift) <span class="sc">|&gt;</span> </span>
<span id="cb63-3"><a href="#cb63-3"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> kde, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb63-4"><a href="#cb63-4"></a></span>
<span id="cb63-5"><a href="#cb63-5"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb63-6"><a href="#cb63-6"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb63-7"><a href="#cb63-7"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb63-8"><a href="#cb63-8"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde), </span>
<span id="cb63-9"><a href="#cb63-9"></a>    <span class="at">data =</span> kde_shift_highest, </span>
<span id="cb63-10"><a href="#cb63-10"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>, </span>
<span id="cb63-11"><a href="#cb63-11"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb63-12"><a href="#cb63-12"></a>    <span class="at">fill =</span> <span class="st">"red2"</span></span>
<span id="cb63-13"><a href="#cb63-13"></a>  ) <span class="sc">+</span></span>
<span id="cb63-14"><a href="#cb63-14"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb63-15"><a href="#cb63-15"></a>    <span class="at">data =</span> <span class="fu">filter</span>(cpd_districts, district_no <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">18</span>)), </span>
<span id="cb63-16"><a href="#cb63-16"></a>    <span class="at">colour =</span> <span class="st">"grey33"</span>, </span>
<span id="cb63-17"><a href="#cb63-17"></a>    <span class="at">fill =</span> <span class="cn">NA</span></span>
<span id="cb63-18"><a href="#cb63-18"></a>  ) <span class="sc">+</span></span>
<span id="cb63-19"><a href="#cb63-19"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(shift)) <span class="sc">+</span></span>
<span id="cb63-20"><a href="#cb63-20"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/map-exercise4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This map makes it very clear that the grid cells with the highest densities of aggravated assaults are very similar in the daytime and evening shifts, in both places being concentrated in the downtown area known as The Loop. For the overnight shift, however, the cells with the highest densities are on the other side of the Chicago River in the River North neighbourhood. A map like this might be particularly useful if the resources available to respond to a crime problem were very limited and so could only be deployed in the places where the problem was worst – this is often the case because crime-prevention resources <em>are</em> often very limited.</p>
</section>
<section id="making-animated-maps" class="level2" data-number="16.5">
<h2 data-number="16.5" class="anchored" data-anchor-id="making-animated-maps"><span class="header-section-number">16.5</span> Making animated maps</h2>
<p>The small-multiple map we have produced of aggravated-assault hotspots in Chicago is useful, especially for policing because it uses periods based on police shifts. But aggregating crimes into only three temporal periods inevitably throws away a lot of information about when crime happens. For example, at what time of night does the area of highest assault density move across the river from The Loop to River North?</p>
<p>We could produce a series of small-multiple maps showing shorter periods (meaning more small multiples). For example, we could show one small-multiple map for each hour of the day. However, this would make each map very small and it would be hard to see the details of locations on each map.</p>
<p>One alternative is to produce an animated map with each frame in the animation representing the map for each hour. We can do this using the <a href="https://gganimate.com/"><code>gganimate</code> package</a>.</p>
<p>The first step in producing an animated map is to create a KDE layer for each hour of the day. The code for this is the same as for the code we have already used to produce the KDE layers for each shift, except that we create a variable for hour of the day rather than police shift. Because an animated map of hours of the day needs 24 KDE layers, in this case it is particularly useful to use <code>group_modify()</code> to avoid having to create 24 different objects and then binding them together.</p>
<div class="cell" data-exercise="true" data-exercise.lines="27">
<div class="sourceCode cell-code" id="cb64" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb64-2"><a href="#cb64-2"></a></span>
<span id="cb64-3"><a href="#cb64-3"></a>assaults_by_hour <span class="ot">&lt;-</span> assaults <span class="sc">|&gt;</span> </span>
<span id="cb64-4"><a href="#cb64-4"></a>  <span class="fu">filter</span>(district <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">18</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb64-5"><a href="#cb64-5"></a>  <span class="fu">mutate</span>(</span>
<span id="cb64-6"><a href="#cb64-6"></a>    <span class="co"># Create nicely formatted labels for each hour</span></span>
<span id="cb64-7"><a href="#cb64-7"></a>    <span class="at">hour_name =</span> <span class="fu">str_pad</span>(<span class="fu">hour</span>(date), <span class="at">width =</span> <span class="dv">2</span>, <span class="at">pad =</span> <span class="st">"0"</span>),</span>
<span id="cb64-8"><a href="#cb64-8"></a>    <span class="at">hour_name =</span> <span class="fu">str_glue</span>(<span class="st">"{hour_name}:00 to {hour_name}:59"</span>)</span>
<span id="cb64-9"><a href="#cb64-9"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb64-10"><a href="#cb64-10"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb64-11"><a href="#cb64-11"></a>  <span class="co"># Convert the data to a suitable co-ordinate system for Chicago</span></span>
<span id="cb64-12"><a href="#cb64-12"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:26916"</span>)</span>
<span id="cb64-13"><a href="#cb64-13"></a></span>
<span id="cb64-14"><a href="#cb64-14"></a>hour_layers <span class="ot">&lt;-</span> assaults_by_hour <span class="sc">|&gt;</span> </span>
<span id="cb64-15"><a href="#cb64-15"></a>  <span class="fu">group_by</span>(hour_name) <span class="sc">|&gt;</span> </span>
<span id="cb64-16"><a href="#cb64-16"></a>  <span class="fu">group_modify</span>(</span>
<span id="cb64-17"><a href="#cb64-17"></a>    <span class="sc">~</span> <span class="fu">hotspot_kde</span>(.x, <span class="at">cell_size =</span> <span class="dv">200</span>, <span class="at">bandwidth_adjust =</span> <span class="fl">0.75</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-18"><a href="#cb64-18"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb64-19"><a href="#cb64-19"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb64-20"><a href="#cb64-20"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb64-21"><a href="#cb64-21"></a>  <span class="fu">st_intersection</span>(cpd_central)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a><span class="co"># Extract only the 10 cells with the highest density in each hour</span></span>
<span id="cb66-2"><a href="#cb66-2"></a>hour_highest <span class="ot">&lt;-</span> hour_layers <span class="sc">|&gt;</span> </span>
<span id="cb66-3"><a href="#cb66-3"></a>  <span class="fu">group_by</span>(hour_name) <span class="sc">|&gt;</span> </span>
<span id="cb66-4"><a href="#cb66-4"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> kde, <span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="box notewell tutorial">
<p>It is possible that this code will time out and give an error saying <code>Your code ran longer than the permitted timelimit for this exercise.</code> – if that happens then just continue with the rest of the tutorial as normal.</p>
</div>
<div class="box notewell book">
<p>This code is likely to take a while to run, because it calculates KDE values separately for every grid cell for each of 24 hours.</p>
</div>
<p>We can now use the <code>hour_highest</code> object as the basis for a new base map that only includes the areas of the highest density (so they appear larger on the animated map).</p>
<p>To create an animated map we use the <code>transition_states()</code> function from the <code>gganimate</code> package. <code>transition_states()</code> works in a similar way to <code>facet_wrap()</code>, in that when added to a <code>ggplot()</code> stack it splits the chart or map up into a separate map for each value of one of the variables in the data (in this case, the hour of the day). The only difference is that while <code>facet_wrap()</code> arranges those separate maps next to one another, <code>transition_states()</code> arranges them into an animation.</p>
<div class="cell" data-exercise="true" data-exercise.lines="18">
<div class="sourceCode cell-code" id="cb67" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb67-3"><a href="#cb67-3"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb67-4"><a href="#cb67-4"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> kde),</span>
<span id="cb67-5"><a href="#cb67-5"></a>    <span class="at">data =</span> hour_highest, </span>
<span id="cb67-6"><a href="#cb67-6"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>, </span>
<span id="cb67-7"><a href="#cb67-7"></a>    <span class="at">colour =</span> <span class="cn">NA</span>,</span>
<span id="cb67-8"><a href="#cb67-8"></a>    <span class="at">fill =</span> <span class="st">"red2"</span></span>
<span id="cb67-9"><a href="#cb67-9"></a>  ) <span class="sc">+</span></span>
<span id="cb67-10"><a href="#cb67-10"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> cpd_central, <span class="at">colour =</span> <span class="st">"grey33"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb67-11"><a href="#cb67-11"></a>  <span class="fu">transition_states</span>(<span class="at">states =</span> hour_name) <span class="sc">+</span></span>
<span id="cb67-12"><a href="#cb67-12"></a>  <span class="fu">labs</span>(</span>
<span id="cb67-13"><a href="#cb67-13"></a>    <span class="at">title =</span> <span class="st">"Aggravated assaults in downtown Chicago, 2010-2019"</span>,</span>
<span id="cb67-14"><a href="#cb67-14"></a>    <span class="at">subtitle =</span> <span class="st">"Areas with most aggravated assaults:</span><span class="sc">\n</span><span class="st">{closest_state}"</span>,</span>
<span id="cb67-15"><a href="#cb67-15"></a>    <span class="at">caption =</span> <span class="st">"Data from Chicago Police"</span></span>
<span id="cb67-16"><a href="#cb67-16"></a>  ) <span class="sc">+</span></span>
<span id="cb67-17"><a href="#cb67-17"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/animated-exercise3-1.gif" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="box extra-detail tutorial">
<h5 id="animated-box1-title" class="box-title anchored">
I got an error starting <code>Your code ran longer than</code>
</h5>
<div id="animated-box1" class="box-content">
<p>This code may take longer to run than is allowed for code inside an interactive tutorial. In which case, you may see the error <code>Your code ran longer than the permitted timelimit for this exercise</code>. If that happens, you can <a href="https://mpjashby.github.io/crimemappingdata/chicago_aggravated_assaults.csv.gz">download the Chicago assaults data</a> and create an animated map in an R script of your own using the code in the chunks above. For reference, this code should produce a map looking like this:</p>
<p class="centered-image">
<img src="https://github.com/mpjashby/crimemapping/raw/main/inst/tutorials/16_mapping_time/images/chicago_animated_highest.gif" alt="Animated map showing how the areas of downtown Chicago with the highest density of aggravated assaults vary throughout the hours of the day.">
</p>
</div>
</div>
<script>
$("#animated-box1-title").click(function () { $("#animated-box1").toggle("slow") })
</script>
<p>There is one other function of <code>gganimate</code> we have used in the code used to make this map. You might have noticed that in the map <code>subtitle</code> is the code <code>{closest_state}</code>. This is a special code that <code>gganimate</code> will replace with the current value of the variable in the data that is used to control which facet appears in each frame of the animation. So for this map, <code>{closest_state}</code> will be replaced in the animation with the value of the <code>hour_name</code> variable in the data for each frame in the animation.</p>
<p>This animated map is very sensitive to the number of grid cells we choose to extract (in the map above, 10 cells for each hour) – it might look quite different if we had chosen a different number. To show the density of crime in all of downtown Chicago, we can combine the base map and KDE layers we have already created to produce another animated map.</p>
<div class="cell" data-exercise="true" data-exercise.lines="18">
<div class="sourceCode cell-code" id="cb68" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb68-2"><a href="#cb68-2"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb68-3"><a href="#cb68-3"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> kde), <span class="at">data =</span> hour_layers, <span class="at">alpha =</span> <span class="fl">0.75</span>, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb68-4"><a href="#cb68-4"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> cpd_central, <span class="at">colour =</span> <span class="st">"grey33"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb68-5"><a href="#cb68-5"></a>  <span class="fu">transition_states</span>(<span class="at">states =</span> hour_name) <span class="sc">+</span></span>
<span id="cb68-6"><a href="#cb68-6"></a>  <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb68-7"><a href="#cb68-7"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(hour_layers, kde)),</span>
<span id="cb68-8"><a href="#cb68-8"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>),</span>
<span id="cb68-9"><a href="#cb68-9"></a>    <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb68-10"><a href="#cb68-10"></a>  ) <span class="sc">+</span></span>
<span id="cb68-11"><a href="#cb68-11"></a>  <span class="fu">labs</span>(</span>
<span id="cb68-12"><a href="#cb68-12"></a>    <span class="at">title =</span> <span class="st">"Aggravated assaults in downtown Chicago, 2010-2019"</span>,</span>
<span id="cb68-13"><a href="#cb68-13"></a>    <span class="at">subtitle =</span> <span class="st">"Density of aggravated assaults: {closest_state}"</span>,</span>
<span id="cb68-14"><a href="#cb68-14"></a>    <span class="at">caption =</span> <span class="st">"Data from Chicago Police"</span>,</span>
<span id="cb68-15"><a href="#cb68-15"></a>    <span class="at">fill =</span> <span class="st">"density of</span><span class="sc">\n</span><span class="st">aggravated</span><span class="sc">\n</span><span class="st">assaults"</span></span>
<span id="cb68-16"><a href="#cb68-16"></a>  ) <span class="sc">+</span></span>
<span id="cb68-17"><a href="#cb68-17"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/animated-exercise4-1.gif" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="tutorial">
<p>This code typically takes a minute or so to finish running because it has to generate 24 maps and then stitch them together. It is unlikely that the code will finish running before the maximum time that a chunk of code in an R tutorial is allowed to run for before automatically stopping. If you were to run this code in RStudio, the map it would produce would look like this:</p>
<p class="centered-image">
<img src="https://github.com/mpjashby/crimemapping/raw/main/inst/tutorials/16_mapping_time/images/chicago_downtown_agg_assaults.gif" alt="Animated map showing how the density of aggravated assaults in Chicago varies throughout the hours of the day.">
</p>
</div>
<p>We can save an animated map to a file using the <code>animate()</code> and <code>anim_save()</code> functions. <code>animate()</code> controls the type of file the animation will be saved in (by default, an animated GIF), the height and width of the plot and so on. <code>anim_save()</code> then saves the animation in a file. For example, if we stored the map created above in an object called <code>chicago_downtown_kde_map</code>, we could save it to an animated GIF file.</p>
<div class="sourceCode" id="cb69" data-code-line-numbers=""><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a><span class="fu">anim_save</span>(</span>
<span id="cb69-2"><a href="#cb69-2"></a>  <span class="at">filename =</span> <span class="st">"chicago_downtown_agg_assaults.gif"</span>, </span>
<span id="cb69-3"><a href="#cb69-3"></a>  <span class="at">animation =</span> <span class="fu">animate</span>(</span>
<span id="cb69-4"><a href="#cb69-4"></a>    <span class="at">plot =</span> chicago_downtown_kde_map,</span>
<span id="cb69-5"><a href="#cb69-5"></a>    <span class="at">height =</span> <span class="dv">800</span>, </span>
<span id="cb69-6"><a href="#cb69-6"></a>    <span class="at">width =</span> <span class="dv">800</span>, </span>
<span id="cb69-7"><a href="#cb69-7"></a>    <span class="at">units =</span> <span class="st">"px"</span></span>
<span id="cb69-8"><a href="#cb69-8"></a>  )</span>
<span id="cb69-9"><a href="#cb69-9"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="in-summary" class="level2" data-number="16.6">
<h2 data-number="16.6" class="anchored" data-anchor-id="in-summary"><span class="header-section-number">16.6</span> In summary</h2>
<div class="box welldone">
<p>In this tutorial we have learned how to incorporate change over time into our analysis of where crime happens. This is important because the distribution of crime across different places often varies at different times. Being aware of the importance of time when we make maps means we can do things like create small-multiple or animated maps for different time periods, which we could use to make sure that scarce crime-prevention resources are used at the right time as well as in the right place.</p>
</div>
<p>This is the complete code we need to create an animated map of aggravated assaults in Chicago. Think about how you could change it, or what extra information you could add, to make this map as useful as possible to different groups of practitioners and policy makers.</p>
<div class="cell" data-exercise="true" data-exercise.lines="72">
<div class="sourceCode cell-code" id="cb70" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a><span class="co"># Load packages</span></span>
<span id="cb70-2"><a href="#cb70-2"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb70-3"><a href="#cb70-3"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb70-4"><a href="#cb70-4"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb70-5"><a href="#cb70-5"></a><span class="fu">library</span>(sf)</span>
<span id="cb70-6"><a href="#cb70-6"></a><span class="fu">library</span>(sfhotspot)</span>
<span id="cb70-7"><a href="#cb70-7"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb70-8"><a href="#cb70-8"></a></span>
<span id="cb70-9"><a href="#cb70-9"></a></span>
<span id="cb70-10"><a href="#cb70-10"></a><span class="co"># Load data --------------------------------------------------------------------</span></span>
<span id="cb70-11"><a href="#cb70-11"></a></span>
<span id="cb70-12"><a href="#cb70-12"></a><span class="co"># Aggravated assaults, Chicago, 2010 to 2019</span></span>
<span id="cb70-13"><a href="#cb70-13"></a>assaults <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/chicago_aggravated_assaults.csv.gz"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Rows: 148636 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (1): loc_cat
dbl  (3): longitude, latitude, district
dttm (1): date

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a><span class="co"># Chicago Police districts 1, 12 and 18</span></span>
<span id="cb72-2"><a href="#cb72-2"></a>cpd_central <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"https://mpjashby.github.io/crimemappingdata/chicago_police_districts.kml"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-3"><a href="#cb72-3"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:26916"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-4"><a href="#cb72-4"></a>  <span class="fu">mutate</span>(<span class="at">district_no =</span> <span class="fu">as.numeric</span>(Name)) <span class="sc">|&gt;</span> </span>
<span id="cb72-5"><a href="#cb72-5"></a>  <span class="fu">filter</span>(district_no <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">18</span>))</span>
<span id="cb72-6"><a href="#cb72-6"></a></span>
<span id="cb72-7"><a href="#cb72-7"></a></span>
<span id="cb72-8"><a href="#cb72-8"></a><span class="co"># Wrangle data -----------------------------------------------------------------</span></span>
<span id="cb72-9"><a href="#cb72-9"></a></span>
<span id="cb72-10"><a href="#cb72-10"></a><span class="co"># Calculate number of assaults each hour</span></span>
<span id="cb72-11"><a href="#cb72-11"></a>hour_layers <span class="ot">&lt;-</span> assaults <span class="sc">|&gt;</span> </span>
<span id="cb72-12"><a href="#cb72-12"></a>  <span class="fu">filter</span>(district <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">18</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb72-13"><a href="#cb72-13"></a>  <span class="fu">mutate</span>(</span>
<span id="cb72-14"><a href="#cb72-14"></a>    <span class="at">hour_name =</span> <span class="fu">str_pad</span>(<span class="fu">hour</span>(date), <span class="at">width =</span> <span class="dv">2</span>, <span class="at">pad =</span> <span class="st">"0"</span>),</span>
<span id="cb72-15"><a href="#cb72-15"></a>    <span class="at">hour_name =</span> <span class="fu">str_glue</span>(<span class="st">"{hour_name}:00 to {hour_name}:59"</span>)</span>
<span id="cb72-16"><a href="#cb72-16"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb72-17"><a href="#cb72-17"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-18"><a href="#cb72-18"></a>  <span class="fu">st_transform</span>(<span class="st">"EPSG:26916"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-19"><a href="#cb72-19"></a>  <span class="fu">group_by</span>(hour_name) <span class="sc">|&gt;</span> </span>
<span id="cb72-20"><a href="#cb72-20"></a>  <span class="fu">group_modify</span>(</span>
<span id="cb72-21"><a href="#cb72-21"></a>    <span class="sc">~</span> <span class="fu">hotspot_kde</span>(.x, <span class="at">cell_size =</span> <span class="dv">200</span>, <span class="at">bandwidth_adjust =</span> <span class="fl">0.75</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb72-22"><a href="#cb72-22"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb72-23"><a href="#cb72-23"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb72-24"><a href="#cb72-24"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb72-25"><a href="#cb72-25"></a>  <span class="fu">st_intersection</span>(cpd_central)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre data-code-line-numbers=""><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="co"># Create map ---------------------------------------------------------------------</span></span>
<span id="cb74-2"><a href="#cb74-2"></a>chicago_downtown_kde_map <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb74-3"><a href="#cb74-3"></a>  <span class="fu">annotation_map_tile</span>(<span class="at">type =</span> <span class="st">"cartolight"</span>, <span class="at">zoomin =</span> <span class="dv">0</span>, <span class="at">progress =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb74-4"><a href="#cb74-4"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> kde), <span class="at">data =</span> hour_layers, <span class="at">alpha =</span> <span class="fl">0.75</span>, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb74-5"><a href="#cb74-5"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> cpd_central, <span class="at">colour =</span> <span class="st">"grey33"</span>, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb74-6"><a href="#cb74-6"></a>  <span class="fu">transition_states</span>(<span class="at">states =</span> hour_name) <span class="sc">+</span></span>
<span id="cb74-7"><a href="#cb74-7"></a>  <span class="fu">scale_fill_distiller</span>(</span>
<span id="cb74-8"><a href="#cb74-8"></a>    <span class="at">breaks =</span> <span class="fu">range</span>(<span class="fu">pull</span>(hour_layers, kde)),</span>
<span id="cb74-9"><a href="#cb74-9"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"lower"</span>, <span class="st">"higher"</span>),</span>
<span id="cb74-10"><a href="#cb74-10"></a>    <span class="at">direction =</span> <span class="dv">1</span></span>
<span id="cb74-11"><a href="#cb74-11"></a>  ) <span class="sc">+</span></span>
<span id="cb74-12"><a href="#cb74-12"></a>  <span class="fu">labs</span>(</span>
<span id="cb74-13"><a href="#cb74-13"></a>    <span class="at">title =</span> <span class="st">"Aggravated assaults in downtown Chicago, 2010-2019"</span>,</span>
<span id="cb74-14"><a href="#cb74-14"></a>    <span class="at">subtitle =</span> <span class="st">"Density of aggravated assaults: {closest_state}"</span>,</span>
<span id="cb74-15"><a href="#cb74-15"></a>    <span class="at">caption =</span> <span class="st">"Data from Chicago Police"</span>,</span>
<span id="cb74-16"><a href="#cb74-16"></a>    <span class="at">fill =</span> <span class="st">"density of</span><span class="sc">\n</span><span class="st">aggravated</span><span class="sc">\n</span><span class="st">assaults"</span></span>
<span id="cb74-17"><a href="#cb74-17"></a>  ) <span class="sc">+</span></span>
<span id="cb74-18"><a href="#cb74-18"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb74-19"><a href="#cb74-19"></a></span>
<span id="cb74-20"><a href="#cb74-20"></a></span>
<span id="cb74-21"><a href="#cb74-21"></a><span class="co"># Save map ---------------------------------------------------------------------</span></span>
<span id="cb74-22"><a href="#cb74-22"></a><span class="fu">anim_save</span>(</span>
<span id="cb74-23"><a href="#cb74-23"></a>  <span class="at">filename =</span> <span class="st">"chicago_downtown_agg_assaults.gif"</span>, </span>
<span id="cb74-24"><a href="#cb74-24"></a>  <span class="at">animation =</span> <span class="fu">animate</span>(</span>
<span id="cb74-25"><a href="#cb74-25"></a>    <span class="at">plot =</span> chicago_downtown_kde_map,</span>
<span id="cb74-26"><a href="#cb74-26"></a>    <span class="at">height =</span> <span class="dv">800</span>, </span>
<span id="cb74-27"><a href="#cb74-27"></a>    <span class="at">width =</span> <span class="dv">800</span>, </span>
<span id="cb74-28"><a href="#cb74-28"></a>    <span class="at">units =</span> <span class="st">"px"</span></span>
<span id="cb74-29"><a href="#cb74-29"></a>  )</span>
<span id="cb74-30"><a href="#cb74-30"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="reading">
<p>You can learn more about:</p>
<ul>
<li>using the different functions in the <code>lubridate</code> package to <a href="https://lubridate.tidyverse.org/articles/lubridate.html">Do more with dates and times in R</a> and</li>
<li>animating different types of map and chart in different ways in <a href="https://gganimate.com/articles/gganimate.html">Getting Started with <code>gganimate</code></a>.</li>
</ul>
</div>
<p class="credits">
<a href="https://twitter.com/allison_horst">Artwork by <span class="citation" data-cites="allison_horst">@allison_horst</span></a>
</p>


<!-- -->

</section>

</main> <!-- /main -->
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";
  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    btn.onclick = check_func;
    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../15_no_maps/index.html" class="pagination-link" aria-label="Presenting spatial data without maps">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Presenting spatial data without maps</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../appendices/read_functions.html" class="pagination-link" aria-label="Functions for reading data into R">
        <span class="nav-page-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Functions for reading data into R</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb75" data-shortcodes="false" data-code-line-numbers=""><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb75-1"><a href="#cb75-1"></a><span class="co">---</span></span>
<span id="cb75-2"><a href="#cb75-2"></a><span class="an">execute:</span></span>
<span id="cb75-3"><a href="#cb75-3"></a><span class="co">  freeze: auto</span></span>
<span id="cb75-4"><a href="#cb75-4"></a><span class="co">---</span></span>
<span id="cb75-5"><a href="#cb75-5"></a></span>
<span id="cb75-6"><a href="#cb75-6"></a><span class="fu"># Mapping crime over time {#sec-mapping-time}</span></span>
<span id="cb75-7"><a href="#cb75-7"></a></span>
<span id="cb75-8"><a href="#cb75-8"></a>**Learn to show change over time on crime maps and charts**</span>
<span id="cb75-9"><a href="#cb75-9"></a></span>
<span id="cb75-10"><a href="#cb75-10"></a>::: {.callout-important}</span>
<span id="cb75-11"><a href="#cb75-11"></a>This chapter has not yet been updated for 2025, so some material is out of date. Check back for an update in mid-February 2025.</span>
<span id="cb75-12"><a href="#cb75-12"></a>:::</span>
<span id="cb75-13"><a href="#cb75-13"></a></span>
<span id="cb75-14"><a href="#cb75-14"></a></span>
<span id="cb75-15"><a href="#cb75-15"></a><span class="in">```{r setup, include=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb75-16"><a href="#cb75-16"></a><span class="in">#| echo: false</span></span>
<span id="cb75-17"><a href="#cb75-17"></a><span class="in">#| include: false</span></span>
<span id="cb75-18"><a href="#cb75-18"></a></span>
<span id="cb75-19"><a href="#cb75-19"></a><span class="in">source(here::here("mask_learnr_functions.R"))</span></span>
<span id="cb75-20"><a href="#cb75-20"></a></span>
<span id="cb75-21"><a href="#cb75-21"></a><span class="in"># Load packages</span></span>
<span id="cb75-22"><a href="#cb75-22"></a><span class="in"># Note that `gifski` and `transformr` aren't used in the tutorial, but are</span></span>
<span id="cb75-23"><a href="#cb75-23"></a><span class="in"># required for `gganimate` to be able to create animated maps, so they are</span></span>
<span id="cb75-24"><a href="#cb75-24"></a><span class="in"># loaded here to force `learnr` to prompt the user to install them the first</span></span>
<span id="cb75-25"><a href="#cb75-25"></a><span class="in"># time they load this tutorial</span></span>
<span id="cb75-26"><a href="#cb75-26"></a><span class="in">library(gganimate)</span></span>
<span id="cb75-27"><a href="#cb75-27"></a><span class="in">library(ggspatial)</span></span>
<span id="cb75-28"><a href="#cb75-28"></a><span class="in">library(gifski)</span></span>
<span id="cb75-29"><a href="#cb75-29"></a><span class="in">library(lubridate)</span></span>
<span id="cb75-30"><a href="#cb75-30"></a><span class="in">library(sf)</span></span>
<span id="cb75-31"><a href="#cb75-31"></a><span class="in">library(sfhotspot)</span></span>
<span id="cb75-32"><a href="#cb75-32"></a><span class="in">library(slider)</span></span>
<span id="cb75-33"><a href="#cb75-33"></a><span class="in">library(tidyverse)</span></span>
<span id="cb75-34"><a href="#cb75-34"></a><span class="in">library(transformr)</span></span>
<span id="cb75-35"><a href="#cb75-35"></a></span>
<span id="cb75-36"><a href="#cb75-36"></a></span>
<span id="cb75-37"><a href="#cb75-37"></a></span>
<span id="cb75-38"><a href="#cb75-38"></a><span class="in"># Load data --------------------------------------------------------------------</span></span>
<span id="cb75-39"><a href="#cb75-39"></a></span>
<span id="cb75-40"><a href="#cb75-40"></a><span class="in"># Crime data for demonstrating date manipulation</span></span>
<span id="cb75-41"><a href="#cb75-41"></a><span class="in">crimes &lt;- read_csv(</span></span>
<span id="cb75-42"><a href="#cb75-42"></a><span class="in">  "https://mpjashby.github.io/crimemappingdata/bronx_shootings.csv",</span></span>
<span id="cb75-43"><a href="#cb75-43"></a><span class="in">  show_col_types = FALSE</span></span>
<span id="cb75-44"><a href="#cb75-44"></a><span class="in">) |&gt; </span></span>
<span id="cb75-45"><a href="#cb75-45"></a><span class="in">  # Change dates so they can be filtered using recent dates</span></span>
<span id="cb75-46"><a href="#cb75-46"></a><span class="in">  mutate(occur_date = as_date(runif(</span></span>
<span id="cb75-47"><a href="#cb75-47"></a><span class="in">    n(), </span></span>
<span id="cb75-48"><a href="#cb75-48"></a><span class="in">    min = as.numeric(today() - days(28 + 7)), </span></span>
<span id="cb75-49"><a href="#cb75-49"></a><span class="in">    max = as.numeric(today())</span></span>
<span id="cb75-50"><a href="#cb75-50"></a><span class="in">  )))</span></span>
<span id="cb75-51"><a href="#cb75-51"></a></span>
<span id="cb75-52"><a href="#cb75-52"></a><span class="in"># Crime data for demonstrating date creation</span></span>
<span id="cb75-53"><a href="#cb75-53"></a><span class="in">thefts &lt;- read_csv(</span></span>
<span id="cb75-54"><a href="#cb75-54"></a><span class="in">  "https://mpjashby.github.io/crimemappingdata/vancouver_thefts.csv.gz",</span></span>
<span id="cb75-55"><a href="#cb75-55"></a><span class="in">  show_col_types = FALSE</span></span>
<span id="cb75-56"><a href="#cb75-56"></a><span class="in">) |&gt; </span></span>
<span id="cb75-57"><a href="#cb75-57"></a><span class="in">  janitor::clean_names() |&gt; </span></span>
<span id="cb75-58"><a href="#cb75-58"></a><span class="in">  select(year, month_of_year = month, day_of_month = day, hour, minute, x, y) |&gt; </span></span>
<span id="cb75-59"><a href="#cb75-59"></a><span class="in">  filter(month_of_year == 9)</span></span>
<span id="cb75-60"><a href="#cb75-60"></a></span>
<span id="cb75-61"><a href="#cb75-61"></a></span>
<span id="cb75-62"><a href="#cb75-62"></a><span class="in">## Assaults data for animated map ----</span></span>
<span id="cb75-63"><a href="#cb75-63"></a></span>
<span id="cb75-64"><a href="#cb75-64"></a><span class="in"># Load data </span></span>
<span id="cb75-65"><a href="#cb75-65"></a><span class="in">assaults &lt;- read_csv(</span></span>
<span id="cb75-66"><a href="#cb75-66"></a><span class="in">  "https://mpjashby.github.io/crimemappingdata/chicago_aggravated_assaults.csv.gz",</span></span>
<span id="cb75-67"><a href="#cb75-67"></a><span class="in">  show_col_types = FALSE</span></span>
<span id="cb75-68"><a href="#cb75-68"></a><span class="in">)</span></span>
<span id="cb75-69"><a href="#cb75-69"></a><span class="in">cpd_districts &lt;- read_sf("https://mpjashby.github.io/crimemappingdata/chicago_police_districts.kml") |&gt; </span></span>
<span id="cb75-70"><a href="#cb75-70"></a><span class="in">  st_transform("EPSG:26916") |&gt; </span></span>
<span id="cb75-71"><a href="#cb75-71"></a><span class="in">  select(district_no = Name, geometry) |&gt; </span></span>
<span id="cb75-72"><a href="#cb75-72"></a><span class="in">  mutate(district_no = as.numeric(district_no))</span></span>
<span id="cb75-73"><a href="#cb75-73"></a><span class="in">cpd_central &lt;- filter(cpd_districts, district_no %in% c(1, 12, 18))</span></span>
<span id="cb75-74"><a href="#cb75-74"></a></span>
<span id="cb75-75"><a href="#cb75-75"></a><span class="in"># Weekly counts</span></span>
<span id="cb75-76"><a href="#cb75-76"></a><span class="in">assault_weekly_counts &lt;- assaults |&gt; </span></span>
<span id="cb75-77"><a href="#cb75-77"></a><span class="in">  mutate(week_date = floor_date(as_date(date), unit = "week")) |&gt; </span></span>
<span id="cb75-78"><a href="#cb75-78"></a><span class="in">  count(week_date, name = "count") |&gt; </span></span>
<span id="cb75-79"><a href="#cb75-79"></a><span class="in">  slice(2:(n() - 1))</span></span>
<span id="cb75-80"><a href="#cb75-80"></a></span>
<span id="cb75-81"><a href="#cb75-81"></a><span class="in"># Hourly counts</span></span>
<span id="cb75-82"><a href="#cb75-82"></a><span class="in">assault_hourly_counts &lt;- assaults |&gt; </span></span>
<span id="cb75-83"><a href="#cb75-83"></a><span class="in">  mutate(wday = wday(date, label = TRUE), hour = hour(date)) |&gt; </span></span>
<span id="cb75-84"><a href="#cb75-84"></a><span class="in">  count(wday, hour, name = "count") |&gt; </span></span>
<span id="cb75-85"><a href="#cb75-85"></a><span class="in">  mutate(pseudo_date = make_datetime(year = 2010, hour = hour))</span></span>
<span id="cb75-86"><a href="#cb75-86"></a></span>
<span id="cb75-87"><a href="#cb75-87"></a><span class="in"># Counts by shift </span></span>
<span id="cb75-88"><a href="#cb75-88"></a><span class="in">assaults_by_shift &lt;- assaults |&gt; </span></span>
<span id="cb75-89"><a href="#cb75-89"></a><span class="in">  filter(district %in% c(1, 12, 18)) |&gt; </span></span>
<span id="cb75-90"><a href="#cb75-90"></a><span class="in">  mutate(</span></span>
<span id="cb75-91"><a href="#cb75-91"></a><span class="in">    shift = case_when(</span></span>
<span id="cb75-92"><a href="#cb75-92"></a><span class="in">      between(hour(date), 6, 13) ~ "06:00 to 13:59",</span></span>
<span id="cb75-93"><a href="#cb75-93"></a><span class="in">      between(hour(date), 14, 21) ~ "14:00 to 21:59",</span></span>
<span id="cb75-94"><a href="#cb75-94"></a><span class="in">      hour(date) &gt;= 22 | hour(date) &lt; 6 ~ "22:00 to 05:59",</span></span>
<span id="cb75-95"><a href="#cb75-95"></a><span class="in">      TRUE ~ NA_character_</span></span>
<span id="cb75-96"><a href="#cb75-96"></a><span class="in">    )</span></span>
<span id="cb75-97"><a href="#cb75-97"></a><span class="in">  ) |&gt; </span></span>
<span id="cb75-98"><a href="#cb75-98"></a><span class="in">  st_as_sf(coords = c("longitude", "latitude"), crs = "EPSG:4326") |&gt; </span></span>
<span id="cb75-99"><a href="#cb75-99"></a><span class="in">  st_transform("EPSG:26916")</span></span>
<span id="cb75-100"><a href="#cb75-100"></a></span>
<span id="cb75-101"><a href="#cb75-101"></a><span class="in"># Assaults by shift nested</span></span>
<span id="cb75-102"><a href="#cb75-102"></a><span class="in">nested_assaults &lt;- assaults_by_shift |&gt; </span></span>
<span id="cb75-103"><a href="#cb75-103"></a><span class="in">  # Remove all the columns except the ones we want</span></span>
<span id="cb75-104"><a href="#cb75-104"></a><span class="in">  select(shift, geometry) |&gt; </span></span>
<span id="cb75-105"><a href="#cb75-105"></a><span class="in">  # Nest the `geometry` column</span></span>
<span id="cb75-106"><a href="#cb75-106"></a><span class="in">  nest(data = geometry)</span></span>
<span id="cb75-107"><a href="#cb75-107"></a></span>
<span id="cb75-108"><a href="#cb75-108"></a></span>
<span id="cb75-109"><a href="#cb75-109"></a><span class="in">## KDE layers ----</span></span>
<span id="cb75-110"><a href="#cb75-110"></a></span>
<span id="cb75-111"><a href="#cb75-111"></a><span class="in"># KDE layers for assaults by shift small multiples</span></span>
<span id="cb75-112"><a href="#cb75-112"></a><span class="in">kde_by_shift &lt;- assaults_by_shift |&gt; </span></span>
<span id="cb75-113"><a href="#cb75-113"></a><span class="in">  group_by(shift) |&gt; </span></span>
<span id="cb75-114"><a href="#cb75-114"></a><span class="in">  group_modify(~ hotspot_kde(.x, cell_size = 200, bandwidth_adjust = 0.75)) |&gt; </span></span>
<span id="cb75-115"><a href="#cb75-115"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb75-116"><a href="#cb75-116"></a><span class="in">  st_as_sf() |&gt; </span></span>
<span id="cb75-117"><a href="#cb75-117"></a><span class="in">  st_intersection(cpd_central)</span></span>
<span id="cb75-118"><a href="#cb75-118"></a></span>
<span id="cb75-119"><a href="#cb75-119"></a><span class="in"># KDE layers for assaults by hour animation</span></span>
<span id="cb75-120"><a href="#cb75-120"></a><span class="in">if (file.exists("www/chicago_hourly_kde.rds")) {</span></span>
<span id="cb75-121"><a href="#cb75-121"></a><span class="in">  </span></span>
<span id="cb75-122"><a href="#cb75-122"></a><span class="in">  hour_layers &lt;- read_rds("www/chicago_hourly_kde.rds")</span></span>
<span id="cb75-123"><a href="#cb75-123"></a><span class="in">  </span></span>
<span id="cb75-124"><a href="#cb75-124"></a><span class="in">} else {</span></span>
<span id="cb75-125"><a href="#cb75-125"></a><span class="in">  </span></span>
<span id="cb75-126"><a href="#cb75-126"></a><span class="in">  assaults_by_hour &lt;- assaults |&gt; </span></span>
<span id="cb75-127"><a href="#cb75-127"></a><span class="in">    filter(district %in% c(1, 12, 18)) |&gt; </span></span>
<span id="cb75-128"><a href="#cb75-128"></a><span class="in">    mutate(</span></span>
<span id="cb75-129"><a href="#cb75-129"></a><span class="in">      # Create nicely formatted labels for each hour</span></span>
<span id="cb75-130"><a href="#cb75-130"></a><span class="in">      hour_name = str_pad(hour(date), width = 2, pad = "0"),</span></span>
<span id="cb75-131"><a href="#cb75-131"></a><span class="in">      hour_name = str_glue("{hour_name}:00 to {hour_name}:59")</span></span>
<span id="cb75-132"><a href="#cb75-132"></a><span class="in">    ) |&gt; </span></span>
<span id="cb75-133"><a href="#cb75-133"></a><span class="in">    st_as_sf(coords = c("longitude", "latitude"), crs = "EPSG:4326")  |&gt;  </span></span>
<span id="cb75-134"><a href="#cb75-134"></a><span class="in">    # Convert the data to a suitable co-ordinate system for Chicago</span></span>
<span id="cb75-135"><a href="#cb75-135"></a><span class="in">    st_transform("EPSG:26916")</span></span>
<span id="cb75-136"><a href="#cb75-136"></a><span class="in">  </span></span>
<span id="cb75-137"><a href="#cb75-137"></a><span class="in">  hour_layers &lt;- assaults_by_hour |&gt; </span></span>
<span id="cb75-138"><a href="#cb75-138"></a><span class="in">    group_by(hour_name) |&gt; </span></span>
<span id="cb75-139"><a href="#cb75-139"></a><span class="in">    group_modify(~ hotspot_kde(.x, cell_size = 200, bandwidth_adjust = 0.75)) |&gt; </span></span>
<span id="cb75-140"><a href="#cb75-140"></a><span class="in">    ungroup() |&gt; </span></span>
<span id="cb75-141"><a href="#cb75-141"></a><span class="in">    st_as_sf() |&gt; </span></span>
<span id="cb75-142"><a href="#cb75-142"></a><span class="in">    # Clip the result to the boundary of Chicago, which is already stored in the </span></span>
<span id="cb75-143"><a href="#cb75-143"></a><span class="in">    # `cpd_districts` object</span></span>
<span id="cb75-144"><a href="#cb75-144"></a><span class="in">    st_intersection(cpd_central)</span></span>
<span id="cb75-145"><a href="#cb75-145"></a><span class="in">  </span></span>
<span id="cb75-146"><a href="#cb75-146"></a><span class="in">  # If run manually, this path will need to be prefixed with</span></span>
<span id="cb75-147"><a href="#cb75-147"></a><span class="in">  # "inst/tutorials/16_mapping_time/"</span></span>
<span id="cb75-148"><a href="#cb75-148"></a><span class="in">  write_rds(hour_layers, "www/chicago_hourly_kde.rds")</span></span>
<span id="cb75-149"><a href="#cb75-149"></a><span class="in">  </span></span>
<span id="cb75-150"><a href="#cb75-150"></a><span class="in">}</span></span>
<span id="cb75-151"><a href="#cb75-151"></a></span>
<span id="cb75-152"><a href="#cb75-152"></a><span class="in"># KDE cells with highest density by hour</span></span>
<span id="cb75-153"><a href="#cb75-153"></a><span class="in">hour_highest &lt;- hour_layers |&gt; </span></span>
<span id="cb75-154"><a href="#cb75-154"></a><span class="in">  group_by(hour_name) |&gt; </span></span>
<span id="cb75-155"><a href="#cb75-155"></a><span class="in">  slice_max(order_by = kde, n = 10)</span></span>
<span id="cb75-156"><a href="#cb75-156"></a><span class="in">```</span></span>
<span id="cb75-157"><a href="#cb75-157"></a></span>
<span id="cb75-158"><a href="#cb75-158"></a></span>
<span id="cb75-159"><a href="#cb75-159"></a></span>
<span id="cb75-160"><a href="#cb75-160"></a><span class="fu">## Introduction</span></span>
<span id="cb75-161"><a href="#cb75-161"></a></span>
<span id="cb75-162"><a href="#cb75-162"></a>Understanding how crime varies over time is just as important as understanding </span>
<span id="cb75-163"><a href="#cb75-163"></a>how it varies between places. Very few places are hotspots of crime all the time </span>
<span id="cb75-164"><a href="#cb75-164"></a>– business districts might be hotspots of pickpocketing in the daytime but </span>
<span id="cb75-165"><a href="#cb75-165"></a>deserted at night, while a nearby entertainment district may be quiet in the </span>
<span id="cb75-166"><a href="#cb75-166"></a>daytime but a violence hotspot at night.</span>
<span id="cb75-167"><a href="#cb75-167"></a></span>
<span id="cb75-168"><a href="#cb75-168"></a>Crime varies over time in lots of ways. For example, there was a long-term drop</span>
<span id="cb75-169"><a href="#cb75-169"></a>in many types of crime in many countries starting in the mid 1990s, e.g.</span>
<span id="cb75-170"><a href="#cb75-170"></a><span class="co">[</span><span class="ot">residential burglary in England and Wales dropped by 67% between 1993 and 2008</span><span class="co">](https://crimesciencejournal.biomedcentral.com/articles/10.1186/s40163-016-0051-z)</span></span>
<span id="cb75-171"><a href="#cb75-171"></a>while the number of </span>
<span id="cb75-172"><a href="#cb75-172"></a><span class="co">[</span><span class="ot">homicides in New York City dropped almost 90% from 2,245 in 1990 to 289 in 2018</span><span class="co">](https://www.brennancenter.org/our-work/analysis-opinion/takeaways-2019-crime-data-major-american-cities)</span>.</span>
<span id="cb75-173"><a href="#cb75-173"></a></span>
<span id="cb75-174"><a href="#cb75-174"></a>There are also short-term variations in crime. Many types of crime are more</span>
<span id="cb75-175"><a href="#cb75-175"></a>common at some types of year than others (known as *seasonal variation*). In</span>
<span id="cb75-176"><a href="#cb75-176"></a>Chicago, for example, assaults, residential burglaries and personal robberies </span>
<span id="cb75-177"><a href="#cb75-177"></a>all vary throughout the year, with assaults in particular being consistently </span>
<span id="cb75-178"><a href="#cb75-178"></a>higher in summer than winter.</span>
<span id="cb75-179"><a href="#cb75-179"></a></span>
<span id="cb75-180"><a href="#cb75-180"></a></span>
<span id="cb75-181"><a href="#cb75-181"></a><span class="in">```{r chicago-seasona-variation-charts, eval=FALSE, echo=FALSE}</span></span>
<span id="cb75-182"><a href="#cb75-182"></a><span class="in">crimes &lt;- crimedata::get_crime_data(</span></span>
<span id="cb75-183"><a href="#cb75-183"></a><span class="in">  years = 2010:2019,</span></span>
<span id="cb75-184"><a href="#cb75-184"></a><span class="in">  cities = "Chicago",</span></span>
<span id="cb75-185"><a href="#cb75-185"></a><span class="in">  type = "core"</span></span>
<span id="cb75-186"><a href="#cb75-186"></a><span class="in">)</span></span>
<span id="cb75-187"><a href="#cb75-187"></a></span>
<span id="cb75-188"><a href="#cb75-188"></a></span>
<span id="cb75-189"><a href="#cb75-189"></a></span>
<span id="cb75-190"><a href="#cb75-190"></a><span class="in"># Seasonal chart ---------------------------------------------------------------</span></span>
<span id="cb75-191"><a href="#cb75-191"></a></span>
<span id="cb75-192"><a href="#cb75-192"></a><span class="in">counts &lt;- crimes %&gt;%</span></span>
<span id="cb75-193"><a href="#cb75-193"></a><span class="in">  mutate(</span></span>
<span id="cb75-194"><a href="#cb75-194"></a><span class="in">    offence = case_when(</span></span>
<span id="cb75-195"><a href="#cb75-195"></a><span class="in">      offense_group == "assault offenses" ~ "assaults",</span></span>
<span id="cb75-196"><a href="#cb75-196"></a><span class="in">      offense_code == "22A" ~ "residential burglaries",</span></span>
<span id="cb75-197"><a href="#cb75-197"></a><span class="in">      offense_code == "12A" ~ "personal robberies",</span></span>
<span id="cb75-198"><a href="#cb75-198"></a><span class="in">      TRUE ~ NA_character_</span></span>
<span id="cb75-199"><a href="#cb75-199"></a><span class="in">    ),</span></span>
<span id="cb75-200"><a href="#cb75-200"></a><span class="in">    yday = yday(date_single),</span></span>
<span id="cb75-201"><a href="#cb75-201"></a><span class="in">    year = year(date_single)</span></span>
<span id="cb75-202"><a href="#cb75-202"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb75-203"><a href="#cb75-203"></a><span class="in">  filter(!is.na(offence)) %&gt;%</span></span>
<span id="cb75-204"><a href="#cb75-204"></a><span class="in">  count(offence, year, yday, name = "count") %&gt;%</span></span>
<span id="cb75-205"><a href="#cb75-205"></a><span class="in">  mutate(date = as_date(str_glue("2012 {yday}"), format = "%Y %j"))</span></span>
<span id="cb75-206"><a href="#cb75-206"></a></span>
<span id="cb75-207"><a href="#cb75-207"></a><span class="in">counts_chart &lt;- ggplot(counts, aes(date, count, colour = year, group = year)) +</span></span>
<span id="cb75-208"><a href="#cb75-208"></a><span class="in">  geom_smooth(</span></span>
<span id="cb75-209"><a href="#cb75-209"></a><span class="in">    method = "loess",</span></span>
<span id="cb75-210"><a href="#cb75-210"></a><span class="in">    formula = "y ~ x",</span></span>
<span id="cb75-211"><a href="#cb75-211"></a><span class="in">    se = FALSE,</span></span>
<span id="cb75-212"><a href="#cb75-212"></a><span class="in">    size = 0.5</span></span>
<span id="cb75-213"><a href="#cb75-213"></a><span class="in">  ) +</span></span>
<span id="cb75-214"><a href="#cb75-214"></a><span class="in">  facet_wrap(vars(offence), ncol = 3, scales = "free_y") +</span></span>
<span id="cb75-215"><a href="#cb75-215"></a><span class="in">  scale_x_date(</span></span>
<span id="cb75-216"><a href="#cb75-216"></a><span class="in">    date_breaks = "2 months",</span></span>
<span id="cb75-217"><a href="#cb75-217"></a><span class="in">    date_labels = "%b",</span></span>
<span id="cb75-218"><a href="#cb75-218"></a><span class="in">    sec.axis = dup_axis()</span></span>
<span id="cb75-219"><a href="#cb75-219"></a><span class="in">  ) +</span></span>
<span id="cb75-220"><a href="#cb75-220"></a><span class="in">  scale_y_continuous(limits = c(0, NA)) +</span></span>
<span id="cb75-221"><a href="#cb75-221"></a><span class="in">  scale_colour_gradient(</span></span>
<span id="cb75-222"><a href="#cb75-222"></a><span class="in">    breaks = range(counts$year, na.rm = TRUE),</span></span>
<span id="cb75-223"><a href="#cb75-223"></a><span class="in">    labels = range(counts$year, na.rm = TRUE),</span></span>
<span id="cb75-224"><a href="#cb75-224"></a><span class="in">    low = RColorBrewer::brewer.pal(9, "Blues")[4],</span></span>
<span id="cb75-225"><a href="#cb75-225"></a><span class="in">    high = RColorBrewer::brewer.pal(9, "Blues")[9],</span></span>
<span id="cb75-226"><a href="#cb75-226"></a><span class="in">    guide = guide_colourbar(reverse = TRUE, ticks = FALSE)</span></span>
<span id="cb75-227"><a href="#cb75-227"></a><span class="in">  ) +</span></span>
<span id="cb75-228"><a href="#cb75-228"></a><span class="in">  labs(</span></span>
<span id="cb75-229"><a href="#cb75-229"></a><span class="in">    title = "Seasonal variation in selected crimes in Chicago",</span></span>
<span id="cb75-230"><a href="#cb75-230"></a><span class="in">    subtitle = "police-reported offences",</span></span>
<span id="cb75-231"><a href="#cb75-231"></a><span class="in">    x = NULL,</span></span>
<span id="cb75-232"><a href="#cb75-232"></a><span class="in">    y = "number of crimes per day",</span></span>
<span id="cb75-233"><a href="#cb75-233"></a><span class="in">    caption = "Data from Chicago Police Department"</span></span>
<span id="cb75-234"><a href="#cb75-234"></a><span class="in">  ) +</span></span>
<span id="cb75-235"><a href="#cb75-235"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb75-236"><a href="#cb75-236"></a><span class="in">  theme(</span></span>
<span id="cb75-237"><a href="#cb75-237"></a><span class="in">    axis.ticks.y = element_line(colour = "grey80"),</span></span>
<span id="cb75-238"><a href="#cb75-238"></a><span class="in">    panel.grid.major.y = element_blank(),</span></span>
<span id="cb75-239"><a href="#cb75-239"></a><span class="in">    panel.grid.minor = element_blank(),</span></span>
<span id="cb75-240"><a href="#cb75-240"></a><span class="in">    plot.caption = element_text(colour = "grey40"),</span></span>
<span id="cb75-241"><a href="#cb75-241"></a><span class="in">    plot.caption.position = "plot",</span></span>
<span id="cb75-242"><a href="#cb75-242"></a><span class="in">    plot.title = element_text(</span></span>
<span id="cb75-243"><a href="#cb75-243"></a><span class="in">      colour = "grey50",</span></span>
<span id="cb75-244"><a href="#cb75-244"></a><span class="in">      face = "bold",</span></span>
<span id="cb75-245"><a href="#cb75-245"></a><span class="in">      size = 16,</span></span>
<span id="cb75-246"><a href="#cb75-246"></a><span class="in">      margin = margin(b = 9)</span></span>
<span id="cb75-247"><a href="#cb75-247"></a><span class="in">    ),</span></span>
<span id="cb75-248"><a href="#cb75-248"></a><span class="in">    plot.title.position = "plot",</span></span>
<span id="cb75-249"><a href="#cb75-249"></a><span class="in">    strip.placement = "outside"</span></span>
<span id="cb75-250"><a href="#cb75-250"></a><span class="in">  )</span></span>
<span id="cb75-251"><a href="#cb75-251"></a></span>
<span id="cb75-252"><a href="#cb75-252"></a><span class="in">ggsave(</span></span>
<span id="cb75-253"><a href="#cb75-253"></a><span class="in">  filename = here::here("inst/tutorials/16_mapping_time/images/chicago_seasonal_variation.png"),</span></span>
<span id="cb75-254"><a href="#cb75-254"></a><span class="in">  plot = counts_chart,</span></span>
<span id="cb75-255"><a href="#cb75-255"></a><span class="in">  width = 1200 / 150,</span></span>
<span id="cb75-256"><a href="#cb75-256"></a><span class="in">  height = 500 / 150,</span></span>
<span id="cb75-257"><a href="#cb75-257"></a><span class="in">  dpi = 300</span></span>
<span id="cb75-258"><a href="#cb75-258"></a><span class="in">)</span></span>
<span id="cb75-259"><a href="#cb75-259"></a></span>
<span id="cb75-260"><a href="#cb75-260"></a></span>
<span id="cb75-261"><a href="#cb75-261"></a></span>
<span id="cb75-262"><a href="#cb75-262"></a><span class="in"># Weekly chart -----------------------------------------------------------------</span></span>
<span id="cb75-263"><a href="#cb75-263"></a></span>
<span id="cb75-264"><a href="#cb75-264"></a><span class="in">weekly_chart &lt;- crimes %&gt;%</span></span>
<span id="cb75-265"><a href="#cb75-265"></a><span class="in">  mutate(</span></span>
<span id="cb75-266"><a href="#cb75-266"></a><span class="in">    offence = case_when(</span></span>
<span id="cb75-267"><a href="#cb75-267"></a><span class="in">      offense_code == "290" ~ "property damage",</span></span>
<span id="cb75-268"><a href="#cb75-268"></a><span class="in">      offense_group == "sex offenses" ~ "sexual violence",</span></span>
<span id="cb75-269"><a href="#cb75-269"></a><span class="in">      offense_code == "23C" ~ "shoplifting",</span></span>
<span id="cb75-270"><a href="#cb75-270"></a><span class="in">      TRUE ~ NA_character_</span></span>
<span id="cb75-271"><a href="#cb75-271"></a><span class="in">    ),</span></span>
<span id="cb75-272"><a href="#cb75-272"></a><span class="in">    weekday = wday(date_single, label = TRUE, week_start = 1)</span></span>
<span id="cb75-273"><a href="#cb75-273"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb75-274"><a href="#cb75-274"></a><span class="in">  filter(!is.na(offence), !is.na(weekday)) %&gt;%</span></span>
<span id="cb75-275"><a href="#cb75-275"></a><span class="in">  count(offence, weekday, name = "count") %&gt;%</span></span>
<span id="cb75-276"><a href="#cb75-276"></a><span class="in">  mutate(</span></span>
<span id="cb75-277"><a href="#cb75-277"></a><span class="in">    count = count / (52 * 10),</span></span>
<span id="cb75-278"><a href="#cb75-278"></a><span class="in">    weekend = weekday %in% c("Sat", "Sun")</span></span>
<span id="cb75-279"><a href="#cb75-279"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb75-280"><a href="#cb75-280"></a><span class="in">  ggplot(aes(weekday, count, fill = weekend, label = str_sub(weekday, 1, 2))) +</span></span>
<span id="cb75-281"><a href="#cb75-281"></a><span class="in">  geom_col() +</span></span>
<span id="cb75-282"><a href="#cb75-282"></a><span class="in">  geom_label(</span></span>
<span id="cb75-283"><a href="#cb75-283"></a><span class="in">    aes(y = 0),</span></span>
<span id="cb75-284"><a href="#cb75-284"></a><span class="in">    colour = "white",</span></span>
<span id="cb75-285"><a href="#cb75-285"></a><span class="in">    # label.padding = unit(0.1, "lines"),</span></span>
<span id="cb75-286"><a href="#cb75-286"></a><span class="in">    label.size = NA,</span></span>
<span id="cb75-287"><a href="#cb75-287"></a><span class="in">    size = 3.25,</span></span>
<span id="cb75-288"><a href="#cb75-288"></a><span class="in">    vjust = 0</span></span>
<span id="cb75-289"><a href="#cb75-289"></a><span class="in">  ) +</span></span>
<span id="cb75-290"><a href="#cb75-290"></a><span class="in">  facet_wrap(vars(offence), ncol = 3, scales = "free_y") +</span></span>
<span id="cb75-291"><a href="#cb75-291"></a><span class="in">  scale_y_continuous(</span></span>
<span id="cb75-292"><a href="#cb75-292"></a><span class="in">    labels = scales::comma_format(accuracy = 1),</span></span>
<span id="cb75-293"><a href="#cb75-293"></a><span class="in">    expand = c(0, 0)</span></span>
<span id="cb75-294"><a href="#cb75-294"></a><span class="in">  ) +</span></span>
<span id="cb75-295"><a href="#cb75-295"></a><span class="in">  scale_fill_manual(values = c(RColorBrewer::brewer.pal(9, "Blues")[c(4, 9)])) +</span></span>
<span id="cb75-296"><a href="#cb75-296"></a><span class="in">  labs(</span></span>
<span id="cb75-297"><a href="#cb75-297"></a><span class="in">    title = "Weekly variation in selected crimes in Chicago",</span></span>
<span id="cb75-298"><a href="#cb75-298"></a><span class="in">    subtitle = "police-reported offences",</span></span>
<span id="cb75-299"><a href="#cb75-299"></a><span class="in">    x = NULL,</span></span>
<span id="cb75-300"><a href="#cb75-300"></a><span class="in">    y = "number of crimes per day",</span></span>
<span id="cb75-301"><a href="#cb75-301"></a><span class="in">    caption = "Data from Chicago Police Department"</span></span>
<span id="cb75-302"><a href="#cb75-302"></a><span class="in">  ) +</span></span>
<span id="cb75-303"><a href="#cb75-303"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb75-304"><a href="#cb75-304"></a><span class="in">  theme(</span></span>
<span id="cb75-305"><a href="#cb75-305"></a><span class="in">    axis.text.x = element_blank(),</span></span>
<span id="cb75-306"><a href="#cb75-306"></a><span class="in">    axis.title.x = element_blank(),</span></span>
<span id="cb75-307"><a href="#cb75-307"></a><span class="in">    legend.position = "none",</span></span>
<span id="cb75-308"><a href="#cb75-308"></a><span class="in">    panel.grid.major.x = element_blank(),</span></span>
<span id="cb75-309"><a href="#cb75-309"></a><span class="in">    panel.grid.minor = element_blank(),</span></span>
<span id="cb75-310"><a href="#cb75-310"></a><span class="in">    plot.caption = element_text(colour = "grey40"),</span></span>
<span id="cb75-311"><a href="#cb75-311"></a><span class="in">    plot.caption.position = "plot",</span></span>
<span id="cb75-312"><a href="#cb75-312"></a><span class="in">    plot.title = element_text(</span></span>
<span id="cb75-313"><a href="#cb75-313"></a><span class="in">      colour = "grey50",</span></span>
<span id="cb75-314"><a href="#cb75-314"></a><span class="in">      face = "bold",</span></span>
<span id="cb75-315"><a href="#cb75-315"></a><span class="in">      size = 16,</span></span>
<span id="cb75-316"><a href="#cb75-316"></a><span class="in">      margin = margin(b = 9)</span></span>
<span id="cb75-317"><a href="#cb75-317"></a><span class="in">    ),</span></span>
<span id="cb75-318"><a href="#cb75-318"></a><span class="in">    plot.title.position = "plot"</span></span>
<span id="cb75-319"><a href="#cb75-319"></a><span class="in">  )</span></span>
<span id="cb75-320"><a href="#cb75-320"></a></span>
<span id="cb75-321"><a href="#cb75-321"></a><span class="in">ggsave(</span></span>
<span id="cb75-322"><a href="#cb75-322"></a><span class="in">  filename = here::here("inst/tutorials/16_mapping_time/images/chicago_weekly_variation.png"),</span></span>
<span id="cb75-323"><a href="#cb75-323"></a><span class="in">  plot = weekly_chart,</span></span>
<span id="cb75-324"><a href="#cb75-324"></a><span class="in">  width = 1200 / 150,</span></span>
<span id="cb75-325"><a href="#cb75-325"></a><span class="in">  height = 500 / 150,</span></span>
<span id="cb75-326"><a href="#cb75-326"></a><span class="in">  dpi = 300</span></span>
<span id="cb75-327"><a href="#cb75-327"></a><span class="in">)</span></span>
<span id="cb75-328"><a href="#cb75-328"></a></span>
<span id="cb75-329"><a href="#cb75-329"></a></span>
<span id="cb75-330"><a href="#cb75-330"></a></span>
<span id="cb75-331"><a href="#cb75-331"></a><span class="in"># Trend chart ------------------------------------------------------------------</span></span>
<span id="cb75-332"><a href="#cb75-332"></a></span>
<span id="cb75-333"><a href="#cb75-333"></a><span class="in">trend_chart &lt;- crimes %&gt;%</span></span>
<span id="cb75-334"><a href="#cb75-334"></a><span class="in">  filter(offense_code == "13A", !is.na(date_single)) %&gt;%</span></span>
<span id="cb75-335"><a href="#cb75-335"></a><span class="in">  mutate(yearweek = floor_date(as_date(date_single), unit = "week")) %&gt;%</span></span>
<span id="cb75-336"><a href="#cb75-336"></a><span class="in">  count(yearweek) %&gt;%</span></span>
<span id="cb75-337"><a href="#cb75-337"></a><span class="in">  slice(2:(n() - 1)) %&gt;%</span></span>
<span id="cb75-338"><a href="#cb75-338"></a><span class="in">  mutate(rolling_mean = slide_dbl(n, mean, .before = 4, .complete = TRUE)) %&gt;%</span></span>
<span id="cb75-339"><a href="#cb75-339"></a><span class="in">  ggplot(aes(x = yearweek, y = n)) +</span></span>
<span id="cb75-340"><a href="#cb75-340"></a><span class="in">  geom_point(colour = "grey75", size = 0.75) +</span></span>
<span id="cb75-341"><a href="#cb75-341"></a><span class="in">  geom_line(aes(y = rolling_mean), na.rm = TRUE) +</span></span>
<span id="cb75-342"><a href="#cb75-342"></a><span class="in">  scale_x_date(date_breaks = "1 year", date_labels = "%e %b\n%Y", expand = c(0, 0)) +</span></span>
<span id="cb75-343"><a href="#cb75-343"></a><span class="in">  scale_y_continuous(limits = c(0, NA), expand = c(0, 0), position = "right") +</span></span>
<span id="cb75-344"><a href="#cb75-344"></a><span class="in">  labs(</span></span>
<span id="cb75-345"><a href="#cb75-345"></a><span class="in">    title = "Trend in aggravated assaults in Chicago",</span></span>
<span id="cb75-346"><a href="#cb75-346"></a><span class="in">    subtitle = "points show weekly counts, line shows four-weekly moving average",</span></span>
<span id="cb75-347"><a href="#cb75-347"></a><span class="in">    caption = "Data from Chicago Police Department",</span></span>
<span id="cb75-348"><a href="#cb75-348"></a><span class="in">    x = NULL,</span></span>
<span id="cb75-349"><a href="#cb75-349"></a><span class="in">    y = "weekly count of aggravated assaults"</span></span>
<span id="cb75-350"><a href="#cb75-350"></a><span class="in">  ) +</span></span>
<span id="cb75-351"><a href="#cb75-351"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb75-352"><a href="#cb75-352"></a><span class="in">  theme(</span></span>
<span id="cb75-353"><a href="#cb75-353"></a><span class="in">    panel.grid.minor.x = element_blank(),</span></span>
<span id="cb75-354"><a href="#cb75-354"></a><span class="in">    plot.caption = element_text(colour = "grey40"),</span></span>
<span id="cb75-355"><a href="#cb75-355"></a><span class="in">    plot.caption.position = "plot",</span></span>
<span id="cb75-356"><a href="#cb75-356"></a><span class="in">    plot.title = element_text(</span></span>
<span id="cb75-357"><a href="#cb75-357"></a><span class="in">      colour = "grey50",</span></span>
<span id="cb75-358"><a href="#cb75-358"></a><span class="in">      face = "bold",</span></span>
<span id="cb75-359"><a href="#cb75-359"></a><span class="in">      size = 16,</span></span>
<span id="cb75-360"><a href="#cb75-360"></a><span class="in">      margin = margin(b = 9)</span></span>
<span id="cb75-361"><a href="#cb75-361"></a><span class="in">    ),</span></span>
<span id="cb75-362"><a href="#cb75-362"></a><span class="in">  )</span></span>
<span id="cb75-363"><a href="#cb75-363"></a></span>
<span id="cb75-364"><a href="#cb75-364"></a><span class="in">ggsave(</span></span>
<span id="cb75-365"><a href="#cb75-365"></a><span class="in">  filename = here::here("inst/tutorials/16_mapping_time/images/chicago_assault_trend.png"),</span></span>
<span id="cb75-366"><a href="#cb75-366"></a><span class="in">  plot = trend_chart,</span></span>
<span id="cb75-367"><a href="#cb75-367"></a><span class="in">  width = 1200 / 150,</span></span>
<span id="cb75-368"><a href="#cb75-368"></a><span class="in">  height = 500 / 150,</span></span>
<span id="cb75-369"><a href="#cb75-369"></a><span class="in">  dpi = 300</span></span>
<span id="cb75-370"><a href="#cb75-370"></a><span class="in">)</span></span>
<span id="cb75-371"><a href="#cb75-371"></a><span class="in">```</span></span>
<span id="cb75-372"><a href="#cb75-372"></a></span>
<span id="cb75-373"><a href="#cb75-373"></a></span>
<span id="cb75-374"><a href="#cb75-374"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/chicago_seasonal_variation.png" alt="Chart showing that assaults, personal robberies and residential burglaries in Chicago all vary by seasonally throughout the year."&gt;&lt;/p&gt;</span>
<span id="cb75-375"><a href="#cb75-375"></a></span>
<span id="cb75-376"><a href="#cb75-376"></a>It is also important to understand short-term variation in crime. For example,</span>
<span id="cb75-377"><a href="#cb75-377"></a>both property damage and sexual violence in Chicago peaks at weekends, while </span>
<span id="cb75-378"><a href="#cb75-378"></a>there are fewer shoplifting offences on Sundays when some shops are closed or</span>
<span id="cb75-379"><a href="#cb75-379"></a>have shorter opening hours.</span>
<span id="cb75-380"><a href="#cb75-380"></a></span>
<span id="cb75-381"><a href="#cb75-381"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/chicago_weekly_variation.png" alt="Chart showing that property damage, sexual violence and shoplifting in Chicago all vary by day of the week."&gt;&lt;/p&gt;</span>
<span id="cb75-382"><a href="#cb75-382"></a></span>
<span id="cb75-383"><a href="#cb75-383"></a>Understanding variation in crime over time is important because we can use the</span>
<span id="cb75-384"><a href="#cb75-384"></a>temporal concentration of crime to focus efforts to respond to crime most</span>
<span id="cb75-385"><a href="#cb75-385"></a>effectively. For example, imagine we wanted to deploy police patrols to a </span>
<span id="cb75-386"><a href="#cb75-386"></a>hotspot to respond to a particular crime problem. Such patrols could be very </span>
<span id="cb75-387"><a href="#cb75-387"></a>effective if they were targeted at the times when crimes were most likely to </span>
<span id="cb75-388"><a href="#cb75-388"></a>happen or completely useless if the officers were deployed at the wrong day or </span>
<span id="cb75-389"><a href="#cb75-389"></a>the wrong time.</span>
<span id="cb75-390"><a href="#cb75-390"></a></span>
<span id="cb75-391"><a href="#cb75-391"></a>In this tutorial we will learn how to incorporate variation over time into our</span>
<span id="cb75-392"><a href="#cb75-392"></a>analysis of where crime happens, including making animated maps like this one:</span>
<span id="cb75-393"><a href="#cb75-393"></a></span>
<span id="cb75-394"><a href="#cb75-394"></a>&lt;p class="centered-image"&gt;&lt;img src="https://github.com/mpjashby/crimemapping/raw/main/inst/tutorials/16_mapping_time/images/chicago_downtown_agg_assaults.gif" alt="Animated map showing how the density of aggravated assaults in Chicago varies throughout the hours of the day."&gt;&lt;/p&gt;</span>
<span id="cb75-395"><a href="#cb75-395"></a></span>
<span id="cb75-396"><a href="#cb75-396"></a></span>
<span id="cb75-397"><a href="#cb75-397"></a></span>
<span id="cb75-398"><a href="#cb75-398"></a><span class="fu">## Handling dates in R</span></span>
<span id="cb75-399"><a href="#cb75-399"></a></span>
<span id="cb75-400"><a href="#cb75-400"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/lubridate_cartoon.jpg" alt="Cartoon showing little monsters feeding lubridate functions into a Back-to-the-Future-style car with the licence plate LUBRDAT."&gt;&lt;/p&gt;</span>
<span id="cb75-401"><a href="#cb75-401"></a></span>
<span id="cb75-402"><a href="#cb75-402"></a>At a very basic level, computers can store data in two days: they can store </span>
<span id="cb75-403"><a href="#cb75-403"></a>numbers and they can store text. This makes storing dates slightly complicated, </span>
<span id="cb75-404"><a href="#cb75-404"></a>because dates aren't completely like numbers and they aren't completely like </span>
<span id="cb75-405"><a href="#cb75-405"></a>text either. Dates aren't like numbers because you can't do normal maths with </span>
<span id="cb75-406"><a href="#cb75-406"></a>dates (e.g. what date is the 29th of January plus one month?) and aren't like </span>
<span id="cb75-407"><a href="#cb75-407"></a>text because you can do some maths with them (e.g. it is easy to calculate three </span>
<span id="cb75-408"><a href="#cb75-408"></a>days from today). Dates are especially complicated because they can be written </span>
<span id="cb75-409"><a href="#cb75-409"></a>as text in so many different ways. For example 17 January can be represented in </span>
<span id="cb75-410"><a href="#cb75-410"></a>all of these ways, all of them equally valid (although some are specific to </span>
<span id="cb75-411"><a href="#cb75-411"></a>particular countries):</span>
<span id="cb75-412"><a href="#cb75-412"></a></span>
<span id="cb75-413"><a href="#cb75-413"></a><span class="ss">  * </span>17/01/<span class="in">`r format(Sys.Date(), "%Y")`</span></span>
<span id="cb75-414"><a href="#cb75-414"></a><span class="ss">  * </span>17.01.<span class="in">`r format(Sys.Date(), "%y")`</span></span>
<span id="cb75-415"><a href="#cb75-415"></a><span class="ss">  * </span>1/17/<span class="in">`r format(Sys.Date(), "%Y")`</span></span>
<span id="cb75-416"><a href="#cb75-416"></a><span class="ss">  * </span><span class="in">`r format(Sys.Date(), "%Y")`</span>-01-17</span>
<span id="cb75-417"><a href="#cb75-417"></a><span class="ss">  * </span>17 Jan <span class="in">`r format(Sys.Date(), "%y")`</span></span>
<span id="cb75-418"><a href="#cb75-418"></a><span class="ss">  * </span>17 January <span class="in">`r format(Sys.Date(), "%Y")`</span></span>
<span id="cb75-419"><a href="#cb75-419"></a><span class="ss">  * </span>January 17th <span class="in">`r format(Sys.Date(), "%Y")`</span></span>
<span id="cb75-420"><a href="#cb75-420"></a></span>
<span id="cb75-421"><a href="#cb75-421"></a></span>
<span id="cb75-422"><a href="#cb75-422"></a>&lt;a href="https://lubridate.tidyverse.org/" title="lubridate website"&gt;&lt;img src="images/lubridate.png" class="right-side-image"&gt;&lt;/a&gt;</span>
<span id="cb75-423"><a href="#cb75-423"></a></span>
<span id="cb75-424"><a href="#cb75-424"></a>R deals with this problem by _storing_ dates internally as if they were numbers </span>
<span id="cb75-425"><a href="#cb75-425"></a>and _displaying_ them (e.g. in the console or in a Quarto document) as if they </span>
<span id="cb75-426"><a href="#cb75-426"></a>were text, by default in the format ``r Sys.Date()``. Fortunately, we don't have </span>
<span id="cb75-427"><a href="#cb75-427"></a>to worry about how dates and times are stored internally in R because we can use </span>
<span id="cb75-428"><a href="#cb75-428"></a>the <span class="co">[</span><span class="ot">`lubridate` package</span><span class="co">](https://lubridate.tidyverse.org/)</span> to work with them. </span>
<span id="cb75-429"><a href="#cb75-429"></a><span class="in">`lubridate`</span> contains functions for working with dates, including extracting </span>
<span id="cb75-430"><a href="#cb75-430"></a>parts of a date with functions such as <span class="in">`month()`</span> and converting text </span>
<span id="cb75-431"><a href="#cb75-431"></a>to date values with functions like <span class="in">`ymd()`</span>.</span>
<span id="cb75-432"><a href="#cb75-432"></a></span>
<span id="cb75-433"><a href="#cb75-433"></a>Because of the special nature of dates, if we want to work with a date variable</span>
<span id="cb75-434"><a href="#cb75-434"></a>(for example to create a chart of crime over time) it is important that it is</span>
<span id="cb75-435"><a href="#cb75-435"></a>stored as a date, not as text or as a number. Many R functions for reading data, </span>
<span id="cb75-436"><a href="#cb75-436"></a>including <span class="in">`read_csv()`</span>, <span class="in">`read_tsv()`</span> and <span class="in">`read_excel()`</span>, will try to recognise </span>
<span id="cb75-437"><a href="#cb75-437"></a>columns of data that contain dates and times stored in common formats. These </span>
<span id="cb75-438"><a href="#cb75-438"></a>will automatically be stored as date variables when the data is loaded. </span>
<span id="cb75-439"><a href="#cb75-439"></a></span>
<span id="cb75-440"><a href="#cb75-440"></a>If R does not recognise automatically that a value contains a date, we can</span>
<span id="cb75-441"><a href="#cb75-441"></a>convert it to a date by using the date-parsing functions from <span class="in">`lubridate`</span>. Which </span>
<span id="cb75-442"><a href="#cb75-442"></a>function to use depends on the order in which the components of the date (e.g. </span>
<span id="cb75-443"><a href="#cb75-443"></a>day, month and year) appear in the variable. For example, to convert the text </span>
<span id="cb75-444"><a href="#cb75-444"></a>"Saturday 17 January 1981" to a date format we can use the <span class="in">`dmy()`</span> function </span>
<span id="cb75-445"><a href="#cb75-445"></a>because the **d**ay of the month comes first, the **m**onth next and then the </span>
<span id="cb75-446"><a href="#cb75-446"></a>**y**ear. Similarly, converting the text "01/17/81" needs the function <span class="in">`mdy()`</span>. </span>
<span id="cb75-447"><a href="#cb75-447"></a>Note that the <span class="in">`lubridate`</span> date-parsing functions are able convert both numeric </span>
<span id="cb75-448"><a href="#cb75-448"></a>and text-based months, and to ignore elements that aren't needed, such as </span>
<span id="cb75-449"><a href="#cb75-449"></a>weekday names.</span>
<span id="cb75-450"><a href="#cb75-450"></a></span>
<span id="cb75-451"><a href="#cb75-451"></a>If a date is stored in multiple columns in a dataset, e.g. one column for the </span>
<span id="cb75-452"><a href="#cb75-452"></a>year, one column for the month and one column for the day, we can create a </span>
<span id="cb75-453"><a href="#cb75-453"></a>single date column using the <span class="in">`make_date()`</span> function to combine them. Similarly, </span>
<span id="cb75-454"><a href="#cb75-454"></a>we can create a date-time column using the <span class="in">`make_datetime()`</span> function. For </span>
<span id="cb75-455"><a href="#cb75-455"></a>example, if we have a dataset of crimes called <span class="in">`thefts`</span>:</span>
<span id="cb75-456"><a href="#cb75-456"></a></span>
<span id="cb75-457"><a href="#cb75-457"></a><span class="in">```{r dates-exercise1, exercise=TRUE}</span></span>
<span id="cb75-458"><a href="#cb75-458"></a><span class="in">library(lubridate)</span></span>
<span id="cb75-459"><a href="#cb75-459"></a></span>
<span id="cb75-460"><a href="#cb75-460"></a><span class="in">thefts |&gt;  </span></span>
<span id="cb75-461"><a href="#cb75-461"></a><span class="in">  mutate(</span></span>
<span id="cb75-462"><a href="#cb75-462"></a><span class="in">    date = make_date(year = year, month = month_of_year, day = day_of_month)</span></span>
<span id="cb75-463"><a href="#cb75-463"></a><span class="in">  ) |&gt;  </span></span>
<span id="cb75-464"><a href="#cb75-464"></a><span class="in">  select(day_of_month, month_of_year, year, date)</span></span>
<span id="cb75-465"><a href="#cb75-465"></a><span class="in">```</span></span>
<span id="cb75-466"><a href="#cb75-466"></a></span>
<span id="cb75-467"><a href="#cb75-467"></a>Note that in this dataset, the <span class="in">`date`</span> variable we have just created has the type</span>
<span id="cb75-468"><a href="#cb75-468"></a><span class="in">`&lt;date&gt;`</span>.</span>
<span id="cb75-469"><a href="#cb75-469"></a></span>
<span id="cb75-470"><a href="#cb75-470"></a>Once we have converted dates stored as text to dates stored as dates, R </span>
<span id="cb75-471"><a href="#cb75-471"></a>understands that they are dates and we can do things like compare them. So while</span>
<span id="cb75-472"><a href="#cb75-472"></a>running <span class="in">`"Sat 17 January 1981" == "01/17/81"`</span> to test if two dates are the same</span>
<span id="cb75-473"><a href="#cb75-473"></a>would give the answer <span class="in">`FALSE`</span> (because the two pieces of text are different),</span>
<span id="cb75-474"><a href="#cb75-474"></a>once we've converted the text to date values R can tell that the two dates are</span>
<span id="cb75-475"><a href="#cb75-475"></a>the same:</span>
<span id="cb75-476"><a href="#cb75-476"></a></span>
<span id="cb75-477"><a href="#cb75-477"></a><span class="in">```{r dates-exercise2, exercise=TRUE}</span></span>
<span id="cb75-478"><a href="#cb75-478"></a><span class="in"># This code returns TRUE only because the two pieces of text are identical</span></span>
<span id="cb75-479"><a href="#cb75-479"></a><span class="in">"Sat 17 January 1981" == "Sat 17 January 1981"</span></span>
<span id="cb75-480"><a href="#cb75-480"></a></span>
<span id="cb75-481"><a href="#cb75-481"></a><span class="in"># This code returns FALSE because the two pieces of text are different, even</span></span>
<span id="cb75-482"><a href="#cb75-482"></a><span class="in"># though the dates they represent are the same</span></span>
<span id="cb75-483"><a href="#cb75-483"></a><span class="in">"Sat 17 January 1981" == "01/17/81"</span></span>
<span id="cb75-484"><a href="#cb75-484"></a></span>
<span id="cb75-485"><a href="#cb75-485"></a><span class="in"># This code returns TRUE because R knows they are dates and so compares them as</span></span>
<span id="cb75-486"><a href="#cb75-486"></a><span class="in"># dates, finding that the two dates are the same</span></span>
<span id="cb75-487"><a href="#cb75-487"></a><span class="in">dmy("Sat 17 January 1981") == mdy("01/17/81")</span></span>
<span id="cb75-488"><a href="#cb75-488"></a><span class="in">```</span></span>
<span id="cb75-489"><a href="#cb75-489"></a></span>
<span id="cb75-490"><a href="#cb75-490"></a></span>
<span id="cb75-491"><a href="#cb75-491"></a><span class="fu">### Working with dates</span></span>
<span id="cb75-492"><a href="#cb75-492"></a></span>
<span id="cb75-493"><a href="#cb75-493"></a>When analysing dates and times, it is often useful to be able to extract </span>
<span id="cb75-494"><a href="#cb75-494"></a>date or time portions. We can do this with the <span class="in">`lubridate`</span> functions <span class="in">`year()`</span>, </span>
<span id="cb75-495"><a href="#cb75-495"></a><span class="in">`month()`</span>, <span class="in">`wday()`</span> (for day of the week), <span class="in">`mday()`</span> (for day of the month), </span>
<span id="cb75-496"><a href="#cb75-496"></a><span class="in">`yday()`</span> (for day of the year, counting from 1 January), <span class="in">`hour()`</span>, <span class="in">`minute()`</span> </span>
<span id="cb75-497"><a href="#cb75-497"></a>and <span class="in">`second()`</span>, each of which extracts the relevant portion of a date or time as </span>
<span id="cb75-498"><a href="#cb75-498"></a>a number. The <span class="in">`month()`</span> and <span class="in">`wday()`</span> functions are slightly different, because </span>
<span id="cb75-499"><a href="#cb75-499"></a>they can also return the day or month name as text by specifying the argument </span>
<span id="cb75-500"><a href="#cb75-500"></a><span class="in">`label = TRUE`</span>. We can see this by extracting the different portions of the </span>
<span id="cb75-501"><a href="#cb75-501"></a>current date and time, which we can retrieve with the <span class="in">`now()`</span> function from </span>
<span id="cb75-502"><a href="#cb75-502"></a><span class="in">`lubridate`</span>.</span>
<span id="cb75-503"><a href="#cb75-503"></a></span>
<span id="cb75-504"><a href="#cb75-504"></a><span class="in">```{r dates-exercise3, exercise=TRUE}</span></span>
<span id="cb75-505"><a href="#cb75-505"></a><span class="in">message("Current year: ", year(now()))</span></span>
<span id="cb75-506"><a href="#cb75-506"></a><span class="in">message("Current month (as a number): ", month(now()))</span></span>
<span id="cb75-507"><a href="#cb75-507"></a><span class="in">message("Current month (as text, abbreviated): ", month(now(), label = TRUE))</span></span>
<span id="cb75-508"><a href="#cb75-508"></a><span class="in">message("Current month (as text): ", month(now(), label = TRUE, abbr = FALSE))</span></span>
<span id="cb75-509"><a href="#cb75-509"></a><span class="in">message("Current day of the year (days since 1 Jan): ", yday(now()))</span></span>
<span id="cb75-510"><a href="#cb75-510"></a><span class="in">message("Current day of the month: ", mday(now()))</span></span>
<span id="cb75-511"><a href="#cb75-511"></a><span class="in">message("Current day of the week (as a number): ", wday(now()))</span></span>
<span id="cb75-512"><a href="#cb75-512"></a><span class="in">message("Current day of the week (as text): ", wday(now(), label = TRUE))</span></span>
<span id="cb75-513"><a href="#cb75-513"></a><span class="in">message("Current hour of the day: ", hour(now()))</span></span>
<span id="cb75-514"><a href="#cb75-514"></a><span class="in">message("Current minute: ", minute(now()))</span></span>
<span id="cb75-515"><a href="#cb75-515"></a><span class="in">message("Current second: ", second(now()))</span></span>
<span id="cb75-516"><a href="#cb75-516"></a><span class="in">```</span></span>
<span id="cb75-517"><a href="#cb75-517"></a></span>
<span id="cb75-518"><a href="#cb75-518"></a>It is sometimes useful to be able to add to or subtract from dates. For example,</span>
<span id="cb75-519"><a href="#cb75-519"></a>if you wanted to filter a dataset so that only records from the past 28 days</span>
<span id="cb75-520"><a href="#cb75-520"></a>were included, you would need to work out the date 28 days ago. We can do this</span>
<span id="cb75-521"><a href="#cb75-521"></a>with a group of functions from <span class="in">`lubridate`</span> that store a period of time that we</span>
<span id="cb75-522"><a href="#cb75-522"></a>can then add to or subtract from an existing date. These functions are </span>
<span id="cb75-523"><a href="#cb75-523"></a><span class="in">`years()`</span>, <span class="in">`months()`</span>, <span class="in">`weeks()`</span>, <span class="in">`days()`</span>, <span class="in">`hours()`</span>, <span class="in">`minutes()`</span>, and </span>
<span id="cb75-524"><a href="#cb75-524"></a><span class="in">`seconds()`</span>. </span>
<span id="cb75-525"><a href="#cb75-525"></a></span>
<span id="cb75-526"><a href="#cb75-526"></a></span>
<span id="cb75-527"><a href="#cb75-527"></a>::: {.box .notewell}</span>
<span id="cb75-528"><a href="#cb75-528"></a></span>
<span id="cb75-529"><a href="#cb75-529"></a>In the <span class="in">`lubridate`</span> package, functions that are used to _extract_ parts of a date</span>
<span id="cb75-530"><a href="#cb75-530"></a>are _singular_, e.g. <span class="in">`day()`</span>, <span class="in">`month()`</span>, <span class="in">`year()`</span>. Functions that are used to</span>
<span id="cb75-531"><a href="#cb75-531"></a>_manipulate_ dates by adding or subtracting from them are _plural_, e.g. </span>
<span id="cb75-532"><a href="#cb75-532"></a><span class="in">`days()`</span>, <span class="in">`months()`</span>, <span class="in">`years()`</span>. So, for example, you would use the code</span>
<span id="cb75-533"><a href="#cb75-533"></a><span class="in">`month(now())`</span> to extract the month (as a number between 1 and 12) from the </span>
<span id="cb75-534"><a href="#cb75-534"></a>current date but the code <span class="in">`now() + months(1)`</span> to find out what the date and time</span>
<span id="cb75-535"><a href="#cb75-535"></a>will be one month from now.</span>
<span id="cb75-536"><a href="#cb75-536"></a></span>
<span id="cb75-537"><a href="#cb75-537"></a>:::</span>
<span id="cb75-538"><a href="#cb75-538"></a></span>
<span id="cb75-539"><a href="#cb75-539"></a></span>
<span id="cb75-540"><a href="#cb75-540"></a>To subtract 28 days from today's date (which we can retrieve with the <span class="in">`today()`</span> </span>
<span id="cb75-541"><a href="#cb75-541"></a>function), we would use <span class="in">`today() - days(28)`</span>.</span>
<span id="cb75-542"><a href="#cb75-542"></a></span>
<span id="cb75-543"><a href="#cb75-543"></a><span class="in">```{r dates-exercise4, exercise=TRUE}</span></span>
<span id="cb75-544"><a href="#cb75-544"></a><span class="in">message(str_glue("Today is {today()} and 28 days ago was {today() - days(28)}"))</span></span>
<span id="cb75-545"><a href="#cb75-545"></a><span class="in">```</span></span>
<span id="cb75-546"><a href="#cb75-546"></a></span>
<span id="cb75-547"><a href="#cb75-547"></a>Adding or subtracting periods from dates can be very useful when combined with</span>
<span id="cb75-548"><a href="#cb75-548"></a>the <span class="in">`filter()`</span> function from the <span class="in">`dplyr()`</span> package. For example, if we had a</span>
<span id="cb75-549"><a href="#cb75-549"></a>dataset of crimes stored in an object called <span class="in">`crimes`</span> and wanted to extract only </span>
<span id="cb75-550"><a href="#cb75-550"></a>those that occurred in the most-recent seven days, we could do this:</span>
<span id="cb75-551"><a href="#cb75-551"></a></span>
<span id="cb75-552"><a href="#cb75-552"></a><span class="in">```{r dates-exercise5, exercise=TRUE}</span></span>
<span id="cb75-553"><a href="#cb75-553"></a><span class="in">filter(crimes, occur_date &gt;= today() - days(7))</span></span>
<span id="cb75-554"><a href="#cb75-554"></a><span class="in">```</span></span>
<span id="cb75-555"><a href="#cb75-555"></a></span>
<span id="cb75-556"><a href="#cb75-556"></a><span class="in">```{r period-setup, include=FALSE, echo=FALSE}</span></span>
<span id="cb75-557"><a href="#cb75-557"></a><span class="in">start_date &lt;- today() - days(28 + 7)</span></span>
<span id="cb75-558"><a href="#cb75-558"></a><span class="in">end_date &lt;- today() - days(7)</span></span>
<span id="cb75-559"><a href="#cb75-559"></a></span>
<span id="cb75-560"><a href="#cb75-560"></a><span class="in">start_date_formatted &lt;- case_when(</span></span>
<span id="cb75-561"><a href="#cb75-561"></a><span class="in">  year(start_date) == year(end_date) &amp;&amp; month(start_date) == month(end_date) ~ </span></span>
<span id="cb75-562"><a href="#cb75-562"></a><span class="in">    str_squish(format(start_date, "%e")),</span></span>
<span id="cb75-563"><a href="#cb75-563"></a><span class="in">  year(start_date) == year(end_date) ~ str_squish(format(start_date, "%e %B")),</span></span>
<span id="cb75-564"><a href="#cb75-564"></a><span class="in">  TRUE ~ str_squish(format(start_date, "%e %B %Y"))</span></span>
<span id="cb75-565"><a href="#cb75-565"></a><span class="in">)</span></span>
<span id="cb75-566"><a href="#cb75-566"></a><span class="in">end_date_formatted &lt;- str_squish(format(end_date, "%e %B %Y"))</span></span>
<span id="cb75-567"><a href="#cb75-567"></a><span class="in">```</span></span>
<span id="cb75-568"><a href="#cb75-568"></a></span>
<span id="cb75-569"><a href="#cb75-569"></a>If we wanted to extract crimes that occurred between two dates, we can use the</span>
<span id="cb75-570"><a href="#cb75-570"></a><span class="in">`between()`</span> function from <span class="in">`dplyr`</span>, which returns either <span class="in">`TRUE`</span> or <span class="in">`FALSE`</span> </span>
<span id="cb75-571"><a href="#cb75-571"></a>depending on whether each item in the first argument is between the values given</span>
<span id="cb75-572"><a href="#cb75-572"></a>in the second and third arguments (inclusive).</span>
<span id="cb75-573"><a href="#cb75-573"></a></span>
<span id="cb75-574"><a href="#cb75-574"></a></span>
<span id="cb75-575"><a href="#cb75-575"></a>::: {.tutorial}</span>
<span id="cb75-576"><a href="#cb75-576"></a></span>
<span id="cb75-577"><a href="#cb75-577"></a>For example, complete the following code by replacing the text <span class="in">`____`</span> and </span>
<span id="cb75-578"><a href="#cb75-578"></a><span class="in">`____`</span> with <span class="in">`ymd()`</span> functions to extract only crimes occurring between </span>
<span id="cb75-579"><a href="#cb75-579"></a><span class="in">`r start_date_formatted`</span> and <span class="in">`r end_date_formatted`</span> inclusive.</span>
<span id="cb75-580"><a href="#cb75-580"></a></span>
<span id="cb75-581"><a href="#cb75-581"></a><span class="in">```{r dates-exercise6, exercise=TRUE, error=TRUE}</span></span>
<span id="cb75-582"><a href="#cb75-582"></a><span class="in">filter(crimes, between(occur_date, ____, ____))</span></span>
<span id="cb75-583"><a href="#cb75-583"></a><span class="in">```</span></span>
<span id="cb75-584"><a href="#cb75-584"></a></span>
<span id="cb75-585"><a href="#cb75-585"></a><span class="in">```{r dates-exercise6-hint}</span></span>
<span id="cb75-586"><a href="#cb75-586"></a><span class="in"># Add the dates to the following code in YYYY-MM-DD format (because you are </span></span>
<span id="cb75-587"><a href="#cb75-587"></a><span class="in"># using the function `ymd()`)</span></span>
<span id="cb75-588"><a href="#cb75-588"></a><span class="in">filter(crimes, between(occur_date, ymd(""), ymd("")))</span></span>
<span id="cb75-589"><a href="#cb75-589"></a><span class="in">```</span></span>
<span id="cb75-590"><a href="#cb75-590"></a></span>
<span id="cb75-591"><a href="#cb75-591"></a>:::</span>
<span id="cb75-592"><a href="#cb75-592"></a></span>
<span id="cb75-593"><a href="#cb75-593"></a></span>
<span id="cb75-594"><a href="#cb75-594"></a>When filtering based on dates or times, it is important to understand that R can</span>
<span id="cb75-595"><a href="#cb75-595"></a>store dates in two ways: as a *date* object or as a *date-time* object (shown </span>
<span id="cb75-596"><a href="#cb75-596"></a>as <span class="in">`&lt;dttm&gt;`</span> when we print a tibble). Date variables store only a date with no </span>
<span id="cb75-597"><a href="#cb75-597"></a>time, while date-time variables always include a time component, even if the </span>
<span id="cb75-598"><a href="#cb75-598"></a>data doesn't contain any information about time. If we store a variable that </span>
<span id="cb75-599"><a href="#cb75-599"></a>only has information about the date of an event as a date-time variable, R will </span>
<span id="cb75-600"><a href="#cb75-600"></a>silently add the time midnight to each date. This is important because if we </span>
<span id="cb75-601"><a href="#cb75-601"></a>compare a date variable to a date-time variable, R will silently convert the </span>
<span id="cb75-602"><a href="#cb75-602"></a>dates to date-times with the times set to midnight. If we are trying to filter </span>
<span id="cb75-603"><a href="#cb75-603"></a>crimes between two times, this might not be what we want. For example, if we </span>
<span id="cb75-604"><a href="#cb75-604"></a>used the code:</span>
<span id="cb75-605"><a href="#cb75-605"></a></span>
<span id="cb75-606"><a href="#cb75-606"></a><span class="in">```r</span></span>
<span id="cb75-607"><a href="#cb75-607"></a><span class="fu">between</span>(offence_date, <span class="fu">ymd</span>(<span class="st">"2021-01-01"</span>), <span class="fu">ymd</span>(<span class="st">"2021-01-31"</span>))</span>
<span id="cb75-608"><a href="#cb75-608"></a><span class="in">```</span></span>
<span id="cb75-609"><a href="#cb75-609"></a></span>
<span id="cb75-610"><a href="#cb75-610"></a>to extract all the crimes that occurred in January 2021, that would work as we </span>
<span id="cb75-611"><a href="#cb75-611"></a>expected only if <span class="in">`offence_date`</span> was a date variable. If the <span class="in">`offence_date`</span> </span>
<span id="cb75-612"><a href="#cb75-612"></a>column instead held dates *and* times, R would filter the data *as if* we had </span>
<span id="cb75-613"><a href="#cb75-613"></a>specified:</span>
<span id="cb75-614"><a href="#cb75-614"></a></span>
<span id="cb75-615"><a href="#cb75-615"></a><span class="in">```r</span></span>
<span id="cb75-616"><a href="#cb75-616"></a><span class="fu">between</span>(offence_date, <span class="fu">ymd_hm</span>(<span class="st">"2021-01-01 00:00"</span>), <span class="fu">ymd_hm</span>(<span class="st">"2021-01-31 00:00"</span>))</span>
<span id="cb75-617"><a href="#cb75-617"></a><span class="in">```</span></span>
<span id="cb75-618"><a href="#cb75-618"></a></span>
<span id="cb75-619"><a href="#cb75-619"></a>which would exclude any crimes that occurred on 31 January (except those</span>
<span id="cb75-620"><a href="#cb75-620"></a>occurring at exactly midnight). To deal with this problem, we can either check</span>
<span id="cb75-621"><a href="#cb75-621"></a>to make sure the variables we are filtering on are date variables, convert them</span>
<span id="cb75-622"><a href="#cb75-622"></a>to date variables using the <span class="in">`as_date()`</span> function, or assume that they might be </span>
<span id="cb75-623"><a href="#cb75-623"></a>date-time variables and specify the exact time that we want as the end of our </span>
<span id="cb75-624"><a href="#cb75-624"></a>range. For example, specifying:</span>
<span id="cb75-625"><a href="#cb75-625"></a></span>
<span id="cb75-626"><a href="#cb75-626"></a><span class="in">```r</span></span>
<span id="cb75-627"><a href="#cb75-627"></a><span class="fu">between</span>(offence_date, <span class="fu">ymd_hm</span>(<span class="st">"2021-01-01 00:00"</span>), <span class="fu">ymd_hm</span>(<span class="st">"2021-01-31 23:59"</span>))</span>
<span id="cb75-628"><a href="#cb75-628"></a><span class="in">```</span></span>
<span id="cb75-629"><a href="#cb75-629"></a></span>
<span id="cb75-630"><a href="#cb75-630"></a>or</span>
<span id="cb75-631"><a href="#cb75-631"></a></span>
<span id="cb75-632"><a href="#cb75-632"></a><span class="in">```r</span></span>
<span id="cb75-633"><a href="#cb75-633"></a><span class="fu">between</span>(<span class="fu">as_date</span>(offence_date), <span class="fu">ymd</span>(<span class="st">"2021-01-01"</span>), <span class="fu">ymd</span>(<span class="st">"2021-01-31"</span>))</span>
<span id="cb75-634"><a href="#cb75-634"></a><span class="in">```</span></span>
<span id="cb75-635"><a href="#cb75-635"></a></span>
<span id="cb75-636"><a href="#cb75-636"></a>would allow us to select all the crimes occurring in January 2021.</span>
<span id="cb75-637"><a href="#cb75-637"></a></span>
<span id="cb75-638"><a href="#cb75-638"></a></span>
<span id="cb75-639"><a href="#cb75-639"></a></span>
<span id="cb75-640"><a href="#cb75-640"></a></span>
<span id="cb75-641"><a href="#cb75-641"></a><span class="fu">## Showing change over time</span></span>
<span id="cb75-642"><a href="#cb75-642"></a></span>
<span id="cb75-643"><a href="#cb75-643"></a>One common task in crime analysis is to show how crime changes over time. The</span>
<span id="cb75-644"><a href="#cb75-644"></a>simplest way to do this is to produce a *time-series chart*. For example, we can</span>
<span id="cb75-645"><a href="#cb75-645"></a>see how the frequency of aggravated assaults recorded by police in Chicago has </span>
<span id="cb75-646"><a href="#cb75-646"></a>changed over time:</span>
<span id="cb75-647"><a href="#cb75-647"></a></span>
<span id="cb75-648"><a href="#cb75-648"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/chicago_assault_trend.png" alt="Chart showing that the weekly frequency of aggravated assaults in Chicago from 2010 to 2019, including seasonal increases each summer and lower frequency of assaults from 2013 to 2015."&gt;&lt;/p&gt;</span>
<span id="cb75-649"><a href="#cb75-649"></a></span>
<span id="cb75-650"><a href="#cb75-650"></a>In this section we will learn how to construct a time-series chart like this. To </span>
<span id="cb75-651"><a href="#cb75-651"></a>illustrate this process, we will use an object called <span class="in">`assaults`</span> that contains </span>
<span id="cb75-652"><a href="#cb75-652"></a>records of aggravated assaults in Chicago from 2010 to 2019.</span>
<span id="cb75-653"><a href="#cb75-653"></a></span>
<span id="cb75-654"><a href="#cb75-654"></a><span class="in">```{r, echo=FALSE}</span></span>
<span id="cb75-655"><a href="#cb75-655"></a><span class="in">assaults |&gt; </span></span>
<span id="cb75-656"><a href="#cb75-656"></a><span class="in">  head() |&gt;  </span></span>
<span id="cb75-657"><a href="#cb75-657"></a><span class="in">  gt::gt()</span></span>
<span id="cb75-658"><a href="#cb75-658"></a><span class="in">```</span></span>
<span id="cb75-659"><a href="#cb75-659"></a></span>
<span id="cb75-660"><a href="#cb75-660"></a>The first task in charting the frequency of crime is to choose a temporal *unit </span>
<span id="cb75-661"><a href="#cb75-661"></a>of analysis*. For example, the chart above counts the number of crimes each</span>
<span id="cb75-662"><a href="#cb75-662"></a>*week*. Weeks are often a good choice as units for counting crimes, since all</span>
<span id="cb75-663"><a href="#cb75-663"></a>weeks are the same length and because many human activities have a weekly cycle</span>
<span id="cb75-664"><a href="#cb75-664"></a>(e.g. people do different things at weekends than on weekdays, even though</span>
<span id="cb75-665"><a href="#cb75-665"></a>which days count as weekdays differs across cultures). </span>
<span id="cb75-666"><a href="#cb75-666"></a></span>
<span id="cb75-667"><a href="#cb75-667"></a></span>
<span id="cb75-668"><a href="#cb75-668"></a>::: {.box .notewell}</span>
<span id="cb75-669"><a href="#cb75-669"></a></span>
<span id="cb75-670"><a href="#cb75-670"></a>Months are much less useful than weeks as a temporal unit of analysis because </span>
<span id="cb75-671"><a href="#cb75-671"></a>months differ in length, so monthly counts of crime will look like they show</span>
<span id="cb75-672"><a href="#cb75-672"></a>some variation even if the amount of crime occurring each day remains constant.</span>
<span id="cb75-673"><a href="#cb75-673"></a>For example, if exactly 10 crimes occur every day throughout February and March,</span>
<span id="cb75-674"><a href="#cb75-674"></a>there will be <span class="in">`r scales::comma(10 * 28, accuracy = 1)`</span> or </span>
<span id="cb75-675"><a href="#cb75-675"></a><span class="in">`r scales::comma(10 * 29, accuracy = 1)`</span> crimes in February (depending on </span>
<span id="cb75-676"><a href="#cb75-676"></a>whether it is a leap year) but <span class="in">`r scales::comma(10 * 31, accuracy = 1)`</span> in </span>
<span id="cb75-677"><a href="#cb75-677"></a>March. In these circumstances, it will look like the volume of crime increased </span>
<span id="cb75-678"><a href="#cb75-678"></a>by <span class="in">`r scales::percent(((10 * 31) - (10 * 28)) / (10 * 28))`</span> between February</span>
<span id="cb75-679"><a href="#cb75-679"></a>and March, not because the rate at which crimes occurred increased but because</span>
<span id="cb75-680"><a href="#cb75-680"></a>March is <span class="in">`r scales::percent(((10 * 31) - (10 * 28)) / (10 * 28))`</span> longer than</span>
<span id="cb75-681"><a href="#cb75-681"></a>February.</span>
<span id="cb75-682"><a href="#cb75-682"></a></span>
<span id="cb75-683"><a href="#cb75-683"></a>Months are also less useful because they contain different numbers of each day </span>
<span id="cb75-684"><a href="#cb75-684"></a>of the week (e.g. one month might have four Fridays while the next has five) and </span>
<span id="cb75-685"><a href="#cb75-685"></a>crimes are typically concentrated on particular days of the week (more on that </span>
<span id="cb75-686"><a href="#cb75-686"></a>later). **Avoid using monthly counts of crime** unless you have no choice </span>
<span id="cb75-687"><a href="#cb75-687"></a>because the only data you have available is monthly counts.</span>
<span id="cb75-688"><a href="#cb75-688"></a></span>
<span id="cb75-689"><a href="#cb75-689"></a>:::</span>
<span id="cb75-690"><a href="#cb75-690"></a></span>
<span id="cb75-691"><a href="#cb75-691"></a></span>
<span id="cb75-692"><a href="#cb75-692"></a>To count the number of crimes occurring each week we can use the <span class="in">`count()`</span></span>
<span id="cb75-693"><a href="#cb75-693"></a>function from the <span class="in">`dplyr`</span> package. But before doing that, we have to allocate</span>
<span id="cb75-694"><a href="#cb75-694"></a>each crime to a week so that we can then count those weeks rather than counting</span>
<span id="cb75-695"><a href="#cb75-695"></a>days. To do this we use the <span class="in">`floor_date()`</span> function from the <span class="in">`lubridate`</span> </span>
<span id="cb75-696"><a href="#cb75-696"></a>package. This function rounds dates down to the start of a specified unit of </span>
<span id="cb75-697"><a href="#cb75-697"></a>time, in this case a week. By default, <span class="in">`floor_date()`</span> treats Sunday as the start </span>
<span id="cb75-698"><a href="#cb75-698"></a>of the week and so if the specified unit of time is a week, all dates will be </span>
<span id="cb75-699"><a href="#cb75-699"></a>rounded down to the date of the previous Sunday.</span>
<span id="cb75-700"><a href="#cb75-700"></a></span>
<span id="cb75-701"><a href="#cb75-701"></a><span class="in">`floor_date()`</span> works on date variables, so if we want to use it on a date-time</span>
<span id="cb75-702"><a href="#cb75-702"></a>variable we should first convert it to a date variable using the <span class="in">`as_date()`</span></span>
<span id="cb75-703"><a href="#cb75-703"></a>function from <span class="in">`lubridate`</span>. So to convert a date-time stored in a variable called</span>
<span id="cb75-704"><a href="#cb75-704"></a><span class="in">`date`</span> into the date of the first day of that week, we would use the code</span>
<span id="cb75-705"><a href="#cb75-705"></a><span class="in">`floor_date(as_date(date), unit = "week")`</span>.</span>
<span id="cb75-706"><a href="#cb75-706"></a></span>
<span id="cb75-707"><a href="#cb75-707"></a>One complication of counting incidents by week is that our data might not fit</span>
<span id="cb75-708"><a href="#cb75-708"></a>neatly into calendar weeks. For example, if we have data for a particular year</span>
<span id="cb75-709"><a href="#cb75-709"></a>and that year started on a Tuesday, the first weekly count will only have data</span>
<span id="cb75-710"><a href="#cb75-710"></a>for five days and it will look like there were fewer crimes that week in </span>
<span id="cb75-711"><a href="#cb75-711"></a>comparison to other weeks. This could be misleading, since this week only looks</span>
<span id="cb75-712"><a href="#cb75-712"></a>like it has less crime because we don't have data for the whole week. The same </span>
<span id="cb75-713"><a href="#cb75-713"></a>problem can happen with the last week of data, too. To deal with this, after </span>
<span id="cb75-714"><a href="#cb75-714"></a>counting the crimes by week we will remove the first and last row of the data </span>
<span id="cb75-715"><a href="#cb75-715"></a>using the <span class="in">`slice()`</span> function from the <span class="in">`dplyr`</span> package.</span>
<span id="cb75-716"><a href="#cb75-716"></a></span>
<span id="cb75-717"><a href="#cb75-717"></a><span class="in">```{r change-exercise1, exercise=TRUE}</span></span>
<span id="cb75-718"><a href="#cb75-718"></a><span class="in">assault_weekly_counts &lt;- assaults |&gt; </span></span>
<span id="cb75-719"><a href="#cb75-719"></a><span class="in">  mutate(week_date = floor_date(as_date(date), unit = "week")) |&gt; </span></span>
<span id="cb75-720"><a href="#cb75-720"></a><span class="in">  count(week_date, name = "count") |&gt; </span></span>
<span id="cb75-721"><a href="#cb75-721"></a><span class="in">  # The code `(n() - 1)` gives us the row number of the second-to-last row in </span></span>
<span id="cb75-722"><a href="#cb75-722"></a><span class="in">  # the data because `n()` returns the number of rows in the data. Note the</span></span>
<span id="cb75-723"><a href="#cb75-723"></a><span class="in">  # parentheses!</span></span>
<span id="cb75-724"><a href="#cb75-724"></a><span class="in">  slice(2:(n() - 1))</span></span>
<span id="cb75-725"><a href="#cb75-725"></a></span>
<span id="cb75-726"><a href="#cb75-726"></a><span class="in">head(assault_weekly_counts)</span></span>
<span id="cb75-727"><a href="#cb75-727"></a><span class="in">```</span></span>
<span id="cb75-728"><a href="#cb75-728"></a></span>
<span id="cb75-729"><a href="#cb75-729"></a>Now we have weekly counts of aggravated assaults, we can plot them on a chart.</span>
<span id="cb75-730"><a href="#cb75-730"></a>The simplest way to do this would be to create a line chart using <span class="in">`ggplot()`</span></span>
<span id="cb75-731"><a href="#cb75-731"></a>with <span class="in">`geom_line()`</span>.</span>
<span id="cb75-732"><a href="#cb75-732"></a></span>
<span id="cb75-733"><a href="#cb75-733"></a><span class="in">```{r change-exercise2, exercise=TRUE}</span></span>
<span id="cb75-734"><a href="#cb75-734"></a><span class="in">ggplot(assault_weekly_counts, aes(x = week_date, y = count)) +</span></span>
<span id="cb75-735"><a href="#cb75-735"></a><span class="in">  geom_line() +</span></span>
<span id="cb75-736"><a href="#cb75-736"></a><span class="in">  theme_minimal()</span></span>
<span id="cb75-737"><a href="#cb75-737"></a><span class="in">```</span></span>
<span id="cb75-738"><a href="#cb75-738"></a></span>
<span id="cb75-739"><a href="#cb75-739"></a>This plot is fine, but there are several things that we can do to make it </span>
<span id="cb75-740"><a href="#cb75-740"></a>better. Most importantly, there seems to be lots of short-term fluctuation in </span>
<span id="cb75-741"><a href="#cb75-741"></a>the frequency of crime (e.g. from one week to another). While this variation is </span>
<span id="cb75-742"><a href="#cb75-742"></a>real, we often refer to it as *noise* because it can obscure the *signal* of</span>
<span id="cb75-743"><a href="#cb75-743"></a>longer-term trends (this terminology originally came to statistics -- and </span>
<span id="cb75-744"><a href="#cb75-744"></a>therefore crime analysis -- from radio engineering and has become common over </span>
<span id="cb75-745"><a href="#cb75-745"></a>time).</span>
<span id="cb75-746"><a href="#cb75-746"></a></span>
<span id="cb75-747"><a href="#cb75-747"></a>We can reduce the visual impact of this short-term variation on our plot by</span>
<span id="cb75-748"><a href="#cb75-748"></a>adding a line showing a *moving average* (also called a *rolling average* or</span>
<span id="cb75-749"><a href="#cb75-749"></a>*rolling mean*) of the count of crime over time. A moving average is the average</span>
<span id="cb75-750"><a href="#cb75-750"></a>(or mean) of the count of crimes in the current week and a given number of </span>
<span id="cb75-751"><a href="#cb75-751"></a>adjacent (in this case, previous), weeks.</span>
<span id="cb75-752"><a href="#cb75-752"></a></span>
<span id="cb75-753"><a href="#cb75-753"></a></span>
<span id="cb75-754"><a href="#cb75-754"></a><span class="in">```{r moving-averages-chart, eval=FALSE, echo=FALSE}</span></span>
<span id="cb75-755"><a href="#cb75-755"></a><span class="in">ma &lt;- tibble(</span></span>
<span id="cb75-756"><a href="#cb75-756"></a><span class="in">  period = rep(2:5, times = 4),</span></span>
<span id="cb75-757"><a href="#cb75-757"></a><span class="in">  week = rep(1:4, each = 4)</span></span>
<span id="cb75-758"><a href="#cb75-758"></a><span class="in">) %&gt;%</span></span>
<span id="cb75-759"><a href="#cb75-759"></a><span class="in">  mutate(period = period + (week  -1), included = TRUE) %&gt;%</span></span>
<span id="cb75-760"><a href="#cb75-760"></a><span class="in">  complete(period, week, fill = list(included = FALSE)) %&gt;%</span></span>
<span id="cb75-761"><a href="#cb75-761"></a><span class="in">  add_row(period = 1, week = 1:4, included = FALSE) %&gt;%</span></span>
<span id="cb75-762"><a href="#cb75-762"></a><span class="in">  add_row(period = 9, week = 1:4, included = FALSE) %&gt;%</span></span>
<span id="cb75-763"><a href="#cb75-763"></a><span class="in">  arrange(week, period) %&gt;%</span></span>
<span id="cb75-764"><a href="#cb75-764"></a><span class="in">  group_by(week) %&gt;%</span></span>
<span id="cb75-765"><a href="#cb75-765"></a><span class="in">  mutate(</span></span>
<span id="cb75-766"><a href="#cb75-766"></a><span class="in">    last = (lead(included) != included &amp; !is.na(lead(included)) &amp; included == TRUE) | (included == TRUE &amp; row_number() == n())</span></span>
<span id="cb75-767"><a href="#cb75-767"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb75-768"><a href="#cb75-768"></a><span class="in">  ungroup()</span></span>
<span id="cb75-769"><a href="#cb75-769"></a></span>
<span id="cb75-770"><a href="#cb75-770"></a><span class="in">ggplot(ma) +</span></span>
<span id="cb75-771"><a href="#cb75-771"></a><span class="in">  geom_point(aes(period, week, fill = included, size = last), shape = 21) +</span></span>
<span id="cb75-772"><a href="#cb75-772"></a><span class="in">  geom_line(aes(period, week, group = week), data = filter(ma, included), show.legend = FALSE) +</span></span>
<span id="cb75-773"><a href="#cb75-773"></a><span class="in">  annotate("curve", x = 7.55, y = 4.5, xend = 8, yend = 4.1, curvature = -0.35, arrow = arrow(length = unit(0.5, "lines"))) +</span></span>
<span id="cb75-774"><a href="#cb75-774"></a><span class="in">  annotate("text", x = 7.5, y = 4.5, hjust = 1, label = "week for which the moving\naverage is calculated", lineheight = 0.9) +</span></span>
<span id="cb75-775"><a href="#cb75-775"></a><span class="in">  annotate("curve", x = 6.05, y = 3.5, xend = 6.5, yend = 3.95, curvature = 0.35, arrow = arrow(length = unit(0.5, "lines"))) +</span></span>
<span id="cb75-776"><a href="#cb75-776"></a><span class="in">  annotate("text", x = 6, y = 3.5, hjust = 1, label = "the 'window' of weeks included\nin the moving average calculation", lineheight = 0.9) +</span></span>
<span id="cb75-777"><a href="#cb75-777"></a><span class="in">  scale_x_continuous(n.breaks = 10) +</span></span>
<span id="cb75-778"><a href="#cb75-778"></a><span class="in">  scale_y_continuous(minor_breaks = NULL, expand = c(0.05, 0.1)) +</span></span>
<span id="cb75-779"><a href="#cb75-779"></a><span class="in">  scale_fill_manual(</span></span>
<span id="cb75-780"><a href="#cb75-780"></a><span class="in">    values = c(`TRUE` = "black", `FALSE` = "white")</span></span>
<span id="cb75-781"><a href="#cb75-781"></a><span class="in">  ) +</span></span>
<span id="cb75-782"><a href="#cb75-782"></a><span class="in">  scale_size_manual(</span></span>
<span id="cb75-783"><a href="#cb75-783"></a><span class="in">    values = c(`TRUE` = 3, `FALSE` = 1)</span></span>
<span id="cb75-784"><a href="#cb75-784"></a><span class="in">  ) +</span></span>
<span id="cb75-785"><a href="#cb75-785"></a><span class="in">  labs(</span></span>
<span id="cb75-786"><a href="#cb75-786"></a><span class="in">    title = "How moving averages are calculated",</span></span>
<span id="cb75-787"><a href="#cb75-787"></a><span class="in">    x = "week"</span></span>
<span id="cb75-788"><a href="#cb75-788"></a><span class="in">  ) +</span></span>
<span id="cb75-789"><a href="#cb75-789"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb75-790"><a href="#cb75-790"></a><span class="in">  theme(</span></span>
<span id="cb75-791"><a href="#cb75-791"></a><span class="in">    axis.text.y = element_blank(),</span></span>
<span id="cb75-792"><a href="#cb75-792"></a><span class="in">    axis.title.y = element_blank(),</span></span>
<span id="cb75-793"><a href="#cb75-793"></a><span class="in">    legend.position = "none",</span></span>
<span id="cb75-794"><a href="#cb75-794"></a><span class="in">    legend.title = element_blank(),</span></span>
<span id="cb75-795"><a href="#cb75-795"></a><span class="in">    panel.grid.major.x = element_blank(),</span></span>
<span id="cb75-796"><a href="#cb75-796"></a><span class="in">    panel.grid.minor.x = element_blank(),</span></span>
<span id="cb75-797"><a href="#cb75-797"></a><span class="in">    plot.caption = element_text(colour = "grey40"),</span></span>
<span id="cb75-798"><a href="#cb75-798"></a><span class="in">    plot.caption.position = "plot",</span></span>
<span id="cb75-799"><a href="#cb75-799"></a><span class="in">    plot.title = element_text(</span></span>
<span id="cb75-800"><a href="#cb75-800"></a><span class="in">      colour = "grey50",</span></span>
<span id="cb75-801"><a href="#cb75-801"></a><span class="in">      face = "bold",</span></span>
<span id="cb75-802"><a href="#cb75-802"></a><span class="in">      size = 16,</span></span>
<span id="cb75-803"><a href="#cb75-803"></a><span class="in">      margin = margin(b = 9)</span></span>
<span id="cb75-804"><a href="#cb75-804"></a><span class="in">    ),</span></span>
<span id="cb75-805"><a href="#cb75-805"></a><span class="in">    plot.title.position = "plot"</span></span>
<span id="cb75-806"><a href="#cb75-806"></a><span class="in">  )</span></span>
<span id="cb75-807"><a href="#cb75-807"></a></span>
<span id="cb75-808"><a href="#cb75-808"></a><span class="in">ggsave(</span></span>
<span id="cb75-809"><a href="#cb75-809"></a><span class="in">  filename = here::here("inst/tutorials/16_mapping_time/images/moving_averages.png"),</span></span>
<span id="cb75-810"><a href="#cb75-810"></a><span class="in">  width = 1200 / 150,</span></span>
<span id="cb75-811"><a href="#cb75-811"></a><span class="in">  height = 500 / 150,</span></span>
<span id="cb75-812"><a href="#cb75-812"></a><span class="in">  dpi = 300</span></span>
<span id="cb75-813"><a href="#cb75-813"></a><span class="in">)</span></span>
<span id="cb75-814"><a href="#cb75-814"></a><span class="in">```</span></span>
<span id="cb75-815"><a href="#cb75-815"></a></span>
<span id="cb75-816"><a href="#cb75-816"></a></span>
<span id="cb75-817"><a href="#cb75-817"></a>&lt;p class="full-width-image"&gt;&lt;img src="images/moving_averages.png" alt="Chart showing that moving averages are calculated by averaging the current week's count with the counts from a given number of previous weeks."&gt;&lt;/p&gt;</span>
<span id="cb75-818"><a href="#cb75-818"></a></span>
<span id="cb75-819"><a href="#cb75-819"></a>Since moving averages show the average count of crime over several weeks, they </span>
<span id="cb75-820"><a href="#cb75-820"></a>are less influenced by week-to-week variation. To calculate a moving average we </span>
<span id="cb75-821"><a href="#cb75-821"></a>have to choose how many weeks to include (known as the *window* of the moving</span>
<span id="cb75-822"><a href="#cb75-822"></a>average). The more weeks we include in the window, the smoother the values will </span>
<span id="cb75-823"><a href="#cb75-823"></a>appear from week to week and the more short-term variation will be obscured. </span>
<span id="cb75-824"><a href="#cb75-824"></a>There is a balance to be struck between making longer-term trends clear and </span>
<span id="cb75-825"><a href="#cb75-825"></a>obscuring genuine short-term variation, so you should experiment with different </span>
<span id="cb75-826"><a href="#cb75-826"></a>window lengths to ensure you are not over-smoothing.</span>
<span id="cb75-827"><a href="#cb75-827"></a></span>
<span id="cb75-828"><a href="#cb75-828"></a>We can calculate moving averages in R with the <span class="in">`slide_dbl()`</span> function from the </span>
<span id="cb75-829"><a href="#cb75-829"></a><span class="co">[</span><span class="ot">`slider` package</span><span class="co">](https://davisvaughan.github.io/slider/)</span> (so called because </span>
<span id="cb75-830"><a href="#cb75-830"></a>its functions slide along a series of values). <span class="in">`slide_dbl()`</span> can calculate </span>
<span id="cb75-831"><a href="#cb75-831"></a>several types of moving averages, so we specify that it should use the <span class="in">`mean()`</span></span>
<span id="cb75-832"><a href="#cb75-832"></a>function to calculate the average by specifying <span class="in">`.f = mean`</span> (note the lack of</span>
<span id="cb75-833"><a href="#cb75-833"></a>parentheses after <span class="in">`mean`</span>). We use the <span class="in">`.before`</span> argument (note the <span class="in">`.`</span>) to </span>
<span id="cb75-834"><a href="#cb75-834"></a>specify how many weeks *before the current week* to include in our moving </span>
<span id="cb75-835"><a href="#cb75-835"></a>average. So if we wanted to calculate a four-week moving average (i.e. the </span>
<span id="cb75-836"><a href="#cb75-836"></a>current week and the previous three weeks), we would specify <span class="in">`.before = 3`</span>. </span>
<span id="cb75-837"><a href="#cb75-837"></a>We also specify <span class="in">`.complete = TRUE`</span> to stop <span class="in">`slide_dbl()`</span> from trying to </span>
<span id="cb75-838"><a href="#cb75-838"></a>calculate averages for the first few weeks in our data, because we don't have </span>
<span id="cb75-839"><a href="#cb75-839"></a>the necessary data from previous weeks (i.e. before the start of our data) that </span>
<span id="cb75-840"><a href="#cb75-840"></a>we would need to make these averages accurate. <span class="in">`slide_dbl()`</span> will use <span class="in">`NA`</span> as </span>
<span id="cb75-841"><a href="#cb75-841"></a>the moving average value for those weeks, so we later need to specify </span>
<span id="cb75-842"><a href="#cb75-842"></a><span class="in">`na.rm = TRUE`</span> to tell <span class="in">`ggplot()`</span> to ignore these when we plot the data.</span>
<span id="cb75-843"><a href="#cb75-843"></a></span>
<span id="cb75-844"><a href="#cb75-844"></a>Once we've calculated a moving average, we can show this using the line on our</span>
<span id="cb75-845"><a href="#cb75-845"></a>chart and show the individual weekly counts as small light-grey dots to show how </span>
<span id="cb75-846"><a href="#cb75-846"></a>much short-term variation there is in the data.</span>
<span id="cb75-847"><a href="#cb75-847"></a></span>
<span id="cb75-848"><a href="#cb75-848"></a><span class="in">```{r change-exercise3, exercise=TRUE, exercise.lines=27}</span></span>
<span id="cb75-849"><a href="#cb75-849"></a><span class="in">library(slider)</span></span>
<span id="cb75-850"><a href="#cb75-850"></a></span>
<span id="cb75-851"><a href="#cb75-851"></a><span class="in">assault_weekly_counts |&gt; </span></span>
<span id="cb75-852"><a href="#cb75-852"></a><span class="in">  mutate(moving_avg = slide_dbl(count, mean, .before = 3, .complete = TRUE)) |&gt; </span></span>
<span id="cb75-853"><a href="#cb75-853"></a><span class="in">  ggplot() +</span></span>
<span id="cb75-854"><a href="#cb75-854"></a><span class="in">  geom_point(aes(x = week_date, y = count), colour = "grey75", size = 0.75) +</span></span>
<span id="cb75-855"><a href="#cb75-855"></a><span class="in">  geom_line(</span></span>
<span id="cb75-856"><a href="#cb75-856"></a><span class="in">    aes(x = week_date, y = moving_avg, colour = "black"), </span></span>
<span id="cb75-857"><a href="#cb75-857"></a><span class="in">    na.rm = TRUE, </span></span>
<span id="cb75-858"><a href="#cb75-858"></a><span class="in">    key_glyph = "timeseries"</span></span>
<span id="cb75-859"><a href="#cb75-859"></a><span class="in">  ) +</span></span>
<span id="cb75-860"><a href="#cb75-860"></a><span class="in">  scale_x_date(date_breaks = "1 year", date_labels = "%b\n%Y") +</span></span>
<span id="cb75-861"><a href="#cb75-861"></a><span class="in">  scale_y_continuous(limits = c(0, NA)) +</span></span>
<span id="cb75-862"><a href="#cb75-862"></a><span class="in">  scale_colour_identity(</span></span>
<span id="cb75-863"><a href="#cb75-863"></a><span class="in">    labels = c("black" = "four-week moving average"),</span></span>
<span id="cb75-864"><a href="#cb75-864"></a><span class="in">    guide = guide_legend()</span></span>
<span id="cb75-865"><a href="#cb75-865"></a><span class="in">  ) +</span></span>
<span id="cb75-866"><a href="#cb75-866"></a><span class="in">  labs(</span></span>
<span id="cb75-867"><a href="#cb75-867"></a><span class="in">    x = NULL,</span></span>
<span id="cb75-868"><a href="#cb75-868"></a><span class="in">    y = "weekly count of aggravated assaults",</span></span>
<span id="cb75-869"><a href="#cb75-869"></a><span class="in">    colour = NULL</span></span>
<span id="cb75-870"><a href="#cb75-870"></a><span class="in">  ) +</span></span>
<span id="cb75-871"><a href="#cb75-871"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb75-872"><a href="#cb75-872"></a><span class="in">  theme(</span></span>
<span id="cb75-873"><a href="#cb75-873"></a><span class="in">    legend.position = "bottom",</span></span>
<span id="cb75-874"><a href="#cb75-874"></a><span class="in">    panel.grid.minor.x = element_blank()</span></span>
<span id="cb75-875"><a href="#cb75-875"></a><span class="in">  )</span></span>
<span id="cb75-876"><a href="#cb75-876"></a><span class="in">```</span></span>
<span id="cb75-877"><a href="#cb75-877"></a></span>
<span id="cb75-878"><a href="#cb75-878"></a>Experiment with the effect of setting a longer or shorter window for the moving</span>
<span id="cb75-879"><a href="#cb75-879"></a>average by specifying larger or smaller values of the <span class="in">`.before`</span> argument to</span>
<span id="cb75-880"><a href="#cb75-880"></a><span class="in">`slide_dbl()`</span>. For example, create an eight-week moving average by specifying</span>
<span id="cb75-881"><a href="#cb75-881"></a><span class="in">`.before = 7`</span>. What happens to the apparent seasonal variation in the number of</span>
<span id="cb75-882"><a href="#cb75-882"></a>assaults if you create an *annual moving average* by specifying <span class="in">`.before = 52`</span>?</span>
<span id="cb75-883"><a href="#cb75-883"></a></span>
<span id="cb75-884"><a href="#cb75-884"></a>You may have noticed that in this code we have also made some changes to the</span>
<span id="cb75-885"><a href="#cb75-885"></a>appearance of the plot to make it easier to read. Specifically, we have:</span>
<span id="cb75-886"><a href="#cb75-886"></a></span>
<span id="cb75-887"><a href="#cb75-887"></a><span class="ss">  * </span>Added a title for the *y* axis and removed the *x* axis and legend titles</span>
<span id="cb75-888"><a href="#cb75-888"></a>    using the <span class="in">`labs()`</span> function.</span>
<span id="cb75-889"><a href="#cb75-889"></a><span class="ss">  * </span>Changed the labels on the *x* axis using <span class="in">`scale_x_date()`</span>. In this case, we</span>
<span id="cb75-890"><a href="#cb75-890"></a>    have used the argument <span class="in">`date_breaks = "1 year"`</span> to specify that we want a</span>
<span id="cb75-891"><a href="#cb75-891"></a>    label at the start of each year and the argument <span class="in">`date_labels = "%b\n%Y"`</span> to</span>
<span id="cb75-892"><a href="#cb75-892"></a>    specify that we want each label to consist of an abbreviated month name </span>
<span id="cb75-893"><a href="#cb75-893"></a>    (using the code <span class="in">`%b`</span>), a new line (the code <span class="in">`\n`</span> as in a previous tutorial) </span>
<span id="cb75-894"><a href="#cb75-894"></a>    and a four-digit year (using the code <span class="in">`%Y`</span>). You can find a full list of </span>
<span id="cb75-895"><a href="#cb75-895"></a>    codes used that can be used to specify different parts of a date and time by </span>
<span id="cb75-896"><a href="#cb75-896"></a>    typing <span class="in">`?strptime`</span> in the R console.</span>
<span id="cb75-897"><a href="#cb75-897"></a><span class="ss">  * </span>Removed some of the vertical grid lines by setting the <span class="in">`panel.grid.minor.x`</span> </span>
<span id="cb75-898"><a href="#cb75-898"></a>    argument to <span class="in">`theme()`</span> to equal <span class="in">`element_blank()`</span>.</span>
<span id="cb75-899"><a href="#cb75-899"></a><span class="ss">  * </span>Forced the *y* axis to begin at zero by specifying <span class="in">`limits = c(0, NA)`</span>,</span>
<span id="cb75-900"><a href="#cb75-900"></a>    remembering that <span class="in">`NA`</span> in this context means to use the default value.</span>
<span id="cb75-901"><a href="#cb75-901"></a><span class="ss">  * </span>Specified that we want the black line to be represented in the legend by a</span>
<span id="cb75-902"><a href="#cb75-902"></a>    line that looks like a time series by specifying <span class="in">`key_glyph = "timeseries"`</span>.</span>
<span id="cb75-903"><a href="#cb75-903"></a>    </span>
<span id="cb75-904"><a href="#cb75-904"></a>We have also added a legend to explain what the black line shows. The code</span>
<span id="cb75-905"><a href="#cb75-905"></a>need to do this is slightly awkward, since <span class="in">`ggplot()`</span> would not normally produce</span>
<span id="cb75-906"><a href="#cb75-906"></a>a legend for aesthetics (in this case, the colour of the line) that have only </span>
<span id="cb75-907"><a href="#cb75-907"></a>one value. To force <span class="in">`ggplot()`</span> to add a legend, we:</span>
<span id="cb75-908"><a href="#cb75-908"></a></span>
<span id="cb75-909"><a href="#cb75-909"></a><span class="ss">  1. </span>Specify the colour of the line (i.e. <span class="in">`colour = "black"`</span>) not as an argument </span>
<span id="cb75-910"><a href="#cb75-910"></a>     to the function <span class="in">`geom_line()`</span> as we normally would but as one of the </span>
<span id="cb75-911"><a href="#cb75-911"></a>     aesthetics specified using <span class="in">`aes()`</span>. </span>
<span id="cb75-912"><a href="#cb75-912"></a><span class="ss">  2. </span>Specify that <span class="in">`ggplot()`</span> should treat the value <span class="in">`colour = "black"`</span> as a </span>
<span id="cb75-913"><a href="#cb75-913"></a>     literal colour name rather than as a reference to a column in the data</span>
<span id="cb75-914"><a href="#cb75-914"></a>     (which is how the arguments to <span class="in">`aes()`</span> are normally interpreted). To do </span>
<span id="cb75-915"><a href="#cb75-915"></a>     this we add <span class="in">`scale_colour_identity()`</span> to the <span class="in">`ggplot()`</span> stack, because </span>
<span id="cb75-916"><a href="#cb75-916"></a>     *identity* is the jargon used in R to say 'keep this value exactly as it </span>
<span id="cb75-917"><a href="#cb75-917"></a>     is'. </span>
<span id="cb75-918"><a href="#cb75-918"></a><span class="ss">  3. </span>Within <span class="in">`scale_colour_identity()`</span>, specify a label to correspond to </span>
<span id="cb75-919"><a href="#cb75-919"></a>     the black line by setting the <span class="in">`labels`</span> argument. </span>
<span id="cb75-920"><a href="#cb75-920"></a><span class="ss">  4. </span>Specify <span class="in">`guide = guide_legend()`</span> to tell <span class="in">`ggplot()`</span> to add a legend</span>
<span id="cb75-921"><a href="#cb75-921"></a>     corresponding to the black line because aesthetics styled using functions</span>
<span id="cb75-922"><a href="#cb75-922"></a>     in the <span class="in">`scale_*_identity()`</span> family do not produce a legend entry by </span>
<span id="cb75-923"><a href="#cb75-923"></a>     default.</span>
<span id="cb75-924"><a href="#cb75-924"></a></span>
<span id="cb75-925"><a href="#cb75-925"></a>Doing all this is obviously tedious, but makes for a better chart.</span>
<span id="cb75-926"><a href="#cb75-926"></a></span>
<span id="cb75-927"><a href="#cb75-927"></a></span>
<span id="cb75-928"><a href="#cb75-928"></a><span class="fu">### Showing repeating patterns over time</span></span>
<span id="cb75-929"><a href="#cb75-929"></a></span>
<span id="cb75-930"><a href="#cb75-930"></a>We have already seen that there is seasonal variation in the number of </span>
<span id="cb75-931"><a href="#cb75-931"></a>aggravated assaults in Chicago. As is very common for assaults, there are more</span>
<span id="cb75-932"><a href="#cb75-932"></a>offences in the summer and fewer in the winter. We can see this in the </span>
<span id="cb75-933"><a href="#cb75-933"></a>time-series chart we have already produced, but it's hard to see the detail. For</span>
<span id="cb75-934"><a href="#cb75-934"></a>example, we might want to know how consistent this seasonal variation is across</span>
<span id="cb75-935"><a href="#cb75-935"></a>different years. Is it, for example, consistent enough that the local police</span>
<span id="cb75-936"><a href="#cb75-936"></a>might want to restrict the number of officers who can take holidays in certain</span>
<span id="cb75-937"><a href="#cb75-937"></a>weeks of the year to maximise the number of officers available when crime is</span>
<span id="cb75-938"><a href="#cb75-938"></a>likely to be highest?</span>
<span id="cb75-939"><a href="#cb75-939"></a></span>
<span id="cb75-940"><a href="#cb75-940"></a>To do this we can create a *seasonal chart*. This can be used to show any type</span>
<span id="cb75-941"><a href="#cb75-941"></a>of repeating variation, but is often used to show patterns across a year (hence</span>
<span id="cb75-942"><a href="#cb75-942"></a>the name). To create a seasonal plot we need to add a variable to our data </span>
<span id="cb75-943"><a href="#cb75-943"></a>specifying which year each weekly count belongs to, which we can do by using the</span>
<span id="cb75-944"><a href="#cb75-944"></a><span class="in">`year()`</span> function to extract the year from the offence dates. We can do this at </span>
<span id="cb75-945"><a href="#cb75-945"></a>the same time as we calculate the moving averages. Once we've done that, we can </span>
<span id="cb75-946"><a href="#cb75-946"></a>specify that we want our chart to have a separate line for each year by setting</span>
<span id="cb75-947"><a href="#cb75-947"></a><span class="in">`group = year`</span> inside the <span class="in">`aes()`</span> function that controls how the data are shown</span>
<span id="cb75-948"><a href="#cb75-948"></a>on the chart, making each year a different colour using <span class="in">`colour = year`</span>.</span>
<span id="cb75-949"><a href="#cb75-949"></a></span>
<span id="cb75-950"><a href="#cb75-950"></a><span class="in">```{r change-exercise4, exercise=TRUE, exercise.lines=20}</span></span>
<span id="cb75-951"><a href="#cb75-951"></a><span class="in">assault_weekly_counts |&gt; </span></span>
<span id="cb75-952"><a href="#cb75-952"></a><span class="in">  mutate(</span></span>
<span id="cb75-953"><a href="#cb75-953"></a><span class="in">    moving_avg = slide_dbl(count, mean, .before = 3, .complete = TRUE),</span></span>
<span id="cb75-954"><a href="#cb75-954"></a><span class="in">    year = year(week_date)</span></span>
<span id="cb75-955"><a href="#cb75-955"></a><span class="in">  ) |&gt; </span></span>
<span id="cb75-956"><a href="#cb75-956"></a><span class="in">  ggplot(aes(x = week_date, y = moving_avg, colour = year, group = year)) +</span></span>
<span id="cb75-957"><a href="#cb75-957"></a><span class="in">  geom_line(na.rm = TRUE, key_glyph = "timeseries") +</span></span>
<span id="cb75-958"><a href="#cb75-958"></a><span class="in">  scale_x_date(date_breaks = "1 year", date_labels = "%b\n%Y") +</span></span>
<span id="cb75-959"><a href="#cb75-959"></a><span class="in">  scale_y_continuous(limits = c(0, NA)) +</span></span>
<span id="cb75-960"><a href="#cb75-960"></a><span class="in">  scale_colour_continuous(breaks = c(2010, 2019)) +</span></span>
<span id="cb75-961"><a href="#cb75-961"></a><span class="in">  labs(</span></span>
<span id="cb75-962"><a href="#cb75-962"></a><span class="in">    x = NULL,</span></span>
<span id="cb75-963"><a href="#cb75-963"></a><span class="in">    y = "weekly count of aggravated assaults",</span></span>
<span id="cb75-964"><a href="#cb75-964"></a><span class="in">    colour = NULL</span></span>
<span id="cb75-965"><a href="#cb75-965"></a><span class="in">  ) +</span></span>
<span id="cb75-966"><a href="#cb75-966"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb75-967"><a href="#cb75-967"></a><span class="in">  theme(</span></span>
<span id="cb75-968"><a href="#cb75-968"></a><span class="in">    panel.grid.minor.x = element_blank()</span></span>
<span id="cb75-969"><a href="#cb75-969"></a><span class="in">  )</span></span>
<span id="cb75-970"><a href="#cb75-970"></a><span class="in">```</span></span>
<span id="cb75-971"><a href="#cb75-971"></a></span>
<span id="cb75-972"><a href="#cb75-972"></a>The result might not be what you expected. Although the grouping of the lines by</span>
<span id="cb75-973"><a href="#cb75-973"></a>year has worked (there is a break between the lines at the start of each year),</span>
<span id="cb75-974"><a href="#cb75-974"></a>it's no easier to compare the seasonal patterns across years. Comparing years </span>
<span id="cb75-975"><a href="#cb75-975"></a>would be much easier if we superimpose the weekly counts for each year on top of </span>
<span id="cb75-976"><a href="#cb75-976"></a>one another.</span>
<span id="cb75-977"><a href="#cb75-977"></a></span>
<span id="cb75-978"><a href="#cb75-978"></a>To do this, we need to trick <span class="in">`ggplot()`</span> into plotting all the weekly counts as</span>
<span id="cb75-979"><a href="#cb75-979"></a>if they occurred in a single year, so the counts appear in the same locations on</span>
<span id="cb75-980"><a href="#cb75-980"></a>the horizontal axis of the chart, whichever year they occurred in. We can do </span>
<span id="cb75-981"><a href="#cb75-981"></a>this by creating a pseudo-date value for each weekly count which has the same</span>
<span id="cb75-982"><a href="#cb75-982"></a>month and day of the month as the original date, but a single year across all </span>
<span id="cb75-983"><a href="#cb75-983"></a>the rows in the data. We will create this pseudo date by extracting the month</span>
<span id="cb75-984"><a href="#cb75-984"></a>and day of the month using <span class="in">`month()`</span> and <span class="in">`mday()`</span>, then creating a new date with</span>
<span id="cb75-985"><a href="#cb75-985"></a><span class="in">`make_date()`</span>. We will also change the labels on the horizontal axis using the </span>
<span id="cb75-986"><a href="#cb75-986"></a>date-formatting code <span class="in">`%e\n%b`</span> -- <span class="in">`%e`</span> means the day of the month and <span class="in">`%b`</span> means </span>
<span id="cb75-987"><a href="#cb75-987"></a>the abbreviated name of the month.</span>
<span id="cb75-988"><a href="#cb75-988"></a></span>
<span id="cb75-989"><a href="#cb75-989"></a><span class="in">```{r change-exercise5, exercise=TRUE, exercise.lines=24}</span></span>
<span id="cb75-990"><a href="#cb75-990"></a><span class="in">assault_weekly_counts |&gt; </span></span>
<span id="cb75-991"><a href="#cb75-991"></a><span class="in">  mutate(</span></span>
<span id="cb75-992"><a href="#cb75-992"></a><span class="in">    moving_avg = slide_dbl(count, mean, .before = 3, .complete = TRUE),</span></span>
<span id="cb75-993"><a href="#cb75-993"></a><span class="in">    year = year(week_date),</span></span>
<span id="cb75-994"><a href="#cb75-994"></a><span class="in">    # By only specifying the `month` and `day` arguments to `make_date()` we</span></span>
<span id="cb75-995"><a href="#cb75-995"></a><span class="in">    # will create a date in 1970 (the year that R uses by default), but that </span></span>
<span id="cb75-996"><a href="#cb75-996"></a><span class="in">    # doesn't matter because we are not going to show the year on the chart</span></span>
<span id="cb75-997"><a href="#cb75-997"></a><span class="in">    pseudo_date = make_date(month = month(week_date), day = mday(week_date))</span></span>
<span id="cb75-998"><a href="#cb75-998"></a><span class="in">  ) |&gt; </span></span>
<span id="cb75-999"><a href="#cb75-999"></a><span class="in">  ggplot(aes(x = pseudo_date, y = moving_avg, colour = year, group = year)) +</span></span>
<span id="cb75-1000"><a href="#cb75-1000"></a><span class="in">  geom_line(na.rm = TRUE, key_glyph = "timeseries") +</span></span>
<span id="cb75-1001"><a href="#cb75-1001"></a><span class="in">  scale_x_date(date_breaks = "1 month", date_labels = "%e\n%b") +</span></span>
<span id="cb75-1002"><a href="#cb75-1002"></a><span class="in">  scale_y_continuous(limits = c(0, NA)) +</span></span>
<span id="cb75-1003"><a href="#cb75-1003"></a><span class="in">  scale_colour_continuous(breaks = c(2010, 2019)) +</span></span>
<span id="cb75-1004"><a href="#cb75-1004"></a><span class="in">  labs(</span></span>
<span id="cb75-1005"><a href="#cb75-1005"></a><span class="in">    x = NULL,</span></span>
<span id="cb75-1006"><a href="#cb75-1006"></a><span class="in">    y = "weekly count of aggravated assaults",</span></span>
<span id="cb75-1007"><a href="#cb75-1007"></a><span class="in">    colour = NULL</span></span>
<span id="cb75-1008"><a href="#cb75-1008"></a><span class="in">  ) +</span></span>
<span id="cb75-1009"><a href="#cb75-1009"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb75-1010"><a href="#cb75-1010"></a><span class="in">  theme(</span></span>
<span id="cb75-1011"><a href="#cb75-1011"></a><span class="in">    panel.grid.minor.x = element_blank()</span></span>
<span id="cb75-1012"><a href="#cb75-1012"></a><span class="in">  )</span></span>
<span id="cb75-1013"><a href="#cb75-1013"></a><span class="in">```</span></span>
<span id="cb75-1014"><a href="#cb75-1014"></a></span>
<span id="cb75-1015"><a href="#cb75-1015"></a>From this chart we can see that assaults consistently peak in July, although in</span>
<span id="cb75-1016"><a href="#cb75-1016"></a>one year they peaked slightly earlier in late June and in one year slightly </span>
<span id="cb75-1017"><a href="#cb75-1017"></a>later in August. At the other end of the year, weekly counts of assaults are </span>
<span id="cb75-1018"><a href="#cb75-1018"></a>almost always least frequent in late January and throughout February before</span>
<span id="cb75-1019"><a href="#cb75-1019"></a>starting to increase quite rapidly in March.</span>
<span id="cb75-1020"><a href="#cb75-1020"></a></span>
<span id="cb75-1021"><a href="#cb75-1021"></a>As well as showing seasonal variation, we can use the same technique to </span>
<span id="cb75-1022"><a href="#cb75-1022"></a>understand variation over other periods of time. For example, since we know a</span>
<span id="cb75-1023"><a href="#cb75-1023"></a>lot of human activities follow weekly patterns, we might want to produce a chart</span>
<span id="cb75-1024"><a href="#cb75-1024"></a>showing the number of crimes in each hour on each day of the week.</span>
<span id="cb75-1025"><a href="#cb75-1025"></a></span>
<span id="cb75-1026"><a href="#cb75-1026"></a>To do this, we:</span>
<span id="cb75-1027"><a href="#cb75-1027"></a></span>
<span id="cb75-1028"><a href="#cb75-1028"></a><span class="ss">  1. </span>Extract the weekday and hour components of each date using <span class="in">`wday()`</span> and</span>
<span id="cb75-1029"><a href="#cb75-1029"></a>     <span class="in">`hour()`</span>.</span>
<span id="cb75-1030"><a href="#cb75-1030"></a><span class="ss">  2. </span>Count the total number of crimes occurring in each hour of each day *across </span>
<span id="cb75-1031"><a href="#cb75-1031"></a>     all ten years of the data* using <span class="in">`count()`</span>.</span>
<span id="cb75-1032"><a href="#cb75-1032"></a><span class="ss">  3. </span>Create a pseudo-date-time using <span class="in">`make_datetime()`</span>.</span>
<span id="cb75-1033"><a href="#cb75-1033"></a><span class="ss">  4. </span>Create a chart with appropriate labels on the horizontal axis and a </span>
<span id="cb75-1034"><a href="#cb75-1034"></a>     suitable qualitative colour scheme to show the days of the week using </span>
<span id="cb75-1035"><a href="#cb75-1035"></a>     <span class="in">`scale_colour_brewer()`</span>.</span>
<span id="cb75-1036"><a href="#cb75-1036"></a></span>
<span id="cb75-1037"><a href="#cb75-1037"></a>We can do this in a single piece of code.     </span>
<span id="cb75-1038"><a href="#cb75-1038"></a></span>
<span id="cb75-1039"><a href="#cb75-1039"></a><span class="in">```{r change-exercise6, exercise=TRUE, exercise.lines=23}</span></span>
<span id="cb75-1040"><a href="#cb75-1040"></a><span class="in">assault_hourly_counts &lt;- assaults |&gt; </span></span>
<span id="cb75-1041"><a href="#cb75-1041"></a><span class="in">  mutate(wday = wday(date, label = TRUE), hour = hour(date)) |&gt; </span></span>
<span id="cb75-1042"><a href="#cb75-1042"></a><span class="in">  count(wday, hour, name = "count") |&gt; </span></span>
<span id="cb75-1043"><a href="#cb75-1043"></a><span class="in">  # By only setting the `hour` argument to `make_datetime()` we will create a</span></span>
<span id="cb75-1044"><a href="#cb75-1044"></a><span class="in">  # date-time on 1 January 1970, but that doesn't matter because we will not </span></span>
<span id="cb75-1045"><a href="#cb75-1045"></a><span class="in">  # show the date on the chart</span></span>
<span id="cb75-1046"><a href="#cb75-1046"></a><span class="in">  mutate(pseudo_date = make_datetime(hour = hour))</span></span>
<span id="cb75-1047"><a href="#cb75-1047"></a></span>
<span id="cb75-1048"><a href="#cb75-1048"></a><span class="in">ggplot(</span></span>
<span id="cb75-1049"><a href="#cb75-1049"></a><span class="in">  assault_hourly_counts, </span></span>
<span id="cb75-1050"><a href="#cb75-1050"></a><span class="in">  aes(x = pseudo_date, y = count, colour = wday, group = wday)</span></span>
<span id="cb75-1051"><a href="#cb75-1051"></a><span class="in">) +</span></span>
<span id="cb75-1052"><a href="#cb75-1052"></a><span class="in">  geom_line(key_glyph = "timeseries") +</span></span>
<span id="cb75-1053"><a href="#cb75-1053"></a><span class="in">  scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M") +</span></span>
<span id="cb75-1054"><a href="#cb75-1054"></a><span class="in">  scale_y_continuous(limits = c(0, NA), labels = scales::comma_format()) +</span></span>
<span id="cb75-1055"><a href="#cb75-1055"></a><span class="in">  scale_colour_brewer(type = "qual") +</span></span>
<span id="cb75-1056"><a href="#cb75-1056"></a><span class="in">  labs(</span></span>
<span id="cb75-1057"><a href="#cb75-1057"></a><span class="in">    x = NULL,</span></span>
<span id="cb75-1058"><a href="#cb75-1058"></a><span class="in">    y = "hourly total of aggravated assaults, 2010-2019",</span></span>
<span id="cb75-1059"><a href="#cb75-1059"></a><span class="in">    colour = NULL</span></span>
<span id="cb75-1060"><a href="#cb75-1060"></a><span class="in">  ) +</span></span>
<span id="cb75-1061"><a href="#cb75-1061"></a><span class="in">  theme_minimal()</span></span>
<span id="cb75-1062"><a href="#cb75-1062"></a><span class="in">```</span></span>
<span id="cb75-1063"><a href="#cb75-1063"></a></span>
<span id="cb75-1064"><a href="#cb75-1064"></a>On this chart you can see that there are two distinct temporal patterns of</span>
<span id="cb75-1065"><a href="#cb75-1065"></a>assaults on different days of the week. Between Mondays and Thursdays, assaults</span>
<span id="cb75-1066"><a href="#cb75-1066"></a>peak between about 14:00 and 21:00 before reducing to a very-low level at about</span>
<span id="cb75-1067"><a href="#cb75-1067"></a>05:00. At the weekend, the picture is different: assaults peak between midnight</span>
<span id="cb75-1068"><a href="#cb75-1068"></a>and 02:00 on both Saturdays and Sundays (i.e. very late on Friday and Saturday</span>
<span id="cb75-1069"><a href="#cb75-1069"></a>evenings).</span>
<span id="cb75-1070"><a href="#cb75-1070"></a></span>
<span id="cb75-1071"><a href="#cb75-1071"></a>This chart probably uses the maximum number of different colours for days of the</span>
<span id="cb75-1072"><a href="#cb75-1072"></a>week that we could use before some of the colours became too similar to one</span>
<span id="cb75-1073"><a href="#cb75-1073"></a>another to be distinguishable. But even with this many colours, it might not be</span>
<span id="cb75-1074"><a href="#cb75-1074"></a>easy for a colour-blind person to translate between the colours of the lines and</span>
<span id="cb75-1075"><a href="#cb75-1075"></a>the colours in the legend. When you find that there are too many colours on a </span>
<span id="cb75-1076"><a href="#cb75-1076"></a>chart, this is a good sign that you should consider using small-multiple charts</span>
<span id="cb75-1077"><a href="#cb75-1077"></a>instead. Fortunately, we can do this by adding a column to the data specifying</span>
<span id="cb75-1078"><a href="#cb75-1078"></a>whether each day is a weekday or on a weekend, then adding <span class="in">`facet_grid()`</span> to our</span>
<span id="cb75-1079"><a href="#cb75-1079"></a><span class="in">`ggplot()`</span> stack. </span>
<span id="cb75-1080"><a href="#cb75-1080"></a></span>
<span id="cb75-1081"><a href="#cb75-1081"></a><span class="in">```{r change-exercise7, exercise=TRUE, exercise.lines=19, fig.asp=1}</span></span>
<span id="cb75-1082"><a href="#cb75-1082"></a><span class="in">assault_hourly_counts |&gt; </span></span>
<span id="cb75-1083"><a href="#cb75-1083"></a><span class="in">  mutate(weekend = if_else(wday %in% c("Sat", "Sun"), "Sat–Sun", "Mon–Fri")) |&gt; </span></span>
<span id="cb75-1084"><a href="#cb75-1084"></a><span class="in">  ggplot(aes(x = pseudo_date, y = count, colour = wday)) +</span></span>
<span id="cb75-1085"><a href="#cb75-1085"></a><span class="in">  geom_line(linewidth = 1) +</span></span>
<span id="cb75-1086"><a href="#cb75-1086"></a><span class="in">  # Assign the facets to rows so that we can compare the same time on different</span></span>
<span id="cb75-1087"><a href="#cb75-1087"></a><span class="in">  # days more easily (change `rows` to `cols` to see the alternative)</span></span>
<span id="cb75-1088"><a href="#cb75-1088"></a><span class="in">  facet_grid(rows = vars(weekend)) +</span></span>
<span id="cb75-1089"><a href="#cb75-1089"></a><span class="in">  scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M") +</span></span>
<span id="cb75-1090"><a href="#cb75-1090"></a><span class="in">  scale_y_continuous(limits = c(0, NA), labels = scales::comma_format()) +</span></span>
<span id="cb75-1091"><a href="#cb75-1091"></a><span class="in">  scale_fill_brewer(type = "qual") +</span></span>
<span id="cb75-1092"><a href="#cb75-1092"></a><span class="in">  labs(</span></span>
<span id="cb75-1093"><a href="#cb75-1093"></a><span class="in">    x = NULL,</span></span>
<span id="cb75-1094"><a href="#cb75-1094"></a><span class="in">    y = "hourly total of aggravated assaults, 2010-2019",</span></span>
<span id="cb75-1095"><a href="#cb75-1095"></a><span class="in">    fill = NULL</span></span>
<span id="cb75-1096"><a href="#cb75-1096"></a><span class="in">  ) +</span></span>
<span id="cb75-1097"><a href="#cb75-1097"></a><span class="in">  theme_minimal()</span></span>
<span id="cb75-1098"><a href="#cb75-1098"></a><span class="in">```</span></span>
<span id="cb75-1099"><a href="#cb75-1099"></a></span>
<span id="cb75-1100"><a href="#cb75-1100"></a>This shows the two distinct patterns (weekdays and weekends) more clearly, while</span>
<span id="cb75-1101"><a href="#cb75-1101"></a>also letting us see that Friday is not like other weekdays since the peak in</span>
<span id="cb75-1102"><a href="#cb75-1102"></a>assaults continues later in the evening. Now that we've created this chart using</span>
<span id="cb75-1103"><a href="#cb75-1103"></a><span class="in">`facet_grid()`</span>, we could also add columns to show the same patterns in </span>
<span id="cb75-1104"><a href="#cb75-1104"></a>different areas, such as police districts or local neighbourhoods, or during</span>
<span id="cb75-1105"><a href="#cb75-1105"></a>different seasons.</span>
<span id="cb75-1106"><a href="#cb75-1106"></a></span>
<span id="cb75-1107"><a href="#cb75-1107"></a></span>
<span id="cb75-1108"><a href="#cb75-1108"></a></span>
<span id="cb75-1109"><a href="#cb75-1109"></a><span class="fu">## How to map change over time</span></span>
<span id="cb75-1110"><a href="#cb75-1110"></a></span>
<span id="cb75-1111"><a href="#cb75-1111"></a>Time-series or seasonal charts are often the best way to show change in the </span>
<span id="cb75-1112"><a href="#cb75-1112"></a>frequency of crime over time. But it can also be useful to show maps of the</span>
<span id="cb75-1113"><a href="#cb75-1113"></a>patterns of crimes at different points in time. We might, for example, want to </span>
<span id="cb75-1114"><a href="#cb75-1114"></a>show the density of crime in an area for different periods in time.</span>
<span id="cb75-1115"><a href="#cb75-1115"></a></span>
<span id="cb75-1116"><a href="#cb75-1116"></a>Choosing how to divide up time into periods is an important step in this </span>
<span id="cb75-1117"><a href="#cb75-1117"></a>process, because in doing so we are converting a continuous variable (time) into</span>
<span id="cb75-1118"><a href="#cb75-1118"></a>a number of categories (periods of time). Whenever we convert an continuous</span>
<span id="cb75-1119"><a href="#cb75-1119"></a>variable to a categorical one we inevitably lose information. For example, if we</span>
<span id="cb75-1120"><a href="#cb75-1120"></a>decided to categorise the maximum temperature every day as being either 'hot' or </span>
<span id="cb75-1121"><a href="#cb75-1121"></a>'cold', we would lose a lot of information about whether a particular day was</span>
<span id="cb75-1122"><a href="#cb75-1122"></a>moderately hot, very hot, etc. The same is true of time, since by splitting time</span>
<span id="cb75-1123"><a href="#cb75-1123"></a>into periods (hours, days, weeks, etc.) we lose information about variations</span>
<span id="cb75-1124"><a href="#cb75-1124"></a>within each period. This is inevitable, since we can't produce infinite maps </span>
<span id="cb75-1125"><a href="#cb75-1125"></a>showing all the infinite moments in time, but it's the reason why choosing </span>
<span id="cb75-1126"><a href="#cb75-1126"></a>periods carefully is important.</span>
<span id="cb75-1127"><a href="#cb75-1127"></a></span>
<span id="cb75-1128"><a href="#cb75-1128"></a>When choosing a period over which to count crime, it is important not to just </span>
<span id="cb75-1129"><a href="#cb75-1129"></a>use default periods like the day from 00:00 to 23:59 just because that is the</span>
<span id="cb75-1130"><a href="#cb75-1130"></a>standard definition of a day. As we saw in the previous section, the peaks of</span>
<span id="cb75-1131"><a href="#cb75-1131"></a>many types of crime like assaults cross over the boundaries between days because</span>
<span id="cb75-1132"><a href="#cb75-1132"></a>the peak frequency is late in the evening. For this reason it may be better to, </span>
<span id="cb75-1133"><a href="#cb75-1133"></a>for example, define a day as a period from 05:00 to 04:59 and count the number </span>
<span id="cb75-1134"><a href="#cb75-1134"></a>of crimes within each day according to that definition. This takes advantage of</span>
<span id="cb75-1135"><a href="#cb75-1135"></a>the fact that very few crimes concentrate in the early hours of the morning.</span>
<span id="cb75-1136"><a href="#cb75-1136"></a></span>
<span id="cb75-1137"><a href="#cb75-1137"></a>Sometimes, it will be easy to choose periods because they will be dictated by</span>
<span id="cb75-1138"><a href="#cb75-1138"></a>the purpose for which you're creating the map. In this section we will create</span>
<span id="cb75-1139"><a href="#cb75-1139"></a>separate maps showing the density of aggravated assaults in a part of Chicago </span>
<span id="cb75-1140"><a href="#cb75-1140"></a>for each of the standard Chicago Police shifts of 06:00 to 13:59, 14:00 to 21:59 </span>
<span id="cb75-1141"><a href="#cb75-1141"></a>and 22:00 to 05:59 (bearing in mind that the actual hours some officers work may </span>
<span id="cb75-1142"><a href="#cb75-1142"></a>differ slightly).</span>
<span id="cb75-1143"><a href="#cb75-1143"></a></span>
<span id="cb75-1144"><a href="#cb75-1144"></a>To do this, we will estimate the density of assaults separately for each shift</span>
<span id="cb75-1145"><a href="#cb75-1145"></a>period, the combine the three density layers and plot them on small-multiple</span>
<span id="cb75-1146"><a href="#cb75-1146"></a>maps. First, we create a new object containing data for the Chicago Police</span>
<span id="cb75-1147"><a href="#cb75-1147"></a>districts we are interested in with a column showing which police shift each</span>
<span id="cb75-1148"><a href="#cb75-1148"></a>assault occurred in. </span>
<span id="cb75-1149"><a href="#cb75-1149"></a></span>
<span id="cb75-1150"><a href="#cb75-1150"></a>We can construct this column using the <span class="in">`case_when()`</span> function from <span class="in">`dplyr`</span>.</span>
<span id="cb75-1151"><a href="#cb75-1151"></a><span class="in">`case_when()`</span> allows us to specify any number of tests that we can apply to our</span>
<span id="cb75-1152"><a href="#cb75-1152"></a>data -- when a test is passed the function assigns the corresponding label to</span>
<span id="cb75-1153"><a href="#cb75-1153"></a>that row (the label is separated from the test by a tilde character <span class="in">`~`</span>).</span>
<span id="cb75-1154"><a href="#cb75-1154"></a><span class="in">`case_when()`</span> is like <span class="in">`recode()`</span>, but for when we need to test for</span>
<span id="cb75-1155"><a href="#cb75-1155"></a>more-complicated things than just whether a variable has a particular value. </span>
<span id="cb75-1156"><a href="#cb75-1156"></a></span>
<span id="cb75-1157"><a href="#cb75-1157"></a><span class="in">```{r map-exercise1, exercise=TRUE}</span></span>
<span id="cb75-1158"><a href="#cb75-1158"></a><span class="in">assaults_by_shift &lt;- assaults |&gt; </span></span>
<span id="cb75-1159"><a href="#cb75-1159"></a><span class="in">  filter(district %in% c(1, 12, 18)) |&gt; </span></span>
<span id="cb75-1160"><a href="#cb75-1160"></a><span class="in">  mutate(</span></span>
<span id="cb75-1161"><a href="#cb75-1161"></a><span class="in">    shift = case_when(</span></span>
<span id="cb75-1162"><a href="#cb75-1162"></a><span class="in">      between(hour(date), 6, 13) ~ "06:00 to 13:59",</span></span>
<span id="cb75-1163"><a href="#cb75-1163"></a><span class="in">      between(hour(date), 14, 21) ~ "14:00 to 21:59",</span></span>
<span id="cb75-1164"><a href="#cb75-1164"></a><span class="in">      hour(date) &gt;= 22 | hour(date) &lt; 6 ~ "22:00 to 05:59",</span></span>
<span id="cb75-1165"><a href="#cb75-1165"></a><span class="in">      TRUE ~ NA_character_</span></span>
<span id="cb75-1166"><a href="#cb75-1166"></a><span class="in">    )</span></span>
<span id="cb75-1167"><a href="#cb75-1167"></a><span class="in">  )|&gt; </span></span>
<span id="cb75-1168"><a href="#cb75-1168"></a><span class="in">  # Convert the data to an SF object</span></span>
<span id="cb75-1169"><a href="#cb75-1169"></a><span class="in">  st_as_sf(coords = c("longitude", "latitude"), crs = "EPSG:4326") |&gt; </span></span>
<span id="cb75-1170"><a href="#cb75-1170"></a><span class="in">  # Transform it to a co-ordinate reference system based on metres</span></span>
<span id="cb75-1171"><a href="#cb75-1171"></a><span class="in">  st_transform("EPSG:26916")</span></span>
<span id="cb75-1172"><a href="#cb75-1172"></a></span>
<span id="cb75-1173"><a href="#cb75-1173"></a><span class="in">head(assaults_by_shift)</span></span>
<span id="cb75-1174"><a href="#cb75-1174"></a><span class="in">```</span></span>
<span id="cb75-1175"><a href="#cb75-1175"></a></span>
<span id="cb75-1176"><a href="#cb75-1176"></a></span>
<span id="cb75-1177"><a href="#cb75-1177"></a>&lt;div class="box extra-detail"&gt;</span>
<span id="cb75-1178"><a href="#cb75-1178"></a></span>
<span id="cb75-1179"><a href="#cb75-1179"></a>&lt;h5 id="map-box1-title" class="box-title"&gt;Why did we include <span class="in">`TRUE ~ NA_character_`</span> in <span class="in">`case_when()`</span>?&lt;/h5&gt;</span>
<span id="cb75-1180"><a href="#cb75-1180"></a></span>
<span id="cb75-1181"><a href="#cb75-1181"></a>&lt;div id="map-box1" class="box-content"&gt;</span>
<span id="cb75-1182"><a href="#cb75-1182"></a></span>
<span id="cb75-1183"><a href="#cb75-1183"></a><span class="in">`case_when()`</span> uses a series of true/false tests to create a variable, usually</span>
<span id="cb75-1184"><a href="#cb75-1184"></a>based on the values of other columns in the data. To make sure that every row</span>
<span id="cb75-1185"><a href="#cb75-1185"></a>in the dataset is matched by at least one of the tests, it is common practice to</span>
<span id="cb75-1186"><a href="#cb75-1186"></a>include a final test that is always true. The easiest way to do this is to </span>
<span id="cb75-1187"><a href="#cb75-1187"></a>simply create a test with the fixed value <span class="in">`TRUE`</span>, since <span class="in">`TRUE`</span> is always true!</span>
<span id="cb75-1188"><a href="#cb75-1188"></a>This catch-all test must be the last test within the <span class="in">`case_when()`</span> function,</span>
<span id="cb75-1189"><a href="#cb75-1189"></a>because <span class="in">`case_when()`</span> runs the tests in the order in which they are given and</span>
<span id="cb75-1190"><a href="#cb75-1190"></a>stops testing a given row in the data as soon as a test produces a true value.</span>
<span id="cb75-1191"><a href="#cb75-1191"></a></span>
<span id="cb75-1192"><a href="#cb75-1192"></a>In this case, we will set the label for this last test to be <span class="in">`NA`</span> (in fact, the</span>
<span id="cb75-1193"><a href="#cb75-1193"></a>special value <span class="in">`NA_character_`</span> because <span class="in">`case_when()`</span> only accepts labels that are </span>
<span id="cb75-1194"><a href="#cb75-1194"></a>characters) to catch any rows that have missing values of <span class="in">`date`</span> or aren't </span>
<span id="cb75-1195"><a href="#cb75-1195"></a>matched by any of our tests. Since our tests between them cover all the hours of</span>
<span id="cb75-1196"><a href="#cb75-1196"></a>the day, there shouldn't be any rows that are not matched by at-least one test,</span>
<span id="cb75-1197"><a href="#cb75-1197"></a>but including a catch-all test makes it easier to catch any problems with our </span>
<span id="cb75-1198"><a href="#cb75-1198"></a>code.</span>
<span id="cb75-1199"><a href="#cb75-1199"></a></span>
<span id="cb75-1200"><a href="#cb75-1200"></a>There's lot's more to learn about the <span class="in">`case_when()`</span> function: you can find out</span>
<span id="cb75-1201"><a href="#cb75-1201"></a>more by looking at the <span class="co">[</span><span class="ot">`case_when()` page on the package website</span><span class="co">](https://dplyr.tidyverse.org/reference/case_when.html)</span>.</span>
<span id="cb75-1202"><a href="#cb75-1202"></a></span>
<span id="cb75-1203"><a href="#cb75-1203"></a></span>
<span id="cb75-1204"><a href="#cb75-1204"></a>&lt;/div&gt;</span>
<span id="cb75-1205"><a href="#cb75-1205"></a></span>
<span id="cb75-1206"><a href="#cb75-1206"></a>&lt;/div&gt;</span>
<span id="cb75-1207"><a href="#cb75-1207"></a></span>
<span id="cb75-1208"><a href="#cb75-1208"></a>&lt;script&gt;</span>
<span id="cb75-1209"><a href="#cb75-1209"></a><span class="fu">$</span>(<span class="st">"#map-box1-title"</span>)<span class="op">.</span><span class="fu">click</span>(<span class="kw">function</span> () { <span class="fu">$</span>(<span class="st">"#map-box1"</span>)<span class="op">.</span><span class="fu">toggle</span>(<span class="st">"slow"</span>) })</span>
<span id="cb75-1210"><a href="#cb75-1210"></a>&lt;/script&gt;</span>
<span id="cb75-1211"><a href="#cb75-1211"></a></span>
<span id="cb75-1212"><a href="#cb75-1212"></a></span>
<span id="cb75-1213"><a href="#cb75-1213"></a>The next step is to produce a kernel density (KDE) layer for assaults occurring</span>
<span id="cb75-1214"><a href="#cb75-1214"></a>in each shift. In a previous tutorial we learned how to do this using the </span>
<span id="cb75-1215"><a href="#cb75-1215"></a><span class="in">`sfhotspot`</span> package. We could run the <span class="in">`hotspot_kde()`</span> function from that package </span>
<span id="cb75-1216"><a href="#cb75-1216"></a>three times to create the KDE layers for each shift, but there is a simpler way</span>
<span id="cb75-1217"><a href="#cb75-1217"></a>to apply the same function to different parts of a dataset using the </span>
<span id="cb75-1218"><a href="#cb75-1218"></a><span class="in">`group_modify()`</span> function from <span class="in">`dplyr`</span>.</span>
<span id="cb75-1219"><a href="#cb75-1219"></a></span>
<span id="cb75-1220"><a href="#cb75-1220"></a>Normally, when we use a function to modify a dataset, that function is applied</span>
<span id="cb75-1221"><a href="#cb75-1221"></a>to the dataset as a whole. With <span class="in">`group_modify()`</span>, we can apply a function to</span>
<span id="cb75-1222"><a href="#cb75-1222"></a>different parts of a dataset separately but still get the result as a single</span>
<span id="cb75-1223"><a href="#cb75-1223"></a>tibble with a column showing which group each row relates to (which is what we </span>
<span id="cb75-1224"><a href="#cb75-1224"></a>need to produce a map).</span>
<span id="cb75-1225"><a href="#cb75-1225"></a></span>
<span id="cb75-1226"><a href="#cb75-1226"></a><span class="in">`group_modify()`</span> needs two inputs. The first is a _grouped_ dataset. We already</span>
<span id="cb75-1227"><a href="#cb75-1227"></a>know how to specify which column in a dataset represents which group each row is</span>
<span id="cb75-1228"><a href="#cb75-1228"></a>in using the <span class="in">`group_by()`</span> function. The second input to <span class="in">`group_modify()`</span> is the</span>
<span id="cb75-1229"><a href="#cb75-1229"></a>name of the function we want to use to modify each group in the data. The only</span>
<span id="cb75-1230"><a href="#cb75-1230"></a>complication is that we have to provide the details of the function that </span>
<span id="cb75-1231"><a href="#cb75-1231"></a><span class="in">`group_modify()`</span> should use in a slightly unusual format called an _anonymous</span>
<span id="cb75-1232"><a href="#cb75-1232"></a>function_. You can see this in the block of code below. You do not need to </span>
<span id="cb75-1233"><a href="#cb75-1233"></a>understand the details of how an anonymous function works, but you should note</span>
<span id="cb75-1234"><a href="#cb75-1234"></a>two things:</span>
<span id="cb75-1235"><a href="#cb75-1235"></a></span>
<span id="cb75-1236"><a href="#cb75-1236"></a><span class="ss">  1. </span>Anonymous functions start with the <span class="in">`~`</span> character.</span>
<span id="cb75-1237"><a href="#cb75-1237"></a><span class="ss">  2. </span>In an anonymous function used within <span class="in">`group_modify()`</span>, you can use the</span>
<span id="cb75-1238"><a href="#cb75-1238"></a>     special value <span class="in">`.x`</span> (note the dot) to represent the data in each group.</span>
<span id="cb75-1239"><a href="#cb75-1239"></a>     </span>
<span id="cb75-1240"><a href="#cb75-1240"></a>So this code:</span>
<span id="cb75-1241"><a href="#cb75-1241"></a></span>
<span id="cb75-1242"><a href="#cb75-1242"></a><span class="in">```r</span></span>
<span id="cb75-1243"><a href="#cb75-1243"></a>some_data <span class="sc">|&gt;</span> </span>
<span id="cb75-1244"><a href="#cb75-1244"></a>  <span class="fu">group_by</span>(some_variable) <span class="sc">|&gt;</span> </span>
<span id="cb75-1245"><a href="#cb75-1245"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">hotspot_kde</span>(.x))</span>
<span id="cb75-1246"><a href="#cb75-1246"></a><span class="in">```</span></span>
<span id="cb75-1247"><a href="#cb75-1247"></a></span>
<span id="cb75-1248"><a href="#cb75-1248"></a>Means 'take the dataset <span class="in">`some_data`</span>, group it according to the values in the</span>
<span id="cb75-1249"><a href="#cb75-1249"></a><span class="in">`some_variable`</span> column and apply the <span class="in">`hotspot_kde()`</span> function separately to each</span>
<span id="cb75-1250"><a href="#cb75-1250"></a>group'. The only thing left for us to do then is to use <span class="in">`ungroup()`</span> to remove </span>
<span id="cb75-1251"><a href="#cb75-1251"></a>the grouping from the result produced by <span class="in">`group_modify()`</span> and convert that</span>
<span id="cb75-1252"><a href="#cb75-1252"></a>result back to an SF object using <span class="in">`st_as_sf()`</span>. Don't worry about specifying any</span>
<span id="cb75-1253"><a href="#cb75-1253"></a>arguments to <span class="in">`st_as_sf()`</span> – R will extract information such as the co-ordinate</span>
<span id="cb75-1254"><a href="#cb75-1254"></a>reference system from the <span class="in">`geometry`</span> column of the data automatically.</span>
<span id="cb75-1255"><a href="#cb75-1255"></a></span>
<span id="cb75-1256"><a href="#cb75-1256"></a><span class="in">```{r map-exercise2, exercise=TRUE}</span></span>
<span id="cb75-1257"><a href="#cb75-1257"></a><span class="in">library(sfhotspot)</span></span>
<span id="cb75-1258"><a href="#cb75-1258"></a></span>
<span id="cb75-1259"><a href="#cb75-1259"></a><span class="in">kde_by_shift &lt;- assaults_by_shift |&gt; </span></span>
<span id="cb75-1260"><a href="#cb75-1260"></a><span class="in">  group_by(shift) |&gt; </span></span>
<span id="cb75-1261"><a href="#cb75-1261"></a><span class="in">  group_modify(</span></span>
<span id="cb75-1262"><a href="#cb75-1262"></a><span class="in">    ~ hotspot_kde(.x, cell_size = 200, bandwidth_adjust = 0.75, quiet = TRUE)</span></span>
<span id="cb75-1263"><a href="#cb75-1263"></a><span class="in">  ) |&gt; </span></span>
<span id="cb75-1264"><a href="#cb75-1264"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb75-1265"><a href="#cb75-1265"></a><span class="in">  st_as_sf() |&gt; </span></span>
<span id="cb75-1266"><a href="#cb75-1266"></a><span class="in">  # Clip the result to the boundary of Chicago, which is already stored in the </span></span>
<span id="cb75-1267"><a href="#cb75-1267"></a><span class="in">  # `cpd_central` object</span></span>
<span id="cb75-1268"><a href="#cb75-1268"></a><span class="in">  st_intersection(cpd_central)</span></span>
<span id="cb75-1269"><a href="#cb75-1269"></a></span>
<span id="cb75-1270"><a href="#cb75-1270"></a><span class="in">head(kde_by_shift)</span></span>
<span id="cb75-1271"><a href="#cb75-1271"></a><span class="in">```</span></span>
<span id="cb75-1272"><a href="#cb75-1272"></a></span>
<span id="cb75-1273"><a href="#cb75-1273"></a></span>
<span id="cb75-1274"><a href="#cb75-1274"></a>&lt;div class="box extra-detail"&gt;</span>
<span id="cb75-1275"><a href="#cb75-1275"></a></span>
<span id="cb75-1276"><a href="#cb75-1276"></a>&lt;h5 id="map-box2-title" class="box-title"&gt;How to anonymous functions work?&lt;/h5&gt;</span>
<span id="cb75-1277"><a href="#cb75-1277"></a></span>
<span id="cb75-1278"><a href="#cb75-1278"></a>&lt;div id="map-box2" class="box-content"&gt;</span>
<span id="cb75-1279"><a href="#cb75-1279"></a></span>
<span id="cb75-1280"><a href="#cb75-1280"></a>Anonymous functions in R (and in many other programming languages) are a compact</span>
<span id="cb75-1281"><a href="#cb75-1281"></a>way of creating a new function that we can then immediately use to modify a</span>
<span id="cb75-1282"><a href="#cb75-1282"></a>dataset.</span>
<span id="cb75-1283"><a href="#cb75-1283"></a></span>
<span id="cb75-1284"><a href="#cb75-1284"></a>We can create our own functions in R by using the <span class="in">`function()`</span> function. For</span>
<span id="cb75-1285"><a href="#cb75-1285"></a>example, if we wanted to create our own version of the <span class="in">`head()`</span> function that</span>
<span id="cb75-1286"><a href="#cb75-1286"></a>printed the first 10 rows of a dataset – rather than the default six rows </span>
<span id="cb75-1287"><a href="#cb75-1287"></a>printed by <span class="in">`head()`</span> – we could create a function called <span class="in">`head10()`</span>:</span>
<span id="cb75-1288"><a href="#cb75-1288"></a></span>
<span id="cb75-1289"><a href="#cb75-1289"></a><span class="in">```r</span></span>
<span id="cb75-1290"><a href="#cb75-1290"></a>head10 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb75-1291"><a href="#cb75-1291"></a>  <span class="fu">head</span>(x, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb75-1292"><a href="#cb75-1292"></a>}</span>
<span id="cb75-1293"><a href="#cb75-1293"></a><span class="in">```</span></span>
<span id="cb75-1294"><a href="#cb75-1294"></a></span>
<span id="cb75-1295"><a href="#cb75-1295"></a>When we call the new <span class="in">`head10()`</span> function on a dataset, R will take whatever data</span>
<span id="cb75-1296"><a href="#cb75-1296"></a>we provide to that function and run all the code inside the braces <span class="in">`{}`</span> above</span>
<span id="cb75-1297"><a href="#cb75-1297"></a>using that data. We can use this new function anywhere in our code _after_ we've </span>
<span id="cb75-1298"><a href="#cb75-1298"></a>created it. For example, if we had a dataset called <span class="in">`some_data`</span> we could view </span>
<span id="cb75-1299"><a href="#cb75-1299"></a>the first 10 rows of it by creating an then using our new function:</span>
<span id="cb75-1300"><a href="#cb75-1300"></a></span>
<span id="cb75-1301"><a href="#cb75-1301"></a><span class="in">```r</span></span>
<span id="cb75-1302"><a href="#cb75-1302"></a>head10 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb75-1303"><a href="#cb75-1303"></a>  <span class="fu">head</span>(x, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb75-1304"><a href="#cb75-1304"></a>}</span>
<span id="cb75-1305"><a href="#cb75-1305"></a></span>
<span id="cb75-1306"><a href="#cb75-1306"></a><span class="fu">head10</span>(some_data)</span>
<span id="cb75-1307"><a href="#cb75-1307"></a><span class="in">```</span></span>
<span id="cb75-1308"><a href="#cb75-1308"></a></span>
<span id="cb75-1309"><a href="#cb75-1309"></a>Note that _inside_ our new function, the dataset is referred to by the name that</span>
<span id="cb75-1310"><a href="#cb75-1310"></a>we gave it in the parentheses <span class="in">`()`</span> after the word <span class="in">`function`</span>, _not_ by the name</span>
<span id="cb75-1311"><a href="#cb75-1311"></a>of the dataset itself. This is important because it means our custom function </span>
<span id="cb75-1312"><a href="#cb75-1312"></a>will work regardless of what a particular dataset is called.</span>
<span id="cb75-1313"><a href="#cb75-1313"></a></span>
<span id="cb75-1314"><a href="#cb75-1314"></a>We could include lots of lines of code inside our new function, but in this case </span>
<span id="cb75-1315"><a href="#cb75-1315"></a>there is just one – <span class="in">`head(x, n = 10)`</span>. When we want to create a function that</span>
<span id="cb75-1316"><a href="#cb75-1316"></a>consists of a single line of code, we can dispense with the braces and put the </span>
<span id="cb75-1317"><a href="#cb75-1317"></a>whole function on one line:</span>
<span id="cb75-1318"><a href="#cb75-1318"></a></span>
<span id="cb75-1319"><a href="#cb75-1319"></a><span class="in">```r</span></span>
<span id="cb75-1320"><a href="#cb75-1320"></a>head10 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">head</span>(x, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb75-1321"><a href="#cb75-1321"></a></span>
<span id="cb75-1322"><a href="#cb75-1322"></a><span class="fu">head10</span>(some_data)</span>
<span id="cb75-1323"><a href="#cb75-1323"></a><span class="in">```</span></span>
<span id="cb75-1324"><a href="#cb75-1324"></a></span>
<span id="cb75-1325"><a href="#cb75-1325"></a>Creating a new function and giving it a name is useful if we want to use the</span>
<span id="cb75-1326"><a href="#cb75-1326"></a>function several times in our code. But in the case of the function we need to</span>
<span id="cb75-1327"><a href="#cb75-1327"></a>provide to <span class="in">`group_modify()`</span> in our code, we only need to use the new function</span>
<span id="cb75-1328"><a href="#cb75-1328"></a>once. In this case, we can dispense with the need to give our new function a </span>
<span id="cb75-1329"><a href="#cb75-1329"></a>name, and instead create an anonymous function. To do this, we replace </span>
<span id="cb75-1330"><a href="#cb75-1330"></a><span class="in">`function(x)`</span> with the <span class="in">`~`</span> character.</span>
<span id="cb75-1331"><a href="#cb75-1331"></a></span>
<span id="cb75-1332"><a href="#cb75-1332"></a>This makes the definition of our custom function even faster, but means we can</span>
<span id="cb75-1333"><a href="#cb75-1333"></a>only use it inside a function such as <span class="in">`group_modify()`</span> or <span class="in">`map()`</span> that needs a</span>
<span id="cb75-1334"><a href="#cb75-1334"></a>function definition to work. Using an anonymous function also means we need some </span>
<span id="cb75-1335"><a href="#cb75-1335"></a>way of referring to our dataset inside the new function, since we don't have the</span>
<span id="cb75-1336"><a href="#cb75-1336"></a>opportunity to define it inside parentheses after the word <span class="in">`function`</span>. </span>
<span id="cb75-1337"><a href="#cb75-1337"></a>Fortunately, <span class="in">`group_modify()`</span> understands that if we refer to <span class="in">`.x`</span> (note the </span>
<span id="cb75-1338"><a href="#cb75-1338"></a>dot) inside our anonymous function, that should be interpreted as referring to</span>
<span id="cb75-1339"><a href="#cb75-1339"></a>our dataset.</span>
<span id="cb75-1340"><a href="#cb75-1340"></a></span>
<span id="cb75-1341"><a href="#cb75-1341"></a>There is a lot more you could learn about creating your own functions in R. If</span>
<span id="cb75-1342"><a href="#cb75-1342"></a>you are interested, you might want to <span class="co">[</span><span class="ot">work through this lesson on Creating Functions</span><span class="co">](https://swcarpentry.github.io/r-novice-inflammation/02-func-R/)</span>.</span>
<span id="cb75-1343"><a href="#cb75-1343"></a></span>
<span id="cb75-1344"><a href="#cb75-1344"></a>&lt;/div&gt;</span>
<span id="cb75-1345"><a href="#cb75-1345"></a></span>
<span id="cb75-1346"><a href="#cb75-1346"></a>&lt;/div&gt;</span>
<span id="cb75-1347"><a href="#cb75-1347"></a></span>
<span id="cb75-1348"><a href="#cb75-1348"></a>&lt;script&gt;</span>
<span id="cb75-1349"><a href="#cb75-1349"></a><span class="fu">$</span>(<span class="st">"#map-box2-title"</span>)<span class="op">.</span><span class="fu">click</span>(<span class="kw">function</span> () { <span class="fu">$</span>(<span class="st">"#map-box2"</span>)<span class="op">.</span><span class="fu">toggle</span>(<span class="st">"slow"</span>) })</span>
<span id="cb75-1350"><a href="#cb75-1350"></a>&lt;/script&gt;</span>
<span id="cb75-1351"><a href="#cb75-1351"></a></span>
<span id="cb75-1352"><a href="#cb75-1352"></a>Now we have a KDE layer for each shift, we can create three maps for the three </span>
<span id="cb75-1353"><a href="#cb75-1353"></a>shifts by adding <span class="in">`facet_wrap()`</span> to a <span class="in">`ggplot()`</span> stack.</span>
<span id="cb75-1354"><a href="#cb75-1354"></a></span>
<span id="cb75-1355"><a href="#cb75-1355"></a><span class="in">```{r map-exercise3, exercise=TRUE, exercise.lines=30, message=FALSE}</span></span>
<span id="cb75-1356"><a href="#cb75-1356"></a><span class="in">library(ggspatial)</span></span>
<span id="cb75-1357"><a href="#cb75-1357"></a></span>
<span id="cb75-1358"><a href="#cb75-1358"></a><span class="in">ggplot() +</span></span>
<span id="cb75-1359"><a href="#cb75-1359"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb75-1360"><a href="#cb75-1360"></a><span class="in">  geom_sf(</span></span>
<span id="cb75-1361"><a href="#cb75-1361"></a><span class="in">    aes(fill = kde), </span></span>
<span id="cb75-1362"><a href="#cb75-1362"></a><span class="in">    data = kde_by_shift, </span></span>
<span id="cb75-1363"><a href="#cb75-1363"></a><span class="in">    alpha = 0.75, </span></span>
<span id="cb75-1364"><a href="#cb75-1364"></a><span class="in">    colour = NA</span></span>
<span id="cb75-1365"><a href="#cb75-1365"></a><span class="in">  ) +</span></span>
<span id="cb75-1366"><a href="#cb75-1366"></a><span class="in">  geom_sf(</span></span>
<span id="cb75-1367"><a href="#cb75-1367"></a><span class="in">    data = filter(cpd_districts, district_no %in% c(1, 12, 18)), </span></span>
<span id="cb75-1368"><a href="#cb75-1368"></a><span class="in">    colour = "grey33", </span></span>
<span id="cb75-1369"><a href="#cb75-1369"></a><span class="in">    fill = NA</span></span>
<span id="cb75-1370"><a href="#cb75-1370"></a><span class="in">  ) +</span></span>
<span id="cb75-1371"><a href="#cb75-1371"></a><span class="in">  facet_wrap(vars(shift)) +</span></span>
<span id="cb75-1372"><a href="#cb75-1372"></a><span class="in">  scale_fill_distiller(</span></span>
<span id="cb75-1373"><a href="#cb75-1373"></a><span class="in">    breaks = range(pull(kde_by_shift, kde)),</span></span>
<span id="cb75-1374"><a href="#cb75-1374"></a><span class="in">    labels = c("lower", "higher"),</span></span>
<span id="cb75-1375"><a href="#cb75-1375"></a><span class="in">    direction = 1</span></span>
<span id="cb75-1376"><a href="#cb75-1376"></a><span class="in">  ) +</span></span>
<span id="cb75-1377"><a href="#cb75-1377"></a><span class="in">  labs(</span></span>
<span id="cb75-1378"><a href="#cb75-1378"></a><span class="in">    fill = "density of aggravated assaults"</span></span>
<span id="cb75-1379"><a href="#cb75-1379"></a><span class="in">  ) +</span></span>
<span id="cb75-1380"><a href="#cb75-1380"></a><span class="in">  theme_void() +</span></span>
<span id="cb75-1381"><a href="#cb75-1381"></a><span class="in">  theme(</span></span>
<span id="cb75-1382"><a href="#cb75-1382"></a><span class="in">    legend.position = "bottom",</span></span>
<span id="cb75-1383"><a href="#cb75-1383"></a><span class="in">    legend.title.align = 1</span></span>
<span id="cb75-1384"><a href="#cb75-1384"></a><span class="in">  )</span></span>
<span id="cb75-1385"><a href="#cb75-1385"></a><span class="in">```</span></span>
<span id="cb75-1386"><a href="#cb75-1386"></a></span>
<span id="cb75-1387"><a href="#cb75-1387"></a>On this map we can see that some places have a relatively high density of </span>
<span id="cb75-1388"><a href="#cb75-1388"></a>assaults throughout all three shifts, but others only have a high density at</span>
<span id="cb75-1389"><a href="#cb75-1389"></a>certain times. We can perhaps make this clearer by only showing the grid cells</span>
<span id="cb75-1390"><a href="#cb75-1390"></a>with the highest estimated density of assaults during each shift. We can do this</span>
<span id="cb75-1391"><a href="#cb75-1391"></a>using the <span class="in">`slice_max()`</span> function from <span class="in">`dplyr`</span>, which allows us to extract the</span>
<span id="cb75-1392"><a href="#cb75-1392"></a>rows in a dataset with the highest values of a particular variable. In this case</span>
<span id="cb75-1393"><a href="#cb75-1393"></a>we will use <span class="in">`slice_max()`</span> together with <span class="in">`group_by()`</span> to get the rows with the</span>
<span id="cb75-1394"><a href="#cb75-1394"></a>highest values _separately for each shift_ rather than those with the highest </span>
<span id="cb75-1395"><a href="#cb75-1395"></a>values across all three shifts combined.</span>
<span id="cb75-1396"><a href="#cb75-1396"></a></span>
<span id="cb75-1397"><a href="#cb75-1397"></a><span class="in">```{r map-exercise4, exercise=TRUE, exercise.lines=21}</span></span>
<span id="cb75-1398"><a href="#cb75-1398"></a><span class="in">kde_shift_highest &lt;- kde_by_shift |&gt; </span></span>
<span id="cb75-1399"><a href="#cb75-1399"></a><span class="in">  group_by(shift) |&gt; </span></span>
<span id="cb75-1400"><a href="#cb75-1400"></a><span class="in">  slice_max(order_by = kde, n = 10)</span></span>
<span id="cb75-1401"><a href="#cb75-1401"></a></span>
<span id="cb75-1402"><a href="#cb75-1402"></a><span class="in">ggplot() +</span></span>
<span id="cb75-1403"><a href="#cb75-1403"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb75-1404"><a href="#cb75-1404"></a><span class="in">  geom_sf(</span></span>
<span id="cb75-1405"><a href="#cb75-1405"></a><span class="in">    aes(fill = kde), </span></span>
<span id="cb75-1406"><a href="#cb75-1406"></a><span class="in">    data = kde_shift_highest, </span></span>
<span id="cb75-1407"><a href="#cb75-1407"></a><span class="in">    alpha = 0.75, </span></span>
<span id="cb75-1408"><a href="#cb75-1408"></a><span class="in">    colour = NA,</span></span>
<span id="cb75-1409"><a href="#cb75-1409"></a><span class="in">    fill = "red2"</span></span>
<span id="cb75-1410"><a href="#cb75-1410"></a><span class="in">  ) +</span></span>
<span id="cb75-1411"><a href="#cb75-1411"></a><span class="in">  geom_sf(</span></span>
<span id="cb75-1412"><a href="#cb75-1412"></a><span class="in">    data = filter(cpd_districts, district_no %in% c(1, 12, 18)), </span></span>
<span id="cb75-1413"><a href="#cb75-1413"></a><span class="in">    colour = "grey33", </span></span>
<span id="cb75-1414"><a href="#cb75-1414"></a><span class="in">    fill = NA</span></span>
<span id="cb75-1415"><a href="#cb75-1415"></a><span class="in">  ) +</span></span>
<span id="cb75-1416"><a href="#cb75-1416"></a><span class="in">  facet_wrap(vars(shift)) +</span></span>
<span id="cb75-1417"><a href="#cb75-1417"></a><span class="in">  theme_void()</span></span>
<span id="cb75-1418"><a href="#cb75-1418"></a><span class="in">```</span></span>
<span id="cb75-1419"><a href="#cb75-1419"></a></span>
<span id="cb75-1420"><a href="#cb75-1420"></a>This map makes it very clear that the grid cells with the highest densities of</span>
<span id="cb75-1421"><a href="#cb75-1421"></a>aggravated assaults are very similar in the daytime and evening shifts, in both</span>
<span id="cb75-1422"><a href="#cb75-1422"></a>places being concentrated in the downtown area known as The Loop. For the </span>
<span id="cb75-1423"><a href="#cb75-1423"></a>overnight shift, however, the cells with the highest densities are on the other</span>
<span id="cb75-1424"><a href="#cb75-1424"></a>side of the Chicago River in the River North neighbourhood. A map like this </span>
<span id="cb75-1425"><a href="#cb75-1425"></a>might be particularly useful if the resources available to respond to a crime </span>
<span id="cb75-1426"><a href="#cb75-1426"></a>problem were very limited and so could only be deployed in the places where the</span>
<span id="cb75-1427"><a href="#cb75-1427"></a>problem was worst -- this is often the case because crime-prevention resources</span>
<span id="cb75-1428"><a href="#cb75-1428"></a>*are* often very limited.</span>
<span id="cb75-1429"><a href="#cb75-1429"></a></span>
<span id="cb75-1430"><a href="#cb75-1430"></a></span>
<span id="cb75-1431"><a href="#cb75-1431"></a><span class="fu">## Making animated maps</span></span>
<span id="cb75-1432"><a href="#cb75-1432"></a></span>
<span id="cb75-1433"><a href="#cb75-1433"></a>The small-multiple map we have produced of aggravated-assault hotspots in</span>
<span id="cb75-1434"><a href="#cb75-1434"></a>Chicago is useful, especially for policing because it uses periods based on </span>
<span id="cb75-1435"><a href="#cb75-1435"></a>police shifts. But aggregating crimes into only three temporal periods </span>
<span id="cb75-1436"><a href="#cb75-1436"></a>inevitably throws away a lot of information about when crime happens. For </span>
<span id="cb75-1437"><a href="#cb75-1437"></a>example, at what time of night does the area of highest assault density move </span>
<span id="cb75-1438"><a href="#cb75-1438"></a>across the river from The Loop to River North?</span>
<span id="cb75-1439"><a href="#cb75-1439"></a></span>
<span id="cb75-1440"><a href="#cb75-1440"></a>We could produce a series of small-multiple maps showing shorter periods </span>
<span id="cb75-1441"><a href="#cb75-1441"></a>(meaning more small multiples). For example, we could show one small-multiple</span>
<span id="cb75-1442"><a href="#cb75-1442"></a>map for each hour of the day. However, this would make each map very small and</span>
<span id="cb75-1443"><a href="#cb75-1443"></a>it would be hard to see the details of locations on each map.</span>
<span id="cb75-1444"><a href="#cb75-1444"></a></span>
<span id="cb75-1445"><a href="#cb75-1445"></a>One alternative is to produce an animated map with each frame in the animation</span>
<span id="cb75-1446"><a href="#cb75-1446"></a>representing the map for each hour. We can do this using the </span>
<span id="cb75-1447"><a href="#cb75-1447"></a><span class="co">[</span><span class="ot">`gganimate` package</span><span class="co">](https://gganimate.com/)</span>.</span>
<span id="cb75-1448"><a href="#cb75-1448"></a></span>
<span id="cb75-1449"><a href="#cb75-1449"></a>The first step in producing an animated map is to create a KDE layer for each</span>
<span id="cb75-1450"><a href="#cb75-1450"></a>hour of the day. The code for this is the same as for the code we have already</span>
<span id="cb75-1451"><a href="#cb75-1451"></a>used to produce the KDE layers for each shift, except that we create a variable</span>
<span id="cb75-1452"><a href="#cb75-1452"></a>for hour of the day rather than police shift. Because an animated map of hours </span>
<span id="cb75-1453"><a href="#cb75-1453"></a>of the day needs 24 KDE layers, in this case it is particularly useful to use</span>
<span id="cb75-1454"><a href="#cb75-1454"></a><span class="in">`group_modify()`</span> to avoid having to create 24 different objects and then binding </span>
<span id="cb75-1455"><a href="#cb75-1455"></a>them together.</span>
<span id="cb75-1456"><a href="#cb75-1456"></a></span>
<span id="cb75-1457"><a href="#cb75-1457"></a><span class="in">```{r animated-exercise1, exercise=TRUE, exercise.lines=27}</span></span>
<span id="cb75-1458"><a href="#cb75-1458"></a><span class="in">library(gganimate)</span></span>
<span id="cb75-1459"><a href="#cb75-1459"></a></span>
<span id="cb75-1460"><a href="#cb75-1460"></a><span class="in">assaults_by_hour &lt;- assaults |&gt; </span></span>
<span id="cb75-1461"><a href="#cb75-1461"></a><span class="in">  filter(district %in% c(1, 12, 18)) |&gt; </span></span>
<span id="cb75-1462"><a href="#cb75-1462"></a><span class="in">  mutate(</span></span>
<span id="cb75-1463"><a href="#cb75-1463"></a><span class="in">    # Create nicely formatted labels for each hour</span></span>
<span id="cb75-1464"><a href="#cb75-1464"></a><span class="in">    hour_name = str_pad(hour(date), width = 2, pad = "0"),</span></span>
<span id="cb75-1465"><a href="#cb75-1465"></a><span class="in">    hour_name = str_glue("{hour_name}:00 to {hour_name}:59")</span></span>
<span id="cb75-1466"><a href="#cb75-1466"></a><span class="in">  ) |&gt; </span></span>
<span id="cb75-1467"><a href="#cb75-1467"></a><span class="in">  st_as_sf(coords = c("longitude", "latitude"), crs = "EPSG:4326") |&gt; </span></span>
<span id="cb75-1468"><a href="#cb75-1468"></a><span class="in">  # Convert the data to a suitable co-ordinate system for Chicago</span></span>
<span id="cb75-1469"><a href="#cb75-1469"></a><span class="in">  st_transform("EPSG:26916")</span></span>
<span id="cb75-1470"><a href="#cb75-1470"></a></span>
<span id="cb75-1471"><a href="#cb75-1471"></a><span class="in">hour_layers &lt;- assaults_by_hour |&gt; </span></span>
<span id="cb75-1472"><a href="#cb75-1472"></a><span class="in">  group_by(hour_name) |&gt; </span></span>
<span id="cb75-1473"><a href="#cb75-1473"></a><span class="in">  group_modify(</span></span>
<span id="cb75-1474"><a href="#cb75-1474"></a><span class="in">    ~ hotspot_kde(.x, cell_size = 200, bandwidth_adjust = 0.75, quiet = TRUE)</span></span>
<span id="cb75-1475"><a href="#cb75-1475"></a><span class="in">  ) |&gt; </span></span>
<span id="cb75-1476"><a href="#cb75-1476"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb75-1477"><a href="#cb75-1477"></a><span class="in">  st_as_sf() |&gt; </span></span>
<span id="cb75-1478"><a href="#cb75-1478"></a><span class="in">  st_intersection(cpd_central)</span></span>
<span id="cb75-1479"><a href="#cb75-1479"></a></span>
<span id="cb75-1480"><a href="#cb75-1480"></a><span class="in"># Extract only the 10 cells with the highest density in each hour</span></span>
<span id="cb75-1481"><a href="#cb75-1481"></a><span class="in">hour_highest &lt;- hour_layers |&gt; </span></span>
<span id="cb75-1482"><a href="#cb75-1482"></a><span class="in">  group_by(hour_name) |&gt; </span></span>
<span id="cb75-1483"><a href="#cb75-1483"></a><span class="in">  slice_max(order_by = kde, n = 10)</span></span>
<span id="cb75-1484"><a href="#cb75-1484"></a><span class="in">```</span></span>
<span id="cb75-1485"><a href="#cb75-1485"></a></span>
<span id="cb75-1486"><a href="#cb75-1486"></a></span>
<span id="cb75-1487"><a href="#cb75-1487"></a>::: {.box .notewell .tutorial}</span>
<span id="cb75-1488"><a href="#cb75-1488"></a></span>
<span id="cb75-1489"><a href="#cb75-1489"></a>It is possible that this code will time out and give an error saying </span>
<span id="cb75-1490"><a href="#cb75-1490"></a><span class="in">`Your code ran longer than the permitted timelimit for this exercise.`</span> -- if </span>
<span id="cb75-1491"><a href="#cb75-1491"></a>that happens then just continue with the rest of the tutorial as normal.</span>
<span id="cb75-1492"><a href="#cb75-1492"></a></span>
<span id="cb75-1493"><a href="#cb75-1493"></a>:::</span>
<span id="cb75-1494"><a href="#cb75-1494"></a></span>
<span id="cb75-1495"><a href="#cb75-1495"></a></span>
<span id="cb75-1496"><a href="#cb75-1496"></a>::: {.box .notewell .book}</span>
<span id="cb75-1497"><a href="#cb75-1497"></a></span>
<span id="cb75-1498"><a href="#cb75-1498"></a>This code is likely to take a while to run, because it calculates KDE values</span>
<span id="cb75-1499"><a href="#cb75-1499"></a>separately for every grid cell for each of 24 hours.</span>
<span id="cb75-1500"><a href="#cb75-1500"></a></span>
<span id="cb75-1501"><a href="#cb75-1501"></a>:::</span>
<span id="cb75-1502"><a href="#cb75-1502"></a></span>
<span id="cb75-1503"><a href="#cb75-1503"></a></span>
<span id="cb75-1504"><a href="#cb75-1504"></a>We can now use the <span class="in">`hour_highest`</span> object as the basis for a new base map that</span>
<span id="cb75-1505"><a href="#cb75-1505"></a>only includes the areas of the highest density (so they appear larger on the</span>
<span id="cb75-1506"><a href="#cb75-1506"></a>animated map).</span>
<span id="cb75-1507"><a href="#cb75-1507"></a></span>
<span id="cb75-1508"><a href="#cb75-1508"></a>To create an animated map we use the <span class="in">`transition_states()`</span> function from the</span>
<span id="cb75-1509"><a href="#cb75-1509"></a><span class="in">`gganimate`</span> package. <span class="in">`transition_states()`</span> works in a similar way to </span>
<span id="cb75-1510"><a href="#cb75-1510"></a><span class="in">`facet_wrap()`</span>, in that when added to a <span class="in">`ggplot()`</span> stack it splits the chart or </span>
<span id="cb75-1511"><a href="#cb75-1511"></a>map up into a separate map for each value of one of the variables in the data </span>
<span id="cb75-1512"><a href="#cb75-1512"></a>(in this case, the hour of the day). The only difference is that while </span>
<span id="cb75-1513"><a href="#cb75-1513"></a><span class="in">`facet_wrap()`</span> arranges those separate maps next to one another, </span>
<span id="cb75-1514"><a href="#cb75-1514"></a><span class="in">`transition_states()`</span> arranges them into an animation.</span>
<span id="cb75-1515"><a href="#cb75-1515"></a></span>
<span id="cb75-1516"><a href="#cb75-1516"></a><span class="in">```{r animated-exercise3, exercise=TRUE, exercise.lines=18, fig.asp=1}</span></span>
<span id="cb75-1517"><a href="#cb75-1517"></a><span class="in">ggplot() +</span></span>
<span id="cb75-1518"><a href="#cb75-1518"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb75-1519"><a href="#cb75-1519"></a><span class="in">  geom_sf(</span></span>
<span id="cb75-1520"><a href="#cb75-1520"></a><span class="in">    aes(fill = kde),</span></span>
<span id="cb75-1521"><a href="#cb75-1521"></a><span class="in">    data = hour_highest, </span></span>
<span id="cb75-1522"><a href="#cb75-1522"></a><span class="in">    alpha = 0.75, </span></span>
<span id="cb75-1523"><a href="#cb75-1523"></a><span class="in">    colour = NA,</span></span>
<span id="cb75-1524"><a href="#cb75-1524"></a><span class="in">    fill = "red2"</span></span>
<span id="cb75-1525"><a href="#cb75-1525"></a><span class="in">  ) +</span></span>
<span id="cb75-1526"><a href="#cb75-1526"></a><span class="in">  geom_sf(data = cpd_central, colour = "grey33", fill = NA) +</span></span>
<span id="cb75-1527"><a href="#cb75-1527"></a><span class="in">  transition_states(states = hour_name) +</span></span>
<span id="cb75-1528"><a href="#cb75-1528"></a><span class="in">  labs(</span></span>
<span id="cb75-1529"><a href="#cb75-1529"></a><span class="in">    title = "Aggravated assaults in downtown Chicago, 2010-2019",</span></span>
<span id="cb75-1530"><a href="#cb75-1530"></a><span class="in">    subtitle = "Areas with most aggravated assaults:\n{closest_state}",</span></span>
<span id="cb75-1531"><a href="#cb75-1531"></a><span class="in">    caption = "Data from Chicago Police"</span></span>
<span id="cb75-1532"><a href="#cb75-1532"></a><span class="in">  ) +</span></span>
<span id="cb75-1533"><a href="#cb75-1533"></a><span class="in">  theme_void()</span></span>
<span id="cb75-1534"><a href="#cb75-1534"></a><span class="in">```</span></span>
<span id="cb75-1535"><a href="#cb75-1535"></a></span>
<span id="cb75-1536"><a href="#cb75-1536"></a></span>
<span id="cb75-1537"><a href="#cb75-1537"></a>&lt;div class="box extra-detail tutorial"&gt;</span>
<span id="cb75-1538"><a href="#cb75-1538"></a></span>
<span id="cb75-1539"><a href="#cb75-1539"></a>&lt;h5 id="animated-box1-title" class="box-title"&gt;I got an error starting <span class="in">`Your code ran longer than`</span>&lt;/h5&gt;</span>
<span id="cb75-1540"><a href="#cb75-1540"></a></span>
<span id="cb75-1541"><a href="#cb75-1541"></a>&lt;div id="animated-box1" class="box-content"&gt;</span>
<span id="cb75-1542"><a href="#cb75-1542"></a></span>
<span id="cb75-1543"><a href="#cb75-1543"></a>This code may take longer to run than is allowed for code inside an interactive </span>
<span id="cb75-1544"><a href="#cb75-1544"></a>tutorial. In which case, you may see the error </span>
<span id="cb75-1545"><a href="#cb75-1545"></a><span class="in">`Your code ran longer than the permitted timelimit for this exercise`</span>. If that </span>
<span id="cb75-1546"><a href="#cb75-1546"></a>happens, you can</span>
<span id="cb75-1547"><a href="#cb75-1547"></a><span class="co">[</span><span class="ot">download the Chicago assaults data</span><span class="co">](https://mpjashby.github.io/crimemappingdata/chicago_aggravated_assaults.csv.gz)</span> </span>
<span id="cb75-1548"><a href="#cb75-1548"></a>and create an animated map in an R script of your own using the code in the </span>
<span id="cb75-1549"><a href="#cb75-1549"></a>chunks above. For reference, this code should produce a map looking like this:</span>
<span id="cb75-1550"><a href="#cb75-1550"></a></span>
<span id="cb75-1551"><a href="#cb75-1551"></a>&lt;p class="centered-image"&gt;&lt;img src="https://github.com/mpjashby/crimemapping/raw/main/inst/tutorials/16_mapping_time/images/chicago_animated_highest.gif" alt="Animated map showing how the areas of downtown Chicago with the highest density of aggravated assaults vary throughout the hours of the day."&gt;&lt;/p&gt;</span>
<span id="cb75-1552"><a href="#cb75-1552"></a></span>
<span id="cb75-1553"><a href="#cb75-1553"></a>&lt;/div&gt;</span>
<span id="cb75-1554"><a href="#cb75-1554"></a></span>
<span id="cb75-1555"><a href="#cb75-1555"></a>&lt;/div&gt;</span>
<span id="cb75-1556"><a href="#cb75-1556"></a></span>
<span id="cb75-1557"><a href="#cb75-1557"></a>&lt;script&gt;</span>
<span id="cb75-1558"><a href="#cb75-1558"></a><span class="fu">$</span>(<span class="st">"#animated-box1-title"</span>)<span class="op">.</span><span class="fu">click</span>(<span class="kw">function</span> () { <span class="fu">$</span>(<span class="st">"#animated-box1"</span>)<span class="op">.</span><span class="fu">toggle</span>(<span class="st">"slow"</span>) })</span>
<span id="cb75-1559"><a href="#cb75-1559"></a>&lt;/script&gt;</span>
<span id="cb75-1560"><a href="#cb75-1560"></a></span>
<span id="cb75-1561"><a href="#cb75-1561"></a></span>
<span id="cb75-1562"><a href="#cb75-1562"></a>There is one other function of <span class="in">`gganimate`</span> we have used in the code used to make</span>
<span id="cb75-1563"><a href="#cb75-1563"></a>this map. You might have noticed that in the map <span class="in">`subtitle`</span> is the code </span>
<span id="cb75-1564"><a href="#cb75-1564"></a><span class="in">`{closest_state}`</span>. This is a special code that <span class="in">`gganimate`</span> will replace with the</span>
<span id="cb75-1565"><a href="#cb75-1565"></a>current value of the variable in the data that is used to control which facet </span>
<span id="cb75-1566"><a href="#cb75-1566"></a>appears in each frame of the animation. So for this map, <span class="in">`{closest_state}`</span> will</span>
<span id="cb75-1567"><a href="#cb75-1567"></a>be replaced in the animation with the value of the <span class="in">`hour_name`</span> variable in the </span>
<span id="cb75-1568"><a href="#cb75-1568"></a>data for each frame in the animation.</span>
<span id="cb75-1569"><a href="#cb75-1569"></a></span>
<span id="cb75-1570"><a href="#cb75-1570"></a>This animated map is very sensitive to the number of grid cells we choose to </span>
<span id="cb75-1571"><a href="#cb75-1571"></a>extract (in the map above, 10 cells for each hour) -- it might look quite </span>
<span id="cb75-1572"><a href="#cb75-1572"></a>different if we had chosen a different number. To show the density of crime in </span>
<span id="cb75-1573"><a href="#cb75-1573"></a>all of downtown Chicago, we can combine the base map and KDE layers we </span>
<span id="cb75-1574"><a href="#cb75-1574"></a>have already created to produce another animated map.</span>
<span id="cb75-1575"><a href="#cb75-1575"></a></span>
<span id="cb75-1576"><a href="#cb75-1576"></a><span class="in">```{r animated-exercise4, exercise=TRUE, exercise.lines=18, fig.asp=1}</span></span>
<span id="cb75-1577"><a href="#cb75-1577"></a><span class="in">ggplot() +</span></span>
<span id="cb75-1578"><a href="#cb75-1578"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb75-1579"><a href="#cb75-1579"></a><span class="in">  geom_sf(aes(fill = kde), data = hour_layers, alpha = 0.75, colour = NA) +</span></span>
<span id="cb75-1580"><a href="#cb75-1580"></a><span class="in">  geom_sf(data = cpd_central, colour = "grey33", fill = NA) +</span></span>
<span id="cb75-1581"><a href="#cb75-1581"></a><span class="in">  transition_states(states = hour_name) +</span></span>
<span id="cb75-1582"><a href="#cb75-1582"></a><span class="in">  scale_fill_distiller(</span></span>
<span id="cb75-1583"><a href="#cb75-1583"></a><span class="in">    breaks = range(pull(hour_layers, kde)),</span></span>
<span id="cb75-1584"><a href="#cb75-1584"></a><span class="in">    labels = c("lower", "higher"),</span></span>
<span id="cb75-1585"><a href="#cb75-1585"></a><span class="in">    direction = 1</span></span>
<span id="cb75-1586"><a href="#cb75-1586"></a><span class="in">  ) +</span></span>
<span id="cb75-1587"><a href="#cb75-1587"></a><span class="in">  labs(</span></span>
<span id="cb75-1588"><a href="#cb75-1588"></a><span class="in">    title = "Aggravated assaults in downtown Chicago, 2010-2019",</span></span>
<span id="cb75-1589"><a href="#cb75-1589"></a><span class="in">    subtitle = "Density of aggravated assaults: {closest_state}",</span></span>
<span id="cb75-1590"><a href="#cb75-1590"></a><span class="in">    caption = "Data from Chicago Police",</span></span>
<span id="cb75-1591"><a href="#cb75-1591"></a><span class="in">    fill = "density of\naggravated\nassaults"</span></span>
<span id="cb75-1592"><a href="#cb75-1592"></a><span class="in">  ) +</span></span>
<span id="cb75-1593"><a href="#cb75-1593"></a><span class="in">  theme_void()</span></span>
<span id="cb75-1594"><a href="#cb75-1594"></a><span class="in">```</span></span>
<span id="cb75-1595"><a href="#cb75-1595"></a></span>
<span id="cb75-1596"><a href="#cb75-1596"></a></span>
<span id="cb75-1597"><a href="#cb75-1597"></a>::: {.tutorial}</span>
<span id="cb75-1598"><a href="#cb75-1598"></a></span>
<span id="cb75-1599"><a href="#cb75-1599"></a>This code typically takes a minute or so to finish running because it has to</span>
<span id="cb75-1600"><a href="#cb75-1600"></a>generate 24 maps and then stitch them together. It is unlikely that the code</span>
<span id="cb75-1601"><a href="#cb75-1601"></a>will finish running before the maximum time that a chunk of code in an R </span>
<span id="cb75-1602"><a href="#cb75-1602"></a>tutorial is allowed to run for before automatically stopping. If you were to</span>
<span id="cb75-1603"><a href="#cb75-1603"></a>run this code in RStudio, the map it would produce would look like this:</span>
<span id="cb75-1604"><a href="#cb75-1604"></a></span>
<span id="cb75-1605"><a href="#cb75-1605"></a>&lt;p class="centered-image"&gt;&lt;img src="https://github.com/mpjashby/crimemapping/raw/main/inst/tutorials/16_mapping_time/images/chicago_downtown_agg_assaults.gif" alt="Animated map showing how the density of aggravated assaults in Chicago varies throughout the hours of the day."&gt;&lt;/p&gt;</span>
<span id="cb75-1606"><a href="#cb75-1606"></a></span>
<span id="cb75-1607"><a href="#cb75-1607"></a>:::</span>
<span id="cb75-1608"><a href="#cb75-1608"></a></span>
<span id="cb75-1609"><a href="#cb75-1609"></a></span>
<span id="cb75-1610"><a href="#cb75-1610"></a>We can save an animated map to a file using the <span class="in">`animate()`</span> and <span class="in">`anim_save()`</span> </span>
<span id="cb75-1611"><a href="#cb75-1611"></a>functions. <span class="in">`animate()`</span> controls the type of file the animation will be saved in</span>
<span id="cb75-1612"><a href="#cb75-1612"></a>(by default, an animated GIF), the height and width of the plot and so on.</span>
<span id="cb75-1613"><a href="#cb75-1613"></a><span class="in">`anim_save()`</span> then saves the animation in a file. For example, if we stored the </span>
<span id="cb75-1614"><a href="#cb75-1614"></a>map created above in an object called <span class="in">`chicago_downtown_kde_map`</span>, we could save </span>
<span id="cb75-1615"><a href="#cb75-1615"></a>it to an animated GIF file.</span>
<span id="cb75-1616"><a href="#cb75-1616"></a></span>
<span id="cb75-1617"><a href="#cb75-1617"></a><span class="in">```r</span></span>
<span id="cb75-1618"><a href="#cb75-1618"></a><span class="fu">anim_save</span>(</span>
<span id="cb75-1619"><a href="#cb75-1619"></a>  <span class="at">filename =</span> <span class="st">"chicago_downtown_agg_assaults.gif"</span>, </span>
<span id="cb75-1620"><a href="#cb75-1620"></a>  <span class="at">animation =</span> <span class="fu">animate</span>(</span>
<span id="cb75-1621"><a href="#cb75-1621"></a>    <span class="at">plot =</span> chicago_downtown_kde_map,</span>
<span id="cb75-1622"><a href="#cb75-1622"></a>    <span class="at">height =</span> <span class="dv">800</span>, </span>
<span id="cb75-1623"><a href="#cb75-1623"></a>    <span class="at">width =</span> <span class="dv">800</span>, </span>
<span id="cb75-1624"><a href="#cb75-1624"></a>    <span class="at">units =</span> <span class="st">"px"</span></span>
<span id="cb75-1625"><a href="#cb75-1625"></a>  )</span>
<span id="cb75-1626"><a href="#cb75-1626"></a>)</span>
<span id="cb75-1627"><a href="#cb75-1627"></a><span class="in">```</span></span>
<span id="cb75-1628"><a href="#cb75-1628"></a></span>
<span id="cb75-1629"><a href="#cb75-1629"></a></span>
<span id="cb75-1630"><a href="#cb75-1630"></a></span>
<span id="cb75-1631"><a href="#cb75-1631"></a><span class="fu">## In summary</span></span>
<span id="cb75-1632"><a href="#cb75-1632"></a></span>
<span id="cb75-1633"><a href="#cb75-1633"></a>::: {.box .welldone}</span>
<span id="cb75-1634"><a href="#cb75-1634"></a></span>
<span id="cb75-1635"><a href="#cb75-1635"></a>In this tutorial we have learned how to incorporate change over time into our </span>
<span id="cb75-1636"><a href="#cb75-1636"></a>analysis of where crime happens. This is important because the distribution of</span>
<span id="cb75-1637"><a href="#cb75-1637"></a>crime across different places often varies at different times. Being aware of</span>
<span id="cb75-1638"><a href="#cb75-1638"></a>the importance of time when we make maps means we can do things like create</span>
<span id="cb75-1639"><a href="#cb75-1639"></a>small-multiple or animated maps for different time periods, which we could use</span>
<span id="cb75-1640"><a href="#cb75-1640"></a>to make sure that scarce crime-prevention resources are used at the right time</span>
<span id="cb75-1641"><a href="#cb75-1641"></a>as well as in the right place.</span>
<span id="cb75-1642"><a href="#cb75-1642"></a></span>
<span id="cb75-1643"><a href="#cb75-1643"></a>:::</span>
<span id="cb75-1644"><a href="#cb75-1644"></a></span>
<span id="cb75-1645"><a href="#cb75-1645"></a></span>
<span id="cb75-1646"><a href="#cb75-1646"></a>This is the complete code we need to create an animated map of aggravated </span>
<span id="cb75-1647"><a href="#cb75-1647"></a>assaults in Chicago. Think about how you could change it, or what extra</span>
<span id="cb75-1648"><a href="#cb75-1648"></a>information you could add, to make this map as useful as possible to different</span>
<span id="cb75-1649"><a href="#cb75-1649"></a>groups of practitioners and policy makers.</span>
<span id="cb75-1650"><a href="#cb75-1650"></a></span>
<span id="cb75-1651"><a href="#cb75-1651"></a><span class="in">```{r complete-map, exercise=TRUE, exercise.lines=72}</span></span>
<span id="cb75-1652"><a href="#cb75-1652"></a><span class="in"># Load packages</span></span>
<span id="cb75-1653"><a href="#cb75-1653"></a><span class="in">library(gganimate)</span></span>
<span id="cb75-1654"><a href="#cb75-1654"></a><span class="in">library(ggspatial)</span></span>
<span id="cb75-1655"><a href="#cb75-1655"></a><span class="in">library(lubridate)</span></span>
<span id="cb75-1656"><a href="#cb75-1656"></a><span class="in">library(sf)</span></span>
<span id="cb75-1657"><a href="#cb75-1657"></a><span class="in">library(sfhotspot)</span></span>
<span id="cb75-1658"><a href="#cb75-1658"></a><span class="in">library(tidyverse)</span></span>
<span id="cb75-1659"><a href="#cb75-1659"></a></span>
<span id="cb75-1660"><a href="#cb75-1660"></a></span>
<span id="cb75-1661"><a href="#cb75-1661"></a><span class="in"># Load data --------------------------------------------------------------------</span></span>
<span id="cb75-1662"><a href="#cb75-1662"></a></span>
<span id="cb75-1663"><a href="#cb75-1663"></a><span class="in"># Aggravated assaults, Chicago, 2010 to 2019</span></span>
<span id="cb75-1664"><a href="#cb75-1664"></a><span class="in">assaults &lt;- read_csv("https://mpjashby.github.io/crimemappingdata/chicago_aggravated_assaults.csv.gz")</span></span>
<span id="cb75-1665"><a href="#cb75-1665"></a></span>
<span id="cb75-1666"><a href="#cb75-1666"></a><span class="in"># Chicago Police districts 1, 12 and 18</span></span>
<span id="cb75-1667"><a href="#cb75-1667"></a><span class="in">cpd_central &lt;- read_sf("https://mpjashby.github.io/crimemappingdata/chicago_police_districts.kml") |&gt; </span></span>
<span id="cb75-1668"><a href="#cb75-1668"></a><span class="in">  st_transform("EPSG:26916") |&gt; </span></span>
<span id="cb75-1669"><a href="#cb75-1669"></a><span class="in">  mutate(district_no = as.numeric(Name)) |&gt; </span></span>
<span id="cb75-1670"><a href="#cb75-1670"></a><span class="in">  filter(district_no %in% c(1, 12, 18))</span></span>
<span id="cb75-1671"><a href="#cb75-1671"></a></span>
<span id="cb75-1672"><a href="#cb75-1672"></a></span>
<span id="cb75-1673"><a href="#cb75-1673"></a><span class="in"># Wrangle data -----------------------------------------------------------------</span></span>
<span id="cb75-1674"><a href="#cb75-1674"></a></span>
<span id="cb75-1675"><a href="#cb75-1675"></a><span class="in"># Calculate number of assaults each hour</span></span>
<span id="cb75-1676"><a href="#cb75-1676"></a><span class="in">hour_layers &lt;- assaults |&gt; </span></span>
<span id="cb75-1677"><a href="#cb75-1677"></a><span class="in">  filter(district %in% c(1, 12, 18)) |&gt; </span></span>
<span id="cb75-1678"><a href="#cb75-1678"></a><span class="in">  mutate(</span></span>
<span id="cb75-1679"><a href="#cb75-1679"></a><span class="in">    hour_name = str_pad(hour(date), width = 2, pad = "0"),</span></span>
<span id="cb75-1680"><a href="#cb75-1680"></a><span class="in">    hour_name = str_glue("{hour_name}:00 to {hour_name}:59")</span></span>
<span id="cb75-1681"><a href="#cb75-1681"></a><span class="in">  ) |&gt; </span></span>
<span id="cb75-1682"><a href="#cb75-1682"></a><span class="in">  st_as_sf(coords = c("longitude", "latitude"), crs = "EPSG:4326") |&gt; </span></span>
<span id="cb75-1683"><a href="#cb75-1683"></a><span class="in">  st_transform("EPSG:26916") |&gt; </span></span>
<span id="cb75-1684"><a href="#cb75-1684"></a><span class="in">  group_by(hour_name) |&gt; </span></span>
<span id="cb75-1685"><a href="#cb75-1685"></a><span class="in">  group_modify(</span></span>
<span id="cb75-1686"><a href="#cb75-1686"></a><span class="in">    ~ hotspot_kde(.x, cell_size = 200, bandwidth_adjust = 0.75, quiet = TRUE)</span></span>
<span id="cb75-1687"><a href="#cb75-1687"></a><span class="in">  ) |&gt; </span></span>
<span id="cb75-1688"><a href="#cb75-1688"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb75-1689"><a href="#cb75-1689"></a><span class="in">  st_as_sf() |&gt; </span></span>
<span id="cb75-1690"><a href="#cb75-1690"></a><span class="in">  st_intersection(cpd_central)</span></span>
<span id="cb75-1691"><a href="#cb75-1691"></a></span>
<span id="cb75-1692"><a href="#cb75-1692"></a></span>
<span id="cb75-1693"><a href="#cb75-1693"></a><span class="in"># Create map ---------------------------------------------------------------------</span></span>
<span id="cb75-1694"><a href="#cb75-1694"></a><span class="in">chicago_downtown_kde_map &lt;- ggplot() +</span></span>
<span id="cb75-1695"><a href="#cb75-1695"></a><span class="in">  annotation_map_tile(type = "cartolight", zoomin = 0, progress = "none") +</span></span>
<span id="cb75-1696"><a href="#cb75-1696"></a><span class="in">  geom_sf(aes(fill = kde), data = hour_layers, alpha = 0.75, colour = NA) +</span></span>
<span id="cb75-1697"><a href="#cb75-1697"></a><span class="in">  geom_sf(data = cpd_central, colour = "grey33", fill = NA) +</span></span>
<span id="cb75-1698"><a href="#cb75-1698"></a><span class="in">  transition_states(states = hour_name) +</span></span>
<span id="cb75-1699"><a href="#cb75-1699"></a><span class="in">  scale_fill_distiller(</span></span>
<span id="cb75-1700"><a href="#cb75-1700"></a><span class="in">    breaks = range(pull(hour_layers, kde)),</span></span>
<span id="cb75-1701"><a href="#cb75-1701"></a><span class="in">    labels = c("lower", "higher"),</span></span>
<span id="cb75-1702"><a href="#cb75-1702"></a><span class="in">    direction = 1</span></span>
<span id="cb75-1703"><a href="#cb75-1703"></a><span class="in">  ) +</span></span>
<span id="cb75-1704"><a href="#cb75-1704"></a><span class="in">  labs(</span></span>
<span id="cb75-1705"><a href="#cb75-1705"></a><span class="in">    title = "Aggravated assaults in downtown Chicago, 2010-2019",</span></span>
<span id="cb75-1706"><a href="#cb75-1706"></a><span class="in">    subtitle = "Density of aggravated assaults: {closest_state}",</span></span>
<span id="cb75-1707"><a href="#cb75-1707"></a><span class="in">    caption = "Data from Chicago Police",</span></span>
<span id="cb75-1708"><a href="#cb75-1708"></a><span class="in">    fill = "density of\naggravated\nassaults"</span></span>
<span id="cb75-1709"><a href="#cb75-1709"></a><span class="in">  ) +</span></span>
<span id="cb75-1710"><a href="#cb75-1710"></a><span class="in">  theme_void()</span></span>
<span id="cb75-1711"><a href="#cb75-1711"></a></span>
<span id="cb75-1712"><a href="#cb75-1712"></a></span>
<span id="cb75-1713"><a href="#cb75-1713"></a><span class="in"># Save map ---------------------------------------------------------------------</span></span>
<span id="cb75-1714"><a href="#cb75-1714"></a><span class="in">anim_save(</span></span>
<span id="cb75-1715"><a href="#cb75-1715"></a><span class="in">  filename = "chicago_downtown_agg_assaults.gif", </span></span>
<span id="cb75-1716"><a href="#cb75-1716"></a><span class="in">  animation = animate(</span></span>
<span id="cb75-1717"><a href="#cb75-1717"></a><span class="in">    plot = chicago_downtown_kde_map,</span></span>
<span id="cb75-1718"><a href="#cb75-1718"></a><span class="in">    height = 800, </span></span>
<span id="cb75-1719"><a href="#cb75-1719"></a><span class="in">    width = 800, </span></span>
<span id="cb75-1720"><a href="#cb75-1720"></a><span class="in">    units = "px"</span></span>
<span id="cb75-1721"><a href="#cb75-1721"></a><span class="in">  )</span></span>
<span id="cb75-1722"><a href="#cb75-1722"></a><span class="in">)</span></span>
<span id="cb75-1723"><a href="#cb75-1723"></a><span class="in">```</span></span>
<span id="cb75-1724"><a href="#cb75-1724"></a></span>
<span id="cb75-1725"><a href="#cb75-1725"></a></span>
<span id="cb75-1726"><a href="#cb75-1726"></a>::: {.reading}</span>
<span id="cb75-1727"><a href="#cb75-1727"></a></span>
<span id="cb75-1728"><a href="#cb75-1728"></a>You can learn more about:</span>
<span id="cb75-1729"><a href="#cb75-1729"></a></span>
<span id="cb75-1730"><a href="#cb75-1730"></a><span class="ss">  * </span>using the different functions in the <span class="in">`lubridate`</span> package to </span>
<span id="cb75-1731"><a href="#cb75-1731"></a>    <span class="co">[</span><span class="ot">Do more with dates and times in R</span><span class="co">](https://lubridate.tidyverse.org/articles/lubridate.html)</span> and</span>
<span id="cb75-1732"><a href="#cb75-1732"></a><span class="ss">  * </span>animating different types of map and chart in different ways in</span>
<span id="cb75-1733"><a href="#cb75-1733"></a>    <span class="co">[</span><span class="ot">Getting Started with `gganimate`</span><span class="co">](https://gganimate.com/articles/gganimate.html)</span>.</span>
<span id="cb75-1734"><a href="#cb75-1734"></a></span>
<span id="cb75-1735"><a href="#cb75-1735"></a>:::</span>
<span id="cb75-1736"><a href="#cb75-1736"></a></span>
<span id="cb75-1737"><a href="#cb75-1737"></a></span>
<span id="cb75-1738"><a href="#cb75-1738"></a>&lt;p class="credits"&gt;&lt;a href="https://twitter.com/allison_horst"&gt;Artwork by @allison_horst&lt;/a&gt;&lt;/p&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by/4.0/">
<p>This book is available under a Creative Commons Attribution 4.0 International licence</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mpjashby/crimemappingbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>